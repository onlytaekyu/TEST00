<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:,">
  <title>DB 접근제어 콘솔</title>
  <!-- CodeMirror (CDN). 운영에선 내부 호스팅 권장 -->
  <script type="text/javascript"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/keymap/vim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/keymap/emacs.min.js"></script>
  <!-- CodeMirror autocomplete addon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/sql-hint.min.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root{
      /* 하나금융 시그니처 그린 계열 (조정 가능) */
      --hana-primary: #00857C; /* main */
      --hana-primary-600:#00786F; /* hover */
      --hana-accent:#00B4A2;

      --header-h: 48px; --sidebar-w: 280px; --min-sidebar-w: 200px; --max-sidebar-w: 420px;
      --resizer-w: 6px; --resizer-h: 6px; --editor-min-h: 180px; --result-min-h: 120px;
      --border: 1px solid #e5e7eb; --bg: #f8fafc; --panel: #ffffff; --ink: #0f172a; --muted: #64748b;
      --brand: var(--hana-accent); --menu-bg: var(--hana-primary); --menu-ink: #e8fbf8; --menu-hover: var(--hana-primary-600);
      --tab-bg: #f1f5f9; --tab-active: #ffffff; --chip-bg: #e2e8f0; --chip-ink: #334155;
      --danger: #ef4444; --ok: #16a34a; --warn-ink:#b45309;
      /* 프로필 색상 정책 */
  

      --prof-ro: #2563eb;        /* 파랑 */
      --prof-limited: #f59e0b;   /* 호박 */
      --prof-ops: #db2777;       /* 로즈 */
    
      --line: #e5e7eb;
    }

    .profile-avatar{
    width:20px;
    height:20px;
    border-radius:50%;
    background:#00b894;
    color:#ffffff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:11px;
  }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    a{color:inherit;text-decoration:none}
    button{cursor:pointer;border:1px solid #cbd5e1;background:#fff;border-radius:8px;padding:6px 10px}
    button:hover{background:#f8fafc}
    .app{display:flex;flex-direction:column;height:100vh;overflow:hidden}

/* ===== UI Harmony Patch (export-* / admin-table / line var) ===== */
:root {
  --line: #e5e7eb;
}

.export-input {
  width: 100%;
  box-sizing: border-box;
  border-radius: 6px;
  border: var(--border);
  background: var(--panel);
  color: var(--ink);
  padding: 6px 8px;
  font-size: 13px;
  line-height: 1.2;
}
.export-input:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(0,133,124,.18);
}
.export-input::placeholder {
  color: rgba(100,116,139,.9);
}

.export-btn {
  border-radius: 6px;
  border: var(--border);
  background: var(--panel);
  color: var(--ink);
  padding: 6px 10px;
  font-size: 13px;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  user-select: none;
  transition: background .12s ease, transform .05s ease;
}
.export-btn:hover {
  background: #f8fafc;
}
.export-btn:active {
  transform: translateY(1px);
}
.export-btn[disabled] {
  opacity: .55;
  cursor: not-allowed;
}
.export-btn i {
  font-size: 12px;
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
}
.admin-table thead th {
  position: sticky;
  top: 0;
  z-index: 1;
  background: #f8fafc;
  border-bottom: var(--border);
  font-weight: 700;
  font-size: 12px;
}
.admin-table th,
.admin-table td {
  border-bottom: var(--border);
  padding: 8px 10px;
  font-size: 12px;
}
.admin-table tbody tr:hover {
  background: rgba(2,132,199,.06);
}


    /* Header */
    .header{display:flex;align-items:center;justify-content:space-between;height:var(--header-h);flex:0 0 var(--header-h);padding:0 12px;background:var(--menu-bg);color:var(--menu-ink);border-bottom:var(--border)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .menubar{display:flex;gap:8px}
    .menu{position:relative}
    .menu>.title{padding:8px 10px;border-radius:6px}
    .menu:hover>.title{background:var(--menu-hover)}
    .dropdown{position:absolute;top:100%;left:0;min-width:220px;background:#0f172a;color:#e2e8f0;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.25);display:none;z-index:10}
    .menu:hover .dropdown{display:block}
    .dropdown a{display:block;padding:8px 12px}
    .dropdown a:hover{background:#1e293b}
    .status{display:flex;align-items:center;gap:8px}
    .chip{background:var(--chip-bg);color:var(--chip-ink);padding:4px 8px;border-radius:999px;font-size:12px}
    .header-actions{display:flex;align-items:center;gap:12px;margin-left:auto;}
    .header-icon-btn{position:relative;display:flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:999px;border:1px solid rgba(148,163,184,.6);background:transparent;color:inherit;cursor:pointer;font-size:14px;}
    .header-icon-btn .badge{position:absolute;top:-4px;right:-4px;min-width:16px;height:16px;border-radius:999px;background:#ef4444;color:#fff;font-size:10px;display:flex;align-items:center;justify-content:center;padding:0 4px;}
    .header-user{position:relative;display:flex;align-items:center;}
    .header-user-toggle{display:flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.6);background:rgba(15,23,42,.15);color:inherit;cursor:pointer;font-size:13px;}
    .header-user-toggle .avatar-circle{width:24px;height:24px;border-radius:999px;background:#00b894;color:#ffffff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;}
    .header-user-name{max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .header-user-dropdown{position:absolute;top:calc(100% + 6px);right:0;min-width:170px;background:#0f172a;border-radius:8px;border:1px solid rgba(148,163,184,.7);box-shadow:0 12px 30px rgba(15,23,42,.45);padding:6px 0;z-index:40;display:none;}
    .header-user-dropdown.open{display:block;}
    .header-user-dropdown button{width:100%;padding:6px 12px;font-size:13px;text-align:left;background:transparent;border:none;color:#e2e8f0;display:flex;align-items:center;gap:8px;cursor:pointer;}
    .header-user-dropdown button:hover{background:rgba(148,163,184,.25);}
    .header-user-dropdown .logout{color:#fecaca;}
    .header-user-dropdown .logout:hover{background:rgba(248,113,113,.35);}
    .header-user-divider{border:none;border-top:1px solid rgba(148,163,184,.6);margin:4px 0;}
    .header-icon-btn:hover{
      background:rgba(148,163,184,.18);
      border-color:rgba(148,163,184,.9);
      color:#e5e7eb;
    }
    .header-user-toggle:hover{
      background:rgba(148,163,184,.24);
      border-color:rgba(148,163,184,.9);
      color:#e5e7eb;
    }


    /* Main */
    .main{display:grid;grid-template-columns:auto var(--resizer-w) 1fr;flex:1 1 auto;min-height:0}

    /* Sidebar */
    .sidebar{width:var(--sidebar-w);min-width:var(--min-sidebar-w);max-width:var(--max-sidebar-w);background:var(--panel);border-right:var(--border);display:flex;flex-direction:column}
    .sidebar .title{padding:10px 12px;border-bottom:var(--border);display:flex;align-items:center;justify-content:space-between}
    .tree{flex:1;overflow:auto;padding:8px 6px 12px}
    .tree ul{list-style:none;margin:0;padding-left:16px}
    .tree li{margin:2px 0}
    .node{display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:6px;cursor:default;position:relative}
    .node:hover{background:#f1f5f9}
    .node:focus{outline:2px solid #c7f2ed; background:#ecfeff}
    .node .tw{display:inline-block;width:12px;text-align:center;cursor:pointer}
    .node .tag{font-size:11px;color:#64748b;margin-left:auto}
    .col-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:16px;
      font-size:10px;
      border-radius:3px;
      padding:0 2px;
      font-weight:600;
    }
    .col-text{background:#e0f2fe;color:#0369a1;}
    .col-number{background:#fee2e2;color:#b91c1c;}
    .col-date{background:#ede9fe;color:#5b21b6;}
    .conn-dot{font-size:8px;margin-right:6px}
    .conn-on{color:var(--ok)}
    .conn-off{color:#f87171}

    .db-pin-btn{
      border:none;
      background:transparent;
      cursor:pointer;
      padding:0 2px;
      margin-left:4px;
      font-size:11px;
      color:#6b7280;
    }
    .db-pin-btn.pinned{
      color:#facc15;
    }
    #dbTree li[data-conn-id].db-pinned > .node{
      font-weight:600;
    }

    .badge-prof{border-radius:8px;padding:2px 6px;font-size:11px;margin-left:6px;color:#fff}
    .prof-ro{background:var(--prof-ro)}
    .prof-limited{background:var(--prof-limited)}
    .prof-ops{background:var(--prof-ops)}

    .v-resizer{width:var(--resizer-w);cursor:col-resize;background:linear-gradient(90deg,#e5e7eb,#cbd5e1)}

    /* Content (Tabs + Editor + Bottom 탭 영역) */
    .content{display:grid;grid-template-rows:auto auto auto auto var(--resizer-h) 1fr;height:100%}
    .tabs-wrapper{display:flex;align-items:center;background:var(--tab-bg);border-bottom:var(--border);position:relative;width:100%;max-width:100%;overflow:hidden;}
    .tab-scroll{display:none;border:none;background:transparent;padding:0 4px;cursor:pointer;min-width:24px;height:100%;}
    .tab-scroll[disabled]{opacity:.3;cursor:default;}
    .tab-overflow-btn{border:none;background:transparent;padding:0 4px;cursor:pointer;min-width:24px;height:100%;font-size:14px;}
    .tabs{display:flex;align-items:center;gap:6px;flex:1 1 auto;min-width:0;overflow:hidden;padding:6px;flex-wrap:nowrap;}
    .tab-overflow-menu{position:fixed;top:100%;margin-top:2px;background:#ffffff;border:var(--border);box-shadow:0 2px 6px rgba(0,0,0,.15);border-radius:4px;min-width:260px;width:auto;max-height:260px;overflow-y:auto;overflow-x:hidden;z-index:20;font-size:12px;padding:2px 0;box-sizing:border-box;}
    .tab-overflow-item{display:block;padding:4px 10px;cursor:pointer;white-space:nowrap;text-align:left;box-sizing:border-box;}
    .tab-overflow-item:hover{background:#e5e7eb;}
.tab{flex:0 0 auto;display:flex;align-items:center;gap:8px;background:var(--tab-bg);border:1px solid #e2e8f0;border-bottom:none;border-radius:10px 10px 0 0;padding:6px 10px;cursor:pointer;position:relative}
    .tab.dragging{opacity:.2;cursor:grabbing;}
    
    .tab.drop-before::before,
    .tab.drop-after::after{
      content:'';
      position:absolute;
      top:2px;
      bottom:2px;
      width:3px;
      background:var(--hana-accent);
    }
    .tab.drop-before::before{ left:0; }
    .tab.drop-after::after{ right:0; }

    .tab.active{background:#A7D8B7;opacity:1;font-weight:bold}
    .tab .close{opacity:.6}
    .tab .close:hover{opacity:1}
    
    .tab-title{
      display:inline-block;
      white-space:nowrap;
    }
    .tab-title-edit{
      font-size:12px;
      padding:2px 6px;
      border:1px solid #9cc7ff;
      border-radius:3px;
      box-sizing:border-box;
      max-width:140px;
      min-width:40px;
      display:inline-block;
      background:#fff;
      color:#000;
    }
    .tab-title-edit-error{
      position:absolute;
      left:4px;
      bottom:100%;
      margin-bottom:2px;
      background:#fffbe6;
      border:1px solid #ffb84d;
      color:#c45a00;
      font-size:10px;
      padding:1px 4px;
      border-radius:3px;
      white-space:nowrap;
      z-index:9999;
    }
    .tab-rename-toast{
      position:fixed;
      left:50%;
      top:64px;
      transform:translateX(-50%);
      background:#fffbe6;
      border:1px solid #ffb84d;
      color:#c45a00;
      font-size:12px;
      padding:4px 10px;
      border-radius:4px;
      white-space:nowrap;
      box-shadow:0 2px 4px rgba(0,0,0,0.15);
      z-index:10000;
      opacity:0;
      pointer-events:none;
      transition:opacity .15s ease-out, transform .15s ease-out;
    }
    .tab-rename-toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(4px);
    }


/* 핀 고정 탭 표시 */
    .tab.pinned::before{
      content:'\1F4CC';
      font-size:11px;
      margin-right:4px;
    }
    /* 탭 색상 밑줄 */
    .tab.color-blue{border-bottom:3px solid #3b82f6;}
    .tab.color-green{border-bottom:3px solid #22c55e;}
    .tab.color-yellow{border-bottom:3px solid #eab308;}
    .tab.color-red{border-bottom:3px solid #ef4444;}

    .tab .conn-badge{display:inline-flex;align-items:center;gap:6px}
    .tab .tab-prof{margin-left:2px}
    .tab-add{margin-left:auto}

    
    /* 환경 배너 (에디터 상단, 탭 아래 / 툴바 위) */
    .env-banner{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:8px 12px;
      border-bottom:var(--border);
      font-size:12px;
      background:#f9fafb;
      color:#111827;
    }
    .env-banner-icon{
      margin-top:2px;
      flex:0 0 auto;
      width:20px;
      height:20px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
    }
    .env-banner-title{
      font-weight:600;
      margin-bottom:2px;
    }
    .env-banner-meta{
      font-size:11px;
      font-weight:500;
      margin-bottom:2px;
    }
    .env-banner-head{
      display:flex;
      flex-wrap:wrap;
      align-items:baseline;
      gap:8px;
      margin-bottom:2px;
    }
    .env-banner-title{
      font-weight:600;
      margin-bottom:0;
    }
    .env-banner-meta{
      display:inline-flex;
      align-items:center;
      font-size:11px;
      font-weight:500;
      margin-bottom:0;
      padding:1px 8px;
      border-radius:999px;
      border:1px solid currentColor;
      background-color:rgba(255,255,255,0.4);
    }
    .env-banner-desc{
      font-size:11px;
      color:var(--muted);
    }
    /* 환경별 색상 (DEV/QA/PROD) */
    .env-banner--dev{
      background:#ecfdf5;
      border-bottom:1px solid #bbf7d0;
      color:#166534;
    }
    .env-banner--dev .env-banner-icon{
      background:#bbf7d0;
      color:#14532d;
    }
    .env-banner--qa{
      background:#eff6ff;
      border-bottom:1px solid #bfdbfe;
      color:#1d4ed8;
    }
    .env-banner--qa .env-banner-icon{
      background:#bfdbfe;
      color:#1e3a8a;
    }
    .env-banner--prod{
      background:#fef2f2;
      border-bottom:1px solid #fecaca;
      color:#991b1b;
    }
    .env-banner--prod .env-banner-icon{
      background:#fee2e2;
      color:#b91c1c;
    }
    .env-banner--hidden{
      display:none;
    }

    .toolbar{display:flex;align-items:center;gap:8px;padding:8px;border-bottom:var(--border);background:var(--panel)}
    .toolbar .sp{flex:1}
    .toolbar button{font-size:12px;padding:4px 8px}
    .toolbar button i{margin-right:2px}

    .editor{background:var(--panel);padding:0 0 8px 0}
    /* 환경별 에디터 영역 색상 (DEV/QA/PROD) */
    body.env-dev .editor{background:#f0fdf4}
    body.env-qa .editor{background:#eff6ff}
    body.env-prod .editor{background:#fef2f2}

    .codewrap{position:relative;border-top:var(--border)}
    /* CodeMirror takes over */
    .CodeMirror{height:320px;min-height:var(--editor-min-h);font-size:13px;border-bottom:var(--border)}
    body.env-dev .CodeMirror{background:#f9fefb}
    body.env-qa .CodeMirror{background:#f8fbff}
    body.env-prod .CodeMirror{background:#fff7f7}

    .h-resizer{height:var(--resizer-h);cursor:row-resize;background:linear-gradient(180deg,#e5e7eb,#cbd5e1)}

    /* Bottom tab area (결과 / DDL / 히스토리 / 즐겨찾기 / 서버 API) */
    .bottom-area{
      display:flex;
      flex-direction:column;
      min-height:0;
      background:var(--panel);
      border-top:var(--border);
    }
    .bottom-tabs{
      display:flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      background:var(--tab-bg);
      border-bottom:var(--border);
      flex-shrink:0;
    }
    .bottom-tabs .bottom-tab{
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#e5e7eb;
      padding:4px 10px;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
    }
    .bottom-tabs .bottom-tab.bottom-tab--with-badge{
      position:relative;
    }
    .bottom-tab-badge{
      position:absolute;
      top:-6px;
      right:-6px;
      min-width:16px;
      height:16px;
      border-radius:999px;
      background:#ef4444;
      color:#fff;
      font-size:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 4px;
    }

    .bottom-tabs .bottom-tab.active{
      background:#A7D8B7;
      font-weight:600;
    }
    .bottom-content{
      position:relative;
      flex:1;
      min-height:0;
    }

    .result{
      position:absolute;
      inset:0;
      background:var(--panel);
      border-top:none;
      display:none;
      flex-direction:column;
    }
    .result-header{display:flex;align-items:center;gap:8px;padding:8px;border-bottom:var(--border);flex-shrink:0}
    .result-body{flex:1;min-height:var(--result-min-h);overflow:auto}

    /* Favorites / Template panel (bottom) */
    .favtpl-body{
      /* reuse result-body base styles */
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .favtpl-inner{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:4px 6px 6px 6px;
      min-height:0;
    }
    .favtpl-tabs{
      display:inline-flex;
      gap:4px;
      align-items:center;
      flex-wrap:wrap;
    }
    .favtpl-tab-btn{
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#f9fafb;
      padding:2px 8px;
      font-size:11px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .favtpl-tab-btn.active{
      background:#047857;
      color:#ecfdf5;
      border-color:#047857;
      font-weight:600;
    }
    .favtpl-tab-btn .badge-chip{
      font-size:10px;
      background:rgba(255,255,255,.2);
      padding:0 4px;
      border-radius:999px;
    }
    .favtpl-panel{
      min-height:60px;
      display:flex;
      flex-direction:column;
      flex:1 1 auto;
      min-height:0;
    }
    .favtpl-panel.hidden{
      display:none;
    }
    .favtpl-filter-bar{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin:4px 0;
      font-size:11px;
      color:#4b5563;
    }
    .favtpl-filter-bar label{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .favtpl-filter-bar select,
    .favtpl-filter-bar input{
      font-size:11px;
      padding:2px 4px;
    }
    .favtpl-main{
      display:flex;
      gap:6px;
      min-height:0;
      flex:1 1 auto;
      overflow:hidden;
    }
    .favtpl-list{
      flex:1;
      min-width:0;
      overflow-y:auto;
    }
    .favtpl-list table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    .favtpl-list tbody tr{
      cursor:pointer;
    }
    .favtpl-list tbody tr:nth-child(odd){
      background:#f9fafb;
    }
    .favtpl-list tbody tr:hover{
      background:#e0f2fe;
    }
    .favtpl-list td{
      padding:4px 6px;
      border-bottom:1px solid #e5e7eb;
      vertical-align:top;
    }
    .favtpl-name{
      font-weight:600;
    }
    .favtpl-desc{
      font-size:10px;
      color:#6b7280;
      margin-top:2px;
    }
    .favtpl-meta-row{
      margin-top:3px;
      display:flex;
      flex-wrap:wrap;
      gap:3px;
    }
    .favtpl-badge{
      display:inline-flex;
      align-items:center;
      padding:0 5px;
      border-radius:999px;
      font-size:10px;
      background:#e5e7eb;
      color:#374151;
    }
    .favtpl-badge.sys-PRD{background:#fee2e2;color:#b91c1c;}
    .favtpl-badge.sys-DEV{background:#dbeafe;color:#1d4ed8;}
    .favtpl-badge.sys-STG{background:#fef3c7;color:#b45309;}
    .favtpl-badge.cat-MONITOR{background:#dcfce7;color:#166534;}
    .favtpl-badge.cat-HISTORY{background:#e0f2fe;color:#075985;}
    .favtpl-badge.cat-BATCH{background:#fae8ff;color:#7e22ce;}
    .favtpl-badge.cat-ETC{background:#e5e7eb;color:#374151;}
    .favtpl-badge.biz-MSG{background:#fef9c3;color:#854d0e;}
    .favtpl-badge.biz-PORTAL{background:#e0f2fe;color:#1d4ed8;}
    .favtpl-badge.biz-COMMON{background:#ecfdf5;color:#166534;}
    .favtpl-badge.biz-ETC{background:#e5e7eb;color:#374151;}
    .favtpl-preview{
      width:40%;
      min-width:180px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .favtpl-preview textarea{
      width:100%;
      min-height:80px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px;
      padding:4px;
      border:1px solid #d1d5db;
      border-radius:4px;
      resize:vertical;
      background:#f9fafb;
    }
    .favtpl-preview-info{
      font-size:10px;
      color:#6b7280;
      display:flex;
      justify-content:space-between;
      gap:4px;
      flex-wrap:wrap;
    }
    .favtpl-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin:2px 0 4px 0;
      flex-wrap:wrap;
    }
    .favtpl-hint{
      font-size:10px;
      color:#6b7280;
      white-space:nowrap;
    }


    table.grid{width:100%;border-collapse:collapse}
    table.grid thead th{position:sticky;top:0;background:#f8fafc;border-bottom:var(--border);font-weight:600}
    table.grid th,table.grid td{border-bottom:1px solid #f1f5f9;padding:6px 8px;white-space:nowrap}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#f1f5f9;color:#111827;font-size:12px}
    .spin{width:14px;height:14px;border-radius:50%;border:2px solid #94a3b8;border-top-color:transparent;display:inline-block;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .warn{color:var(--danger)}
    .ok{color:var(--ok)}
    .hidden{display:none!important}
    .test-pass{color:#16a34a}
    .test-fail{color:#ef4444}

    /* Context Menu */
    .ctx-menu{position:fixed;z-index:2100;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);min-width:180px;overflow:hidden}
    .ctx-menu ul{list-style:none;margin:0;padding:4px 0}
    .ctx-menu li{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px}
    .ctx-menu li:hover{background:#f1f5f9}
    .ctx-menu li.disabled{
      color:#9ca3af;
      cursor:default;
      pointer-events:none;
    }
        /* Scroll fix: allow flex children to scroll independently */
    .sidebar,.right,.result-panel,.result-body{min-height:0;}

    /* SQL 키워드(붉게 표시되는 토큰) 굵게 표시 */
    .CodeMirror .cm-keyword{
      font-weight: bold;
      color: #a626a4;
    }

    /* SQL 기본 함수 토큰 (MAX, SUM 등) 강조 색상 */
    .CodeMirror .cm-sql-builtin-func{
      font-weight: bold;
      color: #c18401;
    }


    /* 문자열 리터럴 색상 (문자/문자열) */
    .CodeMirror .cm-string{
      color: #50a14f;
    }

  
  /* Export audit modal */
  .export-modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.4);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
  }
  .export-modal-backdrop.show{
    display:flex;
  }
  .export-modal{
    background:#fff;
    border-radius:8px;
    min-width:420px;
    max-width:640px;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    padding:16px 20px;
    font-size:13px;
  }
  .export-modal h3{
    margin:0 0 8px;
    font-size:15px;
  }
  .export-modal .meta{
    font-size:12px;
    color:#555;
    margin-bottom:8px;
    line-height:1.4;
  }
  .export-modal textarea{
    width:100%;
    min-height:80px;
    resize:vertical;
    font-size:12px;
    padding:6px;
  }
  .export-modal-header{
    position:relative;
    padding-right:32px;
  }

  .export-modal .field{
    margin-bottom:8px;
  }
  .export-modal .field label{
    display:block;
    font-weight:600;
    margin-bottom:4px;
  }
  .export-modal .danger{
    background:#fff3cd;
    border:1px solid #ffeeba;
    padding:6px 8px;
    border-radius:4px;
    font-size:12px;
    margin-bottom:8px;
    color:#856404;
  }
  .export-modal .btn-row{
    display:flex;
    justify-content:flex-end;
    gap:8px;
    margin-top:10px;
  }
  .export-modal .btn-row button{
    padding:4px 10px;
    font-size:12px;
  }

  /* 현재 탭 SQL 저장 모달 레이아웃 보정 */
  #personalSqlSaveBackdrop .export-modal-grid{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  /* Query History Sidebar (현재 DB 기준) */
  #queryHistorySidebar{
    position:fixed;
    top:80px;
    right:16px;
    width:360px;
    max-height:calc(100vh - 100px);
    background:#ffffff;
    border-radius:8px;
    box-shadow:0 10px 25px rgba(0,0,0,0.25);
    display:none;
    flex-direction:column;
    z-index:2050;
  }
  #queryHistorySidebar.show{
    display:flex;
  }
  #queryHistorySidebar header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    padding:8px 10px;
    border-bottom:1px solid #e5e7eb;
    background:#f9fafb;
    gap:8px;
  }
  #queryHistorySidebar header h3{
    margin:0;
    font-size:13px;
    font-weight:600;
    display:flex;
    align-items:center;
    gap:6px;
  }
  #queryHistorySidebar header .muted{
    font-size:11px;
    color:#6b7280;
    margin-top:2px;
  }
  #queryHistorySidebar header .title-wrap{
    display:flex;
    flex-direction:column;
    gap:0;
  }
  #queryHistorySidebar .body{
    padding:6px 8px 8px;
    overflow-y:auto;
    font-size:12px;
  }
  #queryHistorySidebar .item{
    padding:6px 6px;
    border-radius:4px;
    cursor:pointer;
    border:1px solid transparent;
    margin-bottom:4px;
  }
  #queryHistorySidebar .item:hover{
    background:#f3f4f6;
    border-color:#e5e7eb;
  }
  #queryHistorySidebar .item .meta{
    font-size:11px;
    color:#6b7280;
    margin-bottom:2px;
  }
  #queryHistorySidebar .item .sql{
    font-family:SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  #queryHistorySidebar .empty{
    font-size:12px;
    color:#9ca3af;
    padding:8px 4px;
  }
  #personalSqlSaveBackdrop .export-group{
    margin:0;
  }
  #personalSqlSaveBackdrop .export-group + .export-group{
    border-top:1px solid #e5e7eb;
    padding-top:8px;
  }

  /* My Info modal (light theme) */
  #myInfoBackdrop .export-modal{
    max-width:1220px;
    width:100%;
    color:#111827;
  }
  #myInfoBackdrop .shell{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  #myInfoBackdrop header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin-bottom:4px;
  }
  #myInfoBackdrop .title-area h1{
    margin:0;
    font-size:18px;
    display:flex;
    align-items:center;
    gap:8px;
  }
  #myInfoBackdrop .title-badge{
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid #d1d5db;
    background:#f9fafb;
    color:#4b5563;
  }
  #myInfoBackdrop .title-sub{
    margin-top:4px;
    font-size:12px;
    color:#6b7280;
  }
  #myInfoBackdrop .pill-meta{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:11px;
    color:#6b7280;
  }
  #myInfoBackdrop .pill-meta span{
    padding:3px 7px;
    border-radius:999px;
    border:1px solid #e5e7eb;
    background:#f9fafb;
    display:flex;
    align-items:center;
    gap:4px;
  }
  #myInfoBackdrop .pill-dot{
    width:7px;
    height:7px;
    border-radius:999px;
    display:inline-block;
  }
  #myInfoBackdrop main{
    display:grid;
    grid-template-columns:minmax(0,1.35fr) minmax(0,1.1fr);
    gap:12px;
    margin-top:6px;
  }
  @media (max-width:1024px){
    #myInfoBackdrop main{
      grid-template-columns:1fr;
    }
  }
  #myInfoBackdrop .card{
    background:#f9fafb;
    border-radius:8px;
    border:1px solid #e5e7eb;
    padding:10px 12px;
  }
  #myInfoBackdrop .card-header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    margin-bottom:6px;
  }
  #myInfoBackdrop .card-title{
    font-size:13px;
    font-weight:600;
    display:flex;
    align-items:center;
    gap:6px;
  }
  #myInfoBackdrop .card-title-icon{
    width:18px;
    height:18px;
    border-radius:999px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:11px;
    background:#dcfce7;
    color:#15803d;
  }
  #myInfoBackdrop .card-title-icon.sec{
    background:#e0f2fe;
    color:#0369a1;
  }
  #myInfoBackdrop .card-title-icon.warn{
    background:#fee2e2;
    color:#b91c1c;
  }
  #myInfoBackdrop .card-desc{
    font-size:11px;
    color:#6b7280;
  }
  #myInfoBackdrop .card-toolbar{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:11px;
  }
  #myInfoBackdrop .tag-soft{
    padding:3px 7px;
    border-radius:999px;
    border:1px solid #e5e7eb;
    color:#4b5563;
    background:#f9fafb;
  }
  #myInfoBackdrop .tag-soft.accent{
    border-color:#22c55e;
    color:#166534;
    background:#dcfce7;
  }
  #myInfoBackdrop .tag-soft.warn{
    border-color:#f97316;
    color:#9a3412;
    background:#ffedd5;
  }
  #myInfoBackdrop .profile-grid{
    display:grid;
    grid-template-columns:120px minmax(0,1fr);
    gap:8px 12px;
    font-size:12px;
  }
  @media (max-width:640px){
    #myInfoBackdrop .profile-grid{
      grid-template-columns:1fr;
    }
  }
  #myInfoBackdrop .avatar-block{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
  }
  #myInfoBackdrop .avatar-ring{
    width:70px;
    height:70px;
    border-radius:999px;
    background:#00b894;
    color:#ffffff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:28px;
  }
  #myInfoBackdrop .avatar-label{
    font-size:11px;
    color:#6b7280;
  }
  #myInfoBackdrop dl.profile-fields{
    margin:0;
    display:grid;
    grid-template-columns:110px minmax(0,1fr);
    row-gap:4px;
    column-gap:6px;
  }
  #myInfoBackdrop dl.profile-fields dt{
    font-size:11px;
    color:#6b7280;
  }
  #myInfoBackdrop dl.profile-fields dd{
    margin:0;
    font-size:12px;
    color:#111827;
  }
  #myInfoBackdrop .hint{
    margin-top:4px;
    font-size:10px;
    color:#9ca3af;
  }
  #myInfoBackdrop .roles-list{
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:4px;
    font-size:12px;
  }
  #myInfoBackdrop .roles-list li{
    display:flex;
    align-items:flex-start;
    gap:6px;
  }
  #myInfoBackdrop .roles-label{
    min-width:74px;
    font-size:11px;
    color:#6b7280;
  }
  #myInfoBackdrop .roles-badges{
    display:flex;
    flex-wrap:wrap;
    gap:4px;
  }
  #myInfoBackdrop .badge{
    padding:2px 6px;
    border-radius:999px;
    border:1px solid #e5e7eb;
    font-size:11px;
    background:#fff;
    color:#111827;
  }
  #myInfoBackdrop .section-grid{
    display:grid;
    grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
    gap:8px;
  }
  @media (max-width:900px){
    #myInfoBackdrop .section-grid{
      grid-template-columns:1fr;
    }
  }
  #myInfoBackdrop .log-list{
    list-style:none;
    padding:0;
    margin:4px 0 0;
    display:flex;
    flex-direction:column;
    gap:4px;
    font-size:11px;
  }
  #myInfoBackdrop .log-item{
    padding:4px 6px;
    border-radius:6px;
    border:1px solid #e5e7eb;
    background:#fff;
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  #myInfoBackdrop .log-main{
    display:flex;
    justify-content:space-between;
    gap:8px;
  }
  #myInfoBackdrop .log-meta{
    font-size:10px;
    color:#6b7280;
  }
  #myInfoBackdrop .foot-hint{
    font-size:10px;
    color:#9ca3af;
    text-align:right;
    margin-top:4px;
  }
  #myInfoBackdrop .db-access-toolbar{
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom:8px;
    font-size:11px;
    color:#6b7280;
  }
  #myInfoBackdrop .db-access-toolbar .segmented{
    display:inline-flex;
    border-radius:999px;
    border:1px solid #e5e7eb;
    overflow:hidden;
  }
  #myInfoBackdrop .db-access-toolbar button{
    border:none;
    background:transparent;
    color:inherit;
    font-size:11px;
    padding:4px 10px;
  }
  #myInfoBackdrop .db-access-toolbar button.is-active{
    background:#e5e7eb;
    color:#111827;
  }
  #myInfoBackdrop #dbSearchInput{
    flex:1;
    min-width:0;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #e5e7eb;
    font-size:11px;
  }
  #myInfoBackdrop #dbSearchInput:focus{
    outline:none;
    border-color:#3b82f6;
    box-shadow:0 0 0 1px rgba(59,130,246,0.4);
  }
  #myInfoBackdrop .table-wrap{
    border-radius:8px;
    border:1px solid #d1d5db;
    background:#fff;
    overflow:hidden;
  }
  #myInfoBackdrop table{
    width:100%;
    border-collapse:collapse;
    font-size:11px;
  }
  #myInfoBackdrop thead{
    background:#f3f4f6;
  }
  #myInfoBackdrop thead th{
    padding:6px 7px;
    font-weight:500;
    color:#374151;
    border-bottom:1px solid #e5e7eb;
    text-align:left;
    white-space:nowrap;
  }
  #myInfoBackdrop tbody tr{
    border-bottom:1px solid #e5e7eb;
  }
  #myInfoBackdrop tbody tr:nth-child(even){
    background:#f9fafb;
  }
  #myInfoBackdrop tbody td{
    padding:5px 7px;
    white-space:nowrap;
    text-overflow:ellipsis;
    overflow:hidden;
    max-width:200px;
  }
  #myInfoBackdrop .env-pill{
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:2px 6px;
    border-radius:999px;
    font-size:10px;
    border:1px solid #22c55e;
    color:#166534;
    background:#dcfce7;
  }
  #myInfoBackdrop .env-pill.prod{
    border-color:#f97316;
    color:#9a3412;
    background:#ffedd5;
  }
  #myInfoBackdrop .role-pill{
    padding:2px 6px;
    border-radius:999px;
    border:1px solid #e5e7eb;
    font-size:10px;
    color:#111827;
    background:#fff;
  }
  #myInfoBackdrop .mini-table{
    width:100%;
    border-collapse:collapse;
    font-size:11px;
    margin-top:4px;
  }
  #myInfoBackdrop .mini-table th,
  #myInfoBackdrop .mini-table td{
    padding:4px 4px;
    text-align:left;
    border-bottom:1px solid #e5e7eb;
  }
  #myInfoBackdrop .mini-table th{
    font-weight:500;
    color:#374151;
  }
  #myInfoBackdrop .mini-table tbody tr:nth-child(even){
    background:#f9fafb;
  }
  #myInfoBackdrop .status-pill{
    padding:2px 6px;
    border-radius:999px;
    font-size:10px;
    border:1px solid #e5e7eb;
    background:#fff;
  }
  #myInfoBackdrop .status-pill.wait{
    border-color:#facc15;
    color:#854d0e;
    background:#fef9c3;
  }
  #myInfoBackdrop .status-pill.ok{
    border-color:#22c55e;
    color:#166534;
    background:#dcfce7;
  }
  #myInfoBackdrop .status-pill.reject{
    border-color:#f97316;
    color:#9a3412;
    background:#ffedd5;
  }
  #myInfoBackdrop .myinfo-footer{
    margin-top:10px;
    text-align:right;
  }
  .plan-summary-badge{
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:2px 6px;
    border-radius:999px;
    font-size:11px;
    border:1px solid transparent;
    margin-left:8px;
  }
  .plan-ok{
    color:var(--ok);
    border-color:var(--ok);
    background:#ecfdf3;
  }
  .plan-warn{
    color:var(--warn-ink);
    border-color:var(--warn-ink);
    background:#fffbeb;
  }
  .plan-danger{
    color:var(--danger);
    border-color:var(--danger);
    background:#fef2f2;
  }
  .plan-summary-badge i{
    font-size:11px;
  }



  
  /* === Connection Settings modal === */
  .conn-settings-modal{
    max-width:720px;
    width:720px;
  }
  .conn-settings-body{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .conn-settings-grid{
    display:grid;
    grid-template-columns:1.2fr 1.3fr;
    gap:12px 16px;
    align-items:flex-start;
  }
  .conn-settings-group{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .conn-settings-group label{
    font-size:12px;
    font-weight:600;
    color:#374151;
  }
  .conn-settings-input,
  .conn-settings-select{
    width:100%;
    padding:4px 6px;
    border:1px solid #d1d5db;
    border-radius:4px;
    font-size:12px;
  }
  .conn-settings-input:focus,
  .conn-settings-select:focus{
    outline:none;
    border-color:#0ea5e9;
    box-shadow:0 0 0 1px rgba(14,165,233,0.3);
  }
  .conn-settings-row{
    display:flex;
    gap:8px;
  }
  .conn-settings-row .conn-settings-group{
    flex:1;
  }
  .conn-settings-footer{
    border-top:1px solid #e5e7eb;
    margin-top:8px;
    padding-top:8px;
    display:flex;
    justify-content:space-between;
    gap:8px;
    align-items:center;
  }
  .conn-settings-footer-left{
    font-size:11px;
    color:#6b7280;
  }
  .conn-settings-footer-right{
    display:flex;
    gap:8px;
  }
  .conn-settings-modal{
    position:relative;
  }
  .conn-settings-modal .conn-settings-close-btn{
    position:absolute;
    top:8px;
    right:10px;
  }
  .conn-settings-modal .export-modal-header{
    position:relative;
    padding-right:32px;
  }
  #personalSqlLoadBackdrop .export-modal-header{
    position:relative;
    padding-right:32px;
  }

  .export-modal-header > button{
    position:absolute;
    top:8px;
    right:8px;
  }


/* === Table Edit (DBeaver-style) modal === */
  .table-edit-modal{
    max-width:960px;
    width:960px;
  }

  .table-edit-body{
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .te-header{
    padding-bottom:4px;
  }

  .te-table-name{
    font-size:13px;
    font-weight:600;
  }

  .te-table-meta{
    font-size:11px;
    color:#6b7280;
  }

  .te-tabs{
    display:flex;
    gap:4px;
    border-bottom:1px solid #e5e7eb;
    margin-top:4px;
  }

  .te-tab-btn{
    border:none;
    background:none;
    padding:6px 10px;
    font-size:12px;
    cursor:pointer;
    border-bottom:2px solid transparent;
  }

  .te-tab-btn.active{
    border-bottom-color:#00857C;
    font-weight:600;
  }

  .te-main-panes{
    margin-top:4px;
  }

  .te-pane{
    display:none;
    max-height:420px;
    overflow:auto;
  }

  .te-pane.active{
    display:block;
  }

  .te-subtabs{
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    border-bottom:1px solid #e5e7eb;
    padding:4px 0;
    margin-bottom:4px;
  }

  .te-subtab-btn{
    border:none;
    background:none;
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    cursor:pointer;
  }

  .te-subtab-btn.active{
    background:#00857C;
    color:#fff;
  }

  .te-subpane{
    display:none;
  }

  .te-subpane.active{
    display:block;
  }

  .te-table-wrapper{
    border:1px solid #e5e7eb;
    border-radius:6px;
    overflow:auto;
  }

  .te-grid{
    width:100%;
    border-collapse:collapse;
  }

  .te-grid th,
  .te-grid td{
    padding:4px 6px;
    font-size:11px;
    border-bottom:1px solid #e5e7eb;
  }

  .te-grid th{
    background:#f9fafb;
    text-align:left;
  }

  .te-placeholder{
    font-size:12px;
    color:#6b7280;
    padding:12px 4px;
  }

  .te-ddl{
    font-family: SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    font-size:11px;
    background:#0b1120;
    color:#e5e7eb;
    padding:8px;
    border-radius:4px;
    overflow:auto;
  }
  /* --- Admin / Management overlay ---------------------------------------- */
  .admin-overlay{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.55);
    display:none;
    align-items:stretch;
    justify-content:center;
    z-index:1200;
  }
  .admin-overlay.show{
    display:flex;
  }
  .admin-shell{
    background:#ffffff;
    color:var(--ink);
    width:960px;
    max-width:calc(100% - 80px);
    max-height:calc(100% - 80px);
    display:flex;
    box-shadow:0 20px 40px rgba(15,23,42,0.4);
    border-radius:10px;
    overflow:hidden;
    border:1px solid #e5e7eb;
  }
  .admin-sidebar{
    width:260px;
    background:#f1f5f9;
    border-right:1px solid #e5e7eb;
    padding:12px 10px;
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .admin-sidebar h3{
    margin:4px 4px 8px;
    font-size:14px;
    font-weight:600;
    color:var(--hana-primary);
    display:flex;
    align-items:center;
    gap:6px;
  }
  .admin-nav-section{
    margin-bottom:8px;
  }
  .admin-nav-section-title{
    font-size:11px;
    font-weight:600;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:.04em;
    margin:4px 6px;
  }
  .admin-nav button{
    width:100%;
    text-align:left;
    border-radius:6px;
    border:none;
    padding:5px 8px;
    font-size:12px;
    background:transparent;
    cursor:pointer;
  }
  .admin-nav button:hover{
    background:#e2f3f0;
  }
  .admin-nav button.active{
    background:var(--hana-primary);
    color:#e8fbf8;
  }
  .admin-content{
    flex:1;
    display:flex;
    flex-direction:column;
    padding:12px 14px;
    gap:8px;
  }
  .admin-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    border-bottom:1px solid #e5e7eb;
    padding-bottom:6px;
  }
  .admin-header h2{
    font-size:16px;
    margin:0;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .admin-header .badge{
    font-size:11px;
    padding:2px 6px;
    border-radius:999px;
    background:#ecfdf3;
    color:var(--hana-primary);
    border:1px solid #bbf7d0;
  }
  .admin-body{
    flex:1;
    overflow:auto;
    padding-right:4px;
  }
  .admin-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(230px,1fr));
    gap:8px;
  }
  .admin-card{
    border-radius:8px;
    border:1px solid #e5e7eb;
    padding:8px 9px;
    font-size:12px;
    background:#ffffff;
  }
  .admin-card h4{
    margin:0 0 4px;
    font-size:13px;
    display:flex;
    align-items:center;
    gap:4px;
  }
  .admin-card p{
    margin:0;
    color:var(--muted);
    font-size:12px;
    line-height:1.4;
  }
  
/* === emergencyAccess UI FIX : ul + table + alignment ===================== */
.emg-page ul,
.emg-page ol{
  margin:0;
  padding:0;
}

.emg-page ul{ list-style:none; }
.emg-page li{ margin:0; padding:0; }

/* 카드 헤더(오른쪽 배지 정렬) */
.emg-page .emg-card-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}
.emg-page .emg-card-head .right{
  display:flex;
  align-items:center;
  gap:6px;
}

/* 흐름 요약(UL) */
.emg-page .emg-flow{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-top:6px;
}
.emg-page .emg-flow li{
  display:flex;
  align-items:flex-start;
  gap:6px;
  line-height:1.35;
  color:#374151;
  font-size:12px;
}
.emg-page .emg-flow .no{
  flex:0 0 20px;
  width:20px;
  font-weight:700;
  color:#0f172a;
}

/* 표 공통: 줄바꿈/깨짐 방지 */
.emg-page .emg-table-wrap{
  border:1px solid #e5e7eb;
  border-radius:8px;
  background:#fff;
  overflow:hidden;
}
.emg-page table.emg-table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;           /* 핵심 */
  font-size:11px;
}
.emg-page .emg-table thead{
  background:#f8fafc;
}
.emg-page .emg-table th{
  padding:6px 8px;
  border-bottom:1px solid #e5e7eb;
  text-align:left;
  font-weight:600;
  color:#374151;
  white-space:nowrap;
}
.emg-page .emg-table td{
  padding:6px 8px;
  border-bottom:1px solid #e5e7eb;
  white-space:nowrap;           /* 핵심 */
  overflow:hidden;              /* 핵심 */
  text-overflow:ellipsis;       /* 핵심 */
  color:#111827;
}
.emg-page .emg-table tbody tr:nth-child(even){
  background:#f9fafb;
}
.emg-page .emg-table tbody tr:hover{
  background:#f1f5f9;
  cursor:pointer;
}
.emg-page .emg-table tbody tr.is-active{
  background:#eef2ff;
}
.emg-page .col-right{ text-align:right; }

/* 상태 pill 정렬/크기 */
.emg-page .status-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:2px 8px;
  border-radius:999px;
  font-size:10px;
  border:1px solid #e5e7eb;
  background:#fff;
  white-space:nowrap;
}
.emg-page .status-pill.ok{
  border-color:#bbf7d0;
  background:#ecfdf3;
  color:var(--hana-primary);
}
.emg-page .status-pill.warn{
  border-color:#fed7aa;
  background:#fff7ed;
  color:#9a3412;
}

/* 필터바(셀렉트+검색) 줄 맞춤 */
.emg-page .emg-filterbar{
  display:flex;
  align-items:center;
  gap:6px;
}
.emg-page .emg-filterbar select{ width:84px; }
.emg-page .emg-filterbar input{ flex:1; min-width:0; }
  
  
/* 관리콘솔: 하위 메뉴 카드 hover 시에만 테두리 강조 */
#adminOverlay .admin-card-clickable{
  cursor: pointer;
  border-color: #e5e7eb !important; /* 기본은 항상 원래 테두리 */
  transition: border-color .15s ease, box-shadow .15s ease;
}

#adminOverlay .admin-card-clickable:hover{
  border-color: var(--hana-primary) !important;
  box-shadow: 0 0 0 1px rgba(16,185,129,0.25);
}  
  
  .admin-tags{
    margin-top:4px;
    display:flex;
    flex-wrap:wrap;
    gap:4px;
  }
  .admin-tag{
    font-size:10px;
    padding:2px 5px;
    border-radius:999px;
    border:1px solid #e5e7eb;
    background:#f8fafc;
    color:#64748b;
  }
  .admin-footer{
    margin-top:4px;
    text-align:right;
    font-size:11px;
    color:var(--muted);
  }
  @media (max-width:900px){
    .admin-shell{
      width:100%;
      max-width:calc(100% - 24px);
    }

  }


  /* Query progress overlay (Hana style) */
  .query-progress-overlay{
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.35);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    pointer-events: none;
  }
  .query-progress-overlay.is-active{
    display: flex;
    pointer-events: auto;
  }
  .qp-inner{
    background: rgba(15,23,42,0.94);
    border-radius: 18px;
    box-shadow: 0 18px 45px rgba(15,23,42,0.55);
    padding: 20px 28px 18px;
    min-width: 260px;
    max-width: 360px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: stretch;
    border: 1px solid rgba(148,163,184,0.4);
  }
  .qp-logo-wrap{
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 4px;
  }
  .qp-logo-pulse{
    width: 30px;
    height: 30px;
    border-radius: 999px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: radial-gradient(circle at 30% 20%, #22e4b8 0, #00a89d 40%, #036666 100%);
    box-shadow: 0 0 0 0 rgba(34,228,184,0.55);
    animation: qp-pulse 1.4s ease-out infinite;
  }
  .qp-logo-circle{
    width: 20px;
    height: 20px;
    border-radius: 999px;
    background: #0f172a;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  .qp-logo-bar{
    width: 9px;
    height: 14px;
    border-radius: 999px;
    background: linear-gradient(180deg,#22e4b8,#a3e635);
    box-shadow: 0 0 0 1px rgba(15,23,42,0.7);
  }
  .qp-logo-label{
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.02em;
    color: #e5f0ff;
  }
  .qp-bar{
    position: relative;
    width: 100%;
    height: 4px;
    border-radius: 999px;
    background: rgba(30,64,175,0.3);
    overflow: hidden;
  }
  .qp-bar-fill{
    position: absolute;
    inset: 0;
    width: 45%;
    background: linear-gradient(90deg,#22e4b8,#a3e635);
    transform: translateX(-120%);
    animation: qp-slide 1.1s ease-in-out infinite;
  }
  .qp-text{
    margin-top: 2px;
    font-size: 12px;
    color: #cbd5f5;
    text-align: right;
  }

  @keyframes qp-slide{
    0%{ transform: translateX(-120%); }
    50%{ transform: translateX(0%); }
    100%{ transform: translateX(120%); }
  }
  @keyframes qp-pulse{
    0%{ box-shadow: 0 0 0 0 rgba(34,228,184,0.45); transform: scale(1); }
    70%{ box-shadow: 0 0 0 12px rgba(34,228,184,0); transform: scale(1.04); }
    100%{ box-shadow: 0 0 0 0 rgba(34,228,184,0); transform: scale(1); }
  }

.table-edit-modal {
  position: relative;
}

.table-edit-modal .table-edit-close-btn {
  position: absolute;
  top: 8px;
  right: 10px;
}

.table-edit-modal .export-modal-header{
  padding-right: 28px;
}



  .approval-close-btn {
  position: absolute;
  top: 8px;
  right: 10px;
}
.approval-modal {
  max-height: calc(100vh - 20px);
  display: flex;
  flex-direction: column;
}
.approval-modal .export-modal-body {
  flex: 1 1 auto;
  min-height: 0;
  overflow-y: auto;
}



.approval-modal .export-modal-header{
  position: relative;
  padding-right: 28px;
}

    /* DB Tree folder toolbar & selection/drag */
    .dbtree-folder-toolbar{
      display:flex;
      align-items:center;
      gap:4px;
      margin-left:auto;
    }
    .dbtree-folder-toolbar button{
      position:relative;
      border:none;
      background:transparent;
      padding:0;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:26px;
      height:20px;
    }
    .dbtree-folder-toolbar button i.fa-folder{
      color:#f7d154;
      font-size:16px;
    }
    .dbtree-folder-toolbar button i.dbtree-folder-plus{
      position:absolute;
      right:-2px;
      bottom:-2px;
      font-size:10px;
      color:var(--hana-primary-600,#00786F);
    }

    #dbTree .node.dbtree-selected{
      background:#e1f3ff;
      outline:1px solid #9cc7ff;
      border-radius:6px;
    }
    #dbTree .node.dbtree-dragging{
      opacity:.4;
    }
    #dbTree li.dbtree-drop-target > .node{
      outline:1px dashed #4a90e2;
      background:#f0f7ff;
    }

    /* DB 필터링 시 숨김 처리용 */
    #dbTree .dbfilter-hidden{
      display:none !important;
    }

    /* DB 이름 옆 (필터링됨) 태그 */
    #dbTree .dbfilter-tag{
      margin-left:4px;
      font-size:11px;
      color:#c45a00;
    }



    
    /* DB 필터 모달 헤더/푸터 정렬 및 닫기 버튼 */
    #dbFilterBackdrop .export-modal-header{
      position:relative;
      padding-right:32px;
    }
    #dbFilterBackdrop .dbfilter-close-btn{
      position:absolute;
      top:8px;
      right:8px;
      border:none;
      background:transparent;
      font-size:18px;
      line-height:1;
      cursor:pointer;
    }
    #dbFilterBackdrop .export-modal-footer{
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    /* DB 필터 모달 인풋 폭 조정 */
    #dbFilterBackdrop #dbFilterInput{
      width:100%;
      box-sizing:border-box;
    }
#dbTree .dbtree-folder-edit{
  font-size:12px;
  padding:4px 6px;
  margin-left:2px;
  border:1px solid #9cc7ff;
  border-radius:3px;
  box-sizing:border-box;
  display:inline-block;
  min-width:140px;
  max-width:240px;
  line-height:1.4;
}

    #dbTree li > .node{
      position:relative;
    }
    #dbTree .dbtree-folder-edit-error{
      position:absolute;
      left:2px;
      top:100%;
      margin-top:2px;
      background:#fffbe6;
      border:1px solid #ffb84d;
      color:#c45a00;
      font-size:10px;
      padding:1px 4px;
      border-radius:3px;
      white-space:nowrap;
      z-index:10;
      pointer-events:none;
    }


  /* 부재중 & 대결자 관리 모달 전용 스타일 (modal.html에서 가져옴) */
.modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .modal-backdrop.open {
      display: flex;
    }
    .modal {
      background: #fff;
      border-radius: 10px;
      width: 980px;
      max-width: 95vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
    }
    .modal-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-size: 15px;
      font-weight: 600;
    }
    .modal-close-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      color: #666;
    }
    .modal-body {
      padding: 12px 16px 16px 16px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal-footer {
      padding: 10px 16px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    /* 탭 */
    .tab-header {
      display: inline-flex;
      border-radius: 999px;
      padding: 2px;
      background: #f3f4f6;
      gap: 2px;
      margin-bottom: 4px;
    }
    .tab-btn {
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      color: #555;
    }
    .tab-btn.active {
      background: #005f4f;
      color: #fff;
    }
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }

    /* 현재 상태 카드 */
    .status-card {
      border-radius: 8px;
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      font-size: 13px;
    }
    .status-card.inactive {
      background: #f9fafb;
      border-color: #e5e7eb;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }
    .status-chip.active {
      background: #16a34a;
      color: #fff;
    }
    .status-chip.planned {
      background: #2563eb;
      color: #fff;
    }
    .status-chip.expired {
      background: #9ca3af;
      color: #fff;
    }
    .status-meta {
      margin-top: 4px;
      color: #555;
    }
    .status-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    /* 폼 레이아웃 */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 2.1fr;
      gap: 12px;
      margin-top: 4px;
      margin-bottom: 8px;
    }
    .form-group-wide{
      grid-column: 1 / -1;
    }
    .form-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e5e7eb;
    }
    .form-section:first-of-type {
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }
    .form-label {
      font-weight: 500;
      color: #374151;
    }
    .form-label span.req {
      color: #dc2626;
      margin-left: 2px;
    }
    .form-control, .form-select, .form-textarea {
      border-radius: 6px;
      border: 1px solid #d1d5db;
      padding: 6px 8px;
      font-size: 13px;
    }
    .form-control:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #005f4f;
      box-shadow: 0 0 0 1px rgba(0,95,79,0.2);
    }
    .form-textarea {
      resize: vertical;
      min-height: 96px;
    }
    .inline-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .inline-row > .form-control{
      flex: 1 1 auto;
      min-width: 0;
    }
    .inline-row > button{
      flex: 0 0 auto;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
    }
    .checkbox-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }
    .helper-text {
      font-size: 11px;
      color: #6b7280;
    }
    .error-text {
      font-size: 11px;
      color: #dc2626;
      margin-top: 2px;
    }

    /* 버튼 */
    .btn {
      border-radius: 6px;
      border: 1px solid transparent;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      background: #005f4f;
      color: #fff;
      border-color: #005f4f;
    }
    .btn-primary:hover {
      background: #00463c;
      color: #fff;
      border-color: #00463c;
    }

    .btn-primary:disabled {
      background: #9ca3af;
      border-color: #9ca3af;
      cursor: default;
    }
    .btn-outline {
      background: #fff;
      color: #374151;
      border-color: #d1d5db;
    }
    .btn-ghost {
      background: transparent;
      color: #374151;
      border-color: transparent;
    }
    .btn-sm {
      padding: 4px 8px;
      font-size: 12px;
    }
    .btn-sort {
      border-radius: 999px;
      border-color: #d1d5db;
      background: #fff;
    }
    .btn-sort:hover {
      background: #f3f4f6;
    }


    .quick-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    /* 이력 테이블 */
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    thead {
      background: #f9fafb;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
    }
    #historyTbody td {
      text-align: center;
    }
    #historyTbody td.reason-cell {
      text-align: left;
    }

    th {
      font-weight: 600;
      color: #4b5563;
      white-space: nowrap;
    }
    tbody tr:hover {
      background: #f3f4f6;
    }
    td.nowrap {
      white-space: nowrap;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .badge-used {
      background: #dcfce7;
      color: #166534;
    }
    .badge-planned {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .badge-expired {
      background: #e5e7eb;
      color: #374151;
    }
    .badge-force {
      background: #fee2e2;
      color: #b91c1c;
    }

        .empty-text {
      font-size: 12px;
      color: #6b7280;
      padding: 8px 0;
    }

    .right {
      margin-left: auto;
    }

    /* 스크롤바 약간 정리 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: #cbd5f5;
      border-radius: 999px;
    }
  

    /* Tab context color dots */
    #tabCtx li[data-act="tab-color-default"] i.fa-circle { color: #9ca3af; }
    #tabCtx li[data-act="tab-color-blue"] i.fa-circle { color: #2563eb; }
    #tabCtx li[data-act="tab-color-green"] i.fa-circle { color: #16a34a; }
    #tabCtx li[data-act="tab-color-yellow"] i.fa-circle { color: #eab308; }
    #tabCtx li[data-act="tab-color-red"] i.fa-circle { color: #dc2626; }

/*tk css///////////////////////////////////////   */
/* ===== Admin overlay: LEFT SIDEBAR HARD LOCK (필수) ===== */
#adminOverlay.admin-overlay { overflow: hidden; } /* overlay 밖으로 못 나가게 */

#adminOverlay .admin-shell{
  min-width: 0;                 /* flex overflow 방지 */
  max-width: calc(100vw - 80px);/* 100% 대신 vw로 고정(가로 밀림 방지) */
}

#adminOverlay .admin-sidebar{
  flex: 0 0 260px !important;   /* ✅ 절대 안 줄어듦 */
  width: 260px !important;
  min-width: 260px !important;
  max-width: 260px !important;
  flex-shrink: 0 !important;
  overflow: auto;
}

#adminOverlay .admin-content{
  flex: 1 1 auto;
  min-width: 0 !important;      /* ✅ 오른쪽은 줄어들 수 있어야 함(중요) */
  overflow: hidden;             /* 오른쪽이 커져도 사이드바를 밀지 않게 */
}

#adminOverlay .admin-body{
  min-width: 0 !important;
  overflow-y: auto;
  overflow-x: hidden;           /* ✅ 가로는 body에서 못 만들게(내부 래퍼에서만 스크롤) */
}

#adminOverlay .admin-body > *{
  min-width: 0 !important;
  max-width: 100%;
}

/* ===== Scope Range table spacing fix ===== */
.scope-items-wrap { max-width:100%; min-width:0; background:#fff; }

.scope-items-table th,
.scope-items-table td{
  padding: 8px 10px;
  border-bottom: 1px solid var(--line);
  vertical-align: top;
  box-sizing: border-box;
}

.scope-items-table thead th{
  background: var(--panel, #f8fafc);
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.scope-items-table tbody tr:last-child td{ border-bottom: 0; }

/* 셀 안의 select/input이 폭/높이 통일되게 */
.scope-items-table td .conn-settings-select,
.scope-items-table td .conn-settings-input,
.scope-items-table td select,
.scope-items-table td input{
  display:block;
  width:100%;
  min-width:0;
  height:32px;
  line-height:32px;
  margin:0;
  box-sizing:border-box;
}

/* 동작 컬럼 버튼 정렬(행 안에서 깔끔하게) */
.scope-items-table td:last-child{
  padding-top: 6px;     /* 컨트롤 라인과 높이 맞춤 */
}

.scope-items-table td:last-child .btn{
  white-space: nowrap;
}

/* (중요) 행 안에 들어가는 힌트 문구가 2~3줄로 늘어나 간격 깨는 걸 방지
   -> 힌트 영역에 class="scope-hint"만 붙이면 한 줄로 정리됨 */
.scope-items-table .scope-hint{
  margin-top:4px;
  font-size:11px;
  color:var(--muted);
  line-height:1.2;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* 컬럼 2필드 정리(겹침 방지) */
.scope-colbox{
  display:flex;
  flex-direction:column;
  gap:6px;
  min-width:0;
}

.scope-colbox .conn-settings-select,
.scope-colbox .conn-settings-input{
  width:100%;
  min-width:0;
  box-sizing:border-box;
}

.scope-hint{
  font-size:11px;
  color:var(--muted);
  line-height:1.2;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.org-node-actions{ margin-left:auto; display:none; gap:4px; }
.org-node-header:hover .org-node-actions{ display:flex; }
.org-node-dim{ opacity:.45; }
.org-node-match .org-node-label{ font-weight:700; }
.org-node-label mark{ background:#fde68a; padding:0 2px; border-radius:3px; }
.admin-btn.ghost{ background:transparent; border:1px solid #e5e7eb; }
.admin-btn.ghost:hover{ background:#f8fafc; }
.admin-btn.danger{ background:#fee2e2; border:1px solid #fecaca; }
.admin-btn.danger:hover{ background:#fecaca; }

/*tk css///////////////////////////////////////   end*/
</style>
</head>
<body>
<div class="app">
  <!-- Header / Menubar -->
  <header class="header">
    <div class="brand"><span class="dot"></span> DB 접근제어 콘솔</div>
    <nav class="menubar">
            <div class="menu">
        <div class="title">파일</div>
        <div class="dropdown">
          <a href="#" onclick="ui.newEditorTabFromMenu();return false;">새 SQL 탭</a>
          <a href="#" onclick="ui.openSqlFile();return false;">SQL 파일 불러오기</a>
          <a href="#" onclick="ui.openSqlSaveModal();return false;">현재 탭 SQL 저장…</a>
          <a href="#" onclick="ui.openPersonalSqlLoad();return false;">서버 개인 저장소에서 SQL 불러오기…</a>
          <a href="#" onclick="actions.printCurrentSql();return false;">현재 SQL 인쇄…</a>
          <a href="#" onclick="actions.printCurrentResult();return false;">현재 결과 인쇄…</a>
        </div>
      </div>

<div class="menu"><div class="title">편집</div><div class="dropdown">
        <a href="#" onclick="ui.formatSql();return false;">서식 정리</a>
        <a href="#" onclick="ui.clearEditor();return false;">비우기</a>
      </div></div>
      <div class="menu"><div class="title">보기</div><div class="dropdown">
        <a href="#" onclick="dbamStub('세션 모니터');return false;">세션 모니터</a>
        <a href="#" onclick="dbamStub('실시간 SQL 모니터');return false;">실시간 SQL 모니터</a>
      </div></div>
      <div class="menu"><div class="title">실행</div><div class="dropdown">
        <a href="#" onclick="actions.runCurrent();return false;">실행 — 선택 또는 현재문 (Ctrl+Enter)</a>
        <a href="#" onclick="actions.runScript();return false;">스크립트 실행 — 위→아래 (Ctrl+Shift+Enter)</a>
        <a href="#" onclick="actions.explain();return false;">실행 계획 — 현재문</a>
      </div></div>
      <div class="menu"><div class="title">도구</div><div class="dropdown">
        <a href="#" onclick="onClickExportExcel();return false;"><i class="fa-solid fa-file-excel"></i> Excel 내보내기</a>
        <a href="#" onclick="favorites.addFromEditor();return false;"><i class="fa-solid fa-star"></i> 현재 SQL 즐겨찾기 추가</a>
        <a href="#" onclick="snapshots.createFromCurrentTab();return false;"><i class="fa-solid fa-link"></i> 스냅샷 저장</a>
        <a href="#" onclick="snapshots.importFromPrompt();return false;"><i class="fa-solid fa-folder-open"></i> 스냅샷 불러오기</a>
        <a href="#" onclick="tests.run();return false;"><i class="fa-solid fa-vial"></i> 자가진단(테스트)</a>
      </div></div>
      <div class="menu"><div class="title">관리</div><div class="dropdown">
        <a href="#" onclick="admin.open('orgUser');return false;"><i class="fa-solid fa-shield-halved"></i> 관리 콘솔 열기</a>
        <a href="#" onclick="admin.open('logAudit');return false;"><i class="fa-solid fa-list-check"></i> 로그/감사 뷰</a>
        <a href="#" onclick="admin.open('anomalyReport');return false;"><i class="fa-solid fa-wave-square"></i> 이상행위 조회·리포트</a>
      </div></div>
      <!-- 도움말 메뉴 -->
      <div class="menu"><div class="title">도움말</div><div class="dropdown">
        <a href="#" onclick="ui.openShortcutHelpModal();return false;"><i class="fa-solid fa-circle-question"></i> 단축키 / 스니펫 안내</a>
      </div></div>
          </nav>
    <div class="status">
      <!-- 연결 상태 chip은 내부 로직 유지를 위해 남겨두되, 헤더에서는 숨김 처리 -->
      <span id="connStatus" class="chip" style="display:none;">연결되지 않음</span>
      <div class="header-actions">
        <button type="button" id="headerNotifBtn" class="header-icon-btn" title="알림">
          <i class="fa-regular fa-bell"></i>
          <span class="badge" id="headerNotifBadge">3</span>
        </button>
        <div class="header-user" id="headerUser">
          <button type="button" id="headerUserToggle" class="header-user-toggle" aria-haspopup="true" aria-expanded="false">
            <span class="avatar-circle">H</span>
            <span class="header-user-name" id="headerUserName">홍길동</span>
            <i class="fa-solid fa-caret-down"></i>
          </button>
          <div class="header-user-dropdown" 

id="headerUserDropdown">
            <button type="button" data-action="profile">
              <i class="fa-solid fa-user"></i><span>내 정보</span>
            </button>
            <button type="button" data-action="settings">
              <i class="fa-solid fa-gear"></i><span>내 설정…</span>
            </button>
            <button type="button" data-action="delegate">
              <i class="fa-solid fa-user-clock"></i><span>부재중 / 대결자 설정</span>
            </button>
            <button type="button" data-action="password">
              <i class="fa-solid fa-key"></i><span>비밀번호 변경</span>
            </button>
            <hr class="header-user-divider" />
            <button type="button" class="logout" data-action="logout">
              <i class="fa-solid fa-right-from-bracket"></i><span>로그아웃</span>
            </button>
          </div>


        </div>
      </div>
    </div>
  </header>

  <!-- Main: Sidebar | Resizer | Content -->
  <section class="main">
    <!-- Sidebar (DB Tree) -->
    <aside id="sidebar" class="sidebar">
      <div class="title">
        <strong>Database</strong>
        <div class="dbtree-folder-toolbar">
          <button type="button" id="dbtreeAddFolderBtn" title="폴더 추가">
            <i class="fa-regular fa-folder"></i>
            <i class="fa-solid fa-plus dbtree-folder-plus"></i>
          </button>
          <button type="button" id="dbtreeAddDbBtn" title="Database 추가">
            <i class="fa-solid fa-database"></i>
            <i class="fa-solid fa-plus dbtree-folder-plus"></i>
          </button>
        </div>
      </div>
      <div class="tree" id="dbTree">
        <div class="muted" style="padding:8px 6px">연결 후 목록이 표시됩니다.</div>
      </div>
    </aside>
    <div id="vResizer" class="v-resizer" title="좌/우 크기 조절"></div>

    <!-- Content Area -->
    <section class="content">
      <!-- Tabs -->
      <div class="tabs-wrapper">
        <button class="tab-scroll tab-scroll-left" onclick="ui.scrollTabs(-1)" title="왼쪽으로 스크롤">&lsaquo;</button>
        <div id="tabs" class="tabs">
          <!-- dynamic tabs -->
        </div>
        <button id="tabOverflowBtn" class="tab-overflow-btn hidden" onclick="ui.toggleTabOverflowMenu()" title="더 많은 탭">»</button>
        <button class="tab-scroll tab-scroll-right" onclick="ui.scrollTabs(1)" title="오른쪽으로 스크롤">&rsaquo;</button>
        <div id="tabOverflowMenu" class="tab-overflow-menu hidden"></div>
      </div>

      <!-- Environment Banner (운영 DB 경고) -->
      <div id="envBanner" class="env-banner env-banner--hidden" aria-live="polite">
        <div class="env-banner-icon">
          <i class="fa-solid fa-triangle-exclamation"></i>
        </div>
        <div class="env-banner-body">
          <div class="env-banner-head">
            <div id="envBannerTitle" class="env-banner-title">운영 DB에 접속 중입니다.</div>
            <div id="envBannerMeta" class="env-banner-meta">PROD · 고위험 환경</div>
          </div>
          <div id="envBannerDesc" class="env-banner-desc">운영 DB에서의 쿼리 실행 및 다운로드에는 강화된 통제·승인 정책이 적용됩니다.</div>
        </div>
      </div>

      <!-- Editor Toolbar -->
      <div class="toolbar">
        <button onclick="actions.runCurrent()"><i class="fa-solid fa-play"></i> 실행 (Ctrl+Enter)</button>
        <button onclick="actions.runScript()"><i class="fa-solid fa-forward"></i> 스크립트 실행 (Ctrl+Shift+Enter)</button>
        <button onclick="actions.cancelQuery()"><i class="fa-solid fa-stop"></i> 쿼리 정지</button>
        <button onclick="actions.explain()"><i class="fa-solid fa-magnifying-glass-chart"></i> 실행 계획(EXPLAIN)</button>
        <button id="btnAutoCommit" onclick="ui.toggleAutoCommit();return false;" title="Auto-commit ON/OFF">
          <i id="autoCommitIcon" class="fa-solid fa-toggle-on"></i>
          Auto-commit: <span id="autoCommitLabel">ON</span>
        </button>
        <button id="btnCommit" onclick="actions.commitTx();return false;" title="현재 연결 Commit" disabled>
          <i class="fa-solid fa-check"></i> Commit
        </button>
        <button id="btnRollback" onclick="actions.rollbackTx();return false;" title="현재 연결 Rollback" disabled>
          <i class="fa-solid fa-rotate-left"></i> Rollback
        </button>
        <div class="sp"></div>

        <!-- 스니펫/단축키 도움말 버튼 -->
        <button type="button"
                id="btnShortcutHelp"
                class="btn-icon"
                title="스니펫/단축키 도움말"
                onclick="ui.openShortcutHelpModal();">
          <i class="fa-solid fa-circle-question"></i>
        </button>

        <!-- 최근 쿼리 히스토리 사이드바 버튼 -->
        <button type="button"
                id="btnQueryHistorySidebar"
                class="btn-icon"
                title="최근 쿼리 히스토리 (현재 DB)"
                onclick="queryHistorySidebar.toggle();">
          <i class="fa-solid fa-clock-rotate-left"></i>
        </button>
      </div>

      <!-- Editor -->
      <div class="editor">
        <div class="codewrap">
          <textarea id="sqlEditor" placeholder="여기에 SQL을 작성하세요. 예) SELECT now();"></textarea>
        </div>
      </div>

      <!-- Horizontal Resizer -->
      <div id="hResizer" class="h-resizer" title="에디터/결과 높이 조절"></div>

      <!-- Bottom Area: 결과 / DDL / 히스토리 / 즐겨찾기 / 서버 API 탭 -->
      <div id="bottomArea" class="bottom-area" style="display:none;">
        <div class="bottom-tabs">
          <button type="button" class="bottom-tab active" data-panel="result">
            <i class="fa-solid fa-table"></i> 결과
          </button>
          <button type="button" class="bottom-tab" data-panel="ddlPanel">
            <i class="fa-solid fa-scroll"></i> DDL
          </button>
          <button type="button" class="bottom-tab" data-panel="historyPanel">
            <i class="fa-solid fa-clock-rotate-left"></i> 히스토리
          </button>
          <button type="button" class="bottom-tab" data-panel="sessionPanel">
            <i class="fa-solid fa-user-group"></i> 세션
          </button>
          <button type="button" class="bottom-tab bottom-tab--with-badge" data-panel="approvalPanel">
            <i class="fa-solid fa-stamp"></i> 쿼리 결재함
            <span id="approvalTodoBadge" class="bottom-tab-badge" style="display:none;">0</span>
          </button>
          <button type="button" class="bottom-tab" data-panel="favPanel">
            <i class="fa-solid fa-star"></i> 즐겨찾기
          </button>
          <button type="button" class="bottom-tab" data-panel="serverPanel">
            <i class="fa-solid fa-code"></i> 서버 API
          </button>
        </div>
        <div class="bottom-content">
          <!-- Result Panel (hidden until connected + executed) -->
          <div id="result" class="result">
            <div class="result-header">
              <strong><i class="fa-solid fa-table"></i> 결과</strong>
              <span id="execMeta" class="muted"></span>
              <div class="right">
                <button onclick="onClickExportExcel()"><i class="fa-solid fa-file-export"></i> Excel 내보내기</button>
                <button onclick="ui.clearResult()"><i class="fa-solid fa-eraser"></i> 지우기</button>
              </div>
            </div>
            <div class="result-body">
              <table id="grid" class="grid">
                <thead></thead>
                <tbody></tbody>
              </table>
              <div id="messages" class="muted" style="padding:10px"></div>
            </div>
          </div>

          <!-- DDL Panel -->
          <div id="ddlPanel" class="result hidden">
            <div class="result-header">
              <strong><i class="fa-solid fa-scroll"></i> DDL / 구조</strong>
              <span id="ddlTitle" class="muted"></span>
              <div class="right">
                <button onclick="ddlPanel.clear();return false;"><i class="fa-solid fa-eraser"></i> 지우기</button>
              </div>
            </div>
            <div class="result-body" style="min-height:100px;max-height:none;overflow:auto">
              <pre id="ddlText" style="white-space:pre; margin:0; font-family:monospace; font-size:12px;"></pre>
            </div>
          </div>

          <!-- Query History Panel -->
          <div id="historyPanel" class="result hidden">
            <div class="result-header">
              <strong><i class="fa-solid fa-clock-rotate-left"></i> 쿼리 히스토리</strong>
              <span class="muted" style="font-size:12px">더블클릭: 현재 탭으로 불러오기</span>
              <div class="right">
                <button onclick="historyPanel.clear();return false;"><i class="fa-solid fa-trash"></i> 모두 지우기</button>
              </div>
            </div>
            <div class="result-body" style="min-height:80px;max-height:none;overflow-y:auto;overflow-x:hidden">
              <div style="margin-bottom:4px;">
                <select id="historySelect" style="width:100%;font-size:12px;padding:2px 4px;">
                  <option value="">최근 실행 내역</option>
                </select>
              </div>
              <table id="historyGrid" class="grid">
                <thead>
                  <tr>
                    <th>시간</th>
                    <th>DB</th>
                    <th>탭</th>
                    <th>행수</th>
                    <th>실행(ms)</th>
                    <th>SQL</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div id="approvalPanel" class="result hidden">
            <div class="result-header">
              <strong><i class="fa-solid fa-stamp"></i> 쿼리 결재함 ()</strong>
              <span class="muted" style="font-size:12px">민감 테이블/중요 쿼리에 대한 승인 요청·결재·실행 상태를 확인합니다. (브라우저 새로고침 시 목록은 초기화됩니다.)</span>
              <div class="right">
                <button type="button" onclick="approvalCenter.refresh();return false;"><i class="fa-solid fa-rotate"></i> 새로고침</button>
              </div>
            </div>
            <div class="result-body" style="min-height:120px;max-height:none;overflow-y:auto;overflow-x:hidden">
              <div style="margin-bottom:4px; display:flex; justify-content:space-between; align-items:center; font-size:12px;">
                <div style="color:#6b7280;">
                  아래 결재 요청 목록과 승인/반려/실행 동작은 현재 세션 사용자 기준으로 동작하는 입니다.
                </div>
                <div style="display:flex; align-items:center; gap:4px;">
                  <span style="color:#6b7280;">세션 사용자:</span>
                  <span id="sessionUserLabel" style="font-weight:600;">demoUser</span>
                  <button type="button" class="btn btn-sm" id="btnOpenSessionSwitch">
                    <i class="fa-solid fa-user-gear"></i> 세션 변경
                  </button>
                </div>
              </div>
              <div style="margin-bottom:6px; display:flex; gap:8px; align-items:center; font-size:12px;">
                <label style="display:flex; align-items:center; gap:4px;">
                  <span>보기:</span>
                  <select id="approvalFilter" onchange="approvalCenter.applyFilter(this.value)">
                    <option value="all">전체</option>
                    <option value="mine">내 요청</option>
                    <option value="todo">내 승인할 건</option>
                    <option value="approvedByMe">내가 승인한 것</option>
                    <option value="rejectedByMe">내가 반려한 것</option>
                    <option value="refByMe">내가 참조한 건</option>
                    <option value="completed">완료(승인/반려/실행)</option>
                  </select>
                </label>
                <label style="display:flex; align-items:center; gap:4px;">
                  <span>유형:</span>
                  <select id="approvalTypeFilter" onchange="approvalCenter.applyTypeFilter(this.value)">
                    <option value="all">전체</option>
                    <option value="sql">SQL만</option>
                    <option value="excel">엑셀만</option>
                  </select>
                </label>
                <label style="display:flex; align-items:center; gap:4px;">
                  <span>기간:</span>
                  <select id="approvalPeriod" onchange="approvalCenter.applyPeriod(this.value)">
                    <option value="7d">최근 7일</option>
                    <option value="30d" selected>최근 30일</option>
                    <option value="90d">최근 90일</option>
                    <option value="all">전체 기간</option>
                  </select>
                </label>
                <span class="muted" style="font-size:11px;">행을 클릭하면 상세 창에서 승인/반려/실행을 할 수 있습니다.</span>
              </div>
              <table id="approvalGrid" class="grid">
                <thead>
                  <tr>
                    <th style="text-align:center;">유형</th>
                    <th style="text-align:center;">상태</th>
                    <th style="text-align:center;">요청자</th>
                    <th style="text-align:center;">승인자</th>
                    <th style="text-align:center;">승인요청사유</th>
                    <th style="text-align:center;">허용 실행횟수</th>
                    <th style="text-align:center;">사용 실행횟수</th>
                    <th style="text-align:center;">유효 기간</th>
                    <th style="text-align:center;">요청시각</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="8" style="text-align:center; color:#6b7280; padding:8px;">아직 등록된 결재 요청이 없습니다.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Favorites Panel -->
          <div id="favPanel" class="result hidden">
            <div class="result-header">
              <strong><i class="fa-solid fa-star"></i> 즐겨찾기 / 템플릿</strong>
              <span class="muted" style="font-size:12px">
                개인 즐겨찾기와 조직 공용 템플릿을 한 곳에서 관리합니다.
              </span>
              <div class="right">
                <button onclick="favorites.addFromEditor();return false;"><i class="fa-solid fa-plus"></i> 현재 SQL 추가</button>
              </div>
            </div>
            <div class="result-body favtpl-body" style="min-height:80px;max-height:none;overflow-x:hidden">
              <div class="favtpl-inner">
                                <div class="favtpl-head">
<div class="favtpl-tabs">
                  <button type="button" id="favtplTabPersonal" class="favtpl-tab-btn active" data-mode="personal">
                    개인 즐겨찾기
                  </button>
                  <button type="button" id="favtplTabOrg" class="favtpl-tab-btn" data-mode="org">
                    조직 공용 템플릿
                  </button>
                </div>
<div class="favtpl-hint">
                  클릭: 미리보기, 더블클릭: 현재 SQL 탭에 삽입 (개인 즐겨찾기 / 조직 템플릿 공통)
                </div>
                </div>

                <!-- 개인 즐겨찾기 영역 (새 UI, 리스트 + 미리보기) -->
                <div id="favPersonalWrap" class="favtpl-panel">
                  <div class="favtpl-filter-bar">
                    <label>시스템
                      <select id="favPersonalSys">
                        <option value="">전체</option>
                        <option value="DEV">DEV</option>
                        <option value="STG">STG</option>
                        <option value="PRD">PRD</option>
                      </select>
                    </label>
                    <label>카테고리
                      <select id="favPersonalCat">
                        <option value="">전체</option>
                        <option value="MONITOR">모니터링</option>
                        <option value="HISTORY">이력</option>
                        <option value="BATCH">배치</option>
                        <option value="ETC">기타</option>
                      </select>
                    </label>
                    <label>업무명
                      <select id="favPersonalBiz">
                        <option value="">전체</option>
                        <option value="MSG">메신저</option>
                        <option value="PORTAL">포탈</option>
                        <option value="COMMON">공통</option>
                        <option value="ETC">기타</option>
                      </select>
                    </label>
                    <label>검색
                      <input type="text" id="favPersonalKeyword" placeholder="이름 / SQL 본문" />
                    </label>
                  </div>
                  <div class="favtpl-main">
                    <div class="favtpl-list">
                      <table>
                        <tbody id="favPersonalBody"></tbody>
                      </table>
                    </div>
                    <div class="favtpl-preview">
                      <textarea id="favPersonalPreview" readonly placeholder="개인 즐겨찾기 SQL이 여기 미리보기로 표시됩니다."></textarea>
                      <div class="favtpl-preview-info">
                        <span id="favPersonalMetaLeft"></span>
                        <span id="favPersonalMetaRight"></span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 조직 공용 템플릿 영역 (프로토타입) -->
                <div id="favOrgWrap" class="favtpl-panel hidden">
                  <div class="favtpl-filter-bar">
                    <label>시스템
                      <select id="favOrgSys">
                        <option value="">전체</option>
                        <option value="DEV">DEV</option>
                        <option value="STG">STG</option>
                        <option value="PRD">PRD</option>
                      </select>
                    </label>
                    <label>카테고리
                      <select id="favOrgCat">
                        <option value="">전체</option>
                        <option value="MONITOR">모니터링</option>
                        <option value="HISTORY">이력</option>
                        <option value="BATCH">배치</option>
                        <option value="ETC">기타</option>
                      </select>
                    </label>
                    <label>업무명
                      <select id="favOrgBiz">
                        <option value="">전체</option>
                        <option value="MSG">메신저</option>
                        <option value="PORTAL">포탈</option>
                        <option value="COMMON">공통</option>
                        <option value="ETC">기타</option>
                      </select>
                    </label>
                    <label>검색
                      <input type="text" id="favOrgKeyword" placeholder="이름 / 설명 / SQL / 태그" />
                    </label>
                  </div>
                  <div class="favtpl-main">
                    <div class="favtpl-list">
                      <table>
                        <tbody id="favOrgBody"></tbody>
                      </table>
                    </div>
                    <div class="favtpl-preview">
                      <textarea id="favOrgPreview" readonly placeholder="조직 공용 템플릿 SQL이 여기 미리보기로 표시됩니다."></textarea>
                      <div class="favtpl-preview-info">
                        <span id="favOrgMetaLeft"></span>
                        <span id="favOrgMetaRight"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>


          <!-- Session Monitor Panel -->
          <div id="sessionPanel" class="result hidden">
            <div class="result-header">
              <strong><i class="fa-solid fa-user-group"></i> 현재 세션</strong>
              <span class="muted" style="font-size:12px">이 콘솔에서 열린 접속과 최근 실행 정보를 보여줍니다.</span>
              <div class="right">
                <button onclick="sessionMonitor.refresh();return false;"><i class="fa-solid fa-rotate"></i> 새로고침</button>
                <button onclick="sessionMonitor.clearClosed();return false;"><i class="fa-solid fa-broom"></i> 종료 세션 정리</button>
              </div>
            </div>
            <div class="result-body" style="min-height:80px;max-height:none;overflow-y:auto;overflow-x:hidden">
              <table id="sessionGrid" class="grid">
                <thead>
                  <tr>
                    <th>사용자</th>
                    <th>DB/연결</th>
                    <th>프로필</th>
                    <th>상태</th>
                    <th>위험도</th>
                    <th>최근 실행 (첫 줄)</th>
                    <th>업데이트</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Server API sample panel (toggle) -->
          <div id="serverPanel" class="result hidden">
            <div class="result-header">
              <strong><i class="fa-solid fa-code"></i> 서버 연동 샘플</strong>
              <span class="muted">Spring MVC + Timeout + MaxRows + EXPLAIN</span>
            </div>
            <div class="result-body" style="padding:10px">
<pre><code>// DTO
public record SqlExecRequest(String connId, String sql, Integer maxRows, Integer timeoutMs, boolean explain) {}
public record SqlExecResponse(List&lt;String&gt; columns, List&lt;Map&lt;String,Object&gt;&gt; rows, long elapsedMs) {}

// Controller
@RestController
@RequestMapping("/sql")
@RequiredArgsConstructor
public class SqlController {
  private final SqlService sqlService;

  @PostMapping("/execute")
  public ResponseEntity&lt;SqlExecResponse&gt; execute(@RequestBody SqlExecRequest req) {
    int maxRows = Optional.ofNullable(req.maxRows()).orElse(500);
    int timeoutMs = Optional.ofNullable(req.timeoutMs()).orElse(15000);
    long t0 = System.currentTimeMillis();
    List&lt;Map&lt;String,Object&gt;&gt; rows = sqlService.execute(req.connId(), req.sql(), maxRows, timeoutMs, req.explain());
    long elapsed = System.currentTimeMillis()-t0;
    List&lt;String&gt; columns = rows.isEmpty()? List.of() : new ArrayList&lt;&gt;(rows.get(0).keySet());
    return ResponseEntity.ok(new SqlExecResponse(columns, rows, elapsed));
  }
}

// Service (PostgreSQL 예시)
@Service
public class SqlService {
  public List&lt;Map&lt;String,Object&gt;&gt; execute(String connId, String sql, int maxRows, int timeoutMs, boolean explain) {
    String finalSql = explain ? "EXPLAIN " + sql : sql;
    try(Connection c = dataSourceFor(connId).getConnection();
        Statement st = c.createStatement()){
      st.setMaxRows(maxRows);
      st.setQueryTimeout(Math.max(1, timeoutMs/1000));
      try(ResultSet rs = st.executeQuery(finalSql)){
        return toList(rs);
      }
    } catch(SQLTimeoutException te){ throw new ResponseStatusException(HttpStatus.REQUEST_TIMEOUT, "Query timeout"); }
      catch(SQLException e){ throw new ResponseStatusException(HttpStatus.BAD_REQUEST, e.getMessage()); }
  }
  private DataSource dataSourceFor(String connId){ /* connId→DataSource 맵 조회 */ }
  private List&lt;Map&lt;String,Object&gt;&gt; toList(ResultSet rs) throws SQLException{ /* ResultSet→List 변환 */ }
}
</code></pre>
            </div>
          </div>
        </div>
      </div>

    </section>
  </section>
</div>


<!-- DB Tree Filter Modal -->
<div id="dbFilterBackdrop" class="export-modal-backdrop hidden" aria-hidden="true">
  <div class="export-modal small">
    <div class="export-modal-header">
      <h3>데이터베이스 필터</h3>
      <button type="button" class="dbfilter-close-btn" id="dbFilterCloseBtn" aria-label="닫기">×</button>
    </div>
    <div class="export-modal-body">
      <div class="form-row">
        <label>대상 DB</label>
        <div id="dbFilterTargetLabel" class="muted" style="padding:4px 0;"></div>
      </div>
      <div class="form-row">
        <label for="dbFilterInput">포함할 문자열</label>
        <input type="text" id="dbFilterInput" class="form-control"
               placeholder="테이블/오브젝트 이름에 포함될 문자열">
        <p class="muted" style="margin-top:4px;font-size:11px;">
          입력한 문자열이 이름에 포함된 객체만 표시됩니다. (대/소문자 구분 안 함)
        </p>
      </div>
    </div>
    <div class="export-modal-footer">
      <button type="button" class="btn" id="dbFilterCancelBtn">취소</button>
      <button type="button" class="btn primary" id="dbFilterApplyBtn">필터 적용</button>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div id="ctxMenu" class="ctx-menu hidden" role="menu" aria-hidden="true">
  <ul>
    <li data-act="connect"><i class="fa-solid fa-plug"></i> 연결</li>
    <li data-act="reconnect"><i class="fa-solid fa-arrows-rotate"></i> 재접속</li>
    <li data-act="disconnect"><i class="fa-solid fa-plug-circle-xmark"></i> 연결 해제</li>
    <li data-act="sql-editor"><i class="fa-solid fa-pen-to-square"></i> SQL 에디터 열기</li>
    <li data-act="settings"><i class="fa-solid fa-gear"></i> 커넥션 설정</li>
    <li data-act="db-filter"><i class="fa-solid fa-filter"></i> 필터 적용…</li>
    <li data-act="db-filter-clear"><i class="fa-solid fa-filter-circle-xmark"></i> 필터 해제</li>
    <li data-act="conn-expand-all"><i class="fa-solid fa-angles-down"></i> 하위 모두 펼치기</li>
    <li data-act="conn-collapse-all"><i class="fa-solid fa-angles-up"></i> 하위 모두 접기</li>
    <li data-act="copy-conn"><i class="fa-solid fa-copy"></i> 복사 (Ctrl + C)</li>
        <li data-act="delete-conn"><i class="fa-solid fa-trash"></i> 삭제 (Delete)</li>
    <li data-act="rename-conn"><i class="fa-solid fa-pen"></i> 이름 변경 (F2)</li>
    <li data-act="refresh"><i class="fa-solid fa-rotate"></i> 새로고침 (Alt + R)</li>
  </ul>
</div>


<!-- Tree Object Context Menu -->
<div id="treeCtx" class="ctx-menu hidden" role="menu" aria-hidden="true">
  <ul></ul>
</div>

<!-- Editor Context Menu -->
<div id="editorCtx" class="ctx-menu hidden" role="menu" aria-hidden="true">
  <ul>
    <li data-act="runCurrent"><i class="fa-solid fa-play"></i> 실행 — 선택/현재문 (Ctrl+Enter)</li>
    <li data-act="runScript"><i class="fa-solid fa-forward"></i> 스크립트 실행 — 위→아래 (Ctrl+Shift+Enter)</li>
    <li data-act="format"><i class="fa-solid fa-wand-magic-sparkles"></i> 서식 정리 (Ctrl+Shift+F)</li>
    <li data-act="explain"><i class="fa-solid fa-magnifying-glass-chart"></i> 실행 계획 — 현재문</li>
    <li data-act="favSelection"><i class="fa-solid fa-star"></i> 선택 영역 즐겨찾기 추가</li>
  
<li data-act="code-in-list"><i class="fa-solid fa-list-ol"></i> 선택 영역을 IN (...) 리스트로 변환</li>
<li data-act="code-toggle-comment"><i class="fa-solid fa-slash"></i> 선택 영역 주석/해제 (Ctrl+/)</li>
<li data-act="code-run-selection"><i class="fa-solid fa-play"></i> 선택 부분만 실행</li>
</ul>
</div>

<!-- Tab Context Menu -->
<div id="tabCtx" class="ctx-menu hidden" role="menu" aria-hidden="true">
  <ul>
    <li data-act="tab-close"><i class="fa-solid fa-xmark"></i> 탭 닫기</li>
    <li data-act="tab-close-others"><i class="fa-solid fa-window-restore"></i> 다른 탭 닫기 (핀 제외)</li>
    <li data-act="tab-close-all"><i class="fa-solid fa-window-minimize"></i> 모든 탭 닫기 (핀 제외)</li>
    <li data-act="tab-pin-toggle"><i class="fa-solid fa-thumbtack"></i> 핀 고정</li>
    <li data-act="tab-rename"><i class="fa-solid fa-i-cursor"></i> 탭 이름 변경 (F2)</li>
    <li data-act="tab-save"><i class="fa-solid fa-floppy-disk"></i> SQL 저장</li>
  </ul>
</div>

<!-- Result Context Menu -->
<div id="resultCtx" class="ctx-menu hidden" role="menu" aria-hidden="true">
  <ul>
    <li data-act="export"><i class="fa-solid fa-file-export"></i> Excel 내보내기</li>
    <li data-act="export-insert"><i class="fa-solid fa-file-circle-plus"></i> INSERT 쿼리 내보내기</li>
    <li data-act="copy-sql"><i class="fa-solid fa-copy"></i> 쿼리 복사</li>
  </ul>
</div>

<!-- History / Recent Query Context Menu -->
<div id="historyCtx" class="ctx-menu hidden" role="menu" aria-hidden="true">
  <ul>
    <li data-act="add-favorite"><i class="fa-solid fa-star"></i> 즐겨찾기에 추가</li>
  </ul>
</div>

<!-- Favorite/Template Context Menu -->

<div id="favCtxMenu" class="ctx-menu hidden" role="menu" aria-hidden="true">
  <ul>
    <li data-act="edit"><i class="fa-solid fa-pen-to-square"></i> 수정</li>
    <li data-act="delete"><i class="fa-solid fa-trash"></i> 삭제</li>
  </ul>
</div>

<script>
let cm = null; // CodeMirror 인스턴스
const USE_DEMO = true; // false로 바꾸면 서버 호출(fetch) 경로 사용
const state = {
  connected: false,
  connId: null,
  history: [], // {ts, tsLabel, connId, connLabel, tabId, tabTitle, rowCount, elapsedMs, sql, sqlFirstLine}
  availableConns: [], // {id,label,profile}
  pinnedConnIds: [], // "자주 쓰는 연결" 핀 고정 대상 connId 목록
  connStates: {}, // { connId: boolean }
  connProfiles: {}, // { connId: 'RO'|'LIMITED'|'OPS' }
  connEnvs: {},     // { connId: 'DEV'|'PROD'|'QA'|'ETC'|'' }
  connFilters: {},  // { connId: { keyword: string } }
  tabs: [], // {id, title, connId, sql, result}}
  connAccessInfo: {}, // { connId: { reason, ticketId, activatedAt } }
  activeTabId: null,
  nextTab: 1,
  maxRows: 500,
  lastResult: {columns: [], rows: [], elapsedMs: 0, rowCount: 0},
  lastSql: '',
  currentAbortController: null,
  autoCommit: true,
  queryTimeoutMs: 15000,
  formatBreakLines: false,
  formatUpperAll: false,
  autoSaveEditor: false,
  autoSaveIntervalSec: 5
};


// ---------------- DB Tree Pin helpers ----------------
function isConnPinned(connId){
  try{
    if(!connId) return false;
    if(typeof state === 'undefined' || !state) return false;
    if(!Array.isArray(state.pinnedConnIds)) return false;
    return state.pinnedConnIds.indexOf(connId) >= 0;
  }catch(e){
    console.warn('isConnPinned error', e);
    return false;
  }
}

function setConnPinned(connId, pinned){
  try{
    if(!connId) return;
    if(typeof state === 'undefined' || !state) return;
    if(!Array.isArray(state.pinnedConnIds)){
      state.pinnedConnIds = [];
    }
    var arr = state.pinnedConnIds;
    var idx = arr.indexOf(connId);
    if(pinned){
      if(idx === -1) arr.push(connId);
    }else{
      if(idx !== -1) arr.splice(idx, 1);
    }
  }catch(e){
    console.warn('setConnPinned error', e);
  }
}

function updateConnPinUI(li, btn, connId){
  try{
    var pinned = isConnPinned(connId);
    if(btn){
      if(pinned){
        btn.classList.add('pinned');
        btn.setAttribute('title', '핀 해제');
      }else{
        btn.classList.remove('pinned');
        btn.setAttribute('title', '핀 고정');
      }
    }
    if(li){
      if(pinned){
        li.classList.add('db-pinned');
      }else{
        li.classList.remove('db-pinned');
      }
    }
  }catch(e){
    console.warn('updateConnPinUI error', e);
  }
}

function attachConnPinControl(li, connId){
  try{
    if(!li || !connId) return;
    var nodeEl = li.querySelector(':scope > .node');
    if(!nodeEl) return;
    var btn = nodeEl.querySelector('.db-pin-btn');
    if(!btn){
      btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'db-pin-btn';
      btn.innerHTML = '<i class="fa-solid fa-thumbtack"></i>';
      btn.addEventListener('click', function(e){
        try{
          e.stopPropagation();
          e.preventDefault();
          var nowPinned = !isConnPinned(connId);
          setConnPinned(connId, nowPinned);
          updateConnPinUI(li, btn, connId);
          var parentUl = li.parentElement;
          if(parentUl && typeof sortDbTreeDepth === 'function'){
            sortDbTreeDepth(parentUl);
          }
        }catch(err){
          console.warn('attachConnPinControl click error', err);
        }
      });
      nodeEl.appendChild(btn);
    }
    updateConnPinUI(li, btn, connId);
  }catch(e){
    console.warn('attachConnPinControl error', e);
  }
}

function sortDbTreeDepth(parentUl){
  try{
    if(!parentUl) return;
    var items = Array.from(parentUl.querySelectorAll(':scope > li'));
    if(!items.length) return;
    var folders = [];
    var pinned = [];
    var dbs = [];
    var others = [];
    items.forEach(function(li){
      if(!li || !li.dataset){
        others.push(li);
        return;
      }
      var kind = li.dataset.kind || '';
      var connId = li.dataset.connId || '';
      if(kind === 'folder'){
        folders.push(li);
      }else if(connId){
        if(isConnPinned(connId)){
          pinned.push(li);
        }else{
          dbs.push(li);
        }
      }else{
        others.push(li);
      }
    });
    if(!folders.length && !pinned.length && !dbs.length){
      return;
    }
    items.forEach(function(li){
      parentUl.removeChild(li);
    });
    folders.concat(pinned, dbs, others).forEach(function(li){
      parentUl.appendChild(li);
    });
  }catch(e){
    console.warn('sortDbTreeDepth error', e);
  }
}

// ---------------- Tab underline helpers (connection state) ----------------
function resetTabUnderlineForConn(connId){
  try{
    if(typeof state === 'undefined' || !state || !Array.isArray(state.tabs)) return;
    var activeConnIds = Object.keys(state.connStates || {}).filter(function(id){
      return !!state.connStates[id];
    });
    state.tabs.forEach(function(t){
      if(!t) return;
      if(connId){
        // 특정 DB 연결이 끊어진 경우: 그 DB에 매핑된 탭만 기본색으로
        if(t.connId === connId){
          t.color = 'default';
        }
      }else{
        // connId 미지정: 모든 탭의 밑줄을 기본색으로 초기화
        t.color = 'default';
      }
    });
  }catch(e){
    console.warn('resetTabUnderlineForConn error', e);
  }
}


// 환경 값이 비어 있을 때 라벨에서 DEV/QA/PROD를 추론하는 헬퍼
function detectEnvFromLabel(label){
  try{
    if(!label) return '';
    var s = label.toString().toLowerCase();
    // 운영 / PROD / OPS
    if(s.indexOf('운영') >= 0 || s.indexOf('prod') >= 0 || s.indexOf('prd') >= 0 || s.indexOf(' ops') >= 0 || s.indexOf('(ops') >= 0){
      return 'PROD';
    }
    // QA / 검증 / 스테이징
    if(s.indexOf('qa') >= 0 || s.indexOf('검증') >= 0 || s.indexOf('staging') >= 0){
      return 'QA';
    }
    // DEV / 개발 / 테스트
    if(s.indexOf('dev') >= 0 || s.indexOf('develop') >= 0 || s.indexOf('개발') >= 0 || s.indexOf('test') >= 0 || s.indexOf('테스트') >= 0){
      return 'DEV';
    }
  }catch(e){
    console.warn('detectEnvFromLabel error', e);
  }
  return '';
}

function applyTabUnderlineForConn(connId){
  try{
    if(typeof state === 'undefined' || !state || !Array.isArray(state.tabs)) return;
    if(!connId) return;

    // 환경 값 조회: state.connEnvs > availableConns.env > 트리 data-env
    var env = '';
    try{
      if(state.connEnvs && Object.prototype.hasOwnProperty.call(state.connEnvs, connId)){
        env = state.connEnvs[connId] || '';
      }else{
        var conns = state.availableConns || [];
        for(var i=0;i<conns.length;i++){
          var c = conns[i];
          if(c && c.id === connId){
            if(typeof c.env !== 'undefined' && c.env !== null){
              env = c.env;
            }
            break;
          }
        }
        if(!env && typeof tree !== 'undefined' && tree && typeof tree.getConnLi === 'function'){
          var li = tree.getConnLi(connId);
          if(li && li.dataset && li.dataset.env){
            env = li.dataset.env;
          }
        }
      }
      // env가 여전히 비어 있으면 라벨에서 DEV/QA/PROD 추론
      if(!env){
        var labelGuess = '';
        try{
          var ac = state.availableConns || [];
          for(var j=0;j<ac.length;j++){
            var cc = ac[j];
            if(cc && cc.id === connId){
              labelGuess = cc.label || cc.name || cc.title || '';
              break;
            }
          }
          if(!labelGuess && typeof tree !== 'undefined' && tree && typeof tree.getConnLi === 'function'){
            var li2 = tree.getConnLi(connId);
            if(li2){
              labelGuess = (li2.dataset && (li2.dataset.label || li2.dataset.name)) || li2.textContent || '';
            }
          }
        }catch(le){
          console.warn('applyTabUnderlineForConn env label detect error', le);
        }
        if(labelGuess && typeof detectEnvFromLabel === 'function'){
          var inferred = detectEnvFromLabel(labelGuess);
          if(inferred){
            env = inferred;
            if(state.connEnvs){
              state.connEnvs[connId] = inferred;
            }
          }
        }
      }
    }catch(e){
      console.warn('applyTabUnderlineForConn env detect error', e);
    }

    var key = (env || '').toString().trim().toUpperCase();
    var color = 'default';
    if(!key){
      color = 'default';
    }else if(key === 'PROD' || key === 'PRD' || key === 'OPS' || key === 'OP'){
      color = 'red';      // 운영
    }else if(key === 'DEV' || key === 'DEVELOP' || key === 'DEVELOPMENT'){
      color = 'green';    // 개발
    }else if(key === 'QA' || key === 'STG' || key === 'STAGE' || key === 'STAGING' || key === 'TEST' || key === 'UAT'){
      color = 'blue';     // QA/테스트
    }else{
      color = 'yellow';   // 기타
    }

    state.tabs.forEach(function(t){
      if(!t) return;
      if(t.connId === connId){
        t.color = color;
      }
    });
  }catch(e){
    console.warn('applyTabUnderlineForConn error', e);
  }
}


function updateEnvBannerForConn(connId){
  try{
    var banner = document.getElementById('envBanner');
    if(!banner) return;

    // 기본: 배너 숨김 + 클래스 초기화
    banner.classList.add('env-banner--hidden');
    banner.classList.remove('env-banner--prod');
    banner.classList.remove('env-banner--dev');
    banner.classList.remove('env-banner--qa');

    // 에디터 영역 환경 클래스 초기화
    var body = document.body || null;
    if(body){
      body.classList.remove('env-prod');
      body.classList.remove('env-dev');
      body.classList.remove('env-qa');
    }

    var titleEl = document.getElementById('envBannerTitle');
    var metaEl  = document.getElementById('envBannerMeta');
    var descEl  = document.getElementById('envBannerDesc');

    if(!connId){
      return;
    }

    // 환경 값 조회: state.connEnvs > availableConns.env > 트리 data-env
    var env = '';
    try{
      if(typeof state !== 'undefined' && state){
        if(state.connEnvs && Object.prototype.hasOwnProperty.call(state.connEnvs, connId)){
          env = state.connEnvs[connId] || '';
        }else if(Array.isArray(state.availableConns)){
          var conns = state.availableConns || [];
          for(var i=0;i<conns.length;i++){
            var c = conns[i];
            if(c && c.id === connId){
              if(typeof c.env !== 'undefined' && c.env !== null){
                env = c.env;
              }
              break;
            }
          }
        }
        if(!env && typeof tree !== 'undefined' && tree && typeof tree.getConnLi === 'function'){
          var li = tree.getConnLi(connId);
          if(li && li.dataset && li.dataset.env){
            env = li.dataset.env;
          }
        }
        // env가 여전히 비어 있을 경우 라벨에서 DEV/QA/PROD 추론
        if(!env){
          var labelGuess = '';
          try{
            var ac = state.availableConns || [];
            for(var j=0;j<ac.length;j++){
              var cc = ac[j];
              if(cc && cc.id === connId){
                labelGuess = cc.label || cc.name || cc.title || '';
                break;
              }
            }
            if(!labelGuess && typeof tree !== 'undefined' && tree && typeof tree.getConnLi === 'function'){
              var li2 = tree.getConnLi(connId);
              if(li2){
                labelGuess = (li2.dataset && (li2.dataset.label || li2.dataset.name)) || li2.textContent || '';
              }
            }
          }catch(le){
            console.warn('updateEnvBannerForConn env label detect error', le);
          }
          if(labelGuess && typeof detectEnvFromLabel === 'function'){
            var inferred = detectEnvFromLabel(labelGuess);
            if(inferred){
              env = inferred;
              if(state.connEnvs){
                state.connEnvs[connId] = inferred;
              }
            }
          }
        }
      }
    }catch(e){
      console.warn('updateEnvBannerForConn env detect error', e);
    }

    var key = (env || '').toString().trim().toUpperCase();

    // DEV / QA / PROD 모두 배너 표시 (문구·색상만 다름)
    var titleText = '';
    var metaText  = '';
    var descText  = '';
    var cls       = '';

    if(key === 'PROD' || key === 'PRD' || key === 'OPS' || key === 'OP'){
      titleText = '운영 DB에 접속 중입니다.';
      metaText  = 'PROD · 고위험 환경';
      descText  = '운영 DB에서의 쿼리 실행 및 다운로드에는 강화된 통제·승인 정책이 적용됩니다.';
      cls       = 'env-banner--prod';
    }else if(key === 'QA'){
      titleText = 'QA DB에 접속 중입니다.';
      metaText  = 'QA · 검증 환경';
      descText  = 'QA 환경에서의 실행 결과는 검증용이며, 운영 반영 전 테스트에 사용됩니다.';
      cls       = 'env-banner--qa';
    }else if(key === 'DEV'){
      titleText = '개발 DB에 접속 중입니다.';
      metaText  = 'DEV · 개발 환경';
      descText  = '개발/테스트 전용 DB이며, 실제 고객정보가 아닐 수 있습니다.';
      cls       = 'env-banner--dev';
    }

    if(cls){
      if(titleEl){ titleEl.textContent = titleText; }
      if(metaEl){  metaEl.textContent  = metaText; }
      if(descEl){  descEl.textContent  = descText; }
      banner.classList.remove('env-banner--hidden');
      banner.classList.add(cls);

      // 에디터 영역 색상을 위한 body 클래스 적용
      if(body){
        if(key === 'PROD' || key === 'PRD' || key === 'OPS' || key === 'OP'){
          body.classList.add('env-prod');
        }else if(key === 'QA'){
          body.classList.add('env-qa');
        }else if(key === 'DEV'){
          body.classList.add('env-dev');
        }
      }
    }
  }catch(e){
    console.warn('updateEnvBannerForConn error', e);
  }
}

// 탭 제목에 DB 라벨을 붙이는 헬퍼 (＜라벨＞ SQL N 형태)

// 탭 제목에서 접두사(＜...＞)를 제거하고 '코어' 제목만 반환
function getTabCoreTitle(title){
  try{
    if(!title) return '';
    var t = String(title).trim();
    // 앞쪽에 '<...>' 또는 '＜...＞' 형태의 접두사가 있으면 제거하고 나머지를 코어 제목으로 사용
    var m = t.match(/^[<＜]\s*([^>＞]+)\s*[>＞]\s*(.*)$/);
    if(m){
      // m[1] = 라벨, m[2] = 코어
      return (m[2] || '').trim() || (m[1] || '').trim();
    }
    return t;
  }catch(e){
    console.warn('getTabCoreTitle error', e);
    return title || '';
  }
}


// 탭 제목에 DB 라벨을 붙이는 헬퍼: 내부 title은 코어만 유지하고,
// 화면에 보일 때만 '＜라벨＞ 코어제목' 형태로 사용한다.
function applyConnLabelToTabTitle(tab, connId){
  try{
    if(!tab || !connId) return (tab && (tab.title || tab.id || '')) || '';
    var baseTitle = tab.title || tab.id || '';
    baseTitle = getTabCoreTitle(baseTitle);
    var label = '';
    try{
      var conns = state && state.availableConns ? state.availableConns : [];
      for(var i=0;i<conns.length;i++){
        var c = conns[i];
        if(c && c.id === connId){
          label = c.label || c.id || '';
          break;
        }
      }
      if(!label && typeof tree !== 'undefined' && tree && typeof tree.getConnLi === 'function'){
        var li = tree.getConnLi(connId);
        if(li){
          if(li.dataset && li.dataset.label){
            label = li.dataset.label;
          }else if(li.textContent){
            label = li.textContent.trim();
          }
        }
      }
    }catch(e){
      console.warn('applyConnLabelToTabTitle label detect error', e);
    }
    if(!label) return baseTitle;
    return '＜' + label + '＞ ' + (baseTitle || '');
  }catch(e){
    console.warn('applyConnLabelToTabTitle error', e);
    return (tab && (tab.title || tab.id || '')) || '';
  }
}



const DBAM_AUTO_SAVE_KEY = 'dbam_editor_session_v1';

function initAutoSaveTimer(){
  try{
    if (!window.localStorage) return;
    // 기존 타이머 정리
    if (window._dbamAutoSaveTimer) {
      clearInterval(window._dbamAutoSaveTimer);
      window._dbamAutoSaveTimer = null;
    }
    if (!state.autoSaveEditor) return;
    const sec = state.autoSaveIntervalSec || 5;
    const interval = Math.max(3000, sec * 1000);
    window._dbamAutoSaveTimer = setInterval(()=>{
      try{
        if (ui && typeof ui.autoSaveSession === 'function') {
          ui.autoSaveSession();
        }
      }catch(e){
        console.warn('autoSaveSession interval error', e);
      }
    }, interval);
  }catch(e){
    console.warn('initAutoSaveTimer error', e);
  }
}

// 브라우저 종료/새로고침 직전에 한 번 더 시도
window.addEventListener('beforeunload', function(){
  try{
    if (ui && typeof ui.autoSaveSession === 'function') {
      ui.autoSaveSession();
    }
  }catch(e){}
});

const dbamHint = {
  tables: {},
  updateTablesFromTreeData(data){
    const map = {};
    try{
      if (data && Array.isArray(data.connections)) {
        data.connections.forEach(conn => {
          (conn.schemas || []).forEach(sc => {
            (sc.tables || []).forEach(tname => {
              const shortName = tname;
              if (!map[shortName]) {
                map[shortName] = [];
              }
            });
          });
        });
      }
    }catch(e){
      console.warn('dbamHint.updateTablesFromTreeData error', e);
    }
    this.tables = map;
    window.dbamSqlTables = map;
  },
  addColumnsForTable(schema, table, columns){
    try{
      const shortName = table;
      if (!window.dbamSqlTables) {
        window.dbamSqlTables = {};
      }
      if (!window.dbamSqlTables[shortName]) {
        window.dbamSqlTables[shortName] = [];
      }
      (columns || []).forEach(c => {
        if (window.dbamSqlTables[shortName].indexOf(c) === -1) {
          window.dbamSqlTables[shortName].push(c);
        }
      });
    }catch(e){
      console.warn('dbamHint.addColumnsForTable error', e);
    }
  }
};

function dbamSmartSqlHint(cm, options){
  if (!window.CodeMirror) return;

  // 활성 탭에 연결된 데이터베이스가 없으면 자동완성 비활성화
  try{
    if (typeof state !== 'undefined') {
      const activeTab = (state.tabs || []).find(t => t.id === state.activeTabId);
      const connId = activeTab && activeTab.connId;
      const on = connId && state.connStates && state.connStates[connId];
      if (!on) {
        return;
      }
    }
  }catch(e){
    if (window.console && console.warn) {
      console.warn('dbamSmartSqlHint conn guard error', e);
    }
  }

  const cursor = cm.getCursor();
  const docText = cm.getValue();
  const cursorIdx = cm.indexFromPos(cursor);

  // 기본 테이블 및 별칭 맵 추출
  let defaultTable = null;
  const aliasMap = {};
  if (window.dbamSqlTables && Object.keys(window.dbamSqlTables).length) {
    // 1) 커서 이전(before)에서 FROM / JOIN 스캔
    const before = docText.slice(0, cursorIdx);
    const re = /\b(from|join)\s+([a-zA-Z_][\w$]*(?:\.[a-zA-Z_][\w$]*)?)(?:\s+(?:as\s+)?([a-zA-Z_][\w$]*))?/ig;
    let m;
    while ((m = re.exec(before)) !== null) {
      let rawTable = m[2];
      const dotIdx = rawTable.lastIndexOf('.');
      if (dotIdx !== -1) {
        rawTable = rawTable.substring(dotIdx + 1);
      }
      const tableName = rawTable;
      defaultTable = tableName;
      const alias = m[3];
      if (alias) {
        aliasMap[alias.toLowerCase()] = tableName;
      }
      aliasMap[tableName.toLowerCase()] = tableName;
    }

    // 2) 커서 이전에 FROM/JOIN이 없으면, 커서 이후(after)에서 첫 FROM/JOIN만 검색
    if (!defaultTable) {
      const after = docText.slice(cursorIdx);
      const re2 = /\b(from|join)\s+([a-zA-Z_][\w$]*(?:\.[a-zA-Z_][\w$]*)?)/i;
      const m2 = re2.exec(after);
      if (m2 && m2[2]) {
        let rawTable2 = m2[2];
        const dotIdx2 = rawTable2.lastIndexOf('.');
        if (dotIdx2 !== -1) {
          rawTable2 = rawTable2.substring(dotIdx2 + 1);
        }
        const tableName2 = rawTable2;
        defaultTable = tableName2;
        aliasMap[tableName2.toLowerCase()] = tableName2;
      }
    }
  }

  // 현재 라인의 커서 앞 텍스트로 alias / 컬럼 prefix 추출
  const lineText = cm.getLine(cursor.line) || "";
  const beforeCursor = lineText.slice(0, cursor.ch);

  let aliasPart = null;
  let colPrefix = "";
  const aliasMatch = /([a-zA-Z_][\w$]*)\.\s*([a-zA-Z_0-9$]*)$/.exec(beforeCursor);
  if (aliasMatch) {
    aliasPart = aliasMatch[1];
    colPrefix = aliasMatch[2] || "";
  } else {
    const colMatch = /([a-zA-Z_][\w$]*)$/.exec(beforeCursor);
    if (colMatch) {
      colPrefix = colMatch[1];
    }
  }

  // 1) alias.컬럼 패턴인 경우: FROM/JOIN에 정의된 alias만 허용
  if (aliasPart) {
    const key = aliasPart.toLowerCase();
    const tableName = aliasMap[key];

    // FROM/JOIN에 없는 alias면 컬럼 자동완성 차단
    if (!tableName || !window.dbamSqlTables || !window.dbamSqlTables[tableName]) {
      return { list: [], from: cursor, to: cursor };
    }

    const cols = window.dbamSqlTables[tableName] || [];
    const lowerPrefix = (colPrefix || "").toLowerCase();
    const list = cols.filter(c => !colPrefix || c.toLowerCase().startsWith(lowerPrefix));

    if (!list.length) {
      return { list: [], from: cursor, to: cursor };
    }

    const fromCh = cursor.ch - (colPrefix || "").length;
    return {
      list: list,
      from: CodeMirror.Pos(cursor.line, fromCh),
      to: CodeMirror.Pos(cursor.line, cursor.ch)
    };
  }

  // 2) alias가 없고 defaultTable이 있는 경우: 기본 테이블 컬럼 자동완성 (SELECT/WHERE 등)
  if (defaultTable && window.dbamSqlTables && window.dbamSqlTables[defaultTable]) {
    const cols = window.dbamSqlTables[defaultTable] || [];
    const token = cm.getTokenAt(cursor);
    const tokenStr = token && typeof token.string === "string" ? token.string : "";
    const tokenType = token && token.type ? token.type : "";

    // 키워드 토큰에는 개입하지 않고, 식별자일 때만 개입
    if (tokenType !== "keyword" && /[\w$]/.test(tokenStr)) {
      let startCh = token.start;
      let prefix = "";
      const rel = cursor.ch - startCh;
      if (rel >= 0) {
        const sub = tokenStr.slice(0, rel);
        const mWord = /([a-zA-Z_0-9$]+)$/.exec(sub);
        if (mWord) {
          prefix = mWord[1];
          startCh = cursor.ch - prefix.length;
        } else {
          startCh = cursor.ch;
        }
      } else {
        startCh = cursor.ch;
      }

      const lowerPrefix = prefix.toLowerCase();
      const list = cols.filter(c => !prefix || c.toLowerCase().startsWith(lowerPrefix));

      if (list.length) {
        return {
          list: list,
          from: CodeMirror.Pos(cursor.line, startCh),
          to: CodeMirror.Pos(cursor.line, cursor.ch)
        };
      }
    }
  }

  // 3) 나머지는 CodeMirror 기본 SQL 힌트로 위임
  if (!CodeMirror.hint || !CodeMirror.hint.sql) return;

  options = options || {};
  options.completeSingle = false;
  if (window.dbamSqlTables && Object.keys(window.dbamSqlTables).length) {
    options.tables = window.dbamSqlTables;
  }

  const inner = CodeMirror.hint.sql(cm, options) || {};
  if (!inner.list || !Array.isArray(inner.list)) {
    return inner;
  }

  // table.column 형식의 항목은 display에는 컬럼명만 보이게 정리
  inner.list = inner.list.map(item => {
    if (typeof item === "string") {
      const idx = item.lastIndexOf(".");
      return idx >= 0 ? item.substring(idx + 1) : item;
    }
    const copy = Object.assign({}, item);
    if (typeof copy.text === "string") {
      const idx = copy.text.lastIndexOf(".");
      if (idx >= 0) {
        const short = copy.text.substring(idx + 1);
        copy.text = short;
        if (!copy.displayText) {
          copy.displayText = short;
        }
      }
    }
    return copy;
  });

  return inner;
};
/* ---------------- Helper: DB label & history time ---------------- */
function getConnLabel(connId){
  if(!connId) return '';
  const conns = state.availableConns || [];
  for(const c of conns){
    if(c.id === connId){
      return c.label || c.id;
    }
  }
  return connId;
}
function formatHistoryTime(d){
  try{
    const pad = (n)=> String(n).padStart(2,'0');
    const yy = String(d.getFullYear()).slice(2);
    return `${yy}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }catch(e){
    return '';
  }
}

/* ---------------- UI: Tabs, Editor, Resizers, Theme/Keymap, Server Panel ---------------- */
const ui = {
  favSaveMode: 'new',
  favSaveEditType: null,
  favSaveEditId: null,

  init(){
    // CodeMirror 활성화 (라이트 테마 기본)
    try{
      cm = CodeMirror.fromTextArea(document.getElementById('sqlEditor'), {
        mode: 'text/x-sql',
        lineNumbers: true,
        matchBrackets: true,
        indentWithTabs: true,
        smartIndent: true,
        theme: 'default',
        extraKeys: {
          'Ctrl-Space': function(cmInstance){
            if (window.CodeMirror && CodeMirror.hint && CodeMirror.hint.sql) {
              const options = { completeSingle: false };
              if (window.dbamSqlTables && Object.keys(window.dbamSqlTables).length) {
                options.tables = window.dbamSqlTables;
              }
              CodeMirror.showHint(cmInstance, dbamSmartSqlHint, options);
            }
          }
        }
      });
            // SQL 기본 함수 및 JOIN 관련 키워드 강조 오버레이
      if (cm && typeof cm.addOverlay === 'function') {
        const sqlHighlightOverlay = {
          token: function(stream, state){
            // JOIN 계열 키워드 (LEFT/RIGHT/INNER/OUTER/FULL/CROSS/NATURAL + JOIN)
            if (stream.match(/(LEFT|RIGHT|INNER|OUTER|FULL|CROSS|NATURAL)\b(?=\s+JOIN\b)/i)) {
              return 'keyword';
            }
            // JOIN 자체
            if (stream.match(/JOIN\b/i)) {
              return 'keyword';
            }
            // 집계 함수 등 기본 함수(MAX, MIN, SUM, AVG, COUNT) 강조
            if (stream.match(/(MAX|MIN|SUM|AVG|COUNT)\b(?!\s*\.)/i)) {
              return 'sql-builtin-func';
            }
            // 위 패턴이 다시 나올 때까지 스킵
            while (stream.next() != null &&
                   !stream.match(/(LEFT|RIGHT|INNER|OUTER|FULL|CROSS|NATURAL)\b(?=\s+JOIN\b)/i, false) &&
                   !stream.match(/JOIN\b/i, false) &&
                   !stream.match(/(MAX|MIN|SUM|AVG|COUNT)\b(?!\s*\.)/i, false)) {}
            return null;
          }
        };
        cm.addOverlay(sqlHighlightOverlay);
      }
      cm.setSize(null, 320);
      cm.on('change', (editor, change)=>{
        if(!state.activeTabId) return;
        const tab = state.tabs.find(t=>t.id===state.activeTabId);
        if(tab){
          tab.sql = editor.getValue();
        }
        // 에디터 변경 시 자동 임시저장 (디바운스)
        if (state.autoSaveEditor && window.localStorage && typeof ui._scheduleAutoSave === 'function') {
          ui._scheduleAutoSave();
        }
      });
      cm.on('keydown', (editor, e)=>{
        if(e.ctrlKey && e.key==='Enter' && !e.shiftKey){
          e.preventDefault();
          e.stopPropagation();
          actions.runCurrent();
        }
        if(e.ctrlKey && e.shiftKey && e.key==='Enter'){
          e.preventDefault();
          e.stopPropagation();
          actions.runScript();
        }
        if(e.ctrlKey && e.shiftKey && e.key && e.key.toLowerCase()==='f'){
          e.preventDefault();
          ui.formatSql();
        }
        if(e.ctrlKey && !e.shiftKey && !e.altKey && (e.key === '.' || e.code === 'Period')){
          try{
            if(typeof codeActions !== 'undefined' && codeActions && typeof codeActions.openMenu === 'function'){
              e.preventDefault();
              e.stopPropagation();
              codeActions.openMenu(editor);
            }else if(typeof codeActions !== 'undefined' && codeActions && typeof codeActions.toInList === 'function'){
              e.preventDefault();
              e.stopPropagation();
              codeActions.toInList();
            }
          }catch(err){
            console.warn('codeActions keydown error', err);
          }
        }

        if(e.ctrlKey && !e.shiftKey && !e.altKey && (e.key === '/' || e.code === 'Slash')){
          try{
            if(typeof codeActions !== 'undefined' && codeActions && typeof codeActions.toggleComment === 'function'){
              e.preventDefault();
              e.stopPropagation();
              codeActions.toggleComment();
            }
          }catch(err){
            console.warn('codeActions toggleComment keydown error', err);
          }
        }
        // 스니펫: sel / sel1 / upd / ins / del + Tab
        if(!e.ctrlKey && !e.altKey && e.key === 'Tab'){
          try{
            const pos = editor.getCursor();
            let handled = false;

            // 4글자 패턴 우선: sel1
            if(pos.ch >= 4){
              const from4 = { line: pos.line, ch: pos.ch - 4 };
              const to4   = { line: pos.line, ch: pos.ch };
              const word4 = editor.getRange(from4, to4);
              const w4 = word4 && word4.toLowerCase();
              if(w4 === 'sel1'){
                e.preventDefault();
                e.stopPropagation();
                const snippet = 'SELECT 1 FROM  WHERE ;';
                editor.replaceRange(snippet, from4, to4);
                const cursorCh = from4.ch + 'SELECT 1 FROM '.length;
                editor.setCursor({ line: pos.line, ch: cursorCh });
                handled = true;
              }
            }

            // 3글자 패턴: sel / upd / ins / del
            if(!handled && pos.ch >= 3){
              const from3 = { line: pos.line, ch: pos.ch - 3 };
              const to3   = { line: pos.line, ch: pos.ch };
              const word3 = editor.getRange(from3, to3);
              const w3 = word3 && word3.toLowerCase();

              let snippet = null;
              let cursorOffset = null;

              if(w3 === 'sel'){
                snippet = 'SELECT * FROM  WHERE ;';
                cursorOffset = 'SELECT * FROM '.length;
              }else if(w3 === 'upd'){
                snippet = 'UPDATE  SET  WHERE ;';
                cursorOffset = 'UPDATE '.length;
              }else if(w3 === 'ins'){
                snippet = 'INSERT INTO  () VALUES ();';
                cursorOffset = 'INSERT INTO '.length;
              }else if(w3 === 'del'){
                snippet = 'DELETE FROM  WHERE ;';
                cursorOffset = 'DELETE FROM '.length;
              }

              if(snippet){
                e.preventDefault();
                e.stopPropagation();
                editor.replaceRange(snippet, from3, to3);
                const cursorCh = from3.ch + cursorOffset;
                editor.setCursor({ line: pos.line, ch: cursorCh });
                handled = true;
              }
            }

            if(handled){
              return;
            }
          }catch(err){
            console.warn('snippet Tab error', err);
          }
        }
      });
      // 자동완성: 입력 시 간단 팝업 (SQL 키워드 + 트리에서 가져온 테이블/컬럼)
      cm.on('inputRead', (editor, change) => {
        if (change.origin !== '+input') return;
        const ch = change.text && change.text[0] ? change.text[0] : '';
        if (!ch || !/[\w.]/.test(ch)) return;

        if (window.CodeMirror && CodeMirror.hint && CodeMirror.hint.sql) {
          const options = { completeSingle: false };
          if (window.dbamSqlTables && Object.keys(window.dbamSqlTables).length) {
            options.tables = window.dbamSqlTables;
          }
          CodeMirror.showHint(editor, dbamSmartSqlHint, options);
        }
      });
    
      // 에디터 우클릭 컨텍스트 메뉴 바인딩
      editorCtx.bind(cm.getWrapperElement());
    }catch(err){
      console.warn('CodeMirror 미적용, 기본 textarea 사용');
      editorCtx.bind(document.getElementById('sqlEditor'));
    }

    this.restoreSizes();
    if (!(typeof this.restoreSessionFromAutoSave === 'function' && this.restoreSessionFromAutoSave())) {
      this.newEditorTab();
    }
    document.addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); actions.runCurrent(); }
      if(e.ctrlKey && e.shiftKey && e.key === 'Enter'){ e.preventDefault(); actions.runScript(); }

      // ESC 공통 처리
      if(e.key === 'Escape'){
        ctxMenu.hide();
        editorCtx.hide();

        const sh = document.getElementById('shortcutHelpBackdrop');
        if (sh && sh.classList.contains('show')) {
          this.closeShortcutHelpModal();
        }
        const fb = document.getElementById('favSaveBackdrop');
        if (fb && fb.classList.contains('show')) {
          this.closeFavSaveModal();
        }
      }

      // F2 : 포커싱된 영역에 따라 이름 변경
      const isF2 = (e.key === 'F2' || e.code === 'F2' || e.keyCode === 113 || e.which === 113);
      if(isF2 && !e.ctrlKey && !e.altKey && !e.shiftKey){
        const activeEl = document.activeElement;

        // DB 트리 관련 컨텍스트가 있으면 탭 이름 변경은 절대 수행하지 않는다.
        let hasDbTreeContext = false;

        // 1) 포커스가 DB 트리 안에 있는 경우
        try{
          const dbTree = document.getElementById('dbTree');
          if (dbTree && activeEl && dbTree.contains(activeEl)) {
            hasDbTreeContext = true;
          }
        }catch(err){
          console.warn('global F2 dbTree focus check error', err);
        }

        // 2) dbFolderUi 선택 정보
        if (!hasDbTreeContext) {
          try{
            if (typeof dbFolderUi !== 'undefined' &&
                dbFolderUi &&
                typeof dbFolderUi.getSelectionInfo === 'function') {
              const selInfo = dbFolderUi.getSelectionInfo();
              if (selInfo && selInfo.li) {
                hasDbTreeContext = true;
              }
            }
          }catch(err){
            console.warn('global F2 dbTree selection check error', err);
          }
        }

        // 3) .dbtree-selected 노드가 있는 경우
        if (!hasDbTreeContext && typeof document !== 'undefined') {
          const selNode = document.querySelector('#dbTree .node.dbtree-selected');
          if (selNode) {
            hasDbTreeContext = true;
          }
        }

        // 4) 이름 변경 인풋(.dbtree-folder-edit)이 떠 있는 경우
        if (!hasDbTreeContext && typeof document !== 'undefined') {
          const editInput = document.querySelector('#dbTree .dbtree-folder-edit');
          if (editInput) {
            hasDbTreeContext = true;
          }
        }

        if (hasDbTreeContext) {
          // DB 트리 전용 F2 핸들러에서 이름 변경을 처리하도록 두고,
          // 여기서는 탭 이름 변경을 수행하지 않는다.
          return;
        }

        // 2) 탭 영역 (또는 에디터 등) → 현재 활성 탭 이름 변경
        const tabsEl = document.getElementById('tabs');
        // 탭 컨텍스트 메뉴와 동일하게 ui.startTabInlineRename 경로를 사용한다.
        if (tabsEl && typeof ui !== 'undefined' && typeof ui.startTabInlineRename === 'function') {
          let targetTab = null;

          // 2-1) 현재 포커스가 탭 안에 있는 경우: 그 탭 기준
          if (activeEl && activeEl.closest) {
            const byFocus = activeEl.closest('#tabs .tab');
            if (byFocus) {
              targetTab = byFocus;
            }
          }

          // 2-2) 포커스로 찾은 탭이 없으면 .tab.active 사용
          if (!targetTab) {
            targetTab = tabsEl.querySelector('.tab.active');
          }

          if (targetTab) {
            const tabId = targetTab.dataset && targetTab.dataset.tabId;
            if (tabId) {
              e.preventDefault();
              try{
                ui.startTabInlineRename(tabId);
              }catch(err){
                console.warn('F2 tab rename error', err);
              }
              return;
            }
          }
        }
      }
    }, true);
    this.bindResizers();
    resetTabUnderlineForConn(null);
    this.renderTabs();
    this.refreshConnStatus();
    this.refreshTxnUi();
  },
  setTheme(name){ if(cm){ cm.setOption('theme', name==='default'?'default':name); } },
  setKeymap(k){ if(cm){ cm.setOption('keyMap', 'default'); } },
  refreshTxnUi(){
    const auto = !!state.autoCommit;
    const autoBtn = document.getElementById('btnAutoCommit');
    const icon = document.getElementById('autoCommitIcon');
    const label = document.getElementById('autoCommitLabel');
    const commitBtn = document.getElementById('btnCommit');
    const rollbackBtn = document.getElementById('btnRollback');
    const timeoutLabel = document.getElementById('queryTimeoutLabel');
    if(label){ label.textContent = auto ? 'ON' : 'OFF'; }
    if(icon){
      icon.classList.remove('fa-toggle-on','fa-toggle-off');
      icon.classList.add(auto ? 'fa-toggle-on' : 'fa-toggle-off');
    }
    if(autoBtn){
      autoBtn.title = auto ? '현재 Auto-commit 모드입니다.' : '현재 수동 Commit 모드입니다.';
    }
    if(commitBtn){ commitBtn.disabled = auto; }
    if(rollbackBtn){ rollbackBtn.disabled = auto; }
    if(timeoutLabel){
      const v = state.queryTimeoutMs || 15000;
      try{
        timeoutLabel.textContent = v.toLocaleString();
      }catch(e){
        timeoutLabel.textContent = String(v);
      }
    }
  },
  toggleAutoCommit(){
    state.autoCommit = !state.autoCommit;
    this.refreshTxnUi();
  },
  setQueryTimeoutMs(ms){
    const n = parseInt(ms, 10);
    if(!isFinite(n) || n <= 0){
      alert('타임아웃은 1 이상 숫자(ms)로 입력하세요.');
      return;
    }
    state.queryTimeoutMs = n;
    this.refreshTxnUi();
  },
  toggleServerPanel(){
    if(bottomTabs){
      bottomTabs.toggle('serverPanel');
    }
  },


  openPersonalSqlSave(){
    const el = document.getElementById('personalSqlSaveBackdrop');
    if(!el){ alert('개인 SQL 저장 UI 요소를 찾지 못했습니다.'); return; }
    const tab = state.tabs.find(t=>t.id===state.activeTabId) || null;
    const titleInput = document.getElementById('psSaveTitle');
    const infoSpan = document.getElementById('psSaveInfo');
    const preview = document.getElementById('psSavePreview');
    if(titleInput){
      titleInput.value = tab && tab.title ? tab.title : '';
    }
    if(infoSpan){
      infoSpan.textContent = tab ? (tab.title || tab.id) : '(활성 탭 없음)';
    }
    if(preview){
      try{
        const sql = cm ? cm.getValue() : (document.getElementById('sqlEditor') ? document.getElementById('sqlEditor').value : '');
        preview.textContent = sql ? sql.slice(0, 800) : '';
      }catch(e){
        preview.textContent = '';
      }
    }
    el.classList.remove('hidden');
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');
  },
  closePersonalSqlSave(){
    const el = document.getElementById('personalSqlSaveBackdrop');
    if(!el) return;
    el.classList.remove('show');
    el.classList.add('hidden');
    el.setAttribute('aria-hidden','true');
  },
  confirmPersonalSqlSave(){
    const sql = cm ? cm.getValue() : (document.getElementById('sqlEditor') ? document.getElementById('sqlEditor').value : '');
    if(!sql || !sql.trim()){
      alert('저장할 SQL이 없습니다.');
      return;
    }
    const name = document.getElementById('psSaveTitle') ? document.getElementById('psSaveTitle').value : '';
    const desc = document.getElementById('psSaveDesc') ? document.getElementById('psSaveDesc').value : '';
    // TODO: 서버 API 연동 시 name/desc/sql을 전송하는 로직을 추가
    alert('서버 개인 저장소 연동 전이라 실제 저장은 수행하지 않습니다.\nUI 흐름만 먼저 구현된 상태입니다.');
    this.closePersonalSqlSave();
  },
  openPersonalSqlLoad(){
    const el = document.getElementById('personalSqlLoadBackdrop');
    if(!el){ alert('개인 SQL 불러오기 UI 요소를 찾지 못했습니다.'); return; }
    el.classList.remove('hidden');
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');
  },
  closePersonalSqlLoad(){
    const el = document.getElementById('personalSqlLoadBackdrop');
    if(!el) return;
    el.classList.remove('show');
    el.classList.add('hidden');
    el.setAttribute('aria-hidden','true');
  },
  applyPersonalSqlLoad(){
    // TODO: 서버에서 선택된 SQL 내용을 받아와 에디터에 반영하는 로직을 추가
    alert('서버 개인 저장소 연동 전이라 실제 불러오기는 수행하지 않습니다.\n목록/선택 UI만 먼저 구현된 상태입니다.');
    this.closePersonalSqlLoad();
  },
  openShortcutHelpModal(){
    const el = document.getElementById('shortcutHelpBackdrop');
    if(!el){
      alert('단축키 / 스니펫 안내 UI 요소를 찾지 못했습니다.');
      return;
    }
    el.classList.remove('hidden');
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');

    const first = el.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if(first){ first.focus(); }
  },
  closeShortcutHelpModal(){
    const el = document.getElementById('shortcutHelpBackdrop');
    if(!el) return;
    el.classList.remove('show');
    el.classList.add('hidden');
    el.setAttribute('aria-hidden','true');
  },

  openFavSaveModal(){
    const el = document.getElementById('favSaveBackdrop');
    if(!el){
      alert('즐겨찾기/템플릿 저장 모달 DOM을 찾지 못했습니다.');
      return;
    }

    // 모드: 신규 저장
    this.favSaveMode = 'new';
    this.favSaveEditType = null;
    this.favSaveEditId = null;

    // 저장 대상 라디오 초기화 (개인/공용 선택 가능)
    const typePersonal = el.querySelector('input[name="favSaveType"][value="PERSONAL"]');
    const typeOrg = el.querySelector('input[name="favSaveType"][value="ORG"]');
    if(typePersonal){
      typePersonal.disabled = false;
      typePersonal.checked = true;
    }
    if(typeOrg){
      typeOrg.disabled = false;
      typeOrg.checked = false;
    }

    // 현재 에디터 SQL (선택 영역 우선)
    let sql = '';
    if(typeof cm !== 'undefined' && cm && typeof cm.getSelection === 'function'){
      sql = cm.getSelection();
      if(!sql || !sql.trim()){
        // 선택이 없으면 전체 에디터 내용 사용
        if(typeof cm.getValue === 'function'){
          sql = cm.getValue();
        }
      }
    }else if(this.getEditor){
      sql = this.getEditor() || '';
    }else if(typeof ui !== 'undefined' && ui && typeof ui.getEditor === 'function'){
      sql = ui.getEditor() || '';
    }
    if(!sql || !sql.trim()){
      alert('저장할 SQL이 없습니다.');
      return;
    }
    const firstLine = (sql.split(/\r?\n/)[0] || '').trim();
    const titleInput = el.querySelector('#favSaveName');
    if(titleInput){
      titleInput.value = firstLine.slice(0, 60);
    }

    const descEl = el.querySelector('#favSaveDesc');
    if(descEl){
      descEl.value = '';
    }

    const catSel = el.querySelector('#favSaveCategory');
    if(catSel){
      catSel.value = 'ETC';
    }
    const bizSel = el.querySelector('#favSaveBiz');
    if(bizSel){
      bizSel.value = 'COMMON';
    }

    const connId = state.connId || '';
    const targetSysSel = el.querySelector('#favSaveTargetSys');
    const targetDbInput = el.querySelector('#favSaveTargetDb');
    if(connId){
      const parts = String(connId).split('_');
      const sysCode = (parts[0] || '').toUpperCase();
      if(targetSysSel){
        const hasOption = Array.prototype.some.call(targetSysSel.options, opt => opt.value === sysCode);
        targetSysSel.value = hasOption ? sysCode : '';
      }
      if(targetDbInput){
        targetDbInput.value = connId;
      }
    }else{
      if(targetSysSel){ targetSysSel.value = ''; }
      if(targetDbInput){ targetDbInput.value = ''; }
    }

    const tagsInput = el.querySelector('#favSaveTags');
    if(tagsInput){
      tagsInput.value = '';
    }

    const sqlPreview = el.querySelector('#favSaveSqlPreview');
    if(sqlPreview){
      sqlPreview.value = sql;
    }

    // 유형에 따라 필드 활성/비활성 동기화
    this._syncFavSaveTypeUI();

    el.classList.remove('hidden');
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');

    const first = el.querySelector('input, select, textarea, button');
    if(first){ first.focus(); }
  },


  openFavEditModal(type, id){
    const el = document.getElementById('favSaveBackdrop');
    if(!el){
      alert('즐겨찾기/템플릿 저장 모달 DOM을 찾지 못했습니다.');
      return;
    }
    const saveType = (type === 'ORG') ? 'ORG' : 'PERSONAL';

    // 편집 모드 설정
    this.favSaveMode = 'edit';
    this.favSaveEditType = saveType;
    this.favSaveEditId = id;

    // 저장 대상 라디오: 타입에 맞춰 체크 + 비활성화 (타입 변경 방지)
    const typePersonal = el.querySelector('input[name="favSaveType"][value="PERSONAL"]');
    const typeOrg = el.querySelector('input[name="favSaveType"][value="ORG"]');
    if(typePersonal){
      typePersonal.checked = (saveType === 'PERSONAL');
      typePersonal.disabled = true;
    }
    if(typeOrg){
      typeOrg.checked = (saveType === 'ORG');
      typeOrg.disabled = true;
    }

    // 대상 아이템 조회
    let item = null;
    try{
      if(saveType === 'PERSONAL' && typeof favorites !== 'undefined' && favorites && Array.isArray(favorites.list)){
        item = favorites.list.find(it => it.id === id);
      }else if(saveType === 'ORG' && typeof favTpl !== 'undefined' && favTpl && Array.isArray(favTpl.orgList)){
        item = favTpl.orgList.find(t => t.id === id);
      }
    }catch(e){
      console.warn('openFavEditModal item lookup error', e);
    }
    if(!item){
      alert('편집할 항목을 찾지 못했습니다.');
      return;
    }

    // 제목 / 설명
    const titleInput = el.querySelector('#favSaveName');
    if(titleInput){
      titleInput.value = item.name || '';
    }
    const descEl = el.querySelector('#favSaveDesc');
    if(descEl){
      descEl.value = item.description || '';
    }

    // 카테고리 / 업무명 / 태그
    const catSel = el.querySelector('#favSaveCategory');
    if(catSel){
      catSel.value = item.category || 'ETC';
    }
    const bizSel = el.querySelector('#favSaveBiz');
    if(bizSel){
      bizSel.value = item.biz || 'COMMON';
    }
    const tagsInput = el.querySelector('#favSaveTags');
    if(tagsInput){
      tagsInput.value = item.tags || '';
    }

    // 대상 시스템 / DB (조직 공용 템플릿일 때만 사용)
    const targetSysSel = el.querySelector('#favSaveTargetSys');
    const targetDbInput = el.querySelector('#favSaveTargetDb');
    if(saveType === 'ORG'){
      if(targetSysSel){
        targetSysSel.value = item.targetSys || '';
      }
      if(targetDbInput){
        targetDbInput.value = item.targetDbId || '';
      }
    }else{
      if(targetSysSel){ targetSysSel.value = ''; }
      if(targetDbInput){ targetDbInput.value = ''; }
    }

    // SQL 미리보기: 에디터에 변경해둔 내용이 있으면 그걸 우선, 없으면 기존 저장된 SQL
    const sqlPreview = el.querySelector('#favSaveSqlPreview');
    const currentSql = (ui.getEditor && ui.getEditor()) || '';
    const originalSql = item.sql || item.sqlText || '';
    const previewSql = (currentSql && currentSql.trim()) ? currentSql : originalSql;
    if(sqlPreview){
      sqlPreview.value = previewSql;
    }

    // 유형에 따라 필드 활성/비활성 동기화
    this._syncFavSaveTypeUI();

    el.classList.remove('hidden');
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');

    const first = el.querySelector('input, select, textarea, button');
    if(first){ first.focus(); }
  },

  _syncFavSaveTypeUI(){
    const el = document.getElementById('favSaveBackdrop');
    if(!el) return;
    const typeOrg = el.querySelector('input[name="favSaveType"][value="ORG"]');
    const isOrg = !!(typeOrg && typeOrg.checked);
    const orgOnlyBlocks = el.querySelectorAll('[data-favsave-orgonly="true"]');
    orgOnlyBlocks.forEach(block=>{
      if(isOrg){
        block.classList.remove('muted');
        const inp = block.querySelector('input, select, textarea');
        if(inp){ inp.disabled = false; }
      }else{
        block.classList.add('muted');
        const inp = block.querySelector('input, select, textarea');
        if(inp){ inp.disabled = true; }
      }
    });
  },

  closeFavSaveModal(){
    const el = document.getElementById('favSaveBackdrop');
    if(!el) return;
    el.classList.remove('show');
    el.classList.add('hidden');
    el.setAttribute('aria-hidden','true');
  },

  applyFavSaveModal(){
    const el = document.getElementById('favSaveBackdrop');
    if(!el) return;
    try{
      const mode = this.favSaveMode || 'new';
      const editType = this.favSaveEditType || null;
      const editId = this.favSaveEditId || null;

      const typeInput = el.querySelector('input[name="favSaveType"]:checked');
      const type = typeInput ? typeInput.value : 'PERSONAL';

      const nameEl = el.querySelector('#favSaveName');
      const name = nameEl ? nameEl.value.trim() : '';
      if(!name){
        alert('제목을 입력하세요.');
        if(nameEl){ nameEl.focus(); }
        return;
      }

      // 미리보기 영역의 SQL을 우선 사용 (선택 영역/편집 반영)
      const previewEl = el.querySelector('#favSaveSqlPreview');
      let sql = previewEl ? (previewEl.value || '') : '';
      if((!sql || !sql.trim()) && typeof ui !== 'undefined' && ui && typeof ui.getEditor === 'function'){
        sql = ui.getEditor() || '';
      }
      if(!sql || !sql.trim()){
        alert('저장할 SQL이 없습니다.');
        return;
      }

      const descEl = el.querySelector('#favSaveDesc');
      const catSel = el.querySelector('#favSaveCategory');
      const bizSel = el.querySelector('#favSaveBiz');
      const tagsInput = el.querySelector('#favSaveTags');

      const description = descEl ? descEl.value.trim() : '';
      const category = catSel ? catSel.value : 'ETC';
      const biz = bizSel ? bizSel.value : '';
      const tags = tagsInput ? tagsInput.value.trim() : '';
      const connId = state.connId || null;

      if(type === 'PERSONAL'){
        // 개인 즐겨찾기 (편집/신규 모두 favorites 객체를 통해 처리)
        if(typeof favorites !== 'undefined' && favorites){
          if(mode === 'edit' && editType === 'PERSONAL' && typeof favorites.updateFromModal === 'function'){
            favorites.updateFromModal({
              id: editId,
              name,
              description,
              sql,
              connId,
              category,
              biz,
              tags
            });
            alert('개인 즐겨찾기를 수정했습니다. (프로토타입)');
          }else if(typeof favorites.addFromModal === 'function'){
            favorites.addFromModal({
              name,
              description,
              sql,
              connId,
              category,
              biz,
              tags
            });
            alert('개인 즐겨찾기로 저장했습니다. (프로토타입)');
          }else{
            alert('favorites 객체를 찾지 못해 개인 즐겨찾기 저장/수정을 수행하지 못했습니다.');
          }
        }else{
          alert('favorites 객체를 찾지 못해 개인 즐겨찾기 저장/수정을 수행하지 못했습니다.');
        }
      }else{
        // 조직 공용 템플릿
        const targetSysSel = el.querySelector('#favSaveTargetSys');
        const targetDbInput = el.querySelector('#favSaveTargetDb');

        if(!description){
          alert('공용 템플릿 설명을 입력하세요.');
          if(descEl){ descEl.focus(); }
          return;
        }
        const targetSys = targetSysSel ? targetSysSel.value : '';
        const targetDbId = targetDbInput ? targetDbInput.value.trim() : '';
        if(!targetSys){
          alert('대상 시스템을 선택하세요.');
          if(targetSysSel){ targetSysSel.focus(); }
          return;
        }
        if(!targetDbId){
          alert('대상 DB를 입력하세요.');
          if(targetDbInput){ targetDbInput.focus(); }
          return;
        }

        if(typeof favTpl !== 'undefined' && favTpl){
          if(mode === 'edit' && editType === 'ORG' && typeof favTpl.updateOrgFromModal === 'function'){
            favTpl.updateOrgFromModal({
              id: editId,
              name,
              description,
              category,
              biz,
              tags,
              targetSys,
              targetDbId,
              sql
            });
            alert('조직 공용 템플릿을 수정했습니다. (서버 연동 전, 프로토타입)');
          }else if(typeof favTpl.addOrgTemplateFromModal === 'function'){
            favTpl.addOrgTemplateFromModal({
              name,
              description,
              category,
              biz,
              tags,
              targetSys,
              targetDbId,
              sql
            });
            alert('조직 공용 템플릿으로 저장했습니다. (서버 연동 전, 프로토타입)');
          }else{
            alert('조직 공용 템플릿 객체(favTpl)를 찾지 못했습니다. 콘솔 로그로만 출력합니다.');
            console.log('ORG TEMPLATE (dummy):', {
              mode,
              editType,
              editId,
              name,
              description,
              category,
              biz,
              tags,
              targetSys,
              targetDbId,
              sql
            });
          }
        }else{
          alert('조직 공용 템플릿 객체(favTpl)를 찾지 못했습니다. 콘솔 로그로만 출력합니다.');
          console.log('ORG TEMPLATE (dummy):', {
            mode,
            editType,
            editId,
            name,
            description,
            category,
            biz,
            tags,
            targetSys,
            targetDbId,
            sql
          });
        }
      }

      this.closeFavSaveModal();
    }catch(e){
      console.warn('applyFavSaveModal error', e);
      alert('즐겨찾기/템플릿 저장 중 오류가 발생했습니다. 콘솔을 확인하세요.');
    }
  },

  newEditorTab(){
    const id = 'T'+(state.nextTab++);

    const baseConnId = state.connId || null;
    let dbLabel = '';
    try{
      if (baseConnId) {
        const conns = state.availableConns || [];
        for (const c of conns) {
          if (c && c.id === baseConnId) {
            dbLabel = c.label || c.id || '';
            break;
          }
        }
        if (!dbLabel && typeof tree !== 'undefined' && tree && typeof tree.getConnLi === 'function') {
          const li = tree.getConnLi(baseConnId);
          if (li) {
            if (li.dataset && li.dataset.label) {
              dbLabel = li.dataset.label;
            } else if (li.textContent) {
              dbLabel = li.textContent.trim();
            }
          }
        }
      }
    }catch(e){
      console.warn('newEditorTab conn label detect error', e);
    }

    const seq = state.nextTab;
    const title = dbLabel ? ('＜'+dbLabel+'＞ SQL ' + seq) : ('SQL ' + seq);
    const initialSql = '-- '+title+'\nSELECT 1;';

    const tab = {
      id,
      title,
      connId: baseConnId,
      lastConnId: baseConnId,
      sql: initialSql,
      isPinned: false,
      color: 'default'
    };
    state.tabs.push(tab);
    state.activeTabId = id;

    // 새 SQL 탭도 현재 활성/연결된 DB의 환경 색상/배너 규칙을 즉시 반영
    try{
      if (baseConnId && state.connStates && state.connStates[baseConnId]) {
        if (typeof applyTabUnderlineForConn === 'function') {
          applyTabUnderlineForConn(baseConnId);
        }
        if (typeof updateEnvBannerForConn === 'function') {
          updateEnvBannerForConn(baseConnId);
        }
      }else if (typeof updateEnvBannerForConn === 'function') {
        // 연결되지 않은 상태에서 열리는 탭은 배너를 숨김
        updateEnvBannerForConn(null);
      }
    }catch(e){
      console.warn('newEditorTab env color/banner apply error', e);
    }

    this.renderTabs();
    this.setEditor(initialSql);
    this.syncConnSelect();
  },

  newEmptyEditorTab(){
    // 최소 1개 탭 유지용: 내용이 비어 있는 새 SQL 탭을 연다.
    const id = 'T'+(state.nextTab++);

    const baseConnId = state.connId || null;
    let dbLabel = '';
    try{
      if (baseConnId) {
        const conns = state.availableConns || [];
        for (const c of conns) {
          if (c && c.id === baseConnId) {
            dbLabel = c.label || c.id || '';
            break;
          }
        }
        if (!dbLabel && typeof tree !== 'undefined' && tree && typeof tree.getConnLi === 'function') {
          const li = tree.getConnLi(baseConnId);
          if (li) {
            if (li.dataset && li.dataset.label) {
              dbLabel = li.dataset.label;
            } else if (li.textContent) {
              dbLabel = li.textContent.trim();
            }
          }
        }
      }
    }catch(e){
      console.warn('newEmptyEditorTab conn label detect error', e);
    }

    const seq = state.nextTab;
    const title = dbLabel ? ('＜'+dbLabel+'＞ SQL ' + seq) : ('SQL ' + seq);
    const initialSql = '';

    const tab = {
      id,
      title,
      connId: baseConnId,
      lastConnId: baseConnId,
      sql: initialSql,
      isPinned: false,
      color: 'default'
    };
    state.tabs.push(tab);
    state.activeTabId = id;

    // 새 SQL 탭도 현재 활성/연결된 DB의 환경 색상/배너 규칙을 즉시 반영
    try{
      if (baseConnId && state.connStates && state.connStates[baseConnId]) {
        if (typeof applyTabUnderlineForConn === 'function') {
          applyTabUnderlineForConn(baseConnId);
        }
        if (typeof updateEnvBannerForConn === 'function') {
          updateEnvBannerForConn(baseConnId);
        }
      }else if (typeof updateEnvBannerForConn === 'function') {
        // 연결되지 않은 상태에서 열리는 탭은 배너를 숨김
        updateEnvBannerForConn(null);
      }
    }catch(e){
      console.warn('newEmptyEditorTab env color/banner apply error', e);
    }

    this.renderTabs();
    this.setEditor(initialSql);
    this.syncConnSelect();
  },
  newEditorTabFromMenu(){
    // 파일 메뉴/단축키(Ctrl+T)에서 호출되는 전용 새 탭 열기 로직
    // 1) 트리에서 선택된 노드 정보 조회 (DB / 스키마 / 테이블 모두 허용)
    let info = null;
    try{
      // 1-1) 폴더/DB 트리 관리 모듈에서 선택 정보 우선 사용
      if (typeof dbFolderUi !== 'undefined' &&
          dbFolderUi &&
          typeof dbFolderUi.getSelectionInfo === 'function') {
        const sel = dbFolderUi.getSelectionInfo();
        if (sel && sel.li) {
          info = sel;
        }
      }
      // 1-2) 폴더 UI에서 선택 정보를 못 가져온 경우, .dbtree-selected 기반으로 조회
      if ((!info || !info.li) && typeof document !== 'undefined') {
        const selNode = document.querySelector('#dbTree .node.dbtree-selected');
        if (selNode) {
          const li = selNode.closest('li');
          if (li) {
            info = { node: selNode, li };
          }
        }
      }
    }catch(e){
      console.warn('newEditorTabFromMenu: selection resolve error', e);
    }

    // 2) 선택된 노드를 기준으로 connId 추출 (없으면 활성 커넥션 사용)
// 2) 선택된 노드를 기준으로 connId 추출 (없으면 활성 커넥션 사용)
    let connId = null;

    if (info && info.li) {
      try{
        if (typeof tree !== 'undefined' && tree && typeof tree.buildNodeInfo === 'function') {
          const nodeInfo = tree.buildNodeInfo(info.li);
          if (nodeInfo && nodeInfo.connId) {
            connId = nodeInfo.connId;
          }
        }
        if (!connId && info.li.closest) {
          const connLi = info.li.closest('li[data-conn-id]');
          if (connLi && connLi.dataset && connLi.dataset.connId) {
            connId = connLi.dataset.connId;
          }
        }
      }catch(e){
        console.warn('newEditorTabFromMenu: connId resolve error', e);
      }
    }

    // 선택 정보에서 connId를 얻지 못했을 경우: 현재 활성 커넥션(state.connId) 사용
    if (!connId && typeof state !== 'undefined' && state && state.connId) {
      connId = state.connId;
    }

    // 그래도 connId를 찾지 못하면 사용자에게 안내
    if (!connId) {
      alert('새 SQL 탭을 열려면 먼저 왼쪽에서 데이터베이스를 선택해 주세요.');
      return;
    }

    // 3) 해당 DB 연결 상태/사유에 따라 동작 결정 (트리 컨텍스트 메뉴의 "SQL 에디터 열기"와 동일한 정책)
    this._pendingConnSelectUsed   = false;
    this._pendingConnAfterConnect = 'newTab';

    const accessInfo = (state.connAccessInfo && state.connAccessInfo[connId]) || null;
    const isActive   = !!(state.connStates && state.connStates[connId]);

    if (accessInfo && accessInfo.reason && isActive) {
      // 이미 활성 + 사유 등록된 커넥션이면 모달 없이 바로 새 탭
      this.setActiveConn(connId);
      this._pendingConnAfterConnect = null;
      this.newEditorTab();
    } else {
      // 그 외에는 접속 사유/계정 입력 모달 먼저 → confirmConnReason()에서 _pendingConnAfterConnect === 'newTab'이면 새 탭 자동 생성
      if (typeof this.openConnReasonModal === 'function') {
        this.openConnReasonModal(connId);
      } else {
        // 안전망: 모달이 없으면 이전 동작과 동일하게 그냥 새 탭만 생성
        this._pendingConnAfterConnect = null;
        this.newEditorTab();
      }
    }
  },
  closeTab(id){
    const idx = state.tabs.findIndex(t=>t.id===id);
    if(idx>=0){ state.tabs.splice(idx,1); }
    if(state.activeTabId===id){ state.activeTabId = state.tabs.length? state.tabs[state.tabs.length-1].id : null; }
    this.renderTabs();
    this.syncConnSelect();

    // 최소 1개 SQL 탭 유지: 핀 탭이 없고 남은 탭이 없으면 빈 탭 하나 생성
    try{
      const tabs = state.tabs || [];
      const hasPinned = tabs.some(t => t && t.isPinned);
      if (!hasPinned && tabs.length === 0) {
        if (typeof this.newEmptyEditorTab === 'function') {
          this.newEmptyEditorTab();
        } else if (typeof this.newEditorTab === 'function') {
          this.newEditorTab();
        }
      }
    }catch(e){
      console.warn('closeTab min tab guard error', e);
    }
  },
  closeOtherTabs(id){
    state.tabs = state.tabs.filter(t=>t.id===id || t.isPinned);
    state.activeTabId = id;
    this.renderTabs();
    this.syncConnSelect();
  },
  closeAllTabs(){
    const pinnedTabs = state.tabs.filter(t=>t.isPinned);
    if(pinnedTabs.length === 0){
      state.tabs = [];
      state.activeTabId = null;
      this.renderTabs();
      this.syncConnSelect();
      this.clearEditor();

      // 최소 1개 SQL 탭 유지: 핀 탭이 없고 모두 닫힌 경우 빈 탭 하나 생성
      try{
        if (typeof this.newEmptyEditorTab === 'function') {
          this.newEmptyEditorTab();
        } else if (typeof this.newEditorTab === 'function') {
          this.newEditorTab();
        }
      }catch(e){
        console.warn('closeAllTabs min tab guard error', e);
      }
      return;
    }
    state.tabs = pinnedTabs;
    // 첫 번째 핀 탭을 활성 탭으로 전환
    this.switchTab(pinnedTabs[0].id);
  },
  togglePinTab(id){
    const tab = state.tabs.find(t => t.id === id);
    if (!tab) return;
    tab.isPinned = !tab.isPinned;
    this.renderTabs();
    if (typeof this.autoSaveSession === 'function') {
      this.autoSaveSession();
    }
  },
  setTabColor(id, color){
    const tab = state.tabs.find(t => t.id === id);
    if (!tab) return;
    tab.color = color || 'default';
    this.renderTabs();
    if (typeof this.autoSaveSession === 'function') {
      this.autoSaveSession();
    }
  },
  switchTab(id){
    state.activeTabId = id;
    const tab = state.tabs.find(t=>t.id===id);
    if(tab){
      // 탭에 저장된 마지막 연결 DB를 기준으로, 해당 DB가 현재 연결 상태라면 자동으로 활성 커넥션 전환
      try{
        const lastConnId = (tab.lastConnId || tab.connId || null);
        if(lastConnId && state.connStates && state.connStates[lastConnId]){
          const prevPendingAfter  = this._pendingConnAfterConnect;
          const prevPendingSelect = this._pendingConnSelectUsed;
          this._pendingConnAfterConnect = null;
          this._pendingConnSelectUsed   = true;
          this.setActiveConn(lastConnId);
          this._pendingConnAfterConnect = prevPendingAfter;
          this._pendingConnSelectUsed   = prevPendingSelect;
        }
      }catch(e){
        console.warn('switchTab auto-connect error', e);
      }

      this.setEditor(tab.sql || '');
      if(tab.result && tab.result.lastResult){
        state.lastResult = Object.assign({}, tab.result.lastResult);
        grid.render(state.lastResult.columns||[], state.lastResult.rows||[]);
        document.getElementById('execMeta').innerHTML = tab.result.execMeta || '';
        document.getElementById('messages').textContent = tab.result.messages || '';
        this.showResult();
      }else{
        this.clearResult();
      }
    }
    this.renderTabs();
    this.syncConnSelect();

    // 탭 전환 시 히스토리/최근 쿼리 패널도 현재 탭의 DB 기준으로 다시 렌더링
    try{
      if(typeof historyPanel !== 'undefined' && historyPanel && typeof historyPanel.render === 'function'){
        historyPanel.render();
      }
      if(typeof queryHistorySidebar !== 'undefined' && queryHistorySidebar && typeof queryHistorySidebar.render === 'function'){
        queryHistorySidebar.render();
      }
    }catch(e){
      console.warn('switchTab history/querySidebar render error', e);
    }
  },
  reorderTabs(fromId, toId, placeAfter){
    if(!fromId || !toId || fromId===toId) return;
    const fromIdx = state.tabs.findIndex(t=>t.id===fromId);
    let toIdx = state.tabs.findIndex(t=>t.id===toId);
    if(fromIdx<0 || toIdx<0) return;
    // 배열에서 먼저 제거
    const moved = state.tabs.splice(fromIdx, 1)[0];
    // 왼쪽에서 오른쪽으로 이동하는 경우 인덱스 보정
    if(fromIdx < toIdx){ toIdx -= 1; }
    // 기준 탭의 앞/뒤로 넣을지 결정
    if(placeAfter){ toIdx += 1; }
    if(toIdx < 0){ toIdx = 0; }
    if(toIdx > state.tabs.length){ toIdx = state.tabs.length; }
    state.tabs.splice(toIdx, 0, moved);
    // 드래그로 이동한 탭을 활성 탭으로 전환
    state.activeTabId = fromId;
    this.switchTab(fromId);
  },

  showTabRenameToast(msg){
    try{
      var el = document.getElementById('tabRenameToast');
      if(!el) return;
      el.textContent = msg || '';
      el.classList.add('show');
      clearTimeout(el._hideTimer);
      el._hideTimer = setTimeout(function(){
        el.classList.remove('show');
      }, 2200);
    }catch(e){
      if(window.console && console.warn){
        console.warn('tabRenameToast error', e);
      }
    }
  },

  startTabInlineRename(tabId){
    try{
      const tabEl = document.querySelector('.tab[data-tab-id="'+tabId+'"]');
      if(!tabEl) return;
      const titleSpan = tabEl.querySelector('.tab-title');
      if(!titleSpan) return;

      // 오류 메시지용 툴팁 요소 (탭 이름 중복 등)
      let err = tabEl.querySelector(':scope > .tab-title-edit-error');
      if(!err){
        err = document.createElement('div');
        err.className = 'tab-title-edit-error';
        tabEl.appendChild(err);
      }
      err.textContent = '';
      err.style.display = 'none';

      let input = tabEl.querySelector('.tab-title-edit');
      const fullText = (titleSpan.textContent || '').trim();

      function showTabError(msg){
        if(!err) return;
        err.textContent = msg || '';
        err.style.display = msg ? 'block' : 'none';
      }

      function getCoreFromStateOrText(){
        let core = '';
        try{
          if(typeof state !== 'undefined' && state && Array.isArray(state.tabs)){
            const tab = state.tabs.find(t => String(t.id) === String(tabId));
            if(tab && typeof tab.title !== 'undefined'){
              if (typeof getTabCoreTitle === 'function') {
                core = getTabCoreTitle(tab.title);
              } else {
                core = String(tab.title);
              }
            }
          }
        }catch(e){
          console.warn('startTabInlineRename: read core from state error', e);
        }
        if(!core){
          try{
            if(typeof getTabCoreTitle === 'function'){
              core = getTabCoreTitle(fullText);
            }else{
              core = fullText;
            }
          }catch(e){
            console.warn('startTabInlineRename: fallback core build error', e);
            core = fullText;
          }
        }
        return core;
      }

      function hasDuplicateTabTitle(coreVal){
        try{
          if(typeof state === 'undefined' || !state || !Array.isArray(state.tabs)) return false;
          const name = (coreVal || '').trim();
          if(!name) return false;
          for(const t of state.tabs){
            if(!t) continue;
            if(t.id === tabId) continue;
            let tCore = '';
            try{
              if(typeof getTabCoreTitle === 'function'){
                tCore = getTabCoreTitle(t.title || t.id || '');
              }else{
                tCore = (t.title || '').trim();
              }
            }catch(e){
              tCore = (t.title || '').trim();
            }
            if(tCore && tCore === name){
              return true;
            }
          }
          return false;
        }catch(e){
          console.warn('hasDuplicateTabTitle error', e);
          return false;
        }
      }

      const coreOriginal = getCoreFromStateOrText();

      if(!input){
        input = document.createElement('input');
        input.type = 'text';
        // 입력창에는 항상 코어 제목만
        input.value = coreOriginal;
        input.className = 'tab-title-edit';

        titleSpan.style.display = 'none';
        if(titleSpan.parentElement){
          titleSpan.parentElement.insertBefore(input, titleSpan);
        }else{
          tabEl.appendChild(input);
        }

        let finished = false;
        let removed = false;
        function cleanup(){
          if(finished) return;
          finished = true;
          input.removeEventListener('keydown', onKey);
          input.removeEventListener('blur', onBlur);
        }

        function apply(val){
          const v = (val || '').trim();
          const targetCore = v || coreOriginal || fullText;

          // 코어 제목 기준으로 중복 체크
          if(v && v !== coreOriginal && hasDuplicateTabTitle(targetCore)){
            try{
              if(typeof ui !== 'undefined' && ui && typeof ui.showTabRenameToast === 'function'){
                ui.showTabRenameToast('같은 이름의 탭이 이미 열려 있습니다.');
              }
            }catch(e){
              if(window.console && console.warn){
                console.warn('tab rename toast error', e);
              }
            }
            setTimeout(()=>{
              input.focus();
              input.select();
            }, 0);
            return false; // 중복 등 오류 시 편집 유지
          }

          // 오류 메시지 제거
          showTabError('');

          try{
            if(typeof state !== 'undefined' && state && Array.isArray(state.tabs)){
              const tab = state.tabs.find(t => String(t.id) === String(tabId));
              if(tab){
                // 내부 상태에는 코어 제목만 저장
                tab.title = targetCore;
              }
            }
            // 탭 전체를 다시 렌더링해서, 화면에는 ＜DB라벨＞ + 코어 제목으로 표시
            if(typeof ui !== 'undefined' && ui){
              if(typeof ui.renderTabs === 'function'){
                ui.renderTabs();
              }
              if(typeof ui._scheduleAutoSave === 'function'){
                ui._scheduleAutoSave();
              }
            }
          }catch(e){
            if(window.console && console.warn){
              console.warn('startTabInlineRename: update title error', e);
            }
          }
          return true;
        }

        function finish(applyChange){
          if(finished) return;
          if(applyChange){
            const ok = apply(input.value);
            if(!ok) return; // 중복 등 오류 시 편집 유지
          }else{
            showTabError('');
            titleSpan.style.display = '';
          }

          if(!removed){
            removed = true;
            try{
              if(input.parentElement){
                input.parentElement.removeChild(input);
              }
            }catch(e){
              if(window.console && console.warn){
                console.warn('tab title input remove error', e);
              }
            }
          }

          cleanup();
        }

        function onKey(e){
          if(e.key === 'Enter'){
            e.preventDefault();
            finish(true);
          }else if(e.key === 'Escape'){
            e.preventDefault();
            finish(false);
          }
        }
        function onBlur(){
          finish(true);
        }

        input.addEventListener('keydown', onKey);
        input.addEventListener('blur', onBlur);
        input.addEventListener('mousedown', function(e){
          e.stopPropagation();
        });
        input.addEventListener('click', function(e){
          e.stopPropagation();
        });
        input.addEventListener('dblclick', function(e){
          e.stopPropagation();
        });
        input.addEventListener('contextmenu', function(e){
          e.stopPropagation();
        });
      }

      input.focus();
      input.select();
    }catch(e){
      console.warn('startTabInlineRename error', e);
    }
  },
  renderTabs(){
    const tabsEl = document.getElementById('tabs');
    if(!tabsEl) return;
    tabsEl.querySelectorAll('.tab').forEach(e=>e.remove());
    state.tabs.forEach(t=>{
      // 렌더링 시점: state.tabs 안의 title 은 '코어' 제목만 가지고 있고,
      // 실제 표시용 라벨은 연결 정보에 따라 동적으로(prefix) 구성한다.
      let baseTitle = (t && (t.title || t.id)) || '';
      let displayTitle = baseTitle;
      try{
        if (typeof getTabCoreTitle === 'function') {
          baseTitle = getTabCoreTitle(baseTitle);
        }
        if (t && typeof applyConnLabelToTabTitle === 'function') {
          var cid = t.connId || t.lastConnId;
          if (cid) {
            const v = applyConnLabelToTabTitle(t, cid);
            if (v) {
              displayTitle = v;
            } else {
              displayTitle = baseTitle;
            }
          } else {
            displayTitle = baseTitle;
          }
        } else {
          displayTitle = baseTitle;
        }
      }catch(e){
        console.warn('renderTabs title build error', e);
        displayTitle = baseTitle;
      }
      const el = document.createElement('div');
      let tabClass = 'tab';
      if (t.id === state.activeTabId) {
        tabClass += ' active';
      }
      if (t.isPinned) {
        tabClass += ' pinned';
      }
      if (t.color && t.color !== 'default') {
        tabClass += ' color-' + t.color;
      }
      el.className = tabClass;
      const on = (t.connId && state.connStates[t.connId]);
      const dotCls = on ? 'conn-on' : 'conn-off';

      const title = displayTitle;
      let html = `<i class="fa-solid fa-circle ${dotCls} conn-dot"></i>`;
      html += `<span class="conn-badge"><span class="tab-title">${title}</span></span>`;
      html += ` <span class="close" title="닫기">✕</span>`;
      el.innerHTML = html;

      el.dataset.tabId = t.id;
      el.draggable = true;
      el.addEventListener('click', (ev)=>{
        if(ev.target.classList && ev.target.classList.contains('close')){
          ui.closeTab(t.id);
        }else{
          ui.switchTab(t.id);
        }
      });
      el.addEventListener('contextmenu', (ev)=>{
        ev.preventDefault();
        tabCtx.open(ev.clientX, ev.clientY, t.id);
      });
      el.addEventListener('dragstart', (ev)=>{
        if(ev.dataTransfer){
          ev.dataTransfer.effectAllowed = 'move';
          ev.dataTransfer.setData('text/plain', t.id);
        }
        el.classList.add('dragging');
      });
      el.addEventListener('dragend', ()=>{
        el.classList.remove('dragging');
      });
      el.addEventListener('dragover', (ev)=>{
        ev.preventDefault();
        if(ev.dataTransfer){
          ev.dataTransfer.dropEffect = 'move';
        }
        const rect = el.getBoundingClientRect();
        const midX = rect.left + rect.width / 2;
        const isAfter = ev.clientX > midX;
        el.classList.toggle('drop-after', isAfter);
        el.classList.toggle('drop-before', !isAfter);
      });
      el.addEventListener('dragleave', ()=>{
        el.classList.remove('drop-before','drop-after');
      });

      el.addEventListener('drop', (ev)=>{
        ev.preventDefault();
        if(!ev.dataTransfer) return;
        const fromId = ev.dataTransfer.getData('text/plain');
        const rect = el.getBoundingClientRect();
        const midX = rect.left + rect.width / 2;
        const placeAfter = ev.clientX > midX;
        el.classList.remove('drop-before','drop-after');
        ui.reorderTabs(fromId, t.id, placeAfter);
      });
      tabsEl.appendChild(el);
    });
    // 활성 탭 라벨 업데이트 (탭 이름 기준)
    const activeSpan = document.getElementById('activeTabLabel');
    if(activeSpan){
      const tab = state.tabs.find(t=>t.id===state.activeTabId);
      if(tab){
        let label = '';
        try{
          let baseTitle = (tab.title || tab.id || '');
          if (typeof getTabCoreTitle === 'function') {
            baseTitle = getTabCoreTitle(baseTitle);
          }
          label = baseTitle;
          const cid = tab.connId || tab.lastConnId;
          if (cid && typeof applyConnLabelToTabTitle === 'function') {
            const v = applyConnLabelToTabTitle(tab, cid);
            if (v) {
              label = v;
            }
          }
        }catch(e){
          console.warn('activeTabLabel build error', e);
          label = tab.title || (state.activeTabId || '-');
        }
        activeSpan.textContent = label || (state.activeTabId || '-');
      }else{
        activeSpan.textContent = state.activeTabId || '-';
      }
    }
    // 탭 오버플로우(>> 버튼) 상태 갱신
    if (typeof this.updateTabOverflow === 'function') {
      this.updateTabOverflow();
    }
  },
  
  

updateTabOverflow(){
    try{
      const tabsEl  = document.getElementById('tabs');
      const btn     = document.getElementById('tabOverflowBtn');
      const menu    = document.getElementById('tabOverflowMenu');
      if(!tabsEl || !btn || !menu) return;

      const tabEls = Array.from(tabsEl.querySelectorAll('.tab'));
      if(!tabEls.length){
        btn.classList.add('hidden');
        menu.classList.add('hidden');
        menu.innerHTML = '';
        return;
      }

      
      const MAX_VISIBLE = 4;
      const activeId = (typeof state !== 'undefined' && state) ? state.activeTabId : null;

      // 먼저 모두 보이게 해서 폭 측정
      tabEls.forEach(el => {
        el.style.display = '';
      });

      let containerWidth = tabsEl.clientWidth || 0;
      if (!containerWidth){
        const rect = tabsEl.getBoundingClientRect();
        containerWidth = rect.width || 0;
      }

      // 활성 탭을 우선 포함한 순서 배열 (선호 순서)
      const prefer = [];
      if (activeId){
        const activeEl = tabEls.find(el => el.dataset.tabId === String(activeId));
        if (activeEl){
          prefer.push(activeEl);
        }
      }
      tabEls.forEach(el => {
        if (prefer.indexOf(el) === -1){
          prefer.push(el);
        }
      });

      const visible = [];
      const marginRatio = 0.94;
      let usedWidth = 0;

      if (!containerWidth){
        // 폭 계산이 불가능한 경우: 단순 개수 기준
        for (const el of prefer){
          if (visible.length >= MAX_VISIBLE) break;
          visible.push(el);
        }
      }else{
        for (const el of prefer){
          const rect = el.getBoundingClientRect();
          const w = rect.width || el.offsetWidth || 0;

          if (!visible.length){
            // 첫 번째(보통 활성 탭)는 무조건 표시
            visible.push(el);
            usedWidth = w;
            continue;
          }
          if (visible.length >= MAX_VISIBLE) break;

          if (usedWidth + w <= containerWidth * marginRatio){
            visible.push(el);
            usedWidth += w;
          }
          // 그 외의 탭은 overflow 대상이 됨 (hidden)
        }
      }

      const hidden = tabEls.filter(el => visible.indexOf(el) === -1);

      // 표시/숨김 반영
      tabEls.forEach(el => {
        if (visible.indexOf(el) !== -1){
          el.style.display = '';
        }else{
          el.style.display = 'none';
        }
      });

      if (!hidden.length){
        btn.classList.add('hidden');
        menu.classList.add('hidden');
        menu.innerHTML = '';
        return;
      }

      // 4) 숨겨진 탭들로 overflow 메뉴 구성
      btn.classList.remove('hidden');
      menu.classList.add('hidden');
      menu.innerHTML = '';

      hidden.forEach(el => {
        const id   = el.dataset.tabId;
        let label = '';
        try{
          if (typeof state !== 'undefined' && state && Array.isArray(state.tabs)) {
            const t = state.tabs.find(t => String(t.id) === String(id));
            if (t) {
              let baseTitle = t.title || t.id || '';
              if (typeof getTabCoreTitle === 'function') {
                baseTitle = getTabCoreTitle(baseTitle);
              }
              label = baseTitle;
              const cid = t.connId || t.lastConnId || (state && state.connId);
              if (cid && typeof applyConnLabelToTabTitle === 'function') {
                const vv = applyConnLabelToTabTitle(t, cid);
                if (vv) label = vv;
              }
            }
          }
        }catch(e){
          console.warn('tab overflow label build error', e);
        }
        if (!label) {
          const span = el.querySelector('.tab-title');
          label = span ? span.textContent.trim() : (id || '');
        }
        if (label) {
          // 공백 정규화: < 와 > 주변과 연속 공백을 정리해서 정렬 맞춤
          label = label.replace(/<\s+/g, '<')
                       .replace(/\s+>/g, '>')
                       .replace(/\s+/g, ' ')
                       .trim();
        }
        const item = document.createElement('div');
        item.className = 'tab-overflow-item';
        item.textContent = label || '(제목 없음)';
        item.dataset.tabId = id || '';
        item.addEventListener('click', function(e){
          e.stopPropagation();
          if (id){
            ui.switchTab(id);
          }
          if (typeof ui.closeTabOverflowMenu === 'function') {
            ui.closeTabOverflowMenu();
          }
        });
        menu.appendChild(item);
      });

    }catch(e){
      console.warn('updateTabOverflow error', e);
    }
  },
  toggleTabOverflowMenu(){
    const menu = document.getElementById('tabOverflowMenu');
    const btn  = document.getElementById('tabOverflowBtn');
    if(!menu || !btn) return;
    if(menu.classList.contains('hidden')){
      menu.classList.remove('hidden');
      try{
        // 일단 보이게 한 뒤 위치 계산 (폭은 auto)
        menu.style.visibility = 'hidden';
        menu.style.display    = 'block';
        menu.style.width      = 'auto';

        const rect = btn.getBoundingClientRect();
        const menuRect = menu.getBoundingClientRect();

        let top  = rect.bottom + 4;
        let left = rect.left; // 버튼의 왼쪽 기준

        const vw = window.innerWidth || document.documentElement.clientWidth || 0;
        // 화면 오른쪽을 넘기면 왼쪽으로 당김
        if (vw && left + menuRect.width > vw - 4){
          left = Math.max(4, vw - menuRect.width - 4);
        }
        // 화면 왼쪽을 넘기면 최소 여백
        if (left < 4) left = 4;

        menu.style.top  = top + 'px';
        menu.style.left = left + 'px';
        menu.style.visibility = '';
        menu.style.display    = '';
      }catch(e){
        console.warn('tabOverflowMenu position error', e);
      }
    }else{
      menu.classList.add('hidden');
    }
  },
  closeTabOverflowMenu(){
    const menu = document.getElementById('tabOverflowMenu');
    if(!menu) return;
    if(!menu.classList.contains('hidden')){
      menu.classList.add('hidden');
    }
  },
  _scheduleAutoSave(){
    if (!state.autoSaveEditor || !window.localStorage) return;
    if (this._autoSaveTimer) {
      clearTimeout(this._autoSaveTimer);
    }
    const sec = state.autoSaveIntervalSec || 5;
    const delay = Math.max(1000, sec * 1000);
    this._autoSaveTimer = setTimeout(()=>{
      try{
        this.autoSaveSession && this.autoSaveSession();
      }catch(e){
        console.warn('autoSaveSession error', e);
      }
    }, delay);
  },
  autoSaveSession(){
    if (!state.autoSaveEditor || !window.localStorage) return;
    try{
      const tabs = (state.tabs || []).map(t => ({
        id: t.id,
        title: t.title,
        connId: t.connId || null,
        lastConnId: t.lastConnId || t.connId || null,
        sql: t.sql || '',
        isPinned: !!t.isPinned,
        color: t.color || 'default'
      }));
      const hasContent = tabs.some(t => (t.sql || '').trim().length > 0);
      if (!hasContent) {
        localStorage.removeItem(DBAM_AUTO_SAVE_KEY);
        return;
      }
      const payload = {
        version: 1,
        savedAt: Date.now(),
        connId: state.connId || null,
        activeTabId: state.activeTabId || (tabs[0] && tabs[0].id) || null,
        tabs
      };
      localStorage.setItem(DBAM_AUTO_SAVE_KEY, JSON.stringify(payload));
    }catch(e){
      console.warn('autoSaveSession error', e);
    }
  },
  restoreSessionFromAutoSave(){
    if (!window.localStorage) return false;
    try{
      const raw = localStorage.getItem(DBAM_AUTO_SAVE_KEY);
      if (!raw) return false;
      const payload = JSON.parse(raw);
      if (!payload || !Array.isArray(payload.tabs) || !payload.tabs.length) return false;
      // 이미 탭이 있는 경우에는 복원하지 않음
      if (state.tabs && state.tabs.length) {
        return false;
      }
      state.tabs = payload.tabs.map(t => ({
        id: t.id,
        title: t.title,
        connId: t.connId || null,
        lastConnId: t.lastConnId || t.connId || null,
        sql: t.sql || '',
        isPinned: !!t.isPinned,
        color: t.color || 'default'
      }));
      // nextTab 계산 (T숫자 기준)
      let next = 1;
      state.tabs.forEach(t => {
        const m = (t.id || '').match(/^T(\d+)$/);
        if (m) {
          const n = parseInt(m[1], 10);
          if (!isNaN(n) && n >= next) {
            next = n + 1;
          }
        }
      });
      state.nextTab = next;
      // activeTabId 결정
      if (payload.activeTabId && state.tabs.find(t => t.id === payload.activeTabId)) {
        state.activeTabId = payload.activeTabId;
      } else if (state.tabs[0]) {
        state.activeTabId = state.tabs[0].id;
      }
      this.renderTabs();
      const active = state.tabs.find(t => t.id === state.activeTabId);
      if (active) {
        this.setEditor(active.sql || '');
      }
      this.syncConnSelect();
      if (typeof this.showToast === 'function') {
        this.showToast('임시저장된 탭/쿼리를 복원했습니다.');
      }
      return true;
    }catch(e){
      console.warn('restoreSessionFromAutoSave error', e);
      return false;
    }
  },


  beginQueryProgress(label){
    try{
      const ov = document.getElementById('queryProgressOverlay');
      if(!ov) return;
      const now = Date.now();
      if (!this._queryBusy) {
        this._progressStartTs = now;
      }
      if (this._progressHideTimer) {
        clearTimeout(this._progressHideTimer);
        this._progressHideTimer = null;
      }
      this._queryBusy = (this._queryBusy || 0) + 1;
      ov.classList.add('is-active');
      const txtEl = ov.querySelector('.qp-text');
      if(txtEl){
        txtEl.textContent = label || '쿼리 실행 중입니다…';
      }
    }catch(e){
      console.warn('beginQueryProgress error', e);
    }
  },
  endQueryProgress(){
    try{
      const ov = document.getElementById('queryProgressOverlay');
      if(!ov) return;
      this._queryBusy = Math.max(0, (this._queryBusy || 0) - 1);
      if(this._queryBusy === 0){
        const now = Date.now();
        const minMs = 500; // 최소 표시 시간
        const started = this._progressStartTs || now;
        const elapsed = now - started;
        const remain = minMs - elapsed;
        const hide = ()=>{
          const el = document.getElementById('queryProgressOverlay');
          if(el){
            el.classList.remove('is-active');
          }
          this._progressHideTimer = null;
        };
        if (remain > 0){
          if (this._progressHideTimer) {
            clearTimeout(this._progressHideTimer);
          }
          this._progressHideTimer = setTimeout(hide, remain);
        } else {
          hide();
        }
      }
    }catch(e){
      console.warn('endQueryProgress error', e);
    }
  },

  setEditor(sql){
    if(cm){
      cm.setValue(sql);
    }else{
      const ta = document.getElementById('sqlEditor');
      if(ta){ ta.value = sql; }
    }
  },
  getEditor(){
    if(cm){
      return cm.getValue();
    }
    const ta = document.getElementById('sqlEditor');
    return ta ? ta.value : '';
  },
  // 에디터 내용 뒤에 SQL을 이어 붙이는 유틸 (히스토리/최근 쿼리/템플릿 공통 사용 가능)
  appendSql(sql){
    if(!sql){ return; }
    try{
      if(typeof ui !== 'undefined' && ui && typeof ui.getEditor === 'function' && typeof ui.setEditor === 'function'){
        const current = ui.getEditor() || '';
        let next = '';
        if(!current || !current.trim()){
          next = sql;
        }else{
          const trimmed = current.replace(/\s*$/, '');
          next = trimmed + '\n\n' + sql;
        }
        ui.setEditor(next);
      }
    }catch(e){
      console.warn('ui.appendSql error', e);
    }
  },
  saveCurrentTabAsSql(){
    if(!state.activeTabId){
      alert('저장할 탭이 없습니다.');
      return;
    }
    const sql = this.getEditor();
    const tab = state.tabs.find(t=>t.id===state.activeTabId) || null;
    const title = tab && tab.title ? tab.title : state.activeTabId;
    // 파일명용: 공백은 '_'로, Windows에서 금지된 문자만 제거하고 한글 등은 그대로 유지
    const rawTitle = title || 'sql_tab';
    let safeTitle = rawTitle.trim().replace(/\s+/g, '_').replace(/[\\/:*?"<>|]/g, '');
    if(!safeTitle){ safeTitle = 'sql_tab'; }
    const defaultName = safeTitle + '.sql';
    const userName = window.prompt('저장할 파일명을 입력하세요 (예: my_query.sql)', defaultName);
    if(!userName){ return; }
    const fileName = userName.trim();
    if(!fileName){
      alert('파일명이 올바르지 않습니다.');
      return;
    }
    const blob = new Blob([sql], {type:'text/sql;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  },
  openSqlFile(){
    let input = document.getElementById('sqlFileInput');
    if(!input){
      input = document.createElement('input');
      input.type = 'file';
      input.id = 'sqlFileInput';
      input.accept = '.sql,.txt,text/*';
      input.style.display = 'none';
      document.body.appendChild(input);
    }
    input.value = '';
    input.onchange = (e)=>{
      const fi = e.target.files && e.target.files[0];
      if(!fi) return;
      const reader = new FileReader();
      reader.onload = (ev)=>{
        const text = (ev.target && ev.target.result) ? ev.target.result : '';
        // 항상 새 탭에 로드
        this.newEditorTab();
        const tab = state.tabs.find(t=>t.id===state.activeTabId);
        if(tab){
          tab.title = fi.name;
          tab.sql = text;
        }
        this.setEditor(text);
        this.renderTabs();
      };
      reader.readAsText(fi, 'utf-8');
    };
    input.click();
  },

  clearEditor(){ this.setEditor(''); },
  formatSql(){
    let sql = this.getEditor() || '';
    if (!sql.trim()) {
      return;
    }

    // 0) 기본 정규화 (CRLF → LF)
    sql = sql.replace(/\r\n/g, '\n');

    // 1) 예약어 대문자화
    const keywords = [
      'select','from','where','group by','order by',
      'join','left join','right join','inner join','outer join','on',
      'insert','into','values','update','set','delete','create',
      'table','view','function','procedure','package','trigger',
      'grant','revoke','alter','drop','with','union','union all'
    ];
    keywords.forEach(k => {
      const re = new RegExp('\\b' + k.replace(/\s+/g,'\\s+') + '\\b','gi');
      sql = sql.replace(re, k.toUpperCase());
    });

    // 1-1) 예약어 외 식별자(컬럼/조건 등)도 대문자화 (옵션)
    const upperAll = (typeof state !== 'undefined' && !!state.formatUpperAll);
    if (upperAll && typeof this._uppercaseNonKeywords === 'function') {
      sql = this._uppercaseNonKeywords(sql);
    }

    // 2) 내 설정: 줄바꿈 옵션 여부
    const breakLines = (typeof state !== 'undefined' && !!state.formatBreakLines);
    if (!breakLines) {
      // 줄바꿈 옵션이 꺼져 있으면 대문자 변환까지만 적용
      this.setEditor(sql.trim());
      return;
    }

    // 3) 주요 절(예약어) 앞뒤로 줄바꿈 (idempotent)
    const clauseKeywords = [
      'SELECT',
      'FROM',
      'WHERE',
      'GROUP BY',
      'HAVING',
      'ORDER BY',
      'INSERT INTO',
      'VALUES',
      'UPDATE',
      'SET',
      'DELETE FROM',
      'WITH',
      'UNION ALL',
      'UNION'
    ];
    // 3-1) 키워드 주변 공백/줄바꿈을 ' KW ' 형태로 정규화
    clauseKeywords.forEach(kw => {
      const reNorm = new RegExp('\\s*' + kw.replace(/\s+/g,'\\s+') + '\\s*','gi');
      sql = sql.replace(reNorm, ' ' + kw + ' ');
    });
    // 3-2) 우리가 원하는 패턴으로 줄바꿈 적용 (키워드별로 제어)
    // SELECT / FROM 등: 키워드를 단독 행에 두고, 본문은 다음 줄 3칸 들여쓰기
    sql = sql.replace(/\s*SELECT\s+/gi, '\nSELECT\n   ');
    sql = sql.replace(/\s*FROM\s+/gi, '\nFROM\n   ');
    sql = sql.replace(/\s*GROUP\s+BY\s+/gi, '\nGROUP BY\n   ');
    sql = sql.replace(/\s*HAVING\s+/gi, '\nHAVING\n   ');
    sql = sql.replace(/\s*ORDER\s+BY\s+/gi, '\nORDER BY\n   ');
    sql = sql.replace(/\s*INSERT\s+INTO\s+/gi, '\nINSERT INTO\n   ');
    sql = sql.replace(/\s*VALUES\s+/gi, '\nVALUES\n   ');
    sql = sql.replace(/\s*UPDATE\s+/gi, '\nUPDATE\n   ');
    sql = sql.replace(/\s*SET\s+/gi, '\nSET\n   ');
    sql = sql.replace(/\s*DELETE\s+FROM\s+/gi, '\nDELETE FROM\n   ');
    sql = sql.replace(/\s*WITH\s+/gi, '\nWITH\n   ');
    sql = sql.replace(/\s*UNION\s+ALL\s+/gi, '\nUNION ALL\n   ');
    sql = sql.replace(/\s*UNION\s+/gi, '\nUNION\n   ');

    // WHERE: 첫 번째 조건은 같은 줄에 배치
    sql = sql.replace(/\s*WHERE\s+/gi, '\nWHERE ');

    // 4) 콤마 기준 줄바꿈 (idempotent)
    sql = sql
      .replace(/,\s*/g, ', ')     // 먼저 ', ' 형태로 정규화
      .replace(/,\s*/g, ',\n   '); // 이후 우리가 쓰는 패턴으로 통일

    // 4-1) WHERE / ON / HAVING 절 안에서 AND / OR 줄바꿈 정리
    {
      const lines = sql.split('\n');
      let inCond = false;
      for (let i = 0; i < lines.length; i++) {
        const trimmed = lines[i].trim();
        if (/^(WHERE|ON|HAVING)\b/.test(trimmed)) {
          inCond = true;
        } else if (/^(SELECT|FROM|GROUP BY|ORDER BY|HAVING|JOIN|UNION|INSERT|UPDATE|DELETE|WITH)\b/.test(trimmed)) {
          inCond = false;
          continue;
        }
        if (!inCond) continue;
        if (!/(AND|OR)\b/i.test(trimmed)) continue;

        // 이미 AND/OR로 시작하는 줄은 들여쓰기만 정규화
        if (/^(AND|OR)\b/i.test(trimmed)) {
          lines[i] = '   ' + trimmed.replace(/^(AND|OR)\b/i, function(m){ return m.toUpperCase(); });
          continue;
        }

        // 한 줄에 조건과 AND/OR가 함께 있을 때 AND/OR를 다음 줄로 내림
        lines[i] = lines[i].replace(/\s+(AND|OR)\s+/gi, function(_m, op){
          return '\n   ' + op.toUpperCase() + ' ';
        });
      }
      sql = lines.join('\n');
    }


    // 5) 공백 정리
    sql = sql
      .replace(/[ \t]+\n/g, '\n')  // 줄 끝 공백 제거
      .replace(/\n{3,}/g, '\n\n')  // 3줄 이상 개행 → 2줄
      .trim();

    this.setEditor(sql);
  },
  _uppercaseNonKeywords(sql){
    // 예약어 대문자화 이후, 문자열/주석을 제외한 영역의 식별자(컬럼/조건 등)를 대문자로 변환
    let out = '';
    let inS = false, inD = false, inLC = false, inBC = false;
    let inDollar = null;
    for (let i = 0; i < sql.length; ) {
      const c = sql[i];
      const c2 = (i + 1 < sql.length) ? sql[i + 1] : '';

      // --- 라인 주석 ---
      if (inLC) {
        out += c;
        if (c === '\n') {
          inLC = false;
        }
        i++;
        continue;
      }
      // --- 블록 주석 ---
      if (inBC) {
        out += c;
        if (c === '*' && c2 === '/') {
          out += c2;
          i += 2;
          inBC = false;
        } else {
          i++;
        }
        continue;
      }
      // --- dollar-quoting ---
      if (inDollar) {
        out += c;
        if (c === '$') {
          const tag = inDollar;
          if (sql.substr(i, tag.length) === tag) {
            out += sql.substr(i + 1, tag.length - 1);
            i += tag.length;
            inDollar = null;
          } else {
            i++;
          }
        } else {
          i++;
        }
        continue;
      }
      // --- 작은따옴표 문자열 ---
      if (inS) {
        out += c;
        if (c === '\'' && (i === 0 || sql[i - 1] != '\\')) {
          inS = false;
        }
        i++;
        continue;
      }
      // --- 큰따옴표 문자열 ---
      if (inD) {
        out += c;
        if (c === '\"' && (i === 0 || sql[i - 1] != '\\')) {
          inD = false;
        }
        i++;
        continue;
      }

      // 모드 진입 판별
      if (c === '-' && c2 === '-') {
        inLC = true;
        out += c + c2;
        i += 2;
        continue;
      }
      if (c === '/' && c2 === '*') {
        inBC = true;
        out += c + c2;
        i += 2;
        continue;
      }
      if (c === '\'') {
        inS = true;
        out += c;
        i++;
        continue;
      }
      if (c === '\"') {
        inD = true;
        out += c;
        i++;
        continue;
      }
      if (c === '$') {
        const m = sql.slice(i).match(/^\$[A-Za-z_]*\$/);
        if (m) {
          inDollar = m[0];
          out += m[0];
          i += m[0].length;
          continue;
        }
      }

      // 코드 영역: 식별자 토큰을 찾아 대문자화
      if (/[A-Za-z_]/.test(c)) {
        let j = i + 1;
        while (j < sql.length && /[A-Za-z0-9_$]/.test(sql[j])) {
          j++;
        }
        const token = sql.slice(i, j);
        out += token.toUpperCase();
        i = j;
        continue;
      }

      // 기타 문자 그대로
      out += c;
      i++;
    }
    return out;
  },

  toggleResult(){
    if(bottomTabs){
      bottomTabs.toggle('result');
    }
  },
  clearResult(){ grid.render([], []); ui.setExecMeta(''); document.getElementById('messages').textContent=''; },
  toggleMaxRows(){ const vals = [200,500,1000,2000]; const i = vals.indexOf(state.maxRows); state.maxRows = vals[(i+1)%vals.length]; document.getElementById('maxRowsLabel').textContent = state.maxRows; },
  refreshConnStatus(){
    const chip = document.getElementById('connStatus');
    const connectedCount = Object.values(state.connStates).filter(Boolean).length;
    state.connected = connectedCount > 0;
    if(state.connected){
      const active = state.connId || '-';
      chip.textContent = `연결됨: ${connectedCount}/${state.availableConns.length} (활성: ${active})`;
      chip.classList.add('ok'); chip.classList.remove('warn');
    } else {
      chip.textContent = '연결되지 않음';
      chip.classList.remove('ok'); chip.classList.add('warn');
    }
  },
  renderConnSelect(){ const sel = document.getElementById('connSelect'); if(!sel) return; sel.innerHTML = '<option value="">선택</option>' + state.availableConns.map(c=>`<option value="${c.id}">${c.label}</option>`).join(''); this.syncConnSelect(); },
  onConnSelectChange(connId){
    const cid = connId || null;

    if (cid) {
      // 셀렉트에서 연결 선택 시:
      // - 이미 활성 + 사유가 등록된 커넥션이면 모달 없이 바로 전환
      // - 그 외에는 사유/ITSM 입력 모달 먼저
      this._pendingConnSelectPrev   = state.connId || '';
      this._pendingConnSelectUsed   = true;
      this._pendingConnAfterConnect = null;

      const info     = (state.connAccessInfo && state.connAccessInfo[cid]) || null;
      const isActive = !!(state.connStates && state.connStates[cid]);

      if (info && info.reason && isActive) {
        // 이미 연결/사유가 있는 경우: 모달 없이 즉시 활성화
        this.setActiveConn(cid);
      } else {
        // 처음 연결하거나, 이전 사유가 없는 경우: 모달 오픈
        this.openConnReasonModal(cid);
      }
    } else {
      // "선택" 등 빈 값 선택 시 활성 커넥션만 해제
      state.connId = null;

      const tab = state.tabs.find(t => t.id === state.activeTabId);
      if (tab) {
        tab.connId = null;
      }

      this.renderTabs();
      this.refreshConnStatus();
      tree.updateConnBadges();
    }
  },
  setActiveConn(connId){
    // 이전에 활성화된 연결 수 (첫 접속 판단용)
    var prevActiveCount = 0;
    try{
      prevActiveCount = Object.keys(state.connStates || {}).filter(function(id){ return !!state.connStates[id]; }).length;
    }catch(e){
      prevActiveCount = 0;
    }

    state.connId = connId;
    if (connId) {
      state.connStates[connId] = true;
      if (typeof applyTabUnderlineForConn === 'function') {
        applyTabUnderlineForConn(connId);
      }
      // env 배너는 활성 탭에 이 연결이 실제로 매핑된 경우에만 아래에서 갱신한다.
      if(typeof sessionMonitor!=='undefined' && sessionMonitor.onConnect){
        sessionMonitor.onConnect(connId);
      }
    }

    var isFirstConnect = (!!connId && prevActiveCount === 0);

    // 활성 탭에 연결을 매핑하는 규칙:
    // - "연결 + 새 탭"(_pendingConnAfterConnect === 'newTab')인 경우: 기존 탭은 그대로 두고 새 탭에서만 사용
    // - 셀렉트 박스에서 변경한 경우(_pendingConnSelectUsed === true): 활성 탭의 연결을 강제로 이 DB로 변경
    // - 그 외(트리에서 일반 "연결" 선택 등): 이 탭에 아직 연결이 없을 때만 매핑
    const tab = state.tabs.find(t => t.id === state.activeTabId);
    if (tab) {
      let mapped = false;
      if (this._pendingConnAfterConnect === 'newTab') {
        // do nothing; newEditorTab()에서 state.connId를 사용
      } else if (this._pendingConnSelectUsed) {
        tab.connId = connId || null;
        mapped = !!connId;
      } else {
        if (!tab.connId) {
          tab.connId = connId || null;
          mapped = !!connId;
        }
      }
      if (mapped && connId) {
        tab.lastConnId = connId;
        // 활성 탭 제목에 DB 라벨 반영 (＜DB＞ SQL N)
      }
    }

    // 첫 접속인 경우: 아직 연결되지 않은 SQL 탭들도 모두 이 DB로 매핑 & 제목 정리
    if (isFirstConnect && connId && Array.isArray(state.tabs)) {
      try{
        state.tabs.forEach(function(t){
          if(!t) return;
          if(!t.connId){
            t.connId = connId;
            t.lastConnId = connId;
          }
        });
      }catch(e){
        console.warn('setActiveConn first-connect tab mapping error', e);
      }
    }

    // 활성 탭 기준으로 환경 배너 갱신
    if (typeof updateEnvBannerForConn === 'function') {
      try{
        var activeTab = null;
        if (Array.isArray(state.tabs) && state.activeTabId) {
          activeTab = state.tabs.find(function(t){ return t && t.id === state.activeTabId; });
        }
        var envConnId = null;
        if (activeTab) {
          envConnId = activeTab.lastConnId || activeTab.connId || null;
        }
        if (!envConnId && connId) {
          envConnId = connId;
        }
        if (envConnId) {
          updateEnvBannerForConn(envConnId);
        } else {
          updateEnvBannerForConn(null);
        }
      }catch(e){
        console.warn('setActiveConn env-banner update error', e);
      }
    }

    const sel = document.getElementById('connSelect');
    if (sel) {
      // 현재 활성 탭 기준으로 셀렉트 값 동기화
      const active = state.tabs.find(t => t.id === state.activeTabId);
      sel.value = (active && active.connId) ? active.connId : '';
    }

    this.renderTabs();
    this.refreshConnStatus();
    tree.updateConnBadges();
  },
  syncConnSelect(){ const sel = document.getElementById('connSelect'); if(!sel) return; const tab = state.tabs.find(t=>t.id===state.activeTabId); sel.value = (tab && tab.connId) ? tab.connId : ''; },
  showResult(){
    if(state.connected && bottomTabs){
      bottomTabs.activate('result');
    }
  },
  bindResizers(){
    // Vertical (sidebar)
    const v = document.getElementById('vResizer');
    const sidebar = document.getElementById('sidebar');
    v.addEventListener('mousedown', startDrag);
    function startDrag(e){ e.preventDefault(); document.body.style.userSelect='none'; document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', stopDrag); }
    function onDrag(e){ const w = Math.min(Math.max(e.clientX, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--min-sidebar-w'))), parseInt(getComputedStyle(document.documentElement).getPropertyValue('--max-sidebar-w'))); sidebar.style.width = w+'px'; localStorage.setItem('sidebarW', w); }
    function stopDrag(){ document.body.style.userSelect=''; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', stopDrag); }
    // Horizontal (editor/result)
    const h = document.getElementById('hResizer');
    const editorBox = ()=> cm ? cm.getWrapperElement() : document.querySelector('.editor textarea');
    h.addEventListener('mousedown', startDragH);
    function startDragH(e){ e.preventDefault(); const eb = editorBox(); const startY = e.clientY; const startH = eb.offsetHeight; document.body.style.userSelect='none';
      function onDragH(ev){ const dh = ev.clientY - startY; const nh = Math.max(startH + dh, 140); if(cm){ cm.setSize(null, nh); } else { eb.style.height = nh+'px'; } localStorage.setItem('editorH', nh); }
      function stopDragH(){ document.body.style.userSelect=''; document.removeEventListener('mousemove', onDragH); document.removeEventListener('mouseup', stopDragH); }
      document.addEventListener('mousemove', onDragH); document.addEventListener('mouseup', stopDragH);
    }
  },
  restoreSizes(){ const sw = localStorage.getItem('sidebarW'); if(sw){ document.getElementById('sidebar').style.width = sw+'px'; } const eh = localStorage.getItem('editorH'); if(eh){ if(cm){ cm.setSize(null, parseInt(eh,10)); } else { document.querySelector('.editor textarea').style.height = eh+'px'; } } },
  disconnect(){
    // 모든 연결 해제 + 트리 강제 접기
    Object.keys(state.connStates).forEach(id=>{
      state.connStates[id]=false;
      if(typeof sessionMonitor!=='undefined' && sessionMonitor.onDisconnect){
        sessionMonitor.onDisconnect(id);
      }
    });
    state.connId=null; state.connected=false;
    resetTabUnderlineForConn(null);
    this.renderTabs();
    tree.updateConnBadges();
    tree.collapseAllConns();
    ui.refreshConnStatus();
    this.renderConnSelect();
    if(bottomTabs){
      bottomTabs.hideArea();
    }
  },

  // --- 접속 사유 / ITSM 연계 모달 ---
  openConnReasonModal(connId){
    const backdrop = document.getElementById('connReasonBackdrop');
    const metaEl   = document.getElementById('connReasonMeta');
    const reasonEl = document.getElementById('connReasonInput');
    const ticketEl = document.getElementById('connTicketInput');
    const userEl   = document.getElementById('connUserInput');
    const passEl   = document.getElementById('connPasswordInput');
    const mfaEl    = document.getElementById('connMfaInput');
    const mfaBtn   = document.getElementById('connMfaSendBtn');

    if(!backdrop || !metaEl || !reasonEl || !ticketEl){
      // DOM이 없으면 그냥 바로 활성화 (백업)
      this.setActiveConn(connId);
      return;
    }

    this._pendingConnId = connId;

    const label = getConnLabel(connId);
    metaEl.textContent = `연결: ${label || connId}`;

    // 접속 사유 / ITSM 번호는 매번 새로 입력받는다 (이전 값은 프리필하지 않음)
    const info = (state.connAccessInfo && state.connAccessInfo[connId]) || {};
    reasonEl.value = '';
    ticketEl.value = '';

    // 계정 입력값은 매번 초기화
    if(userEl) userEl.value = '';
    if(passEl) passEl.value = '';
    if(mfaEl){
      mfaEl.value = '';
      mfaEl.classList.add('hidden');
    }
    if(mfaBtn){
      mfaBtn.classList.remove('hidden');
    }

    backdrop.classList.add('show');
    backdrop.setAttribute('aria-hidden','false');

    setTimeout(()=>{ userEl ? userEl.focus() : reasonEl.focus(); }, 10);
  },
  closeConnReasonModal(){
    const backdrop = document.getElementById('connReasonBackdrop');
    if(backdrop){
      backdrop.classList.remove('show');
      backdrop.setAttribute('aria-hidden','true');
    }
  },
  cancelConnReason(){
    // 셀렉트에서 온 경우, 이전 값으로 롤백
    if(this._pendingConnSelectUsed){
      const sel = document.getElementById('connSelect');
      if(sel){
        sel.value = this._pendingConnSelectPrev || '';
      }
    }
    this._pendingConnId           = null;
    this._pendingConnSelectUsed   = false;
    this._pendingConnSelectPrev   = null;
    this._pendingConnAfterConnect = null;
    this.closeConnReasonModal();
  },
  confirmConnReason(){
    const connId   = this._pendingConnId;
    const userEl   = document.getElementById('connUserInput');
    const passEl   = document.getElementById('connPasswordInput');
    const mfaEl    = document.getElementById('connMfaInput');
    const reasonEl = document.getElementById('connReasonInput');
    const ticketEl = document.getElementById('connTicketInput');

    if(!connId || !reasonEl || !ticketEl || !userEl || !passEl){
      this.closeConnReasonModal();
      return;
    }

    const user   = userEl.value.trim();
    const pass   = passEl.value;
    const mfa    = mfaEl ? mfaEl.value.trim() : '';
    const reason = reasonEl.value.trim();
    const ticket = ticketEl.value.trim();

    if(!user){
      alert('DB 사용자 ID를 입력해 주세요.');
      userEl.focus();
      return;
    }
    if(!pass){
      alert('비밀번호를 입력해 주세요.');
      passEl.focus();
      return;
    }

    if(!reason){
      alert('접속 사유를 입력해 주세요.');
      reasonEl.focus();
      return;
    }

    if(ticket){
      // 공백, 과도한 길이 정도만 1차 체크 (세부 검증은 서버에서)
      if(/\s/.test(ticket)){
        alert('ITSM/작업요청 번호에는 공백을 포함할 수 없습니다.');
        ticketEl.focus();
        return;
      }
      if(ticket.length > 50){
        alert('ITSM/작업요청 번호는 50자 이내로 입력해 주세요.');
        ticketEl.focus();
        return;
      }
    }

    if(!state.connAccessInfo){
      state.connAccessInfo = {};
    }
    state.connAccessInfo[connId] = {
      reason,
      ticketId: ticket,
      activatedAt: new Date().toISOString()
    };

    // TODO: 여기에서 user/pass/mfa를 서버로 보내 실제 DB 연결을 수행하되,
    //       서버나 프론트 state에는 저장하지 않는 구조로 구현해야 함.

    // 실제 활성화
    this.setActiveConn(connId);

    // sql-editor 컨텍스트 메뉴에서 "연결 + 새 탭" 요청한 경우
    if(this._pendingConnAfterConnect === 'newTab'){
      this._pendingConnAfterConnect = null;
      this.newEditorTab();
      // 즐겨찾기(Shift+클릭 등)에서 대기 중인 SQL이 있다면 새 탭에 적용
      if (typeof favorites !== 'undefined' && typeof favorites._applyPendingFavoriteToNewTab === 'function') {
        try{
          favorites._applyPendingFavoriteToNewTab();
        }catch(e){
          console.warn('favorites._applyPendingFavoriteToNewTab error', e);
        }
      }
    }

    this._pendingConnId           = null;
    this._pendingConnSelectUsed   = false;
    this._pendingConnSelectPrev   = null;

    this.closeConnReasonModal();
  },

  
  testConnReason(){
    const userEl   = document.getElementById('connUserInput');
    const passEl   = document.getElementById('connPasswordInput');
    const mfaEl    = document.getElementById('connMfaInput');
    const reasonEl = document.getElementById('connReasonInput');

    if(!userEl || !passEl || !reasonEl){
      alert('연결 테스트에 필요한 입력 항목을 찾지 못했습니다.');
      return;
    }

    const user   = userEl.value.trim();
    const pass   = passEl.value;
    const mfa    = mfaEl ? mfaEl.value.trim() : '';
    const reason = reasonEl.value.trim();

    if(!user){
      alert('DB 사용자 ID를 입력해 주세요.');
      userEl.focus();
      return;
    }
    if(!pass){
      alert('비밀번호를 입력해 주세요.');
      passEl.focus();
      return;
    }
    if(!reason){
      alert('접속 사유를 입력해 주세요.');
      reasonEl.focus();
      return;
    }

    alert('연결 테스트는 추후 백엔드 연동 시 구현할 예정입니다.\n\n입력한 ID/PW/MFA는 서버로 전달만 하고 저장하지 않는 구조로 구현해 주세요.');
  },

  sendConnMfaCode(){
    const userEl = document.getElementById('connUserInput');
    const mfaEl  = document.getElementById('connMfaInput');
    const btn    = document.getElementById('connMfaSendBtn');

    if(!userEl || !userEl.value.trim()){
      alert('먼저 DB 사용자 ID를 입력해 주세요.');
      if(userEl) userEl.focus();
      return;
    }

    // 실제로는 여기서 서버를 통해 MFA 코드를 발송해야 함.
    if(btn){
      btn.classList.add('hidden');
    }
    if(mfaEl){
      mfaEl.classList.remove('hidden');
      mfaEl.focus();
    }

    alert('인증코드를 발송했습니다. 도착한 코드를 입력해 주세요.');
  },

openExportAuditModal(meta){
    const backdrop = document.getElementById('exportAuditBackdrop');
    const metaEl = document.getElementById('exportAuditMeta');
    const warnEl = document.getElementById('exportAuditWarning');
    const apprField = document.getElementById('exportApprovalField');
    const reasonEl = document.getElementById('exportReason');
    const apprEl = document.getElementById('exportApprovalId');

    window.__DBAM_EXPORT_META__ = meta || {};
    const rowCount = meta && typeof meta.rowCount === 'number' ? meta.rowCount : 0;
    const colCount = meta && meta.columns ? meta.columns.length : 0;
    const connLabel = meta && meta.connLabel ? meta.connLabel : (meta && meta.connId ? meta.connId : '(미지정)');
    const ts = new Date().toLocaleString();

    metaEl.textContent =
      `접속: ${connLabel}  |  행 수: ${rowCount.toLocaleString()}  |  컬럼 수: ${colCount}  |  시각: ${ts}`;

    reasonEl.value = '';
    apprEl.value = '';

    const EXPORT_LIMIT_ROWS = 50000;
    if (rowCount >= EXPORT_LIMIT_ROWS) {
      warnEl.style.display = 'block';
      warnEl.textContent =
        `주의: ${EXPORT_LIMIT_ROWS.toLocaleString()}행 이상 대용량 반출입니다. 관리자 승인 후 진행해 주세요.`;
      apprField.style.display = 'block';
    } else {
      warnEl.style.display = 'none';
      warnEl.textContent = '';
      apprField.style.display = 'none';
    }

    backdrop.classList.add('show');
    backdrop.setAttribute('aria-hidden','false');
    setTimeout(()=>{ reasonEl.focus(); }, 10);
  },
  closeExportAuditModal(){
    const backdrop = document.getElementById('exportAuditBackdrop');
    if(backdrop){
      backdrop.classList.remove('show');
      backdrop.setAttribute('aria-hidden','true');
    }
    window.__DBAM_EXPORT_META__ = null;
  },
  confirmExportAudit(){
    const meta = window.__DBAM_EXPORT_META__ || {};
    const reasonEl = document.getElementById('exportReason');
    const apprEl = document.getElementById('exportApprovalId');
    if(!reasonEl) return;
    const reason = reasonEl.value.trim();
    const apprId = apprEl ? apprEl.value.trim() : '';

    if(!reason){
      alert('반출 사유를 입력해 주세요.');
      reasonEl.focus();
      return;
    }

    const rowCount = typeof meta.rowCount === 'number' ? meta.rowCount : 0;
    const EXPORT_LIMIT_ROWS = 50000;

    if(rowCount >= EXPORT_LIMIT_ROWS){
      if(!apprId){
        alert('대용량 반출입니다. 관리자 승인 ID를 입력해 주세요.');
        apprEl && apprEl.focus();
        return;
      }
      const again = confirm(`${EXPORT_LIMIT_ROWS.toLocaleString()}행 이상 결과를 내보내려 합니다. 계속하시겠습니까?`);
      if(!again){
        return;
      }
    }

    this.closeExportAuditModal();

    try{
      actions._sendExportAuditLog({
        reason,
        approvalId: apprId,
        rowCount,
        columns: meta.columns || [],
        sql: meta.sql || '',
        connId: meta.connId || null,
        connLabel: meta.connLabel || null
      });
    }catch(e){
      console.warn('export audit log error', e);
    }

    try{
      actions._doExportExcel();
    }catch(e){
      console.error('export error', e);
      alert('Excel 내보내기 중 오류가 발생했습니다.');
    }
  },
  openMyInfoModal(){
    try{
      var backdrop = document.getElementById('myInfoBackdrop');
      if(!backdrop) return;
      backdrop.classList.add('show');
      backdrop.setAttribute('aria-hidden','false');
    }catch(e){}
  },
  closeMyInfoModal(){
    try{
      var backdrop = document.getElementById('myInfoBackdrop');
      if(!backdrop) return;
      backdrop.classList.remove('show');
      backdrop.setAttribute('aria-hidden','true');
    }catch(e){}
  }
};


function openFavSaveModalFromSql(sql){
  try{
    const el = document.getElementById('favSaveBackdrop');
    if(!el){
      alert('즐겨찾기/템플릿 저장 모달 DOM을 찾지 못했습니다.');
      return;
    }
    if(!sql || !String(sql).trim()){
      alert('저장할 SQL이 없습니다.');
      return;
    }

    // 모드: 신규 저장
    if(typeof ui !== 'undefined' && ui){
      ui.favSaveMode = 'new';
      ui.favSaveEditType = null;
      ui.favSaveEditId = null;
    }

    // 저장 대상 라디오 초기화 (개인/공용 선택 가능)
    const typePersonal = el.querySelector('input[name="favSaveType"][value="PERSONAL"]');
    const typeOrg = el.querySelector('input[name="favSaveType"][value="ORG"]');
    if(typePersonal){
      typePersonal.disabled = false;
      typePersonal.checked = true;
    }
    if(typeOrg){
      typeOrg.disabled = false;
      typeOrg.checked = false;
    }

    const firstLine = (String(sql).split(/\r?\n/)[0] || '').trim();
    const titleInput = el.querySelector('#favSaveName');
    if(titleInput){
      titleInput.value = firstLine.slice(0, 60);
    }

    const descEl = el.querySelector('#favSaveDesc');
    if(descEl){
      descEl.value = '';
    }

    const catSel = el.querySelector('#favSaveCategory');
    if(catSel){
      catSel.value = 'ETC';
    }
    const bizSel = el.querySelector('#favSaveBiz');
    if(bizSel){
      bizSel.value = 'COMMON';
    }

    const connId = (typeof state !== 'undefined' && state && state.connId) ? state.connId : '';
    const targetSysSel = el.querySelector('#favSaveTargetSys');
    const targetDbInput = el.querySelector('#favSaveTargetDb');
    if(connId){
      const parts = String(connId).split('_');
      const sysCode = (parts[0] || '').toUpperCase();
      if(targetSysSel){
        const hasOption = Array.prototype.some.call(targetSysSel.options, function(opt){ return opt.value === sysCode; });
        targetSysSel.value = hasOption ? sysCode : '';
      }
      if(targetDbInput){
        targetDbInput.value = connId;
      }
    }else{
      if(targetSysSel){ targetSysSel.value = ''; }
      if(targetDbInput){ targetDbInput.value = ''; }
    }

    const tagsInput = el.querySelector('#favSaveTags');
    if(tagsInput){
      tagsInput.value = '';
    }

    const sqlPreview = el.querySelector('#favSaveSqlPreview');
    if(sqlPreview){
      sqlPreview.value = String(sql);
    }

    if(typeof ui !== 'undefined' && ui && typeof ui._syncFavSaveTypeUI === 'function'){
      ui._syncFavSaveTypeUI();
    }

    el.classList.remove('hidden');
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');

    const first = el.querySelector('input, select, textarea, button');
    if(first){ first.focus(); }
  }catch(e){
    console.warn('openFavSaveModalFromSql error', e);
  }
}




/* ---------------- Context Menu ---------------- */
function hideAllCtxMenus(){
  try{ if(typeof ctxMenu !== 'undefined' && ctxMenu.hide) ctxMenu.hide(); }catch(e){}
  try{ if(typeof treeCtx !== 'undefined' && treeCtx.hide) treeCtx.hide(); }catch(e){}
  try{ if(typeof editorCtx !== 'undefined' && editorCtx.hide) editorCtx.hide(); }catch(e){}
  try{ if(typeof tabCtx !== 'undefined' && tabCtx.hide) tabCtx.hide(); }catch(e){}
  try{ if(typeof resultCtx !== 'undefined' && resultCtx.hide) resultCtx.hide(); }catch(e){}
  try{ if(typeof historyCtx !== 'undefined' && historyCtx.hide) historyCtx.hide(); }catch(e){}
  try{ if(typeof favCtx !== 'undefined' && favCtx.hide) favCtx.hide(); }catch(e){}
}

const ctxMenu = {
  el: document.getElementById('ctxMenu'),
  targetConn: null,
  open(x, y, connId){
    try{
      hideAllCtxMenus();
    }catch(e){}
    this.targetConn = connId || null;
    if (!this.el) return;

    // 연결 중인 DB는 이름 변경 비활성화
    try{
      const renameItem = this.el.querySelector('li[data-act="rename-conn"]');
      const isOn = !!(connId && typeof state !== 'undefined' && state && state.connStates && state.connStates[connId]);
      if (renameItem){
        if (isOn){
          renameItem.classList.add('disabled');
          renameItem.setAttribute('aria-disabled','true');
        } else {
          renameItem.classList.remove('disabled');
          renameItem.removeAttribute('aria-disabled');
        }
      }
    }catch(e){
      console.warn('ctxMenu.open: rename-conn disable check error', e);
    }

    try{
      this.el.style.left = (x || 0) + 'px';
      this.el.style.top = (y || 0) + 'px';
    }catch(e){}

    this.el.classList.remove('hidden');
    this.el.setAttribute('aria-hidden','false');
  },
  hide(){
    if (!this.el) return;
    this.el.classList.add('hidden');
    this.el.setAttribute('aria-hidden','true');
    this.targetConn = null;
  }
};

// ---------------- DB Tree Filter helpers ----------------
function showDbFilterTag(connId){
  try{
    const li = document.querySelector(`#dbTree li[data-conn-id="${connId}"]`);
    if(!li) return;
    const nodeEl = li.querySelector(':scope > .node');
    if(!nodeEl) return;

    let tag = nodeEl.querySelector('.dbfilter-tag');
    if(!tag){
      tag = document.createElement('span');
      tag.className = 'dbfilter-tag';
      tag.textContent = '(필터링됨)';
      nodeEl.appendChild(tag);
    }
  }catch(e){
    console.warn('showDbFilterTag error', e);
  }
}

function hideDbFilterTag(connId){
  try{
    const li = document.querySelector(`#dbTree li[data-conn-id="${connId}"]`);
    if(!li) return;
    const nodeEl = li.querySelector(':scope > .node');
    if(!nodeEl) return;
    const tag = nodeEl.querySelector('.dbfilter-tag');
    if(tag){
      tag.remove();
    }
  }catch(e){
    console.warn('hideDbFilterTag error', e);
  }
}

function applyDbFilter(connId, keyword){
  try{
    const rootLi = document.querySelector(`#dbTree li[data-conn-id="${connId}"]`);
    if(!rootLi) return;
    const kw = (keyword || '').toLowerCase();

    // 루트 제외 모든 자식 숨김
    const allLis = rootLi.querySelectorAll('li');
    allLis.forEach(li=>{
      if(li !== rootLi){
        li.classList.add('dbfilter-hidden');
      }
    });

    // label에 kw 포함되는 노드 표시 + 조상도 표시
    allLis.forEach(li=>{
      const label = (li.dataset && li.dataset.label ? li.dataset.label : '').toLowerCase();
      if(label && kw && label.indexOf(kw) !== -1){
        li.classList.remove('dbfilter-hidden');
        let p = li.parentElement;
        while(p && p !== rootLi.parentElement){
          if(p.tagName === 'LI'){
            p.classList.remove('dbfilter-hidden');
          }
          p = p.parentElement;
        }
      }
    });

    // 루트는 항상 보이게
    rootLi.classList.remove('dbfilter-hidden');

    // 필터 태그 표시
    showDbFilterTag(connId);
  }catch(e){
    console.warn('applyDbFilter error', e);
  }
}

function clearDbFilter(connId){
  try{
    if(state.connFilters && state.connFilters[connId]){
      delete state.connFilters[connId];
    }
    const rootLi = document.querySelector(`#dbTree li[data-conn-id="${connId}"]`);
    if(!rootLi) return;
    const allLis = rootLi.querySelectorAll('li');
    allLis.forEach(li=>{
      li.classList.remove('dbfilter-hidden');
    });
    hideDbFilterTag(connId);
  }catch(e){
    console.warn('clearDbFilter error', e);
  }
}

// ---------------- DB Filter Modal Controller ----------------
const dbFilterModal = {
  targetConnId: null,
  open(connId){
    this.targetConnId = connId;
    const backdrop = document.getElementById('dbFilterBackdrop');
    const labelEl  = document.getElementById('dbFilterTargetLabel');
    const inputEl  = document.getElementById('dbFilterInput');
    if(!backdrop || !inputEl) return;

    let label = connId || '';
    try{
      const conns = state.availableConns || [];
      const found = conns.find(c => c.id === connId);
      if(found){
        label = found.label || found.id || label;
      }
    }catch(e){}

    if(labelEl){
      labelEl.textContent = label;
    }

    // 기존 필터 값 로딩
    const prev = state.connFilters && state.connFilters[connId];
    inputEl.value = (prev && prev.keyword) ? prev.keyword : '';

    backdrop.classList.remove('hidden');
    backdrop.classList.add('show');
    backdrop.setAttribute('aria-hidden','false');

    setTimeout(()=>{
      try{
        inputEl.focus();
        inputEl.select();
      }catch(e){}
    }, 10);
  },
  close(){
    const backdrop = document.getElementById('dbFilterBackdrop');
    if(!backdrop) return;
    backdrop.classList.remove('show');
    backdrop.classList.add('hidden');
    backdrop.setAttribute('aria-hidden','true');
    this.targetConnId = null;
  },
  apply(){
    const connId = this.targetConnId;
    const inputEl = document.getElementById('dbFilterInput');
    if(!connId || !inputEl){
      this.close();
      return;
    }
    const keyword = inputEl.value.trim();
    if(!keyword){
      clearDbFilter(connId);
      this.close();
      return;
    }
    if(!state.connFilters){ state.connFilters = {}; }
    state.connFilters[connId] = { keyword };
    applyDbFilter(connId, keyword);
    this.close();
  },
  clear(){
    const connId = this.targetConnId;
    if(connId){
      clearDbFilter(connId);
    }
    this.close();
  }
};

(function initDbFilterModal(){
  const backdrop = document.getElementById('dbFilterBackdrop');
  if(!backdrop) return;

  const cancelBtn = document.getElementById('dbFilterCancelBtn');
  const applyBtn  = document.getElementById('dbFilterApplyBtn');
  const closeBtn  = document.getElementById('dbFilterCloseBtn');

  cancelBtn && cancelBtn.addEventListener('click', ()=> dbFilterModal.close());
  applyBtn  && applyBtn.addEventListener('click', ()=> dbFilterModal.apply());
  closeBtn  && closeBtn.addEventListener('click', ()=> dbFilterModal.close());

  backdrop.addEventListener('click', (e)=>{
    if(e.target === backdrop){
      dbFilterModal.close();
    }
  });

  // ESC 로 닫기
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      const back = document.getElementById('dbFilterBackdrop');
      if(back && back.classList.contains('show')){
        // DB 필터 모달이 열려 있을 때는 이 핸들러에서만 처리하고,
        // 다른 ESC 핸들러로 이벤트가 전달되지 않도록 막는다.
        e.preventDefault();
        e.stopPropagation();
        dbFilterModal.close();
      }
    }
  }, true);
})();

// override ctxMenu.open to handle connected/disconnected state (disable connect when already connected)
ctxMenu.open = function(x, y, connId){
  hideAllCtxMenus();
  this.targetConn = connId;
  const el = this.el;
  if(!el) return;

  const isOn = !!(state.connStates && state.connStates[connId]);

  // enable/disable 메뉴 항목
  const connectLi    = el.querySelector('li[data-act="connect"]');
  const reconnectLi  = el.querySelector('li[data-act="reconnect"]');
  const disconnectLi = el.querySelector('li[data-act="disconnect"]');

  if(connectLi){
    connectLi.classList.toggle('disabled', isOn);
    if(isOn){
      connectLi.setAttribute('aria-disabled','true');
    }else{
      connectLi.removeAttribute('aria-disabled');
    }
  }

  // 재접속: 연결된 상태에서만 활성
  if(reconnectLi){
    const off = !isOn;
    reconnectLi.classList.toggle('disabled', off);
    if(off){
      reconnectLi.setAttribute('aria-disabled','true');
    }else{
      reconnectLi.removeAttribute('aria-disabled');
    }
  }

  if(disconnectLi){
    const off = !isOn;
    disconnectLi.classList.toggle('disabled', off);
    if(off){
      disconnectLi.setAttribute('aria-disabled','true');
    }else{
      disconnectLi.removeAttribute('aria-disabled');
    }
  }

  // 이름 변경: 연결된 DB에서는 비활성
  const renameLi = el.querySelector('li[data-act="rename-conn"]');
  if (renameLi) {
    if (isOn) {
      renameLi.classList.add('disabled');
      renameLi.setAttribute('aria-disabled','true');
    } else {
      renameLi.classList.remove('disabled');
      renameLi.removeAttribute('aria-disabled');
    }
  }

  
  // 삭제: 연결된 DB에서는 비활성
  const deleteLi = el.querySelector('li[data-act="delete-conn"]');
  if (deleteLi) {
    if (isOn) {
      deleteLi.classList.add('disabled');
      deleteLi.setAttribute('aria-disabled','true');
    } else {
      deleteLi.classList.remove('disabled');
      deleteLi.removeAttribute('aria-disabled');
    }
  }

// DB 필터 메뉴 활성/비활성
  const filterLi      = el.querySelector('li[data-act="db-filter"]');
  const filterClearLi = el.querySelector('li[data-act="db-filter-clear"]');
  const hasFilter = !!(state.connFilters && state.connFilters[connId]);

  // 필터 적용: 연결된 상태에서만 활성
  if (filterLi) {
    const off = !isOn;
    filterLi.classList.toggle('disabled', off);
    if (off) {
      filterLi.setAttribute('aria-disabled','true');
    } else {
      filterLi.removeAttribute('aria-disabled');
    }
  }

  if(filterClearLi){
    // 필터가 적용된 경우에만 메뉴를 노출
    if(hasFilter){
      filterClearLi.style.display = '';
    }else{
      filterClearLi.style.display = 'none';
    }
  }





  // 하위 모두 펼치기 / 하위 모두 접기: 연결된 DB에서만 노출
  const expandAllLi   = el.querySelector('li[data-act="conn-expand-all"]');
  const collapseAllLi = el.querySelector('li[data-act="conn-collapse-all"]');
  if (expandAllLi && collapseAllLi) {
    if (isOn && connId) {
      // 연결된 DB이면 메뉴 노출
      expandAllLi.style.display   = '';
      collapseAllLi.style.display = '';
    } else {
      // 연결 안 된 상태이거나 connId 없으면 메뉴 숨김
      expandAllLi.style.display   = 'none';
      collapseAllLi.style.display = 'none';
    }
  }

  el.style.left = x + 'px';
  el.style.top  = y + 'px';
  el.classList.remove('hidden');
  el.setAttribute('aria-hidden', 'false');
};
ctxMenu.el.addEventListener('click', (e)=>{
  const li = e.target.closest('li');
  if(!li) return;
  // aria-disabled 또는 disabled class가 있으면 동작하지 않음
  if (li.classList.contains('disabled') || li.getAttribute('aria-disabled') === 'true') return;
  const act = li.getAttribute('data-act');
  if(!act) return;
  const id = ctxMenu.targetConn; if(!id) return;

  switch(act){
    case 'connect':
      ui._pendingConnSelectUsed   = false;
      ui._pendingConnAfterConnect = null;
      ui.openConnReasonModal(id);
      break;
    case 'reconnect':
      ui._pendingConnSelectUsed   = false;
      ui._pendingConnAfterConnect = null;
      // 재접속: 기존에 가지고 있던 정보로 즉시 연결 (접속 사유/계정 입력 모달은 띄우지 않음)
      if (typeof ui.setActiveConn === 'function') {
        ui.setActiveConn(id);
      } else {
        console.warn('reconnect: ui.setActiveConn is not available');
      }
      break;
    case 'disconnect':
      state.connStates[id] = false;
      if(state.connId===id){ state.connId=null; }
      resetTabUnderlineForConn(id);
      ui.renderTabs(); ui.refreshConnStatus(); tree.updateConnBadges(); tree.collapseConn(id);
      break;
    case 'sql-editor':
      ui._pendingConnSelectUsed   = false;
      ui._pendingConnAfterConnect = 'newTab';
      // 이미 사유가 등록된 활성 연결이면 모달을 다시 띄우지 않고 바로 새 탭을 연다.
      const info = (state.connAccessInfo && state.connAccessInfo[id]) || null;
      const isActive = !!(state.connStates && state.connStates[id]);
      if (info && info.reason && isActive) {
        ui.setActiveConn(id);
        ui._pendingConnAfterConnect = null;
        ui.newEditorTab();
      } else {
        ui.openConnReasonModal(id);
      }
      break;
    case 'settings':
      if (typeof connSettings !== 'undefined' && connSettings.open) {
        connSettings.open(id);
      }
      break;
    case 'conn-expand-all':
      (function(){
        const liConn = document.querySelector('#dbTree li[data-conn-id="' + id + '"]');
        if (liConn && typeof tree !== 'undefined' && tree && typeof tree.toggleRecursive === 'function') {
          tree.toggleRecursive(liConn, true);
        }
      })();
      break;
    case 'conn-collapse-all':
      (function(){
        const liConn = document.querySelector('#dbTree li[data-conn-id="' + id + '"]');
        if (liConn && typeof tree !== 'undefined' && tree && typeof tree.toggleRecursive === 'function') {
          tree.toggleRecursive(liConn, false);
        }
      })();
      break;
    case 'db-filter':
      if (id && typeof dbFilterModal !== 'undefined') {
        dbFilterModal.open(id);
      }
      break;
    case 'db-filter-clear':
      if (id) {
        clearDbFilter(id);
      }
      break;
case 'copy-conn': {
      try{
        let label = id;
        if (typeof state !== 'undefined' && state && Array.isArray(state.availableConns)) {
          const found = state.availableConns.find(c => c.id === id);
          if (found && found.label) {
            label = found.label;
          }
        }
        if (typeof dbTreeClipboard !== 'undefined') {
          dbTreeClipboard.type  = 'db';
          dbTreeClipboard.connId = id;
          dbTreeClipboard.label = label;
          dbTreeClipboard.folderLi = null;
        }
      }catch(e){
        console.warn('copy-conn clipboard error', e);
      }
      break;
    }
    case 'paste-conn':
      alert('연결 붙여넣기 기능은 추후 구현 예정입니다.');
      break;
        case 'delete-conn': {
      try{
        const connId = id;

        // 1) 현재 선택된 DB 노드를 우선적으로 삭제 대상으로 사용
        let liConn = null;
        const selNode = document.querySelector('#dbTree .node.dbtree-selected');
        if (selNode) {
          const selLi = selNode.closest('li[data-conn-id]');
          if (selLi && selLi.dataset.connId === connId) {
            liConn = selLi;
          }
        }

        // 2) 선택 정보가 없으면 기존 방식대로 첫 번째 노드 사용 (호환용)
        if (!liConn && typeof tree !== 'undefined' && tree && typeof tree.getConnLi === 'function') {
          liConn = tree.getConnLi(connId);
        }

        let label = connId;
        if(liConn){
          const node = liConn.querySelector(':scope > .node');
          const labelSpan =
            (node && node.querySelector('span:nth-of-type(3)')) ||
            (node && node.querySelector('span:nth-of-type(2)'));
          if(labelSpan && labelSpan.textContent){
            label = labelSpan.textContent.trim();
          }
        }

        const msg = `'${label}' 연결을 목록에서 삭제하시겠습니까?`;
        if(!window.confirm(msg)) break;

        // 3) 트리에서 현재 선택(또는 첫 번째) 노드 제거
        if(liConn && liConn.parentElement){
          liConn.parentElement.removeChild(liConn);
        }

        // 4) 같은 connId를 가진 DB 노드가 아직 남아 있는지 확인
        const hasSameConnNode = Array.from(
          document.querySelectorAll('#dbTree li[data-conn-id]')
        ).some(li => li.dataset.connId === connId);

        // 5) 더 이상 이 connId를 가진 노드가 없을 때만 state에서 제거
        if(typeof state !== 'undefined' && state && !hasSameConnNode){
          if(Array.isArray(state.availableConns)){
            state.availableConns = state.availableConns.filter(c => c.id !== connId);
          }
          if(Array.isArray(state.pinnedConnIds)){
            state.pinnedConnIds = state.pinnedConnIds.filter(c => c !== connId);
          }
          if(state.connStates && Object.prototype.hasOwnProperty.call(state.connStates, connId)){
            delete state.connStates[connId];
          }
          if(state.connProfiles && Object.prototype.hasOwnProperty.call(state.connProfiles, connId)){
            delete state.connProfiles[connId];
          }
          if(state.connId === connId){
            state.connId = null;
          }
        }

        if(typeof ui !== 'undefined' && ui){
          if(typeof ui.renderTabs === 'function') ui.renderTabs();
          if(typeof ui.refreshConnStatus === 'function') ui.refreshConnStatus();
        }
        if(typeof tree !== 'undefined' && tree && typeof tree.updateConnBadges === 'function'){
          tree.updateConnBadges();
        }
      }catch(e){
        console.warn('delete-conn error', e);
      }
      break;
    }
    case 'rename-conn': {
      try{
        const connId = id;
        let liConn = null;

        // 1) 현재 선택된 DB 노드가 있으면 우선 사용
        const selNode = document.querySelector('#dbTree .node.dbtree-selected');
        if (selNode) {
          const selLi = selNode.closest('li[data-conn-id]');
          if (selLi && selLi.dataset.connId === connId) {
            liConn = selLi;
          }
        }

        // 2) 선택 정보가 없거나 connId가 다르면 기존 방식대로 첫 번째 노드 사용
        if (!liConn && typeof tree !== 'undefined' && tree && typeof tree.getConnLi === 'function') {
          liConn = tree.getConnLi(connId);
        }

        if(!liConn) break;
        if (typeof dbFolderUi !== 'undefined' && dbFolderUi && typeof dbFolderUi.startDbLabelEdit === 'function') {
          dbFolderUi.startDbLabelEdit(liConn);
        } else if (typeof startDbLabelEdit === 'function') {
          startDbLabelEdit(liConn);
        }
      }catch(e){
        console.warn('rename-conn error', e);
      }
      break;
    }
    case 'refresh':
      tree.updateConnBadges();
      alert('연결 새로고침(예시: 상태 배지 갱신) 완료.');
      break;
    default:
      break;
  }

  ctxMenu.hide();
});
window.addEventListener('click', (e)=>{ if(!ctxMenu.el.contains(e.target)) ctxMenu.hide(); });
window.addEventListener('scroll', ()=> ctxMenu.hide(), true);

// ---------------- Tree Object Context Menu ----------------
let dbTreeClipboard = {
  type: null,
  label: '',
  connId: null,
  folderLi: null
};


const dbamStub = (label)=>{
  alert('[미구현] ' + label + ' 기능은 이후 구현 예정입니다.');
};

const treeCtxConfig = {
  _default: [
    { act: 'refresh-node', label: '새로고침', icon: 'fa-solid fa-rotate' }
  ],
  'dbtree-empty': [
    { act: 'dbtree-create-db',     label: 'Database 생성', icon: 'fa-solid fa-database' },
    { act: 'dbtree-create-folder', label: '폴더 생성',     icon: 'fa-regular fa-folder' },
    { act: 'dbtree-paste',         label: '붙여넣기 (Ctrl + V)',     icon: 'fa-solid fa-clipboard' }
  ],
  'folder': [
    { act: 'folder-add',    label: '폴더 추가',                 icon: 'fa-regular fa-folder-open' },
    { act: 'folder-rename', label: '폴더 이름변경 (F2)',        icon: 'fa-solid fa-pen-to-square' },
    { act: 'folder-copy',   label: '폴더 복사 (Ctrl + C)',      icon: 'fa-regular fa-copy' },
    { act: 'folder-paste',  label: '붙여넣기 (Ctrl + V)',       icon: 'fa-solid fa-clipboard' },
    { act: 'folder-delete', label: '폴더 삭제 (Delete)',        icon: 'fa-solid fa-trash' },
    { act: 'refresh-node',  label: '새로고침 (Alt + R)',        icon: 'fa-solid fa-rotate' }
  ],
  'tables-folder': [
    { act: 'tables-new',       label: '새 테이블 생성…',        icon: 'fa-solid fa-table' },
    { act: 'tables-erd',       label: 'ERD 보기(스키마)',       icon: 'fa-solid fa-project-diagram' },
    { act: 'refresh-node',     label: '새로고침',              icon: 'fa-solid fa-rotate' }
  ],
  'table': [
    { act: 'table-edit',       label: '테이블 편집',            icon: 'fa-solid fa-gears' },
    { act: 'table-view-data',  label: '데이터 조회',            icon: 'fa-solid fa-table-cells' },
    { act: 'table-edit-data',  label: '데이터 편집(미구현)',    icon: 'fa-solid fa-pen-to-square' },
    { act: 'table-export',     label: 'Export Data…',          icon: 'fa-solid fa-file-export' },
    { act: 'table-import',     label: 'Import Data…',          icon: 'fa-solid fa-file-import' },
    { act: 'table-truncate',   label: 'Truncate Table',        icon: 'fa-solid fa-broom' },
    { act: 'table-ddl',        label: 'DDL 보기',              icon: 'fa-solid fa-scroll' },
    { act: 'table-grants',     label: '권한 보기/변경',        icon: 'fa-solid fa-user-shield' },
    { act: 'table-stats',      label: '통계/분석 정보',        icon: 'fa-solid fa-chart-column' },
    { act: 'table-gen-select', label: 'Generate SQL → SELECT', icon: 'fa-solid fa-code' },
    { act: 'table-gen-insert', label: 'Generate SQL → INSERT', icon: 'fa-solid fa-code' },
    { act: 'table-gen-update', label: 'Generate SQL → UPDATE', icon: 'fa-solid fa-code' },
    { act: 'table-gen-delete', label: 'Generate SQL → DELETE', icon: 'fa-solid fa-code' },
    { act: 'table-copy-name',  label: '테이블 이름 복사',        icon: 'fa-solid fa-copy' }
  ],
  'views-folder': [
    { act: 'view-new',      label: '새 뷰 생성…',       icon: 'fa-regular fa-eye' },
    { act: 'refresh-node',  label: '새로고침',          icon: 'fa-solid fa-rotate' }
  ],
  'view': [
    { act: 'view-open',     label: '뷰 열기',                    icon: 'fa-regular fa-eye' },
    { act: 'view-compile',  label: '뷰 컴파일',                  icon: 'fa-solid fa-hammer' },
    { act: 'view-ddl',      label: 'DDL 보기',                   icon: 'fa-solid fa-scroll' },
    { act: 'view-drop',     label: '뷰 삭제(DROP VIEW)',         icon: 'fa-solid fa-trash' },
    { act: 'view-gen-sql',  label: 'Generate SQL',               icon: 'fa-solid fa-code' }
  ],
  'functions-folder': [
    { act: 'func-new',      label: '새 함수 생성…',              icon: 'fa-solid fa-code' },
    { act: 'refresh-node',  label: '새로고침',                   icon: 'fa-solid fa-rotate' }
  ],
  'func': [
    { act: 'func-open',     label: '함수 열기',                  icon: 'fa-solid fa-code' },
    { act: 'func-compile',  label: '컴파일',                    icon: 'fa-solid fa-hammer' },
    { act: 'func-exec',     label: 'Execute…',                  icon: 'fa-solid fa-play' },
    { act: 'func-ddl',      label: 'DDL 보기',                  icon: 'fa-solid fa-scroll' },
    { act: 'func-drop',     label: '함수 삭제(DROP FUNCTION)',  icon: 'fa-solid fa-trash' }
  ],
  'procs-folder': [
    { act: 'proc-new',      label: '새 프로시저 생성…', icon: 'fa-solid fa-code' },
    { act: 'refresh-node',  label: '새로고침',          icon: 'fa-solid fa-rotate' }
  ],
  'proc': [
    { act: 'proc-open',     label: '프로시저 열기',                      icon: 'fa-solid fa-code' },
    { act: 'proc-compile',  label: '컴파일',                            icon: 'fa-solid fa-hammer' },
    { act: 'proc-exec',     label: '실행(Execute…)',                    icon: 'fa-solid fa-play' },
    { act: 'proc-ddl',      label: 'DDL 보기',                          icon: 'fa-solid fa-scroll' },
    { act: 'proc-drop',     label: '프로시저 삭제(DROP PROCEDURE)',     icon: 'fa-solid fa-trash' }
  ],
  'sequences-folder': [
    { act: 'refresh-node', label: '새로고침', icon: 'fa-solid fa-rotate' }
  ],
  'seq': [
    { act: 'seq-preview', label: '값 미리 보기',                icon: 'fa-solid fa-hashtag' },
    { act: 'seq-config',  label: '시퀀스 설정 보기/수정',       icon: 'fa-solid fa-sliders' },
    { act: 'seq-ddl',     label: 'DDL 보기',                    icon: 'fa-solid fa-scroll' }
  ],
  'table-cols': [
    { act: 'cols-add',    label: '새 컬럼 추가…', icon: 'fa-solid fa-plus' },
    { act: 'refresh-node', label: '새로고침',   icon: 'fa-solid fa-rotate' }
  ],
  'column': [
    { act: 'col-edit',    label: '컬럼 편집',     icon: 'fa-solid fa-pen-to-square' },
    { act: 'col-gen-alter', label: 'Generate SQL → ALTER', icon: 'fa-solid fa-code' },
    { act: 'col-drop',    label: '컬럼 삭제',     icon: 'fa-solid fa-trash' }
  ],
  'table-fks': [
    { act: 'fk-add',      label: '새 외래키 생성…', icon: 'fa-solid fa-link' },
    { act: 'refresh-node', label: '새로고침',     icon: 'fa-solid fa-rotate' }
  ],

  'fk': [
    { act: 'fk-edit',     label: 'FK 편집',                 icon: 'fa-solid fa-pen-to-square' },
    { act: 'fk-goto',     label: '참조 테이블로 이동',      icon: 'fa-solid fa-up-right-from-square' },
    { act: 'fk-ddl',      label: 'Generate SQL → ADD/DROP', icon: 'fa-solid fa-code' }
  ],
  'synonyms-folder': [
    { act: 'synonym-new',   label: '새 Synonym 생성…',                icon: 'fa-solid fa-link' },
    { act: 'refresh-node',  label: '새로고침',                        icon: 'fa-solid fa-rotate' }
  ],
  'synonym': [
    { act: 'synonym-ddl',   label: 'DDL 보기',                        icon: 'fa-solid fa-scroll' },
    { act: 'synonym-drop',  label: 'Synonym 삭제(DROP SYNONYM)',     icon: 'fa-solid fa-trash' }
  ],
  'packages-folder': [
    { act: 'package-new',    label: '새 패키지 생성…',                icon: 'fa-solid fa-box-archive' },
    { act: 'refresh-node',   label: '새로고침',                       icon: 'fa-solid fa-rotate' }
  ],
  'package': [
    { act: 'package-open',    label: '패키지 열기',                   icon: 'fa-solid fa-box-archive' },
    { act: 'package-compile', label: '컴파일',                        icon: 'fa-solid fa-hammer' },
    { act: 'package-ddl',     label: 'DDL 보기',                      icon: 'fa-solid fa-scroll' },
    { act: 'package-drop',    label: '패키지 삭제(DROP PACKAGE)',    icon: 'fa-solid fa-trash' }
  ],
  'triggers-folder': [
    { act: 'trigger-new',   label: '새 트리거 생성…',                icon: 'fa-solid fa-bolt' },
    { act: 'refresh-node',  label: '새로고침',                        icon: 'fa-solid fa-rotate' }
  ],
  'table-triggers': [
    { act: 'trigger-new',   label: '새 트리거 생성…',                icon: 'fa-solid fa-bolt' },
    { act: 'refresh-node',  label: '새로고침',                        icon: 'fa-solid fa-rotate' }
  ],
  'trigger': [
    { act: 'trigger-ddl',   label: 'DDL 보기',                        icon: 'fa-solid fa-scroll' },
    { act: 'trigger-drop',  label: '트리거 삭제(DROP TRIGGER)',      icon: 'fa-solid fa-trash' }
  ],
  'db-links-folder': [
    { act: 'dblink-new',    label: '새 DB Link 생성…',               icon: 'fa-solid fa-link' },
    { act: 'refresh-node',  label: '새로고침',                        icon: 'fa-solid fa-rotate' }
  ],
  'dblink': [
    { act: 'dblink-test',   label: '연결 테스트',                     icon: 'fa-solid fa-plug-circle-check' },
    { act: 'dblink-ddl',    label: 'DDL 보기',                        icon: 'fa-solid fa-scroll' },
    { act: 'dblink-drop',   label: 'DB Link 삭제(DROP DATABASE LINK)', icon: 'fa-solid fa-trash' }
  ],
  'jobs-folder': [
    { act: 'job-new',       label: '새 Job 생성…',                    icon: 'fa-solid fa-clock-rotate-left' },
    { act: 'refresh-node',  label: '새로고침',                        icon: 'fa-solid fa-rotate' }
  ],
  'job': [
    { act: 'job-open',      label: 'Job 조회/수정',                    icon: 'fa-solid fa-pen-to-square' },
    { act: 'job-run',       label: 'Job 실행',                        icon: 'fa-solid fa-play' },
    { act: 'job-stop',      label: 'Job 중지',                        icon: 'fa-solid fa-stop' },
    { act: 'job-ddl',       label: 'DDL 보기',                        icon: 'fa-solid fa-scroll' },
    { act: 'job-drop',      label: 'Job 삭제',                        icon: 'fa-solid fa-trash' }
  ],
  'java-folder': [
    { act: 'refresh-node',  label: '새로고침',                        icon: 'fa-solid fa-rotate' }
  ],
  'java': [
    { act: 'java-open',     label: 'Java 클래스 정보 조회',           icon: 'fa-solid fa-circle-info' },
    { act: 'java-source',   label: '소스 보기',                       icon: 'fa-solid fa-file-code' },
    { act: 'java-drop',     label: 'Java 클래스 삭제',                 icon: 'fa-solid fa-trash' }
  ]
};
const treeCtx = {
  el: document.getElementById('treeCtx'),
  model: null,
  items: [],
  open(x, y, info, items){ hideAllCtxMenus(); 
    this.model = info;
    this.items = items || [];
    const ul = this.el.querySelector('ul');
    ul.innerHTML = '';
    (this.items||[]).forEach(it=>{
      const li = document.createElement('li');
      li.setAttribute('data-act', it.act);
      if(it.icon){
        const i = document.createElement('i');
        i.className = it.icon;
        li.appendChild(i);
        li.appendChild(document.createTextNode(' ' + it.label));
      } else {
        li.textContent = it.label;
      }
      ul.appendChild(li);
    });
    this.el.style.left = x + 'px';
    this.el.style.top = y + 'px';
    this.el.classList.remove('hidden');
    this.el.setAttribute('aria-hidden', 'false');
  },
  hide(){
    this.el.classList.add('hidden');
    this.el.setAttribute('aria-hidden', 'true');
    this.model = null;
    this.items = [];
  }
};

treeCtx.el.addEventListener('click', (e)=>{
  const li = e.target.closest('li');
  if(!li) return;
  const act = li.getAttribute('data-act');
  if(!act) return;
  const info = treeCtx.model;
  const item = (treeCtx.items||[]).find(x=>x.act===act) || null;
  handleTreeCtxAction(act, info, item);
  treeCtx.hide();
});
window.addEventListener('click', (e)=>{
  if(!treeCtx.el.contains(e.target)) treeCtx.hide();
});
window.addEventListener('scroll', ()=> treeCtx.hide(), true);


const ddlPanel = {
  el: document.getElementById('ddlPanel'),
  titleEl: document.getElementById('ddlTitle'),
  textEl: document.getElementById('ddlText'),
  show(title, text){
    if(this.titleEl) this.titleEl.textContent = title || '';
    if(this.textEl) this.textEl.textContent = text || '';
    if(bottomTabs){
      bottomTabs.activate('ddlPanel');
    }else if(this.el){
      this.el.classList.remove('hidden');
      this.el.style.display = 'block';
    }
  },
  setText(text){
    if(this.textEl) this.textEl.textContent = text || '';
  },
  clear(){
    if(this.textEl) this.textEl.textContent = '';
    if(this.titleEl) this.titleEl.textContent = '';
  },
  hide(){
    if(this.el){
      this.el.style.display = 'none';
    }
  },
  toggle(){
    if(bottomTabs){
      bottomTabs.toggle('ddlPanel');
      return;
    }
    if(!this.el) return;
    const disp = getComputedStyle(this.el).display;
    if(disp === 'none'){
      this.el.classList.remove('hidden');
      this.el.style.display = 'block';
    }else{
      this.el.style.display = 'none';
    }
  }
};


function handleTreeCtxAction(act, info, item){
  // info가 없는 경우(트리 빈 영역 컨텍스트 메뉴 등)의 전역 액션 처리
  if(!info){
    switch(act){
      case 'dbtree-create-db': {
        if (typeof dbFolderUi !== 'undefined' && dbFolderUi && typeof dbFolderUi.setSelectedNode === 'function') {
          dbFolderUi.setSelectedNode(null);
        }
        if (typeof connSettings !== 'undefined' && connSettings && typeof connSettings.openNew === 'function') {
          connSettings.openNew();
        }
        return;
      }
      case 'dbtree-create-folder': {
        if (typeof dbFolderUi !== 'undefined' && dbFolderUi) {
          if (typeof dbFolderUi.setSelectedNode === 'function') {
            dbFolderUi.setSelectedNode(null);
          }
          if (typeof dbFolderUi.addFolder === 'function') {
            dbFolderUi.addFolder();
          }
        }
        return;
      }
      case 'dbtree-paste': {
        if (typeof dbFolderUi !== 'undefined' && dbFolderUi && typeof dbFolderUi.pasteFolder === 'function') {
          dbFolderUi.pasteFolder(null);
        } else {
          alert('붙여넣기할 폴더 정보가 없습니다.');
        }
        return;
      }
      default:
        return;
    }
  }
  const schema = info.schema || 'public';
  const table = info.table || info.label || '';
  switch(act){
    case 'folder-add': {
      if (typeof dbFolderUi !== 'undefined' && typeof dbFolderUi.addFolder === 'function') {
        dbFolderUi.addFolder();
      }
      break;
    }
    case 'folder-rename': {
      if (typeof dbFolderUi !== 'undefined' && typeof dbFolderUi.renameFolder === 'function') {
        dbFolderUi.renameFolder();
      }
      break;
    }
    case 'folder-delete': {
      if (typeof dbFolderUi !== 'undefined' && typeof dbFolderUi.deleteFolder === 'function') {
        dbFolderUi.deleteFolder();
      }
      break;
    }
    case 'folder-copy': {
      if (typeof dbFolderUi !== 'undefined' && typeof dbFolderUi.copyFolder === 'function') {
        dbFolderUi.copyFolder(info && info.li);
      }
      break;
    }
    case 'folder-paste': {
      if (typeof dbFolderUi !== 'undefined' && typeof dbFolderUi.pasteFolder === 'function') {
        dbFolderUi.pasteFolder(info && info.li);
      }
      break;
    }

    case 'table-edit': {
      if(!table) return;
      tableEditor.open(info);
      break;
    }
    case 'table-view-data': {
      if(!table) return;
      const connId = info.connId || state.connId;
      actions.openSampleSelect(schema, table, connId);
      break;
    }
    case 'table-gen-select': {
      if(!table) return;
      const fullName = schema ? `${schema}.${table}` : table;
      const sql = `-- ${fullName}\nSELECT *\nFROM ${fullName}\nLIMIT 200;`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'table-gen-insert':
    case 'table-gen-update':
    case 'table-gen-delete': {
      if(!table) return;
      const fullName = schema ? `${schema}.${table}` : table;
      let sql;
      if(act === 'table-gen-insert'){
        sql = `-- ${fullName}\nINSERT INTO ${fullName} (\n  /* columns */\n) VALUES (\n  /* values */\n);`;
      } else if(act === 'table-gen-update'){
        sql = `-- ${fullName}\nUPDATE ${fullName}\n   SET /* column = value */\n WHERE /* condition */;`;
      } else {
        sql = `-- ${fullName}\nDELETE FROM ${fullName}\n WHERE /* condition */;`;
      }
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'table-copy-name': {
      if(!table) return;
      const fullName = schema ? `${schema}.${table}` : table;
      window.prompt('테이블 이름 복사', fullName);
      break;
    }
    case 'table-ddl': {
      if(!table) return;
      const connId = info.connId || state.connId;
      const fullName = schema ? `${schema}.${table}` : table;
      const title = `테이블 DDL: ${fullName}`;
      const body = `-- TODO: 서버에서 실제 테이블 DDL을 받아와서 이 영역에 표시하세요.\n-- 대상 테이블: ${fullName}\n-- 연결: ${connId || '(미지정)'}`;
      ddlPanel.show(title, body);
      break;
    }
    case 'view-ddl': {
      const name = table || info.label || '';
      if(!name) return;
      const connId = info.connId || state.connId;
      const fullName = schema ? `${schema}.${name}` : name;
      const title = `뷰 DDL: ${fullName}`;
      const body = `-- TODO: 서버에서 실제 뷰 DDL을 받아와서 이 영역에 표시하세요.\n-- 대상 뷰: ${fullName}\n-- 연결: ${connId || '(미지정)'}`;
      ddlPanel.show(title, body);
      break;
    }
    case 'func-ddl':
    case 'proc-ddl': {
      const name = table || info.label || '';
      if(!name) return;
      const connId = info.connId || state.connId;
      const fullName = schema ? `${schema}.${name}` : name;
      const title = `함수/프로시저 DDL: ${fullName}`;
      const body = `-- TODO: 서버에서 실제 함수/프로시저 DDL을 받아와서 이 영역에 표시하세요.\n-- 대상: ${fullName}\n-- 연결: ${connId || '(미지정)'}`;
      ddlPanel.show(title, body);
      break;
    }

    case 'view-new': {
      const baseSchema = info.schema || schema || 'public';
      const sql = `-- 새 뷰 생성 템플릿
CREATE OR REPLACE VIEW ${baseSchema}.new_view_name AS
SELECT /* columns */
FROM /* table */
WHERE /* condition */;`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'view-compile': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- 뷰 컴파일 템플릿
-- DB 종류에 맞게 명령을 수정하세요.
ALTER VIEW ${fullName} /* COMPILE 또는 REFRESH */;`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'view-drop': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- 뷰 삭제 템플릿
DROP VIEW ${fullName};`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'synonym-new': {
      const baseSchema = info.schema || schema || 'public';
      const sql = `-- Synonym 생성 템플릿
CREATE OR REPLACE SYNONYM ${baseSchema}.synonym_name
  FOR target_schema.target_object;`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'synonym-ddl': {
      const name = table || info.label || '';
      if(!name) return;
      const connId = info.connId || state.connId;
      const fullName = schema ? `${schema}.${name}` : name;
      const title = `Synonym DDL: ${fullName}`;
      const body = `-- TODO: 서버에서 실제 Synonym DDL을 받아와서 이 영역에 표시하세요.
-- 대상 Synonym: ${fullName}
-- 연결: ${connId || '(미지정)'}`;
      ddlPanel.show(title, body);
      break;
    }
    case 'synonym-drop': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- Synonym 삭제 템플릿
DROP SYNONYM ${fullName};`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'seq-config': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- 시퀀스 설정 보기/수정 템플릿
-- 현재 설정은 DB 카탈로그 조회 결과로 채워 넣으세요.
ALTER SEQUENCE ${fullName}
  /* INCREMENT BY 1
     MINVALUE 1
     MAXVALUE 999999999999
     CYCLE
     CACHE 20 */;`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'seq-ddl': {
      const name = table || info.label || '';
      if(!name) return;
      const connId = info.connId || state.connId;
      const fullName = schema ? `${schema}.${name}` : name;
      const title = `시퀀스 DDL: ${fullName}`;
      const body = `-- TODO: 서버에서 실제 시퀀스 DDL을 받아와서 이 영역에 표시하세요.
-- 대상 시퀀스: ${fullName}
-- 연결: ${connId || '(미지정)'}`;
      ddlPanel.show(title, body);
      break;
    }
    case 'proc-new': {
      const baseSchema = info.schema || schema || 'public';
      const sql = `-- 프로시저 생성 템플릿
CREATE OR REPLACE PROCEDURE ${baseSchema}.new_procedure(
  /* parameters */
) AS
BEGIN
  NULL;
END;
/
`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'proc-compile': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- 프로시저 컴파일 템플릿
-- DB 종류에 맞게 명령을 수정하세요.
ALTER PROCEDURE ${fullName} COMPILE;`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'proc-exec': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- 프로시저 실행 템플릿
CALL ${fullName}(/* 파라미터 */);`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'proc-drop': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- 프로시저 삭제 템플릿
DROP PROCEDURE ${fullName};`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'func-new': {
      const baseSchema = info.schema || schema || 'public';
      const sql = `-- 함수 생성 템플릿
CREATE OR REPLACE FUNCTION ${baseSchema}.new_function(
  /* parameters */
) RETURN /* datatype */ AS
BEGIN
  RETURN NULL;
END;
/
`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'func-compile': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- 함수 컴파일 템플릿
-- DB 종류에 맞게 명령을 수정하세요.
ALTER FUNCTION ${fullName} COMPILE;`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'func-exec': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- 함수 실행 템플릿
SELECT ${fullName}(/* 파라미터 */);`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'func-drop': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- 함수 삭제 템플릿
DROP FUNCTION ${fullName};`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'package-new': {
      const baseSchema = info.schema || schema || 'public';
      const sql = `-- 패키지 생성 템플릿
CREATE OR REPLACE PACKAGE ${baseSchema}.new_package IS
  -- 선언부
END new_package;
/
CREATE OR REPLACE PACKAGE BODY ${baseSchema}.new_package IS
  -- 본문
END new_package;
/
`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'package-compile': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- 패키지 컴파일 템플릿
ALTER PACKAGE ${fullName} COMPILE;`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'package-ddl': {
      const name = table || info.label || '';
      if(!name) return;
      const connId = info.connId || state.connId;
      const fullName = schema ? `${schema}.${name}` : name;
      const title = `패키지 DDL: ${fullName}`;
      const body = `-- TODO: 서버에서 실제 패키지 DDL을 받아와서 이 영역에 표시하세요.
-- 대상 패키지: ${fullName}
-- 연결: ${connId || '(미지정)'}`;
      ddlPanel.show(title, body);
      break;
    }
    case 'package-drop': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- 패키지 삭제 템플릿
DROP PACKAGE ${fullName};`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'trigger-new': {
      const baseSchema = info.schema || schema || 'public';
      const targetTable = info.table || 'target_table';
      const sql = `-- 트리거 생성 템플릿
CREATE OR REPLACE TRIGGER ${baseSchema}.trg_name
BEFORE INSERT OR UPDATE OR DELETE ON ${baseSchema}.${targetTable}
FOR EACH ROW
BEGIN
  NULL;
END;
/
`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'trigger-ddl': {
      const name = table || info.label || '';
      if(!name) return;
      const connId = info.connId || state.connId;
      const fullName = schema ? `${schema}.${name}` : name;
      const title = `트리거 DDL: ${fullName}`;
      const body = `-- TODO: 서버에서 실제 트리거 DDL을 받아와서 이 영역에 표시하세요.
-- 대상 트리거: ${fullName}
-- 연결: ${connId || '(미지정)'}`;
      ddlPanel.show(title, body);
      break;
    }
    case 'trigger-drop': {
      const name = table || info.label || '';
      if(!name) return;
      const fullName = schema ? `${schema}.${name}` : name;
      const sql = `-- 트리거 삭제 템플릿
DROP TRIGGER ${fullName};`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }

    case 'dblink-new': {
      const baseSchema = info.schema || schema || 'public';
      const sql = `-- DB Link 생성 템플릿
-- DBMS 종류에 따라 문법을 조정하세요.
CREATE DATABASE LINK dblink_name
  CONNECT TO user IDENTIFIED BY password
  USING 'tns_or_connection_string';
`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'dblink-test': {
      const name = table || info.label || '';
      if(!name) return;
      const sql = `-- DB Link 연결 테스트 템플릿
-- 실제 환경에 맞는 테스트 쿼리로 교체하세요.
SELECT 1 FROM dual@${name};
`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'dblink-ddl': {
      const name = table || info.label || '';
      if(!name) return;
      const connId = info.connId || state.connId;
      const title = `DB Link DDL: ${name}`;
      const body = `-- TODO: 서버에서 실제 DB Link 정의를 조회해 이 영역에 표시하세요.
-- 대상 DB Link: ${name}
-- 연결: ${connId || '(미지정)'}`;
      ddlPanel.show(title, body);
      break;
    }
    case 'dblink-drop': {
      const name = table || info.label || '';
      if(!name) return;
      const sql = `-- DB Link 삭제 템플릿
DROP DATABASE LINK ${name};`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'job-new': {
      const baseSchema = info.schema || schema || 'public';
      const sql = `-- Job 생성 템플릿
-- DBMS 스케줄러 문법(예: DBMS_SCHEDULER, DBMS_JOB, pg_cron 등)에 맞게 수정하세요.
BEGIN
  NULL;
END;
/
`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'job-open': {
      const name = table || info.label || '';
      if(!name) return;
      const sql = `-- Job 조회/수정 템플릿
-- ${name} 의 설정을 조회/수정하는 SQL을 작성하세요.`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'job-run': {
      const name = table || info.label || '';
      if(!name) return;
      const sql = `-- Job 실행 템플릿
-- DBMS 스케줄러에 맞는 즉시 실행 명령으로 바꿔 사용하세요.
-- 예) DBMS_SCHEDULER.RUN_JOB('${name}');
`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'job-stop': {
      const name = table || info.label || '';
      if(!name) return;
      const sql = `-- Job 중지 템플릿
-- DBMS 스케줄러에 맞는 중지 명령으로 바꿔 사용하세요.
-- 예) DBMS_SCHEDULER.STOP_JOB('${name}');
`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'job-ddl': {
      const name = table || info.label || '';
      if(!name) return;
      const connId = info.connId || state.connId;
      const title = `Job 정의: ${name}`;
      const body = `-- TODO: 서버에서 Job 정의를 조회해 이 영역에 표시하세요.
-- 대상 Job: ${name}
-- 연결: ${connId || '(미지정)'}`;
      ddlPanel.show(title, body);
      break;
    }
    case 'job-drop': {
      const name = table || info.label || '';
      if(!name) return;
      const sql = `-- Job 삭제 템플릿
-- 스케줄러 종류에 따라 실제 삭제 명령을 작성하세요.`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'java-open': {
      const name = table || info.label || '';
      if(!name) return;
      const sql = `-- Java 클래스 메타정보 조회 템플릿
-- ${name} 에 대한 메타데이터를 조회하는 SQL 또는 DBMS 전용 뷰를 사용하세요.`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    case 'java-source': {
      const name = table || info.label || '';
      if(!name) return;
      const title = `Java 소스: ${name}`;
      const body = `-- TODO: 서버에서 Java 소스를 조회해 이 영역에 그대로 표시하세요.
-- 대상 Java 클래스: ${name}`;
      ddlPanel.show(title, body);
      break;
    }
    case 'java-drop': {
      const name = table || info.label || '';
      if(!name) return;
      const sql = `-- Java 클래스 삭제 템플릿
-- DBMS 종류에 따라 실제 삭제 명령을 작성하세요.`;
      ui.newEditorTab();
      ui.setEditor(sql);
      break;
    }
    default: {
      const label = item && item.label ? item.label : act;
      dbamStub(label);
    }
  }
}
/* ---------------- Editor Context Menu ---------------- */
const editorCtx = {
  el: document.getElementById('editorCtx'),
  bind(target){
    if (!target) return;
    // 에디터 래퍼 안에서 발생한 우클릭만 처리
    document.addEventListener('contextmenu', (e)=>{
      if (!target.contains(e.target)) return;

      // 쿼리 진행 오버레이나 모달이 떠 있을 때는 에디터 메뉴 비활성
      const overlay = document.querySelector('.query-progress-overlay.is-active, #shortcutHelpBackdrop.show, .export-modal-backdrop.show');
      if (overlay) return;

      e.preventDefault();
      this.open(e.clientX, e.clientY);
    });
  },
  open(x,y){
    hideAllCtxMenus();
    this.el.style.left = x + 'px';
    this.el.style.top = y + 'px';
    this.el.classList.remove('hidden');
    this.el.setAttribute('aria-hidden','false');
  },
  hide(){
    this.el.classList.add('hidden');
    this.el.setAttribute('aria-hidden','true');
  }
};

window.addEventListener('resize', function(){
  try{
    if (window.ui && typeof ui.updateTabOverflow === 'function') {
      ui.updateTabOverflow();
    }
  }catch(e){
    console.warn('tab overflow resize error', e);
  }
});

editorCtx.el.addEventListener('click', (e)=>{
  const li = e.target.closest('li'); if(!li) return;
  const act = li.getAttribute('data-act');
  if(act==='run' || act==='runSql') actions.runSql();         // 호환용
  if(act==='runCurrent') actions.runCurrent();
  if(act==='runScript') actions.runScript();
  if(act==='format') ui.formatSql();
  if(act==='explain') actions.explain();
  if(act==='favSelection'){
    if(typeof ui!=='undefined' && ui && typeof ui.openFavSaveModal==='function'){
      ui.openFavSaveModal();
    }else if(typeof favorites!=='undefined' && favorites.addFromSelection){
      favorites.addFromSelection();
    }
  }
  if(act==='code-in-list' && typeof codeActions !== 'undefined' && codeActions && typeof codeActions.toInList === 'function'){
    codeActions.toInList();
  }
  if(act==='code-toggle-comment' && typeof codeActions !== 'undefined' && codeActions && typeof codeActions.toggleComment === 'function'){
    codeActions.toggleComment();
  }
  if(act==='code-run-selection'){
    if(typeof codeActions !== 'undefined' && codeActions && typeof codeActions.runSelection === 'function'){
      codeActions.runSelection();
    }else{
      actions.runCurrent();
    }
  }
  if(typeof cm !== 'undefined' && cm && typeof cm.focus === 'function'){
    cm.focus();
  }
  editorCtx.hide();
});
window.addEventListener('click', (e)=>{ if(!editorCtx.el.contains(e.target)) editorCtx.hide(); });
window.addEventListener('scroll', ()=> editorCtx.hide(), true);

// ---------------- Tab Context Menu ----------------
const tabCtx = {
  el: document.getElementById('tabCtx'),
  targetTabId: null,
  open(x, y, tabId){ hideAllCtxMenus(); 
    this.targetTabId = tabId;
    // 핀 상태에 따라 메뉴 텍스트 동적 변경
    try{
      const tab = (state.tabs || []).find(t => t.id === tabId);
      const pinLi = this.el.querySelector('li[data-act="tab-pin-toggle"]');
      if (pinLi && tab) {
        const isPinned = !!tab.isPinned;
        pinLi.innerHTML = '<i class="fa-solid fa-thumbtack"></i> ' + (isPinned ? '핀 해제' : '핀 고정');
      }
    }catch(e){}
    this.el.style.left = x + 'px';
    this.el.style.top = y + 'px';
    this.el.classList.remove('hidden');
    this.el.setAttribute('aria-hidden', 'false');
  },
  hide(){
    this.el.classList.add('hidden');
    this.el.setAttribute('aria-hidden', 'true');
    this.targetTabId = null;
  }
};

tabCtx.el.addEventListener('click', (e)=>{
  const li = e.target.closest('li');
  if(!li) return;
  const act = li.getAttribute('data-act');
  const id = tabCtx.targetTabId;
  if(!act || !id){ tabCtx.hide(); return; }

  switch(act){
    case 'tab-close':
      ui.closeTab(id);
      break;
    case 'tab-close-others':
      ui.closeOtherTabs(id);
      break;
    case 'tab-close-all':
      ui.closeAllTabs();
      break;
    case 'tab-pin-toggle':
      ui.togglePinTab(id);
      break;
    case 'tab-rename':
      try{
        ui.startTabInlineRename(id);
      }catch(e){
        console.warn('tab-rename error', e);
      }
      break;
    case 'tab-color-default':
      ui.setTabColor(id, 'default');
      break;
    case 'tab-color-blue':
      ui.setTabColor(id, 'blue');
      break;
    case 'tab-color-green':
      ui.setTabColor(id, 'green');
      break;
    case 'tab-color-yellow':
      ui.setTabColor(id, 'yellow');
      break;
    case 'tab-color-red':
      ui.setTabColor(id, 'red');
      break;
    case 'tab-save':
      ui.openSqlSaveModal();
      break;
    default:
      break;
  }

  tabCtx.hide();
});
window.addEventListener('click', (e)=>{
  if(!tabCtx.el.contains(e.target)) tabCtx.hide();
});
window.addEventListener('scroll', ()=> tabCtx.hide(), true);

// ---------------- Result Context Menu ----------------
const resultCtx = {
  el: document.getElementById('resultCtx'),
  open(x, y){ hideAllCtxMenus(); 
    this.el.style.left = x + 'px';
    this.el.style.top  = y + 'px';
    this.el.classList.remove('hidden');
    this.el.setAttribute('aria-hidden','false');
  },
  hide(){
    this.el.classList.add('hidden');
    this.el.setAttribute('aria-hidden','true');
  }
};

resultCtx.el.addEventListener('click', (e)=>{
  const li = e.target.closest('li');
  if(!li) return;
  const act = li.getAttribute('data-act');
  if(!act) return;

  switch(act){
    case 'export':
      actions.exportCsv();
      break;
    case 'export-insert':
      actions.exportInsert();
      break;
    case 'copy-sql':
      actions.copySql();
      break;
    default:
      break;
  }

  resultCtx.hide();
});
window.addEventListener('click', (e)=>{ if(!resultCtx.el.contains(e.target)) resultCtx.hide(); });
window.addEventListener('scroll', ()=> resultCtx.hide(), true);


// ---------------- History / Recent Query Context Menu ----------------
const historyCtx = {
  el: document.getElementById('historyCtx'),
  target: null,
  open(x, y, target){
    hideAllCtxMenus();
    this.target = target || null;
    const el = this.el;
    if(!el) return;
    el.style.left = x + 'px';
    el.style.top  = y + 'px';
    el.classList.remove('hidden');
    el.setAttribute('aria-hidden','false');
  },
  hide(){
    const el = this.el;
    if(!el) return;
    el.classList.add('hidden');
    el.setAttribute('aria-hidden','true');
    this.target = null;
  }
};

if(historyCtx.el){
  historyCtx.el.addEventListener('click', (e)=>{
    const li = e.target.closest('li');
    if(!li) return;
    const act = li.getAttribute('data-act');
    const target = historyCtx.target;
    if(!act || !target){
      historyCtx.hide();
      return;
    }

    if(act === 'add-favorite'){
      try{
        const sql = target.sql || '';
        if(!sql || !sql.trim()){
          alert('즐겨찾기로 저장할 SQL이 없습니다.');
        }else if(typeof openFavSaveModalFromSql === 'function'){
          openFavSaveModalFromSql(sql);
        }else if(typeof ui !== 'undefined' && ui && typeof ui.openFavSaveModal === 'function'){
          // fallback: 에디터를 잠시 교체 후 모달 호출
          const prev = (typeof ui.getEditor === 'function') ? ui.getEditor() : '';
          if(typeof ui.setEditor === 'function'){
            ui.setEditor(sql);
            ui.openFavSaveModal();
            ui.setEditor(prev);
          }else{
            ui.openFavSaveModal();
          }
        }
      }catch(err){
        console.warn('historyCtx add-favorite error', err);
      }
    }

    historyCtx.hide();
  });

  window.addEventListener('click', (e)=>{
    if(!historyCtx.el.contains(e.target)) historyCtx.hide();
  });
  window.addEventListener('scroll', ()=> historyCtx.hide(), true);
}

// Favorite / Template Context Menu
const favCtx = {
  el: document.getElementById('favCtxMenu'),
  target: null,
  open(x, y, target){
    hideAllCtxMenus();
    this.target = target || null;
    const el = this.el;
    if(!el) return;
    el.style.left = x + 'px';
    el.style.top  = y + 'px';
    el.classList.remove('hidden');
    el.setAttribute('aria-hidden','false');
  },
  hide(){
    const el = this.el;
    if(!el) return;
    el.classList.add('hidden');
    el.setAttribute('aria-hidden','true');
    this.target = null;
  }
};

if(favCtx.el){
  favCtx.el.addEventListener('click', (e)=>{
    const li = e.target.closest('li');
    if(!li) return;
    const act = li.getAttribute('data-act');
    const target = favCtx.target;
    if(!target || !act){
      favCtx.hide();
      return;
    }

    if(act === 'edit'){
      // 유형별로 편집 모달 오픈
      if(typeof ui !== 'undefined' && ui && typeof ui.openFavEditModal === 'function'){
        ui.openFavEditModal(target.type === 'org' ? 'ORG' : 'PERSONAL', target.id);
      }
    }else if(act === 'delete'){
      if(target.type === 'personal'){
        if(window.confirm(`'${target.name || ''}' 개인 즐겨찾기를 삭제할까요?`)){
          if(typeof favorites !== 'undefined' && favorites && typeof favorites.remove === 'function'){
            favorites.remove(target.id);
          }
        }
      }else if(target.type === 'org'){
        if(window.confirm(`'${target.name || ''}' 공용 템플릿을 삭제할까요?`)){
          if(typeof favTpl !== 'undefined' && favTpl && typeof favTpl.removeOrg === 'function'){
            favTpl.removeOrg(target.id);
          }
        }
      }
    }

    favCtx.hide();
  });

  window.addEventListener('click', (e)=>{
    if(!favCtx.el.contains(e.target)) favCtx.hide();
  });
  window.addEventListener('scroll', ()=> favCtx.hide(), true);
}



/* ---------------- Tree (DB objects) ---------------- */
const tree = {

  toggleOne(li, 


expand){
    const sub = li.querySelector(':scope > ul');
    if(!sub) return;
    const tw = li.querySelector(':scope > .node .tw');
    const show = (expand===undefined) ? (getComputedStyle(sub).display==='none') : !!expand;
    sub.style.display = show ? 'block' : 'none';
    if(tw){ tw.textContent = show ? '▼' : '▶'; }
  },
  toggleRecursive(li, expand){
    const hasChild = !!li.querySelector(':scope > ul');
    if(!hasChild) return;
    // expand/collapse the top level first
    this.toggleOne(li, expand);
    // then apply to all descendants
    li.querySelectorAll(':scope ul').forEach(u=>{
      u.style.display = expand ? 'block' : 'none';
      const tw = u.parentElement.querySelector(':scope > .node .tw');
      if(tw){ tw.textContent = expand ? '▼' : '▶'; }
    });
  },
  focusFirstChild(li){
    const first = li.querySelector(':scope > ul > li > .node');
    if(first){ first.focus(); }
  },
  focusParent(li){
    const parentNode = li.parentElement.closest('li > .node');
    if(parentNode){ parentNode.focus(); }
  },

  renderDisconnected(){ document.getElementById('dbTree').innerHTML = '<div class="muted" style="padding:8px 6px">연결 후 목록이 표시됩니다.</div>'; },
  
  icon(kind){
    const green = 'var(--hana-primary,#008485)';
    const folder = '#f7d154';
    switch(kind){
      case 'conn':
        return '<i class="fa-solid fa-database" style="color:'+green+';"></i>';
      case 'schema':
        return '<i class="fa-solid fa-sitemap" style="color:'+green+';"></i>';

      case 'folder':
      case 'tables-folder':
      case 'views-folder':
      case 'indexes-folder':
      case 'functions-folder':
      case 'procs-folder':
      case 'sequences-folder':
      case 'types-folder':
      case 'table-cols':
      case 'table-fks':
      case 'table-deps':
      case 'table-refs':
      case 'table-parts':
      case 'table-triggers':
      case 'table-rules':
      case 'synonyms-folder':
      case 'triggers-folder':
      case 'packages-folder':
      case 'db-links-folder':
        return '<i class="fa-regular fa-folder" style="color:'+folder+';"></i>';

      case 'table':
        return '<i class="fa-solid fa-table" style="color:'+green+';"></i>';
      case 'view':
        return '<i class="fa-regular fa-eye" style="color:'+green+';"></i>';
      case 'func':
        return '<i class="fa-solid fa-code" style="color:'+green+';"></i>';
      case 'proc':
        return '<i class="fa-solid fa-gears" style="color:'+green+';"></i>';
      case 'seq':
        return '<i class="fa-solid fa-hashtag" style="color:'+green+';"></i>';
      case 'index':
        return '<i class="fa-solid fa-arrow-down-a-z" style="color:'+green+';"></i>';
      case 'type':
        return '<i class="fa-regular fa-square" style="color:'+green+';"></i>';
      case 'column':
        return '<i class="fa-solid fa-bars-staggered" style="color:'+green+';"></i>'; /* generic column (fallback) */
      case 'column-text':
        return '<span class="col-icon col-text">ABC</span>';
      case 'column-number':
        return '<span class="col-icon col-number">123</span>';
      case 'column-date':
        return '<span class="col-icon col-date"><i class="fa-regular fa-clock"></i></span>';
      case 'fk':
        return '<i class="fa-solid fa-key" style="color:'+green+';"></i>';
      case 'dependency':
        return '<i class="fa-solid fa-diagram-project" style="color:'+green+';"></i>';
      case 'reference':
        return '<i class="fa-solid fa-diagram-next" style="color:'+green+';"></i>';
      case 'partition':
        return '<i class="fa-solid fa-border-all" style="color:'+green+';"></i>';
      case 'rule':
        return '<i class="fa-solid fa-scale-balanced" style="color:'+green+';"></i>';
      case 'package':
        return '<i class="fa-solid fa-box-archive" style="color:'+green+';"></i>';
      case 'trigger':
        return '<i class="fa-solid fa-bolt" style="color:'+green+';"></i>';
      case 'dblink':
        return '<i class="fa-solid fa-link" style="color:'+green+';"></i>';
      case 'job':
        return '<i class="fa-solid fa-clock-rotate-left" style="color:'+green+';"></i>';
      case 'java':
        return '<i class="fa-brands fa-java" style="color:'+green+';"></i>';

      default:
        return '<i class="fa-regular fa-circle" style="color:'+green+';"></i>';
    }
  },
  render(data){
    try{
      dbamHint.updateTablesFromTreeData(data);
    }catch(e){
      console.warn('dbamHint: tree.render update error', e);
    }
    const el = document.getElementById('dbTree');
    el.innerHTML = '';
    const rootUl = document.createElement('ul');
    data.connections.forEach(conn=>{
      const li = this.node(`${conn.label}`, '▶', 'conn');
      li.dataset.connId = conn.id;
      const connId = conn.id;
      attachConnPinControl(li, connId);
      // 상태 점 + 프로필 배지
      const nodeEl = li.querySelector('.node');
      const dot = document.createElement('i'); dot.className='fa-solid fa-circle conn-off conn-dot'; nodeEl.insertBefore(dot, nodeEl.children[1]);
      state.connProfiles[connId] = (conn.profile || null);
      // 더블클릭 = 연결(미연결 시), 우클릭 = 컨텍스트
      nodeEl.addEventListener('dblclick', ()=>{
        const isOn = !!(state.connStates && state.connStates[connId]);
        if (isOn) {
          // 이미 연결된 경우에는 트리만 펼치기
          const liNode = nodeEl.closest('li');
          if (liNode) {
            tree.toggleOne(liNode);
          }
          return;
        }
        ui._pendingConnSelectUsed   = false;
        ui._pendingConnAfterConnect = null;
        ui.openConnReasonModal(connId);
      });
      nodeEl.addEventListener('contextmenu', (e)=>{
        e.preventDefault();
        try{
          if (typeof dbFolderUi !== 'undefined' && dbFolderUi && typeof dbFolderUi.setSelectedNode === 'function') {
            dbFolderUi.setSelectedNode(nodeEl);
          } else {
            document.querySelectorAll('#dbTree .node.dbtree-selected')
              .forEach(n=>n.classList.remove('dbtree-selected'));
            nodeEl.classList.add('dbtree-selected');
          }
        }catch(err){
          console.warn('tree.render conn node contextmenu error', err);
        }
        ctxMenu.open(e.clientX, e.clientY, connId);
      });

      const schemasUl = document.createElement('ul');
      (conn.schemas||[]).forEach(sc=>{
        const sli = this.node(`schema: ${sc.name}`, '▶', 'schema');
        sli.dataset.schema = sc.name;
        const sUl = document.createElement('ul');
        // tables
        const tli = this.node('Tables', '▶', 'tables-folder');
        const tUl = document.createElement('ul');
        (sc.tables||[]).forEach(t=>{
          const nti = this.node(t, '▶', 'table');
          nti.dataset.table = t;
          nti.dataset.schema = sc.name;
          const nodeDiv = nti.querySelector('.node');
          nodeDiv.addEventListener('dblclick', ()=> actions.openSampleSelect(sc.name, t, connId));

          const childUl = document.createElement('ul');

          // columns (샘플)
          const colsNode = this.node('Columns', '▶', 'table-cols');
          colsNode.dataset.table = t;
          colsNode.dataset.schema = sc.name;
          const colsUl = document.createElement('ul');
          const colTypes = { id: 'bigint', col1: 'varchar(100)', col2: 'timestamp(6)' };
          try{
            dbamHint.addColumnsForTable(sc.name, t, ['id','col1','col2']);
          }catch(e){
            console.warn('dbamHint.addColumnsForTable demo error', e);
          }
          ['id','col1','col2'].forEach(c=>{

            const type = (colTypes[c] || '').toLowerCase();
            const label = type ? `${c} (${colTypes[c]})` : c;
            let colKind = 'column';
            if(type.includes('char') || type.includes('text')){
              colKind = 'column-text';
            }else if(type.includes('date') || type.includes('time')){
              colKind = 'column-date';
            }else if(type.includes('int') || type.includes('numeric') || type.includes('decimal') || type.includes('number') || type.includes('bigint') || type.includes('smallint')){
              colKind = 'column-number';
            }
            const colLi = this.node(label, '•', colKind);
            colLi.dataset.table = t;
            colLi.dataset.schema = sc.name;
            colLi.dataset.column = c;
            colsUl.appendChild(colLi);
          });
          colsNode.appendChild(colsUl);
          childUl.appendChild(colsNode);

          // foreign keys
          const fkNode = this.node('Foreign Keys', '▶', 'table-fks');
          fkNode.dataset.table = t;
          fkNode.dataset.schema = sc.name;
          childUl.appendChild(fkNode);

          // dependencies
          const depNode = this.node('Dependencies', '▶', 'table-deps');
          depNode.dataset.table = t;
          depNode.dataset.schema = sc.name;
          childUl.appendChild(depNode);

          // references
          const refNode = this.node('References', '▶', 'table-refs');
          refNode.dataset.table = t;
          refNode.dataset.schema = sc.name;
          childUl.appendChild(refNode);

          // partitions
          const partNode = this.node('Partitions', '▶', 'table-parts');
          partNode.dataset.table = t;
          partNode.dataset.schema = sc.name;
          childUl.appendChild(partNode);

          // triggers
          const trgNode = this.node('Triggers', '▶', 'table-triggers');
          trgNode.dataset.table = t;
          trgNode.dataset.schema = sc.name;
          childUl.appendChild(trgNode);

          // rules
          const ruleNode = this.node('Rules', '▶', 'table-rules');
          ruleNode.dataset.table = t;
          ruleNode.dataset.schema = sc.name;
          childUl.appendChild(ruleNode);

          nti.appendChild(childUl);
          tUl.appendChild(nti);
        });
        tli.appendChild(tUl); sUl.appendChild(tli);
        // views
        const vli = this.node('Views', '▶', 'views-folder');
        const vUl = document.createElement('ul');
        (sc.views||[]).forEach(v=>{ vUl.appendChild(this.node(v, '•', 'view')); });
        vli.appendChild(vUl); sUl.appendChild(vli);
        // functions
        const fli = this.node('Functions', '▶', 'functions-folder');
        const fUl = document.createElement('ul');
        (sc.functions||[]).forEach(f=>{ fUl.appendChild(this.node(f, 'ƒ', 'func')); });
        fli.appendChild(fUl); sUl.appendChild(fli);
        // sequences
        const qli = this.node('Sequences', '▶', 'sequences-folder');
        const qUl = document.createElement('ul');
        (sc.sequences||[]).forEach(s=>{ qUl.appendChild(this.node(s, '#', 'seq')); });
        qli.appendChild(qUl); sUl.appendChild(qli);
        // synonyms
        const synFolder = this.node('Synonyms', '▶', 'synonyms-folder');
        const synUl = document.createElement('ul');
        (sc.synonyms || ['synonym_sample']).forEach(syn=>{
          synUl.appendChild(this.node(syn, 'S', 'synonym'));
        });
        synFolder.appendChild(synUl); sUl.appendChild(synFolder);
        // triggers (schema-level)
        const trigFolder = this.node('Triggers', '▶', 'triggers-folder');
        const trigUl = document.createElement('ul');
        (sc.triggers || ['trg_sample']).forEach(tr=>{
          trigUl.appendChild(this.node(tr, 'T', 'trigger'));
        });
        trigFolder.appendChild(trigUl); sUl.appendChild(trigFolder);
        // packages
        const pkgFolder = this.node('Packages', '▶', 'packages-folder');
        const pkgUl = document.createElement('ul');
        (sc.packages || ['pkg_sample']).forEach(p=>{
          pkgUl.appendChild(this.node(p, 'P', 'package'));
        });
        pkgFolder.appendChild(pkgUl); sUl.appendChild(pkgFolder);
        // DB Links
        const dbLinkFolder = this.node('DB Links', '▶', 'db-links-folder');
        const dbLinkUl = document.createElement('ul');
        (sc.dbLinks || ['dblink_sample']).forEach(d=>{
          dbLinkUl.appendChild(this.node(d, 'L', 'dblink'));
        });
        dbLinkFolder.appendChild(dbLinkUl); sUl.appendChild(dbLinkFolder);
        // Jobs
        const jobsFolder = this.node('Jobs', '▶', 'jobs-folder');
        const jobsUl = document.createElement('ul');
        (sc.jobs || ['job_sample']).forEach(j=>{
          jobsUl.appendChild(this.node(j, 'J', 'job'));
        });
        jobsFolder.appendChild(jobsUl); sUl.appendChild(jobsFolder);
        // Java
        const javaFolder = this.node('Java', '▶', 'java-folder');
        const javaUl = document.createElement('ul');
        (sc.javaObjects || ['JavaClassSample']).forEach(jv=>{
          javaUl.appendChild(this.node(jv, 'J', 'java'));
        });
        javaFolder.appendChild(javaUl); sUl.appendChild(javaFolder);

        sli.appendChild(sUl); schemasUl.appendChild(sli);
      });
      // 기본 닫힘
      schemasUl.style.display = 'none';
      li.appendChild(schemasUl);
      rootUl.appendChild(li);
    });
    if (typeof sortDbTreeDepth === 'function') {
      sortDbTreeDepth(rootUl);
    }
    el.appendChild(rootUl);
    this.updateConnBadges();
    this.bindTreeContextMenu(el);

    if (typeof dbFolderUi !== 'undefined' && typeof dbFolderUi.initAfterRender === 'function') {
      dbFolderUi.initAfterRender();
    }

    // Keyboard left/right navigation
    el.querySelectorAll('.node').forEach(node=>{
      node.addEventListener('keydown', (e)=>{
        const li = node.parentElement;
        if(e.key === 'ArrowRight'){
          e.preventDefault();
          // if has children and (for conn: must be connected), expand immediate; otherwise, move to first child
          const ch = li.querySelector(':scope > ul');
          if(ch){
            if(li.dataset.connId && !state.connStates[li.dataset.connId]){
              return; // block when disconnected
            }
            if(getComputedStyle(ch).display==='none'){
              tree.toggleOne(li, true);
            } else {
              tree.focusFirstChild(li);
            }
          }
        } else if(e.key === 'ArrowLeft'){
          e.preventDefault();
          const ch = li.querySelector(':scope > ul');
          if(ch && getComputedStyle(ch).display!=='none'){
            // collapse immediate
            tree.toggleOne(li, false);
          } else {
            // move to parent
            tree.focusParent(li);
          }
        }
      });
    });

    el.querySelectorAll('.node .tw').forEach(tw=>{
      tw.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const n = tw.closest('.node');
        if (!n) return;
        try{
          if (typeof dbFolderUi !== 'undefined' && dbFolderUi && typeof dbFolderUi.setSelectedNode === 'function') {
            dbFolderUi.setSelectedNode(n);
          } else {
            document.querySelectorAll('#dbTree .node.dbtree-selected')
              .forEach(x=>x.classList.remove('dbtree-selected'));
            n.classList.add('dbtree-selected');
          }
        }catch(err){
          console.warn('tree.tw click select error', err);
        }
        const li = n.parentElement;
        const ch = li.querySelector(':scope > ul');
        if(!ch) return; // leaf
        // block when disconnected connection root
        if(li.dataset.connId){
          const id = li.dataset.connId;
          if(!state.connStates[id]) return;
        }
        if(ev.altKey){
          // Alt+click: toggle entire subtree
          const isClosed = getComputedStyle(ch).display==='none';
          tree.toggleRecursive(li, isClosed);
        } else {
          // default: immediate only
          tree.toggleOne(li);
        }
      });
    });
  },
  node(text, tw, kind){
    const li = document.createElement('li');
    li.dataset.kind = kind;
    li.dataset.label = text;
    const a = document.createElement('div');
    a.className = 'node';
    a.setAttribute('tabindex', '0');
    a.setAttribute('role', 'treeitem');
    const twEl = document.createElement('span');
    twEl.className = 'tw';
    twEl.textContent = tw;
    a.appendChild(twEl);
    const iconSpan = document.createElement('span');
    iconSpan.innerHTML = this.icon(kind);
    a.appendChild(iconSpan);
    const tx = document.createElement('span');
    tx.textContent = text;
    a.appendChild(tx);
    const tag = document.createElement('span');
    tag.className = 'tag';
    tag.textContent = '';
    a.appendChild(tag);
    li.appendChild(a);
    return li;
  },

  buildNodeInfo(li){
    const info = {
      li,
      kind: li.dataset.kind || 'folder',
      label: (li.dataset.label || '').trim(),
      connId: null,
      schema: null,
      table: null,
      column: null
    };
    const connLi = li.closest('li[data-conn-id]');
    if(connLi){
      info.connId = connLi.dataset.connId;
    }
    const schemaLi = li.closest('li[data-kind="schema"]');
    if(schemaLi){
      const raw = schemaLi.dataset.label || '';
      info.schema = schemaLi.dataset.schema || raw.replace(/^schema:\s*/, '').trim();
    }
    if(li.dataset.schema){ info.schema = li.dataset.schema; }
    if(li.dataset.table){ info.table = li.dataset.table; }
    if(li.dataset.column){ info.column = li.dataset.column; }
    if(!info.table && info.kind === 'table'){ info.table = info.label; }
    return info;
  },

  bindTreeContextMenu(el){
    if(typeof treeCtxConfig === 'undefined' || typeof treeCtx === 'undefined'){
      return;
    }
    el.querySelectorAll('li > .node').forEach(node=>{
      const li = node.parentElement;
      // 연결 루트는 기존 conn 컨텍스트 메뉴 사용
      if(li.dataset.connId) return;
      node.addEventListener('contextmenu', (e)=>{
        e.preventDefault();
        if (typeof dbFolderUi !== 'undefined' && typeof dbFolderUi.setSelectedNode === 'function') {
          dbFolderUi.setSelectedNode(node);
        }
        const kind = li.dataset.kind || 'folder';
        const cfg = treeCtxConfig[kind] || treeCtxConfig._default;
        if(!cfg) return;
        const info = tree.buildNodeInfo(li);
        treeCtx.open(e.clientX, e.clientY, info, cfg);
      });
    });
  },

  updateConnBadges(){
    document.querySelectorAll('#dbTree li[data-conn-id]').forEach(li=>{
      const id = li.dataset.connId;
      const on = !!state.connStates[id];
      const nodeEl = li.querySelector('.node');
      const dot = nodeEl.querySelector('.conn-dot');
      if(dot){ dot.classList.toggle('conn-on', on); dot.classList.toggle('conn-off', !on); }
      const tag = nodeEl.querySelector('.tag');
      if(tag){ tag.style.color = on ? 'var(--ok)' : 'var(--danger)'; tag.textContent = on ? 'conn' : 'discon'; }
      if(!on){ const sub = li.querySelector(':scope > ul'); if(sub){ sub.style.display='none'; const tw = li.querySelector(':scope > .node .tw'); if(tw){ tw.textContent='▶'; } } }
    });
  },
  getConnLi(id){ return Array.from(document.querySelectorAll('#dbTree li[data-conn-id]')).find(li=>li.dataset.connId===id) || null; },
  collapseConn(id){ const li = this.getConnLi(id); if(!li) return; const sub = li.querySelector(':scope > ul'); if(sub){ sub.style.display='none'; const tw = li.querySelector(':scope > .node .tw'); if(tw){ tw.textContent='▶'; } } },
  collapseAllConns(){ document.querySelectorAll('#dbTree li[data-conn-id] > ul').forEach(u=>{u.style.display='none'; const tw = u.parentElement.querySelector(':scope > .node .tw'); if(tw){ tw.textContent='▶'; }}); },
  expandAll(){ document.querySelectorAll('#dbTree ul').forEach(u=>u.style.display='block'); },
  collapseAll(){ document.querySelectorAll('#dbTree ul ul').forEach(u=>{u.style.display='none'; const tw = u.parentElement.querySelector(':scope > .node .tw'); if(tw){ tw.textContent='▶'; }}); }
}
/* ---------------- DB Tree Folder / Drag&Drop ---------------- */
const dbFolderUi = (function(){
  let selectedNode = null;
  let draggingLi = null;
  let pendingNewDbTargetLi = null;
  let folderClipboardName = null;

  function getNodeType(li){
    if(!li) return null;
    if(li.dataset.kind === 'folder') return 'folder';  // custom folder
    if(li.dataset.connId) return 'db';                 // connection root
    return null;
  }

  function clearSelection(){
    document.querySelectorAll('#dbTree .node.dbtree-selected')
      .forEach(n=>n.classList.remove('dbtree-selected'));
    selectedNode = null;
  }

  function setSelected(node){
    if(selectedNode === node) return;
    clearSelection();
    selectedNode = node;
    if(node){
      node.classList.add('dbtree-selected');
      node.focus();
    }
  }

  function clearDropIndicators(){
    document.querySelectorAll('#dbTree li.dbtree-drop-target')
      .forEach(li=>li.classList.remove('dbtree-drop-target'));
  }

  function isDescendant(childLi, maybeAncestor){
    let cur = childLi.parentElement;
    while(cur){
      if(cur === maybeAncestor) return true;
      cur = cur.parentElement;
    }
    return false;
  }



  // 전역 클릭으로 폴더 선택 해제: 트리 밖이나 빈 영역 클릭 시 선택 해제
  function initGlobalClickClear(){
    if (document.body && document.body.dataset.dbtreeClickClearBound === '1') return;
    document.addEventListener('click', (e)=>{
      if (e.target.closest('#dbTree .node')) return;
      clearSelection();
    });
    if (document.body) {
      document.body.dataset.dbtreeClickClearBound = '1';
    }
  }


  // 트리 내부 노드 공통 클릭 시 단일 선택 유지
  function initNodeClickSelect(){
    const container = document.getElementById('dbTree');
    if (!container) return;
    if (container.dataset.nodeClickSelectBound === '1') return;
    container.dataset.nodeClickSelectBound = '1';
    container.addEventListener('click', (e)=>{
      // li 기준으로 찾고, 그 안의 .node를 대표 선택 요소로 사용
      const li = e.target.closest('#dbTree li');
      if (!li) return;
      const node = li.querySelector(':scope > .node') || li.querySelector('.node');
      if (!node) return;
      setSelected(node);
    });
  }

  function attachNodeEvents(node, li){
    const t = getNodeType(li);
    if(t !== 'folder' && t !== 'db') return;

    node.draggable = true;

    node.addEventListener('click', ()=>{
      setSelected(node);
    });

    node.addEventListener('dragstart', (e)=>{
      const type = getNodeType(li);
      if(type !== 'folder' && type !== 'db'){
        e.preventDefault();
        return;
      }
      draggingLi = li;
      node.classList.add('dbtree-dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', 'dbtree:'+type);
    });

    node.addEventListener('dragend', ()=>{
      node.classList.remove('dbtree-dragging');
      draggingLi = null;
      clearDropIndicators();
    });

    node.addEventListener('dragover', (e)=>{
      if(!draggingLi) return;
      const type = getNodeType(li);
      if(type !== 'folder' && type !== 'db') return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      clearDropIndicators();
      li.classList.add('dbtree-drop-target');
    });

    node.addEventListener('dragleave', ()=>{
      li.classList.remove('dbtree-drop-target');
    });

    node.addEventListener('drop', (e)=>{
      if(!draggingLi) return;
      e.preventDefault();
      clearDropIndicators();

      const targetLi   = li;
      const targetType = getNodeType(targetLi);
      if(!targetType) return;
      if(draggingLi === targetLi) return;

      const dragType = getNodeType(draggingLi);
      if(dragType !== 'folder' && dragType !== 'db') return;

      // don't allow folder to be dropped into itself or its descendants
      if(dragType === 'folder' && isDescendant(targetLi, draggingLi)) return;

      if(targetType === 'folder'){
        let childUl = targetLi.querySelector(':scope > ul');
        if(!childUl){
          childUl = document.createElement('ul');
          targetLi.appendChild(childUl);
        }
        childUl.appendChild(draggingLi);
      }else{
        const parentUl = targetLi.parentElement;
        parentUl.insertBefore(draggingLi, targetLi.nextSibling);
      }
    });
  }

  function ensureRootUl(){
    const container = document.getElementById('dbTree');
    if(!container) return null;
    let rootUl = container.querySelector(':scope > ul');
    if(!rootUl){
      rootUl = document.createElement('ul');
      container.innerHTML = '';
      container.appendChild(rootUl);
    }
    return rootUl;
  }

  // 같은 UL 내에서 폴더(kind==='folder')를 위로 정렬
  function sortFolderFirst(parentUl){
    if(!parentUl) return;
    if(typeof sortDbTreeDepth === 'function'){
      sortDbTreeDepth(parentUl);
      return;
    }
    const items = Array.from(parentUl.querySelectorAll(':scope > li'));
    if(!items.length) return;
    const folders = [];
    const others  = [];
    items.forEach(function(li){
      if(li.dataset && li.dataset.kind === 'folder'){
        folders.push(li);
      }else{
        others.push(li);
      }
    });
    if(!folders.length || !others.length) return;
    items.forEach(function(li){
      parentUl.removeChild(li);
    });
    folders.concat(others).forEach(function(li){
      parentUl.appendChild(li);
    });
  }



  
function getUniqueName(parentUl, baseName, kind){
    if(!parentUl) return baseName;
    const items = Array.from(parentUl.querySelectorAll(':scope > li'));
    if(!items.length) return baseName;

    const exists = (name)=>{
      return items.some(li=>{
        if(!li.dataset) return false;
        if(kind && li.dataset.kind !== kind) return false;
        const lbl = (li.dataset.label || '').trim();
        return lbl === name;
      });
    };

    let candidate = baseName;
    if(!exists(candidate)) return candidate;

    let n = 1;
    while(n < 1000){
      candidate = baseName + '(' + n + ')';
      if(!exists(candidate)) return candidate;
      n++;
    }
    return candidate;
  }

  
function startFolderLabelEdit(li, opts){
    opts = opts || {};
    const node = li.querySelector(':scope > .node');
    if(!node) return;
    const labelSpan =
      node.querySelector('span:nth-of-type(3)') ||
      node.querySelector('span:nth-of-type(2)');
    if(!labelSpan) return;

    const originalText = (labelSpan.textContent || '').trim();
    const input = document.createElement('input');
    input.type = 'text';
    input.value = originalText;
    input.className = 'dbtree-folder-edit';

    // 오류 메시지용 툴팁 요소
    let err = node.querySelector(':scope > .dbtree-folder-edit-error');
    if(!err){
      err = document.createElement('div');
      err.className = 'dbtree-folder-edit-error';
      node.appendChild(err);
    }
    err.textContent = '';
    err.style.display = 'none';

    labelSpan.style.display = 'none';
    const tagSpan = node.querySelector(':scope > .tag');
    if(tagSpan){
      node.insertBefore(input, tagSpan);
    }else{
      node.appendChild(input);
    }
    input.focus();
    input.select();

    function hasDuplicateName(val){
      const parentUl = li.parentElement;
      if(!parentUl) return false;
      const siblings = parentUl.querySelectorAll(':scope > li');
      val = (val || '').trim();
      for(const sib of siblings){
        if(sib === li) continue;
        if(sib.dataset && sib.dataset.kind === 'folder'){
          const sibNode = sib.querySelector(':scope > .node');
          if(!sibNode) continue;
          const sibLabelSpan =
            sibNode.querySelector('span:nth-of-type(3)') ||
            sibNode.querySelector('span:nth-of-type(2)');
          if(!sibLabelSpan) continue;
          const sibText = (sibLabelSpan.textContent || '').trim();
          if(!sibText) continue;
          if(sibText === val){
            return true;
          }
        }
      }
      return false;
    }

    function showError(msg){
      if(!err) return;
      err.textContent = msg || '';
      err.style.display = msg ? 'block' : 'none';
    }

    let finished = false;

    function cleanup(){
      if(finished) return;
      finished = true;
      input.removeEventListener('keydown', onKey);
      document.removeEventListener('mousedown', onDocMouseDown);
    }

    function finish(save){
      const raw = input.value;
      const val = (raw || '').trim();

      if(!save){
        // 취소
        showError('');
        if(input.parentElement){
          node.removeChild(input);
        }
        labelSpan.style.display = '';
        if(opts.isNew){
          const parentUl = li.parentElement;
          if(parentUl){
            parentUl.removeChild(li);
          }
        }
        cleanup();
        return;
      }

      if(!val){
        // 빈 값은 새 폴더면 취소, 기존 폴더는 이름 유지
        showError('');
        if(input.parentElement){
          node.removeChild(input);
        }
        labelSpan.style.display = '';
        if(opts.isNew){
          const parentUl = li.parentElement;
          if(parentUl){
            parentUl.removeChild(li);
          }
        }
        cleanup();
        return;
      }

      if(hasDuplicateName(val)){
        // 같은 Depth 폴더명 중복 -> 삭제하지 않고 편집 상태 유지
        showError('같은 위치에 동일한 폴더명이 이미 있습니다.');
        setTimeout(()=>{
          input.focus();
          input.select();
        }, 0);
        return;
      }

      // 정상 저장
      showError('');
      labelSpan.textContent = val;
      labelSpan.style.display = '';
      li.dataset.label = val;
      if(input.parentElement){
        node.removeChild(input);
      }
      setSelected(node);
      cleanup();
    }

    function onKey(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        finish(true);
      }else if(e.key === 'Escape'){
        e.preventDefault();
        finish(false);
      }
    }

    function onDocMouseDown(e){
      // 인풋 자체를 클릭한 경우에는 편집 유지
      if(e.target === input || input.contains(e.target)){
        return;
      }
      // 그 외 영역 클릭 시 현재 값으로 저장
      finish(true);
    }

    input.addEventListener('keydown', onKey);
    document.addEventListener('mousedown', onDocMouseDown);
    input.addEventListener('input', function(){
      showError('');
    });
  }


function startTabTitleEdit(tabEl){
  if(!tabEl) return;
  const titleSpan = tabEl.querySelector('.tab-title');
  if(!titleSpan) return;

  const fullText = (titleSpan.textContent || '').trim();
  const tabId = tabEl.dataset.tabId;
  let coreOriginal = '';

  try{
    if (typeof state !== 'undefined' && state && Array.isArray(state.tabs)) {
      const t = state.tabs.find(t => String(t.id) === String(tabId));
      if (t && t.title) {
        coreOriginal = String(t.title);
      }
    }
  }catch(e){
    console.warn('startTabTitleEdit: read core title from state error', e);
  }

  // state 에 코어 제목이 없으면, 표시 문자열에서 접두사 제거해서 코어 추출
  if (!coreOriginal) {
    try{
      if (typeof getTabCoreTitle === 'function') {
        coreOriginal = getTabCoreTitle(fullText);
      } else {
        coreOriginal = fullText;
      }
    }catch(e){
      console.warn('startTabTitleEdit: fallback core title build error', e);
      coreOriginal = fullText;
    }
  }

  const input = document.createElement('input');
  input.type = 'text';
  // 이름 변경 입력창에는 항상 코어 제목만 보여준다.
  input.value = coreOriginal;
  input.className = 'tab-title-edit';

  // 숨기고 input 삽입
  titleSpan.style.display = 'none';
  titleSpan.parentElement.insertBefore(input, titleSpan);

  input.focus();
  input.select();

  let finished = false;
  function cleanup(){
    if(finished) return;
    finished = true;
    input.removeEventListener('keydown', onKey);
    input.removeEventListener('blur', onBlur);
  }

  function apply(val){
    const v = (val || '').trim();
    const core = v || coreOriginal || fullText;

    if(input.parentElement){
      input.parentElement.removeChild(input);
    }

    try{
      if(typeof state !== 'undefined' && state && Array.isArray(state.tabs)){
        const tab = state.tabs.find(t => String(t.id) === String(tabId));
        if(tab){
          // 내부 상태에는 코어 제목만 저장
          tab.title = core;
        }
      }
      // 전체 탭을 다시 렌더링해서, 접두사(＜DB라벨＞)는 통일된 규칙대로 다시 붙인다.
      if (typeof ui !== 'undefined' && ui) {
        if (typeof ui.renderTabs === 'function') {
          ui.renderTabs();
        }
        if (typeof ui._scheduleAutoSave === 'function') {
          ui._scheduleAutoSave();
        }
      }
    }catch(e){
      console.warn('startTabTitleEdit: update tab title error', e);
    }
  }

  function finish(applyChange){
    if(applyChange){
      apply(input.value);
    }else{
      // 취소: 원래 표시 문자열 복원
      titleSpan.style.display = '';
      if(input.parentElement){
        input.parentElement.removeChild(input);
      }
    }
    cleanup();
  }

  function onKey(e){
    if(e.key === 'Enter'){
      e.preventDefault();
      finish(true);
    }else if(e.key === 'Escape'){
      e.preventDefault();
      finish(false);
    }
  }
  function onBlur(){
    finish(true);
  }

  input.addEventListener('keydown', onKey);
  input.addEventListener('blur', onBlur);
}

function startDbLabelEdit(li){
  // 연결 중인 DB는 이름 변경 불가 (연결 상태에서는 폴더만 이름 변경 허용)
  try{
    if (li && li.dataset && li.dataset.connId){
      var cid = li.dataset.connId;
      if (typeof state !== 'undefined' && state && state.connStates && state.connStates[cid]){
        return;
      }
    }
  }catch(e){
    console.warn('startDbLabelEdit: rename blocked for connected DB', e);
  }

  if(!li) return;
  const node = li.querySelector(':scope > .node');
  if(!node) return;
  const labelSpan =
    node.querySelector('span:nth-of-type(3)') ||
    node.querySelector('span:nth-of-type(2)');
  if(!labelSpan) return;

  const originalText = (labelSpan.textContent || '').trim();
  const input = document.createElement('input');
  input.type = 'text';
  input.value = originalText;
  input.className = 'dbtree-folder-edit';

  // DB 이름 편집 시에도 폴더와 동일한 에러 툴팁을 재사용
  let err = node.querySelector(':scope > .dbtree-folder-edit-error');
  if(!err){
    err = document.createElement('div');
    err.className = 'dbtree-folder-edit-error';
    node.appendChild(err);
  }
  // 이름 변경 시작 시에는 항상 에러 툴팁을 숨긴다
  err.textContent = '';
  err.style.display = 'none';

  labelSpan.style.display = 'none';
  const tagSpan = node.querySelector(':scope > .tag');
  if(tagSpan){
    node.insertBefore(input, tagSpan);
  }else{
    node.appendChild(input);
  }
  input.focus();
  input.select();

  function showError(msg){
    if(!err) return;
    err.textContent = msg || '';
    err.style.display = msg ? 'block' : 'none';
  }

  let finished = false;

  function cleanup(){
    if(finished) return;
    finished = true;
    input.removeEventListener('keydown', onKey);
    document.removeEventListener('mousedown', onDocMouseDown);
  }

  function finish(save){
    const raw = input.value;
    const val = (raw || '').trim();

    if(!save){
      // 취소: 원래 이름 유지
      showError('');
      if(input.parentElement){
        input.parentElement.removeChild(input);
      }
      labelSpan.style.display = '';
      cleanup();
      return;
    }

    if(!val){
      // 빈 값이면 원래 이름 유지
      showError('');
      if(input.parentElement){
        input.parentElement.removeChild(input);
      }
      labelSpan.style.display = '';
      cleanup();
      return;
    }

    // 동일 depth 내에서 DB 이름 중복 체크 (자기 자신은 제외)
    const parentUl = li.parentElement;
    if(parentUl){
      const siblings = parentUl.querySelectorAll(':scope > li');
      const trimmed = (val || '').trim();
      let hasDup = false;
      for(const sib of siblings){
        if(sib === li) continue;
        if(!sib.dataset) continue;
        // DB 노드(kind='conn')만 검사
        if(sib.dataset.kind && sib.dataset.kind !== 'conn') continue;
        const sibLabel = (sib.dataset.label || '').trim();
        if(sibLabel && sibLabel === trimmed){
          hasDup = true;
          break;
        }
      }
      if(hasDup){
        showError('같은 위치에 동일한 데이터베이스명이 이미 있습니다.');
        // 다시 편집 가능하도록 포커스 복원
        setTimeout(()=>{
          input.focus();
          input.select();
        }, 0);
        return;
      }
    }


    // 라벨 및 데이터셋 갱신
    showError('');
    labelSpan.textContent = val;
    labelSpan.style.display = '';
    if(input.parentElement){
      input.parentElement.removeChild(input);
    }

    li.dataset.label = val;

    // 상태 라벨 갱신
    try{
      if(typeof state !== 'undefined' && state && Array.isArray(state.availableConns)){
        const connId = li.dataset.connId;
        if(connId){
          const found = state.availableConns.find(c => c.id === connId);
          if(found){
            found.label = val;
          }
        }
      }
    }catch(e){
      console.warn('startDbLabelEdit: update state label error', e);
    }

    cleanup();
  }

  function onKey(e){
    if(e.key === 'Enter'){
      e.preventDefault();
      finish(true);
    }else if(e.key === 'Escape'){
      e.preventDefault();
      finish(false);
    }
  }

  function onDocMouseDown(e){
    // 인풋 자체를 클릭한 경우에는 편집 유지
    if(e.target === input || input.contains(e.target)){
      return;
    }
    // 그 외 영역 클릭 시 현재 값으로 저장
    finish(true);
  }

  input.addEventListener('keydown', onKey);
  document.addEventListener('mousedown', onDocMouseDown);
}
function getNextFolderLabel(targetUl){
    const base = '새 폴더';
    if(!targetUl){
      return base;
    }
    const used = new Set();
    targetUl.querySelectorAll(':scope > li').forEach(li=>{
      if(!li.dataset || li.dataset.kind !== 'folder') return;
      const label = (li.dataset.label || '').trim();
      if(!label) return;
      if(label === base){
        used.add(0);
        return;
      }
      const m = label.match(/^새 폴더\((\d+)\)$/);
      if(m){
        used.add(parseInt(m[1], 10));
      }
    });
    if(used.size === 0){
      return base;
    }
    let n = 0;
    while(used.has(n)){
      n++;
    }
    return n === 0 ? base : base + '(' + n + ')';
  }
function addFolder(){
    const rootUl = ensureRootUl();
    if(!rootUl) return;

    let targetUl = null;
    if(!selectedNode){
      targetUl = rootUl;
    }else{
      const selLi   = selectedNode.closest('li');
      const selType = getNodeType(selLi);
      if(selType === 'folder'){
        let selChildUl = selLi.querySelector(':scope > ul');
        if(!selChildUl){
          selChildUl = document.createElement('ul');
          selLi.appendChild(selChildUl);
        }
        targetUl = selChildUl;
      }else if(selType === 'db'){
        // DB 선택 시: DB와 같은 depth(형제)로 생성
        const parentUl = selLi.parentElement;
        targetUl = parentUl;
      }else{
        // 테이블/컬럼 등 기타 노드 선택 시: 폴더는 루트에 생성
        targetUl = rootUl;
      }
    }

    const folderLabel = getNextFolderLabel(targetUl || rootUl);
    const li = tree.node(folderLabel, '▶', 'folder');
    const childUl = document.createElement('ul');
    li.appendChild(childUl);

    if(!selectedNode){
      rootUl.appendChild(li);
    }else{
      const selLi   = selectedNode.closest('li');
      const selType = getNodeType(selLi);
      if(selType === 'folder'){
        targetUl.appendChild(li);
      }else if(selType === 'db'){
        const parentUl = selLi.parentElement;
        parentUl.insertBefore(li, selLi.nextSibling);
      }else{
        rootUl.appendChild(li);
      }
    }

    if(targetUl){
      sortFolderFirst(targetUl);
    }

    const node = li.querySelector(':scope > .node');
    if(node){
      attachNodeEvents(node, li);
      // 폴더 컨텍스트 메뉴 연결
      if (typeof treeCtxConfig !== 'undefined' && typeof treeCtx !== 'undefined') {
        node.addEventListener('contextmenu', (e)=>{
          e.preventDefault();
          if (typeof dbFolderUi !== 'undefined' && typeof dbFolderUi.setSelectedNode === 'function') {
            dbFolderUi.setSelectedNode(node);
          }
          const li = node.parentElement;
          const kind = li.dataset.kind || 'folder';
          const cfg = treeCtxConfig[kind] || treeCtxConfig._default;
          if(!cfg) return;
          const info = tree.buildNodeInfo(li);
          treeCtx.open(e.clientX, e.clientY, info, cfg);
        });
      }
      setSelected(node);
      startFolderLabelEdit(li, { isNew: true });
    }
  }
  function renameFolder(){
    if(!selectedNode){
      window.alert('이름을 변경할 폴더를 먼저 선택하세요.');
      return;
    }
    const li = selectedNode.closest('li');
    if(getNodeType(li) !== 'folder'){
      window.alert('폴더만 이름 변경이 가능합니다.');
      return;
    }
    startFolderLabelEdit(li, { isNew: false });
  }
  function deleteFolder(){
    if(!selectedNode){
      window.alert('삭제할 폴더를 먼저 선택하세요.');
      return;
    }
    const li = selectedNode.closest('li');
    if(getNodeType(li) !== 'folder'){
      window.alert('폴더만 삭제할 수 있습니다.');
      return;
    }
    const labelSpan =
      selectedNode.querySelector('span:nth-of-type(3)') ||
      selectedNode.querySelector('span:nth-of-type(2)');
    const label = labelSpan ? labelSpan.textContent.trim() : '';
    if(!window.confirm('폴더 "'+label+'" 및 그 하위 항목을 모두 삭제하시겠습니까?')) return;
    const parentUl = li.parentElement;
    if(parentUl){ parentUl.removeChild(li); }
    clearSelection();
  }

  function copyFolderFromLi(li){
    if(!li){
      window.alert('복사할 폴더를 찾을 수 없습니다.');
      return;
    }
    if(getNodeType(li) !== 'folder'){
      window.alert('폴더만 복사할 수 있습니다.');
      return;
    }
    const label = (li.dataset.label || '').trim() || '새 폴더';
    if (typeof dbTreeClipboard !== 'undefined') {
      dbTreeClipboard.type   = 'folder';
      dbTreeClipboard.label  = label;
      dbTreeClipboard.connId = null;
      dbTreeClipboard.folderLi = li;
    }
  }

  function copyFolderChildrenRecursive(srcFolderLi, dstFolderLi){
    if(!srcFolderLi || !dstFolderLi) return;

    const srcChildUl = srcFolderLi.querySelector(':scope > ul');
    if(!srcChildUl) return;

    let dstChildUl = dstFolderLi.querySelector(':scope > ul');
    if(!dstChildUl){
      dstChildUl = document.createElement('ul');
      dstFolderLi.appendChild(dstChildUl);
    }

    const srcChildLis = Array.from(srcChildUl.querySelectorAll(':scope > li'));

    srcChildLis.forEach((srcChildLi)=>{
      const childType = getNodeType(srcChildLi);
      if(!childType) return;

      if(childType === 'folder'){
        const baseName = (srcChildLi.dataset.label || '').trim() || '새 폴더';
        const folderName = getUniqueName(dstChildUl, baseName, 'folder');

        const newFolderLi = tree.node(folderName, '▶', 'folder');
        newFolderLi.dataset.label = folderName;

        const newFolderChildUl = document.createElement('ul');
        newFolderLi.appendChild(newFolderChildUl);
        dstChildUl.appendChild(newFolderLi);

        const node = newFolderLi.querySelector(':scope > .node');
        if(node){
          attachNodeEvents(node, newFolderLi);
          // 폴더 컨텍스트 메뉴 연결
          if (typeof treeCtxConfig !== 'undefined' && typeof treeCtx !== 'undefined') {
            node.addEventListener('contextmenu', (e)=>{
              e.preventDefault();
              if (typeof dbFolderUi !== 'undefined' && typeof dbFolderUi.setSelectedNode === 'function') {
                dbFolderUi.setSelectedNode(node);
              }
              const li = node.parentElement;
              const kind = li.dataset.kind || 'folder';
              const cfg = treeCtxConfig[kind] || treeCtxConfig._default;
              if(!cfg) return;
              const info = tree.buildNodeInfo(li);
              treeCtx.open(e.clientX, e.clientY, info, cfg);
            });
          }
        }

        copyFolderChildrenRecursive(srcChildLi, newFolderLi);
      }else if(childType === 'db'){
        const srcConnId = (srcChildLi.dataset.connId || '').trim();
        if(!srcConnId) return;

        let dbLabel = (srcChildLi.dataset.label || '').trim();
        if(!dbLabel){
          const srcNode = srcChildLi.querySelector(':scope > .node');
          if(srcNode){
            dbLabel = srcNode.textContent.trim();
          }else{
            dbLabel = srcConnId;
          }
        }

        // 원본과 다른 새 connId 생성 (폴더 복사 시에도 각 DB는 독립적으로 동작)
        let newConnId = '';
        try{
          const ts  = Date.now().toString(36);
          const rnd = Math.floor(Math.random()*1e6).toString(36);
          newConnId = (srcConnId || 'local') + '-copy-' + ts + '-' + rnd;
        }catch(e){
          console.warn('copyFolderChildrenRecursive: newConnId generate error', e);
        }
        if(!newConnId){
          const ts  = Date.now().toString(36);
          const rnd = Math.floor(Math.random()*1e6).toString(36);
          newConnId = 'local-' + ts + '-' + rnd;
        }

        // 가능한 경우 원본 프로필 복사
        let profile = null;
        try{
          if (typeof state !== 'undefined' && state && Array.isArray(state.availableConns)) {
            const found = state.availableConns.find(c => c && c.id === srcConnId);
            if (found && typeof found.profile !== 'undefined') {
              profile = found.profile;
            }
          }
        }catch(e){
          console.warn('copyFolderChildrenRecursive: profile clone error', e);
        }

        try{
          pendingNewDbTargetLi = dstFolderLi;
          let env = null;
          try{
            if (typeof state !== 'undefined' && state && state.connEnvs && srcConnId){
              env = state.connEnvs[srcConnId] || null;
            }
          }catch(e){
            console.warn('copyFolderChildrenRecursive: env clone error', e);
          }
          addDbNode({ id: newConnId, label: dbLabel, profile: profile, env: env });
        }catch(e){
          console.warn('copyFolderChildrenRecursive: addDbNode error', e);
        }
      }
    });

    if(dstChildUl){
      sortFolderFirst(dstChildUl);
    }
  }

  function pasteFolderAtLi(targetLi){
    if (typeof dbTreeClipboard === 'undefined' || !dbTreeClipboard || !dbTreeClipboard.type) {
      window.alert('복사된 정보가 없습니다.');
      return;
    }
    const rootUl = ensureRootUl();
    if(!rootUl) return;

    // 원본 폴더 자기 자신/하위에는 붙여넣기 금지
    if (dbTreeClipboard.type === 'folder' && targetLi && dbTreeClipboard.folderLi) {
      if (targetLi === dbTreeClipboard.folderLi || isDescendant(targetLi, dbTreeClipboard.folderLi)) {
        window.alert('원본 폴더 내부에는 붙여넣기할 수 없습니다.');
        return;
      }
    }

    // 폴더 클립보드 → 폴더 붙여넣기
    if (dbTreeClipboard.type === 'folder') {
      const baseName = dbTreeClipboard.label || '새 폴더';

      let targetUl = null;
      let selType = null;

      if(!targetLi){
        // 빈 영역 붙여넣기 → 루트에 생성
        targetUl = rootUl;
      }else{
        selType = getNodeType(targetLi);
        if(selType === 'folder'){
          let selChildUl = targetLi.querySelector(':scope > ul');
          if(!selChildUl){
            selChildUl = document.createElement('ul');
            targetLi.appendChild(selChildUl);
          }
          targetUl = selChildUl;
        }else{
          const parentUl = targetLi.parentElement;
          targetUl = parentUl || rootUl;
        }
      }

      if(!targetUl){
        targetUl = rootUl;
      }

      // 동일 depth 내에서 이름 중복 방지
      const folderName = getUniqueName(targetUl, baseName, 'folder');

      // 새 폴더 노드 생성 (이름만 복사, 하위 내용은 복사하지 않음)
      const li = tree.node(folderName, '▶', 'folder');
      const childUl = document.createElement('ul');
      li.appendChild(childUl);

      // 실제 삽입
      if(!targetLi){
        targetUl.appendChild(li);
      }else{
        if(selType === 'folder'){
          targetUl.appendChild(li);
        }else{
          const parentUl = targetLi.parentElement;
          if(parentUl){
            parentUl.insertBefore(li, targetLi.nextSibling);
          }else{
            rootUl.appendChild(li);
          }
        }
      }

      // 하위 폴더 및 DB까지 복사
      if (dbTreeClipboard.folderLi) {
        try{
          copyFolderChildrenRecursive(dbTreeClipboard.folderLi, li);
        }catch(e){
          console.warn('pasteFolderAtLi: copyFolderChildrenRecursive error', e);
        }
      }

      if(targetUl){
        sortFolderFirst(targetUl);
      }

      const node = li.querySelector(':scope > .node');
      if(node){
        attachNodeEvents(node, li);
        // 폴더 컨텍스트 메뉴 연결
        if (typeof treeCtxConfig !== 'undefined' && typeof treeCtx !== 'undefined') {
          node.addEventListener('contextmenu', (e)=>{
            e.preventDefault();
            if (typeof dbFolderUi !== 'undefined' && typeof dbFolderUi.setSelectedNode === 'function') {
              dbFolderUi.setSelectedNode(node);
            }
            const li = node.parentElement;
            const kind = li.dataset.kind || 'folder';
            const cfg = treeCtxConfig[kind] || treeCtxConfig._default;
            if(!cfg) return;
            const info = tree.buildNodeInfo(li);
            treeCtx.open(e.clientX, e.clientY, info, cfg);
          });
        }
        setSelected(node);
      }
      return;
    }



    // 데이터베이스 클립보드 → DB 붙여넣기
    if (dbTreeClipboard.type === 'db') {
      const srcConnId = dbTreeClipboard.connId;
      if(!srcConnId){
        window.alert('붙여넣기할 데이터베이스 정보를 찾을 수 없습니다.');
        return;
      }

      const baseLabel = dbTreeClipboard.label || srcConnId;

      let targetUlForDb = null;
      if(!targetLi){
        targetUlForDb = rootUl;
      }else{
        const selType = getNodeType(targetLi);
        if(selType === 'folder'){
          let selChildUl = targetLi.querySelector(':scope > ul');
          if(!selChildUl){
            selChildUl = document.createElement('ul');
            targetLi.appendChild(selChildUl);
          }
          targetUlForDb = selChildUl;
        }else if(selType === 'db'){
          const parentUl = targetLi.parentElement;
          targetUlForDb = parentUl || rootUl;
        }else{
          targetUlForDb = rootUl;
        }
      }

      if(!targetUlForDb){
        targetUlForDb = rootUl;
      }

      // 동일 depth 내에서 이름 중복 방지 (DB 노드)
      const label = getUniqueName(targetUlForDb, baseLabel, 'conn');

      // 원본과 독립적인 새 connId 생성
      let newConnId = '';
      try{
        const ts  = Date.now().toString(36);
        const rnd = Math.floor(Math.random()*1e6).toString(36);
        newConnId = (srcConnId || 'local') + '-copy-' + ts + '-' + rnd;
      }catch(e){
        console.warn('pasteFolderAtLi: newConnId generate error', e);
      }
      if(!newConnId){
        const ts  = Date.now().toString(36);
        const rnd = Math.floor(Math.random()*1e6).toString(36);
        newConnId = 'local-' + ts + '-' + rnd;
      }

      // 가능한 경우 원본 프로필 복사
      let profile = null;
      try{
        if (typeof state !== 'undefined' && state && Array.isArray(state.availableConns)) {
          const found = state.availableConns.find(c => c && c.id === srcConnId);
          if (found && typeof found.profile !== 'undefined') {
            profile = found.profile;
          }
        }
      }catch(e){
        console.warn('pasteFolderAtLi: profile clone error', e);
      }

      try{
        pendingNewDbTargetLi = targetLi || null;
        let env = null;
        try{
          if (typeof state !== 'undefined' && state && state.connEnvs && dbTreeClipboard.connId){
            env = state.connEnvs[dbTreeClipboard.connId] || null;
          }
        }catch(e){
          console.warn('pasteFolderAtLi: env clone error', e);
        }
        addDbNode({ id: newConnId, label: label, profile: profile, env: env });
      }catch(e){
        console.warn('pasteFolderAtLi: db paste error', e);
      }
      return;
    }


    window.alert('지원하지 않는 클립보드 타입입니다.');
  }


function initToolbar(){
    const addBtn = document.getElementById('dbtreeAddFolderBtn');
    if(addBtn){
      addBtn.addEventListener('click', addFolder);
    }

    const addDbBtn = document.getElementById('dbtreeAddDbBtn');
    if(addDbBtn){
      addDbBtn.addEventListener('click', ()=>{
        try{
          const info = getSelectionInfo();
          pendingNewDbTargetLi = info ? info.li : null;

          if (typeof connSettings !== 'undefined' && connSettings && typeof connSettings.openNew === 'function') {
            connSettings.openNew();
          }
        }catch(e){
          console.warn('dbtreeAddDbBtn click error', e);
        }
      });
    }

    // 트리 밖/빈 영역 클릭 시 선택 해제
    initGlobalClickClear();
    // 트리 내부 노드 공통 클릭 시 단일 선택 유지
    initNodeClickSelect();
  }

  function initAfterRender(){
    const container = document.getElementById('dbTree');
    if(!container) return;
    const rootUl = container.querySelector(':scope > ul');
    if(!rootUl) return;

    rootUl.querySelectorAll(':scope > li').forEach(li=>{
      const t = getNodeType(li);
      if(t !== 'folder' && t !== 'db') return;
      const node = li.querySelector(':scope > .node');
      if(node) attachNodeEvents(node, li);
    });

    // 빈 영역 우클릭 컨텍스트 메뉴 (Database 생성 / 폴더 생성 / 붙여넣기)
    container.addEventListener('contextmenu', (e)=>{
      const target = e.target;
      if(target && target.closest && target.closest('.node')){
        // 노드 우클릭은 기존 컨텍스트 메뉴가 처리
        return;
      }
      if(!container.contains(e.target)) return;

      e.preventDefault();

      try{
        if(typeof treeCtxConfig === 'undefined' || typeof treeCtx === 'undefined' || !treeCtx || typeof treeCtx.open !== 'function'){
          return;
        }

        // 선택 해제
        clearSelection();

        const items = treeCtxConfig['dbtree-empty'] || [
          { act: 'dbtree-create-db',     label: 'Database 생성', icon: 'fa-solid fa-database' },
          { act: 'dbtree-create-folder', label: '폴더 생성',     icon: 'fa-regular fa-folder' },
          { act: 'dbtree-paste',         label: '붙여넣기',     icon: 'fa-solid fa-clipboard' }
        ];
        treeCtx.open(e.clientX, e.clientY, null, items);
      }catch(err){
        console.warn('dbTree empty contextmenu error', err);
      }
    });
  }

  
  function addDbNode(conn){
    if(!conn) return;
    const rootUl = ensureRootUl();
    if(!rootUl) return;

    let label = (conn.label || conn.id || '').trim();
    if(!label){
      return;
    }

    let connId = (conn.id || '').trim();
    if(!connId){
      const ts  = Date.now().toString(36);
      const rnd = Math.floor(Math.random()*1e6).toString(36);
      connId = 'local-' + ts + '-' + rnd;
    }

    try{
      if (typeof state !== 'undefined' && state) {
        const list = state.availableConns || [];
        const existingIdx = list.findIndex(c => c && c.id === connId);
        if(existingIdx === -1){
          list.push({ id: connId, label: label, profile: conn.profile || null, env: conn.env || null });
        }else{
          const c = list[existingIdx];
          list[existingIdx] = {
            id: connId,
            label: label,
            profile: (conn.profile != null ? conn.profile : (c.profile || null)),
            env: (conn.env != null ? conn.env : (c.env || null))
          };
        }
        state.availableConns = list;

        // 환경 정보 별도 맵
        if (!state.connEnvs) {
          state.connEnvs = {};
        }
        if (conn.env != null) {
          state.connEnvs[connId] = conn.env || '';
        } else if (typeof state.connEnvs[connId] === 'undefined') {
          state.connEnvs[connId] = '';
        }
      }
    }catch(e){
      console.warn('addDbNode: state.availableConns update error', e);
    }

    const li = tree.node(label, '▶', 'conn');
    li.dataset.connId = connId;
    if (state && state.connEnvs && typeof state.connEnvs[connId] !== 'undefined') {
      li.dataset.env = state.connEnvs[connId];
    }
    attachConnPinControl(li, connId);

    const nodeEl = li.querySelector('.node');
    if(nodeEl){
      // 상태 점 아이콘
      const dot = document.createElement('i');
      dot.className = 'fa-solid fa-circle conn-off conn-dot';
      nodeEl.insertBefore(dot, nodeEl.children[1] || null);

      // 더블클릭 = 연결 시도
      nodeEl.addEventListener('dblclick', ()=>{
        try{
          const isOn = !!(state.connStates && state.connStates[connId]);
          if (isOn) {
            const liNode = nodeEl.closest('li');
            if (liNode) {
              tree.toggleOne(liNode);
            }
            return;
          }
          if(typeof ui !== 'undefined' && ui && typeof ui.openConnReasonModal === 'function'){
            ui._pendingConnSelectUsed   = false;
            ui._pendingConnAfterConnect = null;
            ui.openConnReasonModal(connId);
          }
        }catch(e){
          console.warn('addDbNode: dblclick handler error', e);
        }
      });

      // 우클릭 = 컨텍스트 메뉴
      nodeEl.addEventListener('contextmenu', (e)=>{
        try{
          e.preventDefault();
          // 우클릭 시에도 폴더/DB 단일 선택 유지: 기존 선택 모두 해제 후 이 DB만 선택
          document.querySelectorAll('#dbTree .node.dbtree-selected')
            .forEach(n=>n.classList.remove('dbtree-selected'));
          selectedNode = nodeEl;
          nodeEl.classList.add('dbtree-selected');
          nodeEl.focus();

          if(typeof ctxMenu !== 'undefined' && ctxMenu && typeof ctxMenu.open === 'function'){
            ctxMenu.open(e.clientX, e.clientY, connId);
          }
        }catch(err){
          console.warn('addDbNode: contextmenu handler error', err);
        }
      });

      // 폴더/DB 드래그앤드랍 이벤트
      attachNodeEvents(nodeEl, li);
    }

    // 삽입 위치 결정: 우선 pendingNewDbTargetLi, 없으면 현재 selectedNode
    let targetLi = pendingNewDbTargetLi;
    if(!targetLi && selectedNode){
      targetLi = selectedNode.closest('li');
    }

    let targetUl = null;
    if(!targetLi){
      targetUl = rootUl;
      rootUl.appendChild(li);
    }else{
      const selType = getNodeType(targetLi);
      if(selType === 'folder'){
        let selChildUl = targetLi.querySelector(':scope > ul');
        if(!selChildUl){
          selChildUl = document.createElement('ul');
          targetLi.appendChild(selChildUl);
        }
        targetUl = selChildUl;
        selChildUl.appendChild(li);
      }else if(selType === 'db'){
        const parentUl = targetLi.parentElement;
        targetUl = parentUl || rootUl;
        if(parentUl){
          parentUl.insertBefore(li, targetLi.nextSibling);
        }else{
          rootUl.appendChild(li);
        }
      }else{
        targetUl = rootUl;
        rootUl.appendChild(li);
      }
    }

    if(targetUl){
      sortFolderFirst(targetUl);
    }

    // 한 번 사용 후 초기화
    pendingNewDbTargetLi = null;

    // UI 동기화: 셀렉트/상태칩/badge
    if(typeof ui !== 'undefined' && ui){
      try{
        if(typeof ui.renderConnSelect === 'function'){
          ui.renderConnSelect();
        }else if(typeof ui.syncConnSelect === 'function'){
          ui.syncConnSelect();
        }
        if(typeof ui.updateConnStatusChip === 'function'){
          ui.updateConnStatusChip();
        }
      }catch(e){
        console.warn('addDbNode: ui sync error', e);
      }
    }
    if(typeof tree !== 'undefined' && tree && typeof tree.updateConnBadges === 'function'){
      try{
        tree.updateConnBadges();
      }catch(e){
        console.warn('addDbNode: updateConnBadges error', e);
      }
    }

    // 새 노드를 현재 선택으로
    if(nodeEl){
      setSelected(nodeEl);
    }
  }

  function getSelectionInfo(){
    if(!selectedNode) return null;
    const li = selectedNode.closest('li');
    if(!li) return null;
    const type = getNodeType(li);
    if(!type) return null;
    return { node: selectedNode, li, type };
  }

function setSelectedFromNode(node){
    if(node){
      setSelected(node);
    }else{
      clearSelection();
    }
  }

  return {
    initToolbar,
    initAfterRender,
    addFolder,
    renameFolder,
    deleteFolder,
    setSelectedNode: setSelectedFromNode,
    addDbNode,
    getSelectionInfo,
    copyFolder: copyFolderFromLi,
    pasteFolder: pasteFolderAtLi,
    startFolderLabelEdit,
    startDbLabelEdit
  };
})();;

// ---------------- DB Tree Keyboard Shortcuts ----------------
(function initDbTreeKeyboardShortcuts(){
  if (typeof document === 'undefined') return;

  function getTreeSelectionInfo(){
    // dbFolderUi의 선택 정보를 우선 사용
    try{
      if (typeof dbFolderUi !== 'undefined' &&
          dbFolderUi &&
          typeof dbFolderUi.getSelectionInfo === 'function') {
        const info = dbFolderUi.getSelectionInfo();
        if (info && info.li) {
          const li = info.li;
          const isDb = !!li.dataset.connId;
          const isFolder = (li.dataset.kind === 'folder');
          return {
            node: info.node || li.querySelector(':scope > .node'),
            li,
            isDb,
            isFolder
          };
        }
      }
    }catch(e){
      console.warn('dbTree shortcut getSelectionInfo error', e);
    }

    // fallback: .dbtree-selected 기준
    const selNode = document.querySelector('#dbTree .node.dbtree-selected');
    if (!selNode) return null;
    const li = selNode.closest('li');
    if (!li) return null;
    const isDb = !!li.dataset.connId;
    const isFolder = (li.dataset.kind === 'folder');
    return { node: selNode, li, isDb, isFolder };
  }

  function triggerConnMenuAction(act, info){
    if (!info || !info.isDb) return;
    if (typeof ctxMenu === 'undefined' || !ctxMenu || !ctxMenu.el) return;

    const connLi = info.li.closest('li[data-conn-id]');
    const connId = connLi && connLi.dataset.connId;
    if (!connId) return;

    ctxMenu.targetConn = connId;
    const menuItem = ctxMenu.el.querySelector('li[data-act="' + act + '"]');
    if (menuItem) {
      menuItem.click();
    }
  }

  function triggerFolderRefresh(info){
    if (!info || !info.isFolder) return;
    if (typeof tree === 'undefined' || !tree || typeof tree.buildNodeInfo !== 'function') return;
    if (typeof treeCtxConfig === 'undefined' || typeof handleTreeCtxAction !== 'function') return;

    const nodeInfo = tree.buildNodeInfo(info.li);
    const kind = nodeInfo.kind || info.li.dataset.kind || 'folder';
    const cfg = treeCtxConfig[kind] || treeCtxConfig._default;
    if (!cfg) return;
    const item = (cfg || []).find(x => x.act === 'refresh-node') || null;
    if (!item) return;
    try{
      handleTreeCtxAction('refresh-node', nodeInfo, item);
    }catch(e){
      console.warn('dbTree shortcut refresh-node error', e);
    }
  }

  document.addEventListener('keydown', function(e){
    // 에디터/입력창에서는 기본 동작 유지
    const target = e.target;
    if (target) {
      const tag = target.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || target.isContentEditable) {
        return;
      }
    }

    const key = e.key;
    const ctrl = e.ctrlKey || e.metaKey;
    const alt = e.altKey;
    const shift = e.shiftKey;

    const info = getTreeSelectionInfo();
    // Ctrl+V는 선택이 없어도 루트 기준으로 붙여넣기 허용
    if (!info && !(ctrl && !alt && !shift && (key === 'v' || key === 'V'))) return;

    // 복사: Ctrl + C (DB / 폴더)
    if (ctrl && !alt && !shift && (key === 'c' || key === 'C')) {
      if (info.isDb) {
        triggerConnMenuAction('copy-conn', info);
        e.preventDefault();
        e.stopPropagation();
        return;
      }
      if (info.isFolder &&
          typeof dbFolderUi !== 'undefined' &&
          dbFolderUi &&
          typeof dbFolderUi.copyFolder === 'function') {
        try{
          dbFolderUi.copyFolder(info.li);
        }catch(err){
          console.warn('dbTree shortcut copyFolder error', err);
        }
        e.preventDefault();
        e.stopPropagation();
        return;
      }
    }

    // 붙여넣기: Ctrl + V (클립보드 타입에 따라 폴더/DB 처리)
    if (ctrl && !alt && !shift && (key === 'v' || key === 'V')) {
      if (typeof dbFolderUi !== 'undefined' &&
          dbFolderUi &&
          typeof dbFolderUi.pasteFolder === 'function') {
        try{
          const targetLi = info ? info.li : null; // 선택 없으면 루트 기준으로
          dbFolderUi.pasteFolder(targetLi);
        }catch(err){
          console.warn('dbTree shortcut pasteFolder error', err);
        }
        e.preventDefault();
        e.stopPropagation();
      }
      return;
    }

    // 삭제: Delete
    if (!ctrl && !alt && !shift && key === 'Delete') {
      if (info.isDb) {
        triggerConnMenuAction('delete-conn', info);
        e.preventDefault();
        e.stopPropagation();
        return;
      }
      if (info.isFolder &&
          typeof dbFolderUi !== 'undefined' &&
          dbFolderUi &&
          typeof dbFolderUi.deleteFolder === 'function') {
        try{
          dbFolderUi.deleteFolder();
        }catch(err){
          console.warn('dbTree shortcut deleteFolder error', err);
        }
        e.preventDefault();
        e.stopPropagation();
        return;
      }
    }

    // 이름 변경: F2
    if (!ctrl && !alt && !shift && key === 'F2') {
      if (info.isDb) {
        triggerConnMenuAction('rename-conn', info);
        e.preventDefault();
        e.stopPropagation();
        return;
      }
      if (info.isFolder &&
          typeof dbFolderUi !== 'undefined' &&
          dbFolderUi &&
          typeof dbFolderUi.renameFolder === 'function') {
        try{
          dbFolderUi.renameFolder();
        }catch(err){
          console.warn('dbTree shortcut renameFolder error', err);
        }
        e.preventDefault();
        e.stopPropagation();
        return;
      }
    }

    // 새로고침: Alt + R (브라우저 새로고침과 충돌 피하기 위해 Alt 사용)
    if (!ctrl && alt && !shift && (key === 'r' || key === 'R')) {
      if (info.isDb) {
        triggerConnMenuAction('refresh', info);
        e.preventDefault();
        e.stopPropagation();
        return;
      }
      if (info.isFolder) {
        triggerFolderRefresh(info);
        e.preventDefault();
        e.stopPropagation();
        return;
      }
    }
  });
})();

/* ---------------- Grid (result rendering) ---------------- */
const grid = { render(columns, rows){
  state.lastResult = {
    columns: columns || [],
    rows: rows || [],
    elapsedMs: (state.lastResult ? (state.lastResult.elapsedMs || 0) : 0),
    rowCount: (rows || []).length
  };
  const thead = document.querySelector('#grid thead'); const tbody = document.querySelector('#grid tbody'); thead.innerHTML = ''; tbody.innerHTML = ''; if(!columns || !columns.length){ document.getElementById('messages').textContent = '결과가 없습니다.'; return; } const trh = document.createElement('tr'); columns.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; trh.appendChild(th); }); thead.appendChild(trh); rows.forEach(r=>{ const tr=document.createElement('tr'); columns.forEach(c=>{ const td=document.createElement('td'); td.textContent = (r[c]!==undefined && r[c]!==null)? String(r[c]) : ''; tr.appendChild(td); }); tbody.appendChild(tr); }); } };

// --- Query History Panel ---
const historyPanel = {
  add(entry){
    try{
      if(!state.history){ state.history = []; }
      // 직전 항목과 완전히 동일한 실행인 경우(같은 시각/쿼리/탭/건수/시간)라면 중복으로 쌓지 않는다.
      if(state.history.length){
        const last = state.history[0];
        if(
          last &&
          last.sql === entry.sql &&
          last.connId === entry.connId &&
          last.tabId === entry.tabId &&
          last.rowCount === entry.rowCount &&
          last.elapsedMs === entry.elapsedMs &&
          last.tsLabel === entry.tsLabel
        ){
          console.warn('historyPanel.add: duplicate entry skipped', entry);
          return;
        }
      }
      state.history.unshift(entry);
      if(state.history.length > 200){
        state.history.length = 200;
      }
      // 메인 히스토리 그리드 갱신
      this.render();

      // 우측 최근 쿼리 사이드바: 자동 열기 + 렌더
      const sideEl = document.getElementById('queryHistorySidebar');
      if(typeof queryHistorySidebar !== 'undefined' && queryHistorySidebar){
        if(sideEl && sideEl.classList.contains('show')){
          if(typeof queryHistorySidebar.render === 'function'){
            queryHistorySidebar.render();
          }
        }else{
          if(typeof queryHistorySidebar.open === 'function'){
            queryHistorySidebar.open();
          }
        }

        // 자동 닫기 타이머: 추가 쿼리 실행이 없으면 10초 후 사이드바 닫기
        if(queryHistorySidebar._autoCloseTimer){
          clearTimeout(queryHistorySidebar._autoCloseTimer);
        }
        queryHistorySidebar._autoCloseTimer = setTimeout(function(){
          try{
            const sideElNow = document.getElementById('queryHistorySidebar');
            if(sideElNow && sideElNow.classList.contains('show') &&
               typeof queryHistorySidebar.close === 'function'){
              queryHistorySidebar.close();
            }
          }catch(e){
            console.warn('queryHistorySidebar auto-close error', e);
          }
        }, 10000);
      }
    }catch(e){
      console.warn('historyPanel.add error', e);
    }
  },
  // 최근 쿼리 사이드바와 동일한 규칙으로 SQL 미리보기 한 줄 생성
  _buildSqlPreview(h, maxLen){
    const limit = (typeof maxLen === 'number' && maxLen > 0) ? maxLen : 160;
    let preview = '';
    if(h && h.sql){
      try{
        const lines = h.sql.split(/\r?\n/);
        let candidate = '';
        let startIdx = -1;
        for(let i=0;i<lines.length;i++){
          const t = lines[i].trim();
          if(!t) continue;
          // 전형적인 주석 라인들은 우선 건너뛴다.
          if(t.startsWith('--') || t.startsWith('//') || t.startsWith('/*') || t.startsWith('*') || t.startsWith('*/')){
            continue;
          }
          startIdx = i;
          break;
        }
        if(startIdx >= 0){
          // 첫 유효 라인부터 몇 줄 정도를 묶어서 한 줄로 만든다.
          const slice = lines.slice(startIdx, startIdx + 6);
          candidate = slice.join(' ');
        }else{
          // 전부 주석이거나 비어있으면 전체를 한 줄로 합친다.
          candidate = lines.join(' ');
        }
        let single = candidate.replace(/\s+/g, ' ').trim();
        if(single.length > limit){
          single = single.slice(0, limit - 3) + '...';
        }
        preview = single;
      }catch(e){
        // 실패 시 sqlFirstLine 또는 기존 로직으로 폴백
        if(h && h.sqlFirstLine){
          preview = String(h.sqlFirstLine).replace(/\s+/g, ' ').slice(0, limit);
        }else if(h && h.sql){
          preview = h.sql.split(/\r?\n/)[0].replace(/\s+/g, ' ').slice(0, limit);
        }
      }
    }else if(h && h.sqlFirstLine){
      preview = String(h.sqlFirstLine).replace(/\s+/g, ' ');
      if(preview.length > limit){
        preview = preview.slice(0, limit - 3) + '...';
      }
    }
    return preview;
  },
  render(){
    const tbody = document.querySelector('#historyGrid tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    // 현재 활성 탭의 연결(connId)을 기준으로 히스토리 필터링
    const tabs = state.tabs || [];
    const activeId = state.activeTabId;
    const tab = tabs.find(t=>t.id===activeId) || null;
    const connId = (tab && tab.connId) ? tab.connId : state.connId;

    const all = state.history || [];
    const items = connId ? all.filter(h=>h.connId === connId) : all;

    items.forEach((h, idx)=>{
      const tr = document.createElement('tr');

      // SQL 미리보기 한 줄 (최근 쿼리 사이드바와 동일 규칙)
      const sqlPreview = this._buildSqlPreview(h, 120);

      const cells = [
        h.tsLabel || '',
        h.connLabel || h.connId || '',
        h.tabTitle || '',
        (h.rowCount != null ? String(h.rowCount) : ''),
        (h.elapsedMs != null ? String(h.elapsedMs) : ''),
        sqlPreview || ''
      ];
      cells.forEach((v)=>{
        const td = document.createElement('td');
        td.textContent = v;
        tr.appendChild(td);
      });
      tr.addEventListener('dblclick', ()=>{
        if(h.sql && typeof ui !== 'undefined' && ui && typeof ui.appendSql === 'function'){
          ui.appendSql(h.sql);
        }
        if(h.tabId && state.tabs && state.tabs.find(t=>t.id===h.tabId) && typeof ui !== 'undefined' && ui && typeof ui.switchTab === 'function'){
          ui.switchTab(h.tabId);
        }
      });
      tr.addEventListener('contextmenu', (ev)=>{
        ev.preventDefault();
        try{
          if(typeof historyCtx !== 'undefined' && historyCtx && typeof historyCtx.open === 'function'){
            historyCtx.open(ev.clientX, ev.clientY, {
              source: 'history',
              sql: h.sql || '',
              connId: h.connId || '',
              tabId: h.tabId || '',
              tsLabel: h.tsLabel || ''
            });
          }
        }catch(err){
          console.warn('history row contextmenu error', err);
        }
      });
      tbody.appendChild(tr);
    });

    // 셀렉트박스 동기화 (현재 활성 탭의 연결 기준)
    const sel = document.getElementById('historySelect');
    if(sel){
      sel.innerHTML = '';
      const items2 = items || [];
      const baseOption = document.createElement('option');
      baseOption.value = '';
      baseOption.textContent = items2.length ? `최근 실행 ${items2.length}건` : '최근 실행 내역';
      sel.appendChild(baseOption);
      items2.forEach((h, idx)=>{
        const opt = document.createElement('option');
        opt.value = String(idx);
        const labelParts = [];
        if(h.tsLabel) labelParts.push(h.tsLabel);
        if(h.connLabel || h.connId) labelParts.push(h.connLabel || h.connId);
        const labelSql = this._buildSqlPreview(h, 80);
        if(labelSql) labelParts.push(labelSql);
        opt.textContent = labelParts.join(' | ').slice(0, 120);
        sel.appendChild(opt);
      });

      // 현재 렌더링 기준 데이터/연결 정보를 셀렉트에 보관
      sel._histItems = items2;
      sel._histConnId = connId || null;

      if(!sel._bound){
        sel.addEventListener('change', (e)=>{
          const v = sel.value;
          if(!v) return;
          const idx = parseInt(v, 10);
          const arr = sel._histItems || [];
          const h = arr[idx];
          if(!h) return;
          if(h.sql && typeof ui !== 'undefined' && ui && typeof ui.appendSql === 'function'){
            ui.appendSql(h.sql);
          }
          if(h.tabId && state.tabs && state.tabs.find(t=>t.id===h.tabId) && typeof ui !== 'undefined' && ui && typeof ui.switchTab === 'function'){
            ui.switchTab(h.tabId);
          }
        });
        sel._bound = true;
      }
    }
  },
  toggle(){
    if(bottomTabs){
      bottomTabs.toggle('historyPanel');
    }
  },
  clear(){
    state.history = [];
    const tbody = document.querySelector('#historyGrid tbody');
    if(tbody){ tbody.innerHTML = ''; }
  }
};


// --- Query History Sidebar (현재 DB 기준) ---
const queryHistorySidebar = {
  open(){
    this.render();
    const el = document.getElementById('queryHistorySidebar');
    if(!el) return;
    el.classList.add('show');
    el.classList.remove('hidden');
    el.setAttribute('aria-hidden','false');
  },
  close(){
    const el = document.getElementById('queryHistorySidebar');
    if(!el) return;
    el.classList.remove('show');
    el.classList.add('hidden');
    el.setAttribute('aria-hidden','true');
  },
  toggle(){
    const el = document.getElementById('queryHistorySidebar');
    if(!el) return;
    if(el.classList.contains('show')){
      this.close();
    }else{
      this.open();
    }
  },
  render(){
    const body = document.getElementById('qhSidebarBody');
    const meta = document.getElementById('qhSidebarMeta');
    if(!body) return;
    body.innerHTML = '';
    const tabs = state.tabs || [];
    const activeId = state.activeTabId;
    const tab = tabs.find(t=>t.id===activeId) || null;
    const connId = (tab && tab.connId) ? tab.connId : state.connId;
    const all = state.history || [];
    const items = connId ? all.filter(h=>h.connId === connId) : all;
    const connLabel = (typeof getConnLabel === 'function' && connId)
      ? getConnLabel(connId)
      : (connId || '');

    if(meta){
      if(connId){
        meta.textContent = connLabel ? `연결: ${connLabel}` : `연결 ID: ${connId}`;
      }else{
        meta.textContent = '연결되지 않음';
      }
    }

    if(!items.length){
      const div = document.createElement('div');
      div.className = 'empty';
      div.textContent = connId
        ? '현재 연결 기준 최근 실행 내역이 없습니다.'
        : '연결 정보가 없어 최근 실행 내역을 표시할 수 없습니다.';
      body.appendChild(div);
      return;
    }

    items.slice(0, 30).forEach((h)=>{
      const item = document.createElement('div');
      item.className = 'item';

      const metaLine = document.createElement('div');
      metaLine.className = 'meta';
      const rowInfo = (h.rowCount != null && h.rowCount !== '') ? `${h.rowCount}행` : '';
      const elapsedInfo = (h.elapsedMs != null && h.elapsedMs !== '') ? `${h.elapsedMs}ms` : '';
      const parts = [];
      if(h.tsLabel) parts.push(h.tsLabel);
      if(rowInfo) parts.push(rowInfo);
      if(elapsedInfo) parts.push(elapsedInfo);
      metaLine.textContent = parts.join(' · ');

      
      const sqlLine = document.createElement('div');
      sqlLine.className = 'sql';

      // 미리보기: 주석 라인은 가능하면 건너뛰고, 줄바꿈은 공백으로 합쳐 한 줄로 표시
      let preview = '';
      if(h.sql){
        try{
          const lines = h.sql.split(/\r?\n/);
          let candidate = '';
          let startIdx = -1;
          for(let i=0;i<lines.length;i++){
            const t = lines[i].trim();
            if(!t) continue;
            // 전형적인 주석 라인들은 우선 건너뛴다.
            if(t.startsWith('--') || t.startsWith('//') || t.startsWith('/*') || t.startsWith('*') || t.startsWith('*/')){
              continue;
            }
            startIdx = i;
            break;
          }
          if(startIdx >= 0){
            // 첫 유효 라인부터 몇 줄 정도를 묶어서 한 줄로 만든다.
            const slice = lines.slice(startIdx, startIdx + 6);
            candidate = slice.join(' ');
          }else{
            // 전부 주석이거나 비어있으면 전체를 한 줄로 합친다.
            candidate = lines.join(' ');
          }
          let single = candidate.replace(/\s+/g, ' ').trim();
          if(single.length > 160){
            single = single.slice(0, 157) + '...';
          }
          preview = single;
        }catch(e){
          // 실패 시 sqlFirstLine 또는 기존 로직으로 폴백
          if(h.sqlFirstLine){
            preview = String(h.sqlFirstLine).replace(/\s+/g, ' ').slice(0, 160);
          }else{
            preview = h.sql.split(/\r?\n/)[0].replace(/\s+/g, ' ').slice(0, 160);
          }
        }
      }else if(h.sqlFirstLine){
        preview = String(h.sqlFirstLine).replace(/\s+/g, ' ');
        if(preview.length > 160){
          preview = preview.slice(0, 157) + '...';
        }
      }
      sqlLine.textContent = preview || '';

      item.appendChild(metaLine);
      item.appendChild(sqlLine);

      item.addEventListener('click', ()=>{
        try{
          if(h.sql && typeof ui !== 'undefined' && ui && typeof ui.appendSql === 'function'){
            ui.appendSql(h.sql);
          }
          if(h.tabId && state.tabs && typeof ui !== 'undefined' && ui && typeof ui.switchTab === 'function'){
            const exists = state.tabs.find(t=>t.id===h.tabId);
            if(exists){
              ui.switchTab(h.tabId);
            }
          }
        }catch(err){
          console.warn('queryHistorySidebar item click error', err);
        }
      });
      item.addEventListener('contextmenu', (ev)=>{
        ev.preventDefault();
        try{
          if(typeof historyCtx !== 'undefined' && historyCtx && typeof historyCtx.open === 'function'){
            historyCtx.open(ev.clientX, ev.clientY, {
              source: 'recent',
              sql: h.sql || '',
              connId: h.connId || '',
              tabId: h.tabId || '',
              tsLabel: h.tsLabel || ''
            });
          }
        }catch(err){
          console.warn('queryHistorySidebar item contextmenu error', err);
        }
      });

      body.appendChild(item);
    });
  }
};



const favorites = {
  storageKey: 'dbam_favorites_v1',
  list: [],
  _escapeHtml(str){
    if(str == null) return '';
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
  },
  load(){
    try{
      const raw = localStorage.getItem(this.storageKey);
      if(!raw){
        this.list = [];
        return;
      }
      const arr = JSON.parse(raw);
      this.list = Array.isArray(arr) ? arr : [];
    }catch(e){
      console.warn('favorites.load error', e);
      this.list = [];
    }
    this.render();
  },
  save(){
    try{
      localStorage.setItem(this.storageKey, JSON.stringify(this.list || []));
    }catch(e){
      console.warn('favorites.save error', e);
    }
  },
  addFromSelection(){
    let sql = '';
    // CodeMirror selection 우선 (전역 cm 인스턴스가 있으면 그것부터 사용)
    if (typeof cm !== 'undefined' && cm && typeof cm.getSelection === 'function') {
      sql = cm.getSelection();
    }else if(ui && typeof ui.getEditor === 'function'){
      const full = ui.getEditor() || '';
      const ta = document.getElementById('sqlEditor');
      if(ta && typeof ta.selectionStart === 'number' && typeof ta.selectionEnd === 'number'){
        sql = full.substring(ta.selectionStart, ta.selectionEnd);
      }else{
        sql = full;
      }
    }
    if(!sql || !sql.trim()){
      alert('선택된 SQL이 없습니다.');
      return;
    }
    const defaultName = (sql.split(/\r?\n/)[0] || '').slice(0, 60);
    const name = window.prompt('즐겨찾기 이름을 입력하세요.', defaultName);
    if(!name) return;
    const connId = state.connId || null;
    const now = new Date();
    const item = {
      id: now.getTime(),
      name,
      sql,
      connId,
      createdAt: now.toISOString().replace('T',' ').slice(0,19)
    };
    this.list = this.list || [];
    this.list.unshift(item);
    this.save();
    this.render();
    this.ensureVisible();
  },
  addFromEditor(){
    // 기존: 즉시 localStorage에 저장하던 방식에서,
    // 이제는 즐겨찾기/템플릿 저장 모달을 띄우는 진입점으로 사용
    if(typeof ui !== 'undefined' && ui && typeof ui.openFavSaveModal === 'function'){
      ui.openFavSaveModal();
    }else{
      alert('즐겨찾기 저장 모달 UI를 찾지 못했습니다.');
    }
  },

  addFromModal(payload){
    try{
      const data = payload || {};
      const name = (data.name || '').trim();
      const sql  = (data.sql  || '').trim();
      const description = (data.description || '').trim();
      if(!sql){
        alert('저장할 SQL이 없습니다.');
        return;
      }
      if(!name){
        alert('제목이 비어 있습니다.');
        return;
      }
      const now = new Date();
      const item = {
        id: now.getTime(),
        name: name,
        description: description,
        sql: sql,
        connId: data.connId || null,
        category: data.category || 'ETC',
        biz: data.biz || '',
        tags: data.tags || ''
      };
      this.list = this.list || [];
      this.list.unshift(item);
      this.save();
      this.render();
      this.ensureVisible();
    }catch(e){
      console.warn('favorites.addFromModal error', e);
      alert('개인 즐겨찾기 저장 중 오류가 발생했습니다. 콘솔을 확인하세요.');
    }
  },
  updateFromModal(payload){
    try{
      const data = payload || {};
      const id = data.id;
      if(!id){
        console.warn('favorites.updateFromModal: id 누락');
        return;
      }
      const list = this.list || [];
      const idx = list.findIndex(it => it.id === id);
      if(idx === -1){
        console.warn('favorites.updateFromModal: 대상 항목 없음', id);
        return;
      }
      const name = (data.name || '').trim();
      const sql  = (data.sql  || '').trim();
      const description = (data.description || '').trim();
      if(!sql){
        alert('저장할 SQL이 없습니다.');
        return;
      }
      if(!name){
        alert('제목이 비어 있습니다.');
        return;
      }
      const item = list[idx];
      item.name = name;
      item.description = description;
      item.sql = sql;
      item.connId = data.connId || item.connId || null;
      item.category = data.category || item.category || 'ETC';
      item.biz = data.biz || item.biz || '';
      item.tags = data.tags || item.tags || '';
      this.save();
      this.render();
    }catch(e){
      console.warn('favorites.updateFromModal error', e);
      alert('개인 즐겨찾기 수정 중 오류가 발생했습니다. 콘솔을 확인하세요.');
    }
  },


  remove(id){
    if(!this.list) return;
    this.list = this.list.filter(it => it.id !== id);
    this.save();
    this.render();
  },
  clear(){
    if(!window.confirm('모든 즐겨찾기 쿼리를 삭제할까요?')) return;
    this.list = [];
    this.save();
    this.render();
  },

  _pendingNewTabFavorite: null,
  _applyPendingFavoriteToNewTab(){
    const fav = this._pendingNewTabFavorite;
    this._pendingNewTabFavorite = null;
    if(!fav || !fav.sql) return;
    try{
      if (typeof ui !== 'undefined' && ui && typeof ui.setEditor === 'function') {
        ui.setEditor(fav.sql);
      }
    }catch(e){
      console.warn('favorites._applyPendingFavoriteToNewTab error', e);
    }
  },
  render(){
    const tbody = document.getElementById('favPersonalBody');
    if(!tbody) return;
    tbody.innerHTML = '';
    const items = this.list || [];

    const sysSel = document.getElementById('favPersonalSys');
    const catSel = document.getElementById('favPersonalCat');
    const bizSel = document.getElementById('favPersonalBiz');
    const keywordInput = document.getElementById('favPersonalKeyword');

    const sys = sysSel ? sysSel.value : '';
    const cat = catSel ? catSel.value : '';
    const biz = bizSel ? bizSel.value : '';
    const keyword = (keywordInput && keywordInput.value || '').toLowerCase();

    const filtered = items.filter((f)=>{
      // 시스템 코드는 connId의 prefix로 가정 (예: DEV_DB -> DEV)
      const connLabel = f.connId || '';
      let sysCode = '';
      if(connLabel){
        const parts = String(connLabel).split('_');
        sysCode = (parts[0] || '').toUpperCase();
      }
      const catCode = (f.category || 'ETC');
      const bizCode = (f.biz || '');

      if(sys && sysCode !== sys) return false;
      if(cat && catCode !== cat) return false;
      if(biz && bizCode !== biz) return false;

      if(!keyword) return true;
      const base = ((f.name || '') + ' ' + (f.sql || '')).toLowerCase();
      return base.includes(keyword);
    });

    filtered.forEach((f)=>{
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      const fullSql = f.sql || '';
      const connLabel = f.connId || '';
      let sysCode = '';
      let dbLabel = connLabel || '';
      if(connLabel){
        const parts = String(connLabel).split('_');
        sysCode = (parts[0] || '').toUpperCase();
      }
      const sysLabel = sysCode;
      const catCode = (f.category || 'ETC');
      const catLabel = catCode;
      const bizCode = (f.biz || '');
      let bizLabel = bizCode;
      try{
        if(typeof favTpl !== 'undefined' && favTpl && typeof favTpl.getBizLabel === 'function'){
          bizLabel = favTpl.getBizLabel(bizCode || '') || bizCode;
        }
      }catch(e){
        bizLabel = bizCode;
      }

      const firstLine = (fullSql.split(/\r?\n/)[0] || '').slice(0, 120);
      const descText = (f.description && f.description.trim()) ? f.description : firstLine;

      const td = document.createElement('td');
      td.innerHTML = `
        <div class="favtpl-name">${this._escapeHtml(f.name || '')}</div>
        <div class="favtpl-desc">${this._escapeHtml(descText || '')}</div>
        <div class="favtpl-meta-row">
          ${bizLabel ? `<span class="favtpl-badge biz-${this._escapeHtml(bizCode || '')}">업무: ${this._escapeHtml(bizLabel)}</span>` : ''}
          ${sysLabel ? `<span class="favtpl-badge sys-${this._escapeHtml(sysLabel)}">${this._escapeHtml(sysLabel)}</span>` : ''}
          ${catLabel ? `<span class="favtpl-badge cat-${this._escapeHtml(catCode)}">${this._escapeHtml(catLabel)}</span>` : ''}
          ${dbLabel ? `<span class="favtpl-badge">${this._escapeHtml(dbLabel)}</span>` : ''}
        </div>
      `;
      tr.appendChild(td);

      // 클릭: 우측 미리보기 및 메타만 표시
      tr.addEventListener('click', ()=>{
        try{
          const preview = document.getElementById('favPersonalPreview');
          const metaLeft = document.getElementById('favPersonalMetaLeft');
          const metaRight = document.getElementById('favPersonalMetaRight');
          if(preview){
            preview.value = fullSql;
          }
          if(metaLeft){
            const parts = [];
            if(bizLabel) parts.push(bizLabel);
            if(sysLabel) parts.push(sysLabel);
            if(dbLabel) parts.push(dbLabel);
            if(catLabel) parts.push(catLabel);
            metaLeft.textContent = parts.join(' / ');
          }
          if(metaRight){
            metaRight.textContent = '';
          }
        }catch(err){
          console.warn('favorites click preview error', err);
        }
      });

      // 더블클릭: 현재 활성 에디터에 이어서 붙여넣기
      tr.addEventListener('dblclick', ()=>{
        try{
          if(f.sql && typeof ui !== 'undefined' && ui && typeof ui.setEditor === 'function'){
            const current = (ui.getEditor && ui.getEditor()) || '';
            let nextSql;
            if(!current || !current.trim()){
              // 에디터가 비어 있으면 즐겨찾기 쿼리만 그대로 적용
              nextSql = f.sql;
            }else{
              // 기존 내용이 있으면: 마지막 줄 이후에 빈 줄 + 즐겨찾기 주석 + 즐겨찾기 쿼리
              const trimmed = current.replace(/\s*$/, '');
              nextSql = trimmed + '\n\n-- Favorite: ' + (f.name || '') + '\n' + f.sql;
            }
            ui.setEditor(nextSql);
          }
        }catch(e){
          console.warn('favorites dblclick apply error', e);
        }
      });

      // 우클릭: 컨텍스트 메뉴 (수정/삭제)
      tr.addEventListener('contextmenu', (e)=>{
        e.preventDefault();
        try{
          if(typeof favCtx !== 'undefined' && favCtx && typeof favCtx.open === 'function'){
            favCtx.open(e.pageX, e.pageY, {
              type: 'personal',
              id: f.id,
              name: f.name || ''
            });
          }
        }catch(err){
          console.warn('favorites contextmenu error', err);
        }
      });

      tbody.appendChild(tr);
    });

    if(!filtered.length){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.textContent = '등록된 개인 즐겨찾기 쿼리가 없습니다.';
      td.style.textAlign = 'center';
      td.style.color = '#6b7280';
      td.style.padding = '8px';
      tr.appendChild(td);
      tbody.appendChild(tr);
    }
  },
  toggle(){
    if(!this.list || !this.list.length){
      this.load();
    }else{
      this.render();
    }
    if(bottomTabs){
      bottomTabs.toggle('favPanel');
    }
  },
  ensureVisible(){
    if(bottomTabs){
      bottomTabs.activate('favPanel');
      return;
    }
    const panel = document.getElementById('favPanel');
    if(!panel) return;
    if(getComputedStyle(panel).display === 'none'){
      panel.classList.remove('hidden');
      panel.style.display = 'block';
    }
  }
};
// 초기 로딩 시 즐겨찾기 복원
try{ favorites.load(); }catch(e){ }

// 조직 공용 템플릿 (프로토타입, 서버 연동 전)
const favTpl = {
  currentMode: 'personal',
  orgList: [
    {
      id: 101,
      name: '운영 세션 모니터링',
      description: '현재 접속 세션 및 잠금 상태 확인',
      targetSys: 'PRD',
      targetDbId: 'PRD_MAIN',
      category: 'MONITOR',
      biz: 'PORTAL',
      tags: 'monitor,session,lock',
      sqlText: `SELECT s.sid,
       s.serial#,
       s.username,
       s.machine,
       l.lock_type
  FROM v$session s
  LEFT JOIN v$lock l
    ON s.sid = l.sid;`
    },
    {
      id: 102,
      name: '표준 이력 테이블 INSERT 템플릿',
      description: 'TB_xxx_HIS 표준 INSERT 기본 형식',
      targetSys: 'PRD',
      targetDbId: 'PRD_MAIN',
      category: 'HISTORY',
      biz: 'COMMON',
      tags: 'history,insert,standard',
      sqlText: `INSERT INTO TB_SAMPLE_HIS (
    HIS_ID,
    TARGET_ID,
    COL_BEFORE,
    COL_AFTER,
    REG_DTM,
    REG_ID
) VALUES (
    :HIS_ID,
    :TARGET_ID,
    :COL_BEFORE,
    :COL_AFTER,
    SYSTIMESTAMP,
    :REG_ID
);`
    },
    {
      id: 103,
      name: '배치 검증용 집계 쿼리',
      description: '전일 배치 결과 집계 및 기준 값 비교',
      targetSys: 'STG',
      targetDbId: 'STG_BATCH',
      category: 'BATCH',
      biz: 'MSG',
      tags: 'batch,validate',
      sqlText: `SELECT job_id,
       run_dt,
       status,
       proc_cnt
  FROM tb_batch_result
 WHERE run_dt = TRUNC(SYSDATE-1);`
    }
  ],
  getBizLabel(code){
    switch(code){
      case 'MSG': return '메신저';
      case 'PORTAL': return '포탈';
      case 'COMMON': return '공통';
      case 'ETC': return '기타';
      default: return code || '';
    }
  },
  switchMode(mode){
    this.currentMode = mode;
    const personalBtn = document.getElementById('favtplTabPersonal');
    const orgBtn = document.getElementById('favtplTabOrg');
    const personalWrap = document.getElementById('favPersonalWrap');
    const orgWrap = document.getElementById('favOrgWrap');
    if(personalBtn && orgBtn && personalWrap && orgWrap){
      personalBtn.classList.toggle('active', mode === 'personal');
      orgBtn.classList.toggle('active', mode === 'org');
      personalWrap.classList.toggle('hidden', mode !== 'personal');
      orgWrap.classList.toggle('hidden', mode !== 'org');
    }
  },
  bindEvents(){
    const personalBtn = document.getElementById('favtplTabPersonal');
    const orgBtn = document.getElementById('favtplTabOrg');
    if(personalBtn){
      personalBtn.addEventListener('click', ()=> this.switchMode('personal'));
    }
    if(orgBtn){
      orgBtn.addEventListener('click', ()=> this.switchMode('org'));
    }
    const sysSel = document.getElementById('favOrgSys');
    const catSel = document.getElementById('favOrgCat');
    const bizSel = document.getElementById('favOrgBiz');
    const keywordInput = document.getElementById('favOrgKeyword');
    [sysSel, catSel, bizSel].forEach(el=>{
      if(el){
        el.addEventListener('change', ()=> this.renderOrgList());
      }
    });
    if(keywordInput){
      keywordInput.addEventListener('input', ()=> this.renderOrgList());
    }
  },
  renderOrgList(){
    const tbody = document.getElementById('favOrgBody');
    if(!tbody) return;
    tbody.innerHTML = '';
    const sysSel = document.getElementById('favOrgSys');
    const catSel = document.getElementById('favOrgCat');
    const bizSel = document.getElementById('favOrgBiz');
    const keywordInput = document.getElementById('favOrgKeyword');
    const sys = sysSel ? sysSel.value : '';
    const cat = catSel ? catSel.value : '';
    const biz = bizSel ? bizSel.value : '';
    const keyword = (keywordInput && keywordInput.value || '').toLowerCase();

    const filtered = this.orgList.filter(t=>{
      if(sys && t.targetSys !== sys) return false;
      if(cat && t.category !== cat) return false;
      if(biz && (t.biz || '') !== biz) return false;
      if(!keyword) return true;
      const base = (t.name + ' ' + (t.description||'') + ' ' + (t.tags||'') + ' ' + (t.sqlText||'')).toLowerCase();
      return base.includes(keyword);
    });

    filtered.forEach(t=>{
      const tr = document.createElement('tr');
      tr.addEventListener('click', ()=> this.selectOrg(t));
      tr.addEventListener('dblclick', ()=> this.applyToCurrent(t));
      // 우클릭: 컨텍스트 메뉴 (수정/삭제)
      tr.addEventListener('contextmenu', (e)=>{
        e.preventDefault();
        try{
          if(typeof favCtx !== 'undefined' && favCtx && typeof favCtx.open === 'function'){
            favCtx.open(e.pageX, e.pageY, {
              type: 'org',
              id: t.id,
              name: t.name || ''
            });
          }
        }catch(err){
          console.warn('favTpl renderOrgList contextmenu error', err);
        }
      });
      const td = document.createElement('td');
      td.innerHTML = `
        <div class="favtpl-name">${this.escapeHtml(t.name)}</div>
        <div class="favtpl-desc">${this.escapeHtml(t.description || '')}</div>
        <div class="favtpl-meta-row">
          <span class="favtpl-badge sys-${this.escapeHtml(t.targetSys || 'PRD')}">${this.escapeHtml(t.targetSys || '')}</span>
          <span class="favtpl-badge cat-${this.escapeHtml(t.category || 'ETC')}">${this.escapeHtml(t.category || '')}</span>
          ${t.biz ? `<span class="favtpl-badge biz-${this.escapeHtml(t.biz)}">업무: ${this.escapeHtml(this.getBizLabel(t.biz))}</span>` : ''}
          ${t.targetDbId ? `<span class="favtpl-badge">${this.escapeHtml(t.targetDbId)}</span>` : ''}
        </div>
      `;
      tr.appendChild(td);
      tbody.appendChild(tr);
    });

    if(!filtered.length){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.textContent = '조건에 맞는 조직 공용 템플릿이 없습니다.';
      td.style.textAlign = 'center';
      td.style.color = '#6b7280';
      td.style.padding = '8px';
      tr.appendChild(td);
      tbody.appendChild(tr);
    }
  },
  escapeHtml(str){
    if(str == null) return '';
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
  },
  selectOrg(t){
    const preview = document.getElementById('favOrgPreview');
    const metaLeft = document.getElementById('favOrgMetaLeft');
    const metaRight = document.getElementById('favOrgMetaRight');
    if(preview){
      preview.value = t.sqlText || '';
    }
    if(metaLeft){
      metaLeft.textContent = `${this.getBizLabel(t.biz || '')} / ${t.targetSys || ''} / ${t.targetDbId || ''} / ${t.category || ''}`;
    }
    if(metaRight){
      metaRight.textContent = (t.tags || '').trim() ? `TAG: ${t.tags}` : '';
    }
  },
  applyToCurrent(t){
    const tpl = t || null;
    if(!tpl || !tpl.sqlText) return;
    try{
      if(typeof ui !== 'undefined' && ui && typeof ui.getEditor === 'function' && typeof ui.setEditor === 'function'){
        const current = ui.getEditor() || '';
        let nextSql = '';
        if(!current || !current.trim()){
          nextSql = tpl.sqlText;
        }else{
          const trimmed = current.replace(/\s*$/, '');
          nextSql = trimmed + '\n\n-- Template: ' + (tpl.name || '') + '\n' + tpl.sqlText;
        }
        ui.setEditor(nextSql);
      }
    }catch(e){
      console.warn('favTpl.applyToCurrent error', e);
    }
  },
  openNewTab(t){
    const tpl = t || null;
    if(!tpl || !tpl.sqlText) return;
    try{
      if(typeof ui !== 'undefined' && ui && typeof ui.newEditorTab === 'function' && typeof ui.setEditor === 'function'){
        ui.newEditorTab();
        ui.setEditor(tpl.sqlText);
      }
    }catch(e){
      console.warn('favTpl.openNewTab error', e);
    }
  },

  addOrgTemplateFromModal(payload){
    try{
      const data = payload || {};
      const now = new Date();
      const tpl = {
        id: 'ORG_' + now.getTime(),
        name: data.name || '',
        description: data.description || '',
        targetSys: data.targetSys || '',
        targetDbId: data.targetDbId || '',
        category: data.category || 'ETC',
        biz: data.biz || '',
        tags: data.tags || '',
        sqlText: data.sql || ''
      };
      this.orgList = this.orgList || [];
      this.orgList.unshift(tpl);
      this.renderOrgList();
    }catch(e){
      console.warn('favTpl.addOrgTemplateFromModal error', e);
    }
  },


  updateOrgFromModal(payload){
    try{
      const data = payload || {};
      const id = data.id;
      if(!id){
        console.warn('favTpl.updateOrgFromModal: id 누락');
        return;
      }
      const list = this.orgList || [];
      const idx = list.findIndex(t => t.id === id);
      if(idx === -1){
        console.warn('favTpl.updateOrgFromModal: 대상 항목 없음', id);
        return;
      }
      const name = (data.name || '').trim();
      const sql  = (data.sql  || '').trim();
      const description = (data.description || '').trim();
      if(!sql){
        alert('저장할 SQL이 없습니다.');
        return;
      }
      if(!name){
        alert('제목이 비어 있습니다.');
        return;
      }
      const tpl = list[idx];
      tpl.name = name;
      tpl.description = description;
      tpl.targetSys = data.targetSys || tpl.targetSys || '';
      tpl.targetDbId = data.targetDbId || tpl.targetDbId || '';
      tpl.category = data.category || tpl.category || 'ETC';
      tpl.biz = data.biz || tpl.biz || '';
      tpl.tags = data.tags || tpl.tags || '';
      tpl.sqlText = sql;
      this.renderOrgList();
    }catch(e){
      console.warn('favTpl.updateOrgFromModal error', e);
      alert('조직 공용 템플릿 수정 중 오류가 발생했습니다. 콘솔을 확인하세요.');
    }
  },

  removeOrg(id){
    try{
      const list = this.orgList || [];
      this.orgList = list.filter(t => t.id !== id);
      this.renderOrgList();
    }catch(e){
      console.warn('favTpl.removeOrg error', e);
    }
  },
  init(){
    try{
      this.bindEvents();
      this.switchMode('personal'); // 초기에는 개인 즐겨찾기 탭
      this.renderOrgList();
    }catch(e){
      console.warn('favTpl.init error', e);
    }
  }
};

window.addEventListener('DOMContentLoaded', ()=>{
  try{ favTpl.init(); }catch(e){ console.warn('favTpl.init DOMContentLoaded error', e); }
  try{
    const pSys = document.getElementById('favPersonalSys');
    const pCat = document.getElementById('favPersonalCat');
    const pBiz = document.getElementById('favPersonalBiz');
    const pKeyword = document.getElementById('favPersonalKeyword');
    [pSys, pCat, pBiz].forEach(el=>{
      if(el){
        el.addEventListener('change', ()=> favorites.render());
      }
    });
    if(pKeyword){
      pKeyword.addEventListener('input', ()=> favorites.render());
    }
  }catch(e){
    console.warn('favorites personal filter bind error', e);
  }
  try{
    const favSave = document.getElementById('favSaveBackdrop');
    if(favSave){
      const radios = favSave.querySelectorAll('input[name="favSaveType"]');
      radios.forEach(r=>{
        r.addEventListener('change', ()=> {
          if(typeof ui !== 'undefined' && ui && typeof ui._syncFavSaveTypeUI === 'function'){
            ui._syncFavSaveTypeUI();
          }
        });
      });
    }
  }catch(e){
    console.warn('favSave modal bind error', e);
  }
});


// 현재 접속/쿼리 모니터 (이 콘솔에서 열린 세션만 추적)
const sessionMonitor = {
  sessions: {}, // { connId: { connId, connLabel, profile, user, status, lastSql, lastRiskLevel, lastRiskLabel, lastUpdated, disconnected } }

  _nowIso(){
    try{ return new Date().toISOString(); }catch(e){ return new Date().toString(); }
  },
  _currentUser(){
    return (window.DBAM_CURRENT_USER || '');
  },
  _escape(str){
    return String(str || '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
  },
  _ensure(connId){
    if(!connId) return null;
    if(!this.sessions[connId]){
      this.sessions[connId] = {
        connId,
        connLabel: getConnLabel(connId),
        profile: getConnProfile(connId),
        user: this._currentUser(),
        status: 'idle',
        lastSql: '',
        lastRiskLevel: 'none',
        lastRiskLabel: '',
        lastUpdated: this._nowIso(),
        disconnected: false
      };
    }else{
      const s = this.sessions[connId];
      s.connLabel = getConnLabel(connId);
      s.profile = getConnProfile(connId);
      s.user = this._currentUser();
      s.lastUpdated = this._nowIso();
    }
    return this.sessions[connId];
  },
  onConnect(connId){
    const s = this._ensure(connId); if(!s) return;
    s.status = 'idle';
    s.disconnected = false;
    s.lastUpdated = this._nowIso();
    this.render();
  },
  onDisconnect(connId){
    const s = this.sessions[connId];
    if(!s) return;
    s.status = 'disconnected';
    s.disconnected = true;
    s.lastUpdated = this._nowIso();
    this.render();
  },
  markExecuting(connId, sql){
    const s = this._ensure(connId); if(!s) return;
    s.status = 'running';
    s.lastSql = (sql || '').split(/\r?\n/)[0].slice(0, 120);
    s.lastUpdated = this._nowIso();
    this.render();
  },
  markFinished(connId, info){
    const s = this._ensure(connId); if(!s) return;
    s.status = 'idle';
    if(info && info.lastSql){
      s.lastSql = (info.lastSql || '').split(/\r?\n/)[0].slice(0, 120);
    }
    s.lastUpdated = this._nowIso();
    this.render();
  },
  markRisk(connId, risk){
    const s = this._ensure(connId); if(!s) return;
    const level = risk && risk.level ? risk.level : 'warn';
    s.lastRiskLevel = (level === 'warn' || level === 'danger') ? level : 'none';
    if(risk && Array.isArray(risk.reasons) && risk.reasons.length){
      s.lastRiskLabel = risk.reasons[0];
    }else if(level === 'warn'){
      s.lastRiskLabel = '주의가 필요한 쿼리로 감지되었습니다.';
    }else if(level === 'danger'){
      s.lastRiskLabel = '고위험 쿼리로 감지되었습니다.';
    }else{
      s.lastRiskLabel = '';
    }
    s.lastUpdated = this._nowIso();
    this.render();

    if((level === 'warn' || level === 'danger') && typeof window.DBAM_ON_RISK_SESSION === 'function'){
      try{
        window.DBAM_ON_RISK_SESSION({
          connId,
          connLabel: s.connLabel,
          profile: s.profile,
          user: s.user,
          riskLevel: s.lastRiskLevel,
          riskReasons: (risk && risk.reasons) ? risk.reasons.slice() : [],
          lastSql: s.lastSql,
          lastUpdated: s.lastUpdated
        });
      }catch(e){
        console.warn('DBAM_ON_RISK_SESSION handler error', e);
      }
    }
  },
  clearClosed(){
    Object.keys(this.sessions).forEach(id=>{
      const s = this.sessions[id];
      if(s && s.disconnected){
        delete this.sessions[id];
      }
    });
    this.render();
  },
  refresh(){
    this.render();
  },
  render(){
    const tbody = document.querySelector('#sessionGrid tbody');
    if(!tbody) return;
    tbody.innerHTML = '';
    const list = Object.values(this.sessions || {});
    list.sort((a,b)=>{
      if(a.status === 'running' && b.status !== 'running') return -1;
      if(a.status !== 'running' && b.status === 'running') return 1;
      return (b.lastUpdated || '').localeCompare(a.lastUpdated || '');
    });
    list.forEach(s=>{
      const tr = document.createElement('tr');

      const statusLabel = (function(){
        if(s.status === 'running') return '<span><i class="fa-solid fa-circle-play"></i> 실행 중</span>';
        if(s.status === 'disconnected') return '<span><i class="fa-regular fa-circle-xmark"></i> 종료</span>';
        return '<span><i class="fa-regular fa-circle"></i> 대기</span>';
      })();

      const riskIcon = (function(){
        if(s.lastRiskLevel === 'danger') return '<span title="위험 쿼리"><i class="fa-solid fa-fire"></i> 위험</span>';
        if(s.lastRiskLevel === 'warn') return '<span title="주의 쿼리"><i class="fa-solid fa-triangle-exclamation"></i> 주의</span>';
        return '<span><i class="fa-regular fa-circle-check"></i> 정상</span>';
      })();

      const user = s.user || (window.DBAM_CURRENT_USER || '');
      const conn = s.connLabel || s.connId || '';
      const profile = s.profile || '-';
      const lastSql = s.lastSql || '';
      const updated = (s.lastUpdated || '').replace('T',' ').replace(/\..*$/,'');

      const cols = [
        this._escape(user),
        this._escape(conn),
        this._escape(profile),
        statusLabel,
        riskIcon,
        this._escape(lastSql),
        this._escape(updated)
      ];
      cols.forEach((val, idx)=>{
        const td = document.createElement('td');
        if(idx === 0 || idx === 1 || idx === 2 || idx === 5 || idx === 6){
          td.textContent = val;
        }else{
          td.innerHTML = val;
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }
};

// 쿼리 스냅샷 공유 (경량 버전)
const snapshots = {
  _lastSnapshot: null,

  createFromCurrentTab(){
    try{
      const tab = state.tabs && state.tabs.find(t=>t.id===state.activeTabId);
      if(!tab){
        alert('활성 탭이 없습니다.');
        return;
      }
      const sql = (typeof cm!=='undefined' && cm && typeof cm.getValue==='function')
        ? cm.getValue()
        : (ui && typeof ui.getEditor==='function' ? ui.getEditor() : '');
      if(!sql || !sql.trim()){
        alert('저장할 SQL이 없습니다.');
        return;
      }
      const connId = tab.connId || state.connId || null;
      const accessInfo = (state.connAccessInfo && connId) ? (state.connAccessInfo[connId] || {}) : {};
      const user = window.DBAM_CURRENT_USER || '';
      const now = new Date();
      const id = 'QS-' + now.toISOString().replace(/[-:.TZ]/g,'').slice(0,14)
        + '-' + Math.random().toString(36).slice(2,8).toUpperCase();

      const snap = {
        id,
        createdAt: now.toISOString().replace('T',' ').slice(0,19),
        user,
        connId,
        connLabel: connId ? getConnLabel(connId) : '',
        profile: connId ? getConnProfile(connId) : null,
        tabId: tab.id,
        tabTitle: tab.title || '',
        sql,
        accessReason: accessInfo.reason   || '',
        ticketId:     accessInfo.ticketId || '',
        source: (location && location.href) ? location.href.split('#')[0] : ''
      };
      this._lastSnapshot = snap;
      const json = JSON.stringify(snap);
      this.openExportModal(id, json);
    }catch(e){
      console.error('snapshot.createFromCurrentTab error', e);
      alert('스냅샷 생성 중 오류가 발생했습니다.');
    }
  },

  openExportModal(id, json){
    const backdrop = document.getElementById('snapshotBackdrop');
    const idEl = document.getElementById('snapshotId');
    const jsonEl = document.getElementById('snapshotJson');
    if(!backdrop || !idEl || !jsonEl){
      alert('스냅샷 정보를 표시할 수 없습니다(요소 누락).');
      return;
    }
    idEl.value = id || '';
    jsonEl.value = json || '';
    backdrop.classList.add('show');
    backdrop.setAttribute('aria-hidden','false');
    // JSON 전체 선택
    jsonEl.scrollTop = 0;
    jsonEl.focus();
    jsonEl.select();
  },

  closeModal(){
    const backdrop = document.getElementById('snapshotBackdrop');
    if(backdrop){
      backdrop.classList.remove('show');
      backdrop.setAttribute('aria-hidden','true');
    }
  },

  copyJson(){
    const jsonEl = document.getElementById('snapshotJson');
    if(!jsonEl) return;
    jsonEl.focus();
    jsonEl.select();
    try{
      const ok = document.execCommand('copy');
      if(ok){
        alert('스냅샷 JSON을 클립보드에 복사했습니다.');
      }else{
        alert('복사에 실패했습니다. 직접 선택 후 복사하세요.');
      }
    }catch(e){
      alert('복사에 실패했습니다. 직접 선택 후 복사하세요.');
    }
  },

  importFromPrompt(){
    const raw = window.prompt('공유받은 스냅샷 JSON을 붙여넣으세요.');
    if(!raw) return;
    let snap = null;
    try{
      snap = JSON.parse(raw);
    }catch(e){
      alert('JSON 형식이 올바르지 않습니다.');
      return;
    }
    this.applyToNewTab(snap);
  },

  applyToNewTab(snap){
    if(!snap || !snap.sql){
      alert('스냅샷에 SQL 정보가 없습니다.');
      return;
    }
    // 새 탭을 만들고 그 위에 스냅샷 상태를 입힌다.
    ui.newEditorTab();
    const tab = state.tabs && state.tabs.find(t=>t.id===state.activeTabId);
    if(!tab) return;
    if(snap.tabTitle){
      tab.title = snap.tabTitle;
    }else if(snap.id){
      tab.title = 'Snap ' + snap.id;
    }
    if(snap.connId){
      tab.connId = snap.connId;
    }
    ui.renderTabs();
    if(snap.connId){
      ui.onConnSelectChange(snap.connId);
    }
    ui.setEditor(snap.sql);
    const msgEl = document.getElementById('messages');
    if(msgEl){
      msgEl.textContent = '스냅샷에서 불러온 쿼리입니다. ID: ' + (snap.id || '');
    }
  }
};


// Result grid context menu binding
const gridEl = document.getElementById('grid');
if(gridEl){
  gridEl.addEventListener('contextmenu', (e)=>{
    e.preventDefault();
    resultCtx.open(e.clientX, e.clientY);
  });
}

/* ---------------- Bottom Tabs Controller ---------------- */
const bottomTabs = {
  area: null,
  buttons: [],
  panels: ['result','ddlPanel','historyPanel','approvalPanel','favPanel','sessionPanel','serverPanel'],
  activePanel: 'result',
  visible: false,
  init(){
    this.area = document.getElementById('bottomArea');
    this.buttons = Array.from(document.querySelectorAll('.bottom-tabs .bottom-tab'));
    this.buttons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const panelId = btn.dataset.panel;
        this.activate(panelId);
      });
    });
  },
  showArea(){
    if(!this.area) return;
    this.area.style.display = 'flex';
    this.visible = true;
  },
  hideArea(){
    if(!this.area) return;
    this.area.style.display = 'none';
    this.visible = false;
  },
  activate(panelId){
    if(!panelId) panelId = this.activePanel || 'result';
    this.showArea();
    this.activePanel = panelId;
    // 버튼 상태
    this.buttons.forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.panel === panelId);
    });
    // 패널 표시
    this.panels.forEach(id=>{
      const panel = document.getElementById(id);
      if(!panel) return;
      if(id === panelId){
        panel.classList.remove('hidden');
        panel.style.display = 'flex';
      }else{
        panel.style.display = 'none';
      }
    });
  },
  toggle(panelId){
    if(this.visible && (!panelId || this.activePanel === panelId)){
      this.hideArea();
    }else{
      this.activate(panelId || this.activePanel || 'result');
    }
  }
};


// DBeaver 스타일 테이블 편집 모달 컨트롤러
const tableEditor = {
  current: null,

  open(info) {
    const backdrop = document.getElementById('tableEditBackdrop');
    if (!backdrop) {
      alert('테이블 편집 모달 DOM을 찾지 못했습니다.');
      return;
    }

    this.current = info || null;

    const schema = info && info.schema ? info.schema : '';
    const table  = info && info.table  ? info.table  : '';
    const connId = info && info.connId ? info.connId : '';

    const fullName = (schema ? schema + '.' : '') + table;

    const titleEl = document.getElementById('teTableTitle');
    const metaEl  = document.getElementById('teTableMeta');

    if (titleEl) {
      titleEl.textContent = fullName || '(테이블 미선택)';
    }

    if (metaEl) {
      const parts = [];
      if (connId) {
        const label = (typeof getConnLabel === 'function')
          ? (getConnLabel(connId) || connId)
          : connId;
        parts.push('연결: ' + label);
      }
      if (schema) parts.push('스키마: ' + schema);
      if (table)  parts.push('테이블: ' + table);
      metaEl.textContent = parts.join('  |  ');
    }

    // 기본 탭 상태
    this.activateMainTab('props');
    this.activateSubTab('columns');

    // 내용 채우기
    this.renderColumns();
    this.renderDdl();

    // 모달 표시
    backdrop.classList.remove('hidden');
    backdrop.classList.add('show');
    backdrop.setAttribute('aria-hidden', 'false');
  },

  close() {
    const backdrop = document.getElementById('tableEditBackdrop');
    if (!backdrop) return;
    backdrop.classList.remove('show');
    backdrop.classList.add('hidden');
    backdrop.setAttribute('aria-hidden', 'true');
  },

  activateMainTab(name) {
    const root = document.getElementById('tableEditBackdrop');
    if (!root) return;

    const buttons = root.querySelectorAll('.te-tab-btn');
    buttons.forEach(btn => {
      const key = btn.getAttribute('data-main-tab');
      if (key === name) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });

    const panes = root.querySelectorAll('.te-pane');
    panes.forEach(pane => {
      const key = pane.getAttribute('data-main-pane');
      if (key === name) {
        pane.classList.add('active');
      } else {
        pane.classList.remove('active');
      }
    });
  },

  activateSubTab(name) {
    const root = document.getElementById('tableEditBackdrop');
    if (!root) return;

    const buttons = root.querySelectorAll('.te-subtab-btn');
    buttons.forEach(btn => {
      const key = btn.getAttribute('data-sub-tab');
      if (key === name) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });

    const panes = root.querySelectorAll('.te-subpane');
    panes.forEach(pane => {
      const key = pane.getAttribute('data-sub-pane');
      if (key === name) {
        pane.classList.add('active');
      } else {
        pane.classList.remove('active');
      }
    });
  },

  // SQL Hint 테이블(window.dbamSqlTables)에 있는 컬럼 정보로 Columns 탭 채우기
  renderColumns() {
    const info = this.current;
    const root = document.getElementById('tableEditBackdrop');
    if (!root) return;

    const tbody = root.querySelector('#teColumnsGrid tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!info || !info.table) {
      return;
    }

    let cols = [];
    try {
      const map = window.dbamSqlTables || {};
      if (map && Array.isArray(map[info.table])) {
        cols = map[info.table];
      }
    } catch (e) {
      cols = [];
    }

    if (!cols.length) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 6;
      td.textContent = '컬럼 메타데이터가 아직 준비되지 않았습니다. (SQL 힌트 테이블과 연동 예정)';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    cols.forEach((c, idx) => {
      const tr = document.createElement('tr');
      const cells = [
        String(idx + 1),
        c.name || '',
        c.type || '',
        c.nullable != null ? String(c.nullable) : '',
        c.defaultValue != null ? String(c.defaultValue) : '',
        c.comment || c.label || ''
      ];
      cells.forEach(val => {
        const td = document.createElement('td');
        td.textContent = val;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  },

  // DDL 탭: 아직 실제 DDL 조회는 없고, 기본 골격만
  renderDdl() {
    const info  = this.current;
    const ddlEl = document.getElementById('teDdlText');
    if (!ddlEl) return;

    if (!info || !info.table) {
      ddlEl.textContent = '';
      return;
    }

    const schema   = info.schema || '';
    const table    = info.table  || '';
    const fullName = (schema ? '"' + schema + '".' : '') + '"' + table + '"';

    const lines = [];
    lines.push('-- TODO: DB 메타데이터 연동 후 실제 DDL로 대체 예정');
    lines.push('CREATE TABLE ' + fullName + ' (');
    lines.push('    -- columns ...');
    lines.push(');');

    ddlEl.textContent = lines.join('\n');
  }
};

/* ---------------- SQL Split Helpers ---------------- */
const sqlSplit = {
  // Convert CodeMirror {line,ch} to absolute offset
  offsetFromPos(cm, pos){
    const doc = cm.getDoc();
    let off = 0;
    for(let i=0;i<pos.line;i++){ off += doc.getLine(i).length + 1; } // +1 for '\n'
    return off + pos.ch;
  },
  // Convert absolute offset back to {line,ch}
  posFromOffset(cm, offset){
    const doc = cm.getDoc();
    let acc = 0;
    for(let i=0;i<doc.lineCount();i++){
      const len = doc.getLine(i).length + 1;
      if(acc + len > offset){
        return { line: i, ch: offset - acc };
      }
      acc += len;
    }
    const last = doc.lineCount()-1;
    return { line: last, ch: doc.getLine(last).length };
  },
  // Split SQL by semicolons ignoring those inside ' " /* */ -- and $...$ (PostgreSQL)
  splitStatements(sql){
    const parts = [];
    let start = 0;
    let i = 0;
    const n = sql.length;
    let inS=false,inD=false,inLC=false,inBC=false,inDollar=null;
    while(i<n){
      const c = sql[i];
      const c2 = i+1<n? sql[i+1]: '';
      // end of line-comment
      if(inLC){
        if(c === '\n'){ inLC=false; }
        i++; continue;
      }
      // end of block-comment
      if(inBC){
        if(c==='*' && c2=== '/'){ inBC=false; i+=2; continue; }
        i++; continue;
      }
      // dollar-quote
      if(inDollar){
        if(c === '$'){
          const tag = inDollar;
          if(sql.substr(i, tag.length) === tag){
            inDollar = null;
            i += tag.length;
            continue;
          }
        }
        i++; continue;
      }
      // strings
      if(inS){ if(c==="'" && sql[i-1] !== '\\\\'){ inS=false; } i++; continue; }
      if(inD){ if(c==='"' && sql[i-1] !== '\\\\'){ inD=false; } i++; continue; }
      // comment starts
      if(c==='-' && c2==='-'){ inLC=true; i+=2; continue; }
      if(c==='/' && c2==='*'){ inBC=true; i+=2; continue; }
      // string starts
      if(c==="'"){ inS=true; i++; continue; }
      if(c==='"'){ inD=true; i++; continue; }
      // dollar-quote start $tag$
      if(c==='$'){
        const m = sql.slice(i).match(/^\$[A-Za-z_]*\$/);
        if(m){ inDollar = m[0]; i += inDollar.length; continue; }
      }
      // split point
      if(c === ';'){
        const stmt = sql.slice(start, i).trim();
        if(stmt.length){ parts.push({ text: stmt, start, end: i+1 }); }
        start = i+1;
      }
      i++;
    }
    const tail = sql.slice(start).trim();
    if(tail.length){ parts.push({ text: tail, start: n }); }
    return parts;
  },
  // Get selected SQL or current statement under cursor
  selectedOrCurrent(cm){
    const doc = cm.getDoc();
    const sel = doc.getSelection();
    const full = doc.getValue();
    if(sel && sel.trim().length){ return { sql: sel, range: doc.listSelections()[0] }; }
    const cursor = doc.getCursor();
    const curOff = sqlSplit.offsetFromPos(cm, cursor);
    const stmts = sqlSplit.splitStatements(full);
    let pick = null;
    for(const s of stmts){
      if(curOff >= s.start && curOff <= s.end){ pick = s; break; }
    }
    if(!pick && stmts.length){ pick = stmts[stmts.length-1]; }
    const from = sqlSplit.posFromOffset(cm, pick.start);
    const to   = sqlSplit.posFromOffset(cm, pick.end);
    return { sql: pick.text, range: { anchor: from, head: to } };
  },
  // All statements in the editor
  all(cm){
    const doc = cm.getDoc();
    const all = doc.getValue();
    return sqlSplit.splitStatements(all);
  }
};


/* ---------------- Security: 위험 쿼리 감지 & 2단계 확인 ---------------- */

const SENSITIVE_TABLES = [
  // 운영 환경에서는 실제 개인정보/중요 테이블명을 여기에 등록
  'TB_CUST',
  'TB_CUSTOMER',
  'TB_MEMBER',
  'TB_USER'
];

// DROP/TRUNCATE/ALTER TABLE 등을 허용할 프로필 (예: DBA/OPS)
const SEC_DDL_ALLOWED_PROFILES = ['DBA', 'OPS'];

function getConnProfile(connId){
  return (state.connProfiles && connId) ? (state.connProfiles[connId] || null) : null;
}

function isDdlAllowedForConn(connId){
  const p = getConnProfile(connId);
  return !!(p && SEC_DDL_ALLOWED_PROFILES.includes(p));
}

const security = {
  analyzeSqlForRisk(sqlRaw, connId){
    const text = (sqlRaw || '').trim();
    if(!text){ return { level: 'none', reasons: [] }; }

    // 주석 제거 (/* */ 블록 + -- 한 줄 주석) 후 첫 번째 문장만 기준으로 간단 분석
    const noBlock = text.replace(/\/\*[\s\S]*?\*\//g, ' ');
    const noLine  = noBlock.replace(/--.*$/gm, ' ');
    const upper   = noLine.toUpperCase();
    const firstStmt = upper.split(';')[0];
    const simple  = firstStmt.replace(/\s+/g, ' ').trim();

    let level = 'none';
    const reasons = [];

    // 1) DROP / TRUNCATE / ALTER TABLE
    if(/\b(DROP|TRUNCATE)\s+TABLE\b/.test(simple) || /\bALTER\s+TABLE\b/.test(simple)){
      const allowed = isDdlAllowedForConn(connId);
      reasons.push('DROP/TRUNCATE/ALTER TABLE 문장입니다.' + (allowed ? ' (DBA/OPS 프로필에서만 허용됩니다.)' : ' 관리자 또는 별도 모드에서만 허용해야 합니다.'));
      if(!allowed){
        level = 'block';
      }else if(level === 'none'){
        // DBA/OPS의 경우 경고만 띄우고 확인 후 진행
        level = 'warn';
      }
    }

    // 2) UPDATE / DELETE 이면서 WHERE 없음 → 경고 후 진행 여부 선택
    if(/^UPDATE\b/.test(simple) || /^DELETE\b/.test(simple)){
      if(!/\bWHERE\b/.test(simple)){
        reasons.push('UPDATE/DELETE 문에 WHERE 절이 없습니다.');
        if(level === 'none'){
          level = 'warn';
        }
      }
    }

    // 3) 개인정보 테이블에 대한 SELECT * → 승인 요청 대상 ()
    const m = simple.match(/^SELECT\s+\*\s+FROM\s+([A-Z0-9_\.]+)/);
    if(m){
      const fullName = m[1];
      const baseName = fullName.split('.').pop();
      if(SENSITIVE_TABLES.includes(baseName)){
        reasons.push(`개인정보 테이블(${baseName})에 대한 SELECT * 입니다. 승인 절차가 필요합니다.`);
        if(level === 'none' || level === 'warn'){
          level = 'approval';
        }
      }
    }

    return { level, reasons };
  },

  /**
   * 단일 실행(runCurrent) 전에 위험도 확인.
   * true  → 그대로 실행 계속
   * false → 실행 중단
   */
  beforeExecuteSingle(sql, connId){
    const risk = this.analyzeSqlForRisk(sql, connId);
    if(!risk || risk.level === 'none'){ return true; }

    const msg = (risk.reasons && risk.reasons.length)
      ? risk.reasons.join('\n')
      : '위험도가 높은 SQL로 감지되었습니다.';

    if(risk.level === 'block'){
      alert(msg + '\n\n보안 정책에 따라 이 쿼리는 UI에서 실행할 수 없습니다.');
      return false;
    }

    if(risk.level === 'approval'){
      if(typeof approvalCenter !== 'undefined' && approvalCenter.beginRequest){
        try{
          approvalCenter.beginRequest({ sql, connId, risk });
        }catch(e){
          console.warn('approvalCenter.beginRequest error', e);
          alert(msg + '\n\n승인 요청 처리 중 오류가 발생했습니다. 관리자에게 문의하세요.');
        }
      }else{
        alert(msg + '\n\n(승인 워크플로가 아직 연결되지 않아 실행이 취소됩니다.)');
      }
      return false;
    }

    if(risk.level === 'warn'){
      const ok = confirm(msg + '\n\n계속 실행하시겠습니까?');
      if(ok && typeof sessionMonitor!=='undefined' && sessionMonitor.markRisk){
        sessionMonitor.markRisk(connId, risk);
      }
      return !!ok;
    }

    if(risk.level === 'otp'){
      const code = prompt(
        msg + '\n\n2단계 확인(OTP/비밀번호 등)을 입력하세요.\n' +
        '( 모드에서는 값만 입력하면 값이 비어있지만 않으면 통과합니다.)'
      );
      if(!code){
        alert('2단계 확인이 취소되어 쿼리를 실행하지 않습니다.');
        return false;
      }
      // 실제 환경에서는 여기에서 서버 쪽 검증 추가 필요
      if(typeof sessionMonitor!=='undefined' && sessionMonitor.markRisk){
        sessionMonitor.markRisk(connId, risk);
      }
      return true;
    }

    return true;
  }
}
/* ---------------- Excel Export Policy (엑셀 내보내기 정책 1단계) ---------------- */
const excelPolicy = {
  // 민감/중요 데이터가 들어있는 테이블명 목록 (대문자 기준 매칭 권장)
  // 예: 'TB_CUST', 'TB_ACCOUNT', ...
  sensitiveTables: [
    // 'TB_CUST',
    // 'TB_ACCOUNT',
    // 'TB_EMPLOYEE'
  ],

  // 컬럼명 기준으로 민감 데이터를 판별할 때 사용할 키워드 목록
  // 예: 주민번호, 계좌번호, 카드번호, 연락처 등
  sensitiveColumns: [
    // 'RRN',          // 주민등록번호
    // 'JUMIN_NO',
    // 'RESIDENT_NO',
    // 'ACCOUNT_NO',   // 계좌번호
    // 'CARD_NO',
    // 'PHONE_NO',
    // 'MOBILE_NO',
    // 'TEL_NO',
    // 'EMAIL'
  ],

  // 승인 없이 엑셀로 내보내기를 허용할 최대 건수 (비민감 데이터 기준)
  // 이 값을 초과하면 최소 경고 또는 승인 요청 대상으로 판단
  maxRowsWithoutApproval: 5000,

  // 사용자별 일일 누적 다운로드 허용 건수(행 기준)
  // 운영 환경/업무 특성에 맞게 추후 조정 가능
  dailyRowLimitPerUser: 20000
};


/* ---------------- Excel Result Meta (엑셀 쿼리 결과 메타 정보 2단계) ---------------- */
/**
 * currentResultMeta
 * - 마지막으로 실행된 쿼리/그리드 결과에 대한 메타 정보
 * - 이후 엑셀 내보내기 위험도 평가(evaluateExcelRisk) 등에 사용될 예정
 */
let currentResultMeta = null;

/**
 * resultMeta 객체를 생성하는 헬퍼.
 * options: {
 *   queryId, sql, rowCount, tableNames, columnNames,
 *   hasSensitiveTable, hasSensitiveColumn, userId, executedAt
 * }
 */
function createResultMeta(options){
  const now = options && options.executedAt ? new Date(options.executedAt) : new Date();

  return {
    queryId: options && options.queryId != null ? options.queryId : null,
    sql: options && options.sql ? String(options.sql) : '',
    rowCount: options && typeof options.rowCount === 'number' ? options.rowCount : 0,
    tableNames: options && Array.isArray(options.tableNames) ? options.tableNames.slice() : [],
    columnNames: options && Array.isArray(options.columnNames) ? options.columnNames.slice() : [],
    hasSensitiveTable: !!(options && options.hasSensitiveTable),
    hasSensitiveColumn: !!(options && options.hasSensitiveColumn),
    userId: options && options.userId ? String(options.userId) : null,
    executedAt: now
  };
}

/**
 * 쿼리 실행 결과 정보(execInfo)를 기반으로 currentResultMeta를 갱신한다.
 * execInfo: {
 *   queryId, sql, rowCount, tableNames, columnNames, userId, executedAt
 * }
 *
 * - tableNames / columnNames는 대문자로 변환 후 excelPolicy의 기준과 비교
 * - 실제 쿼리 실행 시점에서 이 함수를 호출해 currentResultMeta를 최신 상태로 유지
 */
function setCurrentResultMetaFromExecution(execInfo){
  execInfo = execInfo || {};

  const sql = execInfo.sql || '';
  const rowCount = typeof execInfo.rowCount === 'number' ? execInfo.rowCount : 0;
  const tableNames = Array.isArray(execInfo.tableNames) ? execInfo.tableNames : [];
  const columnNames = Array.isArray(execInfo.columnNames) ? execInfo.columnNames : [];

  const upperTables = tableNames.map(n => String(n || '').toUpperCase());
  const upperCols = columnNames.map(n => String(n || '').toUpperCase());

  const hasSensitiveTable = upperTables.some(n => excelPolicy.sensitiveTables.includes(n));
  const hasSensitiveColumn = upperCols.some(n => excelPolicy.sensitiveColumns.includes(n));

  currentResultMeta = createResultMeta({
    queryId: execInfo.queryId || null,
    sql,
    rowCount,
    tableNames,
    columnNames,
    hasSensitiveTable,
    hasSensitiveColumn,
    userId: execInfo.userId || null,
    executedAt: execInfo.executedAt || new Date()
  });
}

/**
 * currentResultMeta를 초기화
 */
function clearCurrentResultMeta(){
  currentResultMeta = null;
}

/**
 * 현재 설정된 resultMeta를 반환 (없으면 null)
 */
function getCurrentResultMeta(){
  return currentResultMeta;
}

/* ---------------- Excel Risk Evaluation (엑셀 내보내기 위험도 평가 3단계) ---------------- */
/**
 * 사용자별 일일 누적 다운로드 건수를 조회하는 헬퍼.
 * - 현재 단계에서는 항상 0을 반환 (8단계에서 실제 구현 예정)
 */
function getDailyDownloadRows(userId, tableNames){
  // 간단한  구현:
  // - 오늘 날짜 기준으로, 동일 사용자에 대해 실제 다운로드가 수행된 행(rowCount)의 합계를 반환
  // - 실제 운영에서는 서버측 로그/통계 쿼리로 대체 가능
  if(!userId){
    return 0;
  }

  // 오늘(로컬 기준) YYYY-MM-DD 키 생성
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, '0');
  const d = String(now.getDate()).padStart(2, '0');
  const todayKey = y + '-' + m + '-' + d;

  // 비교용 테이블명(대문자) 목록
  const targetTables = Array.isArray(tableNames)
    ? tableNames.map(n => String(n || '').toUpperCase())
    : null;

  let sum = 0;

  try{
    if(Array.isArray(excelExportLogs)){
      for(const log of excelExportLogs){
        if(!log) continue;
        if(log.userId !== userId) continue;

        // 날짜 비교 (로컬 기준)
        const ts = new Date(log.timestamp);
        if(!ts || isNaN(ts.getTime())) continue;
        const ly = ts.getFullYear();
        const lm = String(ts.getMonth() + 1).padStart(2, '0');
        const ld = String(ts.getDate()).padStart(2, '0');
        const logKey = ly + '-' + lm + '-' + ld;
        if(logKey !== todayKey) continue;

        // 실제 다운로드가 수행된 로그만 집계
        const mode = log.mode || 'DIRECT';
        const approved = !!log.approved;
        // DIRECT 모드는 항상 다운로드 수행,
        // APPROVAL 모드는 approved=true인 경우에만 다운로드로 간주
        if(!(mode === 'DIRECT' || (mode === 'APPROVAL' && approved))){
          continue;
        }

        // 테이블명 필터: targetTables가 있으면 교집합이 있을 때만 집계
        if(targetTables && targetTables.length){
          const logTables = Array.isArray(log.tableNames)
            ? log.tableNames.map(n => String(n || '').toUpperCase())
            : [];
          const hasIntersection = logTables.some(t => targetTables.includes(t));
          if(!hasIntersection){
            continue;
          }
        }

        const rows = typeof log.rowCount === 'number' ? log.rowCount : 0;
        if(rows > 0){
          sum += rows;
        }
      }
    }
  }catch(e){
    console.warn('getDailyDownloadRows failed', e);
  }

  return sum;
}

/**
 * resultMeta를 기반으로 엑셀 내보내기 위험도를 평가한다.
 * meta: createResultMeta / setCurrentResultMetaFromExecution으로 생성된 객체
 * 반환: { level: 'LOW' | 'MID' | 'HIGH', reasons: string[] }
 */
function evaluateExcelRisk(meta){
  meta = meta || {};
  const levelConst = { LOW: 'LOW', MID: 'MID', HIGH: 'HIGH' };
  let level = levelConst.LOW;
  const reasons = [];

  const rowCount = typeof meta.rowCount === 'number' ? meta.rowCount : 0;
  const hasSensitiveTable = !!meta.hasSensitiveTable;
  const hasSensitiveColumn = !!meta.hasSensitiveColumn;
  const userId = meta.userId || null;
  const tableNames = Array.isArray(meta.tableNames) ? meta.tableNames : [];

  // 1) 민감 데이터 포함 여부 (테이블/컬럼)
  if(hasSensitiveTable || hasSensitiveColumn){
    level = levelConst.HIGH;
    reasons.push('민감 데이터(테이블/컬럼) 포함');
  }

  // 2) 단일 다운로드 건수 기준
  if(rowCount > excelPolicy.maxRowsWithoutApproval){
    if(level === levelConst.LOW){
      level = levelConst.MID;
    }
    reasons.push('다운로드 건수 초과: ' + rowCount + '건');
  }

  // 3) 사용자별 일일 누적 다운로드 기준 (선택 사항, 8단계에서 확장)
  try{
    const dailyUsage = getDailyDownloadRows(userId, tableNames);
    if(dailyUsage != null && (dailyUsage + rowCount) > excelPolicy.dailyRowLimitPerUser){
      level = levelConst.HIGH;
      reasons.push('일일 누적 다운로드 한도 초과 가능');
    }
  }catch(e){
    console.warn('evaluateExcelRisk: daily usage check failed', e);
  }

  return { level, reasons };
}

/* ---------------- Excel Export Logging (엑셀 내보내기 로그/감사 7단계) ---------------- */
/**
 * Excel 내보내기 로그 목록 (/프론트 전용)
 * - 실제 운영에서는 서버 측 테이블/로그로 전환 예정
 */
const excelExportLogs = [];

/**
 * Excel 내보내기 시 로그를 남기는 헬퍼 함수.
 * meta: resultMeta 또는 유사 객체 (sql, rowCount, tableNames 등 포함)
 * info: {
 *   level: 'LOW' | 'MID' | 'HIGH',
 *   reasons: string[],
 *   approved: boolean,         // 결재 승인 후 다운로드 여부
 *   approvalId: string|null,   // 결재 ID (EXCEL_EXPORT 타입일 때)
 *   mode: 'DIRECT'|'APPROVAL'  // 바로 내보내기 / 결재 후 내보내기 구분
 * }
 */
function logExcelExport(meta, info){
  try{
    meta = meta || {};
    info = info || {};

    const entry = {
      timestamp: new Date(),
      userId: meta.userId || (typeof approvalCenter !== 'undefined' && typeof approvalCenter._currentUser === 'function'
        ? approvalCenter._currentUser()
        : (window.DBAM_CURRENT_USER || null)),
      sql: meta.sql || '',
      rowCount: typeof meta.rowCount === 'number' ? meta.rowCount : (meta.rowCount || null),
      tableNames: Array.isArray(meta.tableNames) ? meta.tableNames.slice() : [],
      riskLevel: info.level || null,
      riskReasons: Array.isArray(info.reasons) ? info.reasons.slice() : [],
      approved: !!info.approved,
      approvalId: info.approvalId || null,
      mode: info.mode || 'DIRECT'
    };

    excelExportLogs.push(entry);
    // 콘솔에서 확인할 수 있도록 디버그 출력 (운영 시 제거 가능)
    console.debug('Excel export logged', entry);
  }catch(e){
    console.warn('logExcelExport failed', e);
  }
}



/**
 * 엑셀 내보내기 버튼 클릭 핸들러 (4단계)
 * - state.lastResult / state.lastSql 을 기반으로 resultMeta를 구성
 * - evaluateExcelRisk(meta)로 LOW/MID/HIGH 판정 후 분기
 *   - LOW  : 바로 기존 감사/반출 모달(actions.exportCsv) 실행
 *   - MID  : 경고 confirm 후 계속 시 기존 감사/반출 모달 실행
 *   - HIGH : 경고 alert 후 현재 단계에서는 기존 감사/반출 모달 실행
 *            (다음 단계에서 쿼리 결재 연동 로직을 추가 예정)
 */
function onClickExportExcel(){
  // 1) 연결된 DB 여부 체크: 하나도 없으면 안내 후 종료
  try{
    let hasActiveConn = false;
    if (state && state.connStates) {
      for (const id in state.connStates) {
        if (Object.prototype.hasOwnProperty.call(state.connStates, id) && state.connStates[id]) {
          hasActiveConn = true;
          break;
        }
      }
    }
    if (!hasActiveConn) {
      alert('DB 연결 후 실행하세요.');
      return;
    }
  }catch(e){
    console.warn('onClickExportExcel: conn 상태 확인 중 오류', e);
  }

  // 2) 내보낼 결과 존재 여부 체크
  try{
    if(!state || !state.lastResult || !state.lastResult.columns || !state.lastResult.columns.length){
      alert('내보낼 결과가 없습니다.');
      return;
    }
  }catch(e){
    console.warn('onClickExportExcel: state 확인 중 오류', e);
  }


  const lr = state.lastResult || {};
  const rowCount = typeof lr.rowCount === 'number' ? lr.rowCount : (lr.rows ? lr.rows.length : 0);
  const cols = lr.columns || [];
  const colNames = cols.map(function(c){
    if(!c) return '';
    if(typeof c === 'string') return c;
    return c.name || c.label || '';
  });

  let userId = null;
  try{
    if(typeof approvalCenter !== 'undefined' && typeof approvalCenter._currentUser === 'function'){
      userId = approvalCenter._currentUser();
    }else if(window.DBAM_CURRENT_USER){
      userId = window.DBAM_CURRENT_USER;
    }
  }catch(e){
    console.warn('onClickExportExcel: userId 확인 중 오류', e);
  }

  try{
    setCurrentResultMetaFromExecution({
      queryId: null,
      sql: (state && state.lastSql) ? state.lastSql : '',
      rowCount: rowCount,
      tableNames: [], // TODO: 필요 시 쿼리 파싱/메타 정보와 연계
      columnNames: colNames,
      userId: userId,
      executedAt: new Date()
    });
  }catch(e){
    console.warn('onClickExportExcel: setCurrentResultMetaFromExecution 오류', e);
  }

  const meta = getCurrentResultMeta();
  const risk = evaluateExcelRisk(meta);
  const level = risk && risk.level ? risk.level : 'LOW';
  const reasons = Array.isArray(risk && risk.reasons) ? risk.reasons : [];

  // LOW: 바로 기존 Excel 내보내기 절차로 이동 (직접 내보내기 모드)
  if(level === 'LOW'){
    logExcelExport(meta, {
      level: level,
      reasons: reasons,
      approved: false,
      approvalId: null,
      mode: 'DIRECT'
    });
    actions.exportCsv();
    return;
  }

  // MID: 경고 후 계속 진행 여부 확인 (직접 내보내기 모드)
  if(level === 'MID'){
    const ok = window.confirm(
      '[주의] 대량 데이터 Excel 내보내기입니다.\n' +
      (reasons.length ? reasons.join('\n') + '\n\n' : '') +
      '계속 진행하시겠습니까?'
    );
    if(!ok) return;
    logExcelExport(meta, {
      level: level,
      reasons: reasons,
      approved: false,
      approvalId: null,
      mode: 'DIRECT'
    });
    actions.exportCsv();
    return;
  }

  // HIGH: 고위험 Excel 내보내기인 경우: 쿼리 결재함(EXCEL_EXPORT 타입)으로 승인 요청
  if(level === 'HIGH'){
    if(typeof approvalCenter === 'undefined' || typeof approvalCenter.beginRequest !== 'function'){
      alert(
        '[경고] 고위험 Excel 내보내기입니다.\n' +
        (reasons.length ? reasons.join('\n') + '\n\n' : '') +
        '승인 요청 모듈(approvalCenter)을 찾을 수 없어,\n' +
        '기존 Excel 내보내기 절차로 진행합니다.'
      );
      logExcelExport(meta, {
        level: level,
        reasons: reasons,
        approved: false,
        approvalId: null,
        mode: 'DIRECT'
      });
      actions.exportCsv();
      return;
    }

    // 엑셀 전용 EXCEL_EXPORT 타입으로 결재 요청 시작 (결재 후 내보내기 모드)
    const ctx = {
      sql: meta && meta.sql ? meta.sql : ((state && state.lastSql) ? state.lastSql : ''),
      connId: (state && state.activeConnId) ? state.activeConnId : null,
      risk: {
        level: level,
        reasons: reasons.slice()
      },
      type: 'EXCEL_EXPORT',
      exportRowCount: rowCount
    };

    // 결재 요청 단계 로그 (approved=false, mode='APPROVAL')
    logExcelExport(meta, {
      level: level,
      reasons: reasons,
      approved: false,
      approvalId: ctx.id || null,
      mode: 'APPROVAL'
    });

    approvalCenter.beginRequest(ctx);
    return;
  }

  // 그 외 예외적인 경우에도 기본 동작 유지
  actions.exportCsv();
}






;


/* ---------------- Query Approval Center (민감 쿼리 결재 ) ---------------- */
const approvalCenter = {
  _seq: 1,
  requests: [],
  currentDraft: null,
  currentFilter: 'all',
  currentPeriod: '30d',
  currentTypeFilter: 'all',
  currentDetailId: null,

  _nowIso(dt){
    const d = dt || new Date();
    try{
      return d.toISOString();
    }catch(e){
      return d.toString();
    }
  },
  _nowLabel(dt){
    const d = dt || new Date();
    try{
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      return y + '-' + m + '-' + day + ' ' + hh + ':' + mm + ':' + ss;
    }catch(e){
      return d.toString();
    }
  },
  _fmtMmDd(dt){
    if(!dt) return '';
    try{
      const d = (dt instanceof Date) ? dt : new Date(dt);
      if(!(d instanceof Date) || isNaN(d.getTime())) return '';
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return m + '/' + day;
    }catch(e){
      return '';
    }
  },
  _fmtHm(dt){
    if(!dt) return '';
    try{
      const d = (dt instanceof Date) ? dt : new Date(dt);
      if(!(d instanceof Date) || isNaN(d.getTime())) return '';
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return hh + ':' + mm;
    }catch(e){
      return '';
    }
  },
  _decorateApprovalLineWithTime(container, req){
    if(!container || !req) return;

    const children = Array.from(container.children || []);
    if(!children.length) return;

    // 첫 번째 DIV는 요청자 노드, 나머지 DIV는 승인자 노드로 본다.
    const requesterNode = children.find(function(el){ return el && el.tagName === 'DIV'; });
    const approverNodes = children.filter(function(el){
      return el && el.tagName === 'DIV' && el !== requesterNode;
    });

    const requestedAt = req.requestedAt ? new Date(req.requestedAt) : null;

    // 요청자 박스는 항상 동일하게 데코레이션
    if(requesterNode){
      this._decorateRequesterNode(requesterNode, requestedAt);
    }

    const hasSteps = Array.isArray(req.approvalSteps) && req.approvalSteps.length > 0;
    let approvalSteps = [];
    let currentStep = null;

    if(hasSteps){
      const steps = req.approvalSteps;
      approvalSteps = steps.filter(function(step){
        return step && (step.type || 'approval') === 'approval';
      });
      if(typeof req.currentStepIndex === 'number' &&
         req.currentStepIndex >= 0 &&
         req.currentStepIndex < steps.length){
        currentStep = steps[req.currentStepIndex];
      }
    }

    if(hasSteps && approvalSteps.length){
      // 다단계 결재 정보가 있을 때: 각 승인자 박스를 단계별로 데코레이션
      approverNodes.forEach((node, idx)=>{
        const step = approvalSteps[idx] || null;
        let approverAt = null;
        let stepStatus = null;
        let isCurrent = false;

        if(step){
          stepStatus = step.status || null;
          if(step.decidedAt){
            try{
              approverAt = new Date(step.decidedAt);
            }catch(e){}
          }
          if(currentStep && currentStep === step){
            isCurrent = true;
          }
        }

        this._decorateApproverNode(node, approverAt, stepStatus, isCurrent, step);
      });
    }else{
      // 결재선 정보가 없는 경우: 기존 단일 단계 표시 방식 유지 (호환용)
      let approverAtRaw = null;
      if(req.status === 'REJECTED'){
        approverAtRaw = req.rejectedAt || null;
      }else{
        approverAtRaw = req.approvedAt || null;
      }
      const approverAt = approverAtRaw ? new Date(approverAtRaw) : null;

      approverNodes.forEach((node)=>{
        this._decorateApproverNode(node, approverAt, req.status, false, null);
      });
    }
  },  _decorateRequesterNode(node, requestedAt){
    if(!node || node.dataset.detailDecorated === '1') return;
    node.dataset.detailDecorated = '1';

    const oldTop = node.firstElementChild;
    const oldBottom = oldTop ? oldTop.nextElementSibling : null;
    const roleLabel = oldTop && oldTop.textContent ? oldTop.textContent.trim() : '직급';
    const userLabel = oldBottom && oldBottom.textContent ? oldBottom.textContent.trim() : '로그인 사용자';

    const dateStr = this._fmtMmDd(requestedAt);
    const timeStr = this._fmtHm(requestedAt);

    // 공통 박스 스타일 (요청자도 높이 맞추기)
    node.style.borderRadius = node.style.borderRadius || '8px';
    node.style.padding = '6px 10px';
    node.style.border = node.style.border || '1px solid #e5e7eb';
    node.style.background = node.style.background || '#f9fafb';
    node.style.textAlign = 'center';
    node.style.display = 'flex';
    node.style.flexDirection = 'column';
    node.style.justifyContent = 'center';
    node.style.minHeight = '72px';

    node.innerHTML = '';

    const line1 = document.createElement('div');
    line1.style.fontSize = '11px';
    line1.style.color = '#6b7280';
    line1.textContent = roleLabel;
    node.appendChild(line1);

    if(dateStr){
      const dEl = document.createElement('div');
      dEl.style.fontSize = '10px';
      dEl.style.color = '#6b7280';
      dEl.textContent = dateStr;
      node.appendChild(dEl);
    }
    if(timeStr){
      const tEl = document.createElement('div');
      tEl.style.fontSize = '10px';
      tEl.style.color = '#6b7280';
      tEl.textContent = timeStr;
      node.appendChild(tEl);
    }

    const nameEl = document.createElement('div');
    nameEl.style.fontSize = '12px';
    nameEl.style.fontWeight = '500';
    nameEl.style.color = '#111827';
    nameEl.textContent = userLabel;
    node.appendChild(nameEl);
  },
  _decorateApproverNode(node, approvedAt, stepStatus, isCurrent, step){
    if(!node) return;

    const oldTop = node.firstElementChild;
    const oldBottom = oldTop ? oldTop.nextElementSibling : null;
    const roleLabel = oldTop && oldTop.textContent ? oldTop.textContent.trim() : '직급';
    const nameLabelRaw = oldBottom && oldBottom.textContent ? oldBottom.textContent.trim() : '미지정';

    // 기존 이름에서 "(대결)" 꼬리표가 이미 붙어 있다면 제거
    const baseName = nameLabelRaw.replace(/\s*\(대결\)\s*$/, '');

    // delegate 관련 정보 (approvalSteps에서 전달된 step 기준)
    const isDelegate = step && step.isDelegate === 'Y';
    const originalName = (step && step.originalName) ? step.originalName : '';
    const originalTitle = (step && step.originalTitle) ? step.originalTitle : '';

    const hasTime = (approvedAt instanceof Date) && !isNaN(approvedAt.getTime());
    const dateStr = hasTime ? this._fmtMmDd(approvedAt) : '';
    const timeStr = hasTime ? this._fmtHm(approvedAt) : '';

    const isApproved = (stepStatus === 'APPROVED');
    const isRejected = (stepStatus === 'REJECTED');
    const isPending  = (stepStatus === 'PENDING');

    // 박스 기본 스타일
    node.style.borderRadius = node.style.borderRadius || '8px';
    node.style.padding = node.style.padding || '6px 10px';
    node.style.border = node.style.border || '1px solid #e5e7eb';
    node.style.background = node.style.background || '#f9fafb';
    node.style.textAlign = 'center';
    node.style.display = 'flex';
    node.style.flexDirection = 'column';
    node.style.justifyContent = 'center';
    node.style.minHeight = '72px';

    // 기존 내용 제거
    node.innerHTML = '';

    // 역할 + 상태 텍스트
    const roleEl = document.createElement('div');
    roleEl.style.fontSize = '11px';
    roleEl.style.marginBottom = '1px';

    let roleText = roleLabel;
    if(isRejected){
      // 반려: 붉은색 + (반려)
      roleEl.style.color = '#b91c1c';
      roleText = roleLabel + ' (반려)';
    }else{
      // 기본: 초록색, 승인/현재 상태에 따라 꼬리표
      roleEl.style.color = '#16a34a';
      if(isApproved){
        roleText = roleLabel + ' (승인)';
      }else if(isCurrent && isPending){
        roleText = roleLabel + ' (현재)';
      }else{
        roleText = roleLabel;
      }
    }

    roleEl.textContent = roleText;
    node.appendChild(roleEl);

    // 날짜
    if(dateStr){
      const dEl = document.createElement('div');
      dEl.style.fontSize = '10px';
      dEl.style.color = '#6b7280';
      dEl.textContent = dateStr;
      node.appendChild(dEl);
    }
    // 시간
    if(timeStr){
      const tEl = document.createElement('div');
      tEl.style.fontSize = '10px';
      tEl.style.color = '#6b7280';
      tEl.textContent = timeStr;
      node.appendChild(tEl);
    }

    // 이름 (대결인 경우 "(대결)" 표기 + 원결재자 툴팁)
    const nameEl = document.createElement('div');
    nameEl.style.fontSize = '12px';
    nameEl.style.fontWeight = '500';
    nameEl.style.color = '#111827';

    if(isDelegate && originalName){
      nameEl.textContent = (baseName || '미지정') + ' (대결)';
      let tip = '원결재자: ' + originalName;
      if(originalTitle){
        tip += ' / ' + originalTitle;
      }
      node.title = tip;
    }else{
      nameEl.textContent = baseName || '미지정';
    }

    node.appendChild(nameEl);
  },

  _currentUser(){
    return window.DBAM_CURRENT_USER || 'demoUser';
  },
  _currentUserLabel(){
    return window.DBAM_CURRENT_USER_NAME || window.DBAM_CURRENT_USER || 'demoUser';
  },
  _canCurrentUserApprove(req){
    if(!req || req.status !== 'REQUESTED') return false;

    // 결재선이 정의되어 있지 않으면, 호환성을 위해 로그인한 사용자면 승인 가능하게 둠
    if(!Array.isArray(req.approvalSteps) || req.approvalSteps.length === 0){
      const meFallback = this._currentUser();
      return !!meFallback;
    }

    if(typeof req.currentStepIndex !== 'number' ||
       req.currentStepIndex < 0 ||
       req.currentStepIndex >= req.approvalSteps.length){
      return false;
    }

    const step = req.approvalSteps[req.currentStepIndex];
    if(!step || (step.type || 'approval') !== 'approval') return false;

    const me = this._currentUser();
    return !!me && step.empId === me;
  },

  _statusLabel(st){
    switch(st){
      case 'REQUESTED': return '승인대기';
      case 'APPROVED':  return '승인';
      case 'REJECTED':  return '반려';
      case 'EXECUTED':  return '실행완료';
      default:          return st || '임시';
    }
  },
  _statusBadgeHtml(st){
    const label = this._statusLabel(st);
    let bg = '#e5e7eb', color = '#374151';
    if(st === 'REQUESTED'){ bg = '#f97316'; color = '#fff'; }
    else if(st === 'APPROVED'){ bg = '#22c55e'; color = '#fff'; }
    else if(st === 'REJECTED'){ bg = '#ef4444'; color = '#fff'; }
    else if(st === 'EXECUTED'){ bg = '#0ea5e9'; color = '#fff'; }
    return '<span style="display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;background:'+bg+';color:'+color+';">'+label+'</span>';
  },

  beginRequest(ctx){
    const sql     = (ctx && ctx.sql)     || '';
    const connId  = (ctx && ctx.connId)  || null;
    const risk    = (ctx && ctx.risk)    || {reasons:[]};
    const reasons = Array.isArray(risk.reasons) ? risk.reasons.slice() : [];

    const tab = state.tabs.find(t => t.id === state.activeTabId) || {};
    const connLabel = (typeof getConnLabel === 'function') ? (getConnLabel(connId) || connId || '') : (connId || '');
    const dbName    = tab.dbName || '';
    const schema    = tab.schema || tab.schemaName || '';

    const draft = {
      id: 'APR-' + String(this._seq++).padStart(4,'0'),
      status: 'DRAFT',
      connId,
      connLabel,
      dbName,
      schemaName: schema,
      requester: this._currentUser(),
      requesterLabel: this._currentUserLabel(),
      approver: '',
      approverLabel: '',
      reason: '',
      itsmNo: '',
      riskReasons: reasons,
      sql: sql,
      sqlFirstLine: (sql || '').split(/\r?\n/)[0].slice(0,120),
      // 결재 유형: 기본은 SQL_EXECUTE, 엑셀 내보내기는 EXCEL_EXPORT
      approvalType: (ctx && ctx.type) || 'SQL_EXECUTE',
      // 엑셀 내보내기 요청 시 예상 행 수(선택)
      exportRowCount: (ctx && typeof ctx.exportRowCount === 'number') ? ctx.exportRowCount : null,
      // 다단계 결재선을 위한 초기 구조
      approvalSteps: [],
      currentStepIndex: null,
      requestedAt: null,
      approvedAt: null,
      rejectedAt: null,
      executedAt: null,
      allowedExecCount: 1,
      usedExecCount: 0,
      requestedExecCount: 1,
      validFrom: null,
      validTo: null
    };
    this.currentDraft = draft;
    this._openRequestModal(draft);
  },

  _openRequestModal(req){
    const backdrop = document.getElementById('approvalRequestBackdrop');
    if(!backdrop){
      alert('승인 요청 모달 DOM을 찾지 못했습니다.');
      return;
    }

    const type = req.approvalType || req.type || 'SQL_EXECUTE';

    const titleSpan      = backdrop.querySelector('[data-role="apReqTitleText"]');
    const guideEl        = backdrop.querySelector('[data-role="apReqGuide"]');
    const reasonLabel    = backdrop.querySelector('[data-role="apReqReasonLabel"]');
    const reasonTa       = backdrop.querySelector('#apReqReason');
    const execCountLabel = backdrop.querySelector('[data-role="apReqExecCountLabel"]');

    if(type === 'EXCEL_EXPORT'){
      if(titleSpan) titleSpan.textContent = '엑셀 내보내기 승인 요청';
      if(guideEl) guideEl.textContent = '대량 데이터/개인정보를 엑셀로 내보낼 때는 승인 후 다운로드하도록 설계된 입니다.';
      if(reasonLabel){
        for(const node of reasonLabel.childNodes){
          if(node.nodeType === Node.TEXT_NODE){
            node.textContent = '엑셀 내보내기 사유';
            break;
          }
        }
      }
      if(execCountLabel){
        for(const node of execCountLabel.childNodes){
          if(node.nodeType === Node.TEXT_NODE){
            node.textContent = '허용 다운로드 횟수';
            break;
          }
        }
      }
      if(reasonTa){
        reasonTa.placeholder = '왜 이 데이터를 엑셀로 내보내야 하는지 업무 사유를 입력하세요.';
      }
    }else{
      if(titleSpan) titleSpan.textContent = '위험 쿼리 승인 요청';
      if(guideEl) guideEl.textContent = '개인정보/민감 테이블에 대한 쿼리는 바로 실행하지 않고 승인 요청 후 실행하도록 설계된 입니다.';
      if(reasonLabel){
        for(const node of reasonLabel.childNodes){
          if(node.nodeType === Node.TEXT_NODE){
            node.textContent = '사유';
            break;
          }
        }
      }
      if(execCountLabel){
        for(const node of execCountLabel.childNodes){
          if(node.nodeType === Node.TEXT_NODE){
            node.textContent = '허용 실행 횟수';
            break;
          }
        }
      }
      if(reasonTa){
        reasonTa.placeholder = '왜 이 쿼리를 실행해야 하는지 업무 사유를 입력하세요.';
      }
    }

    // 채우기
    const connEl   = backdrop.querySelector('[data-field="connLabel"]');
    const schemaEl = backdrop.querySelector('[data-field="schemaName"]');
    const userEl   = backdrop.querySelector('[data-field="requester"]');
    const bizEl    = backdrop.querySelector('[data-field="bizName"]');
    const riskEl   = backdrop.querySelector('[data-field="riskReasons"]');
    const sqlEl    = backdrop.querySelector('#apReqSql');

    if(connEl)   connEl.textContent   = (req.connLabel || req.connId || '');
    if(schemaEl) schemaEl.textContent = req.schemaName || '';
    if(userEl)   userEl.textContent   = req.requesterLabel || req.requester || '';
    if(bizEl)    bizEl.textContent    = req.bizName || req.biz || '';
    if(riskEl)   riskEl.textContent   = (req.riskReasons && req.riskReasons.length) ? req.riskReasons.join(' / ') : '위험 사유 정보 없음';
    if(sqlEl)    sqlEl.value          = req.sql || '';

    const reasonEl    = backdrop.querySelector('#apReqReason');
    const approverEl  = backdrop.querySelector('#apReqApprover');
    const ticketEl    = backdrop.querySelector('#apReqTicket');
    const execCountEl = backdrop.querySelector('#apReqExecCount');
    const validFromEl = backdrop.querySelector('#apReqValidFrom');
    const validToEl   = backdrop.querySelector('#apReqValidTo');

    if(reasonEl)    reasonEl.value    = req.reason || '';
    if(approverEl)  approverEl.value  = req.approver || '';
    if(ticketEl)    ticketEl.value    = req.itsmNo || '';
    if(execCountEl) execCountEl.value = String(req.requestedExecCount || req.allowedExecCount || 1);
    if(validFromEl) validFromEl.value = req.validFrom || '';
    if(validToEl)   validToEl.value   = req.validTo || '';

    backdrop.classList.remove('hidden');
    backdrop.classList.add('show');
    backdrop.setAttribute('aria-hidden','false');
  },

  closeRequestModal(){
    const backdrop = document.getElementById('approvalRequestBackdrop');
    if(!backdrop) return;
    backdrop.classList.remove('show');
    backdrop.classList.add('hidden');
    backdrop.setAttribute('aria-hidden','true');
    this.currentDraft = null;
  },

  submitCurrentRequest(){

    const req = this.currentDraft;
    const backdrop = document.getElementById('approvalRequestBackdrop');
    if(!req || !backdrop){ return; }

    // 결재선 미리보기 HTML을 함께 저장 (상세 모달에서 재사용)
    const outerLine = backdrop.querySelector('#apReqApprovalPreviewLine');
    const outerRef  = backdrop.querySelector('#apReqApprovalPreviewRef');
    req.approvalLineHtml = outerLine ? outerLine.innerHTML : '';
    req.approvalRefHtml  = outerRef  ? outerRef.innerHTML  : '';

    const reasonEl    = backdrop.querySelector('#apReqReason');
    const approverEl  = backdrop.querySelector('#apReqApprover');
    const ticketEl    = backdrop.querySelector('#apReqTicket');
    const execCountEl = backdrop.querySelector('#apReqExecCount');
    const validFromEl = backdrop.querySelector('#apReqValidFrom');
    const validToEl   = backdrop.querySelector('#apReqValidTo');

    const reason    = reasonEl   ? reasonEl.value.trim()   : '';
    const approver  = approverEl ? approverEl.value.trim() : '';
    const ticket    = ticketEl   ? ticketEl.value.trim()   : '';
    const execCount = execCountEl ? (parseInt(execCountEl.value,10) || 1) : 1;
    const validFrom = validFromEl ? validFromEl.value : '';
    const validTo   = validToEl   ? validToEl.value   : '';

    if(!reason){
      alert('사유를 입력하세요.');
      if(reasonEl) reasonEl.focus();
      return;
    }
    if(execCount <= 0){
      alert('허용 실행 횟수는 1회 이상이어야 합니다.');
      if(execCountEl) execCountEl.focus();
      return;
    }
    if(validFrom && validTo){
      try{
        const fromTs = Date.parse(validFrom);
        const toTs   = Date.parse(validTo);
        if(!isNaN(fromTs) && !isNaN(toTs) && toTs < fromTs){
          alert('유효 종료일시는 시작일시 이후로 설정하세요.');
          if(validToEl) validToEl.focus();
          return;
        }
      }catch(e){}
    }

    // 3단계: 결재선 구조 보정 및 필수 체크
    const steps = Array.isArray(req.approvalSteps) ? req.approvalSteps : [];
    const approvalSteps = steps.filter(function(step){
      return step && (step.type || 'approval') === 'approval';
    });

    if(approvalSteps.length === 0){
      alert('결재선을 지정해 주세요. (최소 1명의 승인자를 추가해야 합니다.)');
      return;
    }

    // 단계 상태 초기화
    steps.forEach(function(step){
      if(!step) return;
      const t = step.type || 'approval';
      if(t === 'approval'){
        step.status = 'PENDING';
      }else{
        step.status = step.status || 'NONE';
      }
      step.decidedAt = null;
    });

    // currentStepIndex 재계산
    let firstIdx = null;
    for(let i=0;i<steps.length;i++){
      const s = steps[i];
      if(s && (s.type || 'approval') === 'approval'){
        firstIdx = i;
        break;
      }
    }
    req.currentStepIndex = (firstIdx !== null ? firstIdx : null);

    // 나머지 필드 세팅
    req.reason          = reason;
    req.approver        = approver;
    req.approverLabel   = approver;
    req.itsmNo          = ticket;
    req.requestedExecCount = execCount;
    req.allowedExecCount   = execCount;
    req.validFrom       = validFrom || null;
    req.validTo         = validTo   || null;
    req.status          = 'REQUESTED';
    req.requestedAt     = new Date();

    this.requests.unshift(req);
    this.currentDraft = null;
    this.closeRequestModal();
    this.renderList();

    if(typeof bottomTabs !== 'undefined' && bottomTabs.activate){
      bottomTabs.activate('approvalPanel');
    }
    if(typeof ui !== 'undefined' && ui.setExecMeta){
      ui.setExecMeta('승인 대기 중인 쿼리로 등록되었습니다.');
    }
  },

  applyFilter(kind){
    this.currentFilter = kind || 'all';
    this.renderList();
  },

  applyTypeFilter(kind){
    this.currentTypeFilter = kind || 'all';
    this.renderList();
  },

  applyPeriod(kind){
    this.currentPeriod = kind || '30d';
    this.renderList();
  },

  refresh(){
    this.renderList();
  },

  renderList(){
    const tbody = document.querySelector('#approvalGrid tbody');
    if(!tbody) return;

    const me = this._currentUser();
    const filter = this.currentFilter || 'all';
    const period = this.currentPeriod || '30d';
    const typeFilter = this.currentTypeFilter || 'all';

    // 쿼리 결재함 탭 배지: 내가 승인해야 할 건수 표시
    try{
      const badgeEl = document.getElementById('approvalTodoBadge');
      if(badgeEl){
        const reqs = Array.isArray(this.requests) ? this.requests : [];
        const todoCount = reqs.filter(r => r && r.status === 'REQUESTED' && this._canCurrentUserApprove(r)).length;
        if(todoCount > 0){
          badgeEl.textContent = String(todoCount);
          badgeEl.style.display = 'flex';
        }else{
          badgeEl.style.display = 'none';
        }
      }
    }catch(e){
      console.warn('update approval todo badge error', e);
    }

    let list = this.requests.slice();

    // 1) 역할/상태 기준 필터
    if(filter === 'mine'){
      // 내가 요청한 쿼리
      list = list.filter(r => r.requester === me);
    }else if(filter === 'todo'){
      // 내가 승인해야 할 쿼리 (다단계 결재 기준 현재 차수의 승인자)
      list = list.filter(r => this._canCurrentUserApprove(r));
    }else if(filter === 'approvedByMe'){
      // 내가 승인한 쿼리
      //  - 최종 승인/실행 완료 건 (req.approver 기준)
      //  - 다단계 결재 중 내가 한 차수라도 승인한 건 (step.approverSessionId 기준)
      list = list.filter(r => {
        // 1) 최종 승인/실행 완료 건
        if(r.approver && r.approver === me && (r.status === 'APPROVED' || r.status === 'EXECUTED')){
          return true;
        }
        // 2) 다단계 결재: 어떤 승인 단계든 내가 승인한 기록이 있는지
        if(Array.isArray(r.approvalSteps) && r.approvalSteps.length > 0){
          return r.approvalSteps.some(function(step){
            if(!step) return false;
            const type = step.type || 'approval';
            const st   = step.status || 'PENDING';
            return type === 'approval' &&
                   st === 'APPROVED' &&
                   step.approverSessionId === me;
          });
        }
        return false;
      });
    }else if(filter === 'rejectedByMe'){
      // 내가 반려한 쿼리
      list = list.filter(r => r.approver && r.approver === me && r.status === 'REJECTED');
    }else if(filter === 'refByMe'){
      // 내가 참조확인한 쿼리 (참조 단계의 status가 CONFIRMED이고, 나의 empId로 기록된 경우)
      list = list.filter(r => {
        if(!Array.isArray(r.approvalSteps) || r.approvalSteps.length === 0) return false;
        return r.approvalSteps.some(function(step){
          if(!step) return false;
          const type = step.type || 'approval';
          const st   = step.status || 'NONE';
          return type === 'ref' &&
                 st === 'CONFIRMED' &&
                 step.approverSessionId === me;
        });
      });
    }else if(filter === 'completed'){
      // 완료된 쿼리 (승인/반려/실행)
      list = list.filter(r => r.status === 'APPROVED' || r.status === 'REJECTED' || r.status === 'EXECUTED');
    }


    // 1-b) 유형(SQL/엑셀) 기준 필터
    if(typeFilter === 'excel'){
      list = list.filter(function(r){
        if(!r) return false;
        const t = r.approvalType || r.type || 'SQL_EXECUTE';
        return t === 'EXCEL_EXPORT';
      });
    }else if(typeFilter === 'sql'){
      list = list.filter(function(r){
        if(!r) return false;
        const t = r.approvalType || r.type || 'SQL_EXECUTE';
        return t !== 'EXCEL_EXPORT';
      });
    }

    // 2) 기간 필터: 승인할 쿼리(todo)는 기간 제한 없이 전체 조회
    if(filter !== 'todo' && period && period !== 'all'){
      const nowTs = Date.now();
      let days = 0;
      if(period.endsWith('d')){
        const n = parseInt(period.slice(0, -1), 10);
        if(!isNaN(n) && n > 0) days = n;
      }
      if(days > 0){
        const fromTs = nowTs - days * 24 * 60 * 60 * 1000;
        list = list.filter(r => {
          if(!r.requestedAt) return true;
          const t = Date.parse(r.requestedAt);
          if(isNaN(t)) return true;
          return t >= fromTs;
        });
      }
    }

    tbody.innerHTML = '';
    if(!list.length){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 9;
      td.style.textAlign = 'center';
      td.style.padding = '8px';
      td.style.color = '#6b7280';
      td.textContent = '아직 등록된 결재 요청이 없습니다.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    list.forEach(req => {
      const tr = document.createElement('tr');
      tr.dataset.reqId = req.id;
      tr.style.cursor = 'pointer';
      tr.addEventListener('click', () => {
        approvalCenter.openDetail(req.id);
      });

      function td(text){
        const cell = document.createElement('td');
        cell.textContent = text;
        cell.style.textAlign = 'center';
        return cell;
      }

      // 유형 컬럼: SQL / 엑셀(EXCEL_EXPORT) 구분 아이콘
      const typeTd = document.createElement('td');
      const type = req.approvalType || req.type || 'SQL_EXECUTE';
      let typeHtml = '';
      if(type === 'EXCEL_EXPORT'){
        typeHtml =
          '<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;padding:2px 6px;border-radius:9999px;background:#ecfdf5;color:#166534;">' +
          '<i class="fa-solid fa-file-excel"></i>' +
          '<span>엑셀</span>' +
          '</span>';
      }else{
        typeHtml =
          '<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;padding:2px 6px;border-radius:9999px;background:#eff6ff;color:#1d4ed8;">' +
          '<i class="fa-solid fa-database"></i>' +
          '<span>SQL</span>' +
          '</span>';
      }
      typeTd.innerHTML = typeHtml;
      typeTd.style.textAlign = 'center';

      const statusTd = document.createElement('td');
      statusTd.innerHTML = this._statusBadgeHtml(req.status);
      statusTd.style.textAlign = 'center';

      const requesterTd = td(req.requesterLabel || req.requester || '');

      // 진행 중(REQUESTED)인 건은 현재 승인자만 표시,
      // 최종 완료(승인/반려/실행완료 등)된 건은 기존 approverLabel 전체를 그대로 사용
      let approverLabelForList = req.approverLabel || req.approver || '';

      if(req.status === 'REQUESTED' &&
         Array.isArray(req.approvalSteps) && req.approvalSteps.length > 0){
        const steps = req.approvalSteps;
        let currentStep = null;

        if(typeof req.currentStepIndex === 'number' &&
           req.currentStepIndex >= 0 &&
           req.currentStepIndex < steps.length){
          currentStep = steps[req.currentStepIndex];
        }

        let currentApprovals = [];

        // currentStep이 승인 단계인 경우: 해당 단계만 현재 승인자로 본다.
        if(currentStep && (currentStep.type || 'approval') === 'approval'){
          currentApprovals = [currentStep];
        }else{
          // currentStep이 없거나 approval 타입이 아닌 경우: PENDING 상태의 승인 단계 중 첫 번째를 fallback으로 사용
          currentApprovals = steps.filter(function(step){
            if(!step) return false;
            const type = step.type || 'approval';
            const st   = step.status || 'PENDING';
            return type === 'approval' && st === 'PENDING';
          }).slice(0,1);
        }

        if(currentApprovals.length){
          const names = currentApprovals.map(function(s){
            let baseName = (s.name || '').replace(/\s*\(대결\)\s*$/, '');
            const title  = s.title || '';
            const isDelegate = s.isDelegate === 'Y';
            const originalName  = (s.originalName || '').replace(/\s*\(대결\)\s*$/, '');
            const originalTitle = s.originalTitle || '';
            let label = baseName || '';

            if(title){
              label = label ? (label + ' ' + title) : title;
            }

            if(isDelegate){
              let suffix = ' (대결';
              if(originalName){
                suffix += ', 원결재자: ' + originalName;
                if(originalTitle){
                  suffix += ' ' + originalTitle;
                }
              }
              suffix += ')';
              label += suffix;
            }

            return label;
          }).filter(Boolean);

          if(names.length){
            // 현재 승인자 이름(직급 포함)을 리스트에 표시
            approverLabelForList = names.join(', ');
          }
        }
      }

      // 진행 중이 아닌 건에서도 대결 승인자가 있는 경우 리스트에서 식별 가능하도록 표시
      if(req.status !== 'REQUESTED' &&
         Array.isArray(req.approvalSteps) && req.approvalSteps.length > 0){
        const approvals = req.approvalSteps.filter(function(step){
          return step && (step.type || 'approval') === 'approval';
        });

        const delegates = approvals.filter(function(step){
          return step.isDelegate === 'Y';
        });

        if(delegates.length > 0){
          const step = delegates[delegates.length - 1];

          let baseName = (step.name || '').replace(/\s*\(대결\)\s*$/, '');
          const title  = step.title || '';
          let label = baseName || '';

          if(title){
            label = label ? (label + ' ' + title) : title;
          }

          const originalName  = (step.originalName || '').replace(/\s*\(대결\)\s*$/, '');
          const originalTitle = step.originalTitle || '';

          let suffix = ' (대결';
          if(originalName){
            suffix += ', 원결재자: ' + originalName;
            if(originalTitle){
              suffix += ' ' + originalTitle;
            }
          }
          suffix += ')';

          approverLabelForList = label + suffix;
        }
      }

      const approverTd  = td(approverLabelForList);
      const reasonTd    = td(req.reason || '');

      let execCountLabel = '';
      if(typeof req.allowedExecCount === 'number'){
        execCountLabel = String(req.allowedExecCount);
      }else if(typeof req.requestedExecCount === 'number'){
        execCountLabel = String(req.requestedExecCount);
      }
      if(execCountLabel){
        execCountLabel += '회';
      }
      const execCountTd = td(execCountLabel);

      let validLabel = '';
      if(req.validFrom || req.validTo){
        const from = req.validFrom || '';
        const to   = req.validTo   || '';
        if(from && to){
          validLabel = from + ' ~ ' + to;
        }else if(from){
          validLabel = from + ' ~';
        }else if(to){
          validLabel = '~ ' + to;
        }
      }
      const validTd = td(validLabel);

      const tsLabel = req.requestedAt ? this._nowLabel(req.requestedAt) : '';
      const timeTd  = td(tsLabel);

      // 사용 실행횟수: usedExecCount
      let usedExecLabel = '';
      if(typeof req.usedExecCount === 'number'){
        usedExecLabel = String(req.usedExecCount) + '회';
      }
      const usedExecTd = td(usedExecLabel);

      // 정렬: 컬럼/데이터는 가운데 정렬, 승인요청사유(reasonTd)만 좌측 정렬
      reasonTd.style.textAlign = 'left';

      tr.appendChild(typeTd);
      tr.appendChild(statusTd);
      tr.appendChild(requesterTd);
      tr.appendChild(approverTd);
      tr.appendChild(reasonTd);
      tr.appendChild(execCountTd);
      tr.appendChild(usedExecTd);
      tr.appendChild(validTd);
      tr.appendChild(timeTd);

      tbody.appendChild(tr);
    });
  },

  openDetail(id){
    const req = this.requests.find(r => r.id === id);
    if(!req) return;

    this.currentDetailId = id;
    const backdrop = document.getElementById('approvalDetailBackdrop');
    if(!backdrop){
      alert('결재 상세 모달 DOM을 찾지 못했습니다.');
      return;
    }

    const type = req.approvalType || req.type || 'SQL_EXECUTE';

    const titleSpan   = backdrop.querySelector('[data-role="apDetailTitleText"]');
    const statusEl    = backdrop.querySelector('[data-field="status"]');
    const connEl      = backdrop.querySelector('[data-field="connLabel"]');
    const schemaEl    = backdrop.querySelector('[data-field="schemaName"]');
    const reqUserEl   = backdrop.querySelector('[data-field="requester"]');
    const bizEl       = backdrop.querySelector('[data-field="bizName"]');
    const appUserEl   = backdrop.querySelector('[data-field="approver"]');
    const riskEl      = backdrop.querySelector('[data-field="riskReasons"]');
    const reasonEl    = backdrop.querySelector('[data-field="requestReason"]');
    const rejectEl    = backdrop.querySelector('[data-field="rejectReason"]');
    const rejectRow   = backdrop.querySelector('#apDetailRejectRow');
    const metaEl      = backdrop.querySelector('[data-field="meta"]');
    const sqlEl       = backdrop.querySelector('#apDetailSql');
    const sqlLabelEl  = backdrop.querySelector('#apDetailSqlLabel');
    const execInfoEl  = backdrop.querySelector('[data-field="execInfo"]');
    const validRangeEl = backdrop.querySelector('#apDetailValidRange');

    const detailLineEl = backdrop.querySelector('#apDetailApprovalLine');
    const detailRefEl  = backdrop.querySelector('#apDetailApprovalRef');
    const detailBoxEl  = backdrop.querySelector('#apDetailApprovalBox');

    const reasonLabelEl    = backdrop.querySelector('[data-role="apDetailReasonLabel"]');
    const execCountLabelEl = backdrop.querySelector('[data-role="apDetailExecCountLabel"]');

    // 타입에 따라 타이틀/라벨 문구 변경
    if(type === 'EXCEL_EXPORT'){
      if(titleSpan) titleSpan.textContent = '엑셀 다운로드 결재 상세';
      if(reasonLabelEl){
        reasonLabelEl.textContent = '엑셀 내보내기 사유';
      }
      if(execCountLabelEl){
        // 라벨 첫 텍스트 노드만 교체
        const txtNodes = Array.from(execCountLabelEl.childNodes).filter(function(n){ return n.nodeType === Node.TEXT_NODE; });
        if(txtNodes.length){
          txtNodes[0].textContent = '허용 다운로드 횟수';
        }
      }
    }else{
      if(titleSpan) titleSpan.textContent = '쿼리 결재 상세';
      if(reasonLabelEl){
        reasonLabelEl.textContent = '승인 요청 사유';
      }
      if(execCountLabelEl){
        const txtNodes = Array.from(execCountLabelEl.childNodes).filter(function(n){ return n.nodeType === Node.TEXT_NODE; });
        if(txtNodes.length){
          txtNodes[0].textContent = '허용 실행 횟수';
        }
      }
    }

    if(statusEl) statusEl.innerHTML = this._statusBadgeHtml(req.status);
    if(connEl)   connEl.textContent = req.connLabel || req.connId || '';
    if(schemaEl) schemaEl.textContent = req.schemaName || '';
    if(reqUserEl) reqUserEl.textContent = req.requesterLabel || req.requester || '';
    if(bizEl)    bizEl.textContent  = req.bizName || req.biz || '';

    // 승인자 요약: 대결 여부를 반영해서 상단 텍스트에 표시
    if(appUserEl){
      let approverText = '';

      if(Array.isArray(req.approvalSteps) && req.approvalSteps.length > 0){
        const approvals = req.approvalSteps.filter(function(step){
          return step && (step.type || 'approval') === 'approval';
        });

        if(approvals.length > 0){
          // 1) 대결 승인자가 있는 경우: 가장 마지막(차수 높은) 대결 승인자 기준으로 표시
          const delegates = approvals.filter(function(step){
            return step.isDelegate === 'Y';
          });

          if(delegates.length > 0){
            const step = delegates[delegates.length - 1];

            // 기본 이름에서 "(대결)" 꼬리표가 이미 붙어있다면 제거
            let baseName = (step.name || '').replace(/\s*\(대결\)\s*$/, '');
            const title  = step.title || '';
            let label = baseName || '';

            if(title){
              label = label ? (label + ' ' + title) : title;
            }

            const originalName  = (step.originalName  || '').replace(/\s*\(대결\)\s*$/, '');
            const originalTitle = step.originalTitle || '';

            let suffix = ' (대결';
            if(originalName){
              suffix += ', 원결재자: ' + originalName;
              if(originalTitle){
                suffix += ' ' + originalTitle;
              }
            }
            suffix += ')';

            approverText = label + suffix;
          }else{
            // 2) 대결이 없는 경우: 승인 라인 이름들을 단순 나열
            const names = approvals.map(function(step){
              const n = step.name || '';
              const t = step.title || '';
              return t ? (n + ' ' + t) : n;
            }).filter(Boolean);
            approverText = names.join(', ');
          }
        }
      }

      appUserEl.textContent = approverText;
    }

    if(riskEl)  riskEl.textContent  = (req.riskReasons && req.riskReasons.length) ? req.riskReasons.join(' / ') : '위험 사유 정보 없음';
    if(reasonEl) reasonEl.textContent = req.reason || '';
    if(rejectEl) rejectEl.textContent = req.rejectReason || '';
    if(rejectRow && rejectEl){
      if(req.status === 'REJECTED'){
        rejectRow.style.display = '';
        rejectEl.style.display = '';
      }else{
        rejectRow.style.display = 'none';
        rejectEl.style.display = 'none';
        rejectEl.textContent = '';
      }
    }

    // 결재선 미리보기 (상세 모달)
    if(detailLineEl){
      detailLineEl.innerHTML = req.approvalLineHtml || '';
      this._decorateApprovalLineWithTime(detailLineEl, req);
    }
    if(detailRefEl){
      detailRefEl.innerHTML = req.approvalRefHtml || '';

      // 참조자 확인 여부에 따라 체크 아이콘 + 참조확인 시각 표시
      if(Array.isArray(req.approvalSteps) && req.approvalSteps.length > 0){
        const refSteps = req.approvalSteps.filter(function(step){
          return step && (step.type || 'approval') === 'ref';
        });
        const chips = detailRefEl.querySelectorAll('.ap-ref-chip');
        chips.forEach((chip, idx) => {
          const step = refSteps[idx] || null;
          if(!step) return;
          if(step.status === 'CONFIRMED'){
            chip.classList.add('confirmed');
            const tsSpan = document.createElement('span');
            tsSpan.className = 'ref-confirm-ts';
            tsSpan.textContent = step.confirmedAt ? (' (' + approvalCenter._nowLabel(step.confirmedAt) + ')') : '';
            chip.appendChild(tsSpan);
          }else{
            chip.classList.remove('confirmed');
          }
        });
      }
    }
    if(detailBoxEl){
      const hasLine = req.approvalLineHtml && String(req.approvalLineHtml).trim() !== '';
      const hasRef  = req.approvalRefHtml && String(req.approvalRefHtml).trim() !== '';
      detailBoxEl.style.display = (hasLine || hasRef) ? '' : 'none';
    }

    const metaParts = [];
    if(req.itsmNo){ metaParts.push('ITSM/작업요청: ' + req.itsmNo); }
    if(req.requestedAt){ metaParts.push('요청시각: ' + this._nowLabel(req.requestedAt)); }
    if(req.approvedAt){ metaParts.push('승인시각: ' + this._nowLabel(req.approvedAt)); }
    if(req.rejectedAt){ metaParts.push('반려시각: ' + this._nowLabel(req.rejectedAt)); }
    if(req.executedAt){ metaParts.push('실행시각: ' + this._nowLabel(req.executedAt)); }
    if(metaEl) metaEl.textContent = metaParts.join('  |  ');

    if(sqlEl) sqlEl.value = req.sql || '';

    // SQL 라벨: 승인 전에는 "요청된 쿼리", 승인/실행 후에는 "승인된 쿼리"
    if(sqlLabelEl){
      if(req.status === 'APPROVED' || req.status === 'EXECUTED'){
        sqlLabelEl.textContent = '승인된 쿼리';
      }else{
        sqlLabelEl.textContent = '요청된 쿼리';
      }
    }

    if(execInfoEl){
      const pieces = [];
      if(typeof req.allowedExecCount === 'number'){
        pieces.push('허용 ' + req.allowedExecCount + '회');
      }
      if(typeof req.usedExecCount === 'number'){
        pieces.push('사용 ' + req.usedExecCount + '회');
      }
      if(pieces.length){
        execInfoEl.textContent = pieces.join(' / ');
      }else{
        execInfoEl.textContent = '';
      }
    }

    // 유효 기간 표시 (텍스트)
    if(validRangeEl){
      const from = req.validFrom || '';
      const to   = req.validTo   || '';
      let label = '';
      if(from || to){
        if(from && to){
          label = '유효 기간: ' + from + ' ~ ' + to;
        }else if(from){
          label = '유효 기간: ' + from + ' ~';
        }else{
          label = '유효 기간: ~ ' + to;
        }
      }else{
        label = '유효 기간: -';
      }
      validRangeEl.textContent = label;
    }

    const approveBtn    = backdrop.querySelector('#apDetailApprove');
    const rejectBtn     = backdrop.querySelector('#apDetailReject');
    const refConfirmBtn = backdrop.querySelector('#apDetailRefConfirm');
    const execBtn       = backdrop.querySelector('#apDetailExecute');
    const excelBtn      = backdrop.querySelector('#apDetailExcelDownload');
    const execCountSel  = backdrop.querySelector('#apDetailExecCount');

    // SQL 실행/엑셀 다운로드/허용 횟수는 승인자만 변경 가능
    const me = this._currentUser();
    let canApprove = this._canCurrentUserApprove(req);
    let hasPendingRefForMe = false;

    if(Array.isArray(req.approvalSteps) && req.approvalSteps.length > 0){
      const steps = req.approvalSteps;

      // 참조자 중 내가 아직 확인하지 않은 건이 있는지 체크
      steps.forEach(function(step){
        if(!step) return;
        if((step.type || 'approval') !== 'ref') return;
        if(step.empId && step.empId === me && step.status !== 'CONFIRMED'){
          hasPendingRefForMe = true;
        }
      });
    }

    // 허용 실행/다운로드 횟수 셀렉트 값 적용 (승인자만 수정 가능)
    if(execCountSel){
      if(typeof req.allowedExecCount === 'number'){
        execCountSel.value = String(req.allowedExecCount);
      }else if(typeof req.requestedExecCount === 'number'){
        execCountSel.value = String(req.requestedExecCount);
      }else{
        execCountSel.value = '1';
      }
      execCountSel.disabled = !canApprove;
    }

    // 현재 차수 승인자가 아닌 경우 승인/반려 버튼 숨김
    if(approveBtn) approveBtn.style.display = (req.status === 'REQUESTED' && canApprove) ? '' : 'none';
    if(rejectBtn)  rejectBtn.style.display  = (req.status === 'REQUESTED' && canApprove) ? '' : 'none';

    // 참조자는 결재 순서와 무관하게 참조확인 버튼 노출 (아직 확인하지 않은 경우)
    if(refConfirmBtn) refConfirmBtn.style.display = hasPendingRefForMe ? '' : 'none';

    if(execBtn || excelBtn){
      const isRequester = (req.requester === this._currentUser());

      let canExec = isRequester && (req.status === 'APPROVED' || req.status === 'EXECUTED') && type !== 'EXCEL_EXPORT';

      // 허용 실행횟수 모두 사용한 경우 실행 버튼 숨김
      if(canExec && typeof req.allowedExecCount === 'number' && typeof req.usedExecCount === 'number' && req.usedExecCount >= req.allowedExecCount){
        canExec = false;
      }

      // 유효 기간이 설정되어 있고, 현재 시간이 범위를 벗어나면 실행 버튼 숨김
      if(canExec && (req.validFrom || req.validTo)){
        const nowTs = Date.now();
        try{
          if(req.validFrom){
            const fromTs = Date.parse(req.validFrom);
            if(!isNaN(fromTs) && nowTs < fromTs){
              canExec = false;
            }
          }
          if(req.validTo){
            const toTs = Date.parse(req.validTo);
            if(!isNaN(toTs) && nowTs > toTs){
              canExec = false;
            }
          }
        }catch(e){}
      }

      if(execBtn){
        execBtn.style.display = canExec ? '' : 'none';
      }

      // EXCEL_EXPORT: 엑셀 다운로드 버튼 노출 조건은 onClickExportExcel / downloadExcelForCurrent와 동일
      if(excelBtn){
        let canExcel = (type === 'EXCEL_EXPORT') && isRequester && (req.status === 'APPROVED' || req.status === 'EXECUTED');

        // 허용 다운로드 횟수 모두 사용한 경우 버튼 숨김
        if(canExcel && typeof req.allowedExecCount === 'number' && typeof req.usedExecCount === 'number' && req.usedExecCount >= req.allowedExecCount){
          canExcel = false;
        }

        // 유효 기간이 설정되어 있고, 현재 시간이 범위를 벗어나면 버튼 숨김
        if(canExcel && (req.validFrom || req.validTo)){
          const nowTs2 = Date.now();
          try{
            if(req.validFrom){
              const fromTs2 = Date.parse(req.validFrom);
              if(!isNaN(fromTs2) && nowTs2 < fromTs2){
                canExcel = false;
              }
            }
            if(req.validTo){
              const toTs2 = Date.parse(req.validTo);
              if(!isNaN(toTs2) && nowTs2 > toTs2){
                canExcel = false;
              }
            }
          }catch(e){}
        }

        excelBtn.style.display = canExcel ? '' : 'none';
      }
    }

    backdrop.classList.remove('hidden');
    backdrop.classList.add('show');
    backdrop.setAttribute('aria-hidden','false');
  },

  closeDetailModal(){
    const backdrop = document.getElementById('approvalDetailBackdrop');
    if(!backdrop) return;
    backdrop.classList.remove('show');
    backdrop.classList.add('hidden');
    backdrop.setAttribute('aria-hidden','true');
    this.currentDetailId = null;
  },

  approveCurrent(){
    const id = this.currentDetailId;
    const req = this.requests.find(r => r.id === id);
    if(!req) return;
    if(req.status !== 'REQUESTED'){
      alert('이미 처리된 건입니다.');
      return;
    }
    // 다단계 결재: 현재 차수의 승인자가 아닌 경우 승인 불가
    if(!this._canCurrentUserApprove(req)){
      alert('현재 결재 차수의 승인자가 아니어서 승인할 수 없습니다.');
      return;
    }

    const backdrop = document.getElementById('approvalDetailBackdrop');
    const execCountSel = backdrop ? backdrop.querySelector('#apDetailExecCount') : null;
    const allowed = execCountSel ? (parseInt(execCountSel.value,10) || 1) : 1;

    // 1) 결재선 정보가 없는 경우: 기존 단일 단계 승인 로직 (호환용)
    if(!Array.isArray(req.approvalSteps) || req.approvalSteps.length === 0 || typeof req.currentStepIndex !== 'number'){
      req.status = 'APPROVED';
      req.allowedExecCount = allowed;
      req.usedExecCount = req.usedExecCount || 0;
      req.approvedAt = new Date();
      req.approver = this._currentUser();
      req.approverLabel = this._currentUserLabel();
      this.renderList();
    this.closeDetailModal();
      return;
    }

    const steps = req.approvalSteps;
    const idx = req.currentStepIndex;
    if(idx < 0 || idx >= steps.length){
      alert('현재 결재 차수 정보를 찾을 수 없습니다.');
      return;
    }

    const step = steps[idx];
    if(!step || (step.type || 'approval') !== 'approval'){
      alert('현재 결재 차수의 정보가 올바르지 않습니다.');
      return;
    }

    const now = new Date();

    // 현재 차수 승인 처리
    step.status = 'APPROVED';
    step.decidedAt = now;
    step.approverSessionId = this._currentUser();
    step.approverLabel = this._currentUserLabel();

    // 실행 허용 횟수는 전체 건 단위이므로 여기서 갱신
    req.allowedExecCount = allowed;
    req.usedExecCount = req.usedExecCount || 0;

    // 2) 다음 승인 차수 찾기
    let nextIdx = null;
    for(let i = idx + 1; i < steps.length; i++){
      const s = steps[i];
      if(s && (s.type || 'approval') === 'approval'){
        nextIdx = i;
        break;
      }
    }

    if(nextIdx !== null){
      // 아직 남은 승인자가 있는 경우: 상태는 계속 REQUESTED, currentStepIndex만 다음으로 이동
      req.currentStepIndex = nextIdx;
      // 전체 상태는 '승인 대기'를 유지 (여전히 결재 진행 중)
      req.status = 'REQUESTED';
    }else{
      // 마지막 승인자까지 모두 승인한 경우: 최종 승인 처리
      req.currentStepIndex = null;
      req.status = 'APPROVED';
      req.approvedAt = now;
      req.approver = this._currentUser();
      req.approverLabel = this._currentUserLabel();
    }

    this.renderList();
    this.closeDetailModal();
  },

  rejectCurrent(){
    const id = this.currentDetailId;
    const req = this.requests.find(r => r.id === id);
    if(!req) return;
    if(req.status !== 'REQUESTED'){
      alert('이미 처리된 건입니다.');
      return;
    }
    // 다단계 결재: 현재 차수의 승인자가 아닌 경우 반려 불가
    if(!this._canCurrentUserApprove(req)){
      alert('현재 결재 차수의 승인자가 아니어서 반려할 수 없습니다.');
      return;
    }
    const reason = window.prompt('반려 사유를 입력하세요.', '');
    if(reason === null) return;

    const now = new Date();

    // 1) 결재선 정보가 없는 경우: 기존 단일 단계 반려 로직 (호환용)
    if(!Array.isArray(req.approvalSteps) || req.approvalSteps.length === 0 || typeof req.currentStepIndex !== 'number'){
      req.status = 'REJECTED';
      req.rejectReason = reason;
      req.rejectedAt = now;
      req.approver = this._currentUser();
      req.approverLabel = this._currentUserLabel();
      this.renderList();
    this.closeDetailModal();
      return;
    }

    const steps = req.approvalSteps;
    const idx = req.currentStepIndex;
    if(idx < 0 || idx >= steps.length){
      alert('현재 결재 차수 정보를 찾을 수 없습니다.');
      return;
    }

    const step = steps[idx];
    if(!step || (step.type || 'approval') !== 'approval'){
      alert('현재 결재 차수의 정보가 올바르지 않습니다.');
      return;
    }

    // 현재 차수 반려 처리
    step.status = 'REJECTED';
    step.decidedAt = now;
    step.approverSessionId = this._currentUser();
    step.approverLabel = this._currentUserLabel();

    // 전체 건은 즉시 반려 완료
    req.status = 'REJECTED';
    req.rejectReason = reason;
    req.rejectedAt = now;
    req.currentStepIndex = null;
    req.approver = this._currentUser();
    req.approverLabel = this._currentUserLabel();

    this.renderList();
    this.closeDetailModal();
  },

  confirmRefCurrent(){
    const id = this.currentDetailId;
    const req = this.requests.find(r => r.id === id);
    if(!req) return;

    const me = this._currentUser();
    const label = this._currentUserLabel ? this._currentUserLabel() : '';

    if(!me){
      alert('로그인 정보를 확인할 수 없습니다.');
      return;
    }

    if(!Array.isArray(req.approvalSteps) || req.approvalSteps.length === 0){
      alert('참조 대상이 아닌 결재선입니다.');
      return;
    }

    const now = new Date();
    let updated = false;

    req.approvalSteps.forEach(function(step){
      if(!step) return;
      const type = step.type || 'approval';
      const st   = step.status || 'NONE';
      if(type === 'ref' && step.empId === me && st !== 'CONFIRMED'){
        step.status = 'CONFIRMED';
        step.decidedAt = now;
        step.approverSessionId = me;
        step.approverLabel = label;
        updated = true;
      }
    });

    if(!updated){
      alert('참조 대상이 아니거나 이미 참조 확인한 건입니다.');
      return;
    }

    this.renderList();
    this.closeDetailModal();
  },

  executeCurrent: async function(){
    const id = this.currentDetailId;
    const req = this.requests.find(r => r.id === id);
    if(!req) return;

    // 요청자만 실행 가능
    if(req.requester !== this._currentUser()){
      alert('승인된 쿼리는 요청자만 실행할 수 있습니다.');
      return;
    }

    if(req.status !== 'APPROVED' && req.status !== 'EXECUTED'){
      alert('승인된 건만 실행할 수 있습니다.');
      return;
    }
    if(req.allowedExecCount && typeof req.usedExecCount === 'number' && req.usedExecCount >= req.allowedExecCount){
      alert('허용 실행 횟수를 초과했습니다.');
      return;
    }

    if(!state.connected){
      alert('DB 연결 후 실행하세요.');
      return;
    }
    if(!req.connId || !state.connStates[req.connId]){
      // 실제 서비스에서는 결재 시점의 DB/스키마와 동일하게 다시 연결했는지 검증해야 하지만,
      //  버전에서는 현재 연결 기준으로 계속 진행한다.
      console.warn('결재 시점의 연결 정보(state.connStates)를 찾지 못했습니다. 에서는 현재 연결로 계속 진행합니다.');
    }

    try{
      // 실행 가능 횟수 및 유효 기간 검증
      if(req.allowedExecCount && req.usedExecCount >= req.allowedExecCount){
        alert('허용된 실행 횟수를 초과했습니다.');
        return;
      }
      if(req.validFrom || req.validTo){
        const nowTs = Date.now();
        try{
          if(req.validFrom){
            const fromTs = Date.parse(req.validFrom);
            if(!isNaN(fromTs) && nowTs < fromTs){
              alert('아직 유효 기간이 시작되지 않아 실행할 수 없습니다.');
              return;
            }
          }
          if(req.validTo){
            const toTs = Date.parse(req.validTo);
            if(!isNaN(toTs) && nowTs > toTs){
              alert('유효 기간이 경과되어 실행할 수 없습니다.');
              return;
            }
          }
        }catch(e){}
      }

      const result = await actions.runApprovedSql(req.sql, req.connId, { approvalId: req.id });
      if(result && result.ok){
        req.usedExecCount = (req.usedExecCount || 0) + 1;
        req.lastRowCount = result.rowCount;
        req.executedAt = new Date();
        if(!req.allowedExecCount || req.usedExecCount >= req.allowedExecCount){
          req.status = 'EXECUTED';
        }
        this.renderList();
        this.closeDetailModal();
      }
    }catch(e){
      console.error('executeCurrent failed', e);
      alert('승인된 쿼리 실행 중 오류가 발생했습니다.');
    }
  },

  downloadExcelForCurrent: async function(){
    const id = this.currentDetailId;
    const req = this.requests.find(r => r.id === id);
    if(!req) return;

    const type = req.approvalType || req.type || 'SQL_EXECUTE';
    if(type !== 'EXCEL_EXPORT'){
      alert('엑셀 내보내기 요청이 아닙니다.');
      return;
    }

    const me = this._currentUser();
    if(!me){
      alert('로그인 정보를 확인할 수 없습니다.');
      return;
    }
    if(req.requester !== me){
      alert('엑셀 다운로드는 요청자만 실행할 수 있습니다.');
      return;
    }

    if(req.status !== 'APPROVED' && req.status !== 'EXECUTED'){
      alert('승인 완료된 엑셀 내보내기 요청만 다운로드할 수 있습니다.');
      return;
    }

    if(!state.connected){
      alert('DB 연결 후 실행하세요.');
      return;
    }
    if(!req.connId || !state.connStates[req.connId]){
      // TODO: 실제 서비스에서는 결재 시점의 DB/스키마와 동일하게 다시 연결했는지 검증해야 함.
      // /프론트 단독 버전에서는 현재 연결 기준으로 계속 진행한다.
      console.warn('결재 시점의 연결 정보를 찾지 못했습니다. 에서는 현재 연결로 계속 진행합니다.', req.connId, state.connStates);
      // return; // 에서는 막지 않음
    }

    // 유효 기간이 설정되어 있을 경우, 범위 외에는 다운로드 불가
    if(req.validFrom || req.validTo){
      const nowTs = Date.now();
      try{
        if(req.validFrom){
          const fromTs = Date.parse(req.validFrom);
          if(!isNaN(fromTs) && nowTs < fromTs){
            alert('아직 유효 기간이 시작되지 않아 엑셀을 다운로드할 수 없습니다.');
            return;
          }
        }
        if(req.validTo){
          const toTs = Date.parse(req.validTo);
          if(!isNaN(toTs) && nowTs > toTs){
            alert('유효 기간이 경과되어 엑셀을 다운로드할 수 없습니다.');
            return;
          }
        }
      }catch(e){}
    }

    try{
      // 승인된 쿼리를 한 번 실행하여 state.lastResult를 최신 상태로 만든 뒤,
      // 기존 Excel 감사/반출 모달(actions.exportCsv)을 호출한다.
      const result = await actions.runApprovedSql(req.sql, req.connId, { approvalId: req.id, mode: 'EXCEL_EXPORT' });
      if(result && result.ok){
        req.usedExecCount = (req.usedExecCount || 0) + 1;
        req.lastRowCount = result.rowCount;
        req.executedAt = new Date();
        if(!req.allowedExecCount || req.usedExecCount >= req.allowedExecCount){
          req.status = 'EXECUTED';
        }
        this.renderList();

        // 결재 후 실제 엑셀 내보내기 로그 (approved=true, mode='APPROVAL')
        try{
          const meta2 = getCurrentResultMeta() || {
            sql: req.sql,
            rowCount: result.rowCount,
            tableNames: [],
            userId: req.requester
          };
          logExcelExport(meta2, {
            level: 'HIGH',
            reasons: req.riskReasons || [],
            approved: true,
            approvalId: req.id || null,
            mode: 'APPROVAL'
          });
        }catch(e2){
          console.warn('logExcelExport from downloadExcelForCurrent failed', e2);
        }

        // state.lastResult를 기반으로 결재 사유를 이용해 바로 엑셀 내보내기 수행
        actions.exportCsvFromApproval(req);
        // 결재창(상세 모달) 닫기
        this.closeDetailModal();
      }
    }catch(e){
      console.error('downloadExcelForCurrent failed', e);
      alert('엑셀 내보내기 중 오류가 발생했습니다.');
    }
  }

};
/* -------------------------------------------------------------------- */

/* ---------------- Explain / Plan Analysis (Lightweight) ---------------- */

const planAnalyzer = {
  extractPlanText(result){
    try{
      if(!result || !result.rows || !result.rows.length){ return ''; }
      const cols = result.columns || [];
      let colIndex = 0;
      let colName = cols[0] || null;
      for(let i=0;i<cols.length;i++){
        const c = (cols[i] || '').toString().toUpperCase();
        if(c === 'QUERY PLAN' || c === 'PLAN'){
          colIndex = i;
          colName = cols[i];
          break;
        }
      }
      const lines = result.rows.map(row=>{
        if(Array.isArray(row)){
          return row[colIndex] != null ? String(row[colIndex]) : '';
        }
        if(row && typeof row === 'object'){
          if(colName && Object.prototype.hasOwnProperty.call(row, colName)){
            return row[colName] != null ? String(row[colName]) : '';
          }
          const keys = Object.keys(row);
          if(keys.length){
            const k = keys[0];
            return row[k] != null ? String(row[k]) : '';
          }
        }
        return '';
      }).filter(Boolean);
      return lines.join('\n');
    }catch(e){
      console.warn('planAnalyzer.extractPlanText error', e);
      return '';
    }
  },
  analyze(planText){
    const text = (planText || '').trim();
    const res = {
      risk: 'ok',
      label: '성능 위험 낮음',
      summaryText: '',
      details: [],
      estRows: null,
      actualRows: null,
      costStart: null,
      costEnd: null,
      hasSeqScan: false,
      hasIndexScan: false,
      hasNestedLoop: false
    };
    if(!text){
      res.summaryText = '실행 계획이 없습니다.';
      return res;
    }
    const upper = text.toUpperCase();

    const costMatch = text.match(/cost\s*=\s*([0-9\.]+)\.\.([0-9\.]+)/i);
    if(costMatch){
      res.costStart = parseFloat(costMatch[1]);
      res.costEnd = parseFloat(costMatch[2]);
    }
    const estRowsMatch = text.match(/rows\s*=\s*([0-9]+)/i);
    if(estRowsMatch){
      res.estRows = parseInt(estRowsMatch[1], 10);
    }
    const actRowsMatch = text.match(/actual\s+rows\s*=\s*([0-9]+)/i);
    if(actRowsMatch){
      res.actualRows = parseInt(actRowsMatch[1], 10);
    }

    res.hasSeqScan = /SEQ\s+SCAN/i.test(upper);
    res.hasIndexScan = /INDEX\s+SCAN/i.test(upper) || /BITMAP\s+INDEX\s+SCAN/i.test(upper);
    const hasBitmap = /BITMAP\s+HEAP\s+SCAN/i.test(upper);
    res.hasNestedLoop = /NESTED\s+LOOP/i.test(upper);
    const hasHashJoin = /HASH\s+JOIN/i.test(upper);
    const hasMergeJoin = /MERGE\s+JOIN/i.test(upper);

    let maxRows = 0;
    if(typeof res.estRows === 'number'){ maxRows = Math.max(maxRows, res.estRows); }
    if(typeof res.actualRows === 'number'){ maxRows = Math.max(maxRows, res.actualRows); }
    const bigRows = maxRows >= 100000;

    if(res.hasSeqScan){
      res.details.push('Seq Scan 검출: 전체 테이블 스캔입니다.');
    }
    if(res.hasNestedLoop){
      res.details.push('Nested Loop 조인 사용.');
    }
    if(bigRows){
      res.details.push('예상/실제 Row가 많습니다 (≈ ' + maxRows.toLocaleString('en-US') + ' rows).');
    }
    if(bigRows && !res.hasIndexScan && res.hasSeqScan){
      res.details.push('대량 Row + Seq Scan인데 인덱스 사용 흔적이 없습니다. 인덱스 추가/튜닝을 검토하세요.');
    }
    if(!bigRows && res.hasSeqScan && !res.hasIndexScan){
      res.details.push('현재 계획에서는 Index Scan이 감지되지 않고 Seq Scan 위주입니다. 인덱스 사용 가능 여부를 확인해 보세요.');
    }
    if(res.hasNestedLoop && bigRows){
      res.details.push('Nested Loop + 대량 Row 조합입니다. 조인 전략/인덱스 점검이 필요할 수 있습니다.');
    }

    let riskScore = 0;
    if(res.hasSeqScan) riskScore = Math.max(riskScore, 1);
    if(bigRows && !res.hasIndexScan) riskScore = Math.max(riskScore, 1);
    if(res.hasNestedLoop && bigRows) riskScore = Math.max(riskScore, 2);
    if(bigRows && !res.hasIndexScan && res.hasSeqScan) riskScore = Math.max(riskScore, 2);

    if(riskScore === 0){
      res.risk = 'ok';
      res.label = '성능 위험 낮음';
    }else if(riskScore === 1){
      res.risk = 'warn';
      res.label = '성능 주의 필요';
    }else{
      res.risk = 'danger';
      res.label = '성능 위험 높음';
    }

    const summaryParts = [];
    const rowParts = [];
    if(typeof res.estRows === 'number') rowParts.push('예상 rows≈' + res.estRows);
    if(typeof res.actualRows === 'number') rowParts.push('실제 rows≈' + res.actualRows);
    if(rowParts.length){ summaryParts.push(rowParts.join(', ')); }
    if(res.costStart != null && res.costEnd != null){
      summaryParts.push('cost≈' + res.costStart + '..' + res.costEnd);
    }
    const scanParts = [];
    if(res.hasSeqScan) scanParts.push('Seq Scan');
    if(res.hasIndexScan) scanParts.push('Index Scan');
    if(hasBitmap) scanParts.push('Bitmap Scan');
    if(res.hasNestedLoop) scanParts.push('Nested Loop');
    if(hasHashJoin) scanParts.push('Hash Join');
    if(hasMergeJoin) scanParts.push('Merge Join');
    if(scanParts.length){ summaryParts.push(scanParts.join(' · ')); }

    res.summaryText = summaryParts.join(' · ') || '요약 가능한 정보가 부족합니다.';

    if(res.summaryText){
      res.details.unshift('[요약] ' + res.summaryText);
    }

    if(res.details.length === 0){
      if(res.risk === 'ok'){
        res.details.push('명확한 성능 위험 패턴은 감지되지 않았습니다.');
      }else if(res.risk === 'warn'){
        res.details.push('일부 성능 주의 패턴이 감지되었습니다. 실행 계획을 상세 검토하세요.');
      }else{
        res.details.push('고위험 성능 패턴이 감지되었습니다. 인덱스/쿼리 구조 조정이 필요할 수 있습니다.');
      }
    }else{
      if(res.risk === 'warn'){
        res.details.push('추가 튜닝 여지가 있습니다. 실행 계획과 인덱스를 함께 검토해 보세요.');
      }else if(res.risk === 'danger'){
        res.details.push('실제 서비스에서는 실행 전에 DBA와 상의하는 것이 좋습니다.');
      }
    }

    return res;
  },
  escapeHtml(str){
    return String(str || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  },
  renderFromResult(result){
    const metaEl = document.getElementById('execMeta');
    const msgEl = document.getElementById('messages');
    if(!metaEl || !msgEl) return;

    const planText = this.extractPlanText(result);
    if(!planText.trim()){
      metaEl.textContent = '실행 계획: 분석할 데이터가 없습니다.';
      msgEl.textContent = '';
      return;
    }

    const a = this.analyze(planText);
    let cls = 'plan-summary-badge plan-ok';
    let icon = '<i class="fa-solid fa-circle-check"></i>';
    if(a.risk === 'warn'){
      cls = 'plan-summary-badge plan-warn';
      icon = '<i class="fa-solid fa-triangle-exclamation"></i>';
    }else if(a.risk === 'danger'){
      cls = 'plan-summary-badge plan-danger';
      icon = '<i class="fa-solid fa-fire"></i>';
    }

    const summaryHtml = this.escapeHtml(a.summaryText);
    metaEl.innerHTML = '실행 계획 <span class="' + cls + '">' + icon + '<span>' + summaryHtml + '</span></span>';
    msgEl.textContent = a.details.join('\n');
  },
  renderFromLastResult(){
    this.renderFromResult(state.lastResult || {});
  }
};
// --- SQL 저장 통합 모달 (파일/서버) ---
ui.openSqlSaveModal = function(){
  const el = document.getElementById('personalSqlSaveBackdrop');
  if(!el){
    alert('SQL 저장 UI 요소를 찾지 못했습니다.');
    return;
  }
  const tab = state.tabs.find(function(t){ return t.id === state.activeTabId; }) || null;
  const titleInput = document.getElementById('psSaveTitle');
  const infoSpan = document.getElementById('psSaveInfo');
  const preview = document.getElementById('psSavePreview');

  if(titleInput){
    titleInput.value = (tab && tab.title) ? tab.title : '';
  }
  if(infoSpan){
    infoSpan.textContent = tab ? (tab.title || tab.id) : '(활성 탭 없음)';
  }
  if(preview){
    try{
      const editorEl = document.getElementById('sqlEditor');
      const sql = (typeof cm !== 'undefined' && cm)
        ? cm.getValue()
        : (editorEl ? editorEl.value : '');
      preview.textContent = sql ? sql.slice(0, 800) : '';
    }catch(e){
      preview.textContent = '';
    }
  }

  const radios = document.querySelectorAll('input[name="psSaveTarget"]');
  if(radios && radios.length){
    radios.forEach(function(r){
      r.checked = (r.value === 'server');
    });
  }

  el.classList.remove('hidden');
  el.classList.add('show');
  el.setAttribute('aria-hidden','false');
};

ui.closeSqlSaveModal = function(){
  const el = document.getElementById('personalSqlSaveBackdrop');
  if(!el) return;
  el.classList.remove('show');
  el.classList.add('hidden');
  el.setAttribute('aria-hidden','true');
};

ui.confirmSqlSave = function(){
  const editorEl = document.getElementById('sqlEditor');
  const sql = (typeof cm !== 'undefined' && cm)
    ? cm.getValue()
    : (editorEl ? editorEl.value : '');
  if(!sql || !sql.trim()){
    alert('저장할 SQL이 없습니다.');
    return;
  }

  // 저장 위치 결정 (기본: 서버)
  let target = 'server';
  const radios = document.querySelectorAll('input[name="psSaveTarget"]');
  if(radios && radios.length){
    radios.forEach(function(r){
      if(r.checked) target = r.value;
    });
  }

  const titleInput = document.getElementById('psSaveTitle');
  const baseTitle = (titleInput && titleInput.value) ? titleInput.value.trim() : '';

  if(target === 'file'){
    // 파일로 저장
    let raw = baseTitle;
    if(!raw){
      const tab = state.tabs.find(function(t){ return t.id === state.activeTabId; }) || null;
      raw = (tab && tab.title) ? tab.title : (state.activeTabId || 'sql_tab');
    }
    let safeTitle = raw ? raw.trim().replace(/\s+/g, '_').replace(/[\\/:*?"<>|]/g, '') : 'sql_tab';
    if(!safeTitle){
      safeTitle = 'sql_tab';
    }
    const fileName = safeTitle + '.sql';

    try{
      const blob = new Blob([sql], {type:'text/sql;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 0);
    }catch(e){
      console.warn('SQL 파일 저장 중 오류', e);
      alert('SQL 파일 저장 중 오류가 발생했습니다.');
    }

    ui.closeSqlSaveModal();
    return;
  }

  // 서버 개인 저장소 저장 (기존 confirmPersonalSqlSave 로직 유지)
  const descInput = document.getElementById('psSaveDesc');
  const desc = descInput ? descInput.value : '';
  // TODO: 서버 API 연동 시 baseTitle/desc/sql을 전송하는 로직을 추가
  alert('서버 개인 저장소 연동 전이라 실제 저장은 수행하지 않습니다.\nUI 흐름만 먼저 구현된 상태입니다.');
  ui.closeSqlSaveModal();
};

// 기존 함수명과의 호환 (기존 코드에서 사용 중일 수 있음)
ui.openPersonalSqlSave = function(){ ui.openSqlSaveModal(); };
ui.closePersonalSqlSave = function(){ ui.closeSqlSaveModal(); };
ui.confirmPersonalSqlSave = function(){ ui.confirmSqlSave(); };




/* ---------------- Actions (execute/explain/export) ---------------- */
const actions = {
  async runCurrent(){
    if(!state.connected){ console.warn('DB 연결 후 실행하세요 (에서는 계속 진행).'); }
    const sqlInfo = cm ? sqlSplit.selectedOrCurrent(cm) : { sql: ui.getEditor().trim() };
    const sql = (sqlInfo.sql||'').trim(); if(!sql){ return; }
    const tab = state.tabs.find(t=>t.id===state.activeTabId);
    const connId = tab && tab.connId ? tab.connId : null;
    if(!connId || !state.connStates[connId]){
      console.warn('이 탭의 연결을 선택/연결하세요 (에서는 계속 진행).', tab, state.connStates);
      // return; // 에서는 막지 않음
    }
    if(!security.beforeExecuteSingle(sql, connId)){
      ui.setExecMeta('위험 쿼리 감지 정책에 의해 실행이 취소되었습니다.');
      return;
    }
    if(typeof sessionMonitor!=='undefined' && sessionMonitor.markExecuting){
      sessionMonitor.markExecuting(connId, sql);
    }
    ui.showResult(); ui.setExecMeta('<span class="spin"></span> 실행 중…');
    if (typeof ui !== 'undefined' && typeof ui.beginQueryProgress === 'function') {
      ui.beginQueryProgress();
    }
    const result = await actions._runOne(sql, connId);
    if (typeof ui !== 'undefined' && typeof ui.endQueryProgress === 'function') {
      ui.endQueryProgress();
    }
    if(typeof sessionMonitor!=='undefined' && sessionMonitor.markFinished){
      sessionMonitor.markFinished(connId, { ok: !!(result && result.ok), lastSql: sql });
    }
    if(result && result.ok && tab){
      const execMetaHtml = document.getElementById('execMeta').innerHTML;
      const msgText = document.getElementById('messages').textContent;
      tab.result = {
        lastResult: Object.assign({}, state.lastResult),
        execMeta: execMetaHtml,
        messages: msgText
      };
      // 쿼리 히스토리 추가
      try{
        const d = new Date();
        const firstLine  = sql.split(/\r?\n/)[0].slice(0, 120);
        const accessInfo = (state.connAccessInfo && state.connAccessInfo[connId]) || {};
        historyPanel.add({
          ts: d,
          tsLabel: formatHistoryTime(d),
          connId,
          connLabel: getConnLabel(connId),
          tabId: tab.id,
          tabTitle: tab.title || tab.id,
          rowCount: result.rowCount,
          elapsedMs: result.elapsedMs,
          sql,
          sqlFirstLine: firstLine,
          accessReason: accessInfo.reason   || '',
          ticketId:     accessInfo.ticketId || ''
        });
      }catch(e){
        console.warn('history add failed (runCurrent)', e);
      }
    }
    return result;
  },
  async runApprovedSql(sql, connId, ctx){
    if(!state.connected){ console.warn('DB 연결 후 실행하세요 (에서는 계속 진행).'); }
    const tab = state.tabs.find(t=>t.id===state.activeTabId);
    if(!tab){
      alert('실행할 탭을 찾지 못했습니다.');
      return;
    }
    if(!connId || !state.connStates[connId]){
      console.warn('이 탭의 연결을 선택/연결하세요 (에서는 계속 진행).', connId, state.connStates);
      // return; // 에서는 막지 않음
    }
    if(typeof sessionMonitor!=='undefined' && sessionMonitor.markExecuting){
      sessionMonitor.markExecuting(connId, sql);
    }
    ui.showResult(); ui.setExecMeta('<span class="spin"></span> 승인된 쿼리 실행 중…');
    if (typeof ui !== 'undefined' && typeof ui.beginQueryProgress === 'function') {
      ui.beginQueryProgress();
    }
    const result = await actions._runOne(sql, connId);
    if (typeof ui !== 'undefined' && typeof ui.endQueryProgress === 'function') {
      ui.endQueryProgress();
    }
    if(typeof sessionMonitor!=='undefined' && sessionMonitor.markFinished){
      sessionMonitor.markFinished(connId, { ok: !!(result && result.ok), lastSql: sql });
    }
    if(result && result.ok && tab){
      const execMetaHtml = document.getElementById('execMeta').innerHTML;
      const msgText = document.getElementById('messages').textContent;
      tab.result = {
        lastResult: Object.assign({}, state.lastResult),
        execMeta: execMetaHtml,
        messages: msgText
      };
      try{
        const d = new Date();
        const firstLine  = sql.split(/\r?\n/)[0].slice(0, 120);
        const accessInfo = (state.connAccessInfo && state.connAccessInfo[connId]) || {};
        // 엑셀 다운로드(EXCEL_EXPORT)로 재실행되는 경우에는 히스토리에 중복으로 쌓지 않는다.
        const mode = ctx && ctx.mode;
        if(mode !== 'EXCEL_EXPORT'){
          historyPanel.add({
            ts: d,
            tsLabel: formatHistoryTime(d),
            connId,
            connLabel: getConnLabel(connId),
            tabId: tab.id,
            tabTitle: tab.title || tab.id,
            rowCount: result.rowCount,
            elapsedMs: result.elapsedMs,
            sql,
            sqlFirstLine: firstLine,
            accessReason: accessInfo.reason   || '',
            ticketId:     accessInfo.ticketId || ''
          });
        }
      }catch(e){
        console.warn('history add failed (runApprovedSql)', e);
      }
    }
    return result;
  },

  async runScript(){
    if(!state.connected){ console.warn('DB 연결 후 실행하세요 (에서는 계속 진행).'); }
    const tab = state.tabs.find(t=>t.id===state.activeTabId);
    const connId = tab && tab.connId ? tab.connId : null; if(!connId || !state.connStates[connId]){
      console.warn('이 탭의 연결을 선택/연결하세요 (에서는 계속 진행).', connId, state.connStates);
      // return; // 에서는 막지 않음
    }
    const stmts = cm ? sqlSplit.all(cm) : [{ text: ui.getEditor().trim() }];
    const execMsgs = [];
    ui.showResult();
    if (typeof ui !== 'undefined' && typeof ui.beginQueryProgress === 'function') {
      ui.beginQueryProgress('[스크립트 실행]');
    }
    if(typeof sessionMonitor!=='undefined' && sessionMonitor.markExecuting){
      sessionMonitor.markExecuting(connId, '[스크립트 실행]');
    }
    let totalRows = 0; let lastCols = 0; let totalMs = 0; let idx=0;
    for(const s of stmts){
      const sql = (s.text||'').trim(); if(!sql) continue; idx++;
      ui.setExecMeta(`<span class='spin'></span> 스크립트 실행 ${idx}/${stmts.length}…`);
      const r = await actions._runOne(sql, connId, true);
      if(r && r.ok){
        totalRows += r.rowCount||0;
        lastCols = r.colCount||0;
        totalMs += r.elapsedMs||0;
        execMsgs.push(`✔ [${idx}] rows=${r.rowCount} cols=${r.colCount} ${r.elapsedMs}ms`);
        // 각 문장별 히스토리도 남긴다
        try{
          const d = new Date();
          const firstLine  = sql.split(/\r?\n/)[0].slice(0, 120);
          const accessInfo = (state.connAccessInfo && state.connAccessInfo[connId]) || {};
          historyPanel.add({
            ts: d,
            tsLabel: formatHistoryTime(d),
            connId,
            connLabel: getConnLabel(connId),
            tabId: tab ? tab.id : null,
            tabTitle: tab && tab.title ? tab.title : (tab ? tab.id : ''),
            rowCount: r.rowCount,
            elapsedMs: r.elapsedMs,
            sql,
            sqlFirstLine: firstLine,
            accessReason: accessInfo.reason   || '',
            ticketId:     accessInfo.ticketId || ''
          });
        }catch(e){
          console.warn('history add failed (runScript)', e);
        }
      }else{
        execMsgs.push(`✖ [${idx}] 실패: ${r && r.error ? r.error: 'unknown'}`);
        break;
      }
    }
    document.getElementById('messages').textContent = execMsgs.join('\n');
    ui.setExecMeta(`스크립트 실행: ${idx}개 중 완료 · 총행 ${totalRows.toLocaleString()} · 마지막열 ${lastCols} · ~${totalMs} ms`);
    if(typeof sessionMonitor!=='undefined' && sessionMonitor.markFinished){
      sessionMonitor.markFinished(connId, { ok: true, lastSql: '[스크립트 실행]' });
    }
    if(tab){
      const execMetaHtml = document.getElementById('execMeta').innerHTML;
      const msgText = document.getElementById('messages').textContent;
      tab.result = {
        lastResult: Object.assign({}, state.lastResult),
        execMeta: execMetaHtml,
        messages: msgText
      };
    }
    if (typeof ui !== 'undefined' && typeof ui.endQueryProgress === 'function') {
      ui.endQueryProgress();
    }
  },
  async _runOne(sql, connId, silent){
    state.lastSql = sql;

    const accessInfo   = (state.connAccessInfo && connId) ? (state.connAccessInfo[connId] || {}) : {};
    const accessReason = accessInfo.reason   || '';
    const ticketId     = accessInfo.ticketId || '';

    try{
      if(USE_DEMO){
        const t0 = performance.now(); const mock = demo.exec(sql, connId); const t1 = performance.now();
        state.lastResult = {columns: mock.columns, rows: mock.rows, elapsedMs: Math.round(t1 - t0), rowCount: mock.rows.length};
        grid.render(mock.columns, mock.rows);
        if(!silent) ui.setExecMeta(`연결 ${connId} · 행 ${mock.rows.length.toLocaleString()} · ${mock.columns.length}열 · ${state.lastResult.elapsedMs} ms`);

        console.debug('DEMO exec meta', { connId, accessReason, ticketId });

        return { ok:true, rowCount: mock.rows.length, colCount: mock.columns.length, elapsedMs: state.lastResult.elapsedMs };
      }
      const controller = new AbortController();
      state.currentAbortController = controller;
      const timeout = setTimeout(()=> {
        controller.abort();
        state.currentAbortController = null;
      }, state.queryTimeoutMs || 15000);
      const payload = {
        connId,
        sql,
        maxRows: state.maxRows,
        timeoutMs: state.queryTimeoutMs || 15000,
        explain: false,
        accessReason,
        ticketId,
        autoCommit: state.autoCommit
      };
      const res = await fetch('/sql/execute', { method: 'POST', headers:{'Content-Type':'application/json'}, signal: controller.signal, body: JSON.stringify(payload) });
      clearTimeout(timeout);
      state.currentAbortController = null;
      if(!res.ok){ const txt = await res.text(); throw new Error(txt||res.statusText); }
      const data = await res.json();
      state.lastResult = {columns: data.columns||[], rows: data.rows||[], elapsedMs: data.elapsedMs||0, rowCount: (data.rows||[]).length};
      grid.render(state.lastResult.columns, state.lastResult.rows);
      if(!silent) ui.setExecMeta(`연결 ${connId} · 행 ${state.lastResult.rowCount.toLocaleString()} · ${state.lastResult.columns.length}열 · ${state.lastResult.elapsedMs} ms`);
      return { ok:true, rowCount: state.lastResult.rowCount, colCount: state.lastResult.columns.length, elapsedMs: state.lastResult.elapsedMs };
    }catch(err){ if(!silent) ui.setExecMeta(`<span class='warn'><i class="fa-solid fa-triangle-exclamation"></i> ${err.message||err}</span>`); return { ok:false, error: err.message||String(err) }; }
  },
  async runSql(){ // backward compat
    return await actions.runCurrent();
  },
  async explain(){
    if(!state.connected){ alert('DB 연결 후 실행하세요.'); return; }
    const sInfo = cm ? sqlSplit.selectedOrCurrent(cm) : { sql: ui.getEditor().trim() };
    const sql = (sInfo.sql||'').trim(); if(!sql){ return; }
    const tab = state.tabs.find(t=>t.id===state.activeTabId);
    const connId = tab && tab.connId ? tab.connId : null;
    if(!connId || !state.connStates[connId]){
      console.warn('이 탭의 연결을 선택/연결하세요 (에서는 계속 진행).', connId, state.connStates);
      // return; // 에서는 막지 않음
    }
    ui.showResult();

    if(USE_DEMO){
      const plan = [{"QUERY PLAN":"Seq Scan on foo  (cost=0.00..12.50 rows=5 width=4)"}];
      state.lastResult = {columns:['QUERY PLAN'], rows: plan, elapsedMs: 1, rowCount:1};
      grid.render(['QUERY PLAN'], plan);
      if(typeof planAnalyzer!=='undefined'){ planAnalyzer.renderFromLastResult(); }
      ui.setExecMeta('실행 계획 (모의 데이터)');
      if(tab){
        const execMetaHtml = document.getElementById('execMeta').innerHTML;
        const msgText = document.getElementById('messages').textContent;
        tab.result = {
          lastResult: Object.assign({}, state.lastResult),
          execMeta: execMetaHtml,
          messages: msgText
        };
      }
      return;
    }
    const res = await fetch('/sql/execute', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ connId, sql, maxRows: 500, timeoutMs: 15000, explain: true })});
    const data = await res.json();
    state.lastResult = {columns: data.columns||['QUERY PLAN'], rows: data.rows||[], elapsedMs: data.elapsedMs||0, rowCount: (data.rows||[]).length};
    grid.render(state.lastResult.columns, state.lastResult.rows);
    if(typeof planAnalyzer!=='undefined'){ planAnalyzer.renderFromLastResult(); }
    ui.setExecMeta('실행 계획');
    if(tab){
      const execMetaHtml = document.getElementById('execMeta').innerHTML;
      const msgText = document.getElementById('messages').textContent;
      tab.result = {
        lastResult: Object.assign({}, state.lastResult),
        execMeta: execMetaHtml,
        messages: msgText
      };
    }
  },
  
  // 실제 Excel 파일 생성 및 다운로드 (감사/반출 로직과 분리)
  _doExportExcel(){
    if(!state.lastResult || !state.lastResult.columns || !state.lastResult.columns.length){
      alert('내보낼 결과가 없습니다.');
      return;
    }
    const {columns, rows} = state.lastResult;

    const escHtml = (v)=>{
      const s = String(v == null ? '' : v);
      return s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };

    let html = '<table border="1"><thead><tr>';
    html += columns.map(c => '<th>' + escHtml(c) + '</th>').join('');
    html += '</tr></thead><tbody>';
    rows.forEach(r => {
      html += '<tr>' + columns.map(c => '<td>' + escHtml(r[c]) + '</td>').join('') + '</tr>';
    });
    html += '</tbody></table>';

    const blob = new Blob(['\ufeff' + html], {
      type: 'application/vnd.ms-excel;charset=utf-8;'
    });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'result.xls';
    a.click();
    URL.revokeObjectURL(a.href);
  },

  // 감사/반출용 모달을 거쳐 내보내기
  exportCsv(){
    if(!state.lastResult || !state.lastResult.columns || !state.lastResult.columns.length){
      alert('내보낼 결과가 없습니다.');
      return;
    }
    const lr = state.lastResult;
    const rowCount = typeof lr.rowCount === 'number' ? lr.rowCount : (lr.rows ? lr.rows.length : 0);
    const columns = lr.columns || [];
    const connId = state.connId;
    const activeConn = state.availableConns.find(c => c.id === connId);
    const connLabel = activeConn ? activeConn.label : (connId || '(미지정)');

    ui.openExportAuditModal({
      rowCount,
      columns,
      connId,
      connLabel,
      sql: state.lastSql || ''
    });
  },


  // 결재 승인 기반 엑셀 내보내기 (반출사유 재입력 모달 스킵)
  exportCsvFromApproval(req){
    if(!state.lastResult || !state.lastResult.columns || !state.lastResult.columns.length){
      alert('내보낼 결과가 없습니다.');
      return;
    }
    const lr = state.lastResult;
    const rowCount = typeof lr.rowCount === 'number' ? lr.rowCount : (lr.rows ? lr.rows.length : 0);
    const columns = lr.columns || [];
    const connId = state.connId;
    const activeConn = state.availableConns.find(c => c.id === connId);
    const connLabel = activeConn ? activeConn.label : (connId || '(미지정)');

    const reason = (req && req.reason) || '결재 기반 엑셀 내보내기';
    const approvalId = (req && (req.id || req.approvalId)) || '';

    try{
      actions._sendExportAuditLog({
        reason,
        approvalId,
        rowCount,
        columns,
        sql: (state.lastSql || (req && req.sql) || ''),
        connId,
        connLabel
      });
    }catch(e){
      console.warn('export audit log (from approval) error', e);
    }

    try{
      actions._doExportExcel();
    }catch(e){
      console.error('doExportExcel from approval failed', e);
      alert('엑셀 파일 생성 중 오류가 발생했습니다.');
    }
  },

  // 감사 로그 전송 (백엔드 연동용, 실패하더라도 내보내기는 계속)
  _sendExportAuditLog(payload){
    try{
      const body = Object.assign({}, payload || {}, {
        exportedAt: new Date().toISOString(),
        // 서버 세션에서 사용자 정보를 채우는 것을 권장.
        // 여기서는 프론트에서 넘길 수 있는 값만 예시로 포함.
        currentUser: (window.DBAM_CURRENT_USER || null)
      });

      if(window.DBAM_AUDIT_EXPORT_ENDPOINT){
        fetch(window.DBAM_AUDIT_EXPORT_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        }).catch(err=>{
          console.warn('export audit log send error', err);
        });
      }else{
        console.debug('export audit log (demo only):', body);
      }
    }catch(e){
      console.warn('export audit log exception', e);
    }
  },
  exportInsert(){
    const lr = state.lastResult;
    if(!lr || !lr.columns || !lr.columns.length){
      alert('내보낼 결과가 없습니다.');
      return;
    }
    let tableName = 'your_table';
    if(state.lastSql){
      const m = state.lastSql.match(/from\s+([a-zA-Z0-9_."`]+)/i);
      if(m && m[1]){
        tableName = m[1].replace(/["`]/g,'');
      }
    }
    const cols = lr.columns;
    const lines = [];
    lines.push('-- INSERT statements generated from last result');
    lines.push('-- 필요에 따라 테이블 이름을 수정하세요.');
    const rows = lr.rows || [];
    for(let i=0; i<rows.length; i++){
      const row = rows[i] || {};
      const vals = cols.map((c)=>{
        const v = row[c];
        if(v === null || v === undefined) return 'NULL';
        if(typeof v === 'number' || typeof v === 'bigint') return String(v);
        if(typeof v === 'boolean') return v ? 'TRUE' : 'FALSE';
        const s = String(v).replace(/'/g, "''");
        return "'" + s + "'";
      });
      const colList = cols.map(c=> '"' + c + '"').join(', ');
      const valList = vals.join(', ');
      lines.push('INSERT INTO ' + tableName + ' (' + colList + ') VALUES (' + valList + ');');
    }
    const text = lines.join('\n');
    actions._downloadText(text, 'insert_statements.sql');
  },
  copySql(){
    let sql = state.lastSql || '';
    if(!sql){
      sql = ui.getEditor();
    }
    if(!sql){
      alert('복사할 쿼리가 없습니다.');
      return;
    }
    const doSetMeta = (msg)=>{
      try{
        ui.setExecMeta(msg);
      }catch(e){}
    };
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(sql)
        .then(()=> doSetMeta('쿼리를 클립보드에 복사했습니다.'))
        .catch(()=>{ actions._fallbackCopy(sql); doSetMeta('쿼리를 클립보드에 복사했습니다.'); });
    }else{
      actions._fallbackCopy(sql);
      doSetMeta('쿼리를 클립보드에 복사했습니다.');
    }
  },
  _fallbackCopy(text){
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try{ document.execCommand('copy'); }catch(e){}
    document.body.removeChild(ta);
  },
  _downloadText(text, fileName){
    const blob = new Blob([text], {type:'text/plain;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  },
  openSampleSelect(schema, table, connId){ ui.newEditorTab(); if(connId){ ui.setActiveConn(connId); } ui.setEditor(`-- 샘플 조회
SELECT *
FROM ${schema}.${table}
LIMIT 100;`); },
  cancelQuery(){
    if(state.currentAbortController){
      try{
        state.currentAbortController.abort();
        ui.setExecMeta('<span class="warn"><i class="fa-solid fa-circle-stop"></i> 쿼리 정지 요청됨</span>');
      }catch(e){}
      state.currentAbortController = null;
    }else{
      alert('현재 실행 중인 쿼리가 없습니다.');
    }
  }
};

ui.setExecMeta = (html)=>{ document.getElementById('execMeta').innerHTML = html; };


// Tx & print helpers (actions)
actions.commitTx = async function(){
  alert('Commit/Rollback 제어는 아직 서버 연동 전입니다.\n백엔드 API 연동 후 이 함수에서 호출하도록 구현하면 됩니다.');
};

actions.rollbackTx = async function(){
  alert('Commit/Rollback 제어는 아직 서버 연동 전입니다.\n백엔드 API 연동 후 이 함수에서 호출하도록 구현하면 됩니다.');
};

actions.printCurrentSql = function(){
  const sql = cm ? cm.getValue() : (document.getElementById('sqlEditor') ? document.getElementById('sqlEditor').value : '');
  if(!sql || !sql.trim()){
    alert('인쇄할 SQL이 없습니다.');
    return;
  }
  const w = window.open('', '_blank');
  if(!w){
    alert('팝업이 차단되었습니다. 팝업 허용 후 다시 시도하세요.');
    return;
  }
  const esc = function(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); };
  w.document.write('<html><head><title>SQL Print</title>');
  w.document.write('<style>body{font-family:monospace;font-size:12px;padding:16px;}pre{white-space:pre-wrap;}</style>');
  w.document.write('</head><body><pre>');
  w.document.write(esc(sql));
  w.document.write('</pre></body></html>');
  w.document.close();
  try{ w.focus(); w.print(); }catch(e){}
};

actions.printCurrentResult = function(){
  const lr = state.lastResult || {};
  const cols = lr.columns || [];
  const rows = lr.rows || [];
  if(!cols.length || !rows.length){
    alert('인쇄할 결과가 없습니다.');
    return;
  }
  const w = window.open('', '_blank');
  if(!w){
    alert('팝업이 차단되었습니다. 팝업 허용 후 다시 시도하세요.');
    return;
  }
  const esc = function(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); };
  w.document.write('<html><head><title>Result Print</title>');
  w.document.write('<style>body{font-family:system-ui,sans-serif;font-size:12px;padding:16px;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:4px 6px;text-align:left;}th{background:#f3f4f6;font-weight:600;}</style>');
  w.document.write('</head><body><table><thead><tr>');
  cols.forEach(function(c){ w.document.write('<th>'+esc(c)+'</th>'); });
  w.document.write('</tr></thead><tbody>');
  rows.forEach(function(row){
    w.document.write('<tr>');
    cols.forEach(function(c){
      var v = row && typeof row === 'object' ? row[c] : '';
      if(v === null || v === undefined){ v = ''; }
      w.document.write('<td>'+esc(v)+'</td>');
    });
    w.document.write('</tr>');
  });
  w.document.write('</tbody></table></body></html>');
  w.document.close();
  try{ w.focus(); w.print(); }catch(e){}
};



/* ---------------- Demo Layer (fake connection & data) ---------------- */
const demo = {
  connectDemo(){ state.availableConns = [{id:'dev@postgres', label:'PostgreSQL (dev)'}]; state.connProfiles={}; state.connStates = {'dev@postgres': true}; state.connId='dev@postgres'; state.connected=true; ui.refreshConnStatus(); const data = { connections:[{ id:'dev@postgres', label:'PostgreSQL (dev)', profile:'LIMITED', schemas:[{ name:'public', tables:['member','orders','product'], views:['v_sales_daily'], functions:['fn_calc_tax(int)','fn_member_score(text)'], sequences:['seq_orders_id'] }]}] }; tree.render(data); ui.renderConnSelect(); ui.setActiveConn('dev@postgres'); ui.showResult(); },
  connectMulti(){ const data = { connections:[ { id:'dev@postgres', label:'PostgreSQL (dev)', profile:'LIMITED', schemas:[{ name:'public', tables:['member','orders','product'], views:['v_sales_daily'], functions:['fn_calc_tax(int)','fn_member_score(text)'], sequences:['seq_orders_id'] }]}, { id:'qa@postgres', label:'PostgreSQL (qa)', profile:'RO', schemas:[{ name:'public', tables:['member_q','orders_q'], views:['v_orders_today'], functions:['fn_q_sample()'], sequences:['seq_orders_q'] }]}, { id:'stg@mysql', label:'MySQL (staging)', profile:'LIMITED', schemas:[{ name:'shop', tables:['users','items','sales'], views:['v_sales_7d'], functions:['fn_price(varchar)'], sequences:[] }]}, { id:'dev@oracle', label:'Oracle (ops)', profile:'OPS', schemas:[{ name:'APP', tables:['TB_USER','TB_ORDER','TB_PRODUCT'], views:['VW_SALES'], functions:['FN_TAX(NUMBER)'], sequences:['SEQ_ORDER_ID'] }]} ]}; state.availableConns = data.connections.map(c=>({id:c.id, label:c.label})); state.connProfiles = {}; state.connStates = {}; state.connId=null; state.connected=false; tree.render(data); ui.renderConnSelect(); ui.refreshConnStatus(); },
  exec(sql, connId){
    const s = (sql || '').trim();

    // SELECT now()
    if(/select\s+now\(\)/i.test(s)){
      const now = new Date().toISOString();
      return {
        columns: ['now'],
        rows: [{ now }]
      };
    }

    // SELECT 1, SELECT 숫자
    const mNum = s.match(/^select\s+(\d+)\b/i);
    if(mNum){
      const v = Number(mNum[1]);
      return {
        columns: ['?column?'],
        rows: [{ '?column?': v }]
      };
    }

    //  기본 응답
    return {
      columns: ['result'],
      rows: [{ result: 'OK' }]
    };
  }
};

// small helper (not used by demo, kept as reference)
Date.prototype.toISOStringSafe = function(){ try { return this.toISOString(); } catch(e){ return new Date().toISOString(); } };

/* ---------------- Minimal Test Runner ---------------- */
const tests = { list: [], add(name, fn){ this.list.push({name, fn}); }, run(){ const out = []; let pass = 0; this.list.forEach(t=>{ try { t.fn(); out.push(`✔ ${t.name}`); pass++; } catch(err){ out.push(`✖ ${t.name} -> ${err.message}`); } }); const msg = `테스트: ${pass}/${this.list.length} 통과\n` + out.join('\n'); const box = document.getElementById('messages'); if(box){ box.textContent = msg; ui.showResult(); } return {pass, total:this.list.length}; } };

// --- 기존 테스트 유지 ---
tests.add('formatSql: SELECT/FROM 대문자화', ()=>{ ui.setEditor('select 1 from dual'); ui.formatSql(); const s = ui.getEditor(); if(!/SELECT\s+1\s+FROM\s+dual/i.test(s)) throw new Error('대문자화 또는 포맷 실패'); });

tests.add('connectMulti: 가용 커넥션 3개 이상', ()=>{ demo.connectMulti(); if(state.availableConns.length < 3) throw new Error('가용 커넥션 부족'); });

tests.add('openSampleSelect: 탭에 conn 지정 & SQL 템플릿', ()=>{ const targetConn = 'qa@postgres'; actions.openSampleSelect('public','member', targetConn); const tab = state.tabs.find(t=>t.id===state.activeTabId); if(tab.connId !== targetConn) throw new Error('탭 커넥션 설정 실패'); const sql = ui.getEditor(); if(!/FROM public\.member/i.test(sql)) throw new Error('SQL 템플릿 실패'); });

tests.add('grid.render: 2행 렌더링', ()=>{ grid.render(['a','b'], [{a:1,b:2},{a:3,b:4}]); const rows = document.querySelectorAll('#grid tbody tr').length; if(rows !== 2) throw new Error('행 수 불일치:'+rows); });

tests.add('demo.exec: now()', ()=>{ const r = demo.exec('select now()','dev@postgres'); if(!(r.columns && r.columns[0]==='now')) throw new Error('열명(now) 미검출'); });

// --- 신규 테스트: 비연결 기본 접힘, 해제시 접힘+라벨, 테마/키맵, 전역 내보내기, 에디터 컨텍스트 ---
tests.add('tree: 초기 비연결 트리 닫힘', ()=>{ demo.connectMulti(); const uls = document.querySelectorAll('#dbTree li[data-conn-id] > ul'); const allClosed = Array.from(uls).every(u=> getComputedStyle(u).display==='none'); if(!allClosed) throw new Error('초기 접힘 실패'); });

tests.add('tree: 연결해도 자동 전개 금지', ()=>{ demo.connectMulti(); const id = state.availableConns[0].id; ui.setActiveConn(id); const li = tree.getConnLi(id); const sub = li.querySelector(':scope > ul'); if(getComputedStyle(sub).display !== 'none') throw new Error('연결시 자동 전개됨'); });

tests.add('tree: 토글은 화살표로만', ()=>{
  demo.connectMulti();
  const id = state.availableConns[0].id;
  // ensure connected for this conn
  ui.setActiveConn(id);
  const li = tree.getConnLi(id);
  const node = li.querySelector(':scope > .node');
  const tw = node.querySelector('.tw');
  const sub = li.querySelector(':scope > ul');

  // 1) clicking node (not tw) should NOT expand
  node.click();
  if(getComputedStyle(sub).display !== 'none') throw new Error('노드 클릭으로 열리면 안됨');

  // 2) clicking tw should expand
  tw.click();
  if(getComputedStyle(sub).display === 'none') throw new Error('화살표 클릭으로 열리지 않음');

  // 3) disconnect and try arrow -> should stay closed
  state.connStates[id] = false; tree.updateConnBadges();
  // force collapsed and arrow reset handled by updateConnBadges
  if(getComputedStyle(sub).display !== 'none') throw new Error('해제 후에도 열림 유지됨');
  const before = tw.textContent;
  tw.click(); // should do nothing
  if(tw.textContent != before) throw new Error('해제 상태에서 화살표 변경되면 안됨');
});


tests.add('tree: 해제 시 접힘 + 라벨 discon', ()=>{ demo.connectMulti(); const id = state.availableConns[1].id; const li = tree.getConnLi(id); const tag = li.querySelector('.tag'); if(tag.textContent !== 'discon') throw new Error('초기 라벨 discon 아님'); ui.setActiveConn(id); state.connStates[id]=false; tree.updateConnBadges(); const sub = li.querySelector(':scope > ul'); if(getComputedStyle(sub).display!=='none') throw new Error('해제시 접힘 실패'); if(tag.textContent!=='discon') throw new Error('해제시 라벨 변경 실패'); });

tests.add('tree: Alt+클릭은 서브트리 전체 토글', ()=>{
  demo.connectMulti();
  const id = state.availableConns[0].id;
  ui.setActiveConn(id);
  const connLi = tree.getConnLi(id);
  const tw = connLi.querySelector(':scope > .node .tw');
  const schemaUl = connLi.querySelector(':scope > ul');
  if(!schemaUl) throw new Error('schema 목록 없음');
  // Alt+click expand all
  const ev = new MouseEvent('click', {bubbles:true, altKey:true});
  tw.dispatchEvent(ev);
  // expect at least one nested ul displayed
  const inner = connLi.querySelector(':scope ul ul');
  if(inner && getComputedStyle(inner).display==='none') throw new Error('서브트리 확장 실패');
  // Alt+click collapse all
  tw.dispatchEvent(new MouseEvent('click', {bubbles:true, altKey:true}));
  if(getComputedStyle(schemaUl).display!=='none') throw new Error('서브트리 접힘 실패');
});

tests.add('tree: ArrowRight/Left immediate 토글', ()=>{
  demo.connectMulti();
  const id = state.availableConns[0].id;
  ui.setActiveConn(id);
  const li = tree.getConnLi(id);
  const node = li.querySelector(':scope > .node');
  const sub = li.querySelector(':scope > ul');
  // ensure collapsed
  sub.style.display = 'none';
  // ArrowRight should expand immediate
  node.dispatchEvent(new KeyboardEvent('keydown', {key:'ArrowRight', bubbles:true}));
  if(getComputedStyle(sub).display==='none') throw new Error('ArrowRight 확장 실패');
  // ArrowLeft should collapse immediate
  node.dispatchEvent(new KeyboardEvent('keydown', {key:'ArrowLeft', bubbles:true}));
  if(getComputedStyle(sub).display!=='none') throw new Error('ArrowLeft 접힘 실패');
});


tests.add('editor: 키맵 기본 고정', ()=>{ if(window.CodeMirror){ ui.setTheme('default'); ui.setKeymap('vim'); if(cm.getOption('keyMap')!=='default') throw new Error('키맵이 default로 고정되지 않음'); } });
tests.add('globals: window 내보내기', ()=>{ if(!window.ui || !window.demo || !window.actions || !window.tree) throw new Error('전역 내보내기 실패'); });

tests.add('editorCtx: 존재/열고닫기', ()=>{ const el = document.getElementById('editorCtx'); if(!el) throw new Error('에디터 컨텍스트 메뉴 없음'); editorCtx.open(10,10); if(el.classList.contains('hidden')) throw new Error('컨텍스트 메뉴 오픈 실패'); editorCtx.hide(); if(!el.classList.contains('hidden')) throw new Error('컨텍스트 메뉴 닫기 실패'); });


tests.add('sqlSplit: 세미콜론/주석/따옴표 처리', ()=>{
  const s = "SELECT 1; SELECT 'a; b'; /*c;*/ SELECT 3;";
  const parts = sqlSplit.splitStatements(s);
  if(parts.length !== 3) throw new Error('분할 실패:'+parts.length);
  if(parts[1].text.indexOf("a; b")<0) throw new Error('인용부호 내 세미콜론 오인식');
});

tests.add('sqlSplit: 현재문 선택', ()=>{
  if(!window.CodeMirror) return;
  ui.setEditor("SELECT 1;\nSELECT 2;\nSELECT 3;");
  const doc = cm.getDoc();
  doc.setCursor({line:1,ch:5}); // in SELECT 2
  const pick = sqlSplit.selectedOrCurrent(cm);
  if(!/SELECT 2/.test(pick.sql)) throw new Error('현재문 선택 실패');
});

// --- 전역(window)으로 내보내기: inline onclick에서 참조 가능하도록 ---

/* ---------------- Admin / Management Console (조직·사용자·권한·정책·로그·리포트) --------- */

const admin = {
  sections: {
    orgUser: {
      title: '조직도 / 사용자 / 역할 관리',
      desc: '조직 구조, 사용자, 역할을 관리하고 DBAM 역할(운영자/보안/감사자 등)을 매핑하는 영역입니다.',
      items: [
        {
          id: 'org',
          label: '조직도 관리',
          icon: 'fa-sitemap',
          tags: ['조직', '부서', '시스템소유자'],
          spec: '조직 구조 및 시스템 소유자 등록/수정, 조직별 담당자 지정'
        },
        {
          id: 'user',
          label: '사용자 관리',
          icon: 'fa-user',
          tags: ['계정', '상태', 'MFA'],
          spec: '로그인 계정 생성/비활성, 잠금 현황, MFA 상태, 로그인 실패 이력 조회'
        },
        {
          id: 'role',
          label: '역할(권한) 관리',
          icon: 'fa-id-badge',
          tags: ['역할', '메뉴권한', '기능권한'],
          spec: 'DBAM 역할(일반사용자/승인자/운영자/보안/감사자 등) 정의 및 메뉴/기능 권한 매핑'
        },
        {
          id: 'publicAccount',
          label: '공용계정 사용 관리',
          icon: 'fa-users',
          tags: ['공용계정', '사유', '승인'],
          spec: '개인계정이 아닌 공용 DB 계정 사용 시 사유·승인 절차 및 사용자 매핑 관리'
        },
        {
          id: 'regularReview',
          label: '정기 권한 검토',
          icon: 'fa-clipboard-check',
          tags: ['정기점검', '부서장', '시스템담당'],
          spec: '부서장/시스템 담당자가 소속 인원의 권한을 주기적으로 검토·유지/회수/변경 기록'
        }
      ]
    },
    accessLifecycle: {
      title: '권한 신청·변경·회수 (ITSM 연계)',
      desc: 'ITSM/작업요청 티켓과 연계되는 권한 라이프사이클 관리 템플릿입니다.',
      items: [
        {
          id: 'accessRequest',
          label: '권한 신청/변경/회수 요청',
          icon: 'fa-paper-plane',
          tags: ['요청', '승인', '워크플로'],
          spec: '제목·요청 내용·결재자 정보를 입력해 ITSM 티켓 생성 화면 호출 (DBAM에서는 입력창 제공)'
        },
        {
          id: 'dbAccountLifecycle',
          label: 'DB 계정 발급/변경/삭제 요청',
          icon: 'fa-database',
          tags: ['계정발급', '권한변경', '회수'],
          spec: 'DB 계정 신규/권한 변경/삭제 요청 템플릿. 대상 DB·스키마·기간 등 필수 정보 관리'
        },
        {
          id: 'emergencyAccess',
          label: '응급(장애) 권한 요청·사용 이력',
          icon: 'fa-triangle-exclamation',
          tags: ['장애', '한시권한', '로그'],
          spec: '장애 시 한시적 고권한 요청/승인 및 사용 내역(실행 쿼리까지) 별도 트래킹'
        }
      ]
    },
    dbSensitive: {
      title: 'DB / 민감 정보 관리',
      desc: 'DB 접속 허용 범위와 민감정보(개인정보/중요정보)를 등록·관리하는 영역입니다.',
      items: [
        {
          id: 'dbRegistry',
          label: '데이터베이스 관리',
          icon: 'fa-server',
          tags: ['DB목록', '접속정보', '계정'],
          spec: '운영/개발 DB, 스키마, 계정, 접속 방식 등을 등록하고 응용시스템 계정과 매핑'
        },
        {
          id: 'sensitiveCatalog',
          label: '민감정보(테이블/컬럼) 목록',
          icon: 'fa-key',
          tags: ['주민번호', '계좌번호', '중요정보'],
          spec: '개인정보/중요정보가 포함된 테이블·컬럼 목록 관리, 마스킹/권한 정책과 연계'
        },
        {
          id: 'ipAllowList',
          label: 'DB 접속 허용 IP 관리',
          icon: 'fa-network-wired',
          tags: ['IP목록', '망대역', '검증로그'],
          spec: '허용된 접속 IP/망대역 목록 관리 및 접속 시 IP 검증 로그 조회'
        },
        {
          id: 'maskingPolicy',
          label: '민감 컬럼 마스킹 정책',
          icon: 'fa-user-secret',
          tags: ['마스킹', '비노출', '부분표시'],
          spec: '주민번호/계좌번호 등 민감정보 기본 마스킹, 예외/다운로드 시 정책 관리'
        }
      ]
    },
    scopePolicy: {
      title: '접근 범위·사전 차단 정책',
      desc: '사용자/역할별로 허용된 객체 범위와 사전 차단 규칙을 관리합니다.',
      items: [
        {
          id: 'objectScope',
          label: 'DB/스키마/테이블/컬럼 범위',
          icon: 'fa-table',
          tags: ['접근범위', '오브젝트', '세분화'],
          spec: '사용자/역할 단위로 접근 가능한 DB/스키마/테이블/컬럼 범위를 정의'
        },
        {
          id: 'preBlock',
          label: '허용 범위 밖 SQL 사전 차단',
          icon: 'fa-ban',
          tags: ['사전차단', '화이트리스트'],
          spec: '허용된 범위를 벗어나는 SQL은 실행 전에 차단하고 사유·로그 기록'
        },
        {
          id: 'downloadThreshold',
          label: '대량 조회/반출 임계값 정책',
          icon: 'fa-download',
          tags: ['대량조회', '다운로드', '임계값'],
          spec: '행 수/용량 기준 임계값 설정, 초과 시 추가 승인 또는 차단 정책 관리'
        },
        {
          id: 'timeLocationPolicy',
          label: '접속 위치/시간대 정책',
          icon: 'fa-clock',
          tags: ['야간', '휴일', '외부망'],
          spec: 'IP/망대역/시간대(업무시간/야간/휴일) 기반 접속 허용·제한 정책 정의'
        }
      ]
    },
    authPolicy: {
      title: '계정·비밀번호·MFA 정책',
      desc: '로그인 실패 제한, 잠금, 비밀번호 정책, MFA 적용 범위를 관리합니다.',
      items: [
        {
          id: 'loginLock',
          label: '로그인 실패 횟수·계정 잠금',
          icon: 'fa-lock',
          tags: ['실패횟수', '잠금', '해제'],
          spec: '로그인 실패 허용 횟수, 자동 잠금/해제 기준 및 잠금 이력 관리'
        },
        {
          id: 'passwordPolicy',
          label: '비밀번호 정책 관리',
          icon: 'fa-key',
          tags: ['길이', '복잡도', '변경주기', '재사용금지'],
          spec: '비밀번호 최소 길이, 복잡도, 주기적 변경, 재사용 금지 횟수 등 정책 설정'
        },
        {
          id: 'passwordResetLog',
          label: '비밀번호 초기화/임시 비밀번호 로그',
          icon: 'fa-scroll',
          tags: ['초기화', '임시비밀번호', '감사'],
          spec: '비밀번호 초기화 및 임시 비밀번호 발급 이력 조회'
        },
        {
          id: 'mfaPolicy',
          label: 'MFA 적용 정책 (관리자/특수 권한)',
          icon: 'fa-mobile-screen-button',
          tags: ['MFA', 'OTP', '고권한'],
          spec: '관리자·특수 권한 사용 시 MFA/OTP 의무 적용 범위 관리'
        }
      ]
    },
    sharedEmergency: {
      title: '공용·응급 계정 관리',
      desc: '공용계정 및 응급 권한 사용 시 사유/승인/이력 관리입니다.',
      items: [
        {
          id: 'sharedAccountReason',
          label: '공용계정 사용 사유·승인',
          icon: 'fa-users-gear',
          tags: ['공용계정', '사유', '승인'],
          spec: '공용 계정 사용 요청·승인 절차 및 사용 목적 관리'
        },
        {
          id: 'emergencyUseLog',
          label: '응급 권한 사용 내역',
          icon: 'fa-notes-medical',
          tags: ['장애', '임시권한', '쿼리기록'],
          spec: '응급 권한 사용 시 접속/쿼리/다운로드 기록을 별도 플래그로 관리'
        }
      ]
    },
    logAudit: {
      title: '로그 조회·감사 뷰',
      desc: '로그인/세션/DB 접속/SQL/다운로드/정책 변경 등 전체 로그를 조회하는 화면입니다.',
      items: [
        {
          id: 'activityLog',
          label: '사용자 활동 로그',
          icon: 'fa-person-walking',
          tags: ['로그인', '세션', '메뉴사용'],
          spec: '사용자가 로그인 후 수행한 주요 활동 로그(메뉴/기능/쿼리 요약) 조회'
        },
        {
          id: 'dbAccessLog',
          label: 'DB 접속·SQL 실행·다운로드 로그',
          icon: 'fa-file-lines',
          tags: ['DB접속', 'SQL', '다운로드'],
          spec: 'DB 접속/SQL 실행/다운로드 등 중요한 이벤트 로그를 필터링·검색'
        },
        {
          id: 'policyChangeLog',
          label: '정책 변경 이력',
          icon: 'fa-sliders',
          tags: ['정책', '변경', '감사'],
          spec: '접속/권한/마스킹 등 보안 정책 변경 내역 및 변경자 정보 확인'
        },
        {
          id: 'auditView',
          label: '보안담당/감사자 전용 뷰',
          icon: 'fa-magnifying-glass',
          tags: ['감사', '검색', '필터'],
          spec: '사용자, DB, 기간, 쿼리 등으로 상세 검색 가능한 감사 전용 로그 조회 화면'
        }
      ]
    },
    anomalyReport: {
      title: '이상행위 탐지·리포트',
      desc: '이상행위 탐지 프리셋과 월간/분기별 리포트 생성을 위한 영역입니다.',
      items: [
        {
          id: 'anomalyPreset',
          label: '이상행위 탐지 프리셋',
          icon: 'fa-wave-square',
          tags: ['대량다운로드', '야간접속', '반복실패'],
          spec: '대량 다운로드, 야간/휴일 접속, 반복 로그인 실패, 위험 쿼리 실행 등 탐지 조건 프리셋 관리'
        },
        {
          id: 'riskQueryFlag',
          label: '위험 쿼리 실행 세션 표시',
          icon: 'fa-bolt',
          tags: ['위험쿼리', '세션', '알림'],
          spec: '위험 쿼리 실행 세션에 별도 아이콘/알림을 제공하여 감사자 뷰와 연계'
        },
        {
          id: 'periodicReport',
          label: '월간/분기별 DB 접근 리포트',
          icon: 'fa-chart-column',
          tags: ['월간리포트', '분기점검', '코멘트'],
          spec: '월간/분기별 DB 접근 로그 요약 리포트를 자동 생성하고 점검 결과/조치 내역 코멘트 입력'
        }
      ]
    }
  },
  current: null,
  open(section) {
	  const ov = document.getElementById('adminOverlay');
	  if (ov) {
	    ov.classList.add('show');
	    ov.setAttribute('aria-hidden', 'false');
	  }
	  this.show(section || 'orgUser');
	},
  close(){
    const ov = document.getElementById('adminOverlay');
    if(!ov) return;
    ov.classList.remove('show');
    ov.setAttribute('aria-hidden','true');
  },

  show(section){
    this.current = section;
    const meta = this.sections[section] || this.sections.orgUser;
    const titleEl = document.getElementById('adminTitle');
    const descEl  = document.getElementById('adminDesc');
    const bodyEl  = document.getElementById('adminBody');
    if(!titleEl || !descEl || !bodyEl) return;

    titleEl.innerHTML = '<i class="fa-solid fa-shield-halved"></i> ' + meta.title;
    descEl.textContent = meta.desc;

    const buttons = document.querySelectorAll('.admin-nav button');
    buttons.forEach(btn=>{
      if(btn.dataset.section === section){
        btn.classList.add('active');
      }else{
        btn.classList.remove('active');
      }
    });

    bodyEl.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'admin-grid';

    (meta.items || []).forEach(it=>{
      const card = document.createElement('div');
      card.className = 'admin-card admin-card-clickable';
      const iconClass = it.icon || 'fa-circle-dot';
      card.innerHTML = '<h4><i class="fa-solid ' + iconClass + '"></i> ' + it.label + '</h4>' +
                       '<p>' + (it.spec || '') + '</p>';
      if(it.tags && it.tags.length){
        const tagsWrap = document.createElement('div');
        tagsWrap.className = 'admin-tags';
        it.tags.forEach(t=>{
          const span = document.createElement('span');
          span.className = 'admin-tag';
          span.textContent = t;
          tagsWrap.appendChild(span);
        });
        card.appendChild(tagsWrap);
      }
      const footer = document.createElement('div');
      footer.className = 'admin-footer';
      footer.textContent = '※ 상세 화면/연동은 서버 구현 단계에서 연결 예정';
      card.appendChild(footer);

   // (추가) card.innerHTML 세팅 직후~appendChild 직전 어딘가에
      card.dataset.section = section;
      card.dataset.itemId = it.id;

      card.setAttribute("role", "button");
      card.tabIndex = 0;

   // [PATCH] openItem이 없어도 카드 클릭이 죽지 않도록 안전 라우팅
      const go = () => {
		  if (typeof this.openItem === "function") {
		    return this.openItem(section, it.id, it.label);
		  }
		  // openItem이 없으면, 섹션별 attachXXXCardHandler가 화면 전환을 담당 (여기서는 에러만 막음)
		};


      card.addEventListener("click", (e) => {
        e.preventDefault();
        go();
      });

      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          go();
        }
      });
      
      grid.appendChild(card);
    });

    bodyEl.appendChild(grid);
  }
};

window.admin = admin;

/* =========================================================
 * [PATCH] orgUser 카드 클릭 라우팅 (단일 라우터, 시그니처 호환)
 * - admin.show()는 openItem(sectionId, itemId, label)로 호출
 * - 기존 일부 패치가 openItem(itemId, sectionId)로 만들어놔도 동작하게 흡수
 * ========================================================= */
 
 /* =========================================================
  * [PATCH] accessLifecycle 하위 메뉴 라우팅 등록
  * - 오류: [admin.openItem] no route: accessLifecycle accessRequest ...
  * - 대상: accessRequest / dbAccountLifecycle / emergencyAccess
  * ========================================================= */
 (function bindAccessLifecycleRoutes(){
   const W = window;
   const A = W.admin;
   if (!A || A.__accessLifecycleRouteFixV1) return;
   A.__accessLifecycleRouteFixV1 = true;

   const toast = W.toast || function(m){ alert(m); };

   function openByGlobalAdmin(globalKey, label){
     try{
       const mod = W[globalKey];
       if (mod && typeof mod.open === "function") return mod.open();
       toast(label + " 화면 모듈이 아직 준비되지 않았습니다.");
     }catch(e){
       console.error("[accessLifecycleRouteFix] open failed:", globalKey, e);
       toast(label + " 열기 실패");
     }
   }

   // 라우터 구현이 버전별로 달라도 동작하도록( __routeHandlers / __itemHandlers 모두 주입 )
   function bind(sectionId, itemId, fn){
     // 1) 공식 등록 함수가 있으면 우선 호출
     if (typeof A.registerItemHandler === "function"){
       try { A.registerItemHandler(sectionId, itemId, fn); } catch(_){}
       try { A.registerItemHandler(itemId, fn); } catch(_){}
     }

     // 2) 라우팅 저장소 직접 주입(서로 다른 openItem 구현 대응)
     A.__routeHandlers = A.__routeHandlers || {};
     A.__routeHandlers[sectionId] = A.__routeHandlers[sectionId] || {};
     A.__routeHandlers[sectionId][itemId] = fn;

     A.__itemHandlers = A.__itemHandlers || {};
     A.__itemHandlers[itemId] = fn;
     A.__itemHandlers[sectionId + "::" + itemId] = fn;
   }

   bind("accessLifecycle", "accessRequest",       () => openByGlobalAdmin("accessRequestAdmin",       "권한 신청/변경/회수 요청"));
   bind("accessLifecycle", "dbAccountLifecycle",  () => openByGlobalAdmin("dbAccountLifecycleAdmin",  "DB 계정 발급/변경/삭제 요청"));
   bind("accessLifecycle", "emergencyAccess",     () => openByGlobalAdmin("emergencyAccessAdmin",     "응급(장애) 권한 요청·사용 이력"));

 })();
 

 /* ===== [START] logAudit routes 통합 v2 (라우팅 테이블 1곳) ===== */
 (function bindLogAuditRoutesV2(){
   const W = window;
   const A = W.admin;
   if (!A || A.__logAuditRoutesV2) return;
   A.__logAuditRoutesV2 = true;

   // admin 버전 차이를 흡수: registerItemHandler + (__routeHandlers/__itemHandlers) 동시 주입
   function bind(sectionId, itemId, fn){
     if (typeof A.registerItemHandler === "function"){
       try { A.registerItemHandler(sectionId, itemId, fn); } catch(_){}
       try { A.registerItemHandler(itemId, fn); } catch(_){}
     }
     A.__routeHandlers = A.__routeHandlers || {};
     A.__routeHandlers[sectionId] = A.__routeHandlers[sectionId] || {};
     A.__routeHandlers[sectionId][itemId] = fn;

     A.__itemHandlers = A.__itemHandlers || {};
     A.__itemHandlers[itemId] = fn;
     A.__itemHandlers[sectionId + "::" + itemId] = fn;
   }

   function safeOpen(adminKey, altFns){
     const alts = Array.isArray(altFns) ? altFns : [];
     return function(){
       const m = W[adminKey];
       if (m && typeof m.open === "function") return m.open();
       for (const f of alts){
         if (m && typeof m[f] === "function") return m[f]();
       }
       console.warn("[logAudit] handler not ready:", adminKey);
       return false;
     };
   }

   function openStub(title, desc){
     return function(){
       const body = document.getElementById("adminBody");
       if (!body) return false;
       body.innerHTML = `
         <div class="emg-page" style="width:100%;">
           <div class="admin-card" style="padding:14px 16px;">
             <div class="admin-header" style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
               <h2 style="margin:0;font-size:16px;"><i class="fa-solid fa-circle-info"></i> ${title}</h2>
               <span class="badge">준비</span>
             </div>
             <p style="margin:10px 0 0;color:var(--muted);font-size:12px;line-height:1.5;">
               ${desc}
             </p>
             <div style="margin-top:12px;border-top:1px solid var(--line);padding-top:10px;color:var(--muted);font-size:12px;">
               라우팅은 연결되어 있으니, 나중에 실제 화면 모듈(open)만 붙이면 그대로 교체 가능합니다.
             </div>
           </div>
         </div>
       `;
       return true;
     };
   }

   // ✅ 이미 구현된 4개 (요청하신 통합 대상)
   bind("logAudit", "activityLog",      safeOpen("activityLogAdmin",      ["openActivityLog"]));
   bind("logAudit", "dbAccessLog",      safeOpen("dbAccessLogAdmin",      ["openDbAccessLog"]));
   bind("logAudit", "policyChangeLog",  safeOpen("policyChangeLogAdmin",  ["openPolicyChangeLog"]));
   bind("logAudit", "auditView",        safeOpen("auditViewAdmin",        ["openAuditView"]));

   // ✅ 아직 화면 모듈이 없는 4개 (no route 제거용: 스텁)
   bind("logAudit", "dbTxnLog",        openStub("트랜잭션/리두 로그 요약", "요약/지표 화면은 백엔드(리두/아카이브/로그 수집) 연동이 필요합니다."));
   bind("logAudit", "sessionManage",   openStub("세션 관리", "세션/락/장기세션 조회는 DB/API 연동이 필요합니다."));
   bind("logAudit", "externalArchive", openStub("주요 데이터 외부 저장 설정", "외부 저장소(S3/NAS/SIEM) 설정은 백엔드 연동이 필요합니다."));
   bind("logAudit", "systemInfo",      openStub("DBAM 시스템 정보", "버전/구성요소/라이선스/환경정보는 시스템 메타 API 연동이 필요합니다."));
 })();
 /* ===== [END] logAudit routes 통합 v2 ===== */


 
 /* ===== [START] scopePolicy 추가 카드(no route) 해결: 통합 모듈 + MockService + 라우팅 ===== */
 (function initScopePolicyAdvancedPolicies(){
   const W = window;
   const A = W.admin;
   if (!A || W.scopePolicyAdvPolicy) return;

   const toast = W.dbamToast || W.toast || function(m){ alert(m); };

   // --- Service Abstraction (나중에 API로 교체하기 쉽게 Adapter 형태 유지) ---
   const STORE_KEY = "dbam_scopePolicy_adv_v1";
   const Roles = ["DEV","DBA","AUDIT","SECURITY","OPS"];
   const Formats = ["CSV","XLSX","JSON"];

// --- SQL Allowlist (승인된 SQL 해시 임시 허용 목록) ---
// ※ 관리콘솔(Policy)에서만 등록/정리하고, 다른 화면(실행/차단)에서 참조할 수 있게 window로 노출
const ALLOWLIST_KEY = "dbam_scopePolicy_sql_allow_v1";

function nowISO(){ return new Date().toISOString(); }
function parseMs(v){ const t = Date.parse(v); return isFinite(t) ? t : 0; }

// 주석 제거 + 공백정리 + 대문자(정규화) → 동일 SQL을 같은 해시로 매핑
function normalizeSql(sql){
  return String(sql||"")
    .replace(/\/\*[\s\S]*?\*\//g, " ")
    .replace(/--.*$/mg, " ")
    .replace(/\s+/g, " ")
    .trim()
    .toUpperCase();
}

// 가벼운 동기 해시(FNV-1a 32bit) - 화면/로컬 검증용으로 충분
function fnv1a32(str){
  let h = 0x811c9dc5;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 0x01000193);
  }
  return (h>>>0);
}

function hashSql(sql){
  const norm = normalizeSql(sql);
  return "SQL-" + fnv1a32(norm).toString(16).padStart(8,"0");
}

function loadAllowlist(){
  try{
    const raw = localStorage.getItem(ALLOWLIST_KEY);
    return raw ? (JSON.parse(raw) || []) : [];
  }catch(_){ return []; }
}
function saveAllowlist(list){
  try{ localStorage.setItem(ALLOWLIST_KEY, JSON.stringify(list||[])); }catch(_){}
}
function cleanupAllowlist(list){
  const now = Date.now();
  return (list||[]).filter(x=>{
    if(!x || !x.hash) return false;
    if(x.validTo && parseMs(x.validTo) && parseMs(x.validTo) < now) return false;
    if(typeof x.remaining === "number" && x.remaining <= 0) return false;
    return true;
  });
}
function upsertAllowItem(item){
  let list = cleanupAllowlist(loadAllowlist());
  // 같은 hash + approvalId 는 갱신
  const idx = list.findIndex(x => x.hash===item.hash && (x.approvalId||"") === (item.approvalId||""));
  if(idx>=0) list[idx] = Object.assign({}, list[idx], item);
  else list.unshift(item);
  saveAllowlist(list);
  return item;
}
function removeAllowByHash(hash){
  const list = cleanupAllowlist(loadAllowlist()).filter(x => x.hash !== hash);
  saveAllowlist(list);
}

// 다른 화면에서도 “승인된 SQL인지” 확인할 수 있게 공개
window.dbamPolicyAllowlist = window.dbamPolicyAllowlist || {
  normalizeSql, hashSql,
  list: ()=> cleanupAllowlist(loadAllowlist()),
  isAllowed: (sql)=>{
    const h = hashSql(sql);
    const list = cleanupAllowlist(loadAllowlist());
    const hit = list.find(x=>x.hash===h);
    if(!hit) return null;

    const now = Date.now();
    if(hit.validFrom && parseMs(hit.validFrom) && parseMs(hit.validFrom) > now) return null;
    if(hit.validTo && parseMs(hit.validTo) && parseMs(hit.validTo) < now) return null;
    if(typeof hit.remaining === "number" && hit.remaining <= 0) return null;
    return hit;
  },
  consume: (sql)=>{
    const h = hashSql(sql);
    let list = cleanupAllowlist(loadAllowlist());
    const idx = list.findIndex(x=>x.hash===h);
    if(idx<0) return { ok:false, reason:"NOT_FOUND" };

    const it = list[idx];
    const now = Date.now();
    if(it.validFrom && parseMs(it.validFrom) && parseMs(it.validFrom) > now) return { ok:false, reason:"NOT_STARTED" };
    if(it.validTo && parseMs(it.validTo) && parseMs(it.validTo) < now) return { ok:false, reason:"EXPIRED" };
    if(typeof it.remaining === "number"){
      if(it.remaining<=0) return { ok:false, reason:"NO_REMAINING" };
      it.remaining -= 1;
    }
    list[idx] = it;
    saveAllowlist(list);
    return { ok:true, item: it };
  },
  removeByHash: removeAllowByHash,
  upsert: upsertAllowItem
};


   function deepClone(v){ return JSON.parse(JSON.stringify(v)); }
   function loadState(){
     const base = {
       approvals: [
         { id:"AP-1001", type:"RISK_QUERY", requester:"kim.dev", reason:"운영 장애 원인 분석", status:"PENDING", at:new Date().toISOString() },
         { id:"AP-1002", type:"EXPORT", requester:"lee.sec", reason:"감사 증적 제출", status:"APPROVED", at:new Date().toISOString() }
       ],
       exportPolicy: { formats:["CSV","XLSX"], maxRows: 5000, requireApproval:true, allowRoles:["DBA","SECURITY"] },
       queryTimeout: { defaultSec: 300, exceptions:[ { role:"DBA", sec:1800 } ] },
       transactionControl: { autoCommitDefault:false, allowManualCommit:true, requireApprovalOnCommit:false, allowRoles:["DBA","OPS"] }
     };
     try{
       const raw = localStorage.getItem(STORE_KEY);
       if (!raw) return base;
       const parsed = JSON.parse(raw);
       return Object.assign(base, parsed || {});
     }catch(_){
       return base;
     }
   }
   function saveState(st){
     try{ localStorage.setItem(STORE_KEY, JSON.stringify(st)); }catch(_){}
   }

   // Adapter(교체 포인트)
   const MockAdapter = {
     get(){ return deepClone(loadState()); },
     set(patch){
       const st = loadState();
       const next = Object.assign(st, patch || {});
       saveState(next);
       return deepClone(next);
     }
   };

   // --- UI Helper ---
   function setAdminPage(titleHtml, descText, bodyHtml){
     const ov = document.getElementById("adminOverlay");
     if (ov){ ov.classList.add("show"); ov.setAttribute("aria-hidden","false"); }

     // nav active 유지
     A.current = "scopePolicy";
     document.querySelectorAll(".admin-nav button").forEach(btn=>{
       btn.classList.toggle("active", btn.dataset.section === "scopePolicy");
     });

     const titleEl = document.getElementById("adminTitle");
     const descEl  = document.getElementById("adminDesc");
     const bodyEl  = document.getElementById("adminBody");
     if (!titleEl || !descEl || !bodyEl) return;

     titleEl.innerHTML = titleHtml;
     descEl.textContent = descText || "";
     bodyEl.innerHTML = bodyHtml || "";
     return bodyEl;
   }

   function badge(status){
     const map = {
       PENDING:  { t:"대기", bg:"#FEF3C7", fg:"#92400E" },
       APPROVED: { t:"승인", bg:"#DCFCE7", fg:"#166534" },
       REJECTED: { t:"반려", bg:"#FEE2E2", fg:"#991B1B" }
     };
     const s = map[status] || { t:status, bg:"#F3F4F6", fg:"#374151" };
     return `<span style="display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:${s.bg};color:${s.fg};font-weight:700;">${s.t}</span>`;
   }

   function headerActions(){
     return `
       <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:10px;">
         <div style="color:var(--muted);font-size:12px;">설정은 브라우저 저장소에 보관됩니다. (백엔드 연동 시 Adapter만 교체)</div>
         <div style="display:flex;gap:8px;">
           <button class="export-btn" data-sp-act="back"><i class="fa-solid fa-arrow-left"></i> 목록</button>
           <button class="export-btn" data-sp-act="reset"><i class="fa-solid fa-rotate-left"></i> 초기화</button>
         </div>
       </div>
     `;
   }

   // --- Renderers ---
   function renderQueryApproval(){
	   const st = MockAdapter.get();
	   const allowCount = (window.dbamPolicyAllowlist && window.dbamPolicyAllowlist.list)
	     ? window.dbamPolicyAllowlist.list().length
	     : 0;

	   const rows = (st.approvals || [])
	     .slice()
	     .sort((a,b)=> (b.at||"").localeCompare(a.at||""))
	     .map(r=>{
	       const h = r.sqlHash || (r.sql ? (window.dbamPolicyAllowlist ? window.dbamPolicyAllowlist.hashSql(r.sql) : "") : "");
	       const hashView = h ? `<code style="font-size:12px;">${h}</code>` : `<span style="color:var(--muted);font-size:12px;">-</span>`;
	       const ttlView = r.validTo ? `<div style="color:var(--muted);font-size:12px;white-space:nowrap;">~ ${String(r.validTo).slice(0,19).replace("T"," ")}</div>` : ``;

	       return `
	         <tr>
	           <td style="white-space:nowrap;">${r.id}</td>
	           <td style="white-space:nowrap;">${r.type}</td>
	           <td>${r.requester}</td>
	           <td>${r.reason}</td>
	           <td style="white-space:nowrap;">${hashView}${ttlView}</td>
	           <td style="white-space:nowrap;">${badge(r.status)}</td>
	           <td style="white-space:nowrap;">
	             ${r.status==="PENDING"
	               ? `<button class="export-btn" data-sp-act="approve" data-id="${r.id}">승인</button>
	                  <button class="export-btn" data-sp-act="reject" data-id="${r.id}">반려</button>`
	               : `<span style="color:var(--muted);font-size:12px;">-</span>`
	             }
	           </td>
	         </tr>
	       `;
	     }).join("");

	   const bodyEl = setAdminPage(
	     `<i class="fa-solid fa-stamp"></i> 쿼리 결재 관리`,
	     `위험 쿼리·대량 반출 요청을 접수/승인/반려로 관리합니다. (승인 시 SQL 해시를 임시 허용목록에 등록)`,
	     `
	     <div class="emg-page" style="width:100%;">
	       ${headerActions()}

	       <div class="admin-card" style="padding:12px 14px;">
	         <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
	           <div style="font-weight:800;">요청 추가</div>
	           <div style="color:var(--muted);font-size:12px;">임시 허용목록: <b>${allowCount}</b> 건</div>
	         </div>

	         <div style="display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:8px;align-items:end;margin-top:10px;">
	           <div>
	             <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">유형</div>
	             <select class="export-input" id="spApType">
	               <option value="RISK_QUERY">RISK_QUERY</option>
	               <option value="EXPORT">EXPORT</option>
	               <option value="DML">DML</option>
	             </select>
	           </div>
	           <div>
	             <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">요청자</div>
	             <input class="export-input" id="spApRequester" placeholder="예) hong.gildong" />
	           </div>
	           <div style="grid-column: span 2;">
	             <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">사유</div>
	             <input class="export-input" id="spApReason" placeholder="예) 운영 장애 원인 분석" />
	           </div>

	           <div style="grid-column: span 4;">
	             <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">SQL (선택)</div>
	             <textarea class="export-input" id="spApSql" rows="3"
	               placeholder="예) DELETE FROM T WHERE ...  /  SELECT ... (승인 시 SQL 해시가 허용목록에 등록됩니다)"></textarea>
	           </div>

	           <div>
	             <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">허용 횟수</div>
	             <input type="number" class="export-input" id="spApAllowCount" min="1" step="1" value="1" />
	           </div>
	           <div>
	             <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">유효 시간(분)</div>
	             <input type="number" class="export-input" id="spApTtlMin" min="1" step="1" value="120" />
	           </div>
	           <div style="grid-column: span 2; display:flex;gap:8px;justify-content:flex-end;">
	             <button class="export-btn" data-sp-act="addApproval"><i class="fa-solid fa-plus"></i> 요청 추가</button>
	           </div>
	         </div>
	       </div>

	       <div class="admin-card" style="padding:12px 14px;margin-top:10px;">
	         <div style="font-weight:800;margin-bottom:8px;">요청 목록</div>
	         <div class="table-scroll-x" style="border:1px solid var(--line);border-radius:10px;overflow:auto;">
	           <table style="width:100%;min-width:980px;border-collapse:collapse;">
	             <thead>
	               <tr style="background:#f9fafb;">
	                 <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">ID</th>
	                 <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">TYPE</th>
	                 <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">REQUESTER</th>
	                 <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">REASON</th>
	                 <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">SQL HASH / VALID</th>
	                 <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">STATUS</th>
	                 <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">ACTION</th>
	               </tr>
	             </thead>
	             <tbody>${rows || `<tr><td colspan="7" style="padding:12px;color:var(--muted);">데이터 없음</td></tr>`}</tbody>
	           </table>
	         </div>
	       </div>
	     </div>
	     `
	   );

	   bindEvents(bodyEl, "queryApproval");
	 }


   function renderExportPolicy(){
     const st = MockAdapter.get();
     const p = st.exportPolicy || {};
     const fmtChecks = Formats.map(f=>{
       const checked = (p.formats||[]).includes(f) ? "checked" : "";
       return `<label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" data-sp-act="toggleFmt" value="${f}" ${checked}/> <span>${f}</span></label>`;
     }).join("");

     const roleChecks = Roles.map(r=>{
       const checked = (p.allowRoles||[]).includes(r) ? "checked" : "";
       return `<label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" data-sp-act="toggleExportRole" value="${r}" ${checked}/> <span>${r}</span></label>`;
     }).join("");

     const bodyEl = setAdminPage(
       `<i class="fa-solid fa-file-export"></i> Export Data 정책`,
       `내보내기 형식/최대 건수/승인 필요 여부/허용 역할을 설정합니다. (실제 파일 다운로드 차단은 백엔드 필요)`,
       `
       <div class="emg-page" style="width:100%;">
         ${headerActions()}

         <div class="admin-card" style="padding:12px 14px;">
           <div style="display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px;">
             <div>
               <div style="font-weight:800;margin-bottom:8px;">허용 포맷</div>
               <div style="display:flex;gap:10px;flex-wrap:wrap;">${fmtChecks}</div>
             </div>
             <div>
               <div style="font-weight:800;margin-bottom:8px;">기본 제한</div>
               <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                 <div style="flex:1;min-width:180px;">
                   <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">최대 Rows</div>
                   <input type="number" class="export-input" id="spExportMaxRows" min="0" step="1" value="${Number(p.maxRows||0)}"/>
                 </div>
                 <label style="display:flex;gap:8px;align-items:center;">
                   <input type="checkbox" id="spExportRequireApproval" ${p.requireApproval ? "checked":""}/>
                   <span style="font-weight:700;">승인 필요</span>
                 </label>
                 <button class="export-btn" data-sp-act="saveExport"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
               </div>
             </div>
           </div>
         </div>

         <div class="admin-card" style="padding:12px 14px;margin-top:10px;">
           <div style="font-weight:800;margin-bottom:8px;">Export 허용 역할</div>
           <div style="display:flex;gap:10px;flex-wrap:wrap;">${roleChecks}</div>
           <div style="margin-top:10px;color:var(--muted);font-size:12px;">※ “승인 필요”가 켜져 있으면, Export 실행 전 결재 흐름으로 연계하는 것이 일반적입니다.</div>
         </div>
       </div>
       `
     );

     bindEvents(bodyEl, "exportPolicy");
   }

   function renderQueryTimeout(){
     const st = MockAdapter.get();
     const q = st.queryTimeout || {};
     const exRows = (q.exceptions||[]).map((x, idx)=>`
       <tr>
         <td style="padding:8px;border-bottom:1px solid var(--line);">${x.role}</td>
         <td style="padding:8px;border-bottom:1px solid var(--line);">${x.sec}</td>
         <td style="padding:8px;border-bottom:1px solid var(--line);">
           <button class="export-btn" data-sp-act="rmTimeoutEx" data-idx="${idx}">삭제</button>
         </td>
       </tr>
     `).join("");

     const roleOpts = Roles.map(r=>`<option value="${r}">${r}</option>`).join("");

     const bodyEl = setAdminPage(
       `<i class="fa-solid fa-clock-rotate-left"></i> 쿼리 타임아웃 설정`,
       `기본 타임아웃과 역할 예외를 설정합니다. (실제 DB 커넥션 cancel은 백엔드/드라이버 영역)`,
       `
       <div class="emg-page" style="width:100%;">
         ${headerActions()}

         <div class="admin-card" style="padding:12px 14px;">
           <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;">
             <div style="min-width:220px;">
               <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">기본 타임아웃(초)</div>
               <input type="number" class="export-input" id="spTimeoutDefault" min="0" step="1" value="${Number(q.defaultSec||0)}"/>
             </div>
             <button class="export-btn" data-sp-act="saveTimeout"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
           </div>
         </div>

         <div class="admin-card" style="padding:12px 14px;margin-top:10px;">
           <div style="font-weight:800;margin-bottom:8px;">역할 예외</div>
           <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;">
             <div style="min-width:180px;">
               <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">ROLE</div>
               <select class="export-input" id="spTimeoutRole">${roleOpts}</select>
             </div>
             <div style="min-width:220px;">
               <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">타임아웃(초)</div>
               <input type="number" class="export-input" id="spTimeoutSec" min="0" step="1" value="600"/>
             </div>
             <button class="export-btn" data-sp-act="addTimeoutEx"><i class="fa-solid fa-plus"></i> 추가</button>
           </div>

           <div class="table-scroll-x" style="margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow:auto;">
             <table style="width:100%;min-width:520px;border-collapse:collapse;">
               <thead>
                 <tr style="background:#f9fafb;">
                   <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">ROLE</th>
                   <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">TIMEOUT(SEC)</th>
                   <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">ACTION</th>
                 </tr>
               </thead>
               <tbody>${exRows || `<tr><td colspan="3" style="padding:12px;color:var(--muted);">예외 없음</td></tr>`}</tbody>
             </table>
           </div>
         </div>

         <div class="admin-card" style="padding:12px 14px;margin-top:10px;">
           <div style="font-weight:800;margin-bottom:8px;">타임아웃 시뮬레이터</div>
           <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;">
             <div style="min-width:180px;">
               <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">ROLE</div>
               <select class="export-input" id="spSimRole">${roleOpts}</select>
             </div>
             <div style="min-width:220px;">
               <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">실행 시간(초)</div>
               <input type="number" class="export-input" id="spSimRunSec" min="1" step="1" value="20"/>
             </div>
             <button class="export-btn" data-sp-act="simStart"><i class="fa-solid fa-play"></i> 시작</button>
             <button class="export-btn" data-sp-act="simStop"><i class="fa-solid fa-stop"></i> 중지</button>
           </div>
           <div id="spSimInfo" class="export-input" style="background:#f9fafb;margin-top:10px;">대기 중</div>
         </div>
       </div>
       `
     );

     bindEvents(bodyEl, "queryTimeout");
   }

   function renderTransactionControl(){
     const st = MockAdapter.get();
     const t = st.transactionControl || {};
     const roleChecks = Roles.map(r=>{
       const checked = (t.allowRoles||[]).includes(r) ? "checked" : "";
       return `<label style="display:flex;gap:6px;align-items:center;"><input type="checkbox" data-sp-act="toggleTxnRole" value="${r}" ${checked}/> <span>${r}</span></label>`;
     }).join("");

     const bodyEl = setAdminPage(
       `<i class="fa-solid fa-exchange-alt"></i> 트랜잭션 제어 정책`,
       `Auto-commit 기본값과 수동 Commit/Rollback 허용 여부를 설정합니다. (실제 강제는 백엔드 필요)`,
       `
       <div class="emg-page" style="width:100%;">
         ${headerActions()}

         <div class="admin-card" style="padding:12px 14px;">
           <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap;">
             <label style="display:flex;gap:8px;align-items:center;">
               <input type="checkbox" id="spAutoCommitDefault" ${t.autoCommitDefault ? "checked":""}/>
               <span style="font-weight:800;">Auto-commit 기본값</span>
             </label>
             <label style="display:flex;gap:8px;align-items:center;">
               <input type="checkbox" id="spAllowManualCommit" ${t.allowManualCommit ? "checked":""}/>
               <span style="font-weight:800;">수동 Commit/Rollback 허용</span>
             </label>
             <label style="display:flex;gap:8px;align-items:center;">
               <input type="checkbox" id="spRequireApprovalOnCommit" ${t.requireApprovalOnCommit ? "checked":""}/>
               <span style="font-weight:800;">Commit 시 승인 필요</span>
             </label>
             <button class="export-btn" data-sp-act="saveTxn"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
           </div>
         </div>

         <div class="admin-card" style="padding:12px 14px;margin-top:10px;">
           <div style="font-weight:800;margin-bottom:8px;">수동 트랜잭션 허용 역할</div>
           <div style="display:flex;gap:10px;flex-wrap:wrap;">${roleChecks}</div>
         </div>

         <div class="admin-card" style="padding:12px 14px;margin-top:10px;">
           <div style="font-weight:800;margin-bottom:8px;">트랜잭션 배너 시뮬레이터</div>
           <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;">
             <div style="min-width:180px;">
               <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">ROLE</div>
               <select class="export-input" id="spTxnSimRole">${Roles.map(r=>`<option value="${r}">${r}</option>`).join("")}</select>
             </div>
             <button class="export-btn" data-sp-act="txnOpen"><i class="fa-solid fa-bolt"></i> DML 실행(모의)</button>
           </div>
           <div id="spTxnBanner" style="display:none;margin-top:10px;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#f9fafb;">
             <div style="font-weight:800;">Auto-commit OFF: 트랜잭션이 열렸습니다</div>
             <div style="margin-top:8px;display:flex;gap:8px;">
               <button class="export-btn" data-sp-act="txnCommit">Commit</button>
               <button class="export-btn" data-sp-act="txnRollback">Rollback</button>
             </div>
             <div id="spTxnMsg" style="margin-top:8px;color:var(--muted);font-size:12px;"></div>
           </div>
         </div>
       </div>
       `
     );

     bindEvents(bodyEl, "transactionControl");
   }

   // --- Events (1곳에서 모드별 처리) ---
   let simTimer = null;

   function resetAll(){
     try{ localStorage.removeItem(STORE_KEY); }catch(_){}
     toast("초기화 완료");
   }

   function bindEvents(bodyEl, mode){
     if (!bodyEl) return;
     if (bodyEl.dataset.spBound === mode) return;
     bodyEl.dataset.spBound = mode;

     bodyEl.addEventListener("click", (e)=>{
       const t = e.target;
       const act = t && t.dataset ? t.dataset.spAct : null;
       if (!act) return;

       if (act === "back") { A.show("scopePolicy"); return; }
       if (act === "reset") { resetAll(); A.show("scopePolicy"); return; }

    // approvals
       if (act === "addApproval"){
         const st = MockAdapter.get();
         const type = (document.getElementById("spApType")||{}).value || "RISK_QUERY";
         const requester = (document.getElementById("spApRequester")||{}).value || "";
         const reason = (document.getElementById("spApReason")||{}).value || "";
         const sql = (document.getElementById("spApSql")||{}).value || "";
         const allowCount = Number((document.getElementById("spApAllowCount")||{}).value || 1);
         const ttlMin = Number((document.getElementById("spApTtlMin")||{}).value || 120);

         if (!requester.trim() || !reason.trim()){ toast("요청자/사유를 입력하세요."); return; }
         if (!isFinite(allowCount) || allowCount <= 0){ toast("허용 횟수를 올바르게 입력하세요."); return; }
         if (!isFinite(ttlMin) || ttlMin <= 0){ toast("유효 시간(분)을 올바르게 입력하세요."); return; }

         // ID는 랜덤 대신 증가 시퀀스로 생성
         const maxSeq = (st.approvals||[]).reduce((m,r)=>{
           const n = Number(String(r.id||"").split("-")[1]) || 0;
           return Math.max(m, n);
         }, 1000);
         const id = "AP-" + (maxSeq + 1);

         const at = nowISO();
         const validFrom = at;
         const validTo = new Date(Date.now() + ttlMin*60*1000).toISOString();

         st.approvals = st.approvals || [];
         st.approvals.push({
           id, type, requester, reason,
           sql,
           allowedExecCount: allowCount,
           ttlMin,
           validFrom,
           validTo,
           sqlHash: sql && sql.trim() ? (window.dbamPolicyAllowlist ? window.dbamPolicyAllowlist.hashSql(sql) : "") : "",
           status:"PENDING",
           at
         });

         MockAdapter.set({ approvals: st.approvals });
         renderQueryApproval();
         toast("요청이 추가되었습니다.");

         // 입력값 정리
         try{
           document.getElementById("spApRequester").value = "";
           document.getElementById("spApReason").value = "";
           document.getElementById("spApSql").value = "";
           document.getElementById("spApAllowCount").value = "1";
           document.getElementById("spApTtlMin").value = "120";
         }catch(_){}
         return;
       }

       if (act === "approve" || act === "reject"){
         const id = t.dataset.id;
         const st = MockAdapter.get();
         let target = null;

         st.approvals = (st.approvals||[]).map(r=>{
           if (r.id !== id) return r;
           target = Object.assign({}, r, {
             status: act==="approve" ? "APPROVED" : "REJECTED",
             decidedAt: nowISO(),
             approver: "SECURITY"
           });
           return target;
         });

         MockAdapter.set({ approvals: st.approvals });

         // 승인 시: SQL이 있으면 해시를 “임시 허용목록”에 등록
         if (act === "approve" && target && target.sql && target.sql.trim() && window.dbamPolicyAllowlist){
           const hash = window.dbamPolicyAllowlist.hashSql(target.sql);
           const maxCount = Number(target.allowedExecCount || 1) || 1;
           const validFrom = target.validFrom || nowISO();
           const validTo = target.validTo || new Date(Date.now() + (Number(target.ttlMin||120)||120)*60*1000).toISOString();

           window.dbamPolicyAllowlist.upsert({
             hash,
             approvalId: target.id,
             type: target.type,
             sql: target.sql,
             maxCount,
             remaining: maxCount,
             validFrom,
             validTo,
             approvedAt: target.decidedAt,
             approver: target.approver || "SECURITY"
           });

           // 화면에도 sqlHash/기간 확정값 반영
           st.approvals = (st.approvals||[]).map(r=>{
             if(r.id!==id) return r;
             return Object.assign({}, r, { sqlHash: hash, validFrom, validTo, allowedExecCount: maxCount });
           });
           MockAdapter.set({ approvals: st.approvals });
         }

         // 반려 시: (선택) 기존 허용목록에서 제거
         if (act === "reject" && target && target.sqlHash && window.dbamPolicyAllowlist){
           window.dbamPolicyAllowlist.removeByHash(target.sqlHash);
         }

         renderQueryApproval();
         toast(act==="approve" ? "승인 처리" : "반려 처리");
         return;
       }


       // export policy
       if (act === "saveExport"){
         const st = MockAdapter.get();
         st.exportPolicy = st.exportPolicy || {};
         const maxRows = Number((document.getElementById("spExportMaxRows")||{}).value || 0);
         const requireApproval = !!(document.getElementById("spExportRequireApproval")||{}).checked;
         st.exportPolicy.maxRows = isFinite(maxRows) ? maxRows : 0;
         st.exportPolicy.requireApproval = requireApproval;
         MockAdapter.set({ exportPolicy: st.exportPolicy });
         toast("저장 완료");
         return;
       }
       if (act === "toggleFmt"){
         const f = t.value;
         const st = MockAdapter.get();
         st.exportPolicy = st.exportPolicy || {};
         const set = new Set(st.exportPolicy.formats || []);
         if (t.checked) set.add(f); else set.delete(f);
         st.exportPolicy.formats = Array.from(set);
         MockAdapter.set({ exportPolicy: st.exportPolicy });
         return;
       }
       if (act === "toggleExportRole"){
         const r = t.value;
         const st = MockAdapter.get();
         st.exportPolicy = st.exportPolicy || {};
         const set = new Set(st.exportPolicy.allowRoles || []);
         if (t.checked) set.add(r); else set.delete(r);
         st.exportPolicy.allowRoles = Array.from(set);
         MockAdapter.set({ exportPolicy: st.exportPolicy });
         return;
       }

       // timeout
       if (act === "saveTimeout"){
         const st = MockAdapter.get();
         st.queryTimeout = st.queryTimeout || {};
         const v = Number((document.getElementById("spTimeoutDefault")||{}).value || 0);
         st.queryTimeout.defaultSec = isFinite(v) ? v : 0;
         MockAdapter.set({ queryTimeout: st.queryTimeout });
         toast("저장 완료");
         return;
       }
       if (act === "addTimeoutEx"){
         const st = MockAdapter.get();
         st.queryTimeout = st.queryTimeout || {};
         st.queryTimeout.exceptions = st.queryTimeout.exceptions || [];
         const role = (document.getElementById("spTimeoutRole")||{}).value || "DEV";
         const sec = Number((document.getElementById("spTimeoutSec")||{}).value || 0);
         if (!isFinite(sec) || sec <= 0){ toast("타임아웃(초)을 올바르게 입력하세요."); return; }
         // role 중복이면 교체
         st.queryTimeout.exceptions = st.queryTimeout.exceptions.filter(x=>x.role!==role);
         st.queryTimeout.exceptions.push({ role, sec });
         MockAdapter.set({ queryTimeout: st.queryTimeout });
         renderQueryTimeout();
         toast("예외가 추가/갱신되었습니다.");
         return;
       }
       if (act === "rmTimeoutEx"){
         const idx = Number(t.dataset.idx);
         const st = MockAdapter.get();
         st.queryTimeout = st.queryTimeout || {};
         st.queryTimeout.exceptions = (st.queryTimeout.exceptions||[]).filter((_,i)=> i!==idx);
         MockAdapter.set({ queryTimeout: st.queryTimeout });
         renderQueryTimeout();
         toast("삭제 완료");
         return;
       }
       if (act === "simStart"){
         const st = MockAdapter.get();
         const role = (document.getElementById("spSimRole")||{}).value || "DEV";
         const runSec = Number((document.getElementById("spSimRunSec")||{}).value || 1);
         const info = document.getElementById("spSimInfo");
         const base = Number((st.queryTimeout||{}).defaultSec || 0);
         const ex = ((st.queryTimeout||{}).exceptions || []).find(x=>x.role===role);
         const limit = ex ? Number(ex.sec) : base;

         if (!info){ toast("시뮬레이터 영역을 찾지 못했습니다."); return; }
         if (!isFinite(runSec) || runSec <= 0){ toast("실행 시간을 입력하세요."); return; }
         if (!isFinite(limit) || limit <= 0){ toast("타임아웃 설정이 0입니다. 먼저 설정하세요."); return; }

         if (simTimer) clearInterval(simTimer);
         let elapsed = 0;
         info.textContent = `RUNNING... role=${role}, limit=${limit}s, target=${runSec}s`;
         simTimer = setInterval(()=>{
           elapsed += 1;
           if (elapsed >= limit){
             clearInterval(simTimer); simTimer=null;
             info.textContent = `TIMEOUT! ${elapsed}s 경과로 중단 처리(모의)`;
             toast("타임아웃 발생");
             return;
           }
           if (elapsed >= runSec){
             clearInterval(simTimer); simTimer=null;
             info.textContent = `DONE. ${elapsed}s 완료(모의)`;
             toast("완료");
             return;
           }
           info.textContent = `RUNNING... ${elapsed}s / limit=${limit}s (target=${runSec}s)`;
         }, 1000);
         return;
       }
       if (act === "simStop"){
         const info = document.getElementById("spSimInfo");
         if (simTimer) clearInterval(simTimer);
         simTimer=null;
         if (info) info.textContent = "중지됨";
         return;
       }

       // transaction
       if (act === "saveTxn"){
         const st = MockAdapter.get();
         st.transactionControl = st.transactionControl || {};
         st.transactionControl.autoCommitDefault = !!(document.getElementById("spAutoCommitDefault")||{}).checked;
         st.transactionControl.allowManualCommit = !!(document.getElementById("spAllowManualCommit")||{}).checked;
         st.transactionControl.requireApprovalOnCommit = !!(document.getElementById("spRequireApprovalOnCommit")||{}).checked;
         MockAdapter.set({ transactionControl: st.transactionControl });
         toast("저장 완료");
         return;
       }
       if (act === "toggleTxnRole"){
         const r = t.value;
         const st = MockAdapter.get();
         st.transactionControl = st.transactionControl || {};
         const set = new Set(st.transactionControl.allowRoles || []);
         if (t.checked) set.add(r); else set.delete(r);
         st.transactionControl.allowRoles = Array.from(set);
         MockAdapter.set({ transactionControl: st.transactionControl });
         return;
       }
       if (act === "txnOpen"){
         const banner = document.getElementById("spTxnBanner");
         const msg = document.getElementById("spTxnMsg");
         if (banner){ banner.style.display="block"; }
         if (msg){ msg.textContent="DML 실행 후 트랜잭션이 열린 상태(모의)"; }
         return;
       }
       if (act === "txnCommit" || act === "txnRollback"){
         const st = MockAdapter.get();
         const role = (document.getElementById("spTxnSimRole")||{}).value || "DEV";
         const tpol = st.transactionControl || {};
         const banner = document.getElementById("spTxnBanner");
         const msg = document.getElementById("spTxnMsg");
         const allowed = (tpol.allowRoles||[]).includes(role);

         if (!allowed){
           if (msg) msg.textContent = `ROLE(${role})은 수동 트랜잭션 권한이 없습니다.`;
           toast("권한 없음");
           return;
         }
         if (act === "txnCommit" && tpol.requireApprovalOnCommit){
           if (msg) msg.textContent = "Commit은 승인 필요(모의): 결재 흐름과 연계하세요.";
           toast("Commit 승인 필요");
           return;
         }
         if (msg) msg.textContent = (act==="txnCommit") ? "Commit 완료(모의)" : "Rollback 완료(모의)";
         toast(act==="txnCommit" ? "Commit" : "Rollback");
         if (banner) banner.style.display="none";
         return;
       }
     }, { passive:true });
   }

   // --- Public module ---
   W.scopePolicyAdvPolicy = {
     open(itemId){
       if (itemId === "queryApproval") return renderQueryApproval();
       if (itemId === "exportPolicy") return renderExportPolicy();
       if (itemId === "queryTimeout") return renderQueryTimeout();
       if (itemId === "transactionControl") return renderTransactionControl();
       toast("지원하지 않는 항목입니다: " + itemId);
     },
     adapter: MockAdapter
   };

   // --- Routing bind (openItem 경고 제거) ---
   function bind(sectionId, itemId, fn){
     // registerItemHandler 있으면 우선 사용
     if (typeof A.registerItemHandler === "function"){
       try{ A.registerItemHandler(sectionId, itemId, fn); }catch(_){}
       try{ A.registerItemHandler(itemId, fn); }catch(_){}
     }
     A.__routeHandlers = A.__routeHandlers || {};
     (A.__routeHandlers[sectionId] ||= {})[itemId] = fn;

     A.__itemHandlers = A.__itemHandlers || {};
     A.__itemHandlers[itemId] = fn;
     A.__itemHandlers[sectionId + "::" + itemId] = fn;
   }

   bind("scopePolicy", "queryApproval",       () => W.scopePolicyAdvPolicy.open("queryApproval"));
   bind("scopePolicy", "exportPolicy",        () => W.scopePolicyAdvPolicy.open("exportPolicy"));
   bind("scopePolicy", "queryTimeout",        () => W.scopePolicyAdvPolicy.open("queryTimeout"));
   bind("scopePolicy", "transactionControl",  () => W.scopePolicyAdvPolicy.open("transactionControl"));
   bind("scopePolicy", "downloadThreshold",   () => W.downloadThresholdAdmin?.open?.());
   bind("scopePolicy", "objectScope",         () => W.objectScopeAdmin?.open?.());
   bind("scopePolicy", "preBlock",            () => W.preBlockAdmin?.open?.());

 })();
 /* ===== [END] scopePolicy 추가 카드(no route) 해결: 통합 모듈 + MockService + 라우팅 ===== */

 
 
(function () {
  const a = window.admin;
  if (!a || a.__orgUserSingleRouterV2) return;
  a.__orgUserSingleRouterV2 = true;

  // section -> item -> fn
  a.__routeHandlers = a.__routeHandlers || {};
  // legacy: item -> fn (혹시 다른 섹션에서 쓰던 형태 유지)
  a.__itemHandlers = a.__itemHandlers || a.__itemHandlers || {};

  // registerItemHandler 오버로드 지원
  //  - (itemId, fn)           : legacy
  //  - (sectionId, itemId, fn): 권장
  a.registerItemHandler = function (p1, p2, p3) {
    let sectionId, itemId, fn;
    if (typeof p2 === "function") {
      sectionId = null;
      itemId = p1;
      fn = p2;
    } else {
      sectionId = p1;
      itemId = p2;
      fn = p3;
    }
    if (typeof fn !== "function") return;

    if (sectionId) {
      (this.__routeHandlers[sectionId] ||= {})[itemId] = fn;
    } else {
      this.__itemHandlers[itemId] = fn;
    }
  };

  // openItem 시그니처 호환:
  //  - openItem(sectionId, itemId, label) : admin.show()가 호출하는 형태(권장)
  //  - openItem(itemId, sectionId)        : 과거 패치 형태(호환)
  a.openItem = function (p1, p2, p3) {
    try {
      let sectionId = p1;
      let itemId = p2;
      let label = p3;

      // 호환: (itemId, sectionId) 형태로 들어온 경우 감지해 스왑
      // sectionId가 실제 섹션키가 아니고, p2가 섹션키면 뒤집힌 걸로 판단
      if (this.sections && !this.sections[sectionId] && this.sections[itemId]) {
        const tmp = sectionId;
        sectionId = itemId;
        itemId = tmp;
      }

      // 섹션 화면 그리드가 필요하면 보여주기
      if (sectionId && typeof this.show === "function" && this.current !== sectionId) {
        this.show(sectionId);
      }

      const fn =
        (sectionId && this.__routeHandlers?.[sectionId]?.[itemId]) ||
        this.__itemHandlers?.[itemId];

      if (typeof fn === "function") {
        fn();
        return true;
      }

      console.warn("[admin.openItem] no route:", sectionId, itemId, label);
      return false;
    } catch (e) {
      console.warn("[admin.openItem] error:", e);
      return false;
    }
  };

  // orgUser 하위 카드 라우팅 등록 (ID는 섹션 정의에 있는 값 그대로)
  // orgUser items: org/user/role/publicAccount/regularReview :contentReference[oaicite:2]{index=2}
  a.registerItemHandler("orgUser", "org", () => window.adminOrgDemo?.openOrgView?.());
  a.registerItemHandler("orgUser", "user", () => window.userAdmin?.open?.());
  a.registerItemHandler("orgUser", "role", () => window.roleAdmin?.open?.());
  a.registerItemHandler("orgUser", "publicAccount", () => window.publicAccountAdmin?.open?.());
  a.registerItemHandler("orgUser", "regularReview", () => window.regularReviewAdmin?.open?.());
})();

/* ===== [START] authPolicy route + UI (sessionTimeout/systemEnvConfig) : v1 ===== */
(function initAuthPolicyExtraRoutesAndUI(){
  const W = window;
  const A = W.admin;
  if (!A || W.__authPolicyExtraV1Installed) return;
  W.__authPolicyExtraV1Installed = true;

  const toast = (typeof W.dbamToast === "function") ? W.dbamToast : (m)=>alert(m);

  const STORE_KEY = "dbam_auth_policy_extra_v1";
  function loadState(){
    const base = {
      sessionTimeout: {
        enabled: true,
        idleMinutes: 15,
        concurrentLimitEnabled: true,
        maxConcurrentSessions: 1
      },
      systemEnvConfig: {
        envName: "DEV",
        auditHardening: true,
        defaultExportFormat: "CSV",
        logRetentionDays: 180
      },
      changeLog: [] // {at, user, item, before, after, reason}
    };
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if (!raw) return base;
      const parsed = JSON.parse(raw);
      return Object.assign(base, parsed || {});
    }catch(_){
      return base;
    }
  }
  function saveState(next){
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(next)); }catch(_){}
  }
  const Adapter = {
    get(){ return JSON.parse(JSON.stringify(loadState())); },
    patch(p){
      const st = loadState();
      const next = Object.assign(st, p || {});
      saveState(next);
      return JSON.parse(JSON.stringify(next));
    }
  };

  function setAuthPolicyPage(titleHtml, descText, bodyHtml){
    const titleEl = document.getElementById("adminTitle");
    const descEl  = document.getElementById("adminDesc");
    const bodyEl  = document.getElementById("adminBody");
    if (!titleEl || !descEl || !bodyEl) return null;

    try{
      W.admin.current = "authPolicy";
      document.querySelectorAll(".admin-nav button").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.section === "authPolicy");
      });
    }catch(_){}

    titleEl.innerHTML = titleHtml;
    descEl.textContent = descText || "";
    bodyEl.innerHTML = bodyHtml || "";
    return bodyEl;
  }

  function renderSessionTimeout(){
    const st = Adapter.get();
    const p = st.sessionTimeout || {};
    setAuthPolicyPage(
      '<i class="fa-solid fa-hourglass-half"></i> 무활동 자동 로그아웃·동시 세션 제한',
      "무활동 시간 기반 세션 만료 및 계정별 동시 세션 제한 정책을 설정합니다. (실제 강제는 백엔드/인증서버 연동 필요)",
      `
      <div class="emg-page" style="width:100%;">
        <div class="admin-card" style="padding:12px 14px;">
          <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap;">
            <label style="display:flex;gap:8px;align-items:center;">
              <input type="checkbox" id="apxIdleEnabled" ${p.enabled ? "checked":""}/>
              <span style="font-weight:800;">무활동 자동 로그아웃 사용</span>
            </label>
            <div style="min-width:220px;">
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">무활동 만료(분)</div>
              <input type="number" class="export-input" id="apxIdleMinutes" min="1" step="1" value="${Number(p.idleMinutes||15)}"/>
            </div>
          </div>

          <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap;margin-top:12px;">
            <label style="display:flex;gap:8px;align-items:center;">
              <input type="checkbox" id="apxConcEnabled" ${p.concurrentLimitEnabled ? "checked":""}/>
              <span style="font-weight:800;">동시 세션 제한 사용</span>
            </label>
            <div style="min-width:220px;">
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">최대 동시 세션 수</div>
              <input type="number" class="export-input" id="apxMaxConc" min="1" step="1" value="${Number(p.maxConcurrentSessions||1)}"/>
            </div>
            <button class="export-btn" data-apx-act="saveSessionTimeout"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
          </div>
        </div>

        <div class="admin-card" style="padding:12px 14px;margin-top:10px;">
          <div style="font-weight:800;margin-bottom:8px;">세션 만료 시뮬레이터</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <button class="export-btn" data-apx-act="simStart"><i class="fa-solid fa-play"></i> 시작</button>
            <button class="export-btn" data-apx-act="simStop"><i class="fa-solid fa-stop"></i> 중지</button>
            <div id="apxSimInfo" class="export-input" style="background:#f9fafb;flex:1;min-width:260px;">대기 중</div>
          </div>
        </div>
      </div>
      `
    );
    W.__authPolicyExtraCurrent = "sessionTimeout";
  }

  function renderSystemEnvConfig(){
    const st = Adapter.get();
    const p = st.systemEnvConfig || {};
    const rows = (st.changeLog || []).slice().reverse().slice(0, 30).map(r => `
      <tr>
        <td style="padding:8px;border-bottom:1px solid var(--line);white-space:nowrap;">${r.at}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);white-space:nowrap;">${r.user||"admin"}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);">${r.item}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);">${r.before}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);">${r.after}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);">${r.reason||""}</td>
      </tr>
    `).join("");

    setAuthPolicyPage(
      '<i class="fa-solid fa-sliders"></i> 시스템 환경 설정',
      "DBAM 공통 환경(감사 옵션/보존기간/기본 포맷 등)을 관리합니다. (실제 반영은 백엔드 설정 저장소 연동 필요)",
      `
      <div class="emg-page" style="width:100%;">
        <div class="admin-card" style="padding:12px 14px;">
          <div style="display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:10px;">
            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">환경명</div>
              <input class="export-input" id="apxEnvName" value="${String(p.envName||"DEV")}"/>
            </div>
            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">로그 보존(일)</div>
              <input type="number" class="export-input" id="apxRetention" min="1" step="1" value="${Number(p.logRetentionDays||180)}"/>
            </div>
            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">기본 Export 포맷</div>
              <select class="export-input" id="apxExportFmt">
                ${["CSV","XLSX","JSON"].map(x=>`<option value="${x}" ${p.defaultExportFormat===x?"selected":""}>${x}</option>`).join("")}
              </select>
            </div>
            <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;">
              <label style="display:flex;gap:8px;align-items:center;">
                <input type="checkbox" id="apxAuditHardening" ${p.auditHardening ? "checked":""}/>
                <span style="font-weight:800;">감사 로그 강화(위변조 억제 옵션)</span>
              </label>
              <button class="export-btn" data-apx-act="saveSystemEnv"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
            </div>
          </div>
        </div>

        <div class="admin-card" style="padding:12px 14px;margin-top:10px;">
          <div style="font-weight:800;margin-bottom:8px;">변경 이력(더미)</div>
          <div class="table-scroll-x" style="border:1px solid var(--line);border-radius:10px;overflow:auto;">
            <table style="width:100%;min-width:980px;border-collapse:collapse;">
              <thead>
                <tr style="background:#f9fafb;">
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">TIME</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">USER</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">ITEM</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">BEFORE</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">AFTER</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">REASON</th>
                </tr>
              </thead>
              <tbody>
                ${rows || `<tr><td colspan="6" style="padding:12px;color:var(--muted);">변경 이력 없음</td></tr>`}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      `
    );
    W.__authPolicyExtraCurrent = "systemEnvConfig";
  }

  // 공개 Admin 객체
  W.sessionTimeoutAdmin = W.sessionTimeoutAdmin || { open: renderSessionTimeout, adapter: Adapter };
  W.systemEnvConfigAdmin = W.systemEnvConfigAdmin || { open: renderSystemEnvConfig, adapter: Adapter };

  // route 등록 (핵심: no route 해결)
  function bind(sectionId, itemId, fn){
    try { A.registerItemHandler(sectionId, itemId, fn); } catch(_){}
    // 방어적으로 직접 주입도 같이
    A.__routeHandlers = A.__routeHandlers || {};
    (A.__routeHandlers[sectionId] ||= {})[itemId] = fn;
    A.__itemHandlers = A.__itemHandlers || {};
    A.__itemHandlers[itemId] = fn;
    A.__itemHandlers[sectionId + "::" + itemId] = fn;
  }
  bind("authPolicy", "sessionTimeout", () => W.sessionTimeoutAdmin.open());
  bind("authPolicy", "systemEnvConfig", () => W.systemEnvConfigAdmin.open());

  // 이벤트 1회만 바인딩(중복 방지)
  if (!W.__authPolicyExtraV1EventsBound) {
    W.__authPolicyExtraV1EventsBound = true;

    let simTimer = null;
    document.addEventListener("click", (e) => {
      const btn = e.target.closest?.("[data-apx-act]");
      if (!btn) return;

      // 현재 authPolicy 화면에서만 동작
      if (!W.admin || W.admin.current !== "authPolicy") return;

      const act = btn.dataset.apxAct;

      if (W.__authPolicyExtraCurrent === "sessionTimeout") {
        if (act === "saveSessionTimeout") {
          const st = Adapter.get();
          const before = JSON.stringify(st.sessionTimeout || {});
          st.sessionTimeout = {
            enabled: !!document.getElementById("apxIdleEnabled")?.checked,
            idleMinutes: Math.max(1, Number(document.getElementById("apxIdleMinutes")?.value || 15)),
            concurrentLimitEnabled: !!document.getElementById("apxConcEnabled")?.checked,
            maxConcurrentSessions: Math.max(1, Number(document.getElementById("apxMaxConc")?.value || 1))
          };
          st.changeLog = st.changeLog || [];
          st.changeLog.push({
            at: new Date().toISOString(),
            user: "admin",
            item: "authPolicy.sessionTimeout",
            before,
            after: JSON.stringify(st.sessionTimeout),
            reason: "정책 변경"
          });
          Adapter.patch({ sessionTimeout: st.sessionTimeout, changeLog: st.changeLog });
          toast("저장 완료");
          return;
        }

        if (act === "simStart") {
          const st = Adapter.get();
          const p = st.sessionTimeout || {};
          const info = document.getElementById("apxSimInfo");
          if (!info) return;

          const enabled = !!p.enabled;
          const sec = Math.max(1, Number(p.idleMinutes||15) * 60);

          if (!enabled) {
            info.textContent = "무활동 자동 로그아웃이 OFF 입니다.";
            return;
          }

          if (simTimer) clearInterval(simTimer);
          let left = sec;

          info.textContent = `만료까지 ${left}s`;
          simTimer = setInterval(() => {
            left -= 1;
            if (left <= 0) {
              clearInterval(simTimer);
              simTimer = null;
              info.textContent = "세션 만료 처리(모의): 자동 로그아웃";
              toast("세션이 만료되었습니다.");
              return;
            }
            info.textContent = `만료까지 ${left}s`;
          }, 1000);
          return;
        }

        if (act === "simStop") {
          const info = document.getElementById("apxSimInfo");
          if (simTimer) clearInterval(simTimer);
          simTimer = null;
          if (info) info.textContent = "중지됨";
          return;
        }
      }

      if (W.__authPolicyExtraCurrent === "systemEnvConfig") {
        if (act === "saveSystemEnv") {
          const st = Adapter.get();
          const before = JSON.stringify(st.systemEnvConfig || {});
          st.systemEnvConfig = {
            envName: String(document.getElementById("apxEnvName")?.value || "DEV").trim() || "DEV",
            auditHardening: !!document.getElementById("apxAuditHardening")?.checked,
            defaultExportFormat: String(document.getElementById("apxExportFmt")?.value || "CSV"),
            logRetentionDays: Math.max(1, Number(document.getElementById("apxRetention")?.value || 180))
          };
          st.changeLog = st.changeLog || [];
          st.changeLog.push({
            at: new Date().toISOString(),
            user: "admin",
            item: "authPolicy.systemEnvConfig",
            before,
            after: JSON.stringify(st.systemEnvConfig),
            reason: "환경 설정 변경"
          });
          Adapter.patch({ systemEnvConfig: st.systemEnvConfig, changeLog: st.changeLog });
          toast("저장 완료");
          // 저장 후 리렌더
          renderSystemEnvConfig();
          return;
        }
      }
    }, true);
  }
})();
/* ===== [END] authPolicy route + UI (sessionTimeout/systemEnvConfig) : v1 ===== */
 
 
// 관리 콘솔 섹션 확장 (번호 4~19 반영)
(function extendAdminSections() {
  if (!window.admin || !admin.sections) return;

  const sections = admin.sections;

  // 1) 인증/정책 쪽 (4번, 11번)
  if (sections.authPolicy && Array.isArray(sections.authPolicy.items)) {
    sections.authPolicy.items.push(
      {
        id: 'sessionTimeout',
        label: '무활동 자동 로그아웃·동시 세션 제한',
        icon: 'fa-hourglass-half',
        tags: ['세션타임아웃', '자동로그아웃', '동시세션'],
        spec: '무활동 시간 기준 자동 로그아웃과 사용자별 동시 세션 허용 개수를 설정·조회'
      },
      {
        id: 'systemEnvConfig',
        label: '시스템 환경 설정',
        icon: 'fa-sliders',
        tags: ['공통코드', '로그인정책', '기본설정', '리소스다운로드', '감사옵션'],
        spec: '코드, 로그인 정책, 사용자 기본설정, 리소스 다운로드, 감사 옵션 등 DBAM 공통 환경을 관리'
      }
    );
  }

  // 2) DB/민감정보 쪽 (6번, 7·15·16번, 13번)
  if (sections.dbSensitive && Array.isArray(sections.dbSensitive.items)) {
    // 기존 dbRegistry spec 보강
    sections.dbSensitive.items = sections.dbSensitive.items.map(function (item) {
      if (item.id === 'dbRegistry') {
        return Object.assign({}, item, {
          spec: '운영/개발 등 환경 구분별 DB 인스턴스의 스키마, 계정, 접속 정보·접속 방식을 등록하고 ' +
                '응용시스템 계정과 매핑하며 연결 테스트를 지원'
        });
      }
      return item;
    });

    sections.dbSensitive.items.push(
      {
        id: 'dbResourceMonitor',
        label: 'DB 파라미터·리소스·상태 모니터링',
        icon: 'fa-gauge-high',
        tags: ['DB파라미터', '리소스사용량', '상태'],
        spec: 'DB 파라미터, 리소스 사용량, 상태를 모니터링하는 화면'
      },
      {
        id: 'dbDashboard',
        label: '전체 데이터베이스 관리 대시보드',
        icon: 'fa-table-cells-large',
        tags: ['전체DB현황', '용량', '접속', '요약'],
        spec: '등록된 전체 DB 인스턴스의 상태, 용량, 접속, 현황을 요약해 보여주는 대시보드'
      }
    );
  }

  // 3) 접근 범위·사전 차단 정책 쪽 (9번, 14번, 18번, 19번)
  if (sections.scopePolicy && Array.isArray(sections.scopePolicy.items)) {
    sections.scopePolicy.items.push(
      {
        id: 'queryApproval',
        label: '쿼리 결재 관리',
        icon: 'fa-stamp',
        tags: ['위험쿼리', '대량다운로드', '승인요청', '결재이력'],
        spec: '위험 쿼리·대량 다운로드에 대한 승인 요청 및 결재 이력을 관리'
      },
      {
        id: 'exportPolicy',
        label: 'Export Data 정책',
        icon: 'fa-file-export',
        tags: ['데이터내보내기', '반출', '승인정책'],
        spec: '데이터 내보내기 허용 범위, 대상, 형식, 승인 필요 여부를 설정'
      },
      {
        id: 'queryTimeout',
        label: '쿼리 타임아웃 설정',
        icon: 'fa-clock-rotate-left',
        tags: ['쿼리타임아웃', '최대실행시간'],
        spec: '쿼리 최대 실행 시간을 설정하고 초과 시 자동 중지되도록 관리'
      },
      {
        id: 'transactionControl',
        label: '트랜잭션 제어 정책',
        icon: 'fa-exchange-alt',
        tags: ['Auto-commit', 'Commit', 'Rollback'],
        spec: 'Auto-commit 사용 여부와 Commit/Rollback 제어 방식을 정책으로 관리'
      }
    );
  }

  // 4) 로그·감사·리포트 쪽 (5번, 8번, 10번, 12번)
  if (sections.logAudit && Array.isArray(sections.logAudit.items)) {
    sections.logAudit.items.push(
      {
        id: 'dbTxnLog',
        label: '트랜잭션/리두 로그 요약',
        icon: 'fa-database',
        tags: ['트랜잭션로그', '리두로그', '요약조회'],
        spec: 'DB별 트랜잭션 로그와 리두 로그를 요약 조회'
      },
      {
        id: 'sessionManage',
        label: '세션 관리',
        icon: 'fa-users-gear',
        tags: ['세션목록', '세션관리', 'DBA전용'],
        spec: 'DBA·관리자가 DB별 세션 목록을 조회하고 세션 상태를 관리'
      },
      {
        id: 'externalArchive',
        label: '주요 데이터 외부 저장 설정',
        icon: 'fa-vault',
        tags: ['로그이중보관', '외부저장소'],
        spec: '중요 로그·설정 데이터를 외부 안전 저장소로 이중 보관하는 설정을 관리'
      },
      {
        id: 'systemInfo',
        label: 'DBAM 시스템 정보',
        icon: 'fa-circle-info',
        tags: ['버전', '구성요소', '라이선스', '환경정보'],
        spec: 'DBAM 시스템 버전, 구성요소, 라이선스, 환경 정보를 제공'
      }
    );
  }
})();

/* ===== [START] logAudit routes + UI (dbTxnLog/sessionManage/externalArchive/systemInfo) : v1 ===== */
(function initLogAuditExtraRoutesAndUI(){
  const W = window;
  const A = W.admin;
  if (!A || W.__logAuditExtraV1Installed) return;
  W.__logAuditExtraV1Installed = true;

  const toast = (typeof W.dbamToast === "function") ? W.dbamToast : (m)=>alert(m);

  // ---- Service abstraction (MockAdapter: localStorage / 나중에 API Adapter로 교체) ----
  const STORE_KEY = "dbam_logAudit_extra_v1";
  function clone(v){ return JSON.parse(JSON.stringify(v)); }
  function nowISO(){
    const d = new Date();
    const p = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }
  function loadState(){
    const base = {
      dbTxnLog: {
        items: [
          { db:"FIN-ORCL-PRD", day:"2025-12-22", commits:12430, rollbacks:312, redoMB:1840, topUser:"app_api" },
          { db:"FIN-PG-DEV",   day:"2025-12-22", commits:  940, rollbacks: 27, redoMB:  88, topUser:"dev_user" },
        ]
      },
      sessionManage: {
        sessions: [
          { id:"S-1001", db:"FIN-ORCL-PRD", user:"app_api", status:"ACTIVE", lastActive:"2m",  clientIp:"10.10.2.11" },
          { id:"S-1002", db:"FIN-ORCL-PRD", user:"batch01", status:"IDLE",   lastActive:"18m", clientIp:"10.10.3.21" },
          { id:"S-2001", db:"FIN-PG-DEV",   user:"dev_user",status:"ACTIVE", lastActive:"1m",  clientIp:"172.16.0.8" },
        ]
      },
      externalArchive: {
        enabled: true,
        targetType: "S3", // S3 | NFS | SYSLOG
        endpoint: "https://archive.example.local",
        bucketOrPath: "dbam-audit",
        encrypt: true,
        retentionDays: 365
      },
      systemInfo: {
        version: "v0.10",
        env: "DEV",
        buildTime: nowISO(),
        modules: ["IAM", "DB/민감정보", "정책", "로그·감사", "이상행위 리포트"],
        license: "INTERNAL"
      },
      changeLog: [] // {at,user,item,before,after,reason}
    };
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if (!raw) return base;
      const parsed = JSON.parse(raw);
      return Object.assign(base, parsed || {});
    }catch(_){
      return base;
    }
  }
  function saveState(st){
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(st)); }catch(_){}
  }

  const Adapter = {
    get(){ return clone(loadState()); },
    patch(patch, meta){
      const st = loadState();
      const before = meta?.before ?? "";
      const after  = meta?.after  ?? "";
      if (meta?.item){
        st.changeLog = st.changeLog || [];
        st.changeLog.push({
          at: nowISO(),
          user: "admin",
          item: meta.item,
          before,
          after,
          reason: meta.reason || "변경"
        });
      }
      const next = Object.assign(st, patch || {});
      saveState(next);
      return clone(next);
    }
  };

  // ---- UI helper ----
  function setPage(titleHtml, descText, bodyHtml){
    // nav active
    try{
      A.current = "logAudit";
      document.querySelectorAll(".admin-nav button").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.section === "logAudit");
      });
    }catch(_){}

    const titleEl = document.getElementById("adminTitle");
    const descEl  = document.getElementById("adminDesc");
    const bodyEl  = document.getElementById("adminBody");
    if (!titleEl || !descEl || !bodyEl) return null;

    titleEl.innerHTML = titleHtml;
    descEl.textContent = descText || "";
    bodyEl.innerHTML = bodyHtml || "";
    return bodyEl;
  }

  function topBar(){
    return `
      <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div style="font-size:12px;color:var(--muted);">설정/조회는 더미 저장소 기반이며, 백엔드 연동 시 Adapter만 교체합니다.</div>
        <div style="display:flex;gap:8px;">
          <button class="export-btn" data-la-act="back"><i class="fa-solid fa-arrow-left"></i> 목록</button>
        </div>
      </div>
    `;
  }

  // ---- renderers ----
  function renderDbTxnLog(){
    const st = Adapter.get();
    const rows = (st.dbTxnLog?.items || []).map(r=>`
      <tr>
        <td style="padding:8px;border-bottom:1px solid var(--line);white-space:nowrap;">${r.day}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);white-space:nowrap;">${r.db}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);text-align:right;">${r.commits}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);text-align:right;">${r.rollbacks}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);text-align:right;">${r.redoMB}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);white-space:nowrap;">${r.topUser}</td>
      </tr>
    `).join("");

    setPage(
      '<i class="fa-solid fa-database"></i> 트랜잭션/리두 로그 요약',
      "DB별 커밋/롤백/리두량을 요약 조회합니다. (실데이터는 백엔드/에이전트 수집 필요)",
      `
      <div id="logAuditExtraPage" class="emg-page" style="width:100%;">
        ${topBar()}
        <div class="admin-card" style="padding:12px 14px;">
          <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;">
            <div style="min-width:220px;">
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">기준일</div>
              <input class="export-input" id="laTxnDay" value="${(st.dbTxnLog?.items?.[0]?.day)||"2025-12-22"}" />
            </div>
            <button class="export-btn" data-la-act="txnRefresh"><i class="fa-solid fa-rotate"></i> 새로고침</button>
          </div>
        </div>

        <div class="admin-card" style="padding:12px 14px;margin-top:10px;">
          <div style="font-weight:800;margin-bottom:8px;">요약 테이블</div>
          <div class="table-scroll-x" style="border:1px solid var(--line);border-radius:10px;overflow:auto;">
            <table style="width:100%;min-width:860px;border-collapse:collapse;">
              <thead>
                <tr style="background:#f9fafb;">
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">DAY</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">DB</th>
                  <th style="text-align:right;padding:10px;border-bottom:1px solid var(--line);">COMMITS</th>
                  <th style="text-align:right;padding:10px;border-bottom:1px solid var(--line);">ROLLBACKS</th>
                  <th style="text-align:right;padding:10px;border-bottom:1px solid var(--line);">REDO(MB)</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">TOP USER</th>
                </tr>
              </thead>
              <tbody>${rows || `<tr><td colspan="6" style="padding:12px;color:var(--muted);">데이터 없음</td></tr>`}</tbody>
            </table>
          </div>
        </div>
      </div>
      `
    );

    W.__logAuditExtraCurrent = "dbTxnLog";
  }

  function renderSessionManage(){
    const st = Adapter.get();
    const rows = (st.sessionManage?.sessions || []).map(s=>`
      <tr>
        <td style="padding:8px;border-bottom:1px solid var(--line);white-space:nowrap;">${s.id}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);white-space:nowrap;">${s.db}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);white-space:nowrap;">${s.user}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);white-space:nowrap;">${s.status}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);white-space:nowrap;">${s.lastActive}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);white-space:nowrap;">${s.clientIp}</td>
        <td style="padding:8px;border-bottom:1px solid var(--line);white-space:nowrap;">
          <button class="export-btn" data-la-act="killSession" data-id="${s.id}">종료</button>
        </td>
      </tr>
    `).join("");

    setPage(
      '<i class="fa-solid fa-users-gear"></i> 세션 관리',
      "DB별 세션 목록을 조회하고 종료(모의)합니다. (실제 세션 종료는 DB 권한/백엔드 연동 필요)",
      `
      <div id="logAuditExtraPage" class="emg-page" style="width:100%;">
        ${topBar()}
        <div class="admin-card" style="padding:12px 14px;">
          <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;">
            <input class="export-input" id="laSessQ" placeholder="검색(DB/USER/IP)" style="min-width:260px;" />
            <button class="export-btn" data-la-act="sessRefresh"><i class="fa-solid fa-rotate"></i> 새로고침</button>
          </div>
        </div>

        <div class="admin-card" style="padding:12px 14px;margin-top:10px;">
          <div style="font-weight:800;margin-bottom:8px;">세션 목록</div>
          <div class="table-scroll-x" style="border:1px solid var(--line);border-radius:10px;overflow:auto;">
            <table style="width:100%;min-width:980px;border-collapse:collapse;">
              <thead>
                <tr style="background:#f9fafb;">
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">ID</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">DB</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">USER</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">STATUS</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">LAST</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">CLIENT IP</th>
                  <th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);">ACTION</th>
                </tr>
              </thead>
              <tbody>${rows || `<tr><td colspan="7" style="padding:12px;color:var(--muted);">세션 없음</td></tr>`}</tbody>
            </table>
          </div>
        </div>
      </div>
      `
    );

    W.__logAuditExtraCurrent = "sessionManage";
  }

  function renderExternalArchive(){
    const st = Adapter.get();
    const p = st.externalArchive || {};
    setPage(
      '<i class="fa-solid fa-vault"></i> 주요 데이터 외부 저장 설정',
      "중요 로그/정책 변경 이력을 외부 저장소로 이중 보관하는 설정입니다. (실제 전송/서명/무결성은 백엔드 연동 필요)",
      `
      <div id="logAuditExtraPage" class="emg-page" style="width:100%;">
        ${topBar()}
        <div class="admin-card" style="padding:12px 14px;">
          <div style="display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:10px;">
            <label style="display:flex;gap:8px;align-items:center;">
              <input type="checkbox" id="laArcEnabled" ${p.enabled ? "checked":""}/>
              <span style="font-weight:800;">외부 저장 사용</span>
            </label>

            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">저장소 타입</div>
              <select class="export-input" id="laArcType">
                ${["S3","NFS","SYSLOG"].map(x=>`<option value="${x}" ${p.targetType===x?"selected":""}>${x}</option>`).join("")}
              </select>
            </div>

            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">Endpoint</div>
              <input class="export-input" id="laArcEndpoint" value="${p.endpoint||""}" />
            </div>

            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">Bucket/Path</div>
              <input class="export-input" id="laArcBucket" value="${p.bucketOrPath||""}" />
            </div>

            <label style="display:flex;gap:8px;align-items:center;">
              <input type="checkbox" id="laArcEncrypt" ${p.encrypt ? "checked":""}/>
              <span style="font-weight:800;">암호화/서명 사용(옵션)</span>
            </label>

            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">보존기간(일)</div>
              <input type="number" class="export-input" id="laArcRetention" min="1" step="1" value="${Number(p.retentionDays||365)}"/>
            </div>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
            <button class="export-btn" data-la-act="arcTest"><i class="fa-solid fa-plug"></i> 연결 테스트</button>
            <button class="export-btn" data-la-act="arcSave"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
          </div>
        </div>
      </div>
      `
    );

    W.__logAuditExtraCurrent = "externalArchive";
  }

  function renderSystemInfo(){
    const st = Adapter.get();
    const s = st.systemInfo || {};
    const ua = navigator.userAgent || "";
    setPage(
      '<i class="fa-solid fa-circle-info"></i> DBAM 시스템 정보',
      "버전/구성요소/환경 정보를 제공합니다. (배포 파이프라인 연동 시 자동 수집 가능)",
      `
      <div id="logAuditExtraPage" class="emg-page" style="width:100%;">
        ${topBar()}
        <div class="admin-card" style="padding:12px 14px;">
          <div style="display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:10px;">
            <div><div style="font-size:11px;color:var(--muted);margin-bottom:4px;">버전</div><div class="export-input" style="background:#f9fafb;">${s.version||"-"}</div></div>
            <div><div style="font-size:11px;color:var(--muted);margin-bottom:4px;">환경</div><div class="export-input" style="background:#f9fafb;">${s.env||"-"}</div></div>
            <div><div style="font-size:11px;color:var(--muted);margin-bottom:4px;">빌드 시간</div><div class="export-input" style="background:#f9fafb;">${s.buildTime||"-"}</div></div>
            <div><div style="font-size:11px;color:var(--muted);margin-bottom:4px;">라이선스</div><div class="export-input" style="background:#f9fafb;">${s.license||"-"}</div></div>
          </div>

          <div style="margin-top:10px;">
            <div style="font-weight:800;margin-bottom:6px;">모듈</div>
            <div class="export-input" style="background:#f9fafb;">${(s.modules||[]).join(", ") || "-"}</div>
          </div>

          <div style="margin-top:10px;">
            <div style="font-weight:800;margin-bottom:6px;">런타임</div>
            <div class="export-input" style="background:#f9fafb;">Host: ${location.host} / UA: ${ua.slice(0,120)}${ua.length>120?"...":""}</div>
          </div>
        </div>
      </div>
      `
    );

    W.__logAuditExtraCurrent = "systemInfo";
  }

  // ---- public module ----
  W.logAuditExtraAdmin = {
    open(itemId){
      if (itemId === "dbTxnLog") return renderDbTxnLog();
      if (itemId === "sessionManage") return renderSessionManage();
      if (itemId === "externalArchive") return renderExternalArchive();
      if (itemId === "systemInfo") return renderSystemInfo();
      toast("지원하지 않는 항목: " + itemId);
    },
    adapter: Adapter
  };

  // ---- route 등록 (no route 해결 핵심) ----
  A.registerItemHandler("logAudit", "dbTxnLog",        () => W.logAuditExtraAdmin.open("dbTxnLog"));
  A.registerItemHandler("logAudit", "sessionManage",   () => W.logAuditExtraAdmin.open("sessionManage"));
  A.registerItemHandler("logAudit", "externalArchive", () => W.logAuditExtraAdmin.open("externalArchive"));
  A.registerItemHandler("logAudit", "systemInfo",      () => W.logAuditExtraAdmin.open("systemInfo"));

  // ---- 이벤트(1회 바인딩, 화면 존재할 때만 동작) ----
  if (!W.__logAuditExtraV1EventsBound) {
    W.__logAuditExtraV1EventsBound = true;

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest?.("[data-la-act]");
      if (!btn) return;
      if (!W.admin || W.admin.current !== "logAudit") return;
      if (!document.getElementById("logAuditExtraPage")) return;

      const act = btn.dataset.laAct;
      if (act === "back") return W.admin.show("logAudit");

      // dbTxnLog
      if (act === "txnRefresh") { toast("새로고침(모의)"); return renderDbTxnLog(); }

      // sessionManage
      if (act === "sessRefresh") { toast("새로고침(모의)"); return renderSessionManage(); }
      if (act === "killSession") {
        const id = btn.dataset.id;
        const st = Adapter.get();
        const before = JSON.stringify(st.sessionManage || {});
        st.sessionManage.sessions = (st.sessionManage.sessions||[]).map(s => s.id===id ? Object.assign({}, s, { status:"KILLED", lastActive:"0m" }) : s);
        Adapter.patch({ sessionManage: st.sessionManage }, { item:"logAudit.sessionManage", before, after: JSON.stringify(st.sessionManage), reason:"세션 종료(모의)" });
        toast("세션 종료 처리(모의)");
        return renderSessionManage();
      }

      // externalArchive
      if (act === "arcTest") { toast("연결 테스트 성공(모의)"); return; }
      if (act === "arcSave") {
        const st = Adapter.get();
        const before = JSON.stringify(st.externalArchive || {});
        const next = {
          enabled: !!document.getElementById("laArcEnabled")?.checked,
          targetType: String(document.getElementById("laArcType")?.value || "S3"),
          endpoint: String(document.getElementById("laArcEndpoint")?.value || ""),
          bucketOrPath: String(document.getElementById("laArcBucket")?.value || ""),
          encrypt: !!document.getElementById("laArcEncrypt")?.checked,
          retentionDays: Math.max(1, Number(document.getElementById("laArcRetention")?.value || 365))
        };
        Adapter.patch({ externalArchive: next }, { item:"logAudit.externalArchive", before, after: JSON.stringify(next), reason:"외부 저장 설정 변경" });
        toast("저장 완료");
        return renderExternalArchive();
      }
    }, true);
  }
})();
/* ===== [END] logAudit routes + UI (dbTxnLog/sessionManage/externalArchive/systemInfo) : v1 ===== */



/* ---------------- Connection Settings modal controller ---------------- */
const connSettings = {
  open(connId) {
    const backdrop = document.getElementById('connSettingsBackdrop');
    const form = document.getElementById('connSettingsForm');
    if (!backdrop || !form) {
      alert('커넥션 설정 모달 DOM을 찾지 못했습니다.');
      return;
    }

    // 초기화
    form.reset();
    const idInput   = document.getElementById('connSettingsConnId');
    const nameInput = document.getElementById('connSettingsName');
    const envSelect = document.getElementById('connSettingsEnv');

    if (idInput) {
      idInput.value = connId || '';
    }

    // 기존 연결 정보가 있으면 이름/환경 정도만 채워줌 (접속정보는 서버 연동 후)
    let label = connId || '';
    let envValue = '';
    try {
      const conns = (state && state.availableConns) ? state.availableConns : [];
      const found = conns.find(c => c.id === connId);
      if (found) {
        label = found.label || found.id || label;
        if (nameInput && !nameInput.value) {
          nameInput.value = label;
        }
        if (typeof found.env !== 'undefined' && found.env !== null) {
          envValue = found.env;
        }
      } else if (nameInput && !nameInput.value) {
        nameInput.value = label;
      }

      // state.connEnvs 우선
      if (state && state.connEnvs && connId && state.connEnvs[connId]) {
        envValue = state.connEnvs[connId] || '';
      }

      // 트리 노드 data-env 보조
      if (!envValue && typeof tree !== 'undefined' && tree && typeof tree.getConnLi === 'function' && connId) {
        const li = tree.getConnLi(connId);
        if (li && li.dataset && li.dataset.env) {
          envValue = li.dataset.env;
        }
      }

      if (envSelect) {
        envSelect.value = envValue || '';
      }
    } catch (e) {
      // state가 없거나 구조가 달라도 치명적이지 않으므로 무시
    }

    backdrop.classList.remove('hidden');
    backdrop.classList.add('show');
    backdrop.setAttribute('aria-hidden', 'false');
  },

  openNew() {
    this.open(null);
  },

  close() {
    const backdrop = document.getElementById('connSettingsBackdrop');
    if (!backdrop) return;
    backdrop.classList.remove('show');
    backdrop.classList.add('hidden');
    backdrop.setAttribute('aria-hidden', 'true');
  },

  save() {
    const form = document.getElementById('connSettingsForm');
    const nameInput = document.getElementById('connSettingsName');
    const idInput   = document.getElementById('connSettingsConnId');
    const envSelect = document.getElementById('connSettingsEnv');

    if (!form) {
      alert('커넥션 설정 폼을 찾을 수 없습니다.');
      return;
    }

    const label = nameInput ? nameInput.value.trim() : '';
    if (!label) {
      alert('연결 이름을 입력하세요.');
      if (nameInput) nameInput.focus();
      return;
    }

    const connId = (idInput && idInput.value) ? idInput.value.trim() : '';
    const envValue = envSelect ? (envSelect.value || '').trim() : '';
    const conn = {
      id: connId,
      label: label,
      profile: null,
      env: envValue
    };

    let updated = false;

    // 기존 DB 노드가 있으면 해당 노드/상태를 수정
    if (connId) {
      // state.availableConns 갱신
      try {
        if (typeof state !== 'undefined' && state && Array.isArray(state.availableConns)) {
          const list = state.availableConns;
          for (let i = 0; i < list.length; i++) {
            const c = list[i];
            if (c && c.id === connId) {
              list[i] = {
                id: c.id,
                label: label,
                profile: c.profile || null,
                env: envValue || c.env || null
              };
              updated = true;
              break;
            }
          }
          state.availableConns = list;
        }
      } catch (e) {
        console.warn('connSettings.save: availableConns update error', e);
      }

      // 트리 노드 라벨 갱신
      try {
        const li = document.querySelector('#dbTree li[data-conn-id="' + connId + '"]');
        if (li) {
          li.dataset.label = label;
          li.dataset.env = envValue || '';
          const nodeEl = li.querySelector('.node');
          if (nodeEl) {
            const spans = nodeEl.querySelectorAll('span');
            if (spans && spans.length > 0) {
              spans[spans.length - 1].textContent = label;
            }
          }
          updated = true;
        }
      } catch (e) {
        console.warn('connSettings.save: tree node update error', e);
      }

      // 연결 선택 박스 / 배지 갱신
      if (updated) {
        try {
          if (typeof ui !== 'undefined' && ui) {
            if (typeof ui.renderConnSelect === 'function') {
              ui.renderConnSelect();
            } else if (typeof ui.syncConnSelect === 'function') {
              ui.syncConnSelect();
            }
            if (typeof ui.updateConnStatusChip === 'function') {
              ui.updateConnStatusChip();
            }
          }
        } catch (e) {
          console.warn('connSettings.save: ui sync error', e);
        }

        try {
          if (typeof tree !== 'undefined' && tree && typeof tree.updateConnBadges === 'function') {
            tree.updateConnBadges();
          }
        } catch (e) {
          console.warn('connSettings.save: updateConnBadges error', e);
        }

        // 환경 구분값 저장 및 탭 밑줄 색 반영
        try {
          if (typeof state !== 'undefined' && state) {
            if (!state.connEnvs) {
              state.connEnvs = {};
            }
            if (connId) {
              state.connEnvs[connId] = envValue || '';
              if (state.connStates && state.connStates[connId] && typeof applyTabUnderlineForConn === 'function') {
                applyTabUnderlineForConn(connId);
              }
              if (state.connStates && state.connStates[connId] && typeof updateEnvBannerForConn === 'function') {
                try{
                  var activeTab = (state.tabs || []).find(function(t){ return t && t.id === state.activeTabId; });
                  var activeConnId = activeTab ? (activeTab.lastConnId || activeTab.connId || null) : null;
                  if (activeConnId === connId) {
                    updateEnvBannerForConn(connId);
                  }
                }catch(e){
                  console.warn('connSettings.save: updateEnvBannerForConn error', e);
                }
              }
            }
          }
        } catch (e) {
          console.warn('connSettings.save: connEnvs update error', e);
        }
      }
    }

    // connId가 없거나(신규) / 위 단계에서 수정 못 한 경우 → 새 DB 노드 추가
    if (!connId || !updated) {
      try {
        if (typeof dbFolderUi !== 'undefined' && dbFolderUi && typeof dbFolderUi.addDbNode === 'function') {
          dbFolderUi.addDbNode(conn);
        } else {
          console.warn('dbFolderUi.addDbNode 가 없어 DB 노드를 트리에 추가하지 못했습니다.');
        }
      } catch (e) {
        console.warn('connSettings.save addDbNode error', e);
      }
    }

    // 모달 닫기
    this.close();
  }
};




const codeActions = {
  _getDoc(){
    try{
      if(typeof cm !== 'undefined' && cm && cm.getDoc){
        return cm.getDoc();
      }
    }catch(e){}
    return null;
  },
  _getSelectionText(doc){
    try{
      if(!doc) return '';
      const sel = doc.getSelection();
      if(sel && sel.length) return sel;
      const cur = doc.getCursor();
      const line = doc.getLine(cur.line) || '';
      let start = cur.ch;
      let end = cur.ch;
      while(start > 0 && /[\w\d_.]/.test(line.charAt(start-1))) start--;
      while(end < line.length && /[\w\d_.]/.test(line.charAt(end))) end++;
      if(end > start){
        return doc.getRange({ line: cur.line, ch: start }, { line: cur.line, ch: end });
      }
      return '';
    }catch(e){
      console.warn('codeActions._getSelectionText error', e);
      return '';
    }
  },
  toInList(){
    try{
      const doc = this._getDoc();
      if(!doc) return;
      let text = doc.getSelection();
      if(!text){
        text = this._getSelectionText(doc);
      }
      if(!text || !text.trim()){
        alert('IN 리스트로 변환할 값을 먼저 선택하세요.');
        return;
      }
      const raw = text.split(/[\n,\t,]+/).map(s => s.trim()).filter(Boolean);
      if(!raw.length){
        alert('선택된 값이 없습니다.');
        return;
      }
      const uniq = [];
      raw.forEach(v => {
        if(uniq.indexOf(v) === -1){
          uniq.push(v);
        }
      });
      const parts = uniq.map(v => {
        let val = v;
        if((val.startsWith("'") && val.endsWith("'")) || (val.startsWith('"') && val.endsWith('"'))){
          val = val.slice(1, -1);
        }
        const isNum = /^-?\d+(\.\d+)?$/.test(val);
        if(isNum) return val;
        return "'" + val.replace(/'/g, "''") + "'";
      });
      const result = 'IN (' + parts.join(', ') + ')';
      if(doc.somethingSelected && doc.somethingSelected()){
        const from = doc.getCursor('from');
        const to = doc.getCursor('to');
        doc.replaceRange(result, from, to);
      }else{
        const cur = doc.getCursor();
        doc.replaceRange(result, cur);
      }
    }catch(e){
      console.warn('codeActions.toInList error', e);
    }
  },
  toggleComment(){
  try{
    const doc = this._getDoc();
    if(!doc) return;
    const from = doc.getCursor('from');
    const to = doc.getCursor('to');
    const startLine = from.line;
    const endLine = to.line;

    const applyToggle = () => {
      for(let line = startLine; line <= endLine; line++){
        const text = doc.getLine(line);
        if(!text || !text.trim()) continue;
        const leading = (text.match(/^\s*/) || [''])[0];
        let rest = text.slice(leading.length);
        if(rest.startsWith('-- ')){
          rest = rest.slice(3);
        }else if(rest.startsWith('--')){
          rest = rest.slice(2);
        }else{
          rest = '-- ' + rest;
        }
        doc.replaceRange(leading + rest, { line, ch: 0 }, { line, ch: text.length });
      }
      // 주석 토글 후, 전체 줄(0열~끝) 다시 선택해서 앞의 '--'까지 선택되도록 유지
      try{
        const lastLineText = doc.getLine(endLine) || '';
        doc.setSelection(
          { line: startLine, ch: 0 },
          { line: endLine, ch: lastLineText.length }
        );
      }catch(_e2){}
    };

    let cmEditor = null;
    try{
      if(typeof cm !== 'undefined' && cm && cm.getDoc){
        cmEditor = cm;
      }
    }catch(_e){}

    if(cmEditor && typeof cmEditor.operation === 'function'){
      cmEditor.operation(applyToggle);
    }else{
      applyToggle();
    }
  }catch(e){
    console.warn('codeActions.toggleComment error', e);
  }
},


  runSelection(){
    try{
      if(typeof actions !== 'undefined' && actions && typeof actions.runCurrent === 'function'){
        actions.runCurrent();
      }
    }catch(e){
      console.warn('codeActions.runSelection error', e);
    }
  },
  openMenu(editorInstance){
    try{
      if(typeof editorCtx === 'undefined' || !editorCtx || typeof editorCtx.open !== 'function'){
        return;
      }
      const cmEditor = editorInstance || (typeof cm !== 'undefined' ? cm : null);
      if(!cmEditor || !cmEditor.charCoords){
        editorCtx.open(window.innerWidth / 2, window.innerHeight / 2);
        return;
      }
      const doc = cmEditor.getDoc ? cmEditor.getDoc() : null;
      const cursor = doc ? doc.getCursor() : null;
      const coords = cursor ? cmEditor.charCoords(cursor, 'page') : { left: window.innerWidth / 2, bottom: window.innerHeight / 2 };
      const x = coords.left;
      const y = coords.bottom + 4;
      editorCtx.open(x, y);
    }catch(e){
      console.warn('codeActions.openMenu error', e);
    }
  }
};

  Object.assign(window, { ui, tree, actions, demo, tests, ctxMenu, editorCtx, bottomTabs, admin });

// bootstrap
window.addEventListener('DOMContentLoaded', ()=>{
  try{
    ui.init();
    bottomTabs.init();
    bottomTabs.activate('result');

    if (typeof dbFolderUi !== 'undefined' && typeof dbFolderUi.initToolbar === 'function') {
      dbFolderUi.initToolbar();
    }

    //  모드(USE_DEMO=true)에서는 기본  커넥션/트리 한 번 그려줌
    if (typeof USE_DEMO !== 'undefined' && USE_DEMO) {
      if (!state.availableConns || !state.availableConns.length) {
        if (typeof demo !== 'undefined' && typeof demo.connectMulti === 'function') {
          demo.connectMulti();
        }
      }
    }

    // 테스트는 개발 모드에서만 수동 실행
    if (window && window.location) {
      const q = window.location.search || '';
      const h = window.location.hash || '';
      if ((q+h).indexOf('dbamTest=1') >= 0) {
        tests.run();
      }
    }
    if (typeof initAutoSaveTimer === 'function') {
      initAutoSaveTimer();
    }

    // ESC 키로 모달 닫기 (전체 모달 + 관리 콘솔, 최상단부터 1개씩)
    document.addEventListener('keydown', (e)=>{
      const key = e.key || e.keyCode;
      if (key === 'Escape' || key === 'Esc' || key === 27) {

        const candidates = [];

        const pushIfVisible = (id, closer) => {
          const el = document.getElementById(id);
          if (!el) return;
          if (!el.classList.contains('show')) return;
          candidates.push({ el, closer, id });
        };

        // 커넥션 설정 모달
        pushIfVisible('connSettingsBackdrop', () => {
          if (typeof connSettings !== 'undefined' && connSettings && typeof connSettings.close === 'function') {
            connSettings.close();
          }
          // ESC로 모달을 닫을 때 DB 추가 버튼 포커스(검정 테두리) 제거
          const addDbBtn = document.getElementById('dbtreeAddDbBtn');
          if (addDbBtn) {
            addDbBtn.blur();
          }
        });

        // 접속 사유 모달
        pushIfVisible('connReasonBackdrop', () => {
          if (typeof ui !== 'undefined' && ui && typeof ui.closeConnReasonModal === 'function') {
            ui.closeConnReasonModal();
          }
        });

        // 위험 쿼리 승인 요청 모달
        pushIfVisible('approvalRequestBackdrop', () => {
          if (typeof approvalCenter !== 'undefined' && approvalCenter && typeof approvalCenter.closeRequestModal === 'function') {
            approvalCenter.closeRequestModal();
          }
        });

        // 위험 쿼리 승인 상세 모달
        pushIfVisible('approvalDetailBackdrop', () => {
          if (typeof approvalCenter !== 'undefined' && approvalCenter && typeof approvalCenter.closeDetailModal === 'function') {
            approvalCenter.closeDetailModal();
          }
        });

        // Export 감사/승인 모달
        pushIfVisible('exportAuditBackdrop', () => {
          if (typeof ui !== 'undefined' && ui && typeof ui.closeExportAuditModal === 'function') {
            ui.closeExportAuditModal();
          } else if (typeof closeExportAuditModal === 'function') {
            closeExportAuditModal();
          }
        });

        // 내 정보 모달
        pushIfVisible('myInfoBackdrop', () => {
          if (typeof ui !== 'undefined' && ui && typeof ui.closeMyInfoModal === 'function') {
            ui.closeMyInfoModal();
          } else if (typeof closeMyInfoModal === 'function') {
            closeMyInfoModal();
          }
        });

        // 내 설정 모달
        pushIfVisible('mySettingsBackdrop', () => {
          if (typeof closeMySettings === 'function') {
            closeMySettings();
          }
        });

        // 부재중 / 대결자 설정 모달 (구 버전 호환)
        pushIfVisible('delegateSettingsBackdrop', () => {
          if (typeof closeDelegateSettingsModal === 'function') {
            closeDelegateSettingsModal();
          }
        });

        // 비밀번호 변경 모달
        pushIfVisible('passwordChangeBackdrop', () => {
          if (typeof closePasswordChangeModal === 'function') {
            closePasswordChangeModal();
          }
        });

        // 개인 SQL 불러오기 모달
        pushIfVisible('personalSqlLoadBackdrop', () => {
          if (typeof ui !== 'undefined' && ui && typeof ui.closePersonalSqlLoad === 'function') {
            ui.closePersonalSqlLoad();
          }
        });

        // 개인 SQL 저장 모달
        pushIfVisible('personalSqlSaveBackdrop', () => {
          if (typeof ui !== 'undefined' && ui && typeof ui.closePersonalSqlSave === 'function') {
            ui.closePersonalSqlSave();
          }
        });

        // 최근 쿼리 히스토리 사이드바
        pushIfVisible('queryHistorySidebar', () => {
          if (typeof queryHistorySidebar !== 'undefined' && queryHistorySidebar && typeof queryHistorySidebar.close === 'function') {
            queryHistorySidebar.close();
          }
        });

        // 쿼리 스냅샷 모달
        pushIfVisible('snapshotBackdrop', () => {
          if (typeof snapshots !== 'undefined' && snapshots && typeof snapshots.closeModal === 'function') {
            snapshots.closeModal();
          }
        });

        // 테이블 편집 모달
        pushIfVisible('tableEditBackdrop', () => {
          if (typeof tableEditor !== 'undefined' && tableEditor && typeof tableEditor.close === 'function') {
            tableEditor.close();
          }
        });

        // 대결자 선택 (조직도) 모달
        pushIfVisible('delegateOrgBackdrop', () => {
          if (window.delegatePicker && typeof window.delegatePicker.close === 'function') {
            window.delegatePicker.close();
          } else {
            const el = document.getElementById('delegateOrgBackdrop');
            if (el) {
              el.classList.remove('show');
              el.classList.add('hidden');
              el.setAttribute('aria-hidden','true');
            }
          }
        });

        // 부재중 & 대결자 관리 모달 (프로필에서 여는 새 모달)
        try {
          const absenceBackdrop = document.getElementById('absenceModalBackdrop');
          if (absenceBackdrop && absenceBackdrop.classList.contains('open')) {
            candidates.push({
              el: absenceBackdrop,
              closer: () => {
                if (typeof closeAbsenceModal === 'function') {
                  closeAbsenceModal();
                }
              },
              id: 'absenceModalBackdrop'
            });
          }
        } catch (err) {
          console.warn('ESC absenceModalBackdrop candidate error', err);
        }

        // 관리 콘솔 오버레이
        (function(){
          const ov = document.getElementById('adminOverlay');
          if (!ov || !ov.classList.contains('show')) return;
          candidates.push({
            el: ov,
            closer: () => {
              if (typeof admin !== 'undefined' && admin && typeof admin.close === 'function') {
                try { admin.close(); } catch(err) { console.warn('ESC close adminOverlay error', err); }
              } else {
                ov.classList.remove('show');
                ov.setAttribute('aria-hidden','true');
              }
            },
            id: 'adminOverlay'
          });
        })();

        if (!candidates.length) {
          return;
        }

        // DOM 상에서 가장 나중에 위치한 요소(시각적으로 가장 위에 있는 요소)를 1개만 닫는다.
        let top = candidates[0];
        for (let i = 1; i < candidates.length; i++) {
          const current = candidates[i];
          if (!current.el || current.el === top.el) continue;
          const cmp = top.el.compareDocumentPosition(current.el);
          if (cmp & Node.DOCUMENT_POSITION_FOLLOWING) {
            top = current;
          }
        }

        try {
          if (typeof top.closer === 'function') {
            top.closer();
          }
        } catch (err) {
          console.warn('ESC close topmost error', err);
        }
      }
    });  }catch(e){
    console.error(e);
  }
});
</script>


  <!-- 관리 / 보안 콘솔 (조직/사용자/권한/정책/로그/리포트) -->
  <div id="adminOverlay" class="admin-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="admin-shell">
      <aside class="admin-sidebar">
        <h3><i class="fa-solid fa-shield-halved"></i> 관리 콘솔</h3>
        <div class="admin-nav">
          <div class="admin-nav-section">
            <div class="admin-nav-section-title">조직·사용자·역할</div>
            <button type="button" data-section="orgUser" onclick="admin.show('orgUser')">조직도 / 사용자 / 역할</button>
            <button type="button" data-section="accessLifecycle" onclick="admin.show('accessLifecycle')">권한 신청·변경·회수</button>
          </div>
          <div class="admin-nav-section">
            <div class="admin-nav-section-title">DB·민감정보</div>
            <button type="button" data-section="dbSensitive" onclick="admin.show('dbSensitive')">DB / 민감정보 관리</button>
            <button type="button" data-section="scopePolicy" onclick="admin.show('scopePolicy')">접근 범위·사전 차단</button>
          </div>
          <div class="admin-nav-section">
            <div class="admin-nav-section-title">계정·정책</div>
            <button type="button" data-section="authPolicy" onclick="admin.show('authPolicy')">계정·비밀번호·MFA 정책</button>
            <button type="button" data-section="sharedEmergency" onclick="admin.show('sharedEmergency')">공용/응급 계정 관리</button>
          </div>
          <div class="admin-nav-section">
            <div class="admin-nav-section-title">로그·감사·리포트</div>
            <button type="button" data-section="logAudit" onclick="admin.show('logAudit')">로그·감사 뷰</button>
            <button type="button" data-section="anomalyReport" onclick="admin.show('anomalyReport')">이상행위·리포트</button>
          </div>
        </div>
      </aside>
      <section class="admin-content">
        <header class="admin-header">
          <h2 id="adminTitle"><i class="fa-solid fa-house-lock"></i> 관리 콘솔 개요</h2>
          <button type="button" class="admin-close" onclick="admin.close()"><i class="fa-solid fa-xmark"></i></button>
        </header>
        <div id="adminDesc" class="admin-footer" style="text-align:left;margin-top:4px;">
          DBAM 콘솔에서 ISMS/감사 요구사항을 한 눈에 관리하는 화면입니다. 좌측에서 영역을 선택하면 관련 기능 카드가 표시됩니다.
        </div>
        <div id="adminBody" class="admin-body">
          <!-- JS에서 카드 렌더링 -->
        </div>
      </section>
    </div>
  </div>

  
  <!-- 내 정보 모달 -->
  <div id="myInfoBackdrop" class="export-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="export-modal">
  <div class="shell">
    <header>
      <div class="title-area">
        <h1>내 정보<span class="title-badge">DB 접근제어 포털 · 사용자 정보</span></h1>
        <div class="title-sub">
          현재 로그인된 사용자 기준으로, 프로필 · 권한 · 접근 가능 DB · 신청 현황 · 보안 로그 요약을 보여줍니다.
        </div>
      </div>
      <div class="pill-meta">
        <span><span class="pill-dot" style="background:#22c55e;"></span>세션 유효</span>
        <span><span class="pill-dot" style="background:#38bdf8;"></span>샘플 데이터 · UI 전용</span>
      </div>
    </header>

    <main>
      <!-- LEFT COLUMN -->
      <section>
        <!-- 기본 프로필 -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="card-title-icon">ID</span>
                기본 프로필 / 로그인 정보
              </div>
              <div class="card-desc">
                사내 인사정보와 연동된 기본 정보, 최근 로그인 이력을 요약합니다.
              </div>
            </div>
            
          </div>
          <div class="profile-grid">
            <div class="avatar-block">
              <div class="avatar-ring">H</div>
              <div class="avatar-label">샘플 사용자</div>
            </div>
            <div>
              <dl class="profile-fields">
                <dt>이름</dt><dd>홍길동</dd>
                <dt>사번 / ID</dt><dd>00012345 / hgildong</dd>
                <dt>부서 / 직책</dt><dd>IT운영팀 / 대리</dd>
                <dt>현재 세션 시작</dt><dd>2025-11-27 14:12 (KST)</dd>
                <dt>마지막 로그인</dt><dd>2025-11-27 09:02 · 10.10.20.35 · Chrome on Windows</dd>
              </dl>
              <div class="hint">※ 위 정보는 샘플입니다. 실제 시스템에서는 사내 인사정보와 연동해 자동으로 표시됩니다.</div>
            </div>
          </div>
        </div>

        <!-- 역할/권한 요약 -->
        <div class="card" style="margin-top:10px;">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="card-title-icon sec">RB</span>
                역할 · 승인 권한 요약
              </div>
              <div class="card-desc">
                DBAM 내에서 부여된 역할, 위험쿼리 승인 권한, 보안 정책 적용 범위를 요약합니다.
              </div>
            </div>
            <div class="card-toolbar">
              <span class="tag-soft accent">운영 DB 일부 쓰기 가능</span>
            </div>
          </div>
          <ul class="roles-list">
            <li>
              <div class="roles-label">DBAM 역할</div>
              <div class="roles-badges">
                <span class="badge">개발자</span>
                <span class="badge">운영자(부분)</span>
              </div>
            </li>
            <li>
              <div class="roles-label">승인 권한</div>
              <div class="roles-badges">
                <span class="badge">개발-위험쿼리 승인 가능</span>
                <span class="badge">운영-카드계 읽기 승인 가능</span>
              </div>
            </li>
            <li>
              <div class="roles-label">보안 정책</div>
              <div class="roles-badges">
                <span class="badge">민감컬럼 마스킹 적용 대상</span>
                <span class="badge">운영 DB 쓰기 시 사전승인 필수</span>
                <span class="badge">엑셀 다운로드 50,000행 제한</span>
              </div>
            </li>
          </ul>
          <div class="hint">※ 실제 권한/정책은 사내 계정·역할 매핑에 따라 자동 반영되며, 변경 시 감사 로그에 기록됩니다.</div>
        </div>

        <!-- 보안 로그 요약 -->
        <div class="card" style="margin-top:10px;">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="card-title-icon warn">LG</span>
                보안 로그 요약
              </div>
              <div class="card-desc">
                최근 로그인 / DB 접속 / 대량 다운로드 이력을 간단히 보여줍니다.
              </div>
            </div>
            <div class="card-toolbar">
              <span class="tag-soft warn">이상 징후 확인용</span>
            </div>
          </div>
          <div class="section-grid">
            <div>
              <div class="card-desc" style="margin-bottom:2px;">최근 로그인 (상위 5건)</div>
              <ul class="log-list">
                <li class="log-item">
                  <div class="log-main">
                    <span>2025-11-27 09:02</span>
                    <span>성공</span>
                  </div>
                  <div class="log-meta">10.10.20.35 · Chrome on Windows</div>
                </li>
                <li class="log-item">
                  <div class="log-main">
                    <span>2025-11-26 18:11</span>
                    <span>성공</span>
                  </div>
                  <div class="log-meta">10.10.20.12 · Edge on Windows</div>
                </li>
                <li class="log-item">
                  <div class="log-main">
                    <span>2025-11-26 08:57</span>
                    <span>실패 (비밀번호 오류)</span>
                  </div>
                  <div class="log-meta">10.10.20.12 · Chrome on Windows</div>
                </li>
              </ul>
            </div>
            <div>
              <div class="card-desc" style="margin-bottom:2px;">최근 DB 접속 / 다운로드 (상위 5건)</div>
              <ul class="log-list">
                <li class="log-item">
                  <div class="log-main">
                    <span>2025-11-27 14:18 · 개발-카드계 PostgreSQL</span>
                  </div>
                  <div class="log-meta">조회 쿼리 12건 실행 · 위험쿼리 없음</div>
                </li>
                <li class="log-item">
                  <div class="log-main">
                    <span>2025-11-27 11:02 · 운영-카드계 Oracle</span>
                  </div>
                  <div class="log-meta">마스킹 컬럼 포함 조회 · 승인번호 #OPS-20251127-034</div>
                </li>
                <li class="log-item">
                  <div class="log-main">
                    <span>2025-11-26 16:40 · 개발-공통 PostgreSQL</span>
                  </div>
                  <div class="log-meta">엑셀 다운로드 32,540행 · 사유: 배치 오류 원인 분석</div>
                </li>
              </ul>
            </div>
          </div>
          <div class="foot-hint">※ 상세 로그는 상단 메뉴의 "트랜잭션/쿼리 로그" 화면에서 확인할 수 있습니다.</div>
        </div>
      </section>

      <!-- RIGHT COLUMN -->
      <section>
        <!-- 내가 접근할 수 있는 데이터베이스 -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="card-title-icon sec">DB</span>
                내가 접근할 수 있는 데이터베이스
              </div>
              <div class="card-desc">
                현재 권한 기준으로 접속 가능한 DB 목록을 환경·시스템별로 보여줍니다.
              </div>
            </div>
            <div class="card-toolbar">
              <span class="tag-soft">총 <strong>샘플 6건</strong></span>
            </div>
          </div>
          <div class="db-access-toolbar">
            <div class="segmented">
              <button type="button" data-env="ALL" class="is-active">전체</button>
              <button type="button" data-env="DEV">개발</button>
              <button type="button" data-env="PROD">운영</button>
            </div>
            <input type="search" id="dbSearchInput" placeholder="시스템명 / DB명 / 프로필 검색" />
          </div>
          <div class="table-wrap">
            <table id="dbAccessTable">
              <thead>
                <tr>
                  <th style="width:74px;">환경</th>
                  <th>시스템</th>
                  <th>DB 유형</th>
                  <th>접속 프로필</th>
                  <th>내 권한</th>
                  <th style="width:110px;">권한 유효기간</th>
                </tr>
              </thead>
              <tbody>
                <tr data-env="DEV">
                  <td><span class="env-pill"><span class="pill-dot" style="background:#22c55e;"></span>개발</span></td>
                  <td>카드-정산 (DEV)</td>
                  <td>PostgreSQL</td>
                  <td>CARD-SETTLE-DEV</td>
                  <td><span class="role-pill">읽기/쓰기 (DML)</span></td>
                  <td>별도 만료 없음</td>
                </tr>
                <tr data-env="DEV">
                  <td><span class="env-pill"><span class="pill-dot" style="background:#22c55e;"></span>개발</span></td>
                  <td>보험-보유계약 (DEV)</td>
                  <td>Oracle</td>
                  <td>LIFE-POLICY-DEV</td>
                  <td><span class="role-pill">읽기 전용</span></td>
                  <td>별도 만료 없음</td>
                </tr>
                <tr data-env="DEV">
                  <td><span class="env-pill"><span class="pill-dot" style="background:#22c55e;"></span>개발</span></td>
                  <td>공통-코드 (DEV)</td>
                  <td>PostgreSQL</td>
                  <td>COMMON-CODE-DEV</td>
                  <td><span class="role-pill">읽기/쓰기 (DML)</span></td>
                  <td>별도 만료 없음</td>
                </tr>
                <tr data-env="PROD">
                  <td><span class="env-pill prod"><span class="pill-dot" style="background:#f97373;"></span>운영</span></td>
                  <td>카드-정산 (PROD)</td>
                  <td>Oracle</td>
                  <td>CARD-SETTLE-PROD</td>
                  <td><span class="role-pill">읽기 전용</span></td>
                  <td>2026-12-31</td>
                </tr>
                <tr data-env="PROD">
                  <td><span class="env-pill prod"><span class="pill-dot" style="background:#f97373;"></span>운영</span></td>
                  <td>보험-보유계약 (PROD)</td>
                  <td>Oracle</td>
                  <td>LIFE-POLICY-PROD</td>
                  <td><span class="role-pill">읽기 전용</span></td>
                  <td>2025-12-31</td>
                </tr>
                <tr data-env="PROD">
                  <td><span class="env-pill prod"><span class="pill-dot" style="background:#f97373;"></span>운영</span></td>
                  <td>공통-코드 (PROD)</td>
                  <td>PostgreSQL</td>
                  <td>COMMON-CODE-PROD</td>
                  <td><span class="role-pill">읽기 전용</span></td>
                  <td>별도 만료 없음</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="foot-hint">※ 실제 화면에서는 ITSM/권한 시스템과 연계해, 본인에게 부여된 DB 접근 권한만 표시됩니다.</div>
        </div>

        <!-- 신청/승인 현황 -->
        <div class="card" style="margin-top:10px;">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="card-title-icon">AP</span>
                위험 쿼리 승인 신청 현황
              </div>
              <div class="card-desc">
                최근에 본인이 신청한 위험 쿼리 승인 요청의 상태를 간단히 보여줍니다.
              </div>

            </div>
            <div class="card-toolbar">
              <span class="tag-soft">최근 7일 기준</span>
            </div>
          </div>
          <div class="section-grid">
            <div>
              <div class="card-desc" style="margin-bottom:2px;">위험 쿼리 승인 요청</div>
              <table class="mini-table">
                <thead>
                  <tr>
                    <th style="width:90px;">신청 일시</th>
                    <th>대상</th>
                    <th style="width:70px;">상태</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>11-27 14:05</td>
                    <td>운영-카드계 · 대량 UPDATE (사유: 정산 오류 수정)</td>
                    <td class="col-right"><span class="status-pill wait">승인 대기</span></td>
                  </tr>
                  <tr>
                    <td>11-26 13:22</td>
                    <td>DEV-공통 코드 일괄 UPDATE</td>
                    <td class="col-right"><span class="status-pill ok">승인 완료</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="foot-hint">※ 자세한 내용은 "권한 신청 내역" / "쿼리 승인 요청 내역" 화면에서 조회할 수 있습니다.</div>
        </div>
      </section>
    </main>
  </div>

  

      <div class="myinfo-footer">
        <button type="button" onclick="if(window.ui&&typeof ui.closeMyInfoModal==='function'){ui.closeMyInfoModal();}">닫기</button>
      </div>
    </div>
  </div>

<!-- Excel 내보내기 감사/반출 통제 모달 -->
  <div id="exportAuditBackdrop" class="export-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="export-modal">
      <h3><i class="fa-solid fa-file-export"></i> Excel 내보내기</h3>
      <div id="exportAuditMeta" class="meta"></div>
      <div id="exportAuditWarning" class="danger" style="display:none;"></div>
      <div class="field">
        <label for="exportReason">반출 사유 <span style="color:#d00">*</span></label>
        <textarea id="exportReason" placeholder="예: 월간 경영 리포트 작성용 집계"></textarea>
      </div>
      <div class="field" id="exportApprovalField" style="display:none;">
        <label for="exportApprovalId">관리자 승인 ID (대용량/예외 반출 시) <span style="color:#d00">*</span></label>
        <input id="exportApprovalId" type="text" style="width:100%;font-size:12px;padding:4px 6px;" />
      </div>
      <div class="btn-row">
        <button type="button" onclick="ui.closeExportAuditModal()">취소</button>
        <button type="button" onclick="ui.confirmExportAudit()" style="background:#2c7be5;color:#fff;border:none;border-radius:4px;">
          내보내기
        </button>
      </div>
    </div>
  </div>

  <!-- 쿼리 스냅샷 공유 모달 -->
  <div id="snapshotBackdrop" class="export-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="export-modal">
      <h3><i class="fa-solid fa-link"></i> 쿼리 스냅샷 공유</h3>
      <div class="field">
        <label for="snapshotId">스냅샷 ID</label>
        <input id="snapshotId" type="text" readonly style="width:100%;font-size:12px;padding:4px 6px;background:#f9fafb;" />
      </div>
      <div class="field">
        <label for="snapshotJson">공유용 JSON</label>
        <textarea id="snapshotJson" readonly placeholder="스냅샷 JSON이 여기 표시됩니다."></textarea>
        <div class="muted" style="font-size:11px;margin-top:4px;">
          이 문자열을 메신저/메일로 전달하면 상대방이 붙여넣기로 동일한 스냅샷을 불러올 수 있습니다.
        </div>
      </div>
      <div class="btn-row">
        <button type="button" onclick="snapshots.closeModal()">닫기</button>
        <button type="button" onclick="snapshots.copyJson()" style="background:#00857C;color:#fff;border:none;border-radius:4px;">
          JSON 복사
        </button>
      </div>
    </div>
  </div>

  
  <!-- DB 커넥션 설정 모달 -->
  <div id="connSettingsBackdrop"
       class="export-modal-backdrop hidden"
       role="dialog"
       aria-modal="true"
       aria-hidden="true">
    <div class="export-modal conn-settings-modal">
      <div class="export-modal-header">
        <h2>
          <i class="fa-solid fa-gear"></i>
          <span style="margin-left:4px;">커넥션 설정</span>
        </h2>
        <button type="button"
                class="btn-icon conn-settings-close-btn"
                onclick="connSettings.close()"
                aria-label="닫기">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="export-modal-body conn-settings-body">
        <form id="connSettingsForm">
          <input type="hidden" name="connId" id="connSettingsConnId" />

          <div class="conn-settings-grid">
            <!-- 좌측: 연결 기본 정보 -->
            <div>
              <div class="conn-settings-group">
                <label for="connSettingsName">연결 이름</label>
                <input type="text"
                       id="connSettingsName"
                       name="name"
                       class="conn-settings-input"
                       placeholder="예: 교보-카드 DEV" />
              </div>

              <div class="conn-settings-row" style="margin-top:6px;">
                <div class="conn-settings-group">
                  <label for="connSettingsEnv">환경 구분</label>
                  <select id="connSettingsEnv"
                          name="env"
                          class="conn-settings-select">
                    <option value="">선택</option>
                    <option value="DEV">개발</option>
                    <option value="PROD">운영</option>
                  </select>
                </div>
              </div>

              <div class="conn-settings-group" style="margin-top:6px;">
                <label for="connSettingsDesc">설명 (선택)</label>
                <textarea id="connSettingsDesc"
                          name="description"
                          class="conn-settings-input"
                          rows="2"
                          placeholder="연결/DB에 대한 간단한 설명을 입력하세요."></textarea>
              </div>
            </div>

            <!-- 우측: DB 접속 정보(계정 정보 제외) -->
            <div>
              <div class="conn-settings-row">
                <div class="conn-settings-group">
                  <label for="connSettingsDbType">DB 유형</label>
                  <select id="connSettingsDbType"
                          name="dbType"
                          class="conn-settings-select">
                    <option value="">선택</option>
                    <option value="POSTGRES">PostgreSQL</option>
                    <option value="ORACLE">Oracle</option>
                    <option value="MYSQL">MySQL/MariaDB</option>
                    <option value="MSSQL">MS SQL Server</option>
                    <option value="ETC">기타</option>
                  </select>
                </div>
                <div class="conn-settings-group">
                  <label for="connSettingsHost">Host</label>
                  <input type="text"
                         id="connSettingsHost"
                         name="host"
                         class="conn-settings-input"
                         placeholder="예: db-server01" />
                </div>
              </div>

              <div class="conn-settings-row" style="margin-top:6px;">
                <div class="conn-settings-group">
                  <label for="connSettingsPort">Port</label>
                  <input type="number"
                         id="connSettingsPort"
                         name="port"
                         class="conn-settings-input"
                         placeholder="예: 5432" />
                </div>
                <div class="conn-settings-group">
                  <label for="connSettingsDbName">DB / SID / Service</label>
                  <input type="text"
                         id="connSettingsDbName"
                         name="dbName"
                         class="conn-settings-input"
                         placeholder="예: coredb 또는 ORCL" />
                </div>
              </div>

              <div class="conn-settings-group" style="margin-top:6px;">
                <label for="connSettingsSchema">기본 스키마 (선택)</label>
                <input type="text"
                       id="connSettingsSchema"
                       name="schema"
                       class="conn-settings-input"
                       placeholder="예: public 또는 APP_USER" />
              </div>
            </div>
          </div>

          <div class="conn-settings-group" style="margin-top:8px;">
            <label for="connSettingsJdbcUrl">JDBC URL (참고용)</label>
            <input type="text"
                   id="connSettingsJdbcUrl"
                   name="jdbcUrl"
                   class="conn-settings-input"
                   readonly
                   placeholder="선택한 DB 유형/Host/Port/DB 기준으로 자동 생성 예정" />
          </div>
        </form>

        <div class="conn-settings-footer">
          <div class="conn-settings-footer-left">
            ※ 커넥션 설정에서는 ID/PW/MFA를 저장하지 않으며, 실제 연결 시에만 별도 입력받습니다.
          </div>
          <div class="conn-settings-footer-right">
            <button type="button"
                    class="btn"
                    onclick="connSettings.close()">
              닫기
            </button>
            <button type="button"
                    class="btn primary"
                    onclick="connSettings.save()">
              저장
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- DB 연결 정보 / 접속 사유 모달 -->
  <div id="connReasonBackdrop" class="export-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="export-modal">
      <h3><i class="fa-solid fa-plug"></i> DB 연결 정보 / 접속 사유</h3>
      <div id="connReasonMeta" class="meta"></div>

      <div class="field">
        <label for="connUserInput">DB 사용자 ID <span style="color:#d00">*</span></label>
        <input id="connUserInput"
               type="text"
               style="width:100%;font-size:12px;padding:4px 6px;"
               autocomplete="username" />
      </div>
      <div class="field">
        <label for="connPasswordInput">비밀번호 <span style="color:#d00">*</span></label>
        <input id="connPasswordInput"
               type="password"
               style="width:100%;font-size:12px;padding:4px 6px;"
               autocomplete="current-password" />
      </div>
      <div class="field">
        <label for="connMfaInput">인증 코드 (MFA)</label>
        <div class="conn-settings-row">
          <button type="button"
                  class="btn"
                  id="connMfaSendBtn"
                  onclick="ui.sendConnMfaCode()">
            인증코드 발송
          </button>
          <input id="connMfaInput"
                 type="text"
                 class="conn-settings-input hidden"
                 style="font-size:12px;padding:4px 6px;"
                 autocomplete="one-time-code"
                 placeholder="발송된 일회용 인증 코드를 입력하세요." />
        </div>
      </div>

      <div class="field">
        <label for="connReasonInput">접속 사유 <span style="color:#d00">*</span></label>
        <textarea id="connReasonInput" placeholder="접속 사유를 입력하세요."></textarea>
      </div>
      <div class="field">
        <label for="connTicketInput">ITSM/작업요청 번호 (선택)</label>
        <input id="connTicketInput" type="text" style="width:100%;font-size:12px;padding:4px 6px;" />
      </div>
      <div class="btn-row">
        <button type="button" onclick="ui.cancelConnReason()">취소</button>
        <button type="button" onclick="ui.testConnReason()" style="border:1px solid #00857C;color:#00857C;background:#fff;border-radius:4px;">
          연결 테스트
        </button>
        <button type="button" onclick="ui.confirmConnReason()" style="background:#00857C;color:#fff;border:none;border-radius:4px;">
          연결
        </button>
      </div>
    </div>
  </div>


  
  
  
  <!-- 최근 쿼리 히스토리 사이드바 (현재 DB 기준) -->
  <div id="queryHistorySidebar" class="hidden" aria-hidden="true">
    <header>
      <div class="title-wrap">
        <h3><i class="fa-solid fa-clock-rotate-left"></i> 최근 쿼리 (현재 DB)</h3>
        <div id="qhSidebarMeta" class="muted"></div>
      </div>
      <button type="button" class="btn-icon" onclick="queryHistorySidebar.close()" aria-label="닫기">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </header>
    <div class="body" id="qhSidebarBody">
      <div class="empty">현재 연결 기준 최근 실행 내역이 없습니다.</div>
    </div>
  </div>
<!-- 개인 SQL 서버 저장소 - 저장 모달 -->
  <div id="personalSqlSaveBackdrop" class="export-modal-backdrop hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="export-modal" style="max-width:820px;">
      <div class="export-modal-header">
        <h2>현재 탭 SQL 저장</h2>
        <button type="button" class="btn-icon" onclick="ui.closePersonalSqlSave()" aria-label="닫기">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="export-modal-body">
        <div class="export-modal-grid">
          <div class="export-group">
            <label>저장 위치</label>
            <div class="export-input" style="background:#f9fafb;display:flex;gap:12px;align-items:center;">
              <label style="display:flex;align-items:center;gap:4px;">
                <input type="radio" name="psSaveTarget" value="server" checked>
                <span>서버 개인 저장소</span>
              </label>
              <label style="display:flex;align-items:center;gap:4px;">
                <input type="radio" name="psSaveTarget" value="file">
                <span>파일로 저장 (다운로드)</span>
              </label>
            </div>
          </div>
          <div class="export-group">
            <label for="psSaveTitle">저장 이름</label>
            <input type="text" id="psSaveTitle" class="export-input" placeholder="예: 2025-11-24 카드 마스터 점검 쿼리">
          </div>
          <div class="export-group">
            <label for="psSaveDesc">설명 (선택)</label>
            <textarea id="psSaveDesc" class="export-input" rows="2" placeholder="간단한 설명을 입력하세요."></textarea>
          </div>
          <div class="export-group">
            <label>대상 탭</label>
            <div id="psSaveInfo" class="export-input" style="background:#f3f4f6;"></div>
          </div>
          <div class="export-group">
            <label>SQL 미리보기 (상위 일부)</label>
            <pre id="psSavePreview" class="export-input" style="min-height:120px;max-height:200px;overflow:auto;white-space:pre-wrap;"></pre>
          </div>
          <p class="muted" style="margin-top:4px;">
            ※ 서버 개인 저장소 연동 전으로, '서버 개인 저장소' 저장은 UI까지만 구현된 상태입니다. (실제 저장은 백엔드 연동 후 적용)
          </p>
        </div>
      </div>
      <div style="border-top:1px solid #e5e7eb; padding:8px 12px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" class="btn" onclick="ui.closePersonalSqlSave()">닫기</button>
        <button type="button" class="btn primary" onclick="ui.confirmPersonalSqlSave()">저장</button>
      </div>
    </div>
  </div>

  <!-- 개인 SQL 서버 저장소 - 불러오기 모달 -->
  <div id="personalSqlLoadBackdrop" class="export-modal-backdrop hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="export-modal" style="max-width:720px;">
      <div class="export-modal-header">
        <h2>개인 SQL 저장소 - SQL 불러오기</h2>
        <button type="button" class="btn-icon" onclick="ui.closePersonalSqlLoad()" aria-label="닫기">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="export-modal-body">
        <p class="muted" style="margin-bottom:8px;">
          서버 개인 저장소에 저장된 SQL 목록이 이 영역에 표시될 예정입니다. (현재는 더미 UI 상태)
        </p>
        <div style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;max-height:260px;">
          <table style="width:100%;border-collapse:collapse;font-size:12px;">
            <thead style="background:#f9fafb;">
              <tr>
                <th style="border-bottom:1px solid #e5e7eb;padding:6px 8px;text-align:left;width:40px;">선택</th>
                <th style="border-bottom:1px solid #e5e7eb;padding:6px 8px;text-align:left;">이름</th>
                <th style="border-bottom:1px solid #e5e7eb;padding:6px 8px;text-align:left;width:180px;">저장일시</th>
                <th style="border-bottom:1px solid #e5e7eb;padding:6px 8px;text-align:left;width:200px;">비고</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="border-top:1px solid #e5e7eb;padding:6px 8px;text-align:center;">
                  <input type="radio" name="psLoadSelect" disabled>
                </td>
                <td style="border-top:1px solid #e5e7eb;padding:6px 8px;color:#9ca3af;">
                  (서버 연동 후 목록이 표시됩니다)
                </td>
                <td style="border-top:1px solid #e5e7eb;padding:6px 8px;color:#9ca3af;">-</td>
                <td style="border-top:1px solid #e5e7eb;padding:6px 8px;color:#9ca3af;">UI만 우선 구현</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div style="border-top:1px solid #e5e7eb; padding:8px 12px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" class="btn primary" onclick="ui.applyPersonalSqlLoad()">선택 SQL 불러오기</button>
      </div>
    </div>
  </div>


  <!-- 단축키 / 스니펫 안내 모달 -->
  <div id="shortcutHelpBackdrop"
       class="export-modal-backdrop hidden"
       role="dialog"
       aria-modal="true"
       aria-hidden="true">
    <div class="export-modal" style="max-width:980px;width:980px;">
      <div class="export-modal-header">
        <h2>
          <i class="fa-solid fa-circle-question"></i>
          <span style="margin-left:4px;">단축키 / 스니펫 안내</span>
        </h2>
        <button type="button"
                class="btn-icon"
                onclick="ui.closeShortcutHelpModal()"
                aria-label="닫기">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="export-modal-body">
        <p class="muted" style="margin-bottom:8px;">
          SQL 에디터에서 자주 사용하는 단축키와 스니펫 요약입니다.
        </p>

        <div style="display:flex;gap:16px;flex-wrap:wrap;">
          <!-- 단축키 영역 -->
          <div style="flex:1 1 260px;min-width:260px;">
            <h3 style="font-size:13px;margin-bottom:4px;">단축키</h3>
            <table style="width:100%;border-collapse:collapse;font-size:12px;">
              <tbody>
                <tr>
                  <td style="padding:4px 6px;width:150px;font-family:monospace;">Ctrl + Enter</td>
                  <td style="padding:4px 6px;">선택/커서 기준 쿼리 실행</td>
                </tr>
                <tr>
                  <td style="padding:4px 6px;font-family:monospace;">Ctrl + Shift + Enter</td>
                  <td style="padding:4px 6px;">전체 스크립트 실행</td>
                </tr>
                <tr>
                  <td style="padding:4px 6px;font-family:monospace;">Ctrl + Shift + F</td>
                  <td style="padding:4px 6px;">SQL 서식 정리</td>
                </tr>
                <tr>
                  <td style="padding:4px 6px;font-family:monospace;">Ctrl + Space</td>
                  <td style="padding:4px 6px;">자동완성 (테이블 / 컬럼)</td>
                </tr>
                <tr>
                  <td style="padding:4px 6px;font-family:monospace;">Esc</td>
                  <td style="padding:4px 6px;">컨텍스트 메뉴 / 모달 닫기</td>
                </tr>
                <tr>
                  <td style="padding:4px 6px;font-family:monospace;">Alt + Drag</td>
                  <td style="padding:4px 6px;">여러 줄 열 선택 / 멀티 커서 편집</td>
                </tr>
                <tr>
                  <td style="padding:4px 6px;font-family:monospace;">Ctrl + /</td>
                  <td style="padding:4px 6px;">선택 영역 주석/해제</td>
                </tr>
                <tr>
                  <td style="padding:4px 6px;font-family:monospace;">Ctrl + .</td>
                  <td style="padding:4px 6px;">코드 액션 메뉴 열기 (IN 리스트 변환 / 주석 / 선택 실행)</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 스니펫 영역 -->
          <div style="flex:1 1 220px;min-width:220px;">
            <h3 style="font-size:13px;margin-bottom:4px;">스니펫 예시</h3>
            <table style="width:100%;border-collapse:collapse;font-size:12px;">
              <tbody>
                <tr>
                  <td style="padding:4px 6px;width:120px;font-family:monospace;">sel + Tab</td>
                  <td style="padding:4px 6px;white-space:nowrap;">SELECT * FROM ...;</td>
                </tr>
                <tr>
                  <td style="padding:4px 6px;font-family:monospace;">sel1 + Tab</td>
                  <td style="padding:4px 6px;white-space:nowrap;">SELECT 1 FROM ...;</td>
                </tr>
                <tr>
                  <td style="padding:4px 6px;font-family:monospace;">ins + Tab</td>
                  <td style="padding:4px 6px;white-space:nowrap;">INSERT INTO ... VALUES ...;</td>
                </tr>
                <tr>
                  <td style="padding:4px 6px;font-family:monospace;">upd + Tab</td>
                  <td style="padding:4px 6px;white-space:nowrap;">UPDATE ... SET ... WHERE ...;</td>
                </tr>
                <tr>
                  <td style="padding:4px 6px;font-family:monospace;">del + Tab</td>
                  <td style="padding:4px 6px;white-space:nowrap;">DELETE FROM ... WHERE ...;</td>
                </tr>
              </tbody>
            </table>
            <p class="muted" style="margin-top:4px;">
              에디터에서 단축 키워드를 입력한 뒤 <span style="font-family:monospace;">Tab</span> 키를 누르면
              스니펫이 확장됩니다.
            </p>
          </div>
        </div>
      </div>

      <div style="border-top:1px solid #e5e7eb; padding:8px 12px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" class="btn" onclick="ui.closeShortcutHelpModal()">닫기</button>
      </div>
    </div>
  </div>


  
  <!-- 즐겨찾기 / 템플릿 저장 모달 (프로토타입) -->
  <div id="favSaveBackdrop"
       class="export-modal-backdrop hidden"
       role="dialog"
       aria-modal="true"
       aria-hidden="true">
    <div class="export-modal" style="max-width:640px;">
      <div class="export-modal-header">
        <h2>
          <i class="fa-solid fa-star"></i>
          <span style="margin-left:4px;">즐겨찾기 / 템플릿 저장</span>
        </h2>
        <button type="button"
                class="btn-icon"
                onclick="ui.closeFavSaveModal()"
                aria-label="닫기">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="export-modal-body">
        <p class="muted" style="margin-bottom:8px;">
          현재 활성 SQL 탭의 내용을 개인 즐겨찾기 또는 조직 공용 템플릿으로 저장합니다. (서버 연동 전, 프로토타입)
        </p>

        <div style="display:flex; flex-direction:column; gap:8px;">
          <div>
            <label style="font-weight:bold; margin-right:8px;">저장 대상</label>
            <label style="margin-right:12px;">
              <input type="radio" name="favSaveType" value="PERSONAL" checked>
              개인 즐겨찾기
            </label>
            <label>
              <input type="radio" name="favSaveType" value="ORG">
              조직 공용 템플릿
            </label>
          </div>

          <div>
            <label style="display:block; font-weight:bold; margin-bottom:2px;">
              제목
            </label>
            <input type="text" id="favSaveName" style="width:100%;" maxlength="100" />
          </div>

          <div>
            <label style="display:block; font-weight:bold; margin-bottom:2px;">
              설명
            </label>
            <textarea id="favSaveDesc" rows="2" style="width:100%;"></textarea>
          </div>

          <div style="display:flex; flex-wrap:wrap; gap:12px;">
            <div style="flex:1 1 140px;">
              <label style="display:block; font-weight:bold; margin-bottom:2px;">카테고리</label>
              <select id="favSaveCategory" style="width:100%;">
                <option value="MONITOR">모니터링</option>
                <option value="HISTORY">이력</option>
                <option value="BATCH">배치</option>
                <option value="ETC" selected>기타</option>
              </select>
            </div>
            <div style="flex:1 1 140px;">
              <label style="display:block; font-weight:bold; margin-bottom:2px;">업무명</label>
              <select id="favSaveBiz" style="width:100%;">
                <option value="MSG">메신저</option>
                <option value="PORTAL">포탈</option>
                <option value="COMMON" selected>공통</option>
                <option value="ETC">기타</option>
              </select>
            </div>
          </div>

          <div style="display:flex; flex-wrap:wrap; gap:12px;">
            <div style="flex:1 1 140px;" data-favsave-orgonly="true">
              <label style="display:block; font-weight:bold; margin-bottom:2px;">대상 시스템</label>
              <select id="favSaveTargetSys" style="width:100%;">
                <option value="">선택</option>
                <option value="DEV">DEV</option>
                <option value="STG">STG</option>
                <option value="PRD">PRD</option>
              </select>
            </div>
            <div style="flex:1 1 160px;" data-favsave-orgonly="true">
              <label style="display:block; font-weight:bold; margin-bottom:2px;">대상 DB</label>
              <input type="text" id="favSaveTargetDb" style="width:100%;" />
            </div>
          </div>

          <div>
            <label style="display:block; font-weight:bold; margin-bottom:2px;">태그 (쉼표로 구분)</label>
            <input type="text" id="favSaveTags" style="width:100%;" placeholder="monitor,session,lock" />
          </div>

          <div>
            <label style="display:block; font-weight:bold; margin-bottom:2px;">저장될 SQL 미리보기</label>
            <textarea id="favSaveSqlPreview" rows="6" style="width:100%;"></textarea>
          </div>
        </div>
      </div>

      <div style="border-top:1px solid #e5e7eb; padding:8px 12px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" class="btn" onclick="ui.closeFavSaveModal()">취소</button>
        <button type="button" class="btn primary" onclick="ui.applyFavSaveModal()">저장</button>
      </div>
    </div>
  </div>


<!-- 테이블 편집 모달 (DBeaver 스타일 간단 버전) -->
  <div id="tableEditBackdrop"
       class="export-modal-backdrop hidden"
       role="dialog"
       aria-modal="true"
       aria-hidden="true">
    <div class="export-modal table-edit-modal">
      <div class="export-modal-header">
        <h2>
          <i class="fa-solid fa-table"></i>
          <span style="margin-left:4px;">테이블 편집</span>
        </h2>
        <button type="button"
                class="btn-icon table-edit-close-btn"
                onclick="tableEditor.close()"
                aria-label="닫기">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="export-modal-body table-edit-body">
        <!-- 상단 테이블 정보 -->
        <div class="te-header">
          <div class="te-table-name" id="teTableTitle">SCHEMA.TABLE</div>
          <div class="te-table-meta" id="teTableMeta"></div>
        </div>

        <!-- 1단 탭: Properties / Data / ER Diagram -->
        <div class="te-tabs" role="tablist">
          <button type="button"
                  class="te-tab-btn active"
                  data-main-tab="props"
                  onclick="tableEditor.activateMainTab('props')">
            Properties
          </button>
          <button type="button"
                  class="te-tab-btn"
                  data-main-tab="data"
                  onclick="tableEditor.activateMainTab('data')">
            Data
          </button>
          <button type="button"
                  class="te-tab-btn"
                  data-main-tab="erd"
                  onclick="tableEditor.activateMainTab('erd')">
            ER Diagram
          </button>
        </div>

        <div class="te-main-panes">
          <!-- Properties 탭 -->
          <div id="tePaneProps" class="te-pane active" data-main-pane="props">
            <!-- 2단 서브탭 -->
            <div class="te-subtabs" role="tablist">
              <button type="button" class="te-subtab-btn active"
                      data-sub-tab="columns"
                      onclick="tableEditor.activateSubTab('columns')">
                Columns
              </button>
              <button type="button" class="te-subtab-btn"
                      data-sub-tab="constraints"
                      onclick="tableEditor.activateSubTab('constraints')">
                Constraints
              </button>
              <button type="button" class="te-subtab-btn"
                      data-sub-tab="fks"
                      onclick="tableEditor.activateSubTab('fks')">
                Foreign Keys
              </button>
              <button type="button" class="te-subtab-btn"
                      data-sub-tab="indexes"
                      onclick="tableEditor.activateSubTab('indexes')">
                Indexes
              </button>
              <button type="button" class="te-subtab-btn"
                      data-sub-tab="deps"
                      onclick="tableEditor.activateSubTab('deps')">
                Dependencies
              </button>
              <button type="button" class="te-subtab-btn"
                      data-sub-tab="refs"
                      onclick="tableEditor.activateSubTab('refs')">
                References
              </button>
              <button type="button" class="te-subtab-btn"
                      data-sub-tab="parts"
                      onclick="tableEditor.activateSubTab('parts')">
                Partitions
              </button>
              <button type="button" class="te-subtab-btn"
                      data-sub-tab="triggers"
                      onclick="tableEditor.activateSubTab('triggers')">
                Triggers
              </button>
              <button type="button" class="te-subtab-btn"
                      data-sub-tab="rules"
                      onclick="tableEditor.activateSubTab('rules')">
                Rules
              </button>
              <button type="button" class="te-subtab-btn"
                      data-sub-tab="stats"
                      onclick="tableEditor.activateSubTab('stats')">
                Statistics
              </button>
              <button type="button" class="te-subtab-btn"
                      data-sub-tab="perms"
                      onclick="tableEditor.activateSubTab('perms')">
                Permissions
              </button>
              <button type="button" class="te-subtab-btn"
                      data-sub-tab="ddl"
                      onclick="tableEditor.activateSubTab('ddl')">
                DDL
              </button>
            </div>

            <!-- Columns 서브패널 -->
            <div class="te-subpane active" data-sub-pane="columns">
              <div class="te-table-wrapper">
                <table class="grid te-grid" id="teColumnsGrid">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Column</th>
                      <th>Type</th>
                      <th>Nullable</th>
                      <th>Default</th>
                      <th>Comment</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- JS로 채움 -->
                  </tbody>
                </table>
              </div>
              <p class="muted" style="margin-top:4px;font-size:11px;">
                ※ 현재는 SQL 힌트 테이블에 있는 컬럼 정보만 사용하며,
                실제 DB 메타데이터 연동은 백엔드 구현 후 적용됩니다.
              </p>
            </div>

            <!-- 나머지 서브패널: 일단 플레이스홀더 -->
            <div class="te-subpane" data-sub-pane="constraints">
              <div class="te-placeholder">Constraints 정보는 추후 DB 메타데이터 연동 시 채워집니다.</div>
            </div>
            <div class="te-subpane" data-sub-pane="fks">
              <div class="te-placeholder">Foreign Keys 정보는 추후 DB 메타데이터 연동 시 채워집니다.</div>
            </div>
            <div class="te-subpane" data-sub-pane="indexes">
              <div class="te-placeholder">Indexes 정보는 추후 DB 메타데이터 연동 시 채워집니다.</div>
            </div>
            <div class="te-subpane" data-sub-pane="deps">
              <div class="te-placeholder">Dependencies 정보는 추후 DB 메타데이터 연동 시 채워집니다.</div>
            </div>
            <div class="te-subpane" data-sub-pane="refs">
              <div class="te-placeholder">References 정보는 추후 DB 메타데이터 연동 시 채워집니다.</div>
            </div>
            <div class="te-subpane" data-sub-pane="parts">
              <div class="te-placeholder">Partitions 정보는 추후 DB 메타데이터 연동 시 채워집니다.</div>
            </div>
            <div class="te-subpane" data-sub-pane="triggers">
              <div class="te-placeholder">Triggers 정보는 추후 DB 메타데이터 연동 시 채워집니다.</div>
            </div>
            <div class="te-subpane" data-sub-pane="rules">
              <div class="te-placeholder">Rules 정보는 추후 DB 메타데이터 연동 시 채워집니다.</div>
            </div>
            <div class="te-subpane" data-sub-pane="stats">
              <div class="te-placeholder">Statistics 정보는 추후 DB 메타데이터 연동 시 채워집니다.</div>
            </div>
            <div class="te-subpane" data-sub-pane="perms">
              <div class="te-placeholder">Permissions 정보는 추후 DB 메타데이터 연동 시 채워집니다.</div>
            </div>
            <div class="te-subpane" data-sub-pane="ddl">
              <pre id="teDdlText" class="te-ddl"></pre>
            </div>
          </div>

          <!-- Data 탭 -->
          <div id="tePaneData" class="te-pane" data-main-pane="data">
            <div class="te-table-wrapper">
              <table class="grid te-grid" id="teDataGrid">
                <thead>
                  <tr>
                    <th>데이터 조회는 추후 SQL 실행엔진 연동 시 구현 예정입니다.</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>예: SELECT * FROM SCHEMA.TABLE FETCH FIRST 100 ROWS ONLY</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p class="muted" style="margin-top:4px;font-size:11px;">
              ※ 현재는  메시지만 표시하며, 실제 데이터 조회는 에디터의 SQL 실행과 연동해서 구현해야 합니다.
            </p>
          </div>

          <!-- ER Diagram 탭 (UI만) -->
          <div id="tePaneErd" class="te-pane" data-main-pane="erd">
            <div class="te-placeholder">
              ER Diagram 탭은 아직 구현되지 않았습니다. (레이아웃만 준비)
            </div>
          </div>
        </div>
      </div>

      <div class="export-modal-footer"
           style="border-top:1px solid #e5e7eb;padding:8px 12px;display:flex;justify-content:flex-end;gap:8px;">
        <button type="button" class="btn" onclick="tableEditor.close()">닫기</button>
      </div>
    </div>
  </div>

<!-- 내 설정 모달 (관리 콘솔 스타일) -->
  <div id="passwordChangeBackdrop"
       class="export-modal-backdrop hidden"
       role="dialog" aria-modal="true" aria-hidden="true">
    <div class="export-modal" style="max-width: 420px;">
      <div style="display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e5e7eb; padding:10px 12px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <div style="width:28px; height:28px; border-radius:50%; background:rgba(0,132,133,0.06); display:flex; align-items:center; justify-content:center; color:var(--hana-primary,#008485);">
            <i class="fa-solid fa-key"></i>
          </div>
          <div>
            <div style="font-size:14px; font-weight:600; color:var(--ink,#111827);">비밀번호 변경</div>
            <div style="font-size:11px; color:#6b7280; margin-top:2px;">현재 비밀번호 확인 후 새 비밀번호를 설정합니다.</div>
          </div>
        </div>
        <button type="button"
                style="border:none; background:transparent; cursor:pointer; padding:2px; color:#6b7280;"
                onclick="closePasswordChangeModal()"
                aria-label="닫기">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div style="padding:12px 14px 10px 14px; font-size:12px;">
        <div style="margin-bottom:8px; color:#6b7280;">
           UI 상태이며 실제 비밀번호 변경은 서버 API 연동 후 적용됩니다.
        </div>

        <div class="export-group" style="margin-bottom:8px;">
          <label for="pcCurrentPwd" style="display:block; margin-bottom:3px;">현재 비밀번호</label>
          <input type="password"
                 id="pcCurrentPwd"
                 class="export-input"
                 autocomplete="off"
                 style="width:100%; box-sizing:border-box;">
        </div>

        <div class="export-group" style="margin-bottom:8px;">
          <label for="pcNewPwd" style="display:block; margin-bottom:3px;">새 비밀번호</label>
          <input type="password"
                 id="pcNewPwd"
                 class="export-input"
                 autocomplete="off"
                 style="width:100%; box-sizing:border-box;">
        </div>

        <div class="export-group" style="margin-bottom:4px;">
          <label for="pcNewPwdConfirm" style="display:block; margin-bottom:3px;">새 비밀번호 확인</label>
          <input type="password"
                 id="pcNewPwdConfirm"
                 class="export-input"
                 autocomplete="off"
                 style="width:100%; box-sizing:border-box;">
        </div>

        <div style="font-size:11px; color:#9ca3af; margin-top:2px;">
          ※ 실제 비밀번호 규칙(길이/조합 등)은 시스템 정책에 따라 검증합니다.
        </div>
      </div>

      <div class="export-modal-footer" style="border-top:1px solid #e5e7eb; padding:8px 12px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" class="btn" onclick="closePasswordChangeModal()">취소</button>
        <button type="button" class="btn primary" onclick="confirmPasswordChange()">변경</button>
      </div>
    </div>
  </div>


  <!-- 부재중 & 대결자 관리 모달 -->
  <div id="absenceModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="absenceModalTitle">
      <div class="modal-header">
        <div class="modal-title" id="absenceModalTitle">부재중 &amp; 대결자 관리</div>
        <button type="button" class="modal-close-btn" id="absenceModalCloseBtn" aria-label="닫기">×</button>
      </div>
      <div class="modal-body">
        <!-- 탭 헤더 -->
        <div class="tab-header">
          <button type="button" class="tab-btn active" data-tab="form">부재 설정</button>
          <button type="button" class="tab-btn" data-tab="history">이력</button>
        </div>

        <!-- 현재 상태 카드 -->
        <div id="currentStatusCard" class="status-card inactive">
          <div>
            <div class="status-chip expired" id="currentStatusChip">부재 설정 없음</div>
            <div class="status-meta" id="currentStatusText">
              현재 부재/대결자 설정이 없습니다.
            </div>
            <div class="helper-text" id="currentStatusSubText">
              부재 기간과 대결자를 등록하면, 지정된 기간 동안 결재 권한이 대결자에게 위임됩니다.
            </div>
          </div>
          <div class="status-actions">
            <button type="button" class="btn btn-outline btn-sm" id="btnCurrentEnd" disabled>지금 해제</button>
            <button type="button" class="btn btn-ghost btn-sm" id="btnCurrentExtend" disabled>기간 연장</button>
          </div>
        </div>

        <!-- 탭 패널: 부재 설정 -->
        <div id="tab-form" class="tab-panel active">
          <div class="form-section">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="absenceType">
                  부재 유형<span class="req">*</span>
                </label>
                <select id="absenceType" class="form-select">
                  <option value="연차">연차</option>
                  <option value="반차">반차</option>
                  <option value="출장">출장</option>
                  <option value="기타">기타</option>
                </select>
                <div class="helper-text">
                  연차/출장 등 부재 사유를 선택하세요.
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  부재 기간<span class="req">*</span>
                </label>
                <div class="inline-row">
                  <input type="datetime-local" id="startDate" class="form-control" />
                  <span style="font-size:12px;">~</span>
                  <input type="datetime-local" id="endDate" class="form-control" />
                </div>
                <div id="dateError" class="error-text" style="display:none;"></div>
              </div>
              <div class="form-group">
                <label class="form-label">
                  대결자<span class="req">*</span>
                </label>
                <div class="inline-row">
                  <input type="text" id="delegateName" class="form-control" placeholder="대결자는 [찾기] 버튼으로만 선택 가능합니다" readonly />
                  <button type="button" class="btn btn-outline btn-sm" id="btnSearchDelegate">찾기</button>
                </div>
                <div class="helper-text">
                  조직도에서 [찾기] 버튼을 눌러 대결자를 선택하세요.
                </div>
                <div id="delegateError" class="error-text" style="display:none;"></div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">알림 설정</label>
                <div class="checkbox-group">
                  <label class="checkbox-item">
                    <input type="checkbox" id="notifyDelegate" checked /> 대결자에게 알림 보내기
                  </label>
                  <label class="checkbox-item">
                    <input type="checkbox" id="notifyMe" /> 나에게도 알림 사본 보내기
                  </label>
                </div>
                <div class="helper-text">
                  실제 시스템에서는 메일/메신저/알림센터 등과 연계할 수 있습니다.
                </div>
              </div>

              <div class="form-group form-group-wide">
                <label class="form-label">사유</label>
                <textarea id="reason" class="form-textarea" placeholder="예) 12/10~12/12 연차로 인한 결재 대행 요청"></textarea>
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-group" style="margin-top:4px;">
              <label class="form-label">빠른 기간 설정</label>
              <div class="quick-buttons">
                <button type="button" class="btn btn-outline btn-sm" data-quick="today">오늘 하루</button>
                <button type="button" class="btn btn-outline btn-sm" data-quick="tomorrow">내일 하루</button>
                <button type="button" class="btn btn-outline btn-sm" data-quick="thisWeek">이번 주까지</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 탭 패널: 이력 -->
        <div id="tab-history" class="tab-panel">
          <div style="margin-bottom:6px;font-size:12px;color:#4b5563;">
            최근 등록된 부재/대결자 설정 목록입니다. 상태, 종료 유형 등을 통해 실제 적용 이력을 확인할 수 있습니다.
          </div>
          <div id="historyEmpty" class="empty-text">
            등록된 부재/대결자 이력이 없습니다.
          </div>
          <div id="historyTableWrapper" style="display:none;">
            <table>
              <thead>
                <tr>
                  <th style="width:80px;text-align:center;">상태</th>
                  <th style="width:210px;text-align:center;">부재 기간</th>
                  <th style="width:110px;text-align:center;">대결자</th>
                  <th style="width:160px;text-align:center;">사유</th>
                  <th style="width:90px;text-align:center;">종료 유형</th>
                  <th style="width:120px;text-align:center;">조작</th>
                </tr>
              </thead>
              <tbody id="historyTbody">
              </tbody>
            </table>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <div class="helper-text">
          저장 후 즉시 적용되며, 지정된 기간이 지나면 자동으로 해제됩니다.
        </div>
        <div class="right">
          <button type="button" class="btn btn-ghost" id="absenceModalCancelBtn">취소</button>
          <button type="button" class="btn btn-primary" id="absenceModalSaveBtn">저장</button>
        </div>
      </div>
    </div>
  </div>

  

  <div id="mySettingsBackdrop"
       class="export-modal-backdrop hidden"
       role="dialog" aria-modal="true" aria-hidden="true">
    <div class="export-modal" style="max-width: 960px; padding: 0;">
      <div style="display:flex; border-bottom:1px solid #e5e7eb; padding:14px 16px 10px 16px; align-items:center; gap:10px;">
        <div style="width:32px; height:32px; border-radius:50%; background:var(--hana-primary-soft,#e2f3f0); display:flex; align-items:center; justify-content:center; color:var(--hana-primary,#008485);">
          <i class="fa-solid fa-user-gear"></i>
        </div>
        <div style="flex:1;">
          <div style="font-size:15px; font-weight:600; color:var(--ink,#111827);">내 설정</div>
          <div style="font-size:12px; color:#6b7280; margin-top:2px;">알림·MFA, 부재중 대결자, 기타 기본값을 한 번에 관리합니다.</div>
        </div>
      </div>

      
      <div style="min-height:320px;">
        <section style="padding:14px 16px 12px 16px; font-size:12px;">

            <div class="admin-card" style="margin-bottom:10px;">
              <div style="font-weight:600; margin-bottom:4px; display:flex; align-items:center; gap:6px;">
                <i class="fa-solid fa-bell"></i>
                <span>알림 채널 / MFA</span>
              </div>
              <div style="font-size:11px; color:#6b7280; margin-bottom:8px;">
                승인 알림, 경고 알림, MFA 인증 코드를 어떤 채널로 받을지 선택합니다.
              </div>
              <div style="display:flex; flex-wrap:wrap; gap:10px;">
                <label style="display:flex; align-items:center; gap:4px;">
                  <input type="radio" name="msNotifyChannel" id="msNotifyChannelMail" value="MAIL" checked> 이메일
                </label>
                <label style="display:flex; align-items:center; gap:4px;">
                  <input type="radio" name="msNotifyChannel" id="msNotifyChannelMessenger" value="MESSENGER"> 메신저
                </label>
                <label style="display:flex; align-items:center; gap:4px;">
                  <input type="radio" name="msNotifyChannel" id="msNotifyChannelBoth" value="MAIL_MESSENGER"> 이메일+메신저
                </label>
              </div>
              <div style="margin-top:8px; font-size:11px; color:#6b7280;">
                ※ 실제 발송 채널은 조직 보안 정책에 따라 제한될 수 있습니다.
              </div>
            </div>

            
          

            <div class="admin-card">
              <div style="font-weight:600; margin-bottom:4px; display:flex; align-items:center; gap:6px;">
                <i class="fa-solid fa-sliders"></i>
                <span>기타 기본값</span>
              </div>
              <div style="font-size:11px; color:#6b7280; margin-bottom:8px;">
                개인별로 선호하는 기본 적용값을 설정합니다. (예: 기본 쿼리 타임아웃, SQL 서식 정리 등)
              </div>
              <div style="display:flex; flex-direction:column; gap:8px; max-width:380px;">
                
                <div>
                  <label style="display:block; font-weight:600; margin-bottom:4px;">기본 쿼리 타임아웃(초)</label>
                  <input type="number" id="msDefaultTimeout" class="export-input" min="0" step="1" placeholder="예: 60">
                </div>
                <div>
                  <label style="display:block; font-weight:600; margin-bottom:4px;">SQL 서식 정리</label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#4b5563;">
                    <input type="checkbox" id="msFormatBreakLines">
                    <span>예약어/콤마 기준으로 줄바꿈 적용 (SQL Developer 형식 유사)</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#4b5563; margin-top:4px;">
                    <input type="checkbox" id="msFormatUpperAll">
                    <span>예약어 외 컬럼/조건 등 식별자도 대문자로 변환</span>
                  </label>
                </div>
                <div style="margin-top:6px;">
                  <label style="display:block; font-weight:600; margin-bottom:4px;">에디터 자동 임시저장</label>
                  <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#4b5563;">
                    <input type="checkbox" id="msAutoSaveEditor">
                    <span style="white-space:nowrap;">에디터 내용을 브라우저에 자동 임시저장 (세션 타임아웃/창닫힘 대비)</span>
                  </label>
                  <div style="margin-top:4px; display:flex; align-items:center; gap:6px; font-size:12px; color:#4b5563;">
                    <span>주기(초)</span>
                    <input type="number" id="msAutoSaveInterval" class="export-input" min="3" step="1" style="width:70px;" placeholder="예: 5">
                  </div>
                </div>
              </div>
            </div>
          
        </section>
      </div>

      <div style="border-top:1px solid #e5e7eb; padding:8px 12px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button" class="btn" onclick="closeMySettings()">닫기</button>
        <button type="button" class="btn primary" onclick="saveMySettings()">저장</button>
      </div>
    </div>
  </div>

  <script>

    function openDelegateSettingsModal() {
      var el = document.getElementById('delegateSettingsBackdrop');
      if (!el) return;
      el.classList.remove('hidden');
      el.classList.add('show');
      el.setAttribute('aria-hidden','false');
    }

    function closeDelegateSettingsModal() {
      var el = document.getElementById('delegateSettingsBackdrop');
      if (!el) return;
      el.classList.remove('show');
      el.classList.add('hidden');
      el.setAttribute('aria-hidden','true');
    }

    function saveDelegateSettings() {
      // TODO: 서버 연동 시 실제 저장 로직 추가
      alert('부재중 / 대결자 설정은  상태입니다.\n실제 저장은 서버 연동 후 구현해야 합니다.');
      closeDelegateSettingsModal();
    }

    function openMySettings() {
      var el = document.getElementById('mySettingsBackdrop');
      if (!el) return;
      // 현재 state 값으로 기본 타임아웃 및 서식 옵션 초기화
      try {
        var t = document.getElementById('msDefaultTimeout');
        if (t && typeof state !== 'undefined') {
          var ms = state.queryTimeoutMs || 15000;
          t.value = Math.round(ms / 1000);
        }
        var f = document.getElementById('msFormatBreakLines');
        if (f && typeof state !== 'undefined') {
          f.checked = !!state.formatBreakLines;
        }
        var u = document.getElementById('msFormatUpperAll');
        if (u && typeof state !== 'undefined') {
          u.checked = !!state.formatUpperAll;
        }
        var a = document.getElementById('msAutoSaveEditor');
        if (a && typeof state !== 'undefined') {
          a.checked = !!state.autoSaveEditor;
        }
        var ai = document.getElementById('msAutoSaveInterval');
        if (ai && typeof state !== 'undefined') {
          var isec = state.autoSaveIntervalSec || 5;
          ai.value = isec;
        }
      } catch (e) {}
      el.classList.remove('hidden');
      el.classList.add('show');
      el.setAttribute('aria-hidden','false');
    }
    function closeMySettings() {
      var el = document.getElementById('mySettingsBackdrop');
      if (!el) return;
      el.classList.remove('show');
      el.classList.add('hidden');
      el.setAttribute('aria-hidden','true');
    }
    ;
    function saveMySettings() {
      try {
        var t = document.getElementById('msDefaultTimeout');
        if (t && t.value !== '') {
          var sec = parseInt(t.value, 10);
          if (!isNaN(sec) && sec > 0 && typeof state !== 'undefined') {
            state.queryTimeoutMs = sec * 1000;
          }
        }
        var f = document.getElementById('msFormatBreakLines');
        if (f && typeof state !== 'undefined') {
          state.formatBreakLines = !!f.checked;
        }
        var u = document.getElementById('msFormatUpperAll');
        if (u && typeof state !== 'undefined') {
          state.formatUpperAll = !!u.checked;
        }
        var a = document.getElementById('msAutoSaveEditor');
        if (a && typeof state !== 'undefined') {
          state.autoSaveEditor = !!a.checked;
        }
        var ai = document.getElementById('msAutoSaveInterval');
        if (ai && ai.value !== '' && typeof state !== 'undefined') {
          var isec = parseInt(ai.value, 10);
          if (!isNaN(isec) && isec >= 3 && isec <= 600) {
            state.autoSaveIntervalSec = isec;
          }
        }
        if (typeof initAutoSaveTimer === 'function') {
          initAutoSaveTimer();
        }
      } catch (e) {}
      alert('내 설정 값은 이 세션에서만 적용됩니다.\n실제 영구 저장은 서버 연동 후 구현해야 합니다.');
      closeMySettings();
    }

    function openPasswordChangeModal() {
      var backdrop = document.getElementById('passwordChangeBackdrop');
      if (!backdrop) return;

      var curr = document.getElementById('pcCurrentPwd');
      var np   = document.getElementById('pcNewPwd');
      var npc  = document.getElementById('pcNewPwdConfirm');

      if (curr) curr.value = '';
      if (np)   np.value   = '';
      if (npc)  npc.value  = '';

      backdrop.classList.remove('hidden');
      backdrop.classList.add('show');
      backdrop.setAttribute('aria-hidden','false');

      setTimeout(function(){
        if (curr) curr.focus();
      }, 10);
    }

    function closePasswordChangeModal() {
      var backdrop = document.getElementById('passwordChangeBackdrop');
      if (!backdrop) return;
      backdrop.classList.remove('show');
      backdrop.classList.add('hidden');
      backdrop.setAttribute('aria-hidden','true');
    }

    function confirmPasswordChange() {
      var curr = document.getElementById('pcCurrentPwd');
      var np   = document.getElementById('pcNewPwd');
      var npc  = document.getElementById('pcNewPwdConfirm');

      var currVal = curr ? curr.value : '';
      var npVal   = np   ? np.value   : '';
      var npcVal  = npc  ? npc.value  : '';

      if (!currVal || !npVal || !npcVal) {
        alert('현재 비밀번호와 새 비밀번호, 확인 값을 모두 입력하세요.');
        return;
      }
      if (npVal !== npcVal) {
        alert('새 비밀번호와 확인 값이 일치하지 않습니다.');
        if (npc) npc.focus();
        return;
      }

      alert('비밀번호 변경 요청은 서버 연동 후 적용됩니다.\n현재는 UI 동작만 확인하는 상태입니다.');
      closePasswordChangeModal();
    }

  </script>

  <script>
    // 간단한 환경 필터 + 검색 기능
    (function(){
      const toolbar = document.querySelector('.db-access-toolbar');
      if(!toolbar) return;
      const buttons = toolbar.querySelectorAll('button[data-env]');
      const searchInput = document.getElementById('dbSearchInput');
      const rows = document.querySelectorAll('#dbAccessTable tbody tr');

      let currentEnv = 'ALL';
      let currentText = '';

      function applyFilter(){
        const text = currentText.trim().toLowerCase();
        rows.forEach(function(tr){
          const env = tr.getAttribute('data-env') || 'DEV';
          let ok = true;

          if(currentEnv !== 'ALL' && env !== currentEnv){
            ok = false;
          }
          if(ok && text){
            const content = tr.textContent.toLowerCase();
            if(content.indexOf(text) === -1){
              ok = false;
            }
          }
          tr.style.display = ok ? '' : 'none';
        });
      }

      buttons.forEach(function(btn){
        btn.addEventListener('click', function(){
          const env = btn.getAttribute('data-env') || 'ALL';
          currentEnv = env;
          buttons.forEach(function(b){ b.classList.remove('is-active'); });
          btn.classList.add('is-active');
          applyFilter();
        });
      });

      if(searchInput){
        searchInput.addEventListener('input', function(){
          currentText = searchInput.value || '';
          applyFilter();
        });
      }
    })();
  </script>

<script>
document.addEventListener('DOMContentLoaded', function(){
    try{
      var userToggle = document.getElementById('headerUserToggle');
      var userDropdown = document.getElementById('headerUserDropdown');
      if (userToggle && userDropdown) {
        userToggle.addEventListener('click', function(e){
          e.stopPropagation();
          var isOpen = userDropdown.classList.contains('open');
          if (isOpen) {
            userDropdown.classList.remove('open');
            userToggle.setAttribute('aria-expanded','false');
          } else {
            userDropdown.classList.add('open');
            userToggle.setAttribute('aria-expanded','true');
          }
        });
        document.addEventListener('click', function(e){
          if (!userDropdown.classList.contains('open')) return;
          if (userDropdown.contains(e.target) || userToggle.contains(e.target)) return;
          userDropdown.classList.remove('open');
          userToggle.setAttribute('aria-expanded','false');
        });
        userDropdown.addEventListener('click', function(e){
          var btn = e.target.closest('button[data-action]');
          if (!btn) return;

          var action = btn.getAttribute('data-action');
          if (action === 'profile') {
            if (window.ui && typeof ui.openMyInfoModal === 'function') {
              ui.openMyInfoModal();
            }
          } else if (action === 'settings') {
            if (typeof openMySettings === 'function') {
              openMySettings();
            } else {
              alert('내 설정 화면은 서버 연동 후 구현 예정입니다.');
            }
          } else if (action === 'delegate') {
            if (typeof openDelegateSettingsModal === 'function') {
              openDelegateSettingsModal();
            } else {
              alert('부재중 / 대결자 설정 모달 스크립트가 로딩되지 않았습니다.');
            }
          } else if (action === 'password') {
            if (typeof openPasswordChangeModal === 'function') {
              openPasswordChangeModal();
            } else {
              alert('비밀번호 변경 기능은 스크립트 로딩 후 동작합니다.');
            }
          } else if (action === 'logout') {
            alert('로그아웃은 서버 세션 연동 후 구현해야 합니다.');
          }
          userDropdown.classList.remove('open');
          userToggle.setAttribute('aria-expanded','false');
        });
      }
      var notifBtn = document.getElementById('headerNotifBtn');
      if (notifBtn) {
        notifBtn.addEventListener('click', function(e){
          e.preventDefault();
          e.stopPropagation();
          alert('알림 센터는 서버 연동 전입니다.\n샘플 알림만 표시됩니다.');
        });
      }

      // 탭 오버플로 메뉴 바깥 클릭 시 자동 닫기
      try{
        var overflowBtn = document.getElementById('tabOverflowBtn');
        var overflowMenu = document.getElementById('tabOverflowMenu');
        if (overflowBtn) {
          overflowBtn.addEventListener('click', function(e){
            // 버튼 클릭 시에는 문서 클릭 핸들러로 전파되지 않도록
            e.stopPropagation();
          });
        }
        if (overflowMenu) {
          overflowMenu.addEventListener('click', function(e){
            // 메뉴 내부 클릭 시 닫히지 않도록
            e.stopPropagation();
          });
        }
        document.addEventListener('click', function(e){
          try{
            var menu = document.getElementById('tabOverflowMenu');
            var btn  = document.getElementById('tabOverflowBtn');
            if (!menu || !btn) return;
            if (menu.classList.contains('hidden')) return;
            if (menu.contains(e.target) || btn.contains(e.target)) return;
            if (window.ui && typeof ui.closeTabOverflowMenu === 'function') {
              ui.closeTabOverflowMenu();
            } else {
              menu.classList.add('hidden');
            }
          }catch(err){
            console.warn('global click for tabOverflowMenu error', err);
          }
        });
      }catch(e2){
        console.warn('init tab overflow auto-close error', e2);
      }
    } catch(e){}
  });
  </script>




  <!-- Query progress overlay -->
  <div id="queryProgressOverlay" class="query-progress-overlay" aria-hidden="true">
    <div class="qp-inner">
      <div class="qp-logo-wrap">
        <div class="qp-logo-pulse">
          <div class="qp-logo-circle">
            <div class="qp-logo-bar"></div>
          </div>
        </div>
        <div class="qp-logo-label">Hana DBAM</div>
      </div>
      <div class="qp-bar">
        <div class="qp-bar-fill"></div>
      </div>
      <div class="qp-text">쿼리 실행 중입니다…</div>
    </div>
  </div>

<div id="approvalRequestBackdrop"
       class="export-modal-backdrop hidden"
       role="dialog"
       aria-modal="true"
       aria-hidden="true">
    <div class="export-modal approval-modal" style="max-width:720px;">
      <div class="export-modal-header">
        <h2>
          <i class="fa-solid fa-stamp"></i>
          <span style="margin-left:4px;" data-role="apReqTitleText">위험 쿼리 승인 요청</span>
        </h2>
        <button type="button"
                class="btn-icon approval-close-btn"
                onclick="approvalCenter.closeRequestModal()"
                aria-label="닫기">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="export-modal-body" style="display:flex;flex-direction:column;gap:8px;">
        <div style="font-size:12px; color:#4b5563;" data-role="apReqGuide">
          개인정보/민감 테이블에 대한 쿼리는 바로 실행하지 않고 승인 요청 후 실행하도록 설계된 입니다.
        </div>
        <div style="display:grid;grid-template-columns:120px 1fr;gap:4px 8px;font-size:12px;">
          <div style="text-align:right;color:#6b7280;">DB / 연결</div>
          <div data-field="connLabel" style="font-weight:600;"></div>
          <div style="text-align:right;color:#6b7280;">스키마</div>
          <div data-field="schemaName"></div>
          <div style="text-align:right;color:#6b7280;">요청자</div>
          <div data-field="requester"></div>
          <div style="text-align:right;color:#6b7280;">업무명</div>
          <div data-field="bizName"></div>
          <div style="text-align:right;color:#6b7280;">위험 사유</div>
          <div data-field="riskReasons" style="white-space:pre-line;"></div>
        </div>
        <div>
          <label style="font-size:12px; color:#374151; display:block; margin-bottom:4px;">수행 쿼리</label>
          <textarea id="apReqSql"
                    readonly
                    style="width:100%;min-height:120px;font-family:var(--mono,monospace);font-size:12px;padding:6px 8px;border-radius:4px;border:1px solid #d1d5db;background:#f9fafb;"></textarea>
        </div>
        <div style="display:flex; flex-direction:column; gap:6px;">
          <label style="font-size:12px; color:#374151;" data-role="apReqReasonLabel">
            사유
            <textarea id="apReqReason"
                      style="width:100%;min-height:60px;font-size:12px;padding:4px 6px;border-radius:4px;border:1px solid #d1d5db;"
                      placeholder="왜 이 쿼리를 실행해야 하는지 업무 사유를 입력하세요."></textarea>
          </label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;">
            <label>
              ITSM/작업요청 번호 (선택)
              <input id="apReqTicket"
                     type="text"
                     placeholder="예: CHG-2025-000123"
                     style="width:100%;padding:4px 6px;border-radius:4px;border:1px solid #d1d5db;">
            </label>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px; margin-top:4px;">
            <label data-role="apReqExecCountLabel">
              허용 실행 횟수
              <select id="apReqExecCount" style="width:100%;padding:4px 6px;border-radius:4px;border:1px solid #d1d5db;">
                <option value="1">1회</option>
                <option value="3">3회</option>
                <option value="5">5회</option>
              </select>
            </label>
            <label>
              유효 기간
              <div style="display:flex; align-items:center; gap:4px;">
                <input id="apReqValidFrom"
                       type="datetime-local"
                       style="flex:1 1 auto;padding:4px 6px;border-radius:4px;border:1px solid #d1d5db;">
                <span style="font-size:11px;color:#6b7280;">~</span>
                <input id="apReqValidTo"
                       type="datetime-local"
                       style="flex:1 1 auto;padding:4px 6px;border-radius:4px;border:1px solid #d1d5db;">
              </div>
            </label>
          </div>
        </div>
      </div>

          <div style="margin-top:8px;border-top:1px dashed #e5e7eb;padding-top:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <div style="font-size:12px;color:#374151;font-weight:600;">결재선</div>
              <button type="button"
                      class="btn btn-sm"
                      id="openApprovalModal">
                <i class="fa-solid fa-sitemap"></i>
                <span style="margin-left:4px;">결재선 지정</span>
              </button>
            </div>
            <div style="border-radius:6px;border:1px dashed #e5e7eb;background:#f9fafb;padding:6px 8px;">
              <div style="display:flex;flex-wrap:wrap;align-items:center;gap:6px;" id="apReqApprovalPreviewLine">
                <span style="font-size:12px;color:#9ca3af;">결재선 미지정 상태입니다.</span>
              </div>
              <div style="margin-top:6px;margin-bottom:8px;font-size:12px;display:flex;flex-wrap:wrap;gap:6px;align-items:center;" id="apReqApprovalPreviewRef"></div>
              <input id="apReqApprover" type="hidden" value="">
            </div>
          </div>

      <div class="export-modal-footer" style="border-top:1px solid #e5e7eb;margin-top:8px;padding:8px 12px;display:flex;justify-content:flex-end;gap:8px;">
        <button type="button" class="btn" onclick="approvalCenter.closeRequestModal()">취소</button>
        <button type="button" class="btn btn-primary" onclick="approvalCenter.submitCurrentRequest()">
          <i class="fa-solid fa-paper-plane"></i>
          <span style="margin-left:4px;">승인 요청</span>
        </button>
      </div>
    </div>
  </div>

  <!-- 쿼리 결재 상세/실행 모달 (용) -->
  <div id="approvalDetailBackdrop"
       class="export-modal-backdrop hidden"
       role="dialog"
       aria-modal="true"
       aria-hidden="true">
    <div class="export-modal approval-modal" style="max-width:860px;">
      <div class="export-modal-header">
        <h2>
          <i class="fa-solid fa-stamp"></i>
          <span style="margin-left:4px;" data-role="apDetailTitleText">쿼리 결재 상세</span>
        </h2>
        <button type="button"
                class="btn-icon approval-close-btn"
                onclick="approvalCenter.closeDetailModal()"
                aria-label="닫기">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="export-modal-body" style="display:flex;flex-direction:column;gap:8px;">
        <div style="display:flex; flex-direction:column; align-items:flex-start; font-size:12px; gap:2px;">
          <div>
            상태:
            <span data-field="status"></span>
          </div>
          <div data-field="meta" style="color:#6b7280;font-size:11px;line-height:1.3;"></div>
        </div>
        <div style="display:grid;grid-template-columns:120px 1fr;gap:4px 8px;font-size:12px;">
          <div style="text-align:right;color:#6b7280;">DB / 연결</div>
          <div data-field="connLabel"></div>
          <div style="text-align:right;color:#6b7280;">스키마</div>
          <div data-field="schemaName"></div>
          <div style="text-align:right;color:#6b7280;">요청자</div>
          <div data-field="requester"></div>
          <div style="text-align:right;color:#6b7280;">업무명</div>
          <div data-field="bizName"></div>
          <div style="text-align:right;color:#6b7280;">승인자</div>
          <div>
          <div data-field="approver"></div>
          <div id="apDetailApprovalBox"
               style="margin-top:4px;border-radius:6px;border:1px dashed #e5e7eb;background:#f9fafb;padding:6px 8px;display:none;">
            <div id="apDetailApprovalLine"
                 style="display:flex;flex-wrap:wrap;align-items:center;gap:6px;"></div>
            <div id="apDetailApprovalRef"
                 style="margin-top:6px;font-size:12px;display:flex;flex-wrap:wrap;gap:6px;align-items:center;"></div>
          </div>
        </div>
          <div style="text-align:right;color:#6b7280;">위험 사유</div>
          <div data-field="riskReasons" style="white-space:pre-line;"></div>
          <div style="text-align:right;color:#6b7280;" data-role="apDetailReasonLabel">승인 요청 사유</div>
          <div data-field="requestReason" style="white-space:pre-line;"></div>
          <div id="apDetailRejectRow" style="text-align:right;color:#6b7280;">반려 사유</div>
          <div data-field="rejectReason" style="white-space:pre-line;"></div>
        </div>
        <div>
          <label id="apDetailSqlLabel" style="font-size:12px; color:#374151; display:block; margin-bottom:4px;">승인된 쿼리</label>
          <textarea id="apDetailSql"
                    readonly
                    style="width:100%;min-height:140px;font-family:var(--mono,monospace);font-size:12px;padding:6px 8px;border-radius:4px;border:1px solid #d1d5db;background:#f9fafb;"></textarea>
        </div>
        <div style="font-size:12px; color:#4b5563;" data-field="execInfo"></div>
        <div style="display:flex; align-items:center; gap:8px; font-size:12px;">
          <label data-role="apDetailExecCountLabel">
            허용 실행 횟수
            <select id="apDetailExecCount" style="margin-left:4px; padding:2px 6px; font-size:12px;">
              <option value="1">1회</option>
              <option value="3">3회</option>
              <option value="5">5회</option>
            </select>
          </label>
          <span class="muted" style="font-size:11px;">승인 단계에서만 수정됩니다.</span>
        </div>
        <div id="apDetailValidRange" style="font-size:12px; font-weight:600; margin:4px 0 10px 0;"></div>
      </div>
      <div class="export-modal-footer" style="border-top:1px solid #e5e7eb;padding:8px 12px;display:flex;justify-content:space-between;gap:8px;align-items:center;">
        <div style="font-size:11px; color:#6b7280;">
          승인된 쿼리는 이 화면에서만 실행되며, 에디터에서 수정된 SQL은 별도 승인 절차가 필요합니다.
        </div>
        <div style="display:flex; gap:8px;">
          <button type="button" id="apDetailReject" class="btn" onclick="approvalCenter.rejectCurrent()">반려</button>
          <button type="button" id="apDetailApprove" class="btn btn-primary" onclick="approvalCenter.approveCurrent()">
            <i class="fa-solid fa-check"></i>
            <span style="margin-left:4px;">승인</span>
          </button>
          <button type="button" id="apDetailRefConfirm" class="btn" onclick="approvalCenter.confirmRefCurrent()">
            <i class="fa-solid fa-check"></i>
            <span style="margin-left:4px;">참조확인</span>
          </button>
          <button type="button" id="apDetailExcelDownload" class="btn" onclick="approvalCenter.downloadExcelForCurrent()">
            <i class="fa-solid fa-file-excel"></i>
            <span style="margin-left:4px;">엑셀 다운로드</span>
          </button>
          <button type="button" id="apDetailExecute" class="btn" onclick="approvalCenter.executeCurrent()">
            <i class="fa-solid fa-play"></i>
            <span style="margin-left:4px;">승인된 쿼리 실행</span>
          </button>
        </div>
      </div>
    </div>
  </div>





  <script>

    // 간단한 in-memory 데이터 구조
    let delegations = [];
    let editingId = null;
    let nextId = 1;

    function syncDelegationsToGlobalAbsence() {
      try {
        var curId = (window.DBAM_CURRENT_USER || 'demoUser').trim();
        if (!curId) {
          console.warn('[부재중/대결자] DBAM_CURRENT_USER가 없어 부재 정보를 전파하지 않습니다.');
          return;
        }
        if (!Array.isArray(window.DBAM_ABSENCE)) {
          window.DBAM_ABSENCE = [];
        }

        // 현재 로그인 사용자(empId) 기준 기존 부재 정보 제거
        window.DBAM_ABSENCE = window.DBAM_ABSENCE.filter(function(item) {
          return !(item && item.empId === curId);
        });

        // 모달 내부 delegations 배열 기준으로 재구성
        (delegations || []).forEach(function(d) {
          if (!d) return;
          window.DBAM_ABSENCE.push({
            empId: curId,
            start: d.start,
            end: d.end,
            status: d.status || 'ACTIVE',
            reason: d.reason || '',
            // delegate: "개발1팀 홍길동 책임" 형식의 라벨
            delegate: d.delegate || '',
            // delegateId는 현재는 따로 저장하지 않지만,
            // findDelegateMember()에서 delegate 라벨로도 매핑하므로 없어도 동작함
            delegateId: d.delegateId || null
          });
        });

        console.log('[부재중/대결자] window.DBAM_ABSENCE 동기화 완료:', window.DBAM_ABSENCE);
      } catch (e) {
        console.warn('[부재중/대결자] syncDelegationsToGlobalAbsence 오류:', e);
      }
    }


    const profileBtn = document.getElementById('profileBtn');
    const profileMenu = document.getElementById('profileMenu');
    const absenceModalBackdrop = document.getElementById('absenceModalBackdrop');
    const absenceModalCloseBtn = document.getElementById('absenceModalCloseBtn');
    const absenceModalCancelBtn = document.getElementById('absenceModalCancelBtn');
    const absenceModalSaveBtn = document.getElementById('absenceModalSaveBtn');

    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabForm = document.getElementById('tab-form');
    const tabHistory = document.getElementById('tab-history');

    const currentStatusCard = document.getElementById('currentStatusCard');
    const currentStatusChip = document.getElementById('currentStatusChip');
    const currentStatusText = document.getElementById('currentStatusText');
    const currentStatusSubText = document.getElementById('currentStatusSubText');
    const btnCurrentEnd = document.getElementById('btnCurrentEnd');
    const btnCurrentExtend = document.getElementById('btnCurrentExtend');

    const absenceTypeEl = document.getElementById('absenceType');
    const startDateEl = document.getElementById('startDate');
    const endDateEl = document.getElementById('endDate');
    const delegateNameEl = document.getElementById('delegateName');
    const btnSearchDelegate = document.getElementById('btnSearchDelegate');
    const notifyDelegateEl = document.getElementById('notifyDelegate');
    const notifyMeEl = document.getElementById('notifyMe');
    const reasonEl = document.getElementById('reason');

    const dateErrorEl = document.getElementById('dateError');
    const delegateErrorEl = document.getElementById('delegateError');

    const quickButtons = document.querySelectorAll('.quick-buttons .btn');

    const historyEmpty = document.getElementById('historyEmpty');
    const historyTableWrapper = document.getElementById('historyTableWrapper');
    const historyTbody = document.getElementById('historyTbody');

        if (profileBtn && profileMenu) {
// 프로필 메뉴 토글
    profileBtn.addEventListener('click', function () {
      profileMenu.classList.toggle('open');
    });

    document.addEventListener('click', function (e) {
      if (!profileMenu.contains(e.target) && !profileBtn.contains(e.target)) {
        profileMenu.classList.remove('open');
      }
    });

    profileMenu.addEventListener('click', function (e) {
      const item = e.target.closest('.profile-menu-item');
      if (!item) return;
      const menu = item.getAttribute('data-menu');
      if (menu === 'absence') {
        openAbsenceModal();
      } else if (menu === 'password') {
        alert('비밀번호 변경 모달은 기존 구현과 연계하세요.');
      }
      profileMenu.classList.remove('open');
    });

    
    }

function openAbsenceModal() {
      editingId = null;
      resetForm();
      renderCurrentStatus();
      renderHistory();
      syncDelegationsToGlobalAbsence();
      switchTab('form');
      absenceModalBackdrop.classList.add('open');
    }

    function closeAbsenceModal() {
      absenceModalBackdrop.classList.remove('open');
    }

    absenceModalCloseBtn.addEventListener('click', closeAbsenceModal);
    absenceModalCancelBtn.addEventListener('click', closeAbsenceModal);

    absenceModalBackdrop.addEventListener('click', function (e) {
      if (e.target === absenceModalBackdrop) {
        closeAbsenceModal();
      }
    });

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && absenceModalBackdrop.classList.contains('open')) {
        // ESC는 전역 핸들러에서 처리
      }
    });

    // 탭 전환
    tabButtons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        const tab = btn.getAttribute('data-tab');
        switchTab(tab);
      });
    });

    function switchTab(tab) {
      tabButtons.forEach(function (btn) {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
      });
      tabForm.classList.toggle('active', tab === 'form');
      tabHistory.classList.toggle('active', tab === 'history');
    }

    // 현재 상태 렌더링
    function renderCurrentStatus() {
      const now = new Date();
      let active = null;
      let planned = null;

      delegations.forEach(function (d) {
        const start = new Date(d.start);
        const end = new Date(d.end);
        if (d.status === 'ACTIVE' && start <= now && now <= end) {
          if (!active || new Date(active.start) < start) {
            active = d;
          }
        } else if (d.status === 'PLANNED' && start > now) {
          if (!planned || new Date(planned.start) > start) {
            planned = d;
          }
        }
      });

      if (active) {
        currentStatusCard.classList.remove('inactive');
        currentStatusChip.className = 'status-chip active';
        currentStatusChip.textContent = '사용중';

        const periodText = formatDateTime(active.start) + ' ~ ' + formatDateTime(active.end);

        currentStatusText.textContent = '현재 부재 설정이 적용 중입니다.';
        currentStatusSubText.textContent =
          '기간: ' + periodText + ' / 대결자: ' + active.delegate;

        btnCurrentEnd.disabled = false;
        btnCurrentExtend.disabled = false;
        btnCurrentEnd.onclick = function () {
          endDelegation(active.id, 'USER_END');
        };
        btnCurrentExtend.onclick = function () {
          loadDelegationToForm(active.id);
        };
      } else if (planned) {
        currentStatusCard.classList.remove('inactive');
        currentStatusChip.className = 'status-chip planned';
        currentStatusChip.textContent = '예정';

        const periodText = formatDateTime(planned.start) + ' ~ ' + formatDateTime(planned.end);
        currentStatusText.textContent = '예약된 부재 설정이 있습니다.';
        currentStatusSubText.textContent =
          '기간: ' + periodText + ' / 대결자: ' + planned.delegate;

        btnCurrentEnd.disabled = true;
        btnCurrentExtend.disabled = false;
        btnCurrentEnd.onclick = null;
        btnCurrentExtend.onclick = function () {
          loadDelegationToForm(planned.id);
        };
      } else {
        currentStatusCard.classList.add('inactive');
        currentStatusChip.className = 'status-chip expired';
        currentStatusChip.textContent = '부재 설정 없음';
        currentStatusText.textContent = '현재 부재/대결자 설정이 없습니다.';
        currentStatusSubText.textContent =
          '부재 기간과 대결자를 등록하면, 지정된 기간 동안 결재 권한이 대결자에게 위임됩니다.';
        btnCurrentEnd.disabled = true;
        btnCurrentExtend.disabled = true;
        btnCurrentEnd.onclick = null;
        btnCurrentExtend.onclick = null;
      }
    }

    // 이력 렌더링
    function renderHistory() {
      if (!delegations.length) {
        historyEmpty.style.display = 'block';
        historyTableWrapper.style.display = 'none';
        historyTbody.innerHTML = '';
        return;
      }
      historyEmpty.style.display = 'none';
      historyTableWrapper.style.display = 'block';

      const sorted = [...delegations].sort(function (a, b) {
        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      historyTbody.innerHTML = '';
      sorted.forEach(function (d) {
        const tr = document.createElement('tr');

        const statusTd = document.createElement('td');
        statusTd.className = 'nowrap';
        const badge = document.createElement('span');
        const now = new Date();
        const start = new Date(d.start);
        const end = new Date(d.end);

        let label = '';
        if (d.status === 'ACTIVE' && start <= now && now <= end) {
          badge.className = 'badge badge-used';
          label = '사용중';
        } else if (d.status === 'PLANNED' && start > now) {
          badge.className = 'badge badge-planned';
          label = '예정';
        } else {
          badge.className = 'badge badge-expired';
          label = '만료';
        }
        badge.textContent = label;
        statusTd.appendChild(badge);
        tr.appendChild(statusTd);

        const periodTd = document.createElement('td');
        periodTd.className = 'nowrap';
        periodTd.textContent = formatDateTime(d.start) + ' ~ ' + formatDateTime(d.end);
        tr.appendChild(periodTd);

        const delegateTd = document.createElement('td');
        delegateTd.className = 'nowrap';
        delegateTd.textContent = d.delegate;
        tr.appendChild(delegateTd);

        const reasonTd = document.createElement('td');
        reasonTd.className = 'reason-cell';
        reasonTd.textContent = d.reason || '-';
        tr.appendChild(reasonTd);

        const endTypeTd = document.createElement('td');
        const endBadge = document.createElement('span');
        if (!d.endType) {
          endBadge.className = 'badge badge-expired';
          endBadge.textContent = '-';
        } else if (d.endType === 'AUTO') {
          endBadge.className = 'badge badge-expired';
          endBadge.textContent = '자동 종료';
        } else if (d.endType === 'USER_END') {
          endBadge.className = 'badge badge-used';
          endBadge.textContent = '사용자 해제';
        } else if (d.endType === 'ADMIN_FORCE') {
          endBadge.className = 'badge badge-force';
          endBadge.textContent = '관리자 해제';
        } else {
          endBadge.className = 'badge badge-expired';
          endBadge.textContent = d.endType;
        }
        endTypeTd.appendChild(endBadge);
        tr.appendChild(endTypeTd);

        const actionTd = document.createElement('td');
        actionTd.className = 'nowrap';
        const btnEdit = document.createElement('button');
        btnEdit.type = 'button';
        btnEdit.className = 'btn btn-ghost btn-sm';
        btnEdit.textContent = '수정';
        btnEdit.addEventListener('click', function () {
          switchTab('form');
          loadDelegationToForm(d.id);
        });
        actionTd.appendChild(btnEdit);

        const btnEnd = document.createElement('button');
        btnEnd.type = 'button';
        btnEnd.className = 'btn btn-ghost btn-sm';
        btnEnd.textContent = '즉시해제';
        btnEnd.addEventListener('click', function () {
          endDelegation(d.id, 'USER_END');
        });
        actionTd.appendChild(btnEnd);

        const btnCopy = document.createElement('button');
        btnCopy.type = 'button';
        btnCopy.className = 'btn btn-ghost btn-sm';
        btnCopy.textContent = '복사';
        btnCopy.addEventListener('click', function () {
          copyDelegationToForm(d.id);
        });
        actionTd.appendChild(btnCopy);

        const btnDelete = document.createElement('button');
        btnDelete.type = 'button';
        btnDelete.className = 'btn btn-ghost btn-sm';
        btnDelete.textContent = '삭제';
        btnDelete.addEventListener('click', function () {
          deleteDelegation(d.id);
        });
        actionTd.appendChild(btnDelete);

        tr.appendChild(actionTd);
        historyTbody.appendChild(tr);
      });
    }

    // 저장 버튼
    absenceModalSaveBtn.addEventListener('click', function () {
      if (!validateForm()) return;

      const now = new Date();
      const start = new Date(startDateEl.value);
      const end = new Date(endDateEl.value);
      const delegate = delegateNameEl.value.trim();
      const reason = reasonEl.value.trim();
      const notifyDelegate = !!notifyDelegateEl.checked;
      const notifyMe = !!notifyMeEl.checked;

      const startIso = start.toISOString();
      const endIso = end.toISOString();

      const duplicate = delegations.some(function (d) {
        return d.id !== editingId &&
               d.start === startIso &&
               d.end === endIso &&
               d.delegate === delegate;
      });
      if (duplicate) {
        alert('같은 기간과 대결자로 등록된 부재 설정이 이미 있습니다.');
        return;
      }

      let status;
      if (end < now) {
        status = 'EXPIRED';
      } else if (start > now) {
        status = 'PLANNED';
      } else {
        status = 'ACTIVE';
      }

      if (editingId) {
        const idx = delegations.findIndex(d => d.id === editingId);
        if (idx >= 0) {
          delegations[idx] = {
            ...delegations[idx],
            type: absenceTypeEl.value,
            start: startIso,
            end: endIso,
            delegate,
            reason,
            notifyDelegate,
            notifyMe,
            status,
            updatedAt: now.toISOString(),
          };
        }
      } else {
        delegations.push({
          id: nextId++,
          type: absenceTypeEl.value,
          start: startIso,
          end: endIso,
          delegate,
          reason,
          notifyDelegate,
          notifyMe,
          status,
          createdAt: now.toISOString(),
          updatedAt: now.toISOString(),
          endType: null,
        });
      }

      renderCurrentStatus();
      renderHistory();
      syncDelegationsToGlobalAbsence();
      editingId = null;
      alert('부재/대결자 설정이 저장되었습니다.');
    });

    // 폼 검증
    function validateForm() {
      let ok = true;
      dateErrorEl.style.display = 'none';
      delegateErrorEl.style.display = 'none';

      if (!startDateEl.value || !endDateEl.value) {
        dateErrorEl.textContent = '부재 시작/종료 일시는 필수입니다.';
        dateErrorEl.style.display = 'block';
        ok = false;
      } else {
        const start = new Date(startDateEl.value);
        const end = new Date(endDateEl.value);
        if (end < start) {
          dateErrorEl.textContent = '종료 일시는 시작 일시보다 빠를 수 없습니다.';
          dateErrorEl.style.display = 'block';
          ok = false;
        }
      }

      if (!delegateNameEl.value.trim()) {
        delegateErrorEl.textContent = '대결자를 입력하세요.';
        delegateErrorEl.style.display = 'block';
        ok = false;
      }

      return ok;
    }

        function resetForm() {
      const now = new Date();
      const startIso = new Date(now.getTime() + 5 * 60000).toISOString().slice(0, 16);
      const endIso = new Date(now.getTime() + 8 * 60 * 60000).toISOString().slice(0, 16);

      absenceTypeEl.value = '연차';
      startDateEl.value = startIso;
      endDateEl.value = endIso;
      delegateNameEl.value = '';
      reasonEl.value = '';
      notifyDelegateEl.checked = true;
      notifyMeEl.checked = false;
      dateErrorEl.style.display = 'none';
      delegateErrorEl.style.display = 'none';
    }

    function loadDelegationToForm(id) {
      const d = delegations.find(function (x) { return x.id === id; });
      if (!d) return;
      editingId = id;
      absenceTypeEl.value = d.type;
      startDateEl.value = d.start.slice(0, 16);
      endDateEl.value = d.end.slice(0, 16);
      delegateNameEl.value = d.delegate;
      reasonEl.value = d.reason || '';
      notifyDelegateEl.checked = !!d.notifyDelegate;
      notifyMeEl.checked = !!d.notifyMe;

    }

    function copyDelegationToForm(id) {
      const d = delegations.find(function (x) { return x.id === id; });
      if (!d) return;
      editingId = null;
      absenceTypeEl.value = d.type;
      delegateNameEl.value = d.delegate;
      reasonEl.value = d.reason || '';
      notifyDelegateEl.checked = !!d.notifyDelegate;
      notifyMeEl.checked = !!d.notifyMe;

      const now = new Date();
      const startIso = new Date(now.getTime() + 5 * 60000).toISOString().slice(0, 16);
      const endIso = new Date(now.getTime() + 8 * 60 * 60000).toISOString().slice(0, 16);
      startDateEl.value = startIso;
      endDateEl.value = endIso;


      switchTab('form');
    }

    function endDelegation(id, endType) {
      const now = new Date();
      const idx = delegations.findIndex(d => d.id === id);
      if (idx < 0) return;

      const d = delegations[idx];
      d.end = now.toISOString();
      d.status = 'EXPIRED';
      d.endType = endType;
      d.updatedAt = now.toISOString();
      delegations[idx] = d;

      renderCurrentStatus();
      renderHistory();
      syncDelegationsToGlobalAbsence();
      alert('해당 부재/대결자 설정이 종료 처리되었습니다.');
    }


    function deleteDelegation(id) {
      const idx = delegations.findIndex(d => d.id === id);
      if (idx < 0) return;
      const d = delegations[idx];

      if (!confirm('선택한 부재/대결자 설정을 삭제하시겠습니까?\n기간: ' +
        formatDateTime(d.start) + ' ~ ' + formatDateTime(d.end) +
        '\n대결자: ' + d.delegate)) {
        return;
      }

      delegations = delegations.filter(function (x) { return x.id !== id; });
      renderCurrentStatus();
      renderHistory();
      syncDelegationsToGlobalAbsence();
    }

    function formatDateTime(iso) {
      const d = new Date(iso);
      if (isNaN(d.getTime())) return '-';
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const hh = String(d.getHours()).padStart(2, '0');
      const mi = String(d.getMinutes()).padStart(2, '0');
      return yyyy + '-' + mm + '-' + dd + ' ' + hh + ':' + mi;
    }

    // 빠른 기간 설정
    quickButtons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        const type = btn.getAttribute('data-quick');
        const now = new Date();
        let start, end;
        if (type === 'today') {
          start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 0, 0);
          end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 18, 0, 0);
        } else if (type === 'tomorrow') {
          const t = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
          start = new Date(t.getFullYear(), t.getMonth(), t.getDate(), 9, 0, 0);
          end = new Date(t.getFullYear(), t.getMonth(), t.getDate(), 18, 0, 0);
        } else if (type === 'thisWeek') {
          const day = now.getDay();
          const mondayOffset = (day === 0 ? -6 : 1 - day);
          const monday = new Date(now.getFullYear(), now.getMonth(), now.getDate() + mondayOffset);
          const friday = new Date(monday.getFullYear(), monday.getMonth(), monday.getDate() + 4);
          start = new Date(now);
          end = new Date(friday.getFullYear(), friday.getMonth(), friday.getDate(), 18, 0, 0);
        } else {
          return;
        }
        startDateEl.value = start.toISOString().slice(0, 16);
        endDateEl.value = end.toISOString().slice(0, 16);
      });
    });

    // 대결자 검색 버튼 → 조직도 모달 연동
    btnSearchDelegate.addEventListener('click', function () {
      if (window.delegatePicker && typeof window.delegatePicker.open === 'function') {
        window.delegatePicker.open();
      } else {
        alert('조직도 기반 대결자 선택 모달이 아직 초기화되지 않았습니다.');
      }
    });

    // 메뉴바 드롭다운 항목 클릭 시 메뉴 닫기
    const menubarMenus = document.querySelectorAll('.menubar .menu');
    menubarMenus.forEach(function(menu) {
      const dropdown = menu.querySelector('.dropdown');
      if (!dropdown) return;
      // 각 메뉴 항목 클릭 시 드롭다운 닫기
      dropdown.querySelectorAll('a').forEach(function(link) {
        link.addEventListener('click', function() {
          dropdown.style.display = 'none';
        });
      });
      // 마우스가 메뉴 영역에서 벗어나면 display 초기화
      menu.addEventListener('mouseleave', function() {
        dropdown.style.display = '';
      });
    });

    // DBAM 연동: 기존 부재중/대결자 메뉴 함수와 연결
    function openDelegateSettingsModal() {
      openAbsenceModal();
    }
    function closeDelegateSettingsModal() {
      closeAbsenceModal();
    }
    function saveDelegateSettings() {
      // 기존 saveDelegateSettings 호출 시, 모달 내 저장 버튼과 동일하게 동작
      if (absenceModalSaveBtn) {
        absenceModalSaveBtn.click();
      }
    }

  </script>

  
  <!-- 세션 변경 모달 -->
  <div id="sessionSwitchBackdrop"
       class="export-modal-backdrop hidden"
       role="dialog"
       aria-modal="true"
       aria-hidden="true">
    <div class="export-modal approval-modal" style="max-width:600px;">
      <div class="export-modal-header">
        <h2>
          <i class="fa-solid fa-user-gear"></i>
          <span style="margin-left:4px;">세션 변경 (조직도 선택)</span>
        </h2>
        <button type="button"
                class="btn-icon approval-close-btn"
                onclick="window.sessionSwitcher && window.sessionSwitcher.close()"
                aria-label="닫기">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="export-modal-body" style="display:flex;flex-direction:column;gap:8px;">
        <div style="font-size:12px;color:#4b5563;">
          결재 를 위해 현재 브라우저 세션의 사용자 정보를 조직도에서 선택한 사용자로 변경합니다. (실제 인증은 변경되지 않습니다.)
        </div>
        <div style="display:flex;gap:12px;min-height:0;">
          <div style="flex:0 0 45%;display:flex;flex-direction:column;gap:6px;min-height:0;">
            <div style="font-size:12px;font-weight:600;">조직도</div>
            <div id="sessionSwitchOrgTree"
                 style="border-radius:6px;border:1px solid #e5e7eb;background:#fff;padding:6px;max-height:320px;overflow:auto;font-size:12px;">
            </div>
          </div>
          <div style="flex:1;display:flex;flex-direction:column;gap:6px;min-height:0;">
            <div style="font-size:12px;font-weight:600;">선택한 사용자</div>
            <div id="sessionSwitchSelectedLabel"
                 style="font-size:12px;color:#374151;border-radius:6px;border:1px dashed #d1d5db;padding:8px;min-height:40px;display:flex;align-items:center;">
              아직 사용자를 선택하지 않았습니다.
            </div>
            <div style="font-size:11px;color:#9ca3af;">
              선택한 사용자 기준으로 결재함의 "내 승인할 건"과 상세 화면의 승인/반려 버튼 노출이 달라집니다.
            </div>
          </div>
        </div>
        <div style="font-size:11px;color:#9ca3af;">
          실제 사내 인증/권한과는 무관한 화면 용 기능입니다.
        </div>
      </div>
      <div class="export-modal-footer" style="display:flex;justify-content:flex-end;gap:6px;">
        <button type="button" class="btn btn-secondary" onclick="window.sessionSwitcher && window.sessionSwitcher.close()">취소</button>
        <button type="button" class="btn btn-primary" onclick="window.sessionSwitcher && window.sessionSwitcher.applySelected()">이 사용자로 세션 변경</button>
      </div>
    </div>
  </div>


  <!-- 대결자 선택 (조직도) 모달 -->
  <div id="delegateOrgBackdrop"
       class="export-modal-backdrop hidden"
       role="dialog"
       aria-modal="true"
       aria-hidden="true">
    <div class="export-modal approval-modal" style="max-width:760px; max-height:80vh;">
      <div class="export-modal-header">
        <h2>
          <i class="fa-solid fa-user-check"></i>
          <span style="margin-left:4px;">대결자 선택 (조직도)</span>
        </h2>
        <button type="button"
                class="btn-icon approval-close-btn"
                onclick="window.delegatePicker && window.delegatePicker.close()"
                aria-label="닫기">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="export-modal-body" style="display:flex;flex-direction:column;gap:8px;">
        <div style="font-size:14px;color:#374151;">
          부재중일 때 결재를 대신 처리할 대결자를 조직도에서 선택합니다.
        </div>
        <div style="display:flex;gap:12px;min-height:0;">
          <div style="flex:0 0 45%;display:flex;flex-direction:column;gap:6px;min-height:0;">
            <div style="font-size:13px;font-weight:600;">조직도</div>
            <div id="delegateOrgTree"
                 style="border-radius:6px;border:1px solid #e5e7eb;background:#fff;padding:6px;max-height:420px;overflow:auto;font-size:12px;">
            </div>
          </div>
          <div style="flex:1;display:flex;flex-direction:column;gap:6px;min-height:0;">
            <div style="font-size:13px;font-weight:600;">선택한 대결자</div>
            <div id="delegateSelectedLabel"
                 style="font-size:13px;color:#111827;border-radius:6px;border:1px solid #e5e7eb;background:#f9fafb;padding:8px;min-height:40px;display:flex;align-items:center;">
              아직 대결자를 선택하지 않았습니다.
            </div>
            <div style="font-size:12px;color:#6b7280;">
              선택한 대결자가 부재 기간 동안 결재를 대신 수행합니다.
            </div>
          </div>
        </div>
      </div>
      <div class="export-modal-footer" style="display:flex;justify-content:flex-end;gap:6px;">
        <button type="button" class="btn btn-secondary"
                onclick="window.delegatePicker && window.delegatePicker.close()">취소</button>
        <button type="button" class="btn btn-primary"
                onclick="window.delegatePicker && window.delegatePicker.applySelected()">대결자 선택</button>
      </div>
    </div>
  </div>

  <!-- 결재선 지정 모달 -->
  <div id="approvalLineBackdrop"
       class="export-modal-backdrop hidden"
       role="dialog"
       aria-modal="true"
       aria-hidden="true">
    <div class="export-modal approval-modal" style="max-width:860px;">
      <div class="export-modal-header">
        <h2>
          <i class="fa-solid fa-sitemap"></i>
          <span style="margin-left:4px;">결재선 지정</span>
        </h2>
        <button type="button"
                class="btn-icon approval-close-btn"
                onclick="window.approvalLine && window.approvalLine.closeModal()"
                aria-label="닫기">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="export-modal-body" style="display:flex;flex-direction:column;gap:8px;">
        <div style="display:flex;gap:12px;flex:1 1 auto;min-height:0;">
          <!-- 좌측: 조직도 -->
          <div style="flex:0 0 40%;display:flex;flex-direction:column;gap:6px;min-height:0;">
            <div style="font-size:12px;font-weight:600;">조직도</div>
            <div id="apLineOrgTree"
                 style="border-radius:6px;border:1px solid #e5e7eb;background:#fff;padding:6px;max-height:340px;overflow:auto;font-size:12px;">
            </div>
            <div style="font-size:11px;color:#9ca3af;margin-top:4px;">
              사용자 이름 앞의 라디오를 선택하면 결재선에 추가됩니다. (이름/직급 기준)
            </div>
          </div>

          <!-- 우측: 결재선 테이블 -->
          <div style="flex:1;display:flex;flex-direction:column;gap:6px;min-height:0;">
            <div style="font-size:12px;font-weight:600;">결재선</div>
            <table style="width:100%;border-collapse:collapse;font-size:12px;background:#fff;border-radius:8px;overflow:hidden;">
              <thead>
                <tr>
                  <th style="background:#f9fafb;border:1px solid #e5e7eb;padding:6px 8px;width:52px;text-align:center;">순서</th>
                  <th style="background:#f9fafb;border:1px solid #e5e7eb;padding:6px 8px;width:90px;text-align:center;">유형</th>
                  <th style="background:#f9fafb;border:1px solid #e5e7eb;padding:6px 8px;text-align:left;">결재자 / 직책</th>
                  <th style="background:#f9fafb;border:1px solid #e5e7eb;padding:6px 8px;width:150px;text-align:center;">정렬 / 삭제</th>
                </tr>
              </thead>
              <tbody id="apLineBody"></tbody>
            </table>
            <div id="apLineEmptyHint" style="font-size:11px;color:#9ca3af;margin-top:4px;">
              아직 선택된 결재선이 없습니다. 좌측 조직도에서 사용자를 선택하세요.
            </div>
          </div>
        </div>

        <!-- 하단: 결재선 미리보기 -->
        <div style="border-top:1px dashed #e5e7eb;padding-top:8px;">
          <div id="apLinePreviewLine"
               style="display:flex;flex-wrap:wrap;align-items:center;gap:6px;"></div>
          <div id="apLinePreviewRef"
               style="margin-top:6px;margin-bottom:8px;font-size:12px;display:flex;flex-wrap:wrap;gap:6px;align-items:center;"></div>
        </div>
      </div>
      <div class="export-modal-footer" style="border-top:1px solid #e5e7eb;padding:8px 12px;display:flex;justify-content:flex-end;gap:8px;">
        <button type="button" class="btn" onclick="window.approvalLine && window.approvalLine.closeModal()">취소</button>
        <button type="button" class="btn btn-primary" onclick="window.approvalLine && window.approvalLine.applyAndClose()">
          <span>확인</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // 위험 쿼리 결재선 지정 모듈
    (function(){
      const ORG_DATA = [
        {
          dept: "IT본부",
          teams: [
            {
              name: "개발1팀",
              members: [
                { id:"E001", name:"홍길동", title:"책임", dept:"IT본부/개발1팀" },
                { id:"E002", name:"김개발", title:"선임", dept:"IT본부/개발1팀" },
                { id:"demoUser", name:"demoUser", title:"테스트", dept:"IT본부/개발1팀" }
              ]
            },
            {
              name: "개발2팀",
              members: [
                { id:"E003", name:"이테스트", title:"책임", dept:"IT본부/개발2팀" },
                { id:"E004", name:"박프론트", title:"대리", dept:"IT본부/개발2팀" }
              ]
            }
          ]
        },
        {
          dept: "경영지원본부",
          teams: [
            {
              name: "인사팀",
              members: [
                { id:"E101", name:"최인사", title:"팀장", dept:"경영지원본부/인사팀" },
                { id:"E102", name:"오교육", title:"주임", dept:"경영지원본부/인사팀" }
              ]
            }
          ]
        }
      ];

      window.DBAM_ORG_DATA = ORG_DATA;

      const backdrop = document.getElementById('approvalLineBackdrop');
      const orgTree = document.getElementById('apLineOrgTree');
      const lineBody = document.getElementById('apLineBody');
      const lineEmptyHint = document.getElementById('apLineEmptyHint');
      const previewLine = document.getElementById('apLinePreviewLine');
      const previewRef = document.getElementById('apLinePreviewRef');
      const outerPreviewLine = document.getElementById('apReqApprovalPreviewLine');
      const outerPreviewRef  = document.getElementById('apReqApprovalPreviewRef');
      const outerApproverInput = document.getElementById('apReqApprover');
      const openBtn = document.getElementById('openApprovalModal');

      if(!backdrop || !orgTree || !lineBody || !previewLine || !previewRef || !openBtn){
        return;
      }

      let escHandler = null;

      // 결재선용 부재 정보 조회 (전역 window.DBAM_ABSENCE 기반)
      // window.DBAM_ABSENCE는 [{ empId, start, end, status, delegate }, ...] 형태를 가정한다.
      function getActiveAbsenceForEmp(empId){
        if (!window.DBAM_ABSENCE || !Array.isArray(window.DBAM_ABSENCE)) return null;
        const now = new Date();
        let active = null;
        window.DBAM_ABSENCE.forEach(function(d){
          if (!d || d.empId !== empId) return;
          try{
            const start = new Date(d.start);
            const end = new Date(d.end);
            if (d.status === 'ACTIVE' && start <= now && now <= end){
              if (!active || new Date(active.start) < start){
                active = d;
              }
            }
          }catch(err){
            console.warn('getActiveAbsenceForEmp parse error', err);
          }
        });
        return active;
      }

      function formatAbsencePeriodForBadge(abs){
        if (!abs || !abs.start || !abs.end) return '';
        try{
          const s = new Date(abs.start);
          const e = new Date(abs.end);
          const pad = (n)=> String(n).padStart(2,'0');
          const fmt = (d)=> d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) +
                           ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
          return fmt(s) + ' ~ ' + fmt(e);
        }catch(err){
          console.warn('formatAbsencePeriodForBadge error', err);
          return '';
        }
      }


      

      // 부재 정보에 등록된 대결자 라벨을 ORG_DATA 멤버로 매핑
      // abs.delegateId가 있으면 ID 우선, 없으면 abs.delegate 문자열을
      // "팀명 이름 직책" 형식으로 ORG_DATA에서 찾아 매핑한다.
      function findDelegateMember(abs){
        if (!abs) return null;
        var baseOrg = (window.DBAM_ORG_DATA || window.ORG_DATA || ORG_DATA);
        if (!baseOrg) return null;

        // 1) delegateId 기반 매핑 (있을 때)
        if (abs.delegateId){
          try{
            for (var i=0; i<baseOrg.length; i++){
              var dept = baseOrg[i];
              if (!dept || !dept.teams) continue;
              for (var j=0; j<dept.teams.length; j++){
                var team = dept.teams[j];
                if (!team || !team.members) continue;
                for (var k=0; k<team.members.length; k++){
                  var m = team.members[k];
                  if (m && m.id === abs.delegateId){
                    return m;
                  }
                }
              }
            }
          }catch(e){
            console.warn('findDelegateMember delegateId error', e);
          }
        }

        // 2) delegate 문자열 기반 매핑 ("팀명 이름 직책")
        if (!abs.delegate) return null;
        var label = String(abs.delegate || '').trim();
        if (!label) return null;

        var found = null;
        try{
          outer:
          for (var i2=0; i2<baseOrg.length; i2++){
            var dept2 = baseOrg[i2];
            if (!dept2 || !dept2.teams) continue;
            for (var j2=0; j2<dept2.teams.length; j2++){
              var team2 = dept2.teams[j2];
              if (!team2 || !team2.members) continue;
              for (var k2=0; k2<team2.members.length; k2++){
                var m2 = team2.members[k2];
                if (!m2) continue;
                var fullDept = m2.dept || '';
                var seg = fullDept;
                if (fullDept.indexOf('/') >= 0){
                  var parts = fullDept.split('/');
                  seg = parts[parts.length-1] || fullDept;
                }
                var candidate = (seg + ' ' + m2.name + ' ' + m2.title).trim();
                if (candidate === label){
                  found = m2;
                  break outer;
                }
              }
            }
          }
        }catch(e){
          console.warn('findDelegateMember label match error', e);
        }
        return found;
            }

      // 전역에서 재사용할 수 있도록 부재/대결자 헬퍼를 window에 노출
      window.DBAM_getActiveAbsenceForEmp = getActiveAbsenceForEmp;
      window.DBAM_formatAbsencePeriodForBadge = formatAbsencePeriodForBadge;

function renderOrgTree(){
        orgTree.innerHTML = '';
        ORG_DATA.forEach(dept => {
          const deptLabel = document.createElement('div');
          deptLabel.style.fontWeight = '600';
          deptLabel.style.padding = '2px 4px';
          deptLabel.textContent = dept.dept;
          orgTree.appendChild(deptLabel);

          dept.teams.forEach(team => {
            const teamLabel = document.createElement('div');
            teamLabel.style.padding = '2px 4px 2px 10px';
            teamLabel.style.fontWeight = '500';
            teamLabel.style.color = '#4b5563';
            teamLabel.textContent = '└ ' + team.name;
            orgTree.appendChild(teamLabel);

            team.members.forEach(member => {
              const row = document.createElement('label');
              row.style.display = 'flex';
              row.style.alignItems = 'center';
              row.style.gap = '4px';
              row.style.padding = '2px 4px 2px 24px';
              row.style.borderRadius = '4px';
              row.style.cursor = 'pointer';

              row.addEventListener('mouseenter', function(){
                row.style.background = '#f3f4f6';
              });
              row.addEventListener('mouseleave', function(){
                row.style.background = '';
              });

              const radio = document.createElement('input');
              radio.type = 'radio';
              radio.name = 'orgUserSelectForApprovalLine';
              radio.dataset.id = member.id;
              radio.dataset.name = member.name;
              radio.dataset.dept = member.dept;
              radio.dataset.title = member.title;

              const textSpan = document.createElement('span');
              textSpan.style.fontSize = '12px';
              textSpan.textContent = member.name + ' / ' + member.title;

              row.appendChild(radio);
              row.appendChild(textSpan);

              // 부재중인 사용자는 Badge 및 Tooltip 표시
              try{
                const abs = getActiveAbsenceForEmp(member.id);
                if (abs){
                  const badge = document.createElement('span');
                  badge.textContent = '부재';
                  badge.style.marginLeft = '4px';
                  badge.style.fontSize = '10px';
                  badge.style.padding = '1px 4px';
                  badge.style.borderRadius = '999px';
                  badge.style.backgroundColor = '#fee2e2';
                  badge.style.color = '#b91c1c';

                  const periodText = formatAbsencePeriodForBadge(abs);
                  let titleParts = [];
                  if (periodText){
                    titleParts.push('부재 기간: ' + periodText);
                  }
                  if (abs.delegate){
                    titleParts.push('대결자: ' + abs.delegate);
                  }
                  if (titleParts.length){
                    badge.title = titleParts.join(' / ');
                  }
                  row.appendChild(badge);
                }
              }catch(err){
                console.warn('apLine orgTree absence badge error', err);
              }

              orgTree.appendChild(row);
            });
          });
        });
      }

            orgTree.addEventListener('change', function(e){
        const radio = e.target;
        if(!radio || radio.name !== 'orgUserSelectForApprovalLine') return;

        // 부재/대결 정보를 반영해 실제로 결재선에 추가할 대상(member)을 결정한다.
        let target = {
          id: radio.dataset.id,
          name: radio.dataset.name,
          dept: radio.dataset.dept,
          title: radio.dataset.title
        };
        let isDelegate = false;
        let originalInfo = null;

        // 부재중인 사용자 처리: 대결자 자동 치환 또는 경고
        try{
          const abs = getActiveAbsenceForEmp(radio.dataset.id);
          if (abs){
            const periodText = formatAbsencePeriodForBadge(abs);
            const delegateMember = findDelegateMember(abs);

            if (delegateMember){
              // 대결자 자동 치환 옵션
              let msg = radio.dataset.name + '님은 현재 부재중입니다.';
              if (periodText){
                msg += '\n부재 기간: ' + periodText;
              }
              msg += '\n\n대결자 "' + (abs.delegate || (delegateMember.name + ' ' + delegateMember.title)) + '"를 결재선에 추가하시겠습니까?';
              msg += '\n[확인: 대결자 추가 / 취소: 부재자 그대로 추가]';

              const useDelegate = window.confirm(msg);
              if (useDelegate){
                // 대결자를 결재선에 올리고, 원 결재자 정보는 별도로 보존
                target = {
                  id: delegateMember.id,
                  name: delegateMember.name,
                  dept: delegateMember.dept,
                  title: delegateMember.title
                };
                isDelegate = true;
                originalInfo = {
                  id: radio.dataset.id,
                  name: radio.dataset.name,
                  dept: radio.dataset.dept,
                  title: radio.dataset.title
                };
              }else{
                // 취소를 누른 경우: 부재자를 그대로 올린다.
                isDelegate = false;
                originalInfo = null;
              }
            }else{
              // 대결자 매핑 실패: 안내만 하고 추가 여부를 물어본다.
              let msg = radio.dataset.name + '님은 현재 부재중입니다.';
              if (periodText){
                msg += '\n부재 기간: ' + periodText;
              }
              if (abs.delegate){
                msg += '\n대결자: ' + abs.delegate;
              }
              msg += '\n\n그래도 이 사용자를 결재선에 추가하시겠습니까?';
              const ok = window.confirm(msg);
              if (!ok){
                // 사용자가 취소한 경우 라디오 선택도 해제
                try{
                  radio.checked = false;
                }catch(e2){}
                return;
              }
            }
          }
        }catch(err){
          console.warn('apLine absence / delegate confirm error', err);
        }

        // 최종적으로 결재선에 추가할 대상 기준으로 중복 체크
        try{
          if(lineBody && target && target.id){
            const rows = lineBody.querySelectorAll('tr');
            for(const row of rows){
              if(row.dataset && row.dataset.empId === target.id){
                // 이미 결재선에 있는 경우: 추가만 막고 선택 상태는 유지
                return;
              }
            }
          }
        }catch(err){
          console.warn('apLine duplicate check error', err);
        }

        const member = {
          id: target.id,
          name: target.name,
          dept: target.dept,
          title: target.title,
          isDelegate: isDelegate ? 'Y' : 'N',
          original: originalInfo
        };
        addLineFromMember(member);
      });


            function addLineFromMember(member){
        const tr = document.createElement('tr');
        tr.dataset.empId = member.id;
        tr.dataset.empName = member.name;
        tr.dataset.empDept = member.dept;
        tr.dataset.empTitle = member.title;
        tr.dataset.type = 'approval';

        // 대결 여부 및 원결재자 메타데이터 보존
        if (member && member.isDelegate === 'Y'){
          tr.dataset.isDelegate = 'Y';
          if (member.original){
            tr.dataset.originalEmpId = member.original.id || '';
            tr.dataset.originalEmpName = member.original.name || '';
            tr.dataset.originalEmpDept = member.original.dept || '';
            tr.dataset.originalEmpTitle = member.original.title || '';
          }
        }else{
          tr.dataset.isDelegate = 'N';
        }

        const tdOrder = document.createElement('td');
        tdOrder.className = 'order';
        tdOrder.style.border = '1px solid #e5e7eb';
        tdOrder.style.padding = '6px 8px';
        tdOrder.style.textAlign = 'center';

        const tdType = document.createElement('td');
        tdType.style.border = '1px solid #e5e7eb';
        tdType.style.padding = '6px 8px';
        tdType.style.textAlign = 'center';
        const sel = document.createElement('select');
        sel.style.width = '100%';
        sel.style.fontSize = '12px';
        sel.style.padding = '2px 4px';
        sel.style.borderRadius = '6px';
        sel.style.border = '1px solid #d1d5db';
        const optA = document.createElement('option');
        optA.value = 'approval';
        optA.textContent = '승인';
        const optR = document.createElement('option');
        optR.value = 'ref';
        optR.textContent = '참조';
        sel.appendChild(optA);
        sel.appendChild(optR);
        tdType.appendChild(sel);

        const tdInfo = document.createElement('td');
        tdInfo.style.border = '1px solid #e5e7eb';
        tdInfo.style.padding = '6px 8px';
        const infoDiv = document.createElement('div');
        infoDiv.style.fontSize = '12px';
        infoDiv.style.color = '#111827';

        // 기본 표기는 "이름 / 직책"
        infoDiv.textContent = member.name + ' / ' + member.title;

        // 대결 결재인 경우 "(대결)" 표기 및 Tooltip에 원결재자 정보 표시
        if (tr.dataset.isDelegate === 'Y' && tr.dataset.originalEmpName){
          infoDiv.textContent = member.name + ' / ' + member.title + ' (대결)';
          let tip = '원결재자: ' + tr.dataset.originalEmpName;
          if (tr.dataset.originalEmpTitle){
            tip += ' / ' + tr.dataset.originalEmpTitle;
          }
          infoDiv.title = tip;
        }

        tdInfo.appendChild(infoDiv);

        const tdAct = document.createElement('td');
        tdAct.style.border = '1px solid #e5e7eb';
        tdAct.style.padding = '6px 8px';
        tdAct.style.textAlign = 'center';
        tdAct.style.whiteSpace = 'nowrap';

        function makeSmallBtn(label, action){
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-sm btn-sort';
          btn.dataset.action = action;
          btn.textContent = label;
          btn.style.marginRight = '2px';
          return btn;
        }

        const btnUp = makeSmallBtn('▲', 'up');
        const btnDown = makeSmallBtn('▼', 'down');
        const btnDel = makeSmallBtn('삭제', 'delete');

        tdAct.appendChild(btnUp);
        tdAct.appendChild(btnDown);
        tdAct.appendChild(btnDel);

        tr.appendChild(tdOrder);
        tr.appendChild(tdType);
        tr.appendChild(tdInfo);
        tr.appendChild(tdAct);

        lineBody.appendChild(tr);
        refreshOrders();
        renderPreview();
      }


      lineBody.addEventListener('change', function(e){
        const sel = e.target;
        if(!(sel && sel.tagName === 'SELECT')) return;
        const row = sel.closest('tr');
        if(!row) return;
        row.dataset.type = sel.value;
        renderPreview();
      });

      lineBody.addEventListener('click', function(e){
        const btn = e.target.closest('button[data-action]');
        if(!btn) return;
        const action = btn.dataset.action;
        const row = btn.closest('tr');
        if(!row) return;

        if(action === 'delete'){
          row.remove();
        } else if(action === 'up'){
          const prev = row.previousElementSibling;
          if(prev){
            lineBody.insertBefore(row, prev);
          }
        } else if(action === 'down'){
          const next = row.nextElementSibling;
          if(next){
            lineBody.insertBefore(row, row.nextElementSibling);
          }
        }

        // 조직도 라디오 선택 해제 (삭제 시에만 해제: 동일 사용자를 다시 선택할 수 있도록)
        if(action === 'delete'){
          try{
            if(orgTree){
              const checked = orgTree.querySelector('input[name="orgUserSelectForApprovalLine"]:checked');
              if(checked){ checked.checked = false; }
            }
          }catch(err){
            console.warn('apLine orgTree radio clear error', err);
          }
        }

        refreshOrders();
        renderPreview();
      });

      function refreshOrders(){
        const rows = lineBody.querySelectorAll('tr');
        rows.forEach((row, idx)=>{
          const cell = row.querySelector('.order');
          if(cell){
            cell.textContent = String(idx + 1);
          }
        });
        if(lineEmptyHint){
          lineEmptyHint.style.display = rows.length === 0 ? 'block' : 'none';
        }
      }

            function renderPreview(){
        previewLine.innerHTML = '';
        previewRef.innerHTML = '';

        // 요청자 노드: 위=직급, 아래=이름 (샘플)
        const requesterNode = document.createElement('div');
        requesterNode.style.borderRadius = '8px';
        requesterNode.style.padding = '6px 10px';
        requesterNode.style.border = '1px solid #e5e7eb';
        requesterNode.style.background = '#f9fafb';
        requesterNode.style.textAlign = 'center';

        const rTop = document.createElement('div');
        rTop.style.fontSize = '11px';
        rTop.style.color = '#6b7280';
        rTop.style.marginBottom = '2px';
        rTop.textContent = '직급';

        const rBottom = document.createElement('div');
        rBottom.style.fontSize = '12px';
        rBottom.style.fontWeight = '500';
        rBottom.style.color = '#111827';
        rBottom.textContent = '로그인 사용자';

        requesterNode.appendChild(rTop);
        requesterNode.appendChild(rBottom);
        previewLine.appendChild(requesterNode);

        const rows = Array.from(lineBody.querySelectorAll('tr'));
        const approvals = rows.filter(r => (r.dataset.type || 'approval') === 'approval');
        const refs = rows.filter(r => (r.dataset.type || 'approval') === 'ref');

        // 결재선 노드들
        approvals.forEach((row)=>{
          const name = row.dataset.empName || '';
          const title = row.dataset.empTitle || '';
          const isDelegate = (row.dataset.isDelegate === 'Y');
          const originalName = row.dataset.originalEmpName || '';
          const originalTitle = row.dataset.originalEmpTitle || '';

          const arrow = document.createElement('span');
          arrow.textContent = '→';
          arrow.style.fontSize = '14px';
          arrow.style.color = '#9ca3af';
          previewLine.appendChild(arrow);

          const node = document.createElement('div');
          node.style.borderRadius = '8px';
          node.style.padding = '6px 10px';
          node.style.border = '1px solid #bbf7d0';
          node.style.background = '#ecfdf3';
          node.style.textAlign = 'center';

          const label = document.createElement('div');
          label.style.fontSize = '11px';
          label.style.color = '#16a34a';
          label.style.marginBottom = '2px';
          label.textContent = title || '직급';

          const text = document.createElement('div');
          text.style.fontSize = '12px';
          text.style.fontWeight = '500';
          text.style.color = '#111827';

          if (isDelegate && originalName){
            text.textContent = (name || '미지정') + ' (대결)';
            let tip = '원결재자: ' + originalName;
            if (originalTitle){
              tip += ' / ' + originalTitle;
            }
            node.title = tip;
          }else{
            text.textContent = name || '미지정';
          }

          node.appendChild(label);
          node.appendChild(text);
          previewLine.appendChild(node);
        });

        // 참조자 칩
        if(refs.length > 0){
          const label = document.createElement('span');
          label.style.color = '#6b7280';
          label.style.fontWeight = '500';
          label.style.fontSize = '12px';
          label.textContent = '참조';
          previewRef.appendChild(label);

          refs.forEach(row=>{
            const name  = row.dataset.empName || '미지정';
            const title = row.dataset.empTitle || '';
            const empId = row.dataset.empId   || '';

            let t = name;
            if(title){
              t += ' / ' + title;
            }

            const chip = document.createElement('span');
            chip.className = 'ap-ref-chip';
            chip.dataset.empId = empId;
            chip.dataset.empName = name;
            chip.style.borderRadius = '999px';
            chip.style.border = '1px solid #c4dafc';
            chip.style.padding = '2px 10px';
            chip.style.background = '#e8f2ff';
            chip.style.fontSize = '11px';
            chip.style.color = '#1a73e8';
            chip.textContent = t;
            previewRef.appendChild(chip);
          });
        }
      }

function buildApproverSummary(){
        const rows = Array.from(lineBody.querySelectorAll('tr'));
        const approvals = rows.filter(r => (r.dataset.type || 'approval') === 'approval');
        const refs = rows.filter(r => (r.dataset.type || 'approval') === 'ref');

        const approvalNames = approvals.map(r => {
          const n = r.dataset.empName || '';
          const t = r.dataset.empTitle || '';
          return t ? (n + ' ' + t) : n;
        }).filter(Boolean);

        const refNames = refs.map(r => {
          const n = r.dataset.empName || '';
          const t = r.dataset.empTitle || '';
          return t ? (n + ' ' + t) : n;
        }).filter(Boolean);

        let parts = [];
        if(approvalNames.length){
          parts.push('승인: ' + approvalNames.join(', '));
        }
        if(refNames.length){
          parts.push('참조: ' + refNames.join(', '));
        }
        return parts.join(' / ');
      }


      function buildApprovalSteps(){
        const rows = Array.from(lineBody.querySelectorAll('tr'));
        const steps = [];

        rows.forEach((row, idx) => {
          const type = row.dataset.type || 'approval';
          const empId = row.dataset.empId || '';
          const name = row.dataset.empName || '';
          const title = row.dataset.empTitle || '';
          const dept = row.dataset.empDept || '';
          const isDelegate = (row.dataset.isDelegate === 'Y');
          const originalEmpId = row.dataset.originalEmpId || '';
          const originalName = row.dataset.originalEmpName || '';
          const originalTitle = row.dataset.originalEmpTitle || '';
          const originalDept = row.dataset.originalEmpDept || '';

          steps.push({
            order: idx + 1,
            empId: empId,
            name: name,
            title: title,
            dept: dept,
            type: type,
            status: (type === 'approval' ? 'PENDING' : 'NONE'),
            decidedAt: null,
            isDelegate: isDelegate ? 'Y' : 'N',
            originalEmpId: originalEmpId,
            originalName: originalName,
            originalTitle: originalTitle,
            originalDept: originalDept
          });
        });

        return steps;
      }

      function syncOuterPreview(){
        if(outerPreviewLine){
          outerPreviewLine.innerHTML = previewLine.innerHTML;
        }
        if(outerPreviewRef){
          outerPreviewRef.innerHTML = previewRef.innerHTML;
        }
        if(outerApproverInput){
          outerApproverInput.value = buildApproverSummary();
        }

        // 결재선 테이블 → approvalCenter.currentDraft.approvalSteps 반영
        if(typeof approvalCenter !== 'undefined' && approvalCenter.currentDraft){
          const steps = buildApprovalSteps();
          approvalCenter.currentDraft.approvalSteps = steps;

          // 최초 승인 단계 인덱스 설정 (approval 타입 중 첫 번째)
          let firstIdx = null;
          for(let i=0;i<steps.length;i++){
            if(steps[i].type === 'approval'){
              firstIdx = i;
              break;
            }
          }
          approvalCenter.currentDraft.currentStepIndex = (firstIdx !== null ? firstIdx : null);
        }
      }

      function openModal(){
        // 모달을 열 때마다 조직도 내용을 재렌더링 해서 최신 부재/대결자 정보를 반영
        try{
          renderOrgTree();
        }catch(e){
          console.warn('approvalLine openModal renderOrgTree error', e);
        }
        backdrop.classList.remove('hidden');
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden','false');
        escHandler = function(e){
          if(e.key === 'Escape'){
            closeModal();
          }
        };
        document.addEventListener('keydown', escHandler);
      }

      function closeModal(){
        backdrop.classList.remove('show');
        backdrop.classList.add('hidden');
        backdrop.setAttribute('aria-hidden','true');
        if(escHandler){
          document.removeEventListener('keydown', escHandler);
          escHandler = null;
        }
      }

      function applyAndClose(){
        syncOuterPreview();
        closeModal();
      }

      openBtn.addEventListener('click', function(){
        openModal();
      });

      backdrop.addEventListener('click', function(e){
        if(e.target === backdrop){
          closeModal();
        }
      });

      renderOrgTree();
      renderPreview();

      window.approvalLine = {
        openModal: openModal,
        closeModal: closeModal,
        applyAndClose: applyAndClose
      };
    })();
  </script>

<div id="tabRenameToast" class="tab-rename-toast"></div>


  <script>
    (function(){
      const backdrop = document.getElementById('sessionSwitchBackdrop');
      const orgTree = document.getElementById('sessionSwitchOrgTree');
      const selectedLabel = document.getElementById('sessionSwitchSelectedLabel');
      const userLabel = document.getElementById('sessionUserLabel');
      const openBtn = document.getElementById('btnOpenSessionSwitch');
      let selected = null;

      function getOrgData(){
        if (window.DBAM_ORG_DATA && Array.isArray(window.DBAM_ORG_DATA)){
          return window.DBAM_ORG_DATA;
        }
        return [];
      }

      function buildOrgTree(){
        if(!orgTree) return;
        const data = getOrgData();
        const frag = document.createDocumentFragment();
        data.forEach(function(dept){
          const deptDiv = document.createElement('div');
          deptDiv.style.marginBottom = '4px';

          const deptTitle = document.createElement('div');
          deptTitle.textContent = dept.dept;
          deptTitle.style.fontWeight = '600';
          deptTitle.style.fontSize = '12px';
          deptDiv.appendChild(deptTitle);

          (dept.teams || []).forEach(function(team){
            const teamDiv = document.createElement('div');
            teamDiv.style.marginLeft = '8px';

            const teamTitle = document.createElement('div');
            teamTitle.textContent = team.name;
            teamTitle.style.fontSize = '11px';
            teamTitle.style.color = '#4b5563';
            teamDiv.appendChild(teamTitle);

            const ul = document.createElement('ul');
            ul.style.listStyle = 'none';
            ul.style.margin = '2px 0 4px';
            ul.style.padding = '0';

            (team.members || []).forEach(function(m){
              const li = document.createElement('li');
              li.style.margin = '1px 0';
              li.style.cursor = 'pointer';

              const radio = document.createElement('input');
              radio.type = 'radio';
              radio.name = 'sessionSwitchUser';
              radio.style.marginRight = '4px';
              radio.value = m.id;

              const label = document.createElement('span');
              label.textContent = m.name + ' ' + (m.title || '');
              label.title = (m.dept || '');

              radio.addEventListener('change', function(){
                selectUser(m);
              });
              li.addEventListener('click', function(e){
                if(e.target !== radio){
                  radio.checked = true;
                  selectUser(m);
                }
              });

              li.appendChild(radio);
              li.appendChild(label);

              // 부재중인 사용자는 Badge 및 Tooltip 표시 (결재선 조직도와 동일 로직 재사용)
              try{
                var abs = null;
                if (window.DBAM_getActiveAbsenceForEmp){
                  abs = window.DBAM_getActiveAbsenceForEmp(m.id);
                } else if (window.DBAM_ABSENCE && Array.isArray(window.DBAM_ABSENCE)){
                  // fallback: 간단히 DBAM_ABSENCE에서 직접 조회
                  var now = new Date();
                  window.DBAM_ABSENCE.forEach(function(d){
                    if (!d || d.empId !== m.id) return;
                    try{
                      var s = new Date(d.start);
                      var e = new Date(d.end);
                      if (d.status === 'ACTIVE' && s <= now && now <= e){
                        abs = d;
                      }
                    }catch(e){}
                  });
                }

                if (abs && window.DBAM_formatAbsencePeriodForBadge){
                  var badge = document.createElement('span');
                  badge.textContent = '부재';
                  badge.style.marginLeft = '4px';
                  badge.style.fontSize = '10px';
                  badge.style.padding = '1px 4px';
                  badge.style.borderRadius = '999px';
                  badge.style.backgroundColor = '#fee2e2';
                  badge.style.color = '#b91c1c';

                  var periodText = window.DBAM_formatAbsencePeriodForBadge(abs);
                  var titleParts = [];
                  if (periodText){
                    titleParts.push('부재 기간: ' + periodText);
                  }
                  if (abs.delegate){
                    titleParts.push('대결자: ' + abs.delegate);
                  }
                  if (titleParts.length){
                    badge.title = titleParts.join(' / ');
                  }
                  li.appendChild(badge);
                }
              }catch(err){
                console.warn('delegate orgTree absence badge error', err);
              }

              ul.appendChild(li);
            });

            teamDiv.appendChild(ul);
            deptDiv.appendChild(teamDiv);
          });

          frag.appendChild(deptDiv);
        });

        orgTree.innerHTML = '';
        orgTree.appendChild(frag);
      }

      function syncCurrentLabel(){
        if(!userLabel) return;
        var name = window.DBAM_CURRENT_USER_NAME || window.DBAM_CURRENT_USER || 'demoUser';
        userLabel.textContent = name;
      }

      function updateSelectedLabel(){
        if(!selected || !selectedLabel){
          if(selectedLabel){
            selectedLabel.textContent = '아직 사용자를 선택하지 않았습니다.';
          }
          return;
        }
        // 예: 개발1팀 홍길동 책임 (최종 부서명 + 이름 + 직급)
        var deptShort = selected.dept || '';
        if (deptShort && deptShort.indexOf('/') >= 0){
          var parts = deptShort.split('/');
          deptShort = parts[parts.length - 1];
        }
        var bits = [];
        if (deptShort){
          bits.push(deptShort);
        }
        if (selected.name){
          bits.push(selected.name);
        }
        if (selected.title){
          bits.push(selected.title);
        }
        var txt = bits.join(' ');
        selectedLabel.textContent = txt;
      }

      function selectUser(m){
        selected = {
          id: m.id,
          name: m.name,
          title: m.title,
          dept: m.dept
        };
        updateSelectedLabel();
      }

      function open(){
        if(!backdrop) return;
        if(orgTree && !orgTree.firstElementChild){
          buildOrgTree();
        }
        updateSelectedLabel();
        syncCurrentLabel();
        backdrop.classList.remove('hidden');
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden','false');
      }

      function close(){
        if(!backdrop) return;
        backdrop.classList.remove('show');
        backdrop.classList.add('hidden');
        backdrop.setAttribute('aria-hidden','true');
      }

      function applySelected(){
        if(!selected){
          alert('세션으로 변경할 사용자를 선택하세요.');
          return;
        }
        window.DBAM_CURRENT_USER = selected.id;
        window.DBAM_CURRENT_USER_NAME = selected.name + ' ' + (selected.title || '');
        syncCurrentLabel();

        if(typeof approvalCenter !== 'undefined'){
          approvalCenter.refresh();
          if(approvalCenter.currentDetailId){
            approvalCenter.openDetail(approvalCenter.currentDetailId);
          }
        }

        close();
      }

      if(openBtn){
        openBtn.addEventListener('click', function(){
          open();
        });
      }

      // 초기 라벨 세팅
      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', syncCurrentLabel);
      }else{
        syncCurrentLabel();
      }

      window.sessionSwitcher = {
        open: open,
        close: close,
        applySelected: applySelected
      };
    })();
  
    (function(){
      const backdrop = document.getElementById('delegateOrgBackdrop');
      const orgTree = document.getElementById('delegateOrgTree');
      const selectedLabel = document.getElementById('delegateSelectedLabel');
      const delegateInput = document.getElementById('delegateName');
      if (!backdrop || !orgTree || !selectedLabel || !delegateInput) {
        return;
      }

      let selected = null;
      let escHandler = null;

      function getOrgData(){
        if (window.DBAM_ORG_DATA && Array.isArray(window.DBAM_ORG_DATA)){
          return window.DBAM_ORG_DATA;
        }
        return [];
      }

      function buildOrgTree(){
        orgTree.innerHTML = '';
        const data = getOrgData();
        const frag = document.createDocumentFragment();

        data.forEach(function(dept){
          const deptDiv = document.createElement('div');
          deptDiv.style.marginBottom = '4px';

          const deptTitle = document.createElement('div');
          deptTitle.textContent = dept.dept;
          deptTitle.style.fontWeight = '600';
          deptTitle.style.fontSize = '12px';
          deptDiv.appendChild(deptTitle);

          (dept.teams || []).forEach(function(team){
            const teamDiv = document.createElement('div');
            teamDiv.style.marginLeft = '8px';

            const teamTitle = document.createElement('div');
            teamTitle.textContent = team.name;
            teamTitle.style.fontSize = '11px';
            teamTitle.style.color = '#4b5563';
            teamDiv.appendChild(teamTitle);

            const ul = document.createElement('ul');
            ul.style.listStyle = 'none';
            ul.style.margin = '2px 0 4px 0';
            ul.style.padding = '0';

            (team.members || []).forEach(function(m){
              const li = document.createElement('li');
              li.style.display = 'flex';
              li.style.alignItems = 'center';
              li.style.fontSize = '12px';

              const radio = document.createElement('input');
              radio.type = 'radio';
              radio.name = 'delegateUserSelect';
              radio.style.marginRight = '4px';
              radio.value = m.id;

              const label = document.createElement('span');
              label.textContent = m.name + ' ' + (m.title || '');
              label.title = (m.dept || '');

              radio.addEventListener('change', function(){
                selectUser(m);
              });
              li.addEventListener('click', function(e){
                if(e.target !== radio){
                  radio.checked = true;
                  selectUser(m);
                }
              });

              li.appendChild(radio);
              li.appendChild(label);

              // 부재중인 사용자는 Badge 및 Tooltip 표시 (결재선 조직도와 동일 로직 재사용)
              try{
                var abs = null;
                if (window.DBAM_getActiveAbsenceForEmp){
                  abs = window.DBAM_getActiveAbsenceForEmp(m.id);
                } else if (window.DBAM_ABSENCE && Array.isArray(window.DBAM_ABSENCE)){
                  // fallback: 간단히 DBAM_ABSENCE에서 직접 조회
                  var now = new Date();
                  window.DBAM_ABSENCE.forEach(function(d){
                    if (!d || d.empId !== m.id) return;
                    try{
                      var s = new Date(d.start);
                      var e = new Date(d.end);
                      if (d.status === 'ACTIVE' && s <= now && now <= e){
                        abs = d;
                      }
                    }catch(e){}
                  });
                }

                if (abs && window.DBAM_formatAbsencePeriodForBadge){
                  var badge = document.createElement('span');
                  badge.textContent = '부재';
                  badge.style.marginLeft = '4px';
                  badge.style.fontSize = '10px';
                  badge.style.padding = '1px 4px';
                  badge.style.borderRadius = '999px';
                  badge.style.backgroundColor = '#fee2e2';
                  badge.style.color = '#b91c1c';

                  var periodText = window.DBAM_formatAbsencePeriodForBadge(abs);
                  var titleParts = [];
                  if (periodText){
                    titleParts.push('부재 기간: ' + periodText);
                  }
                  if (abs.delegate){
                    titleParts.push('대결자: ' + abs.delegate);
                  }
                  if (titleParts.length){
                    badge.title = titleParts.join(' / ');
                  }
                  li.appendChild(badge);
                }
              }catch(err){
                console.warn('delegate orgTree absence badge error', err);
              }

              ul.appendChild(li);
            });

            teamDiv.appendChild(ul);
            deptDiv.appendChild(teamDiv);
          });

          frag.appendChild(deptDiv);
        });

        orgTree.appendChild(frag);
      }

      function updateSelectedLabel(){
        if(!selected){
          selectedLabel.textContent = '아직 대결자를 선택하지 않았습니다.';
          return;
        }
        // 예: 개발1팀 홍길동 책임 (최종 부서명 + 이름 + 직급)
        var deptShort = selected.dept || '';
        if (deptShort && deptShort.indexOf('/') >= 0){
          var parts = deptShort.split('/');
          deptShort = parts[parts.length - 1];
        }
        var bits = [];
        if (deptShort){
          bits.push(deptShort);
        }
        if (selected.name){
          bits.push(selected.name);
        }
        if (selected.title){
          bits.push(selected.title);
        }
        var txt = bits.join(' ');
        selectedLabel.textContent = txt;
      }

      function selectUser(m){
        selected = {
          id: m.id,
          name: m.name,
          title: m.title,
          dept: m.dept
        };
        updateSelectedLabel();
      }

      function open(){
        if(!backdrop) return;
        if(orgTree){
          buildOrgTree(); // 항상 최신 부재 정보를 반영하기 위해 매 오픈 시 트리 재구성
        }
        updateSelectedLabel();
        backdrop.classList.remove('hidden');
        backdrop.classList.add('show');
        backdrop.setAttribute('aria-hidden','false');
      }

      function close(){
        backdrop.classList.remove('show');
        backdrop.classList.add('hidden');
        backdrop.setAttribute('aria-hidden','true');
        // delegateOrg ESC 핸들링은 전역 ESC 로직에서 처리
        escHandler = null;
      }

      function applySelected(){
        if(!selected){
          alert('대결자를 선택해 주세요.');
          return;
        }
        if (delegateInput){
          // 형식: 최종 부서명 + 이름 + 직급 → "개발1팀 홍길동 책임"
          var dept = selected.dept || '';
          var teamName = dept;
          var idx = dept.lastIndexOf('/');
          if(idx >= 0){
            teamName = dept.substring(idx+1);
          }
          var parts = [];
          if(teamName){ parts.push(teamName); }
          if(selected.name){ parts.push(selected.name); }
          if(selected.title){ parts.push(selected.title); }
          delegateInput.value = parts.join(' ');
          delegateInput.dataset.empId = selected.id || '';
        }
        close();
      }

      window.delegatePicker = {
        open: open,
        close: close,
        applySelected: applySelected
      };
    })();
    
//**tk - start//////////////////////////////////
    // =======================
// [조직도 관리 ] const adminOrgDemo
// =======================

(() => {
  const W = window;

  /* ---------- (1) 카드 라우터 보강: openItem 미존재로 인한 오류 방지 ---------- */
  function patchAdminRouterIfNeeded() {
    if (!W.admin) return;

    // registerItemHandler가 없으면 최소 구현
    if (typeof W.admin.registerItemHandler !== "function") {
      W.admin.__itemHandlers = W.admin.__itemHandlers || {};
      W.admin.registerItemHandler = function (itemId, fn) {
        this.__itemHandlers[itemId] = fn;
      };
    } else {
      W.admin.__itemHandlers = W.admin.__itemHandlers || {};
    }

    // openItem이 없으면 최소 구현(이전 this.openItem 오류 방지)
    if (typeof W.admin.openItem !== "function") {
      W.admin.openItem = function (itemId, sectionId) {
        try {
          if (sectionId && typeof this.show === "function") this.show(sectionId);
          const fn = this.__itemHandlers?.[itemId];
          if (typeof fn === "function") {
            requestAnimationFrame(() => {
              try { fn(); } catch (e) { console.warn("openItem handler error", e); }
            });
            return true;
          }
        } catch (e) {}
        return false;
      };
    }
  }
  
  /* ---------- (2) 조직도 관리 모듈 ---------- */
  const orgChartAdmin = {
    uiStateKey: "dbam.orgChart.ui.v2",
    dataKey: "dbam.orgChart.data.v2",

    _orgData: null,
    _idSeq: 1,

    _ui: {
      query: "",
      filterMode: "highlight", // highlight | filter
      collapsed: {}, // { [id]: true }
      selectedId: null,
      
      manualEdit: false,          // 기본: 수기 편집 OFF
      lastSyncAt: null,           // ISO string
      syncSource: "HR/LDAP/AD",   // 표시용
    },

    /* ===== 스타일 주입(깨져도 다시 살리기) ===== */
    ensureStyles() {
      // (1) 이전 버전 스타일(남아있으면) 정리
      ["dbam-org-chart-styles-v2", "dbam-org-harmony-v1"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.remove();
      });

      // (2) 최신 스타일은 항상 갱신(구버전 style이 남아있어도 덮어씀)
      const STYLE_ID = "dbam-org-chart-styles-v3";
      const css = `
        /* ===== 화면 레이아웃(관리 콘솔 톤) ===== */
        #orgMgmtPage{width:100%;}
        #orgMgmtPage .org-toolbar-row{
          display:flex; align-items:center; justify-content:space-between;
          gap:10px; flex-wrap:wrap;
        }
        #orgMgmtPage .org-toolbar-left{
          display:flex; align-items:center; gap:10px; flex:1;
          min-width:260px; flex-wrap:wrap;
        }
        #orgMgmtPage .org-toolbar-right{
          display:flex; align-items:center; gap:8px; flex-wrap:wrap;
        }
        #orgMgmtPage .org-grid{
          display:grid;
          grid-template-columns: 1fr 1fr;
          gap:10px;
        }
        @media (max-width: 1100px){
          #orgMgmtPage .org-grid{grid-template-columns:1fr;}
        }
        #orgMgmtPage .org-pane-head{
          display:flex; align-items:center; justify-content:space-between;
          gap:10px; margin-bottom:10px;
        }
        #orgMgmtPage .org-pane-title{
          display:flex; align-items:center; gap:8px;
          font-size:13px; font-weight:800; color:var(--ink);
        }

        /* ===== 트리 ===== */
        #orgMgmtPage .org-tree{padding:4px 2px; max-height:540px; overflow:auto;}
        .org-row{
          display:flex; align-items:center; gap:8px;
          padding:6px 8px; border-radius:10px; cursor:pointer;
        }
        .org-row:hover{background:rgba(0,0,0,.03);}
        .org-row.selected{
          outline:2px solid rgba(0,133,124,.25);
          background:rgba(0,133,124,.07);
        }
        .org-caret{
          width:18px; height:18px;
          display:inline-flex; align-items:center; justify-content:center;
          border-radius:6px;
          background:var(--tab-bg);
          color:var(--muted);
          font-weight:900;
          user-select:none;
        }
        .org-name{font-weight:800; color:var(--ink); line-height:1.2;}
        .org-meta{font-size:11px; color:var(--muted); line-height:1.2;}
        .org-badge{
          margin-left:auto;
          font-size:11px;
          padding:2px 8px;
          border-radius:999px;
          background:rgba(0,133,124,.12);
          color:var(--hana-primary);
          border:1px solid rgba(0,133,124,.18);
        }
        .org-children{
          margin-left:18px;
          border-left:1px dashed rgba(0,0,0,.18);
          padding-left:10px;
        }
        .org-hl{background:rgba(250,204,21,.35); border-radius:4px; padding:0 2px;}

        /* ===== 상세 ===== */
        #orgMgmtPage .org-detail{min-height:540px;}
        .org-detail-empty{font-size:12px; color:var(--muted); padding:10px 6px;}
        .org-kv{
          display:grid;
          grid-template-columns: 120px 1fr;
          gap:8px;
          padding:6px 0;
          border-bottom:1px solid rgba(0,0,0,.06);
        }
        .org-kv:last-child{border-bottom:none;}
        .org-k{font-size:12px; color:var(--muted); font-weight:700;}
        .org-v{font-size:12px; color:var(--ink); font-weight:700;}
        .org-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}

        .org-table{width:100%; border-collapse:collapse; font-size:12px; margin-top:10px;}
        .org-table th, .org-table td{
          padding:8px;
          border-bottom:1px solid rgba(0,0,0,.08);
          text-align:left;
        }
        .org-table th{
          background:var(--tab-bg);
          color:var(--muted);
          font-weight:800;
        }

        /* ===== 폼 ===== */
        .org-form{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
        .org-form .full{grid-column:1/-1;}
        .org-label{font-size:11px; color:var(--muted); margin-bottom:4px; font-weight:800;}
        .org-field, .org-textarea{
          width:100%;
          padding:8px 10px;
          border:1px solid rgba(0,0,0,.12);
          border-radius:10px;
          background:#fff;
          color:var(--ink);
          font-size:12px;
        }
        .org-textarea{min-height:90px; resize:vertical;}
        .org-field:focus, .org-textarea:focus{
          outline:none;
          box-shadow:0 0 0 3px rgba(0,133,124,.18);
          border-color: rgba(0,133,124,.35);
        }

        /* ===== 모달(전역: body에 append됨) ===== */
        .org-modal-backdrop{
          position:fixed;
          inset:0;
          background:rgba(15,23,42,.45);
          display:none;
          align-items:center;
          justify-content:center;
          z-index:9999;
        }
        .org-modal-backdrop.show{display:flex;}

        .org-modal{
          width:min(760px, calc(100% - 24px));
          max-height:calc(100% - 40px);
          overflow:auto;
          background:#fff;
          border-radius:12px;
          border:1px solid rgba(0,0,0,.12);
          box-shadow:0 16px 40px rgba(0,0,0,.25);
        }
        .org-modal-hd{
          display:flex; align-items:center; justify-content:space-between;
          padding:10px 12px;
          border-bottom:1px solid rgba(0,0,0,.08);
          background:var(--panel);
        }
        .org-modal-title{
          font-size:13px; font-weight:900; color:var(--ink);
          display:flex; align-items:center; gap:8px;
        }
        .org-modal-close{
          border:1px solid rgba(0,0,0,.12);
          background:#fff;
          border-radius:10px;
          width:34px; height:34px;
          display:inline-flex; align-items:center; justify-content:center;
          cursor:pointer;
        }
        .org-modal-bd{padding:12px;}
        .org-modal-ft{
          display:flex; gap:8px; justify-content:flex-end;
          padding:10px 12px;
          border-top:1px solid rgba(0,0,0,.08);
          background:var(--tab-bg);
        }

        .org-btn{
          border:1px solid rgba(0,0,0,.12);
          background:#fff;
          border-radius:10px;
          padding:8px 12px;
          font-size:12px;
          cursor:pointer;
        }
        .org-btn.primary{
          background:var(--hana-primary);
          border-color:var(--hana-primary);
          color:#fff;
        }
        .org-btn:hover{filter:brightness(0.98);}
      `;

      let styleEl = document.getElementById(STYLE_ID);
      if (!styleEl) {
        styleEl = document.createElement("style");
        styleEl.id = STYLE_ID;
        document.head.appendChild(styleEl);
      }
      if (styleEl.textContent !== css) styleEl.textContent = css;
    },


    /* ===== 유틸 ===== */
    _escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    },
    _formatTs(iso) {
    	  if (!iso) return "-";
    	  try {
    	    const d = new Date(iso);
    	    const pad = (n) => String(n).padStart(2, "0");
    	    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    	  } catch (e) {
    	    return String(iso);
    	  }
    	},

    	_indexOrg(list) {
    	  const map = new Map(); // id -> {id,parentId,name,code,manager,note}
    	  const walk = (arr, parentId) => {
    	    (arr || []).forEach(n => {
    	      if (!n) return;
    	      map.set(n.id, {
    	        id: n.id,
    	        parentId: parentId || "",
    	        name: n.name || "",
    	        code: n.code || "",
    	        manager: n.manager || "",
    	        note: n.note || ""
    	      });
    	      if (n.children && n.children.length) walk(n.children, n.id);
    	    });
    	  };
    	  walk(list || [], "");
    	  return map;
    	},

    	syncNow() {
    	  // ✅ “외부(HR/LDAP/AD) 동기화”를 모의: 하드코딩 원본(loadOrgStructure)로 덮어쓰기
    	  const prev = this._orgData || [];
    	  const next = (typeof this.loadOrgStructure === "function") ? this.loadOrgStructure() : [];

    	  const a = this._indexOrg(prev);
    	  const b = this._indexOrg(next);

    	  let added = 0, removed = 0, updated = 0;
    	  for (const id of b.keys()) {
    	    if (!a.has(id)) added++;
    	    else {
    	      const x = a.get(id), y = b.get(id);
    	      const changed =
    	        x.parentId !== y.parentId ||
    	        x.name !== y.name ||
    	        x.code !== y.code ||
    	        x.manager !== y.manager ||
    	        x.note !== y.note;
    	      if (changed) updated++;
    	    }
    	  }
    	  for (const id of a.keys()) if (!b.has(id)) removed++;

    	  // 동기화 적용
    	  this._orgData = next;
    	  this._reseedIdSeq();
    	  this._saveOrgStructure();

    	  // lastSync 갱신
    	  this._ui.lastSyncAt = new Date().toISOString();
    	  this._saveUiState();

    	  // 선택 복원(없으면 첫 노드)
    	  const sel = this._ui.selectedId;
    	  if (sel && !this._findNode(sel).node) this._ui.selectedId = null;

    	  this._renderOrgTree();
    	  if (this._ui.selectedId) this._renderDetail();
    	  else this._selectFirstVisible();

    	  // 결과 알림(간단 요약)
    	  alert(`동기화 완료\n추가: ${added} / 변경: ${updated} / 제거: ${removed}`);
    	},

    _loadUiState() {
      try {
        const raw = localStorage.getItem(this.uiStateKey);
        if (!raw) return;
        const o = JSON.parse(raw);
        if (!o || typeof o !== "object") return;
        this._ui.query = o.query || "";
        this._ui.filterMode = o.filterMode === "filter" ? "filter" : "highlight";
        this._ui.collapsed = (o.collapsed && typeof o.collapsed === "object") ? o.collapsed : {};
        this._ui.selectedId = o.selectedId || null;
        this._ui.manualEdit = !!o.manualEdit;
        this._ui.lastSyncAt = o.lastSyncAt || null;
        this._ui.syncSource = o.syncSource || "HR/LDAP/AD";
      } catch (e) {}
    },

    _saveUiState() {
      try {
        localStorage.setItem(this.uiStateKey, JSON.stringify({
          query: this._ui.query,
          filterMode: this._ui.filterMode,
          collapsed: this._ui.collapsed,
          selectedId: this._ui.selectedId,
          manualEdit: this._ui.manualEdit,
          lastSyncAt: this._ui.lastSyncAt,
          syncSource: this._ui.syncSource,
        }));
      } catch (e) {}
    },

    _loadOrgStructure() {
      // “가상 저장 포함”: localStorage에 데이터가 있으면 그것을 사용
      try {
        const raw = localStorage.getItem(this.dataKey);
        if (raw) {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) return parsed;
        }
      } catch (e) {}
      return this.loadOrgStructure();
    },

    _saveOrgStructure() {
      try {
        localStorage.setItem(this.dataKey, JSON.stringify(this._orgData || []));
      } catch (e) {}
    },

    _walk(list, fn) {
      (list || []).forEach((n) => {
        fn(n);
        if (n.children && n.children.length) this._walk(n.children, fn);
      });
    },
    
    _flattenNodes() {
    	  const out = [];
    	  const walk = (arr, depth) => {
    	    (arr || []).forEach((n) => {
    	      if (!n) return;
    	      out.push({
    	        id: String(n.id ?? ""),
    	        name: n.name ?? "",
    	        code: n.code ?? "",
    	        depth: depth || 0,
    	      });
    	      if (n.children && n.children.length) walk(n.children, (depth || 0) + 1);
    	    });
    	  };
    	  walk(this._orgData || [], 0);
    	  return out;
    	},
    	
    _reseedIdSeq() {
      let max = 0;
      this._walk(this._orgData || [], (n) => {
        const m = String(n.id || "").match(/(\d+)/);
        if (m) max = Math.max(max, parseInt(m[1], 10));
      });
      this._idSeq = Math.max(1, max + 1);
    },

    _findNode(id) {
      let found = { node: null, parent: null, parentArr: null, idx: -1 };
      const walk = (arr, parent) => {
        for (let i = 0; i < (arr || []).length; i++) {
          const n = arr[i];
          if (n.id === id) {
            found = { node: n, parent, parentArr: arr, idx: i };
            return true;
          }
          if (n.children && n.children.length) {
            if (walk(n.children, n)) return true;
          }
        }
        return false;
      };
      walk(this._orgData || [], null);
      return found;
    },

    _getPath(id) {
      const path = [];
      const walk = (arr, stack) => {
        for (const n of (arr || [])) {
          const next = stack.concat([n]);
          if (n.id === id) {
            next.forEach(x => path.push(x.name));
            return true;
          }
          if (n.children && n.children.length) {
            if (walk(n.children, next)) return true;
          }
        }
        return false;
      };
      walk(this._orgData || [], []);
      return path.join(" / ");
    },

    _mark(text, q) {
      const s = String(text ?? "");
      const query = String(q ?? "").trim();
      if (!query) return this._escapeHtml(s);

      const low = s.toLowerCase();
      const ql = query.toLowerCase();
      const idx = low.indexOf(ql);
      if (idx < 0) return this._escapeHtml(s);

      // 여러 번 등장도 처리
      let out = "";
      let pos = 0;
      while (true) {
        const i = low.indexOf(ql, pos);
        if (i < 0) break;
        out += this._escapeHtml(s.slice(pos, i));
        out += `<span class="org-hl">${this._escapeHtml(s.slice(i, i + query.length))}</span>`;
        pos = i + query.length;
      }
      out += this._escapeHtml(s.slice(pos));
      return out;
    },

    _computeFilterSets() {
      const query = (this._ui.query || "").trim().toLowerCase();
      const matchIds = new Set();
      const showIds = new Set();
      const ancestorIds = new Set();

      if (!query) return { query, matchIds, showIds, ancestorIds };

      const matchNode = (node) => {
        const members = (node.members || []).map(m => m.name).join(" ");
        const base = `${node.name || ""} ${node.code || ""} ${node.manager || ""} ${members}`.toLowerCase();
        return base.includes(query);
      };

      const walk = (node, ancestors) => {
        const isMatch = matchNode(node);
        let childHas = false;
        (node.children || []).forEach(ch => {
          if (walk(ch, ancestors.concat([node.id]))) childHas = true;
        });

        const has = isMatch || childHas;
        if (has) {
          showIds.add(node.id);
          ancestors.forEach(a => {
            showIds.add(a);
            ancestorIds.add(a);
          });
        }
        if (isMatch) matchIds.add(node.id);
        return has;
      };

      (this._orgData || []).forEach(r => walk(r, []));
      return { query, matchIds, showIds, ancestorIds };
    },

    _setAllCollapse(collapsed) {
      const map = this._ui.collapsed || {};
      this._walk(this._orgData || [], (n) => {
        if (n.children && n.children.length) map[n.id] = !!collapsed;
      });
      this._ui.collapsed = map;
      this._saveUiState();
    },

    _selectById(id, opts = {}) {
      this._ui.selectedId = id || null;
      this._saveUiState();
      this._renderOrgTree();

      if (!opts.silent) this._renderDetail();

      if (opts.scroll) {
        const row = document.querySelector(`.org-row[data-node-id="${CSS.escape(id)}"]`);
        if (row) row.scrollIntoView({ block: "nearest" });
      }
    },

    _selectFirstVisible() {
      const first = document.querySelector(".org-row[data-node-id]");
      if (first) {
        const id = first.getAttribute("data-node-id");
        this._selectById(id, { scroll: true, silent: false });
      }
    },

    /* ===== 화면 진입 ====== */
openOrgView() {
  this.ensureStyles();
  this._loadUiState();

  const titleEl = document.getElementById("adminTitle");
  const descEl  = document.getElementById("adminDesc");
  const bodyEl  = document.getElementById("adminBody");
  if (!bodyEl) return;

  if (titleEl) titleEl.innerHTML = '<i class="fa-solid fa-sitemap"></i> 조직도 관리';
  if (descEl)  descEl.textContent =
    "조직도는 HR 시스템 또는 LDAP/AD와 연동하여 주기적으로 동기화하는 방식이 기본이며, 수기 편집은 예외적으로만 허용합니다.";

  // 데이터 로딩(+가상 저장)
  this._orgData = this._loadOrgStructure();
  this._reseedIdSeq();

  const lastSyncText = this._formatTs(this._ui.lastSyncAt);
  const manualOn = !!this._ui.manualEdit;

  bodyEl.innerHTML = `
    <div id="orgMgmtPage" class="emg-page">
      <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
        <div class="org-toolbar-row">
          <div class="org-toolbar-left">
            <input id="orgSearchInput" class="export-input" placeholder="조직명/담당자/구성원 검색" />
            <label class="checkbox-item" title="체크 시 매칭되는 노드(및 상위 경로)만 표시합니다.">
              <input type="checkbox" id="orgOnlyResultChk" />
              결과만 보기
            </label>
          </div>
          <div class="org-toolbar-right">
            <button class="btn btn-outline btn-sm" id="orgExpandAllBtn"><i class="fa-solid fa-square-plus"></i> 전체 펼치기</button>
            <button class="btn btn-outline btn-sm" id="orgCollapseAllBtn"><i class="fa-solid fa-square-minus"></i> 전체 접기</button>
            <button class="btn btn-outline btn-sm" id="orgSyncNowBtn"><i class="fa-solid fa-rotate"></i> 지금 동기화</button>

            <!-- 수기 편집은 예외 -->
            <label class="checkbox-item" style="margin-left:6px;" title="예외적으로만 사용하세요. 동기화 시 덮어써질 수 있습니다.">
              <input type="checkbox" id="orgManualEditChk" ${manualOn ? "checked" : ""}/>
              수기 편집(예외)
            </label>

            <!-- 수기 편집 ON 일때만 노출 -->
            <button class="btn btn-primary btn-sm" id="orgAddDeptBtn" style="${manualOn ? "" : "display:none;"}">
              <i class="fa-solid fa-plus"></i> 부서 추가
            </button>
          </div>
        </div>

        <div class="admin-footer" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <span class="chip">원본: <b id="orgSyncSourceTxt">${this._escapeHtml(this._ui.syncSource || "HR/LDAP/AD")}</b></span>
          <span class="chip">마지막 동기화: <b id="orgLastSyncTxt">${this._escapeHtml(lastSyncText)}</b></span>
          <span class="chip" style="border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10);">
            수기 변경은 지양(예외만)
          </span>
        </div>
      </div>

      <div class="org-grid">
        <div class="admin-card" style="padding:12px 14px;">
          <div class="org-pane-head">
            <div class="org-pane-title"><i class="fa-solid fa-diagram-project"></i> 조직 트리</div>
            <span class="chip">탐색</span>
          </div>
          <div id="orgTreeRoot" class="org-tree"></div>
        </div>

        <div class="admin-card" style="padding:12px 14px;">
          <div class="org-pane-head">
            <div class="org-pane-title"><i class="fa-solid fa-circle-info"></i> 선택된 조직 정보</div>
            <span class="chip" id="orgSelectedBadge">-</span>
          </div>
          <div id="orgDetailRoot" class="org-detail">
            <div class="org-detail-empty">좌측 조직을 선택하면 상세 정보가 표시됩니다.</div>
          </div>
        </div>
      </div>
    </div>
  `;

  const qInput = document.getElementById("orgSearchInput");
  const onlyChk = document.getElementById("orgOnlyResultChk");
  const btnExpand = document.getElementById("orgExpandAllBtn");
  const btnCollapse = document.getElementById("orgCollapseAllBtn");
  const btnSync = document.getElementById("orgSyncNowBtn");
  const btnAdd = document.getElementById("orgAddDeptBtn");
  const chkManual = document.getElementById("orgManualEditChk");

  const refreshMeta = () => {
    const src = document.getElementById("orgSyncSourceTxt");
    const last = document.getElementById("orgLastSyncTxt");
    if (src) src.textContent = this._ui.syncSource || "HR/LDAP/AD";
    if (last) last.textContent = this._formatTs(this._ui.lastSyncAt);
    if (btnAdd) btnAdd.style.display = this._ui.manualEdit ? "" : "none";
  };

  if (qInput) {
    qInput.value = this._ui.query || "";
    qInput.addEventListener("keyup", () => {
      this._ui.query = qInput.value || "";
      this._saveUiState();

      const sets = this._computeFilterSets();
      if (sets.query) {
        sets.ancestorIds.forEach(a => { this._ui.collapsed[a] = false; });
        this._saveUiState();
      }

      this._renderOrgTree();
      if (this._ui.filterMode === "filter") {
        const selRow = document.querySelector(`.org-row[data-node-id="${CSS.escape(this._ui.selectedId || "")}"]`);
        if (!selRow) this._selectFirstVisible();
      }
    });
  }

  if (onlyChk) {
    onlyChk.checked = (this._ui.filterMode === "filter");
    onlyChk.addEventListener("change", () => {
      this._ui.filterMode = onlyChk.checked ? "filter" : "highlight";
      this._saveUiState();
      this._renderOrgTree();
      if (this._ui.filterMode === "filter") this._selectFirstVisible();
    });
  }

  if (btnExpand) btnExpand.addEventListener("click", () => {
    this._setAllCollapse(false);
    this._renderOrgTree();
  });

  if (btnCollapse) btnCollapse.addEventListener("click", () => {
    this._setAllCollapse(true);
    this._renderOrgTree();
  });

  if (btnSync) btnSync.addEventListener("click", () => {
    // 동기화 실행(수기 변경 덮어쓸 수 있음)
    const ok = confirm("지금 동기화를 수행하면, 수기 변경 사항이 덮어써질 수 있습니다.\n계속하시겠습니까?");
    if (!ok) return;
    this.syncNow();
    refreshMeta();
  });

  if (chkManual) {
    chkManual.addEventListener("change", () => {
      if (chkManual.checked) {
        const ok = confirm("수기 편집은 예외적으로만 사용하세요.\n동기화 시 변경 사항이 덮어써질 수 있습니다.\n수기 편집을 켜시겠습니까?");
        if (!ok) {
          chkManual.checked = false;
          return;
        }
        this._ui.manualEdit = true;
      } else {
        this._ui.manualEdit = false;
      }
      this._saveUiState();
      refreshMeta();
      this._renderDetail();
    });
  }

  if (btnAdd) btnAdd.addEventListener("click", () => {
    if (!this._ui.manualEdit) return;
    this._openDeptModal("add", {
      parentId: this._ui.selectedId || "",
      name: "",
      code: "",
      manager: "",
      note: "",
    });
  });

  // 렌더
  this._renderOrgTree();
  if (this._ui.selectedId) {
    const exists = this._findNode(this._ui.selectedId).node;
    if (exists) this._renderDetail();
    else this._selectFirstVisible();
  } else {
    this._selectFirstVisible();
  }

  refreshMeta();
},



    /* ===== 트리 렌더링 ===== */
    _renderOrgTree() {
      const root = document.getElementById("orgTreeRoot");
      if (!root) return;

      const sets = this._computeFilterSets();
      const q = (this._ui.query || "").trim();

      root.innerHTML = "";

      const renderNode = (node, depth) => {
        const hasChildren = !!(node.children && node.children.length);
        const isCollapsed = !!this._ui.collapsed[node.id];
        const isSelected = (this._ui.selectedId === node.id);

        // filter 모드면 showIds에 없는 노드는 숨김
        if (this._ui.filterMode === "filter" && sets.query) {
          if (!sets.showIds.has(node.id)) return null;
        }

        const wrap = document.createElement("div");
        wrap.className = "org-node";

        const row = document.createElement("div");
        row.className = "org-row" + (isSelected ? " is-selected" : "");
        row.setAttribute("data-node-id", node.id);

        // 들여쓰기(가독성)
        for (let i = 0; i < depth; i++) {
          const ind = document.createElement("span");
          ind.className = "org-indent";
          row.appendChild(ind);
        }

        if (hasChildren) {
          const caret = document.createElement("span");
          caret.className = "org-caret";
          caret.innerHTML = isCollapsed ? '<i class="fa-solid fa-plus"></i>' : '<i class="fa-solid fa-minus"></i>';
          caret.addEventListener("click", (e) => {
            e.stopPropagation();
            this._ui.collapsed[node.id] = !this._ui.collapsed[node.id];
            this._saveUiState();
            this._renderOrgTree();
          });
          row.appendChild(caret);
        } else {
          // 정렬을 맞추기 위한 자리
          const dummy = document.createElement("span");
          dummy.className = "org-caret";
          dummy.style.opacity = "0";
          dummy.textContent = "+";
          row.appendChild(dummy);
        }

        const textWrap = document.createElement("div");
        textWrap.style.display = "flex";
        textWrap.style.flexDirection = "column";
        textWrap.style.gap = "2px";

        const nameEl = document.createElement("div");
        nameEl.className = "org-name";
        nameEl.innerHTML = q ? this._mark(node.name, q) : this._escapeHtml(node.name);

        const metaEl = document.createElement("div");
        metaEl.className = "org-meta";
        const memCount = (node.members || []).length;
        const manager = node.manager ? (q ? this._mark(node.manager, q) : this._escapeHtml(node.manager)) : "-";
        metaEl.innerHTML = `담당: ${manager} · 구성원: ${memCount}명`;

        textWrap.appendChild(nameEl);
        textWrap.appendChild(metaEl);

        row.appendChild(textWrap);

        row.addEventListener("click", () => {
          this._selectById(node.id, { scroll: true, silent: false });
        });

        wrap.appendChild(row);

        if (hasChildren && !isCollapsed) {
          const childrenWrap = document.createElement("div");
          childrenWrap.className = "org-children";
          (node.children || []).forEach(ch => {
            const el = renderNode(ch, depth + 1);
            if (el) childrenWrap.appendChild(el);
          });
          wrap.appendChild(childrenWrap);
        }

        return wrap;
      };

      (this._orgData || []).forEach(r => {
        const el = renderNode(r, 0);
        if (el) root.appendChild(el);
      });

      // 선택 배지 업데이트
      const badge = document.getElementById("orgSelectedBadge");
      if (badge) {
        const n = this._ui.selectedId ? this._findNode(this._ui.selectedId).node : null;
        badge.textContent = n ? n.name : "-";
      }
    },

    /* ===== 상세 패널 ===== */
    _renderDetail() {
      const detail = document.getElementById("orgDetailRoot");
      if (!detail) return;

      const badge = document.getElementById("orgSelectedBadge");
      const node = this._ui.selectedId ? this._findNode(this._ui.selectedId).node : null;

      const canEdit = !!(this._ui && this._ui.manualEdit);

      if (!node) {
        if (badge) badge.textContent = "-";
        detail.innerHTML = `<div class="org-detail-empty">좌측 조직을 선택하면 상세 정보가 표시됩니다.</div>`;
        return;
      }

      if (badge) badge.textContent = node.name;

      const path = this._getPath(node.id);
      const members = node.members || [];

      detail.innerHTML = `
        <div style="font-size:12px; color:var(--muted);">좌측 조직을 선택하면 상세 정보가 표시됩니다.</div>

        <dl class="org-kv">
          <dt>조직명</dt><dd>${this._escapeHtml(node.name)}</dd>
          <dt>조직코드</dt><dd>${this._escapeHtml(node.code || "-")}</dd>
          <dt>담당자</dt><dd>${this._escapeHtml(node.manager || "-")}</dd>
          <dt>경로</dt><dd>${this._escapeHtml(path || "-")}</dd>
          <dt>메모</dt><dd>${this._escapeHtml(node.note || "-")}</dd>
        </dl>

        ${
            canEdit
              ? `<div class="org-actions">
                   <button class="org-btn" id="orgEditBtn"><i class="fa-solid fa-pen-to-square"></i> 수정</button>
                   <button class="org-btn" id="orgDeleteBtn"><i class="fa-solid fa-trash"></i> 삭제</button>
                 </div>`
              : `<div style="margin-top:10px; font-size:12px; color:var(--muted);">
                   이 조직도는 동기화 기반으로 관리됩니다. 수기 편집은 예외적으로만 허용됩니다.
                 </div>`
          }

        <div style="margin-top:12px; font-weight:900; font-size:12.5px; color:var(--ink);">팀원 목록</div>
        <table class="org-table">
          <thead>
            <tr>
              <th style="width:26%;">이름</th>
              <th style="width:22%;">직급</th>
              <th style="width:26%;">계정</th>
              <th style="width:26%;">이메일</th>
            </tr>
          </thead>
          <tbody>
            ${
              members.length
                ? members.map(m => `
                  <tr>
                    <td>${this._escapeHtml(m.name)}</td>
                    <td>${this._escapeHtml(m.title || "-")}</td>
                    <td>${this._escapeHtml(m.userId || "-")}</td>
                    <td>${this._escapeHtml(m.email || "-")}</td>
                  </tr>
                `).join("")
                : `<tr><td colspan="4" style="color:var(--muted);">등록된 팀원이 없습니다.</td></tr>`
            }
          </tbody>
        </table>
      `;

      if (this._ui.manualEdit) {
    	  const btnEdit = document.getElementById("orgEditBtn");
          const btnDel  = document.getElementById("orgDeleteBtn");
      
      

      if (btnEdit) btnEdit.addEventListener("click", () => {
        this._openDeptModal("edit", {
          id: node.id,
          parentId: (this._findNode(node.id).parent || {}).id || "",
          name: node.name || "",
          code: node.code || "",
          manager: node.manager || "",
          note: node.note || "",
        });
      });

      if (btnDel) btnDel.addEventListener("click", () => {
        if (!confirm(`"${node.name}" 부서를 삭제하시겠습니까?`)) return;
        this.deleteDepartment(node.id);
      });
      }
      
    },

    /* ===== CRUD (가상 처리 + alert) ===== */
    addDepartment(data) {
      const parentId = data.parentId || "";
      const name = (data.name || "").trim();
      if (!name) return alert("조직명을 입력해 주세요.");

      const newNode = {
        id: `D${String(this._idSeq++).padStart(4, "0")}`,
        name,
        code: (data.code || "").trim(),
        manager: (data.manager || "").trim(),
        note: (data.note || "").trim(),
        members: [],
        children: [],
      };

      if (parentId) {
        const p = this._findNode(parentId).node;
        if (p) {
          p.children = p.children || [];
          p.children.push(newNode);
          this._ui.collapsed[parentId] = false; // 부모는 펼쳐서 바로 보이게
        } else {
          (this._orgData || []).push(newNode);
        }
      } else {
        (this._orgData || []).push(newNode);
      }

      this._saveOrgStructure();
      alert("새 부서가 추가되었습니다.");

      this._ui.selectedId = newNode.id;
      this._saveUiState();
      this._renderOrgTree();
      this._selectById(newNode.id, { scroll: true, silent: false });
    },

    editDepartment(id, data) {
      const found = this._findNode(id);
      const n = found.node;
      if (!n) return alert("대상을 찾을 수 없습니다.");

      const name = (data.name || "").trim();
      if (!name) return alert("조직명을 입력해 주세요.");

      // 상위 이동(가상)
      const targetParentId = (data.parentId != null) ? data.parentId : "";
      const currentParentId = (found.parent || {}).id || "";
      if (targetParentId !== currentParentId) {
        // 1) 기존 위치에서 제거
        if (found.parentArr && found.idx >= 0) found.parentArr.splice(found.idx, 1);

        // 2) 새 위치에 추가
        if (targetParentId) {
          const np = this._findNode(targetParentId).node;
          if (np) {
            np.children = np.children || [];
            np.children.push(n);
            this._ui.collapsed[targetParentId] = false;
          } else {
            (this._orgData || []).push(n);
          }
        } else {
          (this._orgData || []).push(n);
        }
      }

      n.name = name;
      n.code = (data.code || "").trim();
      n.manager = (data.manager || "").trim();
      n.note = (data.note || "").trim();

      this._saveOrgStructure();
      alert("부서 정보가 수정되었습니다.");

      this._ui.selectedId = id;
      this._saveUiState();
      this._renderOrgTree();
      this._selectById(id, { scroll: true, silent: false });
    },

    deleteDepartment(id) {
      const found = this._findNode(id);
      if (!found.node) return alert("대상을 찾을 수 없습니다.");

      if (found.parentArr && found.idx >= 0) found.parentArr.splice(found.idx, 1);
      else {
        const roots = this._orgData || [];
        const idx = roots.findIndex(x => x.id === id);
        if (idx >= 0) roots.splice(idx, 1);
      }

      if (this._ui.selectedId === id) this._ui.selectedId = null;

      this._saveOrgStructure();
      alert("부서가 삭제되었습니다.");

      this._saveUiState();
      this._renderOrgTree();
      this._renderDetail();
      this._selectFirstVisible();
    },

    /* ===== 모달 쉘 ===== */
    _ensureModalShell() {
      let bd = document.getElementById("orgDeptModalBackdrop");
      if (bd) return bd;

      bd = document.createElement("div");
      bd.id = "orgDeptModalBackdrop";
      bd.className = "org-modal-backdrop";
      bd.setAttribute("role", "dialog");
      bd.setAttribute("aria-modal", "true");

      // ✅ CSS가 누락/깨져도 동작하게 하는 최소 인라인 안전장치
      bd.style.display = "none";
      bd.style.position = "fixed";
      bd.style.inset = "0";
      bd.style.zIndex = "9999";
      bd.style.alignItems = "center";
      bd.style.justifyContent = "center";
      bd.style.background = "rgba(15,23,42,.45)";

      bd.innerHTML = `
        <div class="org-modal" role="document">
          <div class="org-modal-hd">
            <div class="org-modal-title" id="orgDeptModalTitle">
              <i class="fa-solid fa-building"></i> 부서
            </div>
            <button class="org-modal-close" id="orgDeptModalCloseBtn" aria-label="닫기">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <div class="org-modal-bd" id="orgDeptModalBody"></div>
          <div class="org-modal-ft">
            <button class="org-btn" id="orgDeptModalCancelBtn">취소</button>
            <button class="org-btn primary" id="orgDeptModalSaveBtn"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
          </div>
        </div>
      `;

      document.body.appendChild(bd);

      const close = () => {
        bd.classList.remove("show");
        bd.style.display = "none";
      };

      // backdrop 클릭 닫기
      bd.addEventListener("click", (e) => {
        if (e.target === bd) close();
      });

      const btnClose = bd.querySelector("#orgDeptModalCloseBtn");
      const btnCancel = bd.querySelector("#orgDeptModalCancelBtn");

      if (btnClose) btnClose.addEventListener("click", close);
      if (btnCancel) btnCancel.addEventListener("click", close);

      // ESC 닫기(한 번만)
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && bd.classList.contains("show")) close();
      });

      return bd;
    },
    _addDept(dto) {
    	  if (!dto?.name) return this.toast?.('부서명을 입력하세요.');

    	  // 예: 트리 데이터가 this.orgTree 라고 가정
    	  const root = this.orgTree;
    	  const parent = this.findDeptById(dto.parentId) || root;
    	  parent.children = parent.children || [];

    	  const newNode = {
    	    id: this.nextDeptId(),     // <- 없으면 너의 방식으로 생성
    	    name: dto.name,
    	    code: dto.code || '',
    	    children: []
    	  };

    	  parent.children.push(newNode);

    	  this.saveOrgTree?.();        // localStorage 등
    	  this.renderOrgTree?.();      // 화면 갱신
    	  this.closeModal?.();
    	  this.toast?.('저장되었습니다.');
    	},

    _openDeptModal(mode, data) {
        const bd = this._ensureModalShell();
        const titleEl = bd.querySelector("#orgDeptModalTitle");
        const bodyEl = bd.querySelector("#orgDeptModalBody");
        const saveBtn = bd.querySelector("#orgDeptModalSaveBtn");
        const cancelBtn = bd.querySelector("#orgDeptModalCancelBtn");

        const isEdit = mode === "edit";
        if (titleEl) titleEl.innerHTML = `<i class="fa-solid fa-building"></i> ${isEdit ? "부서 수정" : "부서 추가"}`;

        const opts = this._flattenNodes().map(n => {
          const pad = "&nbsp;".repeat(Math.min(8, n.depth * 2));
          const sel = (data.parentId && data.parentId === n.id) ? "selected" : "";
          return `<option value="${n.id}" ${sel}>${pad}${this._escapeHtml(n.name)} (${this._escapeHtml(n.code||"-")})</option>`;
        }).join("");

        bodyEl.innerHTML = `
          <div class="org-form">
            <div class="full">
              <div class="org-label">상위 부서</div>
              <select id="orgDeptParent" class="org-field export-input">
                <option value="">(최상위)</option>
                ${opts}
              </select>
            </div>
            <div>
              <div class="org-label">부서명</div>
              <input id="orgDeptName" class="org-field export-input" placeholder="예: 플랫폼개발팀" />
            </div>
            <div>
              <div class="org-label">부서코드</div>
              <input id="orgDeptCode" class="org-field export-input" placeholder="예: DEV-PLAT" />
            </div>
            <div class="full">
              <div class="org-label">담당자</div>
              <input id="orgDeptManager" class="org-field export-input" placeholder="예: 홍길동" />
            </div>
            <div class="full">
              <div class="org-label">설명/메모</div>
              <textarea id="orgDeptNote" class="org-textarea export-input" placeholder="필요시 메모를 입력하세요."></textarea>
            </div>
          </div>
        `;

        const parentEl = bodyEl.querySelector("#orgDeptParent");
        const nameEl = bodyEl.querySelector("#orgDeptName");
        const codeEl = bodyEl.querySelector("#orgDeptCode");
        const managerEl = bodyEl.querySelector("#orgDeptManager");
        const noteEl = bodyEl.querySelector("#orgDeptNote");

        if (nameEl) nameEl.value = data.name || "";
        if (codeEl) codeEl.value = data.code || "";
        if (managerEl) managerEl.value = data.manager || "";
        if (noteEl) noteEl.value = data.note || "";

        const close = () => { bd.classList.remove("show"); bd.style.display = "none"; };

        const onSave = () => {
          const payload = {
            parentId: (parentEl && parentEl.value) ? parentEl.value : "",
            name: (nameEl && nameEl.value || "").trim(),
            code: (codeEl && codeEl.value || "").trim(),
            manager: (managerEl && managerEl.value || "").trim(),
            note: (noteEl && noteEl.value || "").trim(),
          };

          if (!payload.name) { alert("부서명을 입력해 주세요."); if (nameEl) nameEl.focus(); return; }
          if (isEdit) this._updateDept(data.id, payload);
          else this._addDept(payload);

          close();
          this._renderOrgTree();
          this._renderDetail();
        };

        if (saveBtn) saveBtn.onclick = onSave;
        if (cancelBtn) cancelBtn.onclick = close;

        // ✅ 모달 표시(오버레이 위로 올리기)
        bd.style.display = "flex";
        bd.classList.add("show");
        setTimeout(() => { if (nameEl) nameEl.focus(); }, 0);
      },


    /* ===== 기본 하드코딩 데이터 ===== */
    loadOrgStructure() {
      return [
        {
          id: "D0001",
          name: "플랫폼본부",
          code: "PLAT",
          manager: "김영수",
          note: "플랫폼/공통 서비스 운영",
          members: [
            { name: "김영수", title: "본부장", userId: "u1000", email: "yskim@example.com" },
            { name: "서지연", title: "책임", userId: "u1002", email: "jyseo@example.com" },
          ],
          children: [
            {
              id: "D0002",
              name: "개발1팀",
              code: "DEV-01",
              manager: "홍길동",
              note: "코어 API, 배치",
              members: [
                { name: "홍길동", title: "팀장", userId: "u1101", email: "gdhong@example.com" },
                { name: "이수민", title: "선임", userId: "u1102", email: "smlee@example.com" },
                { name: "박지훈", title: "사원", userId: "u1103", email: "jhpark@example.com" },
              ],
              children: [
                {
                  id: "D0003",
                  name: "백엔드파트",
                  code: "BE",
                  manager: "이수민",
                  note: "Spring/DB 연동",
                  members: [
                    { name: "이수민", title: "선임", userId: "u1102", email: "smlee@example.com" },
                    { name: "최나래", title: "사원", userId: "u1104", email: "nrchoi@example.com" },
                  ],
                  children: [],
                },
                {
                  id: "D0004",
                  name: "프론트파트",
                  code: "FE",
                  manager: "박지훈",
                  note: "관리 콘솔 UI",
                  members: [
                    { name: "박지훈", title: "사원", userId: "u1103", email: "jhpark@example.com" },
                    { name: "정하늘", title: "사원", userId: "u1105", email: "hnjung@example.com" },
                  ],
                  children: [],
                },
              ],
            },
            {
              id: "D0005",
              name: "운영팀",
              code: "OPS",
              manager: "강민지",
              note: "운영 배포/장애 대응",
              members: [
                { name: "강민지", title: "팀장", userId: "u1201", email: "mjkang@example.com" },
                { name: "오태훈", title: "책임", userId: "u1202", email: "thoh@example.com" },
              ],
              children: [],
            },
          ],
        },
        {
          id: "D0006",
          name: "보안감사실",
          code: "SEC",
          manager: "한지수",
          note: "정책/감사/로그 모니터링",
          members: [
            { name: "한지수", title: "실장", userId: "u2001", email: "jshan@example.com" },
            { name: "임도윤", title: "책임", userId: "u2002", email: "dyim@example.com" },
          ],
          children: [],
        },
      ];
    },
  };

  // 전역 노출(기존 코드 호환 포함)
  W.orgChartAdmin = orgChartAdmin;
  W.adminOrgDemo = orgChartAdmin; // 기존 이름을 참조하는 코드가 있어도 깨지지 않게

  // 요구한 가상 처리 함수도 전역에서 바로 호출 가능하게 노출
  W.addDepartment = (data) => orgChartAdmin.addDepartment(data);
  W.editDepartment = (id, data) => orgChartAdmin.editDepartment(id, data);
  W.deleteDepartment = (id) => orgChartAdmin.deleteDepartment(id);

  patchAdminRouterIfNeeded();
})();


/* =========================================================
 * [A11Y PATCH] adminOverlay aria-hidden 경고 해결
 * - 닫기 전 포커스를 오버레이 밖으로 이동
 * - 닫힌 상태에서 inert 적용(포커스/클릭 차단)
 * - 열기 시 포커스는 오버레이 내부(닫기 버튼)로 이동
 * ========================================================= */
(() => {
  const admin = window.admin;
  const ov = document.getElementById("adminOverlay");
  if (!admin || !ov) return;

  if (admin.__a11yAdminOverlayPatched) return;
  admin.__a11yAdminOverlayPatched = true;

  // 원본 보관
  admin.__openOrig = admin.__openOrig || admin.open?.bind(admin);
  admin.__closeOrig = admin.__closeOrig || admin.close?.bind(admin);

  function setInert(el, on) {
    try {
      // 표준 inert 지원 브라우저(크롬 등)
      if ("inert" in el) {
        el.inert = !!on;
        return;
      }
      // fallback: 포인터 차단 + tabindex 제거
      el.style.pointerEvents = on ? "none" : "";
      const nodes = el.querySelectorAll('a,button,input,select,textarea,[tabindex]');
      nodes.forEach(n => {
        if (on) {
          if (!n.hasAttribute("data-prev-tabindex")) {
            n.setAttribute("data-prev-tabindex", n.getAttribute("tabindex") ?? "");
          }
          n.setAttribute("tabindex", "-1");
        } else {
          const prev = n.getAttribute("data-prev-tabindex");
          if (prev === "") n.removeAttribute("tabindex");
          else if (prev != null) n.setAttribute("tabindex", prev);
          n.removeAttribute("data-prev-tabindex");
        }
      });
    } catch (e) {}
  }

  function focusFirstInOverlay() {
    const target =
      ov.querySelector(".admin-close") ||
      ov.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (target && typeof target.focus === "function") {
      target.focus({ preventScroll: true });
    }
  }

  function ensureFocusSink() {
	  let sink = document.getElementById("adminFocusSink");
	  if (sink) return sink;

	  sink = document.createElement("button");
	  sink.id = "adminFocusSink";
	  sink.type = "button";
	  sink.tabIndex = -1;
	  sink.style.position = "fixed";
	  sink.style.left = "-9999px";
	  sink.style.top = "0";
	  sink.style.width = "1px";
	  sink.style.height = "1px";
	  sink.style.opacity = "0";
	  sink.style.pointerEvents = "none";
	  sink.textContent = "focus-sink";
	  document.body.appendChild(sink);
	  return sink;
	}


  function focusOutOfOverlay() {
	  // body가 focus될 수 있게 보장(크롬 기본은 focus 불가)
	  try { if (document.body && document.body.tabIndex == null) document.body.tabIndex = -1; } catch(e){}

	  const ret = admin.__returnFocusEl;
	  if (ret && document.contains(ret) && typeof ret.focus === "function") {
	    try { ret.focus({ preventScroll: true }); return; } catch (e) {}
	  }

	  // 열기 트리거로 최대한 복귀
	  const fallback =
	    document.querySelector('a[onclick*="admin.open"]') ||
	    document.querySelector('button[onclick*="admin.open"]');

	  if (fallback && typeof fallback.focus === "function") {
	    try { fallback.focus({ preventScroll: true }); return; } catch (e) {}
	  }

	  // 확실한 최종 fallback: 포커스 싱크
	  try {
	    ensureFocusSink().focus({ preventScroll: true });
	    return;
	  } catch(e){}

	  // 최후의 최후
	  try { document.body.focus({ preventScroll: true }); } catch(e){}
	}


  // OPEN 패치: 열기 직전 포커스 저장 + inert 해제 + 포커스 이동
  admin.open = function (section) {
    admin.__returnFocusEl = document.activeElement;

    admin.__openOrig?.(section);

    ov.setAttribute("aria-hidden", "false");
    setInert(ov, false);

    requestAnimationFrame(() => focusFirstInOverlay());
  };

  // CLOSE 패치: aria-hidden 적용 전에 포커스 먼저 빼기 + inert 적용
admin.close = function () {
  // 1) 오버레이 내부에 포커스가 남아있으면 밖으로 이동
  if (ov.contains(document.activeElement)) {
    focusOutOfOverlay();
  }

  // 2) 그래도 내부에 남아있다면(브라우저/상황에 따라) 강제 처리
  if (ov.contains(document.activeElement)) {
    try { document.activeElement.blur(); } catch(e){}
    try { ensureFocusSink().focus({ preventScroll: true }); } catch(e){}
  }

  // 3) 원래 close 실행(여기서 aria-hidden true가 걸림)
  admin.__closeOrig?.();

  // 4) 닫힌 상태 inert 적용
  ov.setAttribute("aria-hidden", "true");
  setInert(ov, true);
};


  // 초기 상태도 반영
  setInert(ov, ov.getAttribute("aria-hidden") === "true");
})();


/// const adminOrgDemo   end/////

///조직도 관리 end/////////////////////////

/* ---------------- RBAC/SoD/AuthZ (IAM 핵심) ---------------- */
 
// [PATCH] Global toast alias (여러 모듈에서 toast()를 직접 호출하므로 전역으로 보장)
function toast(msg){
  try{
    if (typeof window.dbamToast === 'function') return window.dbamToast(msg);
    if (typeof window.showToast === 'function') return window.showToast(msg);
  }catch(_){}
  alert(String(msg || ''));
}

window.DBAM_USER_ROLE_MAP = window.DBAM_USER_ROLE_MAP || {
  u1001: ['ROLE_SEC_ANALYST'],
  u1002: ['ROLE_DBA_OPERATOR'],
  u1004: ['ROLE_DEV_READONLY'],
  u1006: ['ROLE_AUDITOR'],
};

window.DBAM_PERMS = window.DBAM_PERMS || {
	  IAM_USER_VIEW: 'IAM_USER_VIEW',
	  IAM_USER_ROLE_EDIT: 'IAM_USER_ROLE_EDIT',
	  IAM_ROLE_VIEW: 'IAM_ROLE_VIEW',
	  IAM_ROLE_PERM_EDIT: 'IAM_ROLE_PERM_EDIT',

	  AUDIT_LOG_VIEW: 'AUDIT_LOG_VIEW',
	  AUDIT_LOG_EXPORT: 'AUDIT_LOG_EXPORT',
	  AUDIT_LOG_DELETE: 'AUDIT_LOG_DELETE',
	};

	(function(){
		  const P = window.DBAM_PERMS;
		  window.DBAM_ROLE_PERMS = window.DBAM_ROLE_PERMS || {
		    ROLE_DBAM_USER:      [P.IAM_USER_VIEW],
		    ROLE_DEV_READONLY:   [P.IAM_USER_VIEW],

		    // ✅ 운영자가 사용자/역할 매핑을 손댈 수 있다면
		    ROLE_DBA_OPERATOR:   [P.IAM_USER_VIEW, P.IAM_USER_ROLE_EDIT, P.IAM_ROLE_VIEW],

		    // ✅ 역할(권한) 관리 화면 "조회"는 보안/감사자가 보통 필요
		    ROLE_SEC_ANALYST:    [P.AUDIT_LOG_VIEW, P.AUDIT_LOG_EXPORT, P.IAM_ROLE_VIEW],
		    ROLE_AUDITOR:        [P.AUDIT_LOG_VIEW, P.AUDIT_LOG_EXPORT, P.IAM_ROLE_VIEW],

		    ROLE_REPORT_VIEWER:  [P.AUDIT_LOG_VIEW],
		  };
		})();


	window.DBAM_AUTHZ = window.DBAM_AUTHZ || {
		  currentUserId(){ return window.DBAM_CURRENT_USER || 'u1002'; },

		  rolesOf(userId){
		    const uid = userId || this.currentUserId();
		    return (window.DBAM_USER_ROLE_MAP && window.DBAM_USER_ROLE_MAP[uid]) || ['ROLE_DBAM_USER'];
		  },

		  hasPerm(perm, userId){
		    const roles = this.rolesOf(userId);
		    for (const r of roles){
		      const ps = (window.DBAM_ROLE_PERMS && window.DBAM_ROLE_PERMS[r]) || [];
		      if (ps.includes(perm)) return true;
		    }
		    return false;
		  },

		  requirePerm(perm, ctx){
		    if (!this.hasPerm(perm)){
		      throw new Error(`권한이 없습니다: ${perm}` + (ctx ? ` (${ctx})` : ''));
		    }
		  }
		};

		window.DBAM_SOD_CONFLICTS = window.DBAM_SOD_CONFLICTS || [
			  ['ROLE_DEV_READONLY', 'ROLE_AUDITOR'],
			  ['ROLE_DBA_OPERATOR', 'ROLE_AUDITOR'],
			];

			window.validateSoD = window.validateSoD || function(nextRoles){
			  const roles = Array.isArray(nextRoles) ? nextRoles : [];
			  for (const pair of (window.DBAM_SOD_CONFLICTS || [])){
			    const a = pair[0], b = pair[1];
			    if (roles.includes(a) && roles.includes(b)){
			      return `SoD 위반: ${a} 와 ${b} 는 동시에 부여할 수 없습니다.`;
			    }
			  }
			  return null;
			};

			
/* ---------------- Admin: 사용자 관리 (조직·사용자·역할 > 사용자 관리) ---------------- */

const userAdmin = {
  // 하드코딩 사용자 목록 (간단 샘플)
  sampleUsers: [
    {
      id: 'u1001',
      empNo: '2023001',
      name: '홍길동',
      dept: '정보보안실',
      team: 'DB보안팀',
      title: '대리',
      profile: 'SEC',
      status: 'ACTIVE',     // ACTIVE | LOCKED | DISABLED
      mfa: 'ON',            // ON | OFF
      lastLogin: '2025-12-10 09:12',
      lastLoginIp: '10.10.1.15',
      failCount: 0,
      createdAt: '2023-01-02'
    },
    {
      id: 'u1002',
      empNo: '2019012',
      name: '김감사',
      dept: '정보보안실',
      team: '감사팀',
      title: '과장',
      profile: 'AUDITOR',
      status: 'ACTIVE',
      mfa: 'ON',
      lastLogin: '2025-12-11 08:55',
      lastLoginIp: '10.10.5.21',
      failCount: 1,
      createdAt: '2019-06-10'
    },
    {
      id: 'u1003',
      empNo: '2017021',
      name: '박운영',
      dept: 'IT운영센터',
      team: 'DBA팀',
      title: '차장',
      profile: 'DBA',
      status: 'ACTIVE',
      mfa: 'OFF',
      lastLogin: '2025-12-09 22:01',
      lastLoginIp: '10.20.1.7',
      failCount: 0,
      createdAt: '2017-03-15'
    },
    {
      id: 'u1004',
      empNo: '2021010',
      name: '이개발',
      dept: '디지털개발센터',
      team: '뱅킹개발1팀',
      title: '대리',
      profile: 'DEV',
      status: 'ACTIVE',
      mfa: 'ON',
      lastLogin: '2025-12-11 10:12',
      lastLoginIp: '10.30.2.33',
      failCount: 2,
      createdAt: '2021-10-01'
    },
    {
      id: 'u1005',
      empNo: '2015023',
      name: '장트레이딩',
      dept: 'IB사업부',
      team: '트레이딩팀',
      title: '부장',
      profile: 'TRADER',
      status: 'DISABLED',
      mfa: 'OFF',
      lastLogin: '2024-01-03 14:20',
      lastLoginIp: '10.40.3.11',
      failCount: 0,
      createdAt: '2015-04-02'
    },
    {
      id: 'u1006',
      empNo: '2020005',
      name: '최휴면',
      dept: '정보보안실',
      team: 'DB보안팀',
      title: '과장',
      profile: 'SEC',
      status: 'LOCKED',
      mfa: 'ON',
      lastLogin: '2025-12-08 22:13',
      lastLoginIp: '10.10.2.45',
      failCount: 7,
      createdAt: '2020-02-20'
    },
    {
      id: 'u1007',
      empNo: '2024010',
      name: '오계정',
      dept: '디지털개발센터',
      team: '플랫폼개발팀',
      title: '사원',
      profile: 'DEV',
      status: 'ACTIVE',
      mfa: 'ON',
      lastLogin: '2025-12-11 10:03',
      lastLoginIp: '10.30.9.17',
      failCount: 0,
      createdAt: '2024-03-01'
    },
    {
      id: 'u1008',
      empNo: '2018019',
      name: '윤감사',
      dept: '정보보안실',
      team: '감사팀',
      title: '차장',
      profile: 'AUDITOR',
      status: 'ACTIVE',
      mfa: 'OFF',
      lastLogin: '2025-12-10 16:40',
      lastLoginIp: '10.10.6.9',
      failCount: 3,
      createdAt: '2018-09-10'
    }
  ],

  // 외부에서 부를 엔트리 포인트
  open(){
		  try{
			  window.DBAM_AUTHZ.requirePerm(window.DBAM_PERMS.IAM_USER_VIEW, 'open: 사용자 관리');
			}catch(e){
			  toast(e.message);
			  return;
			}
			
    const ov = document.getElementById('adminOverlay');
    if(!ov) return;

    // 오버레이 열기
    ov.classList.add('show');
    ov.setAttribute('aria-hidden','false');

    // 좌측 네비 활성화 동기화 (orgUser 섹션 기준)
    try{
      const buttons = document.querySelectorAll('.admin-nav button');
      buttons.forEach(btn=>{
        if(btn.dataset.section === 'orgUser'){
          btn.classList.add('active');
        }else{
          btn.classList.remove('active');
        }
      });
    }catch(err){
      console.warn('userAdmin.open nav sync error', err);
    }

    this.render();
  },

  render(){
    const titleEl = document.getElementById('adminTitle');
    const descEl  = document.getElementById('adminDesc');
    const bodyEl  = document.getElementById('adminBody');
    if(!titleEl || !descEl || !bodyEl) return;

    // 제목/설명
    titleEl.innerHTML = '<i class="fa-solid fa-user-gear"></i> 사용자 관리';
    descEl.textContent = '로그인 계정 기준으로 상태 · MFA · 프로필을 한눈에 보는 사용자 관리 화면입니다. (정적 데이터, 화면 흐름만 구현)';

    // 레이아웃 구성 (필터 + 요약 + 테이블)
    bodyEl.innerHTML =
      '<div id="userAdminLayout" style="display:grid;grid-template-columns:260px minmax(0,1fr);gap:12px;align-items:flex-start;">' +
        '<div>' +
          // 필터 카드
          '<div class="admin-card" id="userAdminFilterCard">' +
            '<h4><i class="fa-solid fa-filter"></i> 필터</h4>' +
            '<div style="display:flex;flex-direction:column;gap:6px;margin-top:6px;font-size:12px;">' +
              '<label>검색 (이름/ID/사번)' +
                '<input id="userAdminSearch" type="text" placeholder="예: 홍길동, u1001, 2023001" ' +
                  'style="margin-top:2px;width:100%;box-sizing:border-box;padding:4px 6px;font-size:12px;border:1px solid #e5e7eb;border-radius:4px;" />' +
              '</label>' +

              '<label>조직' +
                '<select id="userAdminDept" ' +
                  'style="margin-top:2px;width:100%;box-sizing:border-box;padding:4px 6px;font-size:12px;border:1px solid #e5e7eb;border-radius:4px;">' +
                  '<option value="">전체</option>' +
                '</select>' +
              '</label>' +

              '<label>상태' +
                '<select id="userAdminStatus" ' +
                  'style="margin-top:2px;width:100%;box-sizing:border-box;padding:4px 6px;font-size:12px;border:1px solid #e5e7eb;border-radius:4px;">' +
                  '<option value="">전체</option>' +
                  '<option value="ACTIVE">활성</option>' +
                  '<option value="LOCKED">잠금</option>' +
                  '<option value="DISABLED">비활성</option>' +
                '</select>' +
              '</label>' +

              '<label>MFA' +
                '<select id="userAdminMfa" ' +
                  'style="margin-top:2px;width:100%;box-sizing:border-box;padding:4px 6px;font-size:12px;border:1px solid #e5e7eb;border-radius:4px;">' +
                  '<option value="">전체</option>' +
                  '<option value="ON">사용</option>' +
                  '<option value="OFF">미사용</option>' +
                '</select>' +
              '</label>' +

              '<button type="button" id="userAdminReset" ' +
                'style="margin-top:2px;align-self:flex-start;padding:4px 10px;font-size:12px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb;cursor:pointer;">' +
                '<i class="fa-solid fa-rotate"></i> 필터 초기화' +
              '</button>' +
            '</div>' +
          '</div>' +

          // 요약 카드
          '<div class="admin-card" id="userAdminSummaryCard" style="margin-top:10px;">' +
            '<h4><i class="fa-solid fa-circle-info"></i> 요약</h4>' +
            '<div id="userAdminSummaryBody" style="margin-top:6px;font-size:12px;"></div>' +
          '</div>' +
        '</div>' +

        '<div>' +
          '<div class="admin-card" id="userAdminTableCard">' +
            '<h4><i class="fa-solid fa-users"></i> 사용자 목록</h4>' +
            '<div style="margin-top:6px;max-height:420px;overflow:auto;border-top:1px solid #e5e7eb;">' +
              '<table id="userAdminTable" style="width:100%;border-collapse:collapse;font-size:12px;">' +
                '<thead>' +
                  '<tr>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">이름 / ID</th>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">조직</th>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">프로필</th>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">상태</th>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">MFA</th>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">최근 로그인</th>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">실패/잠금</th>' +
                  '</tr>' +
                '</thead>' +
                '<tbody></tbody>' +
              '</table>' +
            '</div>' +
            '<div class="admin-footer" style="margin-top:6px;">' +
              '※ 계정 생성/잠금 해제 등의 액션은 서버 연동 단계에서 추가하는 전제입니다.' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';

    this._populateDeptOptions();
    this._bindFilterEvents();
    this._applyFilter();
  },

  _populateDeptOptions(){
    const sel = document.getElementById('userAdminDept');
    if(!sel) return;
    const set = new Set();
    this.sampleUsers.forEach(u=>{
      if(u.dept){ set.add(u.dept); }
    });
    const depts = Array.from(set).sort();
    depts.forEach(d=>{
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      sel.appendChild(opt);
    });
  },

  _bindFilterEvents(){
    const searchInput = document.getElementById('userAdminSearch');
    const deptSel    = document.getElementById('userAdminDept');
    const statusSel  = document.getElementById('userAdminStatus');
    const mfaSel     = document.getElementById('userAdminMfa');
    const resetBtn   = document.getElementById('userAdminReset');
    const self = this;

    if(searchInput && !searchInput._bound){
      searchInput.addEventListener('input', function(){ self._applyFilter(); });
      searchInput._bound = true;
    }
    [deptSel, statusSel, mfaSel].forEach(el=>{
      if(el && !el._bound){
        el.addEventListener('change', function(){ self._applyFilter(); });
        el._bound = true;
      }
    });
    if(resetBtn && !resetBtn._bound){
      resetBtn.addEventListener('click', function(){
        if(searchInput) searchInput.value = '';
        if(deptSel)    deptSel.value = '';
        if(statusSel)  statusSel.value = '';
        if(mfaSel)     mfaSel.value = '';
        self._applyFilter();
      });
      resetBtn._bound = true;
    }
  },

  _applyFilter(){
    const searchInput = document.getElementById('userAdminSearch');
    const deptSel    = document.getElementById('userAdminDept');
    const statusSel  = document.getElementById('userAdminStatus');
    const mfaSel     = document.getElementById('userAdminMfa');

    const kw     = (searchInput && searchInput.value || '').trim().toLowerCase();
    const dept   = deptSel ? (deptSel.value || '') : '';
    const status = statusSel ? (statusSel.value || '') : '';
    const mfa    = mfaSel ? (mfaSel.value || '') : '';

    const filtered = this.sampleUsers.filter(u=>{
      if(dept && u.dept !== dept) return false;
      if(status && u.status !== status) return false;
      if(mfa && u.mfa !== mfa) return false;
      if(!kw) return true;

      const base = [
        u.name || '',
        u.id || '',
        u.empNo || '',
        u.dept || '',
        u.team || '',
        u.title || '',
        u.profile || ''
      ].join(' ').toLowerCase();

      return base.indexOf(kw) >= 0;
    });

    this._renderTable(filtered);
    this._renderSummary(filtered);
  },

  _renderTable(list){
    const tbody = document.querySelector('#userAdminTable tbody');
    if(!tbody) return;
    tbody.innerHTML = '';

    list.forEach(u=>{
      const tr = document.createElement('tr');
      tr.style.borderBottom = '1px solid #f3f4f6';

      // 이름 / ID
      const tdName = document.createElement('td');
      tdName.style.padding = '4px 6px';
      tdName.style.whiteSpace = 'nowrap';
      tdName.innerHTML =
        '<div style="font-weight:600;">' + (u.name || '') + '</div>' +
        '<div style="font-size:11px;color:#6b7280;">' +
          (u.id || '') +
          (u.empNo ? ' · ' + u.empNo : '') +
        '</div>';
      tr.appendChild(tdName);

      // 조직
      const tdOrg = document.createElement('td');
      tdOrg.style.padding = '4px 6px';
      tdOrg.style.whiteSpace = 'nowrap';
      tdOrg.innerHTML =
        '<div>' + (u.dept || '') + '</div>' +
        '<div style="font-size:11px;color:#6b7280;">' + (u.team || '') + '</div>';
      tr.appendChild(tdOrg);

      // 프로필
      const tdProf = document.createElement('td');
      tdProf.style.padding = '4px 6px';
      tdProf.style.whiteSpace = 'nowrap';
      tdProf.innerHTML =
        '<span style="display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid #e5e7eb;font-size:11px;">' +
        (u.profile || '') +
        '</span>' +
        (u.title ? '<span style="margin-left:4px;font-size:11px;color:#6b7280;">' + u.title + '</span>' : '');
      tr.appendChild(tdProf);

      // 상태
      const tdStatus = document.createElement('td');
      tdStatus.style.padding = '4px 6px';
      tdStatus.style.whiteSpace = 'nowrap';
      const st = u.status || 'ACTIVE';
      let stLabel = '활성';
      let stColor = '#16a34a';
      let stBg    = '#dcfce7';
      if(st === 'LOCKED'){
        stLabel = '잠금';
        stColor = '#b91c1c';
        stBg    = '#fee2e2';
      }else if(st === 'DISABLED'){
        stLabel = '비활성';
        stColor = '#6b7280';
        stBg    = '#e5e7eb';
      }
      tdStatus.innerHTML =
        '<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:999px;font-size:11px;background:' + stBg + ';color:' + stColor + ';">' +
          '<span style="width:6px;height:6px;border-radius:999px;background:' + stColor + ';"></span>' +
          stLabel +
        '</span>';
      tr.appendChild(tdStatus);

      // MFA
      const tdMfa = document.createElement('td');
      tdMfa.style.padding = '4px 6px';
      tdMfa.style.whiteSpace = 'nowrap';
      const mfaOn = (u.mfa === 'ON');
      tdMfa.innerHTML =
        '<span style="font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid ' + (mfaOn ? '#22c55e' : '#e5e7eb') + ';' +
        'background:' + (mfaOn ? '#dcfce7' : '#f9fafb') + ';color:' + (mfaOn ? '#166534' : '#6b7280') + ';">' +
        (mfaOn ? '<i class="fa-solid fa-shield-halved"></i> 사용' : '미사용') +
        '</span>';
      tr.appendChild(tdMfa);

      // 최근 로그인
      const tdLogin = document.createElement('td');
      tdLogin.style.padding = '4px 6px';
      tdLogin.style.whiteSpace = 'nowrap';
      tdLogin.innerHTML =
        '<div>' + (u.lastLogin || '-') + '</div>' +
        '<div style="font-size:11px;color:#6b7280;">' + (u.lastLoginIp || '') + '</div>';
      tr.appendChild(tdLogin);

      // 실패/잠금
      const tdFail = document.createElement('td');
      tdFail.style.padding = '4px 6px';
      tdFail.style.whiteSpace = 'nowrap';
      tdFail.innerHTML =
        '<div>실패 ' + (u.failCount || 0) + '회</div>' +
        (u.status === 'LOCKED'
          ? '<div style="font-size:11px;color:#b91c1c;">잠금 계정</div>'
          : '');
      tr.appendChild(tdFail);

      tbody.appendChild(tr);
    });
  },

  _renderSummary(list){
    const box = document.getElementById('userAdminSummaryBody');
    if(!box) return;

    const all      = this.sampleUsers.length;
    const current  = list.length;
    const active   = list.filter(u=>u.status === 'ACTIVE').length;
    const locked   = list.filter(u=>u.status === 'LOCKED').length;
    const disabled = list.filter(u=>u.status === 'DISABLED').length;
    const mfaOn    = list.filter(u=>u.mfa === 'ON').length;
    const mfaOff   = list.filter(u=>u.mfa === 'OFF').length;

    box.innerHTML =
      '<div style="display:flex;flex-direction:column;gap:4px;">' +
        '<div style="font-size:11px;color:#6b7280;">현재 필터 결과 기준 요약</div>' +
        '<div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:4px;">' +
          '<div style="padding:4px 6px;border-radius:6px;background:#f9fafb;border:1px solid #e5e7eb;">' +
            '<div style="font-size:11px;color:#6b7280;">전체 계정(정의)</div>' +
            '<div style="margin-top:2px;font-size:13px;font-weight:600;">' + all + '명</div>' +
          '</div>' +
          '<div style="padding:4px 6px;border-radius:6px;background:#f9fafb;border:1px solid #e5e7eb;">' +
            '<div style="font-size:11px;color:#6b7280;">필터 후 계정</div>' +
            '<div style="margin-top:2px;font-size:13px;font-weight:600;">' + current + '명</div>' +
          '</div>' +
          '<div style="padding:4px 6px;border-radius:6px;background:#ecfdf3;border:1px solid #bbf7d0;">' +
            '<div style="font-size:11px;color:#16a34a;">활성</div>' +
            '<div style="margin-top:2px;font-size:13px;font-weight:600;">' + active + '명</div>' +
          '</div>' +
          '<div style="padding:4px 6px;border-radius:6px;background:#fef2f2;border:1px solid #fecaca;">' +
            '<div style="font-size:11px;color:#b91c1c;">잠금/비활성</div>' +
            '<div style="margin-top:2px;font-size:13px;font-weight:600;">' + (locked + disabled) + '명</div>' +
          '</div>' +
          '<div style="padding:4px 6px;border-radius:6px;background:#eff6ff;border:1px solid #bfdbfe;">' +
            '<div style="font-size:11px;color:#1d4ed8;">MFA 사용</div>' +
            '<div style="margin-top:2px;font-size:13px;font-weight:600;">' + mfaOn + '명</div>' +
          '</div>' +
          '<div style="padding:4px 6px;border-radius:6px;background:#f9fafb;border:1px solid #e5e7eb;">' +
            '<div style="font-size:11px;color:#6b7280;">MFA 미사용</div>' +
            '<div style="margin-top:2px;font-size:13px;font-weight:600;">' + mfaOff + '명</div>' +
          '</div>' +
        '</div>' +
      '</div>';
  }
};

// 전역 노출 (inline onclick 등에서 사용 가능)
window.userAdmin = userAdmin;
window.DBAM_USER_SAMPLE = userAdmin.sampleUsers;
///사용자 관리 end////////////////////////
/* ---------------- Admin: 역할(권한) 관리 ---------------- */

const roleAdmin = {
  selectedRoleId: null,

  sampleRoles: [
    {
      id: 'ROLE_DBAM_USER',
      code: 'DBAM_USER',
      name: '일반 사용자',
      category: '기본',
      risk: 'LOW',
      envScope: ['DEV', 'QA'],
      menuScopes: [
        'SQL 실행 (개발/테스트 DB)',
        '쿼리 실행 이력 조회 (본인)',
        '승인 요청 현황 조회 (본인)'
      ],
      dataScope: '개발·테스트 환경의 업무 DB에 한해 읽기 중심 쿼리 허용',
      mfaRequired: true,
      defaultAssigned: true,
      recommendedFor: '일반 개발자/운영자 기본 권한',
      assignedUsers: 42
    },
    {
      id: 'ROLE_DBAM_APPROVER',
      code: 'DBAM_APPROVER',
      name: '승인자',
      category: '기본',
      risk: 'MEDIUM',
      envScope: ['DEV', 'QA', 'PROD'],
      menuScopes: [
        '권한 신청 승인/반려',
        '응급/임시 권한 승인',
        '정기 권한 검토 결과 제출'
      ],
      dataScope: '타 사용자의 DB 권한 요청에 대한 승인/반려 권한',
      mfaRequired: true,
      defaultAssigned: false,
      recommendedFor: '부서장, 시스템 담당자',
      assignedUsers: 15
    },
    {
      id: 'ROLE_DBA_OPERATOR',
      code: 'DBA_OPERATOR',
      name: 'DB 운영자',
      category: '운영',
      risk: 'HIGH',
      envScope: ['DEV', 'QA', 'PROD'],
      menuScopes: [
        'DB 연결/SQL 실행 (운영 포함)',
        '세션 모니터링/강제 종료',
        'DB 파라미터/리소스 상태 조회',
        'DDL/권한 확인'
      ],
      dataScope: '운영/개발/테스트 DB 전반, 계정·권한·리소스 조회 및 일부 변경',
      mfaRequired: true,
      defaultAssigned: false,
      recommendedFor: 'DBA 전담 인력',
      assignedUsers: 6
    },
    {
      id: 'ROLE_SEC_ANALYST',
      code: 'SEC_ANALYST',
      name: '보안 분석 담당',
      category: '보안/감사',
      risk: 'MEDIUM',
      envScope: ['DEV', 'QA', 'PROD'],
      menuScopes: [
        'DB 접속/SQL 로그 조회',
        '이상행위 룰 조회',
        '정책 변경 이력 조회'
      ],
      dataScope: '로그/정책 정보 중심, 실제 데이터 조회 권한은 제한',
      mfaRequired: true,
      defaultAssigned: false,
      recommendedFor: '정보보호/보안 관제 인력',
      assignedUsers: 5
    },
    {
      id: 'ROLE_AUDITOR',
      code: 'AUDITOR',
      name: '감사 전용',
      category: '보안/감사',
      risk: 'MEDIUM',
      envScope: ['PROD'],
      menuScopes: [
        '감사 전용 로그 조회',
        '사용자·DB·기간별 상세 검색',
        '다운로드/리포트 출력'
      ],
      dataScope: '운영 환경의 감사 로그/리포트 전용, 실제 데이터 조회는 원칙적으로 차단',
      mfaRequired: true,
      defaultAssigned: false,
      recommendedFor: '내부 감사/외부 감사 계정',
      assignedUsers: 3
    },
    {
      id: 'ROLE_DEV_READONLY',
      code: 'DEV_READONLY',
      name: '개발자 읽기 전용',
      category: '운영',
      risk: 'LOW',
      envScope: ['DEV', 'QA'],
      menuScopes: [
        '스키마/테이블 구조 조회',
        '메타데이터 조회',
        '일부 조회 쿼리 실행'
      ],
      dataScope: '개발/테스트 환경 DB의 스키마·메타데이터 중심 조회',
      mfaRequired: false,
      defaultAssigned: false,
      recommendedFor: 'DB 구조만 참고하는 일반 개발자',
      assignedUsers: 20
    },
    {
      id: 'ROLE_EMERGENCY_DBA',
      code: 'EMERGENCY_DBA',
      name: '응급 DB 권한',
      category: '응급',
      risk: 'HIGH',
      envScope: ['PROD'],
      menuScopes: [
        '장애 시 한시적 고권한 부여',
        '응급 세션 모니터링',
        '응급 권한 사용 이력 조회'
      ],
      dataScope: '운영 DB의 장애 복구 목적 한시적 고권한 (기간·범위 제한 필수)',
      mfaRequired: true,
      defaultAssigned: false,
      recommendedFor: '승인 받은 장애 대응 담당자',
      assignedUsers: 2
    },
    {
      id: 'ROLE_REPORT_VIEWER',
      code: 'REPORT_VIEWER',
      name: '리포트 전용',
      category: '리포트',
      risk: 'LOW',
      envScope: ['DEV', 'QA', 'PROD'],
      menuScopes: [
        '정기 점검 리포트 조회',
        '대시보드 조회',
        'PDF/엑셀 다운로드'
      ],
      dataScope: '집계/통계 기반 리포트 뷰, 원본 데이터 직접 조회는 불가',
      mfaRequired: false,
      defaultAssigned: false,
      recommendedFor: '부서장, 경영진 요약 리포트용 계정',
      assignedUsers: 12
    }
  ],

  open(){
	  
	  try{
		  window.DBAM_AUTHZ.requirePerm(window.DBAM_PERMS.IAM_ROLE_VIEW, 'open: 역할(권한) 관리');
		}catch(e){
		  toast(e.message);
		  return;
		}

		
    const ov = document.getElementById('adminOverlay');
    if (!ov) return;

    ov.classList.add('show');
    ov.setAttribute('aria-hidden', 'false');

    // 좌측 네비 활성화: orgUser 섹션
    const buttons = document.querySelectorAll('.admin-nav button');
    buttons.forEach(btn => {
      if (btn.dataset.section === 'orgUser') {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });

    this.render();
  },

  render(){
    const titleEl = document.getElementById('adminTitle');
    const descEl  = document.getElementById('adminDesc');
    const bodyEl  = document.getElementById('adminBody');
    if (!titleEl || !descEl || !bodyEl) return;

    titleEl.innerHTML = '<i class="fa-solid fa-id-badge"></i> 역할(권한) 관리';
    descEl.textContent = '역할 코드와 위험도·환경·메뉴 권한을 정의하고, 역할 구성을 한눈에 파악하는 화면입니다.';

    bodyEl.innerHTML =
      '<div id="roleAdminLayout" ' +
           'style="display:grid;grid-template-columns:260px minmax(0,1fr);gap:12px;align-items:flex-start;">' +

        '<div>' +
          '<div class="admin-card" id="roleAdminFilterCard">' +
            '<h4><i class="fa-solid fa-filter"></i> 필터</h4>' +
            '<div style="display:flex;flex-direction:column;gap:6px;margin-top:6px;font-size:12px;">' +
              '<label>검색 (역할명/코드)' +
                '<input id="roleAdminSearch" type="text" ' +
                  'placeholder="예: DBAM_USER, 일반 사용자" ' +
                  'style="margin-top:2px;width:100%;box-sizing:border-box;padding:4px 6px;font-size:12px;' +
                         'border:1px solid #e5e7eb;border-radius:4px;" />' +
              '</label>' +

              '<label>범주' +
                '<select id="roleAdminCategory" ' +
                  'style="margin-top:2px;width:100%;box-sizing:border-box;padding:4px 6px;font-size:12px;' +
                         'border:1px solid #e5e7eb;border-radius:4px;">' +
                  '<option value="">전체</option>' +
                '</select>' +
              '</label>' +

              '<label>위험도' +
                '<select id="roleAdminRisk" ' +
                  'style="margin-top:2px;width:100%;box-sizing:border-box;padding:4px 6px;font-size:12px;' +
                         'border:1px solid #e5e7eb;border-radius:4px;">' +
                  '<option value="">전체</option>' +
                  '<option value="LOW">LOW</option>' +
                  '<option value="MEDIUM">MEDIUM</option>' +
                  '<option value="HIGH">HIGH</option>' +
                '</select>' +
              '</label>' +

              '<label>환경' +
                '<select id="roleAdminEnv" ' +
                  'style="margin-top:2px;width:100%;box-sizing:border-box;padding:4px 6px;font-size:12px;' +
                         'border:1px solid #e5e7eb;border-radius:4px;">' +
                  '<option value="">전체</option>' +
                '</select>' +
              '</label>' +

              '<button type="button" id="roleAdminReset" ' +
                'style="margin-top:2px;align-self:flex-start;padding:4px 10px;font-size:12px;' +
                       'border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb;cursor:pointer;">' +
                '<i class="fa-solid fa-rotate"></i> 필터 초기화' +
              '</button>' +
            '</div>' +
          '</div>' +

          '<div class="admin-card" id="roleAdminSummaryCard" style="margin-top:10px;">' +
            '<h4><i class="fa-solid fa-circle-info"></i> 요약</h4>' +
            '<div id="roleAdminSummaryBody" style="margin-top:6px;font-size:12px;"></div>' +
          '</div>' +
        '</div>' +

        '<div>' +
          '<div class="admin-card" id="roleAdminTableCard">' +
            '<h4><i class="fa-solid fa-id-badge"></i> 역할 목록</h4>' +
            '<div style="margin-top:6px;max-height:260px;overflow:auto;border-top:1px solid #e5e7eb;">' +
              '<table id="roleAdminTable" style="width:100%;border-collapse:collapse;font-size:12px;">' +
                '<thead>' +
                  '<tr>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">역할명 / 코드</th>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">범주</th>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">위험도</th>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">환경</th>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">MFA</th>' +
                    '<th style="text-align:left;padding:4px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">할당 인원</th>' +
                  '</tr>' +
                '</thead>' +
                '<tbody></tbody>' +
              '</table>' +
            '</div>' +
            '<div class="admin-footer" style="margin-top:6px;">' +
              '※ 역할 구성은 예시이며, 실제 운영 시에는 조직 규정에 맞춰 재정의합니다.' +
            '</div>' +
          '</div>' +

          '<div class="admin-card" id="roleAdminDetailCard" style="margin-top:8px;">' +
            '<h4><i class="fa-solid fa-clipboard-list"></i> 역할 상세</h4>' +
            '<div id="roleAdminDetailBody" style="margin-top:6px;font-size:12px;">' +
              '좌측 목록에서 역할을 선택하면 상세 정보가 표시됩니다.' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>';

    this._populateFilterOptions();
    this._bindFilterEvents();
    this._applyFilter();
  },

  _populateFilterOptions(){
    const catSel = document.getElementById('roleAdminCategory');
    const envSel = document.getElementById('roleAdminEnv');
    if (!catSel || !envSel) return;

    const catSet = new Set();
    const envSet = new Set();

    this.sampleRoles.forEach(r => {
      if (r.category) catSet.add(r.category);
      (r.envScope || []).forEach(e => envSet.add(e));
    });

    Array.from(catSet).sort().forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      catSel.appendChild(opt);
    });

    Array.from(envSet).sort().forEach(e => {
      const opt = document.createElement('option');
      opt.value = e;
      opt.textContent = e;
      envSel.appendChild(opt);
    });
  },

  _bindFilterEvents(){
    const searchInput = document.getElementById('roleAdminSearch');
    const catSel      = document.getElementById('roleAdminCategory');
    const riskSel     = document.getElementById('roleAdminRisk');
    const envSel      = document.getElementById('roleAdminEnv');
    const resetBtn    = document.getElementById('roleAdminReset');
    const self        = this;

    function bindChange(el){
      if (!el || el._bound) return;
      el.addEventListener('change', function(){ self._applyFilter(); });
      el._bound = true;
    }

    if (searchInput && !searchInput._bound){
      searchInput.addEventListener('input', function(){ self._applyFilter(); });
      searchInput._bound = true;
    }
    bindChange(catSel);
    bindChange(riskSel);
    bindChange(envSel);

    if (resetBtn && !resetBtn._bound){
      resetBtn.addEventListener('click', function(){
        if (searchInput) searchInput.value = '';
        if (catSel)      catSel.value = '';
        if (riskSel)     riskSel.value = '';
        if (envSel)      envSel.value = '';
        self.selectedRoleId = null;
        self._applyFilter();
      });
      resetBtn._bound = true;
    }
  },

  _applyFilter(){
    const searchInput = document.getElementById('roleAdminSearch');
    const catSel      = document.getElementById('roleAdminCategory');
    const riskSel     = document.getElementById('roleAdminRisk');
    const envSel      = document.getElementById('roleAdminEnv');

    const kw    = (searchInput && searchInput.value || '').trim().toLowerCase();
    const cat   = catSel ? (catSel.value || '') : '';
    const risk  = riskSel ? (riskSel.value || '') : '';
    const env   = envSel ? (envSel.value || '') : '';

    const filtered = this.sampleRoles.filter(r => {
      if (cat && r.category !== cat) return false;
      if (risk && r.risk !== risk) return false;
      if (env && !(r.envScope || []).includes(env)) return false;

      if (!kw) return true;

      const base = [
        r.name || '',
        r.code || '',
        r.category || '',
        (r.menuScopes || []).join(' '),
        r.dataScope || '',
        r.recommendedFor || ''
      ].join(' ').toLowerCase();

      return base.indexOf(kw) >= 0;
    });

    this._renderTable(filtered);
    this._renderSummary(filtered);
  },

  _renderTable(list){
    const tbody = document.querySelector('#roleAdminTable tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!list.length){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 6;
      td.style.padding = '8px 6px';
      td.style.textAlign = 'center';
      td.style.color = '#6b7280';
      td.textContent = '조건에 해당하는 역할이 없습니다.';
      tr.appendChild(td);
      tbody.appendChild(tr);

      const detailBox = document.getElementById('roleAdminDetailBody');
      if (detailBox){
        detailBox.textContent = '필터를 조정하거나 검색어를 변경해 역할 목록을 다시 확인해 주세요.';
      }
      return;
    }

    list.forEach(r => {
      const tr = document.createElement('tr');
      tr.style.borderBottom = '1px solid #f3f4f6';
      tr.dataset.roleId = r.id;

      // 역할명 / 코드
      const tdName = document.createElement('td');
      tdName.style.padding = '4px 6px';
      tdName.style.whiteSpace = 'nowrap';
      tdName.innerHTML =
        '<div style="font-weight:600;">' + (r.name || '') + '</div>' +
        '<div style="font-size:11px;color:#6b7280;">' + (r.code || '') + '</div>';
      tr.appendChild(tdName);

      // 범주
      const tdCat = document.createElement('td');
      tdCat.style.padding = '4px 6px';
      tdCat.style.whiteSpace = 'nowrap';
      tdCat.textContent = r.category || '';
      tr.appendChild(tdCat);

      // 위험도
      const tdRisk = document.createElement('td');
      tdRisk.style.padding = '4px 6px';
      tdRisk.style.whiteSpace = 'nowrap';
      const riskChip = this._buildRiskChip(r.risk || 'LOW');
      tdRisk.appendChild(riskChip);
      tr.appendChild(tdRisk);

      // 환경
      const tdEnv = document.createElement('td');
      tdEnv.style.padding = '4px 6px';
      tdEnv.style.whiteSpace = 'nowrap';
      const envs = r.envScope || [];
      tdEnv.innerHTML = envs.map(e =>
        '<span style="display:inline-block;margin-right:3px;padding:2px 6px;border-radius:999px;' +
               'border:1px solid #e5e7eb;background:#f9fafb;font-size:11px;">' + e + '</span>'
      ).join('');
      tr.appendChild(tdEnv);

      // MFA
      const tdMfa = document.createElement('td');
      tdMfa.style.padding = '4px 6px';
      tdMfa.style.whiteSpace = 'nowrap';
      const mfaOn = !!r.mfaRequired;
      tdMfa.innerHTML =
        '<span style="font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid ' +
        (mfaOn ? '#22c55e' : '#e5e7eb') + ';background:' +
        (mfaOn ? '#dcfce7' : '#f9fafb') + ';color:' +
        (mfaOn ? '#166534' : '#6b7280') + ';">' +
        (mfaOn ? '<i class="fa-solid fa-shield-halved"></i> 필수' : '선택') +
        '</span>';
      tr.appendChild(tdMfa);

      // 할당 인원
      const tdCount = document.createElement('td');
      tdCount.style.padding = '4px 6px';
      tdCount.style.whiteSpace = 'nowrap';
      tdCount.textContent = (r.assignedUsers || 0) + '명';
      tr.appendChild(tdCount);

      tr.addEventListener('click', () => {
        this.selectedRoleId = r.id;
        this._highlightSelectedRow();
        this._renderDetail(r);
      });

      tbody.appendChild(tr);
    });

    // 기본 선택: 첫 번째
    this.selectedRoleId = list[0].id;
    this._highlightSelectedRow();
    this._renderDetail(list[0]);
  },

  _buildRiskChip(risk){
    const span = document.createElement('span');
    span.style.display = 'inline-flex';
    span.style.alignItems = 'center';
    span.style.gap = '4px';
    span.style.padding = '2px 6px';
    span.style.borderRadius = '999px';
    span.style.fontSize = '11px';

    let label = risk || 'LOW';
    let color = '#16a34a';
    let bg    = '#dcfce7';

    if (risk === 'MEDIUM'){
      label = 'MEDIUM';
      color = '#ea580c';
      bg    = '#ffedd5';
    } else if (risk === 'HIGH'){
      label = 'HIGH';
      color = '#b91c1c';
      bg    = '#fee2e2';
    }

    span.style.background = bg;
    span.style.color = color;
    span.innerHTML =
      '<span style="width:6px;height:6px;border-radius:999px;background:' + color + ';"></span>' +
      label;

    return span;
  },

  _highlightSelectedRow(){
    const tbody = document.querySelector('#roleAdminTable tbody');
    if (!tbody) return;
    const rows = tbody.querySelectorAll('tr');
    rows.forEach(tr => {
      if (tr.dataset.roleId === this.selectedRoleId){
        tr.style.background = '#eff6ff';
      } else {
        tr.style.background = '';
      }
    });
  },

  _renderDetail(role){
    const box = document.getElementById('roleAdminDetailBody');
    if (!box) return;

    if (!role){
      box.textContent = '좌측 목록에서 역할을 선택하면 상세 정보가 표시됩니다.';
      return;
    }

    const mfaText = role.mfaRequired ? '필수' : '선택';
    const mfaDesc = role.mfaRequired ? '이 역할을 가진 계정은 반드시 MFA를 사용해야 합니다.' :
                                       '운영 정책에 따라 선택적으로 MFA를 적용할 수 있습니다.';

    const riskChipHtml = (function(r){
      let label = r || 'LOW';
      let color = '#16a34a';
      let bg    = '#dcfce7';
      if (r === 'MEDIUM'){
        label = 'MEDIUM'; color = '#ea580c'; bg = '#ffedd5';
      } else if (r === 'HIGH'){
        label = 'HIGH'; color = '#b91c1c'; bg = '#fee2e2';
      }
      return '<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 6px;' +
                    'border-radius:999px;font-size:11px;background:' + bg + ';color:' + color + ';">' +
               '<span style="width:6px;height:6px;border-radius:999px;background:' + color + ';"></span>' +
               label +
             '</span>';
    })(role.risk || 'LOW');

    const envHtml = (role.envScope || []).map(e =>
      '<span style="display:inline-block;margin-right:3px;padding:2px 6px;border-radius:999px;' +
             'border:1px solid #e5e7eb;background:#f9fafb;font-size:11px;">' + e + '</span>'
    ).join('');

    const menusHtml = (role.menuScopes || []).map(m =>
      '<li>' + m + '</li>'
    ).join('');

    const permList = (window.DBAM_ROLE_PERMS && window.DBAM_ROLE_PERMS[role.id]) || [];
    const permsHtml = permList.length
      ? permList.map(p => (
          '<span style="display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid #e5e7eb;background:#f9fafb;font-size:11px;">' + p + '</span>'
        )).join(' ')
      : '<span style="color:#6b7280;font-size:12px;">(권한 ID 정의 없음)</span>';
    
    
    box.innerHTML =
      '<div>' +
        '<div style="font-weight:600;font-size:13px;">' +
          (role.name || '') + ' <span style="font-size:11px;color:#6b7280;">[' + (role.code || '') + ']</span>' +
        '</div>' +
        '<div style="margin-top:2px;font-size:11px;color:#6b7280;">' +
          (role.recommendedFor || '') +
        '</div>' +

        '<dl style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px;margin-top:8px;font-size:12px;">' +
          '<div>' +
            '<dt style="font-weight:600;color:#64748b;">범주</dt>' +
            '<dd style="margin:0;">' + (role.category || '-') + '</dd>' +
          '</div>' +
          '<div>' +
            '<dt style="font-weight:600;color:#64748b;">위험도</dt>' +
            '<dd style="margin:0;">' + riskChipHtml + '</dd>' +
          '</div>' +
          '<div>' +
            '<dt style="font-weight:600;color:#64748b;">환경 범위</dt>' +
            '<dd style="margin:0;">' + (envHtml || '-') + '</dd>' +
          '</div>' +
          '<div>' +
            '<dt style="font-weight:600;color:#64748b;">MFA</dt>' +
            '<dd style="margin:0;">' + mfaText + '<span style="margin-left:6px;font-size:11px;color:#6b7280;">' + mfaDesc + '</span></dd>' +
          '</div>' +
          '<div>' +
            '<dt style="font-weight:600;color:#64748b;">할당 인원</dt>' +
            '<dd style="margin:0;">' + (role.assignedUsers || 0) + '명</dd>' +
          '</div>' +
          '<div>' +
            '<dt style="font-weight:600;color:#64748b;">기본 할당 여부</dt>' +
            '<dd style="margin:0;">' + (role.defaultAssigned ? '일부 사용자 기본 역할' : '필요시 수동 할당') + '</dd>' +
          '</div>' +
        '</dl>' +

        '<div style="margin-top:8px;">' +
          '<div style="font-weight:600;font-size:12px;margin-bottom:2px;">메뉴·기능 권한</div>' +
          '<ul style="margin:0;padding-left:18px;font-size:12px;">' +
            menusHtml +
          '</ul>' +
        '</div>' +

        '<div style="margin-top:8px;">' +
        '<div style="font-weight:600;font-size:12px;margin-bottom:2px;">권한 ID</div>' +
        '<div style="display:flex;flex-wrap:wrap;gap:6px;">' + permsHtml + '</div>' +
      '</div>' +
      
        '<div style="margin-top:8px;">' +
          '<div style="font-weight:600;font-size:12px;margin-bottom:2px;">데이터 범위</div>' +
          '<div style="font-size:12px;">' + (role.dataScope || '-') + '</div>' +
        '</div>' +
      '</div>';
  },

  	_getUserRoles(userId){
	    return (window.DBAM_USER_ROLE_MAP && window.DBAM_USER_ROLE_MAP[userId]) ? [...window.DBAM_USER_ROLE_MAP[userId]] : [];
	  },

	  _setUserRoles(userId, nextRoles){
	    const msg = window.validateSoD(nextRoles);
	    if (msg) { throw new Error(msg); }
	    window.DBAM_USER_ROLE_MAP[userId] = [...nextRoles];
	  },

	  
  _renderSummary(list){
    const box = document.getElementById('roleAdminSummaryBody');
    if (!box) return;

    const all       = this.sampleRoles.length;
    const current   = list.length;
    const lowCnt    = list.filter(r => r.risk === 'LOW').length;
    const medCnt    = list.filter(r => r.risk === 'MEDIUM').length;
    const highCnt   = list.filter(r => r.risk === 'HIGH').length;
    const mfaReq    = list.filter(r => r.mfaRequired).length;
    const defaultCnt= list.filter(r => r.defaultAssigned).length;

    box.innerHTML =
      '<div style="display:flex;flex-direction:column;gap:4px;">' +
        '<div style="font-size:11px;color:#6b7280;">현재 필터 결과 기준 요약</div>' +
        '<div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:4px;">' +
          '<div style="padding:4px 6px;border-radius:6px;background:#f9fafb;border:1px solid #e5e7eb;">' +
            '<div style="font-size:11px;color:#6b7280;">정의된 역할 수</div>' +
            '<div style="margin-top:2px;font-size:13px;font-weight:600;">' + all + '개</div>' +
          '</div>' +
          '<div style="padding:4px 6px;border-radius:6px;background:#f9fafb;border:1px solid #e5e7eb;">' +
            '<div style="font-size:11px;color:#6b7280;">필터 후 역할</div>' +
            '<div style="margin-top:2px;font-size:13px;font-weight:600;">' + current + '개</div>' +
          '</div>' +
          '<div style="padding:4px 6px;border-radius:6px;background:#ecfdf3;border:1px solid #bbf7d0;">' +
            '<div style="font-size:11px;color:#16a34a;">LOW 위험</div>' +
            '<div style="margin-top:2px;font-size:13px;font-weight:600;">' + lowCnt + '개</div>' +
          '</div>' +
          '<div style="padding:4px 6px;border-radius:6px;background:#fffbeb;border:1px solid #facc15;">' +
            '<div style="font-size:11px;color:#ea580c;">MEDIUM/HIGH</div>' +
            '<div style="margin-top:2px;font-size:13px;font-weight:600;">' + (medCnt + highCnt) + '개</div>' +
          '</div>' +
          '<div style="padding:4px 6px;border-radius:6px;background:#eff6ff;border:1px solid #bfdbfe;">' +
            '<div style="font-size:11px;color:#1d4ed8;">MFA 필수 역할</div>' +
            '<div style="margin-top:2px;font-size:13px;font-weight:600;">' + mfaReq + '개</div>' +
          '</div>' +
          '<div style="padding:4px 6px;border-radius:6px;background:#f9fafb;border:1px solid #e5e7eb;">' +
            '<div style="font-size:11px;color:#6b7280;">기본 역할 (자동 부여)</div>' +
            '<div style="margin-top:2px;font-size:13px;font-weight:600;">' + defaultCnt + '개</div>' +
          '</div>' +
        '</div>' +
      '</div>';
  },

};

window.roleAdmin = roleAdmin;

/* =========================================================
 * [PATCH] IAM 사용자/역할 관리(RBAC) 완성
 * - 사용자별 Role 매핑(UI/저장) + SoD 체크
 * - 역할별 Permission 매핑(UI/저장)
 * - API 호출 래퍼: 권한체크(requirePerm) + 활동로그(DBAM_ACTIVITY_LOGS_V1)
 * ========================================================= */
(function(){
  const W = window;
  if (!W || !W.userAdmin || !W.roleAdmin || !W.DBAM_AUTHZ) return;

  const toast = W.toast || function(m){ alert(m); };

  // ---------------------------
  // 0) 최소 권한/역할 정의 보강
  // ---------------------------
  W.DBAM_PERMS = W.DBAM_PERMS || {};
  const P = W.DBAM_PERMS;
  P.IAM_USER_VIEW       = P.IAM_USER_VIEW       || "IAM_USER_VIEW";
  P.IAM_USER_ROLE_EDIT  = P.IAM_USER_ROLE_EDIT  || "IAM_USER_ROLE_EDIT";
  P.IAM_USER_STATUS_EDIT= P.IAM_USER_STATUS_EDIT|| "IAM_USER_STATUS_EDIT";
  P.IAM_ROLE_VIEW       = P.IAM_ROLE_VIEW       || "IAM_ROLE_VIEW";
  P.IAM_ROLE_PERM_EDIT  = P.IAM_ROLE_PERM_EDIT  || "IAM_ROLE_PERM_EDIT";

  W.DBAM_ROLE_PERMS = W.DBAM_ROLE_PERMS || {};
  // 기존 운영자(ROLE_DBA_OPERATOR)가 편집을 전혀 못 하는 상태면 테스트가 막혀서, 최소한의 편집 권한을 추가
  if (Array.isArray(W.DBAM_ROLE_PERMS.ROLE_DBA_OPERATOR)) {
    if (!W.DBAM_ROLE_PERMS.ROLE_DBA_OPERATOR.includes(P.IAM_USER_STATUS_EDIT)) W.DBAM_ROLE_PERMS.ROLE_DBA_OPERATOR.push(P.IAM_USER_STATUS_EDIT);
    if (!W.DBAM_ROLE_PERMS.ROLE_DBA_OPERATOR.includes(P.IAM_ROLE_PERM_EDIT))   W.DBAM_ROLE_PERMS.ROLE_DBA_OPERATOR.push(P.IAM_ROLE_PERM_EDIT);
  }

  // ---------------------------
  // 1) 공통 유틸
  // ---------------------------
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function pad2(n){ n = String(n); return n.length>=2 ? n : ("0"+n); }
  function pad6(n){ n = String(n); return n.length>=6 ? n : ("000000"+n).slice(-6); }
  function ymd(ts){
    const d = new Date(ts);
    return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}`;
  }
  function safeJSONParse(raw, fallback){
    try { return JSON.parse(raw); } catch(e){ return fallback; }
  }

  // 사용자 표시명 찾기(활동로그에 쓰기)
  function findUserNameById(uid){
    const list = (W.userAdmin && Array.isArray(W.userAdmin.sampleUsers)) ? W.userAdmin.sampleUsers : [];
    const u = list.find(x => x.id === uid);
    return u ? (u.name || u.id) : uid;
  }

  // ---------------------------
  // 2) API 호출 래퍼(미들웨어 역할)
  // ---------------------------
  W.DBAM_API = W.DBAM_API || {};
  W.DBAM_API.call = function(opts){
	  console.log("##opts=",opts);
	  console.log("##opts.perm=",opts.perm);
    const perm   = opts && opts.perm;
    const action = (opts && opts.action) || "API_CALL";
    const target = (opts && opts.target) || "-";
    const detail = (opts && opts.detail) || "";
    const fn     = (opts && opts.fn);

    // 권한 체크
    try{
      if (perm) W.DBAM_AUTHZ.requirePerm(perm, action);
    }catch(e){
      pushActivityLog({
        env: "PROD",
        cat: "IAM",
        action,
        target,
        result: "FAIL",
        sev: "WARN",
        detail: `${detail} / ${e.message}`
      });
      throw e;
    }

    // 실행
    const out = (typeof fn === "function") ? fn() : null;

    pushActivityLog({
      env: "PROD",
      cat: "IAM",
      action,
      target,
      result: "SUCCESS",
      sev: "INFO",
      detail
    });

    return out;
  };

  // 활동 로그 저장(기존 activityLog 화면이 localStorage를 읽어보는 구조라면 그대로 이어짐)
  function pushActivityLog(rec){
    const STORE_KEY = "DBAM_ACTIVITY_LOGS_V1";
    const SEQ_KEY   = "DBAM_ACTIVITY_LOG_SEQ_V1";
    try{
      const cur = safeJSONParse(localStorage.getItem(STORE_KEY) || "[]", []);
      let seq = Number(localStorage.getItem(SEQ_KEY) || "0");
      seq += 1;
      localStorage.setItem(SEQ_KEY, String(seq));

      const ts = Date.now();
      const uid = W.DBAM_AUTHZ.currentUserId ? W.DBAM_AUTHZ.currentUserId() : (W.DBAM_CURRENT_USER || "unknown");
      const row = {
        id: `AL-${ymd(ts)}-${pad6(seq)}`,
        ts,
        env: rec.env || "PROD",
        user: findUserNameById(uid),
        cat: rec.cat || "IAM",
        action: rec.action || "API_CALL",
        target: rec.target || "-",
        result: rec.result || "SUCCESS",
        sev: rec.sev || "INFO",
        ip: "0.0.0.0",
        ua: (navigator && navigator.userAgent) ? navigator.userAgent.split(" ")[0] : "Web",
        detail: rec.detail || ""
      };

      cur.unshift(row);
      localStorage.setItem(STORE_KEY, JSON.stringify(cur));
    }catch(e){
      // 로컬스토리지 막힌 환경이면 조용히 무시
    }
  }

  // ---------------------------
  // 3) 사용자-역할 매핑 기본값 보정
  // ---------------------------
  W.DBAM_USER_ROLE_MAP = W.DBAM_USER_ROLE_MAP || {};
  function ensureUserRoleDefaults(){
    const users = (W.userAdmin && Array.isArray(W.userAdmin.sampleUsers)) ? W.userAdmin.sampleUsers : [];
    users.forEach(u=>{
      if (!W.DBAM_USER_ROLE_MAP[u.id]) W.DBAM_USER_ROLE_MAP[u.id] = ["ROLE_DBAM_USER"];
    });
  }
  ensureUserRoleDefaults();

  // 역할 배정 수 재계산(역할 화면에 숫자 맞추기)
  function recomputeAssignedUsers(){
    const roles = (W.roleAdmin && Array.isArray(W.roleAdmin.sampleRoles)) ? W.roleAdmin.sampleRoles : [];
    if (!roles.length) return;

    const counts = {};
    Object.keys(W.DBAM_USER_ROLE_MAP).forEach(uid=>{
      const rs = W.DBAM_USER_ROLE_MAP[uid] || [];
      rs.forEach(rid => { counts[rid] = (counts[rid]||0) + 1; });
    });

    roles.forEach(r=>{
      r.assignedUsers = counts[r.id] || 0;
    });
  }

  // ---------------------------
  // 4) roleAdmin: open 권한 체크 + 권한 매핑 편집 UI
  // ---------------------------
  (function patchRoleAdmin(){
    const ra = W.roleAdmin;
    if (!ra || ra.__iamPatchedV1) return;

    // open()에 조회 권한 체크 추가
    const origOpen = ra.open && ra.open.bind(ra);
    ra.open = function(){
      try{
        W.DBAM_AUTHZ.requirePerm(P.IAM_ROLE_VIEW, "open: 역할(권한) 관리");
      }catch(e){
        toast(e.message);
        return;
      }
      return origOpen ? origOpen() : null;
    };

    // 상세 렌더링을 교체(권한 편집/저장 포함)
    ra._renderDetail = function(role){
      const box = document.getElementById("roleAdminDetailBody");
      if (!box) return;

      if (!role){
        box.textContent = "좌측 목록에서 역할을 선택하면 상세 정보가 표시됩니다.";
        return;
      }

      recomputeAssignedUsers();

      const allPerms = Object.values(W.DBAM_PERMS || {}).slice().sort();
      const curPerms = (W.DBAM_ROLE_PERMS && Array.isArray(W.DBAM_ROLE_PERMS[role.id])) ? W.DBAM_ROLE_PERMS[role.id] : [];
      const canEdit  = !!(W.DBAM_AUTHZ.hasPerm && W.DBAM_AUTHZ.hasPerm(P.IAM_ROLE_PERM_EDIT));

      // 이 역할이 배정된 사용자 목록
      const users = (W.userAdmin && Array.isArray(W.userAdmin.sampleUsers)) ? W.userAdmin.sampleUsers : [];
      const assigned = users.filter(u => (W.DBAM_USER_ROLE_MAP[u.id] || []).includes(role.id));

      const permChecks = allPerms.map(pid=>{
        const checked = curPerms.includes(pid) ? "checked" : "";
        return `
          <label style="display:flex;gap:8px;align-items:center;padding:4px 6px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;">
            <input type="checkbox" class="role-perm-chk" value="${esc(pid)}" ${checked} ${canEdit ? "" : "disabled"} />
            <span style="font-size:12px;">${esc(pid)}</span>
          </label>
        `;
      }).join("");

      box.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:10px;">
          <div>
            <div style="font-weight:800;font-size:14px;">
              ${esc(role.name)} <span style="font-size:11px;color:#6b7280;">[${esc(role.code)}]</span>
            </div>
            <div style="margin-top:4px;font-size:12px;color:#6b7280;">
              분류: ${esc(role.category)} / 위험도: ${esc(role.risk)} / MFA: ${role.mfaRequired ? "필수" : "선택"}
            </div>
          </div>

          <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;">
            <div style="font-weight:800;font-size:13px;margin-bottom:6px;">권한(ID) 매핑</div>
            <div style="font-size:12px;color:#6b7280;margin-bottom:8px;">
              역할에 부여된 권한을 정의합니다. (저장은 권한이 있는 사용자만 가능)
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;">
              ${permChecks || `<div style="color:#6b7280;">권한 ID가 없습니다.</div>`}
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
              <button id="rolePermSaveBtn" class="btn" style="padding:6px 10px;" ${canEdit ? "" : "disabled"}>
                <i class="fa-solid fa-floppy-disk"></i> 저장
              </button>
            </div>
            ${canEdit ? "" : `<div style="margin-top:6px;font-size:12px;color:#b91c1c;">※ 권한이 없어 편집할 수 없습니다.</div>`}
          </div>

          <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;">
            <div style="font-weight:800;font-size:13px;margin-bottom:6px;">이 역할이 배정된 사용자 (${assigned.length})</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;">
              ${
                assigned.length
                  ? assigned.map(u=>`<span style="padding:2px 8px;border:1px solid #e5e7eb;border-radius:999px;background:#f9fafb;font-size:12px;">${esc(u.name)}(${esc(u.id)})</span>`).join("")
                  : `<span style="color:#6b7280;font-size:12px;">(없음)</span>`
              }
            </div>
          </div>
        </div>
      `;

      // 저장 버튼 이벤트(중복 바인딩 방지)
      const saveBtn = document.getElementById("rolePermSaveBtn");
      if (saveBtn && !saveBtn._bound){
        saveBtn.addEventListener("click", function(){
          try{
            W.DBAM_API.call({
              perm: P.IAM_ROLE_PERM_EDIT,
              action: "IAM:UPDATE_ROLE_PERMS",
              target: role.id,
              detail: `역할 권한 매핑 저장 (${role.id})`,
              fn: function(){
                const chks = Array.from(box.querySelectorAll(".role-perm-chk"));
                const next = chks.filter(c=>c.checked).map(c=>c.value);
                W.DBAM_ROLE_PERMS[role.id] = next;
              }
            });
            toast("역할 권한 매핑이 저장되었습니다.");
          }catch(e){
            toast(e.message);
          }
        });
        saveBtn._bound = true;
      }
    };

    ra.__iamPatchedV1 = true;
  })();

  // ---------------------------
  // 5) userAdmin: 역할 매핑 UI/저장 + SoD + (선택)잠금 토글
  // ---------------------------
  (function patchUserAdmin(){
    const ua = W.userAdmin;
    if (!ua || ua.__iamPatchedV1) return;

    // render() 템플릿 확장: 테이블에 "역할/관리" 컬럼 + 상세 카드 추가 + 세션 사용자 선택
    ua.render = function(){
      const titleEl = document.getElementById("adminTitle");
      const descEl  = document.getElementById("adminDesc");
      const bodyEl  = document.getElementById("adminBody");
      if(!titleEl || !descEl || !bodyEl) return;

      titleEl.innerHTML = '<i class="fa-solid fa-user-gear"></i> 사용자 관리';
      descEl.textContent = "계정 상태/MFA/조직 정보와 함께 사용자↔역할 매핑(RBAC) 및 직무분리(SoD) 검증을 수행합니다.";

      const users = Array.isArray(ua.sampleUsers) ? ua.sampleUsers : [];
      const curUid = (W.DBAM_AUTHZ.currentUserId && W.DBAM_AUTHZ.currentUserId()) || (W.DBAM_CURRENT_USER || "");

      bodyEl.innerHTML =
        '<div id="userAdminLayout" style="display:grid;grid-template-columns:260px minmax(0,1fr);gap:12px;align-items:flex-start;">' +

          // 좌측
          '<div>' +
            '<div class="admin-card" style="padding:10px 12px;">' +
              '<div style="font-weight:800;font-size:13px;margin-bottom:8px;"><i class="fa-solid fa-id-badge"></i> 세션 사용자</div>' +
              '<select id="iamSessionUserSelect" style="width:100%;padding:6px 8px;font-size:12px;border:1px solid #e5e7eb;border-radius:8px;">' +
                users.map(u=>{
                  const sel = (u.id === curUid) ? "selected" : "";
                  return `<option value="${esc(u.id)}" ${sel}>${esc(u.name)} (${esc(u.id)})</option>`;
                }).join("") +
              '</select>' +
              '<div id="iamSessionUserInfo" style="margin-top:8px;font-size:12px;color:#6b7280;"></div>' +
            '</div>' +

            // 필터 카드(기존 ID 유지)
            '<div class="admin-card" id="userAdminFilterCard" style="margin-top:10px;">' +
              '<h4><i class="fa-solid fa-filter"></i> 필터</h4>' +
              '<div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">' +
                '<label>검색' +
                  '<input id="userAdminSearch" placeholder="이름/ID/사번" style="margin-top:2px;width:100%;box-sizing:border-box;padding:6px 8px;font-size:12px;border:1px solid #e5e7eb;border-radius:8px;" />' +
                '</label>' +
                '<label>조직' +
                  '<select id="userAdminDept" style="margin-top:2px;width:100%;box-sizing:border-box;padding:6px 8px;font-size:12px;border:1px solid #e5e7eb;border-radius:8px;">' +
                    '<option value="">전체</option>' +
                  '</select>' +
                '</label>' +
                '<label>상태' +
                  '<select id="userAdminStatus" style="margin-top:2px;width:100%;box-sizing:border-box;padding:6px 8px;font-size:12px;border:1px solid #e5e7eb;border-radius:8px;">' +
                    '<option value="">전체</option>' +
                    '<option value="ACTIVE">활성</option>' +
                    '<option value="LOCKED">잠금</option>' +
                    '<option value="DISABLED">비활성</option>' +
                  '</select>' +
                '</label>' +
                '<label>MFA' +
                  '<select id="userAdminMfa" style="margin-top:2px;width:100%;box-sizing:border-box;padding:6px 8px;font-size:12px;border:1px solid #e5e7eb;border-radius:8px;">' +
                    '<option value="">전체</option>' +
                    '<option value="ON">사용</option>' +
                    '<option value="OFF">미사용</option>' +
                  '</select>' +
                '</label>' +
                '<button id="userAdminReset" class="btn" style="margin-top:6px;">초기화</button>' +
              '</div>' +
            '</div>' +

            // 요약 카드(기존 ID 유지)
            '<div class="admin-card" id="userAdminSummaryCard" style="margin-top:10px;">' +
              '<h4><i class="fa-solid fa-chart-simple"></i> 요약</h4>' +
              '<div id="userAdminSummaryBody" style="margin-top:8px;"></div>' +
            '</div>' +
          '</div>' +

          // 우측
          '<div>' +
            '<div class="admin-card" id="userAdminTableCard">' +
              '<h4><i class="fa-solid fa-users"></i> 사용자 목록</h4>' +
              '<div style="margin-top:6px;max-height:380px;overflow:auto;border-top:1px solid #e5e7eb;">' +
                '<table id="userAdminTable" style="width:100%;border-collapse:collapse;font-size:12px;">' +
                  '<thead>' +
                    '<tr>' +
                      '<th style="text-align:left;padding:6px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">이름 / ID</th>' +
                      '<th style="text-align:left;padding:6px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">조직</th>' +
                      '<th style="text-align:left;padding:6px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">프로필</th>' +
                      '<th style="text-align:left;padding:6px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">상태</th>' +
                      '<th style="text-align:left;padding:6px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">MFA</th>' +
                      '<th style="text-align:left;padding:6px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">최근 로그인</th>' +
                      '<th style="text-align:left;padding:6px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">역할</th>' +
                      '<th style="text-align:left;padding:6px 6px;border-bottom:1px solid #e5e7eb;white-space:nowrap;">관리</th>' +
                    '</tr>' +
                  '</thead>' +
                  '<tbody></tbody>' +
                '</table>' +
              '</div>' +
              '<div class="admin-footer" style="margin-top:6px;">' +
                '※ 역할 저장 시 SoD(직무 분리) 규칙을 검증합니다.' +
              '</div>' +
            '</div>' +

            '<div class="admin-card" id="userAdminDetailCard" style="margin-top:10px;">' +
              '<h4><i class="fa-solid fa-user-shield"></i> 사용자 상세 / 역할 매핑</h4>' +
              '<div id="userAdminDetailBody" style="margin-top:8px;color:#6b7280;font-size:12px;">좌측 목록에서 사용자를 선택하세요.</div>' +
            '</div>' +
          '</div>' +
        '</div>';

      ua._populateDeptOptions();
      ua._bindFilterEvents();
      ua._bindSessionUserSelect();
      ua._applyFilter();
      ua._renderSessionUserInfo();
    };

    // 세션 사용자 선택
    ua._bindSessionUserSelect = function(){
      const sel = document.getElementById("iamSessionUserSelect");
      if (!sel || sel._bound) return;
      sel.addEventListener("change", function(){
        W.DBAM_CURRENT_USER = sel.value;
        toast(`세션 사용자가 ${sel.value} 로 변경되었습니다.`);
        ua._renderSessionUserInfo();
      });
      sel._bound = true;
    };
    ua._renderSessionUserInfo = function(){
      const box = document.getElementById("iamSessionUserInfo");
      if (!box) return;
      const uid = (W.DBAM_AUTHZ.currentUserId && W.DBAM_AUTHZ.currentUserId()) || (W.DBAM_CURRENT_USER || "");
      const roles = (W.DBAM_USER_ROLE_MAP && W.DBAM_USER_ROLE_MAP[uid]) ? W.DBAM_USER_ROLE_MAP[uid] : [];
      const perms = [];
      roles.forEach(r=>{
        const ps = (W.DBAM_ROLE_PERMS && W.DBAM_ROLE_PERMS[r]) || [];
        ps.forEach(p=>{ if (!perms.includes(p)) perms.push(p); });
      });
      box.innerHTML =
        `<div>현재 ID: <b>${esc(uid)}</b></div>` +
        `<div style="margin-top:4px;">Roles: ${roles.map(r=>`<span style="padding:1px 8px;border:1px solid #e5e7eb;border-radius:999px;background:#f9fafb;">${esc(r)}</span>`).join(" ") || "-"}</div>` +
        `<div style="margin-top:4px;">Perms: <span style="color:#111827;">${esc(perms.join(", ") || "-")}</span></div>`;
    };

    // 테이블 렌더링 교체(역할/관리 컬럼 + 선택/상세)
    ua._renderTable = function(list){
      ensureUserRoleDefaults();
      recomputeAssignedUsers();

      const tbody = document.querySelector("#userAdminTable tbody");
      if(!tbody) return;
      tbody.innerHTML = "";

      const canRoleEdit   = !!(W.DBAM_AUTHZ.hasPerm && W.DBAM_AUTHZ.hasPerm(P.IAM_USER_ROLE_EDIT));
      const canStatusEdit = !!(W.DBAM_AUTHZ.hasPerm && W.DBAM_AUTHZ.hasPerm(P.IAM_USER_STATUS_EDIT));

      list.forEach(u=>{
        const roles = (W.DBAM_USER_ROLE_MAP[u.id] || ["ROLE_DBAM_USER"]);
        const tr = document.createElement("tr");
        tr.style.borderBottom = "1px solid #f3f4f6";
        tr.style.cursor = "pointer";

        // 1) 이름/ID
        const tdName = document.createElement("td");
        tdName.style.padding = "6px 6px";
        tdName.innerHTML =
          `<div style="font-weight:700;">${esc(u.name)}</div>` +
          `<div style="font-size:11px;color:#6b7280;">${esc(u.id)} / ${esc(u.empNo || "-")}</div>`;
        tr.appendChild(tdName);

        // 2) 조직
        const tdOrg = document.createElement("td");
        tdOrg.style.padding = "6px 6px";
        tdOrg.innerHTML =
          `<div>${esc(u.dept || "-")}</div>` +
          `<div style="font-size:11px;color:#6b7280;">${esc(u.team || "")}</div>`;
        tr.appendChild(tdOrg);

        // 3) 프로필
        const tdProfile = document.createElement("td");
        tdProfile.style.padding = "6px 6px";
        tdProfile.textContent = u.profile || "-";
        tr.appendChild(tdProfile);

        // 4) 상태
        const tdStatus = document.createElement("td");
        tdStatus.style.padding = "6px 6px";
        const st = u.status || "ACTIVE";
        let stLabel = "활성", stColor="#16a34a", stBg="#dcfce7";
        if (st === "LOCKED"){ stLabel="잠금"; stColor="#b91c1c"; stBg="#fee2e2"; }
        else if (st === "DISABLED"){ stLabel="비활성"; stColor="#6b7280"; stBg="#e5e7eb"; }
        tdStatus.innerHTML =
          `<span style="display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:${stBg};color:${stColor};font-size:11px;">
             <span style="width:6px;height:6px;border-radius:999px;background:${stColor};"></span>${stLabel}
           </span>`;
        tr.appendChild(tdStatus);

        // 5) MFA
        const tdMfa = document.createElement("td");
        tdMfa.style.padding = "6px 6px";
        const mfaOn = (u.mfa === "ON");
        tdMfa.innerHTML = mfaOn
          ? '<span style="padding:2px 8px;border-radius:999px;background:#eff6ff;color:#1d4ed8;font-size:11px;">ON</span>'
          : '<span style="padding:2px 8px;border-radius:999px;background:#f3f4f6;color:#6b7280;font-size:11px;">OFF</span>';
        tr.appendChild(tdMfa);

        // 6) 최근 로그인
        const tdLogin = document.createElement("td");
        tdLogin.style.padding = "6px 6px";
        tdLogin.innerHTML =
          `<div style="white-space:nowrap;">${esc(u.lastLogin || "-")}</div>` +
          `<div style="font-size:11px;color:#6b7280;white-space:nowrap;">${esc(u.lastLoginIp || "")}</div>`;
        tr.appendChild(tdLogin);

        // 7) 역할
        const tdRoles = document.createElement("td");
        tdRoles.style.padding = "6px 6px";
        const roleBadges = roles.slice(0,2).map(r=>`<span style="display:inline-block;margin:2px 4px 0 0;padding:1px 8px;border:1px solid #e5e7eb;border-radius:999px;background:#f9fafb;font-size:11px;">${esc(r)}</span>`).join("");
        const more = roles.length > 2 ? `<span style="font-size:11px;color:#6b7280;">+${roles.length-2}</span>` : "";
        tdRoles.innerHTML = roleBadges + more;
        tr.appendChild(tdRoles);

        // 8) 관리
        const tdAct = document.createElement("td");
        tdAct.style.padding = "6px 6px";
        tdAct.style.whiteSpace = "nowrap";
        tdAct.innerHTML =
          `<button class="btn" data-act="roles" data-uid="${esc(u.id)}" style="padding:4px 8px;">역할</button>
           <button class="btn" data-act="lock"  data-uid="${esc(u.id)}" style="padding:4px 8px;${canStatusEdit ? "" : "opacity:.5;pointer-events:none;"}">${st==="LOCKED"?"해제":"잠금"}</button>`;
        tr.appendChild(tdAct);

        // 클릭 시 상세 표시(버튼 클릭은 제외)
        tr.addEventListener("click", function(e){
          const t = e.target;
          if (t && t.getAttribute && t.getAttribute("data-act")) return;
          ua.selectedUserId = u.id;
          ua._renderDetail(u);
        });

        tbody.appendChild(tr);
      });

      // 버튼 이벤트(이벤트 위임)
      if (!tbody._iamBound){
        tbody.addEventListener("click", function(e){
          const t = e.target;
          if (!t || !t.getAttribute) return;
          const act = t.getAttribute("data-act");
          const uid = t.getAttribute("data-uid");
          if (!act || !uid) return;

          const user = (ua.sampleUsers || []).find(x=>x.id===uid);
          if (!user) return;

          if (act === "roles"){
            ua.selectedUserId = uid;
            ua._renderDetail(user);
            document.getElementById("userAdminDetailCard")?.scrollIntoView({behavior:"smooth", block:"start"});
          }
          if (act === "lock"){
            try{
              W.DBAM_API.call({
                perm: P.IAM_USER_STATUS_EDIT,
                action: "IAM:TOGGLE_USER_LOCK",
                target: uid,
                detail: `사용자 상태 변경 (${uid})`,
                fn: function(){
                  user.status = (user.status === "LOCKED") ? "ACTIVE" : "LOCKED";
                  if (user.status === "ACTIVE") user.failCount = 0;
                }
              });
              toast("사용자 상태가 변경되었습니다.");
              ua._applyFilter();
              if (ua.selectedUserId === uid) ua._renderDetail(user);
            }catch(err){
              toast(err.message);
            }
          }
        });
        tbody._iamBound = true;
      }
    };

    // 상세/역할 매핑 UI
    ua._renderDetail = function(user){
      ensureUserRoleDefaults();

      const box = document.getElementById("userAdminDetailBody");
      if (!box) return;

      const roleDefs = (W.roleAdmin && Array.isArray(W.roleAdmin.sampleRoles)) ? W.roleAdmin.sampleRoles : [];
      const curRoles = (W.DBAM_USER_ROLE_MAP[user.id] || ["ROLE_DBAM_USER"]).slice();
      const canEdit  = !!(W.DBAM_AUTHZ.hasPerm && W.DBAM_AUTHZ.hasPerm(P.IAM_USER_ROLE_EDIT));

      // 역할 체크리스트
      const roleItems = roleDefs.length
        ? roleDefs.map(r=>{
            const checked = curRoles.includes(r.id) ? "checked" : "";
            const risk = r.risk || "LOW";
            const riskBg = (risk==="HIGH") ? "#fef2f2" : (risk==="MEDIUM") ? "#fffbeb" : "#ecfdf3";
            const riskFg = (risk==="HIGH") ? "#b91c1c" : (risk==="MEDIUM") ? "#ea580c" : "#16a34a";
            return `
              <label style="display:flex;gap:10px;align-items:flex-start;padding:8px 10px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;">
                <input type="checkbox" class="ua-role-chk" value="${esc(r.id)}" ${checked} ${canEdit ? "" : "disabled"} style="margin-top:3px;"/>
                <div style="flex:1;min-width:0;">
                  <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                    <div style="font-weight:800;font-size:12px;">${esc(r.name)} <span style="font-weight:600;color:#6b7280;">(${esc(r.id)})</span></div>
                    <span style="padding:2px 8px;border-radius:999px;background:${riskBg};color:${riskFg};font-size:11px;font-weight:800;">${esc(risk)}</span>
                  </div>
                  <div style="margin-top:4px;font-size:11px;color:#6b7280;">${esc(r.recommendedFor || "")}</div>
                  <div style="margin-top:4px;font-size:11px;color:#6b7280;">MFA: ${r.mfaRequired ? "필수" : "선택"}</div>
                </div>
              </label>
            `;
          }).join("")
        : `<div style="color:#6b7280;">역할 정의(sampleRoles)가 없습니다.</div>`;

      box.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr;gap:10px;">
          <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;">
            <div style="font-weight:900;font-size:13px;">${esc(user.name)} (${esc(user.id)})</div>
            <div style="margin-top:6px;font-size:12px;color:#6b7280;">
              조직: ${esc(user.dept || "-")} / ${esc(user.team || "-")} / 직급: ${esc(user.title || "-")} / MFA: <b>${esc(user.mfa || "-")}</b>
            </div>
            <div style="margin-top:6px;font-size:12px;color:#6b7280;">
              최근 로그인: ${esc(user.lastLogin || "-")} (${esc(user.lastLoginIp || "")})
            </div>
          </div>

          <div style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
              <div style="font-weight:900;font-size:13px;">역할 매핑</div>
              <div style="display:flex;gap:8px;align-items:center;">
                <button id="uaRoleResetBtn" class="btn" style="padding:6px 10px;" ${canEdit ? "" : "disabled"}>되돌리기</button>
                <button id="uaRoleSaveBtn" class="btn" style="padding:6px 10px;" ${canEdit ? "" : "disabled"}>
                  <i class="fa-solid fa-floppy-disk"></i> 저장
                </button>
              </div>
            </div>

            <div id="uaSodWarn" style="margin-top:8px;font-size:12px;color:#6b7280;"></div>

            <div style="margin-top:10px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;">
              ${roleItems}
            </div>

            ${canEdit ? "" : `<div style="margin-top:8px;font-size:12px;color:#b91c1c;">※ 권한이 없어 편집할 수 없습니다.</div>`}
          </div>
        </div>
      `;

      function readSelected(){
        const chks = Array.from(box.querySelectorAll(".ua-role-chk"));
        return chks.filter(c=>c.checked).map(c=>c.value);
      }
      function renderSodWarn(nextRoles){
        const warnEl = document.getElementById("uaSodWarn");
        if (!warnEl) return;
        const msg = (typeof W.validateSoD === "function") ? W.validateSoD(nextRoles) : null;

        // MFA 필수 역할이 있는데 MFA OFF면 경고
        const mfaRequiredRoles = roleDefs.filter(r => nextRoles.includes(r.id) && r.mfaRequired);
        const mfaWarn = (mfaRequiredRoles.length && user.mfa !== "ON")
          ? `MFA 경고: MFA 필수 역할(${mfaRequiredRoles.map(r=>r.id).join(", ")})이 포함되어 있는데 사용자 MFA가 OFF 입니다.`
          : null;

        const lines = [];
        if (msg) lines.push(`<div style="color:#b91c1c;font-weight:800;">${esc(msg)}</div>`);
        if (mfaWarn) lines.push(`<div style="color:#ea580c;font-weight:800;">${esc(mfaWarn)}</div>`);
        if (!lines.length) lines.push(`<div>SoD/MFA 체크: 이상 없음</div>`);
        warnEl.innerHTML = lines.join("");
      }

      renderSodWarn(curRoles);

      // 체크 변경 시 SoD 즉시 표시
      const chks = Array.from(box.querySelectorAll(".ua-role-chk"));
      chks.forEach(c=>{
        c.addEventListener("change", function(){
          renderSodWarn(readSelected());
        });
      });

      // 되돌리기
      const resetBtn = document.getElementById("uaRoleResetBtn");
      if (resetBtn && !resetBtn._bound){
        resetBtn.addEventListener("click", function(){
          const now = (W.DBAM_USER_ROLE_MAP[user.id] || ["ROLE_DBAM_USER"]).slice();
          chks.forEach(c=>{ c.checked = now.includes(c.value); });
          renderSodWarn(now);
        });
        resetBtn._bound = true;
      }

      // 저장
      const saveBtn = document.getElementById("uaRoleSaveBtn");
      if (saveBtn && !saveBtn._bound){
        saveBtn.addEventListener("click", function(){
          const nextRoles = readSelected();

          try{
            W.DBAM_API.call({
              perm: P.IAM_USER_ROLE_EDIT,
              action: "IAM:UPDATE_USER_ROLES",
              target: user.id,
              detail: `사용자 역할 매핑 저장 (${user.id}) -> ${nextRoles.join(", ")}`,
              fn: function(){
                const msg = (typeof W.validateSoD === "function") ? W.validateSoD(nextRoles) : null;
                if (msg) throw new Error(msg);
                W.DBAM_USER_ROLE_MAP[user.id] = nextRoles.length ? nextRoles : ["ROLE_DBAM_USER"];
              }
            });

            toast("사용자 역할 매핑이 저장되었습니다.");
            ua._applyFilter();
            recomputeAssignedUsers();

            // 역할 화면을 열어둔 상태면(가능한 범위에서) 상세 재렌더링
            if (W.roleAdmin && W.roleAdmin.selectedRoleId) {
              // 필터 재적용을 강제하진 않고, 선택된 상세만 갱신되면 충분
              const role = (W.roleAdmin.sampleRoles || []).find(r=>r.id===W.roleAdmin.selectedRoleId);
              if (role && typeof W.roleAdmin._renderDetail === "function") W.roleAdmin._renderDetail(role);
            }
          }catch(e){
            toast(e.message);
          }
        });
        saveBtn._bound = true;
      }
    };

    ua.__iamPatchedV1 = true;
  })();

  // 끝: 사용자/역할 변경 후 역할 배정 수 맞추기
  recomputeAssignedUsers();
})();

//역할(권한) 관리 end///////////////////////

/* ---------------- Admin: 공용계정 사용 관리 ---------------- */

/**
 * [FIX] 공용계정 사용 관리 (UI + 기능 정합성)
 * - 필터/키워드/목록 tbody id 불일치로 목록이 비거나(=없어 보임), 검색 버튼이 누락되는 문제를 근본 해결
 * - 컨트롤 id: paFilterSystem / paFilterStatus / paFilterKeyword / paSearchBtn / paResetBtn
 * - 목록 tbody id: paAccountTbody (로직과 동일)
 * - 검색은 Enter 또는 [검색] 버튼으로 실행, [초기화]로 필터 리셋
 * - 공용계정 선택(행 클릭) → 상세 패널 동기화
 * - 대여(Checkout)/반납, 비밀번호 변경 요청, 허용 사용자 추가를 프론트 단에서 동작하도록 연결
 */

const publicAccountAdmin = {
  filter: { system: '', status: '', keyword: '' },
  selectedAccountId: null,

  // --- storage keys (필요 시 파일 새로고침해도 유지) ---
  _LS: {
    ACCOUNTS: 'DBAM_PUBLIC_ACCOUNTS_V1',
    GRANTS: 'DBAM_PUBLIC_ACCOUNT_GRANTS_V1',
    USAGE: 'DBAM_PUBLIC_ACCOUNT_USAGE_V1',
    CHECKOUTS: 'DBAM_PUBLIC_ACCOUNT_CHECKOUTS_V1',
    ROTATE_REQ: 'DBAM_PUBLIC_ACCOUNT_ROTATE_REQ_V1'
  },

  // --- seed data ---
  sampleAccounts: [
    { id:'PA-ORA-PROD-DBA',  system:'ORA-PROD', accountName:'oracle',     ownerDept:'DB운영',   purpose:'운영 장애 조치', risk:'HIGH', status:'ACTIVE', rotateCycleDays:30,  lastUsed:'2025-12-18 09:22' },
    { id:'PA-ORA-DEV-APP',   system:'ORA-DEV',  accountName:'app_shared', ownerDept:'플랫폼',   purpose:'배치 점검',     risk:'MED',  status:'ACTIVE', rotateCycleDays:90,  lastUsed:'2025-12-17 16:05' },
    { id:'PA-MY-PROD-ROOT',  system:'MY-PROD',  accountName:'root',       ownerDept:'DB운영',   purpose:'긴급 복구',     risk:'HIGH', status:'LOCKED', rotateCycleDays:30,  lastUsed:'-' },
    { id:'PA-MSSQL-DEV-SA',  system:'MSSQL-DEV',accountName:'sa',         ownerDept:'개발지원', purpose:'테스트 셋업',   risk:'LOW',  status:'ACTIVE', rotateCycleDays:180, lastUsed:'2025-12-12 10:11' },
    { id:'PA-ETC-LEGACY',    system:'LEGACY',   accountName:'shared',     ownerDept:'미지정',   purpose:'레거시 유지보수', risk:'MED', status:'DISABLED', rotateCycleDays:365, lastUsed:'2025-11-30 19:20' }
  ],

  sampleGrants: [
    { accountId:'PA-ORA-PROD-DBA', userId:'u1001', userName:'홍길동', dept:'DB운영',  expiresAt:'2026-01-31' },
    { accountId:'PA-ORA-PROD-DBA', userId:'u1002', userName:'김영희', dept:'보안감사', expiresAt:'2025-12-31' },
    { accountId:'PA-ORA-DEV-APP',  userId:'u2001', userName:'이철수', dept:'플랫폼',  expiresAt:'2026-03-31' }
  ],

  sampleUsage: [
    { ts:'2025-12-18 09:22', accountId:'PA-ORA-PROD-DBA', actor:'홍길동', action:'CHECKOUT', detail:'장애조치(INC-20251218-0012) - 테이블스페이스 확장' },
    { ts:'2025-12-18 10:05', accountId:'PA-ORA-PROD-DBA', actor:'홍길동', action:'RETURN',   detail:'조치 완료' },
    { ts:'2025-12-17 16:05', accountId:'PA-ORA-DEV-APP',  actor:'이철수', action:'CHECKOUT', detail:'배치 점검 - 로그 확인' }
  ],

  sampleCheckouts: [
    // { accountId, actor, reason, startAt, expectedEndAt, returnedAt }
  ],

  sampleRotateReq: [
    // { ts, accountId, requester, reason, status }
  ],

  // ========== entry ==========
  open() {
    const title = document.getElementById('adminTitle');
    if (title) title.innerHTML = '<i class="fa-solid fa-user-shield"></i> 공용계정 사용 관리';

    const desc = document.getElementById('adminDesc');
    if (desc) desc.textContent = '공용계정 상태/허용 사용자/사용 이력을 한 화면에서 관리합니다.';

    // storage load (처음 1회)
    if (!this._loadedOnce) {
      this._loadedOnce = true;
      this._load();
    }

    this.render();
  },

  render() {
    const body = document.getElementById('adminBody');
    if (!body) return;

    const systems = this._uniqueSystems();
    const filtered = this._getFilteredAccounts();
    this._ensureSelected(filtered);
    const stats = this._calcStats(filtered);

    const sysOptions =
      ['<option value="">전체 시스템</option>']
        .concat(
          systems.map((s) => {
            const sel = this.filter.system === s ? ' selected' : '';
            return `<option value="${this._esc(s)}"${sel}>${this._esc(s)}</option>`;
          })
        )
        .join('');

    const statusOptions = [
      { v: '', label: '전체 상태' },
      { v: 'ACTIVE', label: '활성' },
      { v: 'LOCKED', label: '잠금' },
      { v: 'DISABLED', label: '비활성' }
    ]
      .map((o) => {
        const sel = this.filter.status === o.v ? ' selected' : '';
        return `<option value="${this._esc(o.v)}"${sel}>${this._esc(o.label)}</option>`;
      })
      .join('');

    body.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px;flex-wrap:wrap;">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <button type="button" class="btn" id="paNewAccountBtn">
            <i class="fa-solid fa-plus"></i> 공용계정 등록
          </button>
          <button type="button" class="btn" id="paExportBtn">
            <i class="fa-solid fa-file-arrow-down"></i> 이력 내보내기
          </button>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <select id="paFilterSystem" class="select" style="min-width:160px;">${sysOptions}</select>
          <select id="paFilterStatus" class="select" style="min-width:120px;">${statusOptions}</select>
          <input id="paFilterKeyword" class="input" style="min-width:240px;"
            placeholder="계정/용도/담당부서/ID 검색"
            value="${this._esc(this.filter.keyword || '')}" />
          <button type="button" class="btn small" id="paSearchBtn">
            <i class="fa-solid fa-magnifying-glass"></i> 검색
          </button>
          <button type="button" class="btn small" id="paResetBtn">
            <i class="fa-solid fa-rotate-left"></i> 초기화
          </button>
        </div>
      </div>

      <div id="publicAccountAdminLayout" style="display:grid;grid-template-columns:330px 1fr;gap:12px;">
        <!-- LEFT -->
        <div>
          <div class="admin-card">
            <h4><i class="fa-solid fa-chart-simple"></i> 상태 요약</h4>

            <div style="margin-top:6px;display:grid;grid-template-columns:repeat(5, 1fr);gap:8px;">
              <div class="admin-card" style="padding:10px;border-style:dashed;background:#f8fafc;">
                <div style="font-size:11px;color:#6b7280;">전체</div>
                <div style="font-weight:900;font-size:18px;">${stats.total}</div>
              </div>
              <div class="admin-card" style="padding:10px;border-style:dashed;background:#f0fdf4;">
                <div style="font-size:11px;color:#166534;">활성</div>
                <div style="font-weight:900;font-size:18px;">${stats.active}</div>
              </div>
              <div class="admin-card" style="padding:10px;border-style:dashed;background:#fff7ed;">
                <div style="font-size:11px;color:#9a3412;">잠금</div>
                <div style="font-weight:900;font-size:18px;">${stats.locked}</div>
              </div>
              <div class="admin-card" style="padding:10px;border-style:dashed;background:#f1f5f9;">
                <div style="font-size:11px;color:#334155;">비활성</div>
                <div style="font-weight:900;font-size:18px;">${stats.disabled}</div>
              </div>
              <div class="admin-card" style="padding:10px;border-style:dashed;background:#fef2f2;">
                <div style="font-size:11px;color:#991b1b;">HIGH</div>
                <div style="font-weight:900;font-size:18px;">${stats.highRisk}</div>
              </div>
            </div>

            <div style="margin-top:10px;padding:10px;border-radius:10px;border:1px dashed #d1d5db;background:#fff;">
              <div style="font-size:12px;color:#6b7280;">선택 계정</div>
              <div id="paSelectedSummary" style="font-size:12px;margin-top:4px;color:#111827;">-</div>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
              <button type="button" class="btn small" id="paRotateBtnQuick">
                <i class="fa-solid fa-key"></i> 비밀번호 변경 요청
              </button>
              <button type="button" class="btn small" id="paCheckoutBtnQuick">
                <i class="fa-solid fa-right-to-bracket"></i> 대여 시작
              </button>
              <button type="button" class="btn small" id="paReturnBtnQuick">
                <i class="fa-solid fa-right-from-bracket"></i> 반납
              </button>
            </div>

            <div style="margin-top:10px;padding:10px;border-radius:10px;border:1px solid #e5e7eb;background:#f9fafb;">
              <div style="font-size:12px;font-weight:800;margin-bottom:6px;">최근 활동</div>
              <div id="paRecentLog" style="font-size:12px;color:#374151;">-</div>
            </div>
          </div>

          <div class="admin-card" style="margin-top:12px;">
            <h4><i class="fa-solid fa-circle-info"></i> 운영 포인트</h4>
            <ul style="margin:8px 0 0 18px;color:#4b5563;font-size:12px;line-height:1.55;">
              <li>공용계정은 반드시 <b>대여(Checkout)</b>로 실사용자를 식별합니다.</li>
              <li>대여 시작/종료 시점과 사유가 <b>사용 이력</b>에 남습니다.</li>
              <li>비밀번호 변경 요청은 즉시 변경이 아니라 <b>요청→처리</b> 흐름을 가정합니다.</li>
            </ul>
          </div>
        </div>

        <!-- RIGHT -->
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div class="admin-card">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
              <h4 style="margin:0;">
                <i class="fa-solid fa-list"></i> 공용계정 목록
                <span id="paListCountTag" class="tag" style="margin-left:6px;">0</span>
              </h4>
              <div style="display:flex;gap:6px;flex-wrap:wrap;">
                <button type="button" class="btn small" id="paRotateBtnList">
                  <i class="fa-solid fa-key"></i> 비밀번호 변경 요청
                </button>
                <button type="button" class="btn small" id="paAddGrantBtnList">
                  <i class="fa-solid fa-user-plus"></i> 허용 사용자 추가
                </button>
              </div>
            </div>

            <div class="table-scroll-x" style="margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow-x:auto;">
              <table style="width:100%;min-width:860px;border-collapse:collapse;table-layout:fixed;">
                <colgroup>
                  <col style="width:190px;" />
                  <col style="width:120px;" />
                  <col style="width:140px;" />
                  <col style="width:90px;" />
                  <col style="width:80px;" />
                  <col style="width:180px;" />
                  <col style="width:120px;" />
                </colgroup>
                <thead>
                  <tr style="text-align:left;">
                    <th style="padding:10px;border-bottom:1px solid var(--line);font-size:12px;color:var(--muted);">ID</th>
                    <th style="padding:10px;border-bottom:1px solid var(--line);font-size:12px;color:var(--muted);">시스템</th>
                    <th style="padding:10px;border-bottom:1px solid var(--line);font-size:12px;color:var(--muted);">계정</th>
                    <th style="padding:10px;border-bottom:1px solid var(--line);font-size:12px;color:var(--muted);">상태</th>
                    <th style="padding:10px;border-bottom:1px solid var(--line);font-size:12px;color:var(--muted);">위험</th>
                    <th style="padding:10px;border-bottom:1px solid var(--line);font-size:12px;color:var(--muted);">용도</th>
                    <th style="padding:10px;border-bottom:1px solid var(--line);font-size:12px;color:var(--muted);">최근 사용</th>
                  </tr>
                </thead>
                <tbody id="paAccountTbody"></tbody>
              </table>
            </div>
          </div>

          <div class="admin-card">
            <h4 style="margin:0;"><i class="fa-solid fa-magnifying-glass"></i> 상세</h4>
            <div id="paDetailBody" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
    `;

    this._bindEvents();
    this._renderAccountTable();
    this._renderDetail();
    this._renderRecentLog();
  },

  // ========== events ==========
  _bindEvents() {
    const sysSel = document.getElementById('paFilterSystem');
    const stSel  = document.getElementById('paFilterStatus');
    const kw     = document.getElementById('paFilterKeyword');

    if (sysSel) {
      sysSel.addEventListener('change', () => {
        this.filter.system = sysSel.value || '';
        this.render();
      });
    }
    if (stSel) {
      stSel.addEventListener('change', () => {
        this.filter.status = stSel.value || '';
        this.render();
      });
    }

    const doSearch = () => {
      this.filter.keyword = (kw?.value || '').trim();
      this.render();
    };

    const sbtn = document.getElementById('paSearchBtn');
    if (sbtn) sbtn.addEventListener('click', doSearch);

    if (kw) {
      kw.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); doSearch(); }
      });
    }

    const rbtn = document.getElementById('paResetBtn');
    if (rbtn) rbtn.addEventListener('click', () => {
      this.filter = { system:'', status:'', keyword:'' };
      if (sysSel) sysSel.value = '';
      if (stSel) stSel.value = '';
      if (kw) kw.value = '';
      this.render();
    });

    const tbody = document.getElementById('paAccountTbody');
    if (tbody) {
      tbody.addEventListener('click', (e) => {
        const tr = e.target && e.target.closest ? e.target.closest('tr[data-acct-id]') : null;
        if (!tr) return;
        const id = tr.getAttribute('data-acct-id');
        if (!id) return;
        this.selectedAccountId = id;
        this._renderAccountTable();
        this._renderDetail();
        this._renderRecentLog();
      });
    }

    const newBtn = document.getElementById('paNewAccountBtn');
    if (newBtn) newBtn.addEventListener('click', () => {
      const sys = prompt('시스템명을 입력하세요 (예: ORA-PROD)');
      if (!sys) return;
      const acct = prompt('공용계정명을 입력하세요 (예: app_shared)');
      if (!acct) return;

      const id = 'PA-' + sys.replace(/\s+/g,'').toUpperCase() + '-' + acct.replace(/\s+/g,'').toUpperCase();
      this.sampleAccounts.unshift({
        id,
        accountName: acct,
        system: sys,
        ownerDept: '미지정',
        purpose: '신규 등록',
        risk: 'LOW',
        status: 'ACTIVE',
        rotateCycleDays: 90,
        lastUsed: '-'
      });
      this.selectedAccountId = id;
      this._save();
      this.render();
      this._toast('공용계정이 등록되었습니다.');
    });

    const exportBtn = document.getElementById('paExportBtn');
    if (exportBtn) exportBtn.addEventListener('click', () => {
      this._toast('내보내기는 백엔드 연동 후 파일 생성으로 구현하세요. (현재: 화면 동작만 연결)', 'info');
    });

    // 공통 액션 버튼(빠른)
    const rotateQuick = document.getElementById('paRotateBtnQuick');
    if (rotateQuick) rotateQuick.addEventListener('click', () => this._requestRotateFromSelected());

    const checkoutQuick = document.getElementById('paCheckoutBtnQuick');
    if (checkoutQuick) checkoutQuick.addEventListener('click', () => this._checkoutFromSelected());

    const returnQuick = document.getElementById('paReturnBtnQuick');
    if (returnQuick) returnQuick.addEventListener('click', () => this._returnFromSelected());

    // 목록 헤더 버튼
    const rotateBtnList = document.getElementById('paRotateBtnList');
    if (rotateBtnList) rotateBtnList.addEventListener('click', () => this._requestRotateFromSelected());

    const addGrantBtnList = document.getElementById('paAddGrantBtnList');
    if (addGrantBtnList) addGrantBtnList.addEventListener('click', () => this._addGrantFromSelected());
  },

  // ========== render parts ==========
  _renderAccountTable() {
    const tbody = document.getElementById('paAccountTbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    const list = this._getFilteredAccounts();
    this._ensureSelected(list);

    const tag = document.getElementById('paListCountTag');
    if (tag) tag.textContent = String(list.length);

    if (!list.length) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="7" style="padding:14px;color:#6b7280;font-size:12px;">검색 결과가 없습니다.</td>`;
      tbody.appendChild(tr);
      const sumEl = document.getElementById('paSelectedSummary');
      if (sumEl) sumEl.textContent = '-';
      return;
    }

    list.forEach((a) => {
      const isSel = a.id === this.selectedAccountId;
      const statusLabel = (a.status === 'ACTIVE') ? '활성' : (a.status === 'LOCKED' ? '잠금' : '비활성');

      const tr = document.createElement('tr');
      tr.setAttribute('data-acct-id', a.id);
      tr.style.cursor = 'pointer';
      tr.style.borderBottom = '1px solid var(--line)';
      if (isSel) tr.style.background = '#eff6ff';

      tr.innerHTML = `
        <td style="padding:10px;font-weight:800;font-size:12px;">${this._esc(a.id)}</td>
        <td style="padding:10px;font-size:12px;">${this._esc(a.system)}</td>
        <td style="padding:10px;font-size:12px;">${this._esc(a.accountName)}</td>
        <td style="padding:10px;font-size:12px;">${this._esc(statusLabel)}</td>
        <td style="padding:10px;font-size:12px;">${this._esc(a.risk)}</td>
        <td style="padding:10px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${this._esc(a.purpose)}</td>
        <td style="padding:10px;font-size:12px;">${this._esc(a.lastUsed)}</td>
      `;
      tbody.appendChild(tr);
    });

    const sel = this._getAccount(this.selectedAccountId);
    const sumEl = document.getElementById('paSelectedSummary');
    if (sumEl) {
      sumEl.textContent = sel
        ? `${sel.system} / ${sel.accountName} (${sel.status})`
        : '-';
    }
  },

  _renderDetail() {
    const wrap = document.getElementById('paDetailBody');
    if (!wrap) return;

    const a = this._getAccount(this.selectedAccountId);
    if (!a) {
      wrap.innerHTML = '<div style="color:#6b7280;font-size:12px;">선택된 공용계정이 없습니다.</div>';
      return;
    }

    const grants = this.sampleGrants.filter(g => g.accountId === a.id);
    const checkout = this._getCheckout(a.id);
    const rotateReqs = this.sampleRotateReq.filter(r => r.accountId === a.id).slice().reverse().slice(0, 5);
    const usage = this.sampleUsage.filter(u => u.accountId === a.id).slice().reverse().slice(0, 8);

    const statusLabel = (a.status === 'ACTIVE') ? '활성' : (a.status === 'LOCKED' ? '잠금' : '비활성');

    wrap.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="admin-card" style="padding:12px;">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
            <div style="font-weight:900;">기본 정보</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              <button class="btn small" id="paDetailCheckoutBtn"><i class="fa-solid fa-right-to-bracket"></i> 대여</button>
              <button class="btn small" id="paDetailReturnBtn"><i class="fa-solid fa-right-from-bracket"></i> 반납</button>
              <button class="btn small" id="paDetailRotateBtn"><i class="fa-solid fa-key"></i> 변경 요청</button>
            </div>
          </div>

          <div style="margin-top:10px;font-size:12px;line-height:1.6;color:#111827;">
            <div><span style="color:#6b7280;">ID</span> <b>${this._esc(a.id)}</b></div>
            <div><span style="color:#6b7280;">시스템</span> <b>${this._esc(a.system)}</b></div>
            <div><span style="color:#6b7280;">계정</span> <b>${this._esc(a.accountName)}</b></div>
            <div><span style="color:#6b7280;">상태</span> <b>${this._esc(statusLabel)}</b></div>
            <div><span style="color:#6b7280;">위험도</span> <b>${this._esc(a.risk)}</b></div>
            <div><span style="color:#6b7280;">담당부서</span> <b>${this._esc(a.ownerDept)}</b></div>
            <div><span style="color:#6b7280;">용도</span> <b>${this._esc(a.purpose)}</b></div>
            <div><span style="color:#6b7280;">비밀번호 주기</span> <b>${this._esc(String(a.rotateCycleDays))}일</b></div>
          </div>

          <div style="margin-top:10px;padding:10px;border-radius:10px;border:1px solid #e5e7eb;background:#f9fafb;">
            <div style="font-size:12px;font-weight:800;margin-bottom:6px;">대여 상태</div>
            ${
              checkout && !checkout.returnedAt
                ? `<div style="font-size:12px;color:#111827;">
                     <div><span style="color:#6b7280;">사용자</span> <b>${this._esc(checkout.actor)}</b></div>
                     <div><span style="color:#6b7280;">시작</span> <b>${this._esc(checkout.startAt)}</b></div>
                     <div><span style="color:#6b7280;">종료 예정</span> <b>${this._esc(checkout.expectedEndAt || '-')}</b></div>
                     <div style="margin-top:6px;color:#374151;"><span style="color:#6b7280;">사유</span> ${this._esc(checkout.reason)}</div>
                   </div>`
                : `<div style="font-size:12px;color:#6b7280;">대여 중이 아닙니다.</div>`
            }
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn small" id="paToggleLockBtn">${a.status === 'LOCKED' ? '잠금 해제' : '잠금'}</button>
            <button class="btn small" id="paToggleDisableBtn">${a.status === 'DISABLED' ? '활성화' : '비활성화'}</button>
          </div>
        </div>

        <div class="admin-card" style="padding:12px;">
          <div style="font-weight:900;margin-bottom:8px;">허용 사용자</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">
            <button class="btn small" id="paDetailAddGrantBtn"><i class="fa-solid fa-user-plus"></i> 추가</button>
          </div>

          <div style="border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;">
            <div style="max-height:160px;overflow:auto;">
              <table style="width:100%;border-collapse:collapse;table-layout:fixed;">
                <colgroup>
                  <col style="width:120px;" />
                  <col style="width:120px;" />
                  <col style="width:110px;" />
                  <col style="width:70px;" />
                </colgroup>
                <thead>
                  <tr style="text-align:left;background:#f9fafb;">
                    <th style="padding:8px 10px;font-size:12px;color:#6b7280;">사용자</th>
                    <th style="padding:8px 10px;font-size:12px;color:#6b7280;">부서</th>
                    <th style="padding:8px 10px;font-size:12px;color:#6b7280;">만료</th>
                    <th style="padding:8px 10px;font-size:12px;color:#6b7280;">관리</th>
                  </tr>
                </thead>
                <tbody>
                  ${
                    grants.length
                      ? grants.map(g => `
                          <tr style="border-top:1px solid #e5e7eb;">
                            <td style="padding:8px 10px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${this._esc(g.userName)}</td>
                            <td style="padding:8px 10px;font-size:12px;">${this._esc(g.dept)}</td>
                            <td style="padding:8px 10px;font-size:12px;">${this._esc(g.expiresAt)}</td>
                            <td style="padding:8px 10px;">
                              <button class="btn small" data-remove-grant="${this._esc(g.userId)}">삭제</button>
                            </td>
                          </tr>
                        `).join('')
                      : `<tr><td colspan="4" style="padding:10px;color:#6b7280;font-size:12px;">등록된 허용 사용자가 없습니다.</td></tr>`
                  }
                </tbody>
              </table>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div style="font-weight:900;margin-bottom:8px;">비밀번호 변경 요청(최근 5건)</div>
            <div style="border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;background:#fff;">
              <div style="max-height:140px;overflow:auto;">
                <table style="width:100%;border-collapse:collapse;table-layout:fixed;">
                  <colgroup>
                    <col style="width:120px;" />
                    <col style="width:90px;" />
                    <col style="width:1fr;" />
                  </colgroup>
                  <thead>
                    <tr style="text-align:left;background:#f9fafb;">
                      <th style="padding:8px 10px;font-size:12px;color:#6b7280;">시각</th>
                      <th style="padding:8px 10px;font-size:12px;color:#6b7280;">상태</th>
                      <th style="padding:8px 10px;font-size:12px;color:#6b7280;">사유</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${
                      rotateReqs.length
                        ? rotateReqs.map(r => `
                            <tr style="border-top:1px solid #e5e7eb;">
                              <td style="padding:8px 10px;font-size:12px;">${this._esc(r.ts)}</td>
                              <td style="padding:8px 10px;font-size:12px;">${this._esc(r.status)}</td>
                              <td style="padding:8px 10px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${this._esc(r.reason)}</td>
                            </tr>
                          `).join('')
                        : `<tr><td colspan="3" style="padding:10px;color:#6b7280;font-size:12px;">요청 이력이 없습니다.</td></tr>`
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="admin-card" style="margin-top:12px;padding:12px;">
        <div style="font-weight:900;margin-bottom:8px;">사용 이력(최근 8건)</div>
        <div style="border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;background:#fff;">
          <div style="max-height:180px;overflow:auto;">
            <table style="width:100%;border-collapse:collapse;table-layout:fixed;">
              <colgroup>
                <col style="width:120px;" />
                <col style="width:90px;" />
                <col style="width:90px;" />
                <col style="width:1fr;" />
              </colgroup>
              <thead>
                <tr style="text-align:left;background:#f9fafb;">
                  <th style="padding:8px 10px;font-size:12px;color:#6b7280;">시각</th>
                  <th style="padding:8px 10px;font-size:12px;color:#6b7280;">사용자</th>
                  <th style="padding:8px 10px;font-size:12px;color:#6b7280;">유형</th>
                  <th style="padding:8px 10px;font-size:12px;color:#6b7280;">상세</th>
                </tr>
              </thead>
              <tbody>
                ${
                  usage.length
                    ? usage.map(u => `
                        <tr style="border-top:1px solid #e5e7eb;">
                          <td style="padding:8px 10px;font-size:12px;">${this._esc(u.ts)}</td>
                          <td style="padding:8px 10px;font-size:12px;">${this._esc(u.actor)}</td>
                          <td style="padding:8px 10px;font-size:12px;">${this._esc(u.action)}</td>
                          <td style="padding:8px 10px;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${this._esc(u.detail)}</td>
                        </tr>
                      `).join('')
                    : `<tr><td colspan="4" style="padding:10px;color:#6b7280;font-size:12px;">사용 이력이 없습니다.</td></tr>`
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;

    // bind detail actions (single render scope)
    const rotateBtn = document.getElementById('paDetailRotateBtn');
    if (rotateBtn) rotateBtn.addEventListener('click', () => this._requestRotateFromSelected());

    const checkoutBtn = document.getElementById('paDetailCheckoutBtn');
    if (checkoutBtn) checkoutBtn.addEventListener('click', () => this._checkoutFromSelected());

    const returnBtn = document.getElementById('paDetailReturnBtn');
    if (returnBtn) returnBtn.addEventListener('click', () => this._returnFromSelected());

    const addGrantBtn = document.getElementById('paDetailAddGrantBtn');
    if (addGrantBtn) addGrantBtn.addEventListener('click', () => this._addGrantFromSelected());

    const lockBtn = document.getElementById('paToggleLockBtn');
    if (lockBtn) lockBtn.addEventListener('click', () => {
      const acc = this._getAccount(this.selectedAccountId);
      if (!acc) return;
      if (acc.status === 'LOCKED') acc.status = 'ACTIVE';
      else acc.status = 'LOCKED';
      this._save();
      this.render();
      this._toast('상태가 변경되었습니다.');
    });

    const disBtn = document.getElementById('paToggleDisableBtn');
    if (disBtn) disBtn.addEventListener('click', () => {
      const acc = this._getAccount(this.selectedAccountId);
      if (!acc) return;
      if (acc.status === 'DISABLED') acc.status = 'ACTIVE';
      else acc.status = 'DISABLED';
      this._save();
      this.render();
      this._toast('상태가 변경되었습니다.');
    });

    // remove grant
    wrap.querySelectorAll('[data-remove-grant]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const uid = btn.getAttribute('data-remove-grant');
        const acc = this._getAccount(this.selectedAccountId);
        if (!acc || !uid) return;
        const idx = this.sampleGrants.findIndex(g => g.accountId === acc.id && g.userId === uid);
        if (idx >= 0) {
          this.sampleGrants.splice(idx, 1);
          this._save();
          this._renderDetail();
          this._toast('허용 사용자가 삭제되었습니다.');
        }
      });
    });
  },

  _renderRecentLog() {
    const el = document.getElementById('paRecentLog');
    if (!el) return;

    const a = this._getAccount(this.selectedAccountId);
    if (!a) { el.textContent = '-'; return; }

    const u = this.sampleUsage.filter(x => x.accountId === a.id).slice().reverse()[0];
    el.textContent = u ? `${u.ts} / ${u.actor} / ${u.action}` : '-';
  },

  // ========== actions ==========
  _requestRotateFromSelected() {
    const acc = this._getAccount(this.selectedAccountId);
    if (!acc) { this._toast('공용계정을 선택하세요.', 'warn'); return; }

    const reason = prompt('비밀번호 변경 요청 사유를 입력하세요', '정기 변경/보안 점검');
    if (!reason) return;

    const requester = prompt('요청자(이름)를 입력하세요', '관리자');
    if (!requester) return;

    const ts = this._nowStr();
    this.sampleRotateReq.push({ ts, accountId: acc.id, requester, reason, status:'REQUESTED' });
    this.sampleUsage.push({ ts, accountId: acc.id, actor: requester, action:'ROTATE_REQUEST', detail: reason });
    this._save();
    this._renderDetail();
    this._renderRecentLog();
    this._toast('비밀번호 변경 요청이 등록되었습니다.');
  },

  _checkoutFromSelected() {
    const acc = this._getAccount(this.selectedAccountId);
    if (!acc) { this._toast('공용계정을 선택하세요.', 'warn'); return; }
    if (acc.status !== 'ACTIVE') { this._toast('활성 상태에서만 대여할 수 있습니다.', 'warn'); return; }

    const current = this._getCheckout(acc.id);
    if (current && !current.returnedAt) { this._toast('이미 대여 중입니다. 반납 후 다시 시도하세요.', 'warn'); return; }

    const actor = prompt('대여 사용자(이름)를 입력하세요', '홍길동');
    if (!actor) return;

    const reason = prompt('대여 사유를 입력하세요', '운영 점검/장애 조치');
    if (!reason) return;

    const expectedEndAt = prompt('종료 예정(선택) 예: 2025-12-19 18:00', '');
    const startAt = this._nowStr();

    this.sampleCheckouts.push({ accountId: acc.id, actor, reason, startAt, expectedEndAt: (expectedEndAt||''), returnedAt:'' });
    this.sampleUsage.push({ ts: startAt, accountId: acc.id, actor, action:'CHECKOUT', detail: reason });
    acc.lastUsed = startAt;
    this._save();
    this._renderDetail();
    this._renderAccountTable();
    this._renderRecentLog();
    this._toast('대여가 시작되었습니다.');
  },

  _returnFromSelected() {
    const acc = this._getAccount(this.selectedAccountId);
    if (!acc) { this._toast('공용계정을 선택하세요.', 'warn'); return; }

    const cur = this._getCheckout(acc.id);
    if (!cur || cur.returnedAt) { this._toast('대여 중이 아닙니다.', 'warn'); return; }

    const actor = prompt('반납 처리자(이름)를 입력하세요', cur.actor || '관리자');
    if (!actor) return;

    const reason = prompt('반납 사유(선택)', '조치 완료');
    const ts = this._nowStr();

    cur.returnedAt = ts;
    this.sampleUsage.push({ ts, accountId: acc.id, actor, action:'RETURN', detail: (reason||'반납') });
    this._save();
    this._renderDetail();
    this._renderRecentLog();
    this._toast('반납 처리되었습니다.');
  },

  _addGrantFromSelected() {
    const acc = this._getAccount(this.selectedAccountId);
    if (!acc) { this._toast('공용계정을 선택하세요.', 'warn'); return; }

    const name = prompt('추가할 사용자 이름을 입력하세요 (예: 홍길동)');
    if (!name) return;

    const dept = prompt('부서를 입력하세요 (예: DB운영)', '부서 미지정') || '부서 미지정';
    const exp = prompt('만료일을 입력하세요 (YYYY-MM-DD)', '2026-01-31');
    if (!exp) return;

    // 결정적 순번
    this.__grantSeq = (this.__grantSeq || 1000) + 1;
    const uid = 'u' + this.__grantSeq;

    this.sampleGrants.push({
      accountId: acc.id,
      userId: uid,
      userName: name,
      dept,
      expiresAt: exp
    });

    this._save();
    this._renderDetail();
    this._toast('허용 사용자가 추가되었습니다.');
  },

  // ========== helpers ==========
  _getCheckout(accountId) {
    return this.sampleCheckouts.find(c => c.accountId === accountId) || null;
  },

  _getAccount(id) {
    if (!id) return null;
    return this.sampleAccounts.find(a => a.id === id) || null;
  },

  _uniqueSystems() {
    const set = new Set(this.sampleAccounts.map(a => a.system).filter(Boolean));
    return Array.from(set).sort((a,b)=>a.localeCompare(b));
  },

  _getFilteredAccounts() {
    const sys = (this.filter.system || '').trim();
    const st = (this.filter.status || '').trim();
    const kw = (this.filter.keyword || '').trim().toLowerCase();

    return this.sampleAccounts
      .filter(a => !sys || a.system === sys)
      .filter(a => !st || a.status === st)
      .filter(a => {
        if (!kw) return true;
        const hay = [
          a.id, a.system, a.accountName, a.ownerDept, a.purpose, a.risk, a.status
        ].map(x => (x || '').toString().toLowerCase()).join(' ');
        return hay.includes(kw);
      })
      .slice()
      .sort((a,b) => a.id.localeCompare(b.id));
  },

  _ensureSelected(list) {
    if (!list || !list.length) { this.selectedAccountId = null; return; }
    if (!this.selectedAccountId || !list.some(a => a.id === this.selectedAccountId)) {
      this.selectedAccountId = list[0].id;
    }
  },

  _calcStats(list) {
    const all = Array.isArray(list) ? list : [];
    return {
      total: all.length,
      active: all.filter(a => a.status === 'ACTIVE').length,
      locked: all.filter(a => a.status === 'LOCKED').length,
      disabled: all.filter(a => a.status === 'DISABLED').length,
      highRisk: all.filter(a => (a.risk || '').toUpperCase() === 'HIGH').length
    };
  },

  _nowStr() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  },

  _esc(v) {
    return String(v ?? '').replace(/[&<>"']/g, (m) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  },

  _toast(msg, type) {
    // toast가 전역에 있으면 사용 (없으면 자체 토스트)
    try {
      if (typeof window.toast === 'function') { window.toast(msg, type); return; }
    } catch(e){}

    const id = 'paToastContainer';
    let box = document.getElementById(id);
    if (!box) {
      box = document.createElement('div');
      box.id = id;
      box.style.position = 'fixed';
      box.style.right = '16px';
      box.style.bottom = '16px';
      box.style.zIndex = '99999';
      box.style.display = 'flex';
      box.style.flexDirection = 'column';
      box.style.gap = '8px';
      document.body.appendChild(box);
    }

    const item = document.createElement('div');
    item.style.padding = '10px 12px';
    item.style.borderRadius = '10px';
    item.style.border = '1px solid rgba(0,0,0,0.12)';
    item.style.background = '#111827';
    item.style.color = '#fff';
    item.style.fontSize = '12px';
    item.style.boxShadow = '0 8px 18px rgba(0,0,0,0.18)';
    item.textContent = msg;

    box.appendChild(item);
    setTimeout(() => { item.style.opacity = '0'; item.style.transition = 'opacity .2s ease'; }, 1600);
    setTimeout(() => { try { item.remove(); } catch(e){} }, 1900);
  },

  _load() {
    const safeParse = (v, fallback) => {
      try { const x = JSON.parse(v); return Array.isArray(x) ? x : fallback; } catch(e){ return fallback; }
    };

    try {
      const a = localStorage.getItem(this._LS.ACCOUNTS);
      const g = localStorage.getItem(this._LS.GRANTS);
      const u = localStorage.getItem(this._LS.USAGE);
      const c = localStorage.getItem(this._LS.CHECKOUTS);
      const r = localStorage.getItem(this._LS.ROTATE_REQ);

      if (a) this.sampleAccounts = safeParse(a, this.sampleAccounts);
      if (g) this.sampleGrants = safeParse(g, this.sampleGrants);
      if (u) this.sampleUsage = safeParse(u, this.sampleUsage);
      if (c) this.sampleCheckouts = safeParse(c, this.sampleCheckouts);
      if (r) this.sampleRotateReq = safeParse(r, this.sampleRotateReq);
    } catch(e) {
      // localStorage 접근 불가 환경이면 무시
    }
  },

  _save() {
    try {
      localStorage.setItem(this._LS.ACCOUNTS, JSON.stringify(this.sampleAccounts));
      localStorage.setItem(this._LS.GRANTS, JSON.stringify(this.sampleGrants));
      localStorage.setItem(this._LS.USAGE, JSON.stringify(this.sampleUsage));
      localStorage.setItem(this._LS.CHECKOUTS, JSON.stringify(this.sampleCheckouts));
      localStorage.setItem(this._LS.ROTATE_REQ, JSON.stringify(this.sampleRotateReq));
    } catch(e) {
      // localStorage 접근 불가 환경이면 무시
    }
  }
};

// 전역 노출
window.publicAccountAdmin = publicAccountAdmin;

/* ---------------- Admin: 공용계정 사용 관리 end ---------------- */

/* ---------------- Admin: 정기 권한 검토 ---------------- */

const regularReviewAdmin = {
  filter: { cycle: '', status: '', keyword: '' },

  // 하드코딩 샘플 데이터 (원하는대로 수정)
  sampleReviews: [
    { id: 'RR-2025Q4-001', cycle: '분기', period: '2025 Q4', target: '디지털개발센터', owner: '김부서장', status: 'PLANNED', due: '2025-12-20' },
    { id: 'RR-2025Q4-002', cycle: '분기', period: '2025 Q4', target: 'IT운영센터', owner: '박부서장', status: 'IN_PROGRESS', due: '2025-12-18' },
    { id: 'RR-2025M12-003', cycle: '월간', period: '2025-12', target: '정보보안실', owner: '윤감사', status: 'DELAYED', due: '2025-12-10' },
    { id: 'RR-2025M11-004', cycle: '월간', period: '2025-11', target: '데이터플랫폼팀', owner: '최팀장', status: 'DONE', due: '2025-11-30' }
  ],


  // 2) 화면 열기
  open() {
    const ov = document.getElementById('adminOverlay');
    if (ov) {
      ov.classList.add('show');
      ov.setAttribute('aria-hidden', 'false');
    }

    // 좌측 네비 active 를 orgUser로 맞춤
    document.querySelectorAll('.admin-nav button[data-section]').forEach((btn) => {
      btn.classList.toggle('active', btn.dataset.section === 'orgUser');
    });

    const title = document.getElementById('adminTitle');
    if (title) title.innerHTML = '<i class="fa-solid fa-clipboard-check"></i> 정기 권한 검토';

    const desc = document.getElementById('adminDesc');
    if (desc) desc.textContent = '부서/시스템 단위로 주기적 권한 검토를 진행하고 상태를 관리합니다. (정적 데이터, 화면 흐름만 구현)';

    this.render();
  },

  // 3) 렌더링
  render() {
    const body = document.getElementById('adminBody');
    if (!body) return;

    const filtered = this._getFilteredReviews();
    const stats = this._calcStats(filtered);

    const cycleOptions = [
      { v: '', label: '전체 주기' },
      { v: '월간', label: '월간' },
      { v: '분기', label: '분기' }
    ].map(o => {
      const sel = this.filter.cycle === o.v ? ' selected' : '';
      return `<option value="${this._esc(o.v)}"${sel}>${this._esc(o.label)}</option>`;
    }).join('');

    const statusOptions = [
      { v: '', label: '전체 상태' },
      { v: 'PLANNED', label: '예정' },
      { v: 'IN_PROGRESS', label: '진행중' },
      { v: 'DELAYED', label: '지연' },
      { v: 'DONE', label: '완료' }
    ].map(o => {
      const sel = this.filter.status === o.v ? ' selected' : '';
      return `<option value="${this._esc(o.v)}"${sel}>${this._esc(o.label)}</option>`;
    }).join('');

    const rows = filtered.map(r => {
      const badge = this._statusBadge(r.status);
      const btnLabel = (r.status === 'PLANNED') ? '검토 시작'
                    : (r.status === 'IN_PROGRESS') ? '완료 처리'
                    : (r.status === 'DELAYED') ? '재개'
                    : '보기';

      const action = (r.status === 'DONE') ? 'view' : 'toggle';

      return `
        <tr>
          <td style="font-weight:600;">${this._esc(r.id)}</td>
          <td>${this._esc(r.target)}</td>
          <td>${this._esc(r.period)} (${this._esc(r.cycle)})</td>
          <td>${badge}</td>
          <td>${this._esc(r.owner)}</td>
          <td style="text-align:right;">
            <button class="btn btn-ghost" data-rr-action="${action}" data-rr-id="${this._esc(r.id)}">${this._esc(btnLabel)}</button>
          </td>
        </tr>
      `;
    }).join('');

    body.innerHTML = `
      <div class="card" style="margin-bottom:10px;">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="card-title-icon">RR</span>
              검토 현황
            </div>
            <div class="card-desc">주기별 검토 건을 간단히 집계합니다.</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;padding:10px;">
          ${this._statTile('예정', stats.PLANNED, '#f1f5f9', '#64748b')}
          ${this._statTile('진행중', stats.IN_PROGRESS, '#ecfeff', '#0e7490')}
          ${this._statTile('지연', stats.DELAYED, '#fff7ed', '#c2410c')}
          ${this._statTile('완료', stats.DONE, '#f0fdf4', '#16a34a')}
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="card-title-icon warn">LS</span>
              검토 목록
            </div>
            <div class="card-desc">조건을 바꿔가며 목록을 확인할 수 있습니다.</div>
          </div>

          <div class="card-toolbar" style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
            <select id="rr_filter_cycle" class="input" style="max-width:140px;">${cycleOptions}</select>
            <select id="rr_filter_status" class="input" style="max-width:140px;">${statusOptions}</select>
            <input id="rr_filter_keyword" class="input" style="max-width:220px;" placeholder="부서/담당자/ID 검색" value="${this._esc(this.filter.keyword)}" />
          </div>
        </div>

        <div style="padding:10px;">
          <table style="width:100%;border-collapse:collapse;font-size:12px;background:#fff;">
            <thead>
              <tr style="background:#f9fafb;">
                <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">검토 ID</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">대상</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">기간</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">상태</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid #e5e7eb;">담당</th>
                <th style="text-align:right;padding:8px;border-bottom:1px solid #e5e7eb;">조치</th>
              </tr>
            </thead>
            <tbody>
              ${rows || `<tr><td colspan="6" style="padding:12px;color:#64748b;">조건에 맞는 항목이 없습니다.</td></tr>`}
            </tbody>
          </table>

          <div class="hint" style="margin-top:8px;">
            ※ 버튼은 상태만 바꾸는 수준으로 연결되어 있습니다. (실제 결재/회수/ITSM 연계는 이후 단계)
          </div>
        </div>
      </div>
    `;

    this._bindEventsOnce();
  },

  _bindEventsOnce() {
    const body = document.getElementById('adminBody');
    if (!body) return;
    if (body.dataset.rrBound === '1') return;
    body.dataset.rrBound = '1';

    const self = this;

    body.addEventListener('change', function (e) {
      const t = e.target;
      if (!t) return;
      if (t.id === 'rr_filter_cycle') {
        self.filter.cycle = t.value || '';
        self.render();
      }
      if (t.id === 'rr_filter_status') {
        self.filter.status = t.value || '';
        self.render();
      }
    });

    body.addEventListener('input', function (e) {
      const t = e.target;
      if (!t) return;
      if (t.id === 'rr_filter_keyword') {
        self.filter.keyword = t.value || '';
        self.render();
      }
    });

    body.addEventListener('click', function (e) {
      const btn = e.target && e.target.closest ? e.target.closest('[data-rr-action]') : null;
      if (!btn) return;

      const action = btn.getAttribute('data-rr-action');
      const id = btn.getAttribute('data-rr-id');
      if (!id) return;

      if (action === 'view') {
        alert('검토 결과/이력 보기: ' + id + '\n(이력 상세는 이후 단계에서 연결)');
        return;
      }

      if (action === 'toggle') {
        self._toggleStatus(id);
        self.render();
        return;
      }
    });
  },

  _toggleStatus(id) {
    const idx = this.sampleReviews.findIndex(x => x.id === id);
    if (idx < 0) return;

    const cur = this.sampleReviews[idx].status;
    let next = cur;

    if (cur === 'PLANNED') next = 'IN_PROGRESS';
    else if (cur === 'IN_PROGRESS') next = 'DONE';
    else if (cur === 'DELAYED') next = 'IN_PROGRESS';
    else next = 'DONE';

    this.sampleReviews[idx].status = next;

    const msg =
      (next === 'IN_PROGRESS') ? '검토를 시작했습니다.'
    : (next === 'DONE') ? '완료 처리되었습니다.'
    : '상태가 변경되었습니다.';

    alert(msg + `\n(${id} → ${this._statusLabel(next)})`);
  },

  _getFilteredReviews() {
    const kw = (this.filter.keyword || '').trim().toLowerCase();
    return this.sampleReviews.filter(r => {
      if (this.filter.cycle && r.cycle !== this.filter.cycle) return false;
      if (this.filter.status && r.status !== this.filter.status) return false;
      if (!kw) return true;

      const hay = (r.id + ' ' + r.target + ' ' + r.owner + ' ' + r.period).toLowerCase();
      return hay.indexOf(kw) >= 0;
    });
  },

  _calcStats(list) {
    const s = { PLANNED: 0, IN_PROGRESS: 0, DELAYED: 0, DONE: 0 };
    list.forEach(x => { if (s[x.status] != null) s[x.status]++; });
    return s;
  },

  _statusLabel(st) {
    if (st === 'PLANNED') return '예정';
    if (st === 'IN_PROGRESS') return '진행중';
    if (st === 'DELAYED') return '지연';
    if (st === 'DONE') return '완료';
    return st;
  },

  _statusBadge(st) {
    const label = this._statusLabel(st);
    if (st === 'PLANNED') return `<span class="tag-soft" style="border-color:#cbd5e1;color:#475569;background:#f1f5f9;">${label}</span>`;
    if (st === 'IN_PROGRESS') return `<span class="tag-soft" style="border-color:#67e8f9;color:#0e7490;background:#ecfeff;">${label}</span>`;
    if (st === 'DELAYED') return `<span class="tag-soft warn">${label}</span>`;
    if (st === 'DONE') return `<span class="tag-soft ok">${label}</span>`;
    return `<span class="tag-soft">${this._esc(label)}</span>`;
  },

  _statTile(label, value, bg, color) {
    return `
      <div style="min-width:140px;flex:1;padding:10px;border-radius:12px;border:1px solid #e5e7eb;background:${bg};">
        <div style="font-size:12px;color:${color};font-weight:700;">${this._esc(label)}</div>
        <div style="margin-top:4px;font-size:18px;font-weight:800;color:#0f172a;">${value}</div>
      </div>
    `;
  },

  _esc(s) {
    return String(s == null ? '' : s)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }
};

window.regularReviewAdmin = regularReviewAdmin;

/* ---------------- Admin: 정기 권한 검토 end ---------------- */

/* =========================================================
 * [PATCH] orgUser 카드 클릭 라우팅 연결 (Final / Single Router)
 * - admin.show()가 호출하는 openItem(sectionId, itemId, label) 시그니처 지원
 * - sectionId::itemId 우선 → 없으면 itemId fallback
 * - orgUser 5개(조직/사용자/역할/공용계정/정기검토) 핸들러 등록
 * ========================================================= */
(() => {
  const W = window;
  const A = W.admin;
  if (!A) return;

  // 1) handler store
  A.__itemHandlers = A.__itemHandlers || {};

  // 2) registerItemHandler: (itemId, fn) 또는 (sectionId, itemId, fn) 둘 다 지원
  if (!A.registerItemHandler || !A.registerItemHandler.__dbamCompat) {
    const prev = A.registerItemHandler;
    A.registerItemHandler = function (p1, p2, p3) {
      let sectionId = null, itemId = null, fn = null;

      // (itemId, fn)
      if (typeof p1 === "string" && typeof p2 === "function" && p3 === undefined) {
        itemId = p1; fn = p2;
      } else {
        // (sectionId, itemId, fn)
        sectionId = p1; itemId = p2; fn = p3;
      }

      if (typeof itemId !== "string" || typeof fn !== "function") return false;

      // 섹션키 우선 등록 + itemId fallback 등록(기존 코드 호환)
      if (sectionId) this.__itemHandlers[`${sectionId}::${itemId}`] = fn;
      this.__itemHandlers[itemId] = fn;
      return true;
    };
    A.registerItemHandler.__dbamCompat = true;
    A.registerItemHandler.__prev = prev;
  }

  // 3) openItem: sectionId::itemId → itemId 순서로 dispatch
  if (!A.openItem || !A.openItem.__dbamCompat) {
    const prev = A.openItem;
    A.openItem = function (a, b, c) {
      const hasSections = !!this.sections;

      // admin.show()는 openItem(sectionId, itemId, label)로 호출
      const aIsSection = (typeof a === "string" && hasSections && this.sections[a]);
      const sectionId = aIsSection ? a :
        ((typeof b === "string" && hasSections && this.sections[b]) ? b : null);
      const itemId = aIsSection ? b : a;

      const key = (sectionId && itemId) ? `${sectionId}::${itemId}` : null;

      const fn =
        (key && this.__itemHandlers && this.__itemHandlers[key]) ||
        (this.__itemHandlers && this.__itemHandlers[itemId]);

      if (typeof fn === "function") {
        try { return fn({ sectionId, itemId, label: c }); }
        catch (e) { console.warn("[admin.openItem] handler error:", e); return false; }
      }

      // 마지막 fallback
      if (typeof prev === "function" && prev !== this.openItem) {
        try { return prev.call(this, a, b, c); } catch (e) {}
      }

      console.warn("[admin.openItem] handler 없음:", { sectionId, itemId, a, b, c });
      return false;
    };
    A.openItem.__dbamCompat = true;
  }

  // 4) orgUser 5개 핸들러 등록(중복 등록 방지)
  if (!A.__orgUserHandlersBound) {
    A.__orgUserHandlersBound = true;

    A.registerItemHandler("orgUser", "org", () => {
      if (W.orgChartAdmin && typeof W.orgChartAdmin.openOrgView === "function") return W.orgChartAdmin.openOrgView();
      if (W.adminOrgDemo && typeof W.adminOrgDemo.openOrgView === "function") return W.adminOrgDemo.openOrgView();
      toast("조직도 모듈이 아직 로드되지 않았습니다.");
    });

    A.registerItemHandler("orgUser", "user", () => {
      if (W.userAdmin && typeof W.userAdmin.open === "function") return W.userAdmin.open();
      toast("사용자 관리 모듈이 아직 로드되지 않았습니다.");
    });

    A.registerItemHandler("orgUser", "role", () => {
      if (W.roleAdmin && typeof W.roleAdmin.open === "function") return W.roleAdmin.open();
      toast("역할(권한) 관리 모듈이 아직 로드되지 않았습니다.");
    });

    A.registerItemHandler("orgUser", "publicAccount", () => {
      if (W.publicAccountAdmin && typeof W.publicAccountAdmin.open === "function") return W.publicAccountAdmin.open();
      toast("공용계정 사용 관리 모듈이 아직 로드되지 않았습니다.");
    });

    A.registerItemHandler("orgUser", "regularReview", () => {
      if (W.regularReviewAdmin && typeof W.regularReviewAdmin.open === "function") return W.regularReviewAdmin.open();
      toast("정기 권한 검토 모듈이 아직 로드되지 않았습니다.");
    });
  }
})();



/* ---------------- Admin: 권한 신청/변경/회수 요청 (권한 신청·변경·회수 > 권한 신청/변경/회수 요청) ---------------- */

const accessRequestAdmin = {
  // 간단 샘플(하드코딩)
  sampleRequests: [
    { id: 'AR-2025-001', type: '신청', target: 'DEV / ERP_READ', requester: '홍길동', dept: '정보보안실', status: '결재대기', createdAt: '2025-12-10', itsm: 'CHG-10421', reason: '업무상 조회 필요' },
    { id: 'AR-2025-002', type: '변경', target: 'PRD / FIN_WRITE', requester: '김태규', dept: 'IT운영팀', status: '결재중', createdAt: '2025-12-11', itsm: 'REQ-88210', reason: '권한 범위 조정' },
    { id: 'AR-2025-003', type: '회수', target: 'OPS / DBA_TEMP', requester: '김감사', dept: '감사팀', status: '승인', createdAt: '2025-12-12', itsm: '', reason: '프로젝트 종료' }
  ],

  state: {
    approvers: [],
    filterType: 'ALL',
    filterStatus: 'ALL',
    keyword: ''
  },

  attachAccessRequestCardHandler() {
    const bodyEl = document.getElementById('adminBody');
    if (!bodyEl) return;

    const cards = Array.from(bodyEl.querySelectorAll('.admin-card'));
    const target = cards.find(card => {
      const h4 = card.querySelector('h4');
      return h4 && h4.textContent.includes('권한 신청/변경/회수 요청');
    });

    if (!target) return;
    if (target.dataset.accessRequestBound === '1') return;

    target.dataset.accessRequestBound = '1';
    target.classList.add('admin-card-clickable');

    // 안내 문구도 이 카드 목적에 맞게 살짝 변경(원하면 삭제해도 됨)
    const footer = target.querySelector('.admin-footer');
    if (footer) footer.textContent = '요청서 작성/상신 및 이력 확인';

    target.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      this.open();
    });
  },

  open() {
    // 좌측 메뉴 active 처리(기존 admin.show 로직과 동일 패턴) :contentReference[oaicite:4]{index=4}
    try {
      if (window.admin) admin.current = 'accessLifecycle';
      const buttons = document.querySelectorAll('.admin-nav button');
      buttons.forEach(btn => {
        if (btn.dataset.section === 'accessLifecycle') btn.classList.add('active');
        else btn.classList.remove('active');
      });
    } catch (e) {}

    const titleEl = document.getElementById('adminTitle');
    const descEl  = document.getElementById('adminDesc');
    const bodyEl  = document.getElementById('adminBody');
    if (!titleEl || !descEl || !bodyEl) return;

    titleEl.innerHTML = '<i class="fa-solid fa-paper-plane"></i> 권한 신청/변경/회수 요청';
    descEl.textContent = '권한 요청서를 작성하고 상태 흐름(상신/결재/승인)을 화면에서 확인합니다.';

    bodyEl.innerHTML = this.getTemplateHtml();
    this.bindOnce();
    this.renderList();
  },

  getTemplateHtml() {
    return `
      <div style="display:flex; flex-direction:column; gap:12px;">
        <div class="admin-card" style="padding:14px;">
          <h4 style="margin:0 0 6px 0;"><i class="fa-solid fa-file-signature"></i> 요청서 작성</h4>
          <p style="margin:0 0 10px 0; color:#6b7280; font-size:13px;">
            유형/대상/사유/결재선을 입력하고 요청을 등록합니다.
          </p>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div>
              <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">요청 유형</div>
              <select id="arType" class="input" style="width:100%;">
                <option value="신청">신청</option>
                <option value="변경">변경</option>
                <option value="회수">회수</option>
              </select>
            </div>

            <div>
              <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">ITSM 티켓(선택)</div>
              <input id="arItsm" class="input" style="width:100%;" placeholder="예) REQ-12345 / CHG-00001" />
            </div>

            <div>
              <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">대상 시스템/권한</div>
              <input id="arTarget" class="input" style="width:100%;" placeholder="예) DEV / ERP_READ" />
            </div>

            <div>
              <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">결재선(간단)</div>
              <div style="display:flex; gap:8px;">
                <input id="arApprovers" class="input" style="width:100%;" placeholder="결재선 미지정" readonly />
                <button id="arPickApprover" class="btn" type="button" style="white-space:nowrap;">지정</button>
              </div>
            </div>

            <div style="grid-column:1 / -1;">
              <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">사유</div>
              <textarea id="arReason" class="input" style="width:100%; min-height:70px;" placeholder="요청 사유를 간단히 입력"></textarea>
            </div>
          </div>

          <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
            <button id="arReset" class="btn" type="button">초기화</button>
            <button id="arSubmit" class="btn primary" type="button">요청 등록</button>
          </div>
        </div>

        <div class="admin-card" style="padding:14px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px;">
            <div>
              <h4 style="margin:0 0 6px 0;"><i class="fa-solid fa-list-check"></i> 요청 이력</h4>
              <div style="color:#6b7280; font-size:13px;">
                조회 결과 <b id="arCount">0</b>건
              </div>
            </div>

            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
              <select id="arFilterType" class="input" style="min-width:120px;">
                <option value="ALL">유형(전체)</option>
                <option value="신청">신청</option>
                <option value="변경">변경</option>
                <option value="회수">회수</option>
              </select>
              <select id="arFilterStatus" class="input" style="min-width:140px;">
                <option value="ALL">상태(전체)</option>
                <option value="결재대기">결재대기</option>
                <option value="결재중">결재중</option>
                <option value="승인">승인</option>
                <option value="반려">반려</option>
                <option value="취소">취소</option>
              </select>
              <input id="arKeyword" class="input" style="min-width:220px;" placeholder="검색(요청자/대상/티켓)" />
            </div>
          </div>

          <div style="margin-top:10px; overflow:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
              <thead>
                <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
                  <th style="padding:8px 6px;">ID</th>
                  <th style="padding:8px 6px;">유형</th>
                  <th style="padding:8px 6px;">대상</th>
                  <th style="padding:8px 6px;">요청자</th>
                  <th style="padding:8px 6px;">상태</th>
                  <th style="padding:8px 6px;">ITSM</th>
                  <th style="padding:8px 6px;">등록일</th>
                  <th style="padding:8px 6px; width:160px;">동작</th>
                </tr>
              </thead>
              <tbody id="arTbody"></tbody>
            </table>
          </div>

          <div style="margin-top:10px; color:#6b7280; font-size:12px;">
            ※ “동작” 버튼은 화면에서 상태 흐름을 확인하는 수준으로만 구성되어 있습니다.
          </div>
        </div>
      </div>
    `;
  },

  bindOnce() {
    const bodyEl = document.getElementById('adminBody');
    if (!bodyEl) return;
    if (bodyEl.dataset.arBound === '1') return;
    bodyEl.dataset.arBound = '1';

    bodyEl.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      if (btn.id === 'arPickApprover') {
        this.pickApprovers();
      } else if (btn.id === 'arReset') {
        this.resetForm();
      } else if (btn.id === 'arSubmit') {
        this.submitRequest();
      } else if (btn.dataset.action === 'view') {
        this.viewRequest(btn.dataset.id);
      } else if (btn.dataset.action === 'next') {
        this.advanceStatus(btn.dataset.id);
      } else if (btn.dataset.action === 'cancel') {
        this.setStatus(btn.dataset.id, '취소');
      }
    });

    bodyEl.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'arFilterType') {
        this.state.filterType = e.target.value;
        this.renderList();
      }
      if (e.target && e.target.id === 'arFilterStatus') {
        this.state.filterStatus = e.target.value;
        this.renderList();
      }
    });

    bodyEl.addEventListener('input', (e) => {
      if (e.target && e.target.id === 'arKeyword') {
        this.state.keyword = (e.target.value || '').trim();
        this.renderList();
      }
    });
  },

  pickApprovers() {
    const current = this.state.approvers.join(', ');
    const input = prompt('결재자 이름을 쉼표(,)로 구분해서 입력하세요.', current);
    if (input === null) return;

    const list = input.split(',')
      .map(s => s.trim())
      .filter(Boolean);

    this.state.approvers = list;

    const approverEl = document.getElementById('arApprovers');
    if (approverEl) {
      approverEl.value = list.length ? list.join(' > ') : '';
      if (!list.length) approverEl.placeholder = '결재선 미지정';
    }
  },

  resetForm() {
    const typeEl = document.getElementById('arType');
    const itsmEl = document.getElementById('arItsm');
    const targetEl = document.getElementById('arTarget');
    const reasonEl = document.getElementById('arReason');
    const apprEl = document.getElementById('arApprovers');

    if (typeEl) typeEl.value = '신청';
    if (itsmEl) itsmEl.value = '';
    if (targetEl) targetEl.value = '';
    if (reasonEl) reasonEl.value = '';
    this.state.approvers = [];
    if (apprEl) {
      apprEl.value = '';
      apprEl.placeholder = '결재선 미지정';
    }
  },

  submitRequest() {
    const typeEl = document.getElementById('arType');
    const itsmEl = document.getElementById('arItsm');
    const targetEl = document.getElementById('arTarget');
    const reasonEl = document.getElementById('arReason');

    const type = typeEl ? typeEl.value : '신청';
    const itsm = itsmEl ? itsmEl.value.trim() : '';
    const target = targetEl ? targetEl.value.trim() : '';
    const reason = reasonEl ? reasonEl.value.trim() : '';

    if (!target) {
      alert('대상 시스템/권한을 입력하세요.');
      return;
    }
    if (!reason) {
      alert('사유를 입력하세요.');
      return;
    }
    if (!this.state.approvers.length) {
      alert('결재선을 지정하세요.');
      return;
    }

    const today = new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth() + 1).padStart(2, '0');
    const d = String(today.getDate()).padStart(2, '0');
    const createdAt = `${y}-${m}-${d}`;

    const seq = String(this.sampleRequests.length + 1).padStart(3, '0');
    const id = `AR-${y}-${seq}`;

    this.sampleRequests.unshift({
      id,
      type,
      target,
      requester: '현재사용자',
      dept: '요청부서',
      status: '결재대기',
      createdAt,
      itsm,
      reason,
      approvers: this.state.approvers.slice()
    });

    this.resetForm();
    this.renderList();
    alert('요청이 등록되었습니다.');
  },

  getFilteredList() {
    let list = this.sampleRequests.slice();

    if (this.state.filterType !== 'ALL') {
      list = list.filter(x => x.type === this.state.filterType);
    }
    if (this.state.filterStatus !== 'ALL') {
      list = list.filter(x => x.status === this.state.filterStatus);
    }
    if (this.state.keyword) {
      const q = this.state.keyword.toLowerCase();
      list = list.filter(x =>
        (x.requester || '').toLowerCase().includes(q) ||
        (x.target || '').toLowerCase().includes(q) ||
        (x.itsm || '').toLowerCase().includes(q)
      );
    }
    return list;
  },

  renderList() {
    const tbody = document.getElementById('arTbody');
    const countEl = document.getElementById('arCount');
    if (!tbody || !countEl) return;

    const list = this.getFilteredList();
    countEl.textContent = String(list.length);

    tbody.innerHTML = list.map(row => {
      const badge = this.renderStatusBadge(row.status);
      return `
        <tr style="border-bottom:1px solid #f3f4f6;">
          <td style="padding:8px 6px; font-weight:600;">${row.id}</td>
          <td style="padding:8px 6px;">${row.type}</td>
          <td style="padding:8px 6px;">${row.target}</td>
          <td style="padding:8px 6px;">${row.requester}<div style="color:#9ca3af; font-size:12px;">${row.dept || ''}</div></td>
          <td style="padding:8px 6px;">${badge}</td>
          <td style="padding:8px 6px;">${row.itsm || '-'}</td>
          <td style="padding:8px 6px;">${row.createdAt}</td>
          <td style="padding:8px 6px;">
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="btn" type="button" data-action="view" data-id="${row.id}">보기</button>
              <button class="btn" type="button" data-action="next" data-id="${row.id}">다음상태</button>
              <button class="btn" type="button" data-action="cancel" data-id="${row.id}">취소</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  },

  renderStatusBadge(status) {
    const map = {
      '결재대기': { bg:'#fff7ed', fg:'#9a3412' },
      '결재중':   { bg:'#eff6ff', fg:'#1d4ed8' },
      '승인':     { bg:'#ecfdf5', fg:'#047857' },
      '반려':     { bg:'#fef2f2', fg:'#b91c1c' },
      '취소':     { bg:'#f3f4f6', fg:'#374151' }
    };
    const c = map[status] || { bg:'#f3f4f6', fg:'#374151' };
    return `<span style="display:inline-block; padding:3px 8px; border-radius:999px; background:${c.bg}; color:${c.fg}; font-size:12px; font-weight:600;">${status}</span>`;
  },

  findById(id) {
    return this.sampleRequests.find(x => x.id === id);
  },

  viewRequest(id) {
    const row = this.findById(id);
    if (!row) return;

    const approvers = (row.approvers && row.approvers.length) ? row.approvers.join(' > ') : '(미지정)';
    alert(
      `[${row.id}]\n` +
      `유형: ${row.type}\n` +
      `대상: ${row.target}\n` +
      `요청자: ${row.requester} / ${row.dept}\n` +
      `상태: ${row.status}\n` +
      `ITSM: ${row.itsm || '-'}\n` +
      `결재선: ${approvers}\n\n` +
      `사유: ${row.reason || ''}`
    );
  },

  advanceStatus(id) {
    const row = this.findById(id);
    if (!row) return;

    const flow = ['결재대기', '결재중', '승인'];
    if (row.status === '반려' || row.status === '취소') {
      alert('이미 종료된 요청입니다.');
      return;
    }

    const idx = flow.indexOf(row.status);
    row.status = (idx === -1) ? '결재대기' : flow[Math.min(idx + 1, flow.length - 1)];
    this.renderList();
  },

  setStatus(id, status) {
    const row = this.findById(id);
    if (!row) return;
    row.status = status;
    this.renderList();
  }
};

window.accessRequestAdmin = accessRequestAdmin;
/* ---------------- Admin: 권한 신청/변경/회수 요청 (권한 신청·변경·회수 > 권한 신청/변경/회수 요청) end---------------- */

/* accessLifecycle 섹션에서 카드 클릭 바인딩 (orgUser 패치와 동일한 방식) */
(function patchAdminShowForAccessLifecycle() {
  if (!window.admin || typeof admin.show !== 'function') return;
  if (admin.__accessLifecyclePatched) return;
  admin.__accessLifecyclePatched = true;

  const originalShow = admin.show.bind(admin);

  admin.show = function(section) {
    originalShow(section);

    if (section === 'accessLifecycle') {
      try {
        if (window.accessRequestAdmin &&
            typeof accessRequestAdmin.attachAccessRequestCardHandler === 'function') {
          accessRequestAdmin.attachAccessRequestCardHandler();
        }
      } catch (e) {
        console.warn('accessRequest 카드 바인딩 오류', e);
      }
      
      try {
          if (window.dbAccountLifecycleAdmin &&
              typeof dbAccountLifecycleAdmin.attachDbAccountLifecycleCardHandler === 'function') {
            dbAccountLifecycleAdmin.attachDbAccountLifecycleCardHandler();
          }
        } catch (e) {
          console.warn('dbAccountLifecycle 카드 바인딩 오류', e);
        }
      
        try {
            if (window.emergencyAccessAdmin &&
                typeof emergencyAccessAdmin.attachEmergencyAccessCardHandler === 'function') {
              emergencyAccessAdmin.attachEmergencyAccessCardHandler();
            }
          } catch (e) {
            console.warn('emergencyAccess 카드 바인딩 오류', e);
          }        
        
    }
  };
})();
/* accessLifecycle 섹션에서 카드 클릭 바인딩 (orgUser 패치와 동일한 방식) end */

/* ---------------- Admin: DB 계정 발급/변경/삭제 요청 (권한 신청·변경·회수 > DB 계정 발급/변경/삭제 요청) ---------------- */

const dbAccountLifecycleAdmin = {
  // 간단 샘플(하드코딩)
  sampleRequests: [
    { id: 'DBA-2025-001', type: '발급', system: 'DEV', account: 'APP_USER01', role: 'ERP_READ', requester: '홍길동', dept: 'IT운영팀', status: '결재대기', createdAt: '2025-12-10', itsm: 'REQ-90211', reason: '신규 프로젝트 투입' },
    { id: 'DBA-2025-002', type: '변경', system: 'PRD', account: 'BATCH_USER', role: 'FIN_WRITE', requester: '김태규', dept: 'IT운영팀', status: '결재중', createdAt: '2025-12-11', itsm: 'CHG-11421', reason: '권한 범위 확장' },
    { id: 'DBA-2025-003', type: '삭제', system: 'OPS', account: 'TEMP_DBA', role: 'DBA_TEMP', requester: '김감사', dept: '감사팀', status: '승인', createdAt: '2025-12-12', itsm: '', reason: '사용 종료' }
  ],

  state: {
    approvers: [],
    filterType: 'ALL',
    filterStatus: 'ALL',
    keyword: ''
  },

  attachDbAccountLifecycleCardHandler() {
    const bodyEl = document.getElementById('adminBody');
    if (!bodyEl) return;

    const cards = Array.from(bodyEl.querySelectorAll('.admin-card'));
    const target = cards.find(card => {
      const h4 = card.querySelector('h4');
      return h4 && h4.textContent.includes('DB 계정 발급/변경/삭제 요청');
    });

    if (!target) return;
    if (target.dataset.dbAccountLifecycleBound === '1') return;

    target.dataset.dbAccountLifecycleBound = '1';
    target.classList.add('admin-card-clickable');

    const footer = target.querySelector('.admin-footer');
    if (footer) footer.textContent = '요청서 작성/상신 및 이력 확인';

    target.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      this.open();
    });
  },

  open() {
    // 좌측 메뉴 active 처리(accessRequestAdmin과 동일 패턴)
    try {
      if (window.admin) admin.current = 'accessLifecycle';
      const buttons = document.querySelectorAll('.admin-nav button');
      buttons.forEach(btn => {
        if (btn.dataset.section === 'accessLifecycle') btn.classList.add('active');
        else btn.classList.remove('active');
      });
    } catch (e) {}

    const titleEl = document.getElementById('adminTitle');
    const descEl  = document.getElementById('adminDesc');
    const bodyEl  = document.getElementById('adminBody');
    if (!titleEl || !descEl || !bodyEl) return;

    titleEl.innerHTML = '<i class="fa-solid fa-database"></i> DB 계정 발급/변경/삭제 요청';
    descEl.textContent = '계정 발급/변경/삭제 요청서를 작성하고 상태 흐름을 화면에서 확인합니다.';

    bodyEl.innerHTML = this.getTemplateHtml();
    this.bindOnce();
    this.renderList();
  },

  getTemplateHtml() {
    return `
      <div style="display:flex; flex-direction:column; gap:12px;">
        <div class="admin-card" style="padding:14px;">
          <h4 style="margin:0 0 6px 0;"><i class="fa-solid fa-file-signature"></i> 요청서 작성</h4>
          <p style="margin:0 0 10px 0; color:#6b7280; font-size:13px;">
            유형/시스템/계정/권한/사유/결재선을 입력하고 요청을 등록합니다.
          </p>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div>
              <label style="display:block; font-size:12px; color:#4b5563; font-weight:700; margin-bottom:4px;">요청 유형</label>
              <select id="dbaType" class="export-input" style="width:100%;">
                <option value="발급">발급</option>
                <option value="변경">변경</option>
                <option value="삭제">삭제</option>
              </select>
            </div>

            <div>
              <label style="display:block; font-size:12px; color:#4b5563; font-weight:700; margin-bottom:4px;">시스템</label>
              <select id="dbaSystem" class="export-input" style="width:100%;">
                <option value="DEV">DEV</option>
                <option value="QA">QA</option>
                <option value="PRD">PRD</option>
                <option value="OPS">OPS</option>
              </select>
            </div>

            <div>
              <label style="display:block; font-size:12px; color:#4b5563; font-weight:700; margin-bottom:4px;">계정명</label>
              <input id="dbaAccount" class="export-input" style="width:100%;" placeholder="예) APP_USER01" />
            </div>

            <div>
              <label style="display:block; font-size:12px; color:#4b5563; font-weight:700; margin-bottom:4px;">권한/롤</label>
              <input id="dbaRole" class="export-input" style="width:100%;" placeholder="예) ERP_READ" />
            </div>

            <div style="grid-column: 1 / span 2;">
              <label style="display:block; font-size:12px; color:#4b5563; font-weight:700; margin-bottom:4px;">사유</label>
              <input id="dbaReason" class="export-input" style="width:100%;" placeholder="예) 프로젝트 투입으로 신규 발급 필요" />
            </div>

            <div>
              <label style="display:block; font-size:12px; color:#4b5563; font-weight:700; margin-bottom:4px;">ITSM 티켓</label>
              <input id="dbaItsm" class="export-input" style="width:100%;" placeholder="예) REQ-12345" />
            </div>

            <div>
              <label style="display:block; font-size:12px; color:#4b5563; font-weight:700; margin-bottom:4px;">결재선</label>
              <div style="display:flex; gap:8px;">
                <input id="dbaApprovers" class="export-input" style="flex:1;" placeholder="결재자 선택" readonly />
                <button type="button" class="btn" id="dbaPickApprover">선택</button>
              </div>
            </div>
          </div>

          <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
            <button type="button" class="btn" id="dbaReset">초기화</button>
            <button type="button" class="btn primary" id="dbaSubmit">요청 등록</button>
          </div>
        </div>

        <div class="admin-card" style="padding:14px;">
          <h4 style="margin:0 0 6px 0;"><i class="fa-solid fa-list-check"></i> 요청 이력</h4>

          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <div style="display:flex; align-items:center; gap:6px;">
              <span style="font-size:12px; color:#4b5563; font-weight:700;">유형</span>
              <select id="dbaFilterType" class="export-input">
                <option value="ALL">전체</option>
                <option value="발급">발급</option>
                <option value="변경">변경</option>
                <option value="삭제">삭제</option>
              </select>
            </div>

            <div style="display:flex; align-items:center; gap:6px;">
              <span style="font-size:12px; color:#4b5563; font-weight:700;">상태</span>
              <select id="dbaFilterStatus" class="export-input">
                <option value="ALL">전체</option>
                <option value="결재대기">결재대기</option>
                <option value="결재중">결재중</option>
                <option value="승인">승인</option>
                <option value="반려">반려</option>
                <option value="취소">취소</option>
              </select>
            </div>

            <div style="flex:1; min-width:240px;">
              <input id="dbaKeyword" class="export-input" style="width:100%;" placeholder="검색(요청자/계정/티켓)" />
            </div>
          </div>

          <div style="margin-top:10px; overflow:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
              <thead>
                <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
                  <th style="padding:8px 6px;">ID</th>
                  <th style="padding:8px 6px;">유형</th>
                  <th style="padding:8px 6px;">시스템</th>
                  <th style="padding:8px 6px;">계정</th>
                  <th style="padding:8px 6px;">권한</th>
                  <th style="padding:8px 6px;">요청자</th>
                  <th style="padding:8px 6px;">상태</th>
                  <th style="padding:8px 6px;">ITSM</th>
                  <th style="padding:8px 6px;">등록일</th>
                  <th style="padding:8px 6px; width:160px;">동작</th>
                </tr>
              </thead>
              <tbody id="dbaTbody"></tbody>
            </table>
          </div>

          <div style="margin-top:10px; color:#6b7280; font-size:12px;">
            ※ “동작” 버튼은 상태 흐름을 확인하는 수준으로만 구성되어 있습니다.
          </div>
        </div>
      </div>
    `;
  },

  bindOnce() {
    const bodyEl = document.getElementById('adminBody');
    if (!bodyEl) return;
    if (bodyEl.dataset.dbaBound === '1') return;
    bodyEl.dataset.dbaBound = '1';

    bodyEl.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;

      if (btn.id === 'dbaPickApprover') {
        this.pickApprovers();
      } else if (btn.id === 'dbaReset') {
        this.resetForm();
      } else if (btn.id === 'dbaSubmit') {
        this.submitRequest();
      } else if (btn.dataset.action === 'view') {
        this.viewRequest(btn.dataset.id);
      } else if (btn.dataset.action === 'next') {
        this.advanceStatus(btn.dataset.id);
      } else if (btn.dataset.action === 'cancel') {
        this.setStatus(btn.dataset.id, '취소');
      }
    });

    bodyEl.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'dbaFilterType') {
        this.state.filterType = e.target.value;
        this.renderList();
      }
      if (e.target && e.target.id === 'dbaFilterStatus') {
        this.state.filterStatus = e.target.value;
        this.renderList();
      }
    });

    bodyEl.addEventListener('input', (e) => {
      if (e.target && e.target.id === 'dbaKeyword') {
        this.state.keyword = (e.target.value || '').trim();
        this.renderList();
      }
    });
  },

  pickApprovers() {
    const current = this.state.approvers.join(', ');
    const input = prompt('결재자 이름을 쉼표(,)로 구분해서 입력하세요.', current);
    if (input === null) return;

    const list = input.split(',')
      .map(s => s.trim())
      .filter(Boolean);

    this.state.approvers = list;

    const box = document.getElementById('dbaApprovers');
    if (box) box.value = list.join(' > ');
  },

  resetForm() {
    const t = document.getElementById('dbaType');
    const s = document.getElementById('dbaSystem');
    const a = document.getElementById('dbaAccount');
    const r = document.getElementById('dbaRole');
    const reason = document.getElementById('dbaReason');
    const itsm = document.getElementById('dbaItsm');
    const ap = document.getElementById('dbaApprovers');

    if (t) t.value = '발급';
    if (s) s.value = 'DEV';
    if (a) a.value = '';
    if (r) r.value = '';
    if (reason) reason.value = '';
    if (itsm) itsm.value = '';

    this.state.approvers = [];
    if (ap) ap.value = '';
  },

  submitRequest() {
    const typeEl = document.getElementById('dbaType');
    const sysEl = document.getElementById('dbaSystem');
    const accEl = document.getElementById('dbaAccount');
    const roleEl = document.getElementById('dbaRole');
    const reasonEl = document.getElementById('dbaReason');
    const itsmEl = document.getElementById('dbaItsm');

    const type = typeEl ? typeEl.value : '';
    const system = sysEl ? sysEl.value : '';
    const account = (accEl ? accEl.value : '').trim();
    const role = (roleEl ? roleEl.value : '').trim();
    const reason = (reasonEl ? reasonEl.value : '').trim();
    const itsm = (itsmEl ? itsmEl.value : '').trim();

    if (!account) { alert('계정명을 입력하세요.'); return; }
    if (!role) { alert('권한/롤을 입력하세요.'); return; }
    if (!reason) { alert('사유를 입력하세요.'); return; }

    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const createdAt = `${yyyy}-${mm}-${dd}`;

    const seq = String(this.sampleRequests.length + 1).padStart(3, '0');
    const id = `DBA-${yyyy}-${seq}`;

    this.sampleRequests.unshift({
      id,
      type,
      system,
      account,
      role,
      requester: window.DBAM_CURRENT_USER || '사용자',
      dept: 'IT운영팀',
      status: '결재대기',
      createdAt,
      itsm,
      reason,
      approvers: (this.state.approvers || []).slice()
    });

    alert('요청이 등록되었습니다.\n(실제 ITSM 연동은 서버 연결 후 구현)');
    this.resetForm();
    this.renderList();
  },

  renderStatusBadge(status) {
    const map = {
      '결재대기': { bg:'#fff7ed', fg:'#9a3412' },
      '결재중':   { bg:'#eff6ff', fg:'#1d4ed8' },
      '승인':     { bg:'#ecfdf5', fg:'#047857' },
      '반려':     { bg:'#fef2f2', fg:'#b91c1c' },
      '취소':     { bg:'#f3f4f6', fg:'#374151' }
    };
    const c = map[status] || { bg:'#f3f4f6', fg:'#374151' };
    return `<span style="display:inline-block; padding:3px 8px; border-radius:999px; background:${c.bg}; color:${c.fg}; font-size:12px; font-weight:600;">${this._esc(status)}</span>`;
  },

  _esc(s) {
    return String(s == null ? '' : s)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  },

  findById(id) {
    return this.sampleRequests.find(x => x.id === id);
  },

  viewRequest(id) {
    const row = this.findById(id);
    if (!row) return;
    const approvers = (row.approvers && row.approvers.length) ? row.approvers.join(' > ') : '(미지정)';
    alert(
      `[${row.id}]\n` +
      `유형: ${row.type}\n` +
      `시스템: ${row.system}\n` +
      `계정: ${row.account}\n` +
      `권한: ${row.role}\n` +
      `요청자: ${row.requester} / ${row.dept}\n` +
      `상태: ${row.status}\n` +
      `ITSM: ${row.itsm || '-'}\n` +
      `결재선: ${approvers}\n\n` +
      `사유: ${row.reason || ''}`
    );
  },

  advanceStatus(id) {
    const row = this.findById(id);
    if (!row) return;

    const flow = ['결재대기', '결재중', '승인'];
    if (row.status === '반려' || row.status === '취소') {
      alert('이미 종료된 요청입니다.');
      return;
    }

    const idx = flow.indexOf(row.status);
    row.status = (idx === -1) ? '결재대기' : flow[Math.min(idx + 1, flow.length - 1)];
    this.renderList();
  },

  setStatus(id, status) {
    const row = this.findById(id);
    if (!row) return;
    row.status = status;
    this.renderList();
  },

  renderList() {
    const tbody = document.getElementById('dbaTbody');
    if (!tbody) return;

    const ft = this.state.filterType || 'ALL';
    const fs = this.state.filterStatus || 'ALL';
    const kw = (this.state.keyword || '').trim().toLowerCase();

    let list = (this.sampleRequests || []).slice();

    if (ft !== 'ALL') list = list.filter(x => x.type === ft);
    if (fs !== 'ALL') list = list.filter(x => x.status === fs);

    if (kw) {
      list = list.filter(x => {
        const hay = `${x.requester || ''} ${x.account || ''} ${x.itsm || ''}`.toLowerCase();
        return hay.indexOf(kw) >= 0;
      });
    }

    tbody.innerHTML = '';
    list.forEach(row => {
      const tr = document.createElement('tr');
      tr.style.borderBottom = '1px solid #eef2f7';

      const td = (html) => {
        const cell = document.createElement('td');
        cell.style.padding = '8px 6px';
        cell.innerHTML = html;
        return cell;
      };

      tr.appendChild(td(this._esc(row.id)));
      tr.appendChild(td(this._esc(row.type)));
      tr.appendChild(td(this._esc(row.system)));
      tr.appendChild(td(this._esc(row.account)));
      tr.appendChild(td(this._esc(row.role)));
      tr.appendChild(td(this._esc(row.requester)));
      tr.appendChild(td(this.renderStatusBadge(row.status)));
      tr.appendChild(td(this._esc(row.itsm || '-')));
      tr.appendChild(td(this._esc(row.createdAt || '-')));

      const actionHtml = `
        <div style="display:flex; gap:6px;">
          <button type="button" class="btn" data-action="view" data-id="${this._esc(row.id)}">보기</button>
          <button type="button" class="btn" data-action="next" data-id="${this._esc(row.id)}">다음</button>
          <button type="button" class="btn" data-action="cancel" data-id="${this._esc(row.id)}">취소</button>
        </div>
      `;
      tr.appendChild(td(actionHtml));

      tbody.appendChild(tr);
    });
  }
};

window.dbAccountLifecycleAdmin = dbAccountLifecycleAdmin;

/* ---------------- Admin: DB 계정 발급/변경/삭제 요청 end ---------------- */

/* ---------------- Admin: 응급(장애) 권한 요청·사용 이력 (권한 신청·변경·회수 > 응급(장애) 권한 요청·사용 이력) start ---------------- */

const emergencyAccessAdmin = {
  // 하드코딩 데이터 (간단 시나리오용)
  requests: [
    {
      id: 'EA-2025-001',
      incident: 'INC-20251212-0001',
      system: 'ERP',
      account: 'erp_dba_emg',
      role: 'DBA(긴급)',
      requester: '홍길동',
      dept: '운영관리팀',
      hours: 2,
      status: '승인',
      createdAt: '2025-12-12 09:05'
    },
    {
      id: 'EA-2025-002',
      incident: 'INC-20251212-0007',
      system: 'DW',
      account: 'dw_ops_emg',
      role: 'OPS(긴급)',
      requester: '김지수',
      dept: '데이터플랫폼팀',
      hours: 4,
      status: '결재대기',
      createdAt: '2025-12-12 09:12'
    }
  ],
  usage: [
    {
      id: 'EAU-0001',
      reqId: 'EA-2025-001',
      at: '2025-12-12 09:10',
      actor: 'dba01',
      action: 'CONNECT',
      detail: '긴급 권한 세션 생성'
    },
    {
      id: 'EAU-0002',
      reqId: 'EA-2025-001',
      at: '2025-12-12 09:13',
      actor: 'dba01',
      action: 'QUERY',
      detail: '장애 확인 쿼리 실행'
    }
  ],

  state: {
    filterStatus: 'ALL',
    filterText: '',
    selectedReqId: 'EA-2025-001'
  },

  _bound: false,

  _esc(v){
    if(v == null) return '';
    return String(v)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  },

  // 카드 클릭 이벤트 연결 (accessRequestAdmin 방식과 동일하게: 타이틀로 카드 찾고 1회만 바인딩)
  attachEmergencyAccessCardHandler(){
    const CARD_TITLE = '응급(장애) 권한 요청·사용 이력';

    const cards = document.querySelectorAll('.admin-card');
    if(!cards || !cards.length) return;

    cards.forEach((card)=>{
      const h4 = card.querySelector('h4');
      const title = h4 ? (h4.textContent || '').trim() : '';
      if(title.indexOf(CARD_TITLE) === -1) return;

      if(card.dataset.emergencyAccessBound === '1') return;
      card.dataset.emergencyAccessBound = '1';

      // 다른 카드들과 동일한 “클릭 가능한 카드” 처리(hover 스타일은 공통 CSS에서 이미 처리됨)
      card.classList.add('clickable');
      card.setAttribute('role','button');
      card.tabIndex = 0;

      const open = ()=>{ try{ this.open(); }catch(e){ console.warn('emergencyAccess open error', e); } };

      card.addEventListener('click', (e)=>{ e.preventDefault(); open(); });
      card.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' '){
          e.preventDefault(); open();
        }
      });
    });
  },

  open(){
    // 사이드바/섹션은 accessLifecycle 그대로 두고, 본문만 교체하는 패턴(다른 카드들과 동일)
    try{
      if (window.admin && typeof admin._activateNav === 'function'){
        admin._activateNav('accessLifecycle');
      }
    }catch(e){}

    const titleEl = document.getElementById('adminTitle');
    const descEl  = document.getElementById('adminDesc');
    const bodyEl  = document.getElementById('adminBody');

    if(titleEl){
      titleEl.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> 응급(장애) 권한 요청·사용 이력`;
    }
    if(descEl){
      descEl.textContent = '장애 상황에서의 긴급 권한 요청/승인/종료 흐름과 사용 로그를 간단히 확인합니다.';
    }
    if(bodyEl){
      bodyEl.innerHTML = this.getTemplateHtml();
    }

    this.bindOnce();
    this.renderAll();
  },

  getTemplateHtml(){
	  return `
	  <div class="emg-page">
	    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(360px, 1fr)); gap:10px; align-items:start;">

	      <!-- LEFT -->
	      <div style="min-width:0; display:flex; flex-direction:column; gap:10px;">

	        <div class="admin-card" style="padding:12px 14px;">
	          <div class="admin-header">
	            <h2><i class="fa-solid fa-bolt"></i> 응급 권한 요청</h2>
	            <span class="badge">요청</span>
	          </div>

	          <div style="display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:8px; margin-top:10px;">
	            <div style="min-width:0;">
	              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">장애번호</div>
	              <input id="eaIncident" class="export-input" placeholder="INC-YYYYMMDD-0001" style="width:100%; min-width:0;" />
	            </div>

	            <div style="min-width:0;">
	              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">시스템</div>
	              <select id="eaSystem" class="export-input" style="width:100%; min-width:0;">
	                <option value="ERP">ERP</option>
	                <option value="DW">DW</option>
	                <option value="CRM">CRM</option>
	                <option value="ETC">ETC</option>
	              </select>
	            </div>

	            <div style="min-width:0;">
	              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">대상 계정</div>
	              <input id="eaAccount" class="export-input" placeholder="ex) erp_dba_emg" style="width:100%; min-width:0;" />
	            </div>

	            <div style="min-width:0;">
	              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">권한(역할)</div>
	              <select id="eaRole" class="export-input" style="width:100%; min-width:0;">
	                <option value="DBA(긴급)">DBA(긴급)</option>
	                <option value="OPS(긴급)">OPS(긴급)</option>
	                <option value="READONLY(긴급)">READONLY(긴급)</option>
	              </select>
	            </div>

	            <div style="min-width:0;">
	              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">유효시간(시간)</div>
	              <input id="eaHours" class="export-input" type="number" min="1" max="24" value="2" style="width:100%; min-width:0;" />
	            </div>

	            <div style="min-width:0;">
	              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">요청자</div>
	              <input id="eaRequester" class="export-input" placeholder="ex) 홍길동" style="width:100%; min-width:0;" />
	            </div>

	            <div style="grid-column:1 / -1; min-width:0;">
	              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">사유</div>
	              <input id="eaReason" class="export-input" placeholder="ex) 장애 원인 분석을 위한 긴급 권한 필요" style="width:100%; min-width:0;" />
	            </div>
	          </div>

	          <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px; flex-wrap:wrap;">
	            <button class="btn" data-ea-act="reset">초기화</button>
	            <button class="btn primary" data-ea-act="submit">
	              <i class="fa-solid fa-paper-plane"></i> 요청 등록
	            </button>
	          </div>
	        </div>

	        <div class="admin-card" style="padding:12px 14px;">
	          <div class="admin-header">
	            <h2><i class="fa-solid fa-list"></i> 요청 목록</h2>
	            <span class="badge" id="eaReqCount">0건</span>
	          </div>

	          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
	            <select id="eaFilterStatus" class="export-input" style="max-width:140px;">
	              <option value="ALL">전체</option>
	              <option value="결재대기">결재대기</option>
	              <option value="결재중">결재중</option>
	              <option value="승인">승인</option>
	              <option value="종료">종료</option>
	              <option value="반려">반려</option>
	            </select>

	            <input id="eaFilterText" class="export-input"
	                   placeholder="검색(계정/시스템/요청자/장애번호)"
	                   style="flex:1; min-width:220px;" />
	          </div>

	          <div style="overflow:auto; margin-top:10px; border:1px solid #e5e7eb; border-radius:8px;">
	            <table style="width:100%; border-collapse:collapse; font-size:12px;">
	              <thead>
	                <tr style="background:#f8fafc; color:#334155;">
	                  <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">요청ID</th>
	                  <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">장애번호</th>
	                  <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">시스템</th>
	                  <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">계정</th>
	                  <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">상태</th>
	                  <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">조치</th>
	                </tr>
	              </thead>
	              <tbody id="eaReqTbody"></tbody>
	            </table>
	          </div>

	          <div class="admin-footer">행 클릭 시 오른쪽 사용 이력이 해당 요청으로 필터됩니다.</div>
	        </div>

	      </div>

	      <!-- RIGHT -->
	      <div style="min-width:0; display:flex; flex-direction:column; gap:10px;">

	        <div class="admin-card" style="padding:12px 14px;">
	          <div class="admin-header">
	            <h2><i class="fa-solid fa-clock-rotate-left"></i> 사용 이력</h2>
	            <span class="badge" id="eaUsageCount">0건</span>
	          </div>

	          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px; min-width:0;">
	            <div style="font-size:12px; color:var(--muted);">선택 요청:</div>
	            <div id="eaSelectedInfo" style="font-weight:600; min-width:0; max-width:360px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">-</div>
	            <div style="flex:1;"></div>
	            <button class="btn" data-ea-act="add-log" style="white-space:nowrap;"><i class="fa-solid fa-plus"></i> 사용 로그 추가</button>
	            <button class="btn" data-ea-act="append-sql" style="white-space:nowrap;"><i class="fa-solid fa-code"></i> SQL 템플릿</button>
	          </div>

	          <div style="overflow:auto; margin-top:10px; border:1px solid #e5e7eb; border-radius:8px;">
	            <table style="width:100%; border-collapse:collapse; font-size:12px;">
	              <thead>
	                <tr style="background:#f8fafc; color:#334155;">
	                  <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">시간</th>
	                  <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">사용자</th>
	                  <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">행위</th>
	                  <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">내용</th>
	                </tr>
	              </thead>
	              <tbody id="eaUsageTbody"></tbody>
	            </table>
	          </div>

	          <div class="admin-footer">“사용 로그 추가”는 화면 확인을 위한 간단한 추가 동작입니다.</div>
	        </div>

	        <div class="admin-card" style="padding:12px 14px;">
	          <div class="admin-header">
	            <h2><i class="fa-solid fa-circle-info"></i> 흐름 요약</h2>
	            <span class="badge">안내</span>
	          </div>

	          <ul class="emg-flow" style="list-style:none; padding:0; margin:10px 0 0; display:flex; flex-direction:column; gap:6px;">
	            <li style="display:flex; gap:8px; align-items:flex-start;">
	              <span class="no">①</span>
	              <span>요청 등록 → ② 상태 진행(결재대기→결재중→승인)</span>
	            </li>
	            <li style="display:flex; gap:8px; align-items:flex-start;">
	              <span class="no">③</span>
	              <span>사용 로그 기록 → ④ 종료/반려 처리</span>
	            </li>
	          </ul>
	        </div>

	      </div>
	    </div>
	  </div>
	  `;
	},


  bindOnce(){
    if(this._bound) return;
    this._bound = true;

    const body = document.getElementById('adminBody');
    if(!body) return;

    // 클릭 이벤트(버튼/행 선택) - event delegation
    body.addEventListener('click', (e)=>{
      const actBtn = e.target.closest('[data-ea-act]');
      if(actBtn){
        const act = actBtn.getAttribute('data-ea-act');
        const id  = actBtn.getAttribute('data-id');

        if(act === 'submit'){ this.submit(); return; }
        if(act === 'reset'){ this.resetForm(); return; }
        if(act === 'advance' && id){ this.advanceStatus(id); return; }
        if(act === 'close' && id){ this.setStatus(id, '종료'); return; }
        if(act === 'reject' && id){ this.setStatus(id, '반려'); return; }
        if(act === 'add-log'){ this.addLog(); return; }
        if(act === 'append-sql'){ this.appendSqlTemplate(); return; }
      }

      const tr = e.target.closest('tr[data-ea-id]');
      if(tr && tr.parentElement && tr.parentElement.id === 'eaReqTbody'){
        const rid = tr.getAttribute('data-ea-id');
        if(rid){ this.setSelected(rid); }
      }
    });

    // 필터 입력
    body.addEventListener('change', (e)=>{
      if(e.target && e.target.id === 'eaFilterStatus'){
        this.state.filterStatus = e.target.value || 'ALL';
        this.renderAll();
      }
    });

    body.addEventListener('input', (e)=>{
      if(e.target && e.target.id === 'eaFilterText'){
        this.state.filterText = e.target.value || '';
        this.renderAll();
      }
    });
  },

  resetForm(){
    const ids = ['eaIncident','eaSystem','eaAccount','eaRole','eaHours','eaRequester','eaReason'];
    ids.forEach((id)=>{
      const el = document.getElementById(id);
      if(!el) return;
      if(el.tagName === 'SELECT'){
        el.selectedIndex = 0;
      }else if(el.type === 'number'){
        el.value = '2';
      }else{
        el.value = '';
      }
    });
  },

  submit(){
    const incident   = (document.getElementById('eaIncident')?.value || '').trim();
    const system     = (document.getElementById('eaSystem')?.value || '').trim();
    const account    = (document.getElementById('eaAccount')?.value || '').trim();
    const role       = (document.getElementById('eaRole')?.value || '').trim();
    const hoursRaw   = (document.getElementById('eaHours')?.value || '2').trim();
    const requester  = (document.getElementById('eaRequester')?.value || '').trim();
    const reason     = (document.getElementById('eaReason')?.value || '').trim();

    if(!incident || !account || !requester){
      alert('장애번호/대상 계정/요청자는 필수입니다.');
      return;
    }

    const nextNo = String(this.requests.length + 1).padStart(3,'0');
    const id = `EA-2025-${nextNo}`;
    const now = new Date();
    const createdAt = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

    this.requests.unshift({
      id,
      incident,
      system: system || 'ETC',
      account,
      role: role || 'DBA(긴급)',
      requester,
      dept: '미지정',
      hours: Math.max(1, Math.min(24, parseInt(hoursRaw,10) || 2)),
      status: '결재대기',
      createdAt,
      reason
    });

    this.state.selectedReqId = id;
    this.renderAll();
    alert('응급 권한 요청이 등록되었습니다.');
  },

  findReq(id){
    return (this.requests || []).find(r=>r.id===id) || null;
  },

  setSelected(id){
    this.state.selectedReqId = id;
    this.renderAll();
  },

  advanceStatus(id){
    const row = this.findReq(id);
    if(!row) return;

    if(row.status === '종료' || row.status === '반려'){
      alert('이미 종료된 요청입니다.');
      return;
    }

    const flow = ['결재대기','결재중','승인'];
    const idx = flow.indexOf(row.status);
    row.status = (idx === -1) ? '결재대기' : flow[Math.min(idx+1, flow.length-1)];
    this.renderAll();
  },

  setStatus(id, status){
    const row = this.findReq(id);
    if(!row) return;
    row.status = status;
    this.renderAll();
  },

  addLog(){
    const rid = this.state.selectedReqId;
    const req = rid ? this.findReq(rid) : null;
    if(!req){
      alert('선택된 요청이 없습니다.');
      return;
    }
    if(req.status !== '승인'){
      alert('승인된 요청에서만 사용 로그를 추가할 수 있습니다.');
      return;
    }

    const nextNo = String(this.usage.length + 1).padStart(4,'0');
    const id = `EAU-${nextNo}`;
    const now = new Date();
    const at = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

    this.usage.unshift({
      id,
      reqId: req.id,
      at,
      actor: 'dba01',
      action: 'QUERY',
      detail: '장애 확인 쿼리 실행(샘플)'
    });

    this.renderAll();
  },

  appendSqlTemplate(){
    const rid = this.state.selectedReqId;
    const req = rid ? this.findReq(rid) : null;
    if(!req){
      alert('선택된 요청이 없습니다.');
      return;
    }

    const sql =
`-- [긴급 권한] ${req.id}
-- 장애번호: ${req.incident}
-- 시스템: ${req.system}
-- 대상계정: ${req.account}
-- 권한: ${req.role}
-- 참고: 실제 운영에서는 승인/만료/로그 정책에 맞춰 사용하세요.

SELECT /* 장애 확인 */ 1;
`;

    // 에디터에 붙여넣기 유틸이 이미 존재하므로 있으면 활용 (ui.appendSql) :contentReference[oaicite:3]{index=3}
    try{
      if(typeof ui !== 'undefined' && ui && typeof ui.appendSql === 'function'){
        ui.appendSql(sql);
        alert('SQL 템플릿이 에디터에 추가되었습니다.');
      }else{
        alert(sql);
      }
    }catch(e){
      console.warn('appendSqlTemplate error', e);
      alert(sql);
    }
  },

  renderAll(){
    this.renderReqList();
    this.renderUsageList();
    this.renderCounts();
  },

  renderCounts(){
    const reqCnt = document.getElementById('eaReqCount');
    const useCnt = document.getElementById('eaUsageCount');
    const selected = this.state.selectedReqId;

    const visibleReq = this._filteredRequests();
    if(reqCnt) reqCnt.textContent = `${visibleReq.length}건`;

    const usage = (this.usage || []).filter(u => !selected ? true : (u.reqId === selected));
    if(useCnt) useCnt.textContent = `${usage.length}건`;

    const info = document.getElementById('eaSelectedInfo');
    if(info){
      const req = selected ? this.findReq(selected) : null;
      info.textContent = req ? `${req.id} (${req.system} / ${req.account})` : '-';
    }
  },

  _filteredRequests(){
    const st = this.state.filterStatus || 'ALL';
    const kw = (this.state.filterText || '').toLowerCase().trim();

    return (this.requests || []).filter(r=>{
      if(st !== 'ALL' && r.status !== st) return false;
      if(kw){
        const blob = `${r.id} ${r.incident} ${r.system} ${r.account} ${r.requester}`.toLowerCase();
        if(blob.indexOf(kw) === -1) return false;
      }
      return true;
    });
  },

  _statusBadge(status){
    // 아주 단순한 강조(상태별 느낌만)
    const s = status || '-';
    let bg = '#f8fafc', bd = '#e5e7eb', fg = '#64748b';
    if(s === '승인'){ bg='#ecfdf3'; bd='#bbf7d0'; fg='var(--hana-primary)'; }
    if(s === '결재중'){ bg='#eff6ff'; bd='#bfdbfe'; fg='#2563eb'; }
    if(s === '결재대기'){ bg='#fff7ed'; bd='#fed7aa'; fg='#c2410c'; }
    if(s === '종료'){ bg='#f1f5f9'; bd='#e2e8f0'; fg='#475569'; }
    if(s === '반려'){ bg='#fef2f2'; bd='#fecaca'; fg='#dc2626'; }
    return `<span style="font-size:11px; padding:2px 6px; border-radius:999px; background:${bg}; border:1px solid ${bd}; color:${fg};">${this._esc(s)}</span>`;
  },

  renderReqList(){
    const tbody = document.getElementById('eaReqTbody');
    if(!tbody) return;

    const list = this._filteredRequests();
    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="6" style="padding:10px; color:var(--muted);">요청이 없습니다.</td></tr>`;
      return;
    }

    tbody.innerHTML = list.map((r)=>{
      const id = this._esc(r.id);
      const inc = this._esc(r.incident);
      const sys = this._esc(r.system);
      const acc = this._esc(r.account);
      const badge = this._statusBadge(r.status);

      return `
        <tr data-ea-id="${id}" style="border-bottom:1px solid #eef2f7; cursor:pointer;">
          <td style="padding:8px;">${id}</td>
          <td style="padding:8px;">${inc}</td>
          <td style="padding:8px;">${sys}</td>
          <td style="padding:8px;">${acc}</td>
          <td style="padding:8px;">${badge}</td>
          <td style="padding:8px; white-space:nowrap;">
            <button class="btn" data-ea-act="advance" data-id="${id}">상태 진행</button>
            <button class="btn" data-ea-act="close" data-id="${id}">종료</button>
            <button class="btn" data-ea-act="reject" data-id="${id}">반려</button>
          </td>
        </tr>
      `;
    }).join('');
  },

  renderUsageList(){
    const tbody = document.getElementById('eaUsageTbody');
    if(!tbody) return;

    const rid = this.state.selectedReqId;
    const list = (this.usage || []).filter(u => !rid ? true : (u.reqId === rid));

    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="4" style="padding:10px; color:var(--muted);">사용 이력이 없습니다.</td></tr>`;
      return;
    }

    tbody.innerHTML = list.map((u)=>{
      return `
        <tr style="border-bottom:1px solid #eef2f7;">
          <td style="padding:8px;">${this._esc(u.at)}</td>
          <td style="padding:8px;">${this._esc(u.actor)}</td>
          <td style="padding:8px;">${this._esc(u.action)}</td>
          <td style="padding:8px;">${this._esc(u.detail)}</td>
        </tr>
      `;
    }).join('');
  }
};

window.emergencyAccessAdmin = emergencyAccessAdmin;

/* ---------------- Admin: 응급(장애) 권한 요청·사용 이력 end ---------------- */


/* =========================
 * [PATCH START] Admin > DB/민감정보 관리 > 데이터베이스 관리 (DB 레지스트리)
 * - Service 추상화 + MockAdapter
 * - UI(dbRegistryAdmin/connSettings)가 Service를 통해 동작하도록 연결
 * ========================= */
(function () {
  const W = window;

  // ---- state bridge (기존 const state 우선 사용) ----
  function getState() {
    try {
      if (typeof state !== 'undefined' && state) return state; // eslint-disable-line no-undef
    } catch (_) {}
    W.__fallbackState = W.__fallbackState || {};
    return W.__fallbackState;
  }

  // --------- helpers ----------
  function esc(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function nowISO() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function strHash(s) {
    s = String(s ?? '');
    let h = 0 >>> 0;
    for (let i = 0; i < s.length; i++) h = (((h * 31) >>> 0) + s.charCodeAt(i)) >>> 0;
    return h >>> 0;
  }

  function pill(text, tone) {
    // tone: ok | warn | bad | neutral
    const map = {
      ok:     { b: '#bbf7d0', c: '#166534', bg: '#f0fdf4' },
      warn:   { b: '#fde68a', c: '#92400e', bg: '#fffbeb' },
      bad:    { b: '#fecaca', c: '#991b1b', bg: '#fef2f2' },
      neutral:{ b: '#e5e7eb', c: '#374151', bg: '#f9fafb' },
    };
    const t = map[tone] || map.neutral;
    return `<span style="display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid ${t.b};background:${t.bg};color:${t.c};font-size:10px;white-space:nowrap;">${esc(text)}</span>`;
  }

  function ensureStore() {
    const s = getState();
    s.availableConns = s.availableConns || [];
    s.connEnvs = s.connEnvs || {};
    s.connStates = s.connStates || {};
    s.dbRegistry = s.dbRegistry || {
      metaByConn: {},       // connId -> { env, dbms, host, port, database, schema, ownerTeam, systemName, sensitivity, connectType, note, updatedAt }
      mappingsByConn: {},   // connId -> [{ appName, appAccount, role, scope, note }]
      accountsByConn: {},   // connId -> [{ accountId, authType, privilege, status, rotatedAt, note }]
    };
    return s;
  }

  function seedIfMissing(connId) {
    const state = ensureStore();
    const meta = state.dbRegistry.metaByConn[connId];
    if (meta) return;

    const h = strHash(connId);
    const env = state.connEnvs[connId] || (state.availableConns.find(c => c.id === connId)?.env) || 'DEV';
    const dbmsPool = ['Oracle', 'PostgreSQL', 'MySQL', 'MSSQL', 'MariaDB'];
    const dbms = dbmsPool[h % dbmsPool.length];
    const host = `10.${(h % 200) + 10}.${((h >>> 8) % 250)}.${((h >>> 16) % 250)}`;
    const portMap = { Oracle: '1521', PostgreSQL: '5432', MySQL: '3306', MSSQL: '1433', MariaDB: '3306' };
    const port = portMap[dbms] || '0000';
    const database = `DB${(h % 90) + 10}`;
    const schema = (dbms === 'Oracle') ? `SC${(h % 30) + 1}` : 'public';
    const ownerTeamPool = ['플랫폼팀', '보안팀', '데이터팀', '채널팀', '운영팀'];
    const ownerTeam = ownerTeamPool[(h >>> 3) % ownerTeamPool.length];
    const systemNamePool = ['멤버스', 'CRM', '정산', '상품', '채널API', '리포트'];
    const systemName = systemNamePool[(h >>> 5) % systemNamePool.length];
    const sensitivity = (h % 4 === 0) ? 'PII' : (h % 7 === 0 ? '중요' : '일반');
    const connectType = (h % 2 === 0) ? 'JDBC' : '프록시';
    const note = (env === 'PROD') ? '운영 인스턴스' : '개발/검증 인스턴스';

    state.dbRegistry.metaByConn[connId] = {
      env,
      dbms,
      host,
      port,
      database,
      schema,
      ownerTeam,
      systemName,
      sensitivity,
      connectType,
      note,
      updatedAt: nowISO(),
    };

    if (!state.dbRegistry.mappingsByConn[connId]) {
      state.dbRegistry.mappingsByConn[connId] = [
        { appName: systemName, appAccount: `${systemName.toUpperCase()}_APP`, role: 'READ', scope: schema, note: '' },
      ];
    }
    if (!state.dbRegistry.accountsByConn[connId]) {
      state.dbRegistry.accountsByConn[connId] = [
        { accountId: 'APP_RO', authType: 'PASSWORD', privilege: 'READ', status: 'ACTIVE', rotatedAt: '2025-11-01', note: '' },
      ];
    }
  }

  function syncEnvToState(connId, env) {
    const state = ensureStore();
    if (env) state.connEnvs[connId] = env;
    const c = state.availableConns.find(x => x.id === connId);
    if (c && env) c.env = env;
    const m = state.dbRegistry.metaByConn[connId];
    if (m && env) m.env = env;
  }

  // --------- Service Abstraction ----------
  function createMockAdapter() {
    return {
      async exportSnapshot() {
        const state = ensureStore();
        return {
          exportedAt: nowISO(),
          availableConns: state.availableConns || [],
          connEnvs: state.connEnvs || {},
          dbRegistry: state.dbRegistry || {},
        };
      },

      async importSnapshot(obj) {
        const state = ensureStore();

        const incomingConns = Array.isArray(obj?.availableConns) ? obj.availableConns : [];
        const incomingEnvs = obj?.connEnvs || {};
        const incomingReg = obj?.dbRegistry || {};

        // merge conns
        const byId = new Map((state.availableConns || []).map(c => [c.id, c]));
        incomingConns.forEach(c => {
          if (!c || !c.id) return;
          byId.set(c.id, { id: c.id, label: c.label || c.id, profile: c.profile ?? null, env: c.env ?? null });
        });
        state.availableConns = Array.from(byId.values());

        // merge envs
        state.connEnvs = Object.assign(state.connEnvs || {}, incomingEnvs || {});

        // merge registry
        state.dbRegistry = state.dbRegistry || { metaByConn:{}, mappingsByConn:{}, accountsByConn:{} };
        if (incomingReg.metaByConn) state.dbRegistry.metaByConn = Object.assign(state.dbRegistry.metaByConn || {}, incomingReg.metaByConn);
        if (incomingReg.mappingsByConn) state.dbRegistry.mappingsByConn = Object.assign(state.dbRegistry.mappingsByConn || {}, incomingReg.mappingsByConn);
        if (incomingReg.accountsByConn) state.dbRegistry.accountsByConn = Object.assign(state.dbRegistry.accountsByConn || {}, incomingReg.accountsByConn);

        // seed missing
        (state.availableConns || []).forEach(c => seedIfMissing(c.id));

        return { ok: true };
      },

      async upsertMeta(connId, patch) {
        const state = ensureStore();
        if (!connId) return { ok: false, message: 'connId required' };
        seedIfMissing(connId);

        const prev = state.dbRegistry.metaByConn[connId] || {};
        state.dbRegistry.metaByConn[connId] = Object.assign({}, prev, patch || {}, { updatedAt: nowISO() });

        if (patch?.env) syncEnvToState(connId, patch.env);
        return { ok: true, meta: state.dbRegistry.metaByConn[connId] };
      },

      async addMapping(connId, mapping) {
        const state = ensureStore();
        if (!connId) return { ok: false, message: 'connId required' };
        seedIfMissing(connId);

        const list = state.dbRegistry.mappingsByConn[connId] || (state.dbRegistry.mappingsByConn[connId] = []);
        list.push(Object.assign({}, mapping));
        if (state.dbRegistry.metaByConn[connId]) state.dbRegistry.metaByConn[connId].updatedAt = nowISO();
        return { ok: true };
      },

      async removeMapping(connId, idx) {
        const state = ensureStore();
        if (!connId) return { ok: false };
        const list = state.dbRegistry.mappingsByConn[connId] || [];
        if (idx < 0 || idx >= list.length) return { ok: false };
        list.splice(idx, 1);
        if (state.dbRegistry.metaByConn[connId]) state.dbRegistry.metaByConn[connId].updatedAt = nowISO();
        return { ok: true };
      },

      async addAccount(connId, account) {
        const state = ensureStore();
        if (!connId) return { ok: false, message: 'connId required' };
        seedIfMissing(connId);

        const list = state.dbRegistry.accountsByConn[connId] || (state.dbRegistry.accountsByConn[connId] = []);
        list.push(Object.assign({}, account));
        if (state.dbRegistry.metaByConn[connId]) state.dbRegistry.metaByConn[connId].updatedAt = nowISO();
        return { ok: true };
      },

      async removeAccount(connId, idx) {
        const state = ensureStore();
        if (!connId) return { ok: false };
        const list = state.dbRegistry.accountsByConn[connId] || [];
        if (idx < 0 || idx >= list.length) return { ok: false };
        list.splice(idx, 1);
        if (state.dbRegistry.metaByConn[connId]) state.dbRegistry.metaByConn[connId].updatedAt = nowISO();
        return { ok: true };
      },

      async removeConn(connId) {
        const state = ensureStore();
        if (!connId) return { ok: false, message: 'connId required' };

        delete state.dbRegistry.metaByConn[connId];
        delete state.dbRegistry.mappingsByConn[connId];
        delete state.dbRegistry.accountsByConn[connId];
        if (state.connStates) delete state.connStates[connId];
        if (state.connEnvs) delete state.connEnvs[connId];

        state.availableConns = (state.availableConns || []).filter(x => x.id !== connId);
        return { ok: true };
      },

      async requestConnectionTest(connId) {
        // 현재 환경에서는 기존 모달(ui.openConnReasonModal)을 사용
        if (W.ui && typeof W.ui.openConnReasonModal === 'function') {
          W.ui.openConnReasonModal(connId);
          return { ok: true, mode: 'reasonModal' };
        }
        if (W.ui && typeof W.ui.setActiveConn === 'function') {
          W.ui.setActiveConn(connId);
          return { ok: true, mode: 'activate' };
        }
        return { ok: false, message: 'connection test UI not found' };
      },
    };
  }

  function createDbRegistryService() {
    // 필요 시: USE_DEMO=false 환경에서 API Adapter로 교체할 수 있게 구조만 유지
    // (현재는 기본 MockAdapter만 사용)
    const adapter = createMockAdapter();
    return {
      adapter: 'mock',
      exportSnapshot: (...a) => adapter.exportSnapshot(...a),
      importSnapshot: (...a) => adapter.importSnapshot(...a),
      upsertMeta: (...a) => adapter.upsertMeta(...a),
      addMapping: (...a) => adapter.addMapping(...a),
      removeMapping: (...a) => adapter.removeMapping(...a),
      addAccount: (...a) => adapter.addAccount(...a),
      removeAccount: (...a) => adapter.removeAccount(...a),
      removeConn: (...a) => adapter.removeConn(...a),
      requestConnectionTest: (...a) => adapter.requestConnectionTest(...a),
    };
  }

  function getDbRegistryService() {
    W.dbamServices = W.dbamServices || {};
    if (!W.dbamServices.dbRegistry) W.dbamServices.dbRegistry = createDbRegistryService();
    return W.dbamServices.dbRegistry;
  }

  // --------- modal (export/import + small forms) ----------
  function ensureModal() {
    let bd = document.getElementById('dbrModalBackdrop');
    if (bd) return bd;

    bd = document.createElement('div');
    bd.id = 'dbrModalBackdrop';
    bd.className = 'export-modal-backdrop';
    bd.innerHTML = `
      <div class="export-modal" style="max-width:860px;width:calc(100vw - 40px);">
        <div class="export-modal-header">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <h3 id="dbrModalTitle" style="margin:0;font-size:14px;"></h3>
            <button class="btn" id="dbrModalCloseBtn"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>
        <div id="dbrModalBody" style="margin-top:10px;"></div>
        <div id="dbrModalFooter" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;"></div>
      </div>
    `;
    document.body.appendChild(bd);

    bd.addEventListener('click', (e) => { if (e.target === bd) bd.classList.remove('show'); });
    bd.querySelector('#dbrModalCloseBtn').addEventListener('click', () => bd.classList.remove('show'));
    return bd;
  }

  function openModal(title, bodyHtml, footerButtons /* [{label, className, onClick}] */) {
    const bd = ensureModal();
    bd.querySelector('#dbrModalTitle').innerHTML = title;
    bd.querySelector('#dbrModalBody').innerHTML = bodyHtml;

    const ft = bd.querySelector('#dbrModalFooter');
    ft.innerHTML = '';
    (footerButtons || []).forEach(btn => {
      const b = document.createElement('button');
      b.className = btn.className || 'btn';
      b.innerHTML = btn.label;
      b.addEventListener('click', () => btn.onClick && btn.onClick());
      ft.appendChild(b);
    });

    bd.classList.add('show');
  }

  // --------- DB Registry Admin ----------
  const dbRegistryAdmin = {
    selectedConnId: null,
    filters: { env: 'ALL', dbms: 'ALL', sens: 'ALL', q: '' },

    open(connId) {
      ensureStore();
      getDbRegistryService(); // service ensure

      // overlay open + nav active
      const ov = document.getElementById('adminOverlay');
      if (ov) { ov.classList.add('show'); ov.setAttribute('aria-hidden', 'false'); }
      document.querySelectorAll('.admin-nav button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.section === 'dbSensitive');
      });

      const titleEl = document.getElementById('adminTitle');
      const descEl = document.getElementById('adminDesc');
      const bodyEl = document.getElementById('adminBody');
      if (!titleEl || !descEl || !bodyEl) return;

      titleEl.innerHTML = `<i class="fa-solid fa-server"></i> 데이터베이스 관리`;
      descEl.textContent =
        '운영/개발 등 환경 구분별 DB 인스턴스의 스키마, 계정, 접속 정보·접속 방식을 등록하고 응용시스템 계정과 매핑하며 연결 테스트를 지원';

      bodyEl.innerHTML = this.getTemplateHtml();
      this.bindOnce();

      // seed metas for existing conns
      const state = ensureStore();
      (state.availableConns || []).forEach(c => seedIfMissing(c.id));

      if (connId) this.selectedConnId = connId;
      if (!this.selectedConnId) this.selectedConnId = (state.availableConns[0] && state.availableConns[0].id) || null;

      this.renderAll();
    },

    getTemplateHtml() {
      return `
        <div id="dbrPage" class="emg-page">
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <div style="flex:1.25; min-width:420px; display:flex; flex-direction:column; gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div class="admin-header">
                  <h2><i class="fa-solid fa-server"></i> DB 목록</h2>
                  <span class="badge" id="dbrCount">0건</span>
                </div>

                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px;">
                  <select id="dbrFilterEnv" class="export-input" style="max-width:140px;">
                    <option value="ALL">환경(전체)</option>
                    <option value="PROD">운영</option>
                    <option value="QA">검증</option>
                    <option value="DEV">개발</option>
                  </select>

                  <select id="dbrFilterDbms" class="export-input" style="max-width:160px;">
                    <option value="ALL">DBMS(전체)</option>
                    <option value="Oracle">Oracle</option>
                    <option value="PostgreSQL">PostgreSQL</option>
                    <option value="MySQL">MySQL</option>
                    <option value="MSSQL">MSSQL</option>
                    <option value="MariaDB">MariaDB</option>
                  </select>

                  <select id="dbrFilterSens" class="export-input" style="max-width:160px;">
                    <option value="ALL">분류(전체)</option>
                    <option value="PII">개인정보</option>
                    <option value="중요">중요정보</option>
                    <option value="일반">일반</option>
                  </select>

                  <input id="dbrKeyword" class="export-input" placeholder="검색(이름/Host/DB/스키마/시스템)" style="flex:1; min-width:220px;" />

                  <button class="btn" data-dbr-act="import"><i class="fa-solid fa-file-import"></i> 가져오기</button>
                  <button class="btn" data-dbr-act="export"><i class="fa-solid fa-file-export"></i> 내보내기</button>
                  <button class="btn primary" data-dbr-act="add"><i class="fa-solid fa-plus"></i> 등록</button>
                </div>

                <div style="overflow:auto; margin-top:10px; border:1px solid #e5e7eb; border-radius:8px;">
                  <table style="width:100%; border-collapse:collapse; font-size:12px;">
                    <thead>
                      <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                        <th style="text-align:left; padding:8px;">이름</th>
                        <th style="text-align:left; padding:8px; width:70px;">환경</th>
                        <th style="text-align:left; padding:8px; width:95px;">DBMS</th>
                        <th style="text-align:left; padding:8px; min-width:170px;">Host:Port</th>
                        <th style="text-align:left; padding:8px; width:90px;">DB</th>
                        <th style="text-align:left; padding:8px; width:110px;">스키마</th>
                        <th style="text-align:left; padding:8px; width:95px;">분류</th>
                        <th style="text-align:left; padding:8px; width:90px;">상태</th>
                      </tr>
                    </thead>
                    <tbody id="dbrTbody"></tbody>
                  </table>
                </div>

                <div class="admin-footer">행을 클릭하면 오른쪽 상세/매핑/계정이 갱신됩니다.</div>
              </div>
            </div>

            <div style="flex:0.85; min-width:320px; display:flex; flex-direction:column; gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div class="admin-header">
                  <h2><i class="fa-solid fa-circle-info"></i> 상세</h2>
                  <span class="badge" id="dbrSelBadge">-</span>
                </div>

                <div id="dbrDetailBody" style="margin-top:10px;"></div>

                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap;">
                  <button class="btn" data-dbr-act="edit"><i class="fa-solid fa-pen"></i> 수정</button>
                  <button class="btn" data-dbr-act="test"><i class="fa-solid fa-plug"></i> 연결 테스트</button>
                  <button class="btn" data-dbr-act="delete"><i class="fa-solid fa-trash"></i> 제거</button>
                </div>
              </div>

              <div class="admin-card" style="padding:12px 14px;">
                <div class="admin-header">
                  <h2><i class="fa-solid fa-link"></i> 응용시스템 계정 매핑</h2>
                  <span class="badge" id="dbrMapCount">0건</span>
                </div>
                <div id="dbrMapBody" style="margin-top:10px;"></div>
                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
                  <button class="btn" data-dbr-act="add-map"><i class="fa-solid fa-plus"></i> 추가</button>
                </div>
              </div>

              <div class="admin-card" style="padding:12px 14px;">
                <div class="admin-header">
                  <h2><i class="fa-solid fa-id-card"></i> DB 계정</h2>
                  <span class="badge" id="dbrAccCount">0건</span>
                </div>
                <div id="dbrAccBody" style="margin-top:10px;"></div>
                <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
                  <button class="btn" data-dbr-act="add-acc"><i class="fa-solid fa-plus"></i> 추가</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    },

    bindOnce() {
      const bodyEl = document.getElementById('adminBody');
      if (!bodyEl || bodyEl.dataset.dbrBound === '1') return;
      bodyEl.dataset.dbrBound = '1';

      bodyEl.addEventListener('click', (e) => {
        const page = document.getElementById('dbrPage');
        if (!page || !page.contains(e.target)) return;

        const btn = e.target.closest('[data-dbr-act]');
        if (btn) {
          const act = btn.dataset.dbrAct;
          this.handleAction(act);
          return;
        }

        const tr = e.target.closest('tr[data-conn-id]');
        if (tr) {
          this.selectedConnId = tr.dataset.connId;
          this.renderAll();
        }

        const rmMap = e.target.closest('[data-dbr-rm-map]');
        if (rmMap) {
          const idx = Number(rmMap.dataset.dbrRmMap);
          this.removeMapping(idx);
        }

        const rmAcc = e.target.closest('[data-dbr-rm-acc]');
        if (rmAcc) {
          const idx = Number(rmAcc.dataset.dbrRmAcc);
          this.removeAccount(idx);
        }
      });

      bodyEl.addEventListener('input', (e) => {
        const page = document.getElementById('dbrPage');
        if (!page || !page.contains(e.target)) return;

        if (e.target.id === 'dbrKeyword') {
          this.filters.q = e.target.value || '';
          this.renderList();
        }
      });

      bodyEl.addEventListener('change', (e) => {
        const page = document.getElementById('dbrPage');
        if (!page || !page.contains(e.target)) return;

        if (e.target.id === 'dbrFilterEnv') {
          this.filters.env = e.target.value || 'ALL';
          this.renderList();
        }
        if (e.target.id === 'dbrFilterDbms') {
          this.filters.dbms = e.target.value || 'ALL';
          this.renderList();
        }
        if (e.target.id === 'dbrFilterSens') {
          this.filters.sens = e.target.value || 'ALL';
          this.renderList();
        }
      });
    },

    getFilteredRows() {
      const state = ensureStore();
      const q = (this.filters.q || '').trim().toLowerCase();
      const env = this.filters.env;
      const dbms = this.filters.dbms;
      const sens = this.filters.sens;

      const rows = (state.availableConns || []).map(c => {
        seedIfMissing(c.id);
        const meta = state.dbRegistry.metaByConn[c.id] || {};
        const label = c.label || c.id;
        const envV = meta.env || c.env || state.connEnvs[c.id] || 'DEV';
        const status = (state.connStates && state.connStates[c.id]) ? '연결' : '미연결';
        return { conn: c, meta, label, envV, status };
      });

      return rows.filter(r => {
        if (env !== 'ALL' && (r.envV || 'DEV') !== env) return false;
        if (dbms !== 'ALL' && (r.meta.dbms || '') !== dbms) return false;
        if (sens !== 'ALL' && (r.meta.sensitivity || '일반') !== sens) return false;

        if (q) {
          const blob = [
            r.label, r.conn.id, r.meta.host, r.meta.port, r.meta.database,
            r.meta.schema, r.meta.systemName, r.meta.ownerTeam, r.meta.dbms, r.meta.note
          ].join(' ').toLowerCase();
          if (!blob.includes(q)) return false;
        }
        return true;
      });
    },

    renderAll() {
      this.renderList();
      this.renderDetail();
      this.renderMappings();
      this.renderAccounts();
    },

    renderList() {
      const state = ensureStore();
      const rows = this.getFilteredRows();
      const tbody = document.getElementById('dbrTbody');
      const cnt = document.getElementById('dbrCount');
      if (!tbody || !cnt) return;

      cnt.textContent = `${rows.length}건`;

      const selected = this.selectedConnId;
      tbody.innerHTML = rows.map(r => {
        const meta = r.meta || {};
        const tone = (r.status === '연결') ? 'ok' : 'neutral';
        const sensTone = (meta.sensitivity === 'PII') ? 'bad' : (meta.sensitivity === '중요' ? 'warn' : 'neutral');

        const isSel = (r.conn.id === selected);
        const bg = isSel ? 'background:#eff6ff;' : '';
        return `
          <tr data-conn-id="${esc(r.conn.id)}" style="${bg} border-bottom:1px solid #f1f5f9; cursor:pointer;">
            <td style="padding:8px;">
              <div style="font-weight:600;">${esc(r.label)}</div>
              <div style="font-size:11px; color:#64748b;">${esc(r.conn.id)}</div>
            </td>
            <td style="padding:8px;">${pill(meta.env || r.envV || 'DEV', 'neutral')}</td>
            <td style="padding:8px;">${esc(meta.dbms || '-')}</td>
            <td style="padding:8px;">${esc((meta.host || '-') + ':' + (meta.port || '-'))}</td>
            <td style="padding:8px;">${esc(meta.database || '-')}</td>
            <td style="padding:8px;">${esc(meta.schema || '-')}</td>
            <td style="padding:8px;">${pill(meta.sensitivity || '일반', sensTone)}</td>
            <td style="padding:8px;">${pill(r.status, tone)}</td>
          </tr>
        `;
      }).join('');

      // selection fallback
      if (!this.selectedConnId && rows[0]) {
        this.selectedConnId = rows[0].conn.id;
        this.renderAll();
      } else if (this.selectedConnId && !state.availableConns.find(c => c.id === this.selectedConnId)) {
        this.selectedConnId = (rows[0] && rows[0].conn.id) || null;
        this.renderAll();
      }
    },

    renderDetail() {
      const state = ensureStore();
      const connId = this.selectedConnId;
      const badge = document.getElementById('dbrSelBadge');
      const body = document.getElementById('dbrDetailBody');
      if (!badge || !body) return;

      if (!connId) {
        badge.textContent = '-';
        body.innerHTML = `<div style="color:#64748b; font-size:12px;">선택된 DB가 없습니다.</div>`;
        return;
      }

      seedIfMissing(connId);

      const conn = state.availableConns.find(c => c.id === connId);
      const meta = state.dbRegistry.metaByConn[connId] || {};
      const status = (state.connStates && state.connStates[connId]) ? '연결' : '미연결';

      badge.textContent = connId;

      body.innerHTML = `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <div>
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">이름</div>
            <div style="font-weight:600;">${esc(conn?.label || connId)}</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">상태</div>
            <div>${pill(status, status === '연결' ? 'ok' : 'neutral')}</div>
          </div>

          <div>
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">환경</div>
            <div>${esc(meta.env || conn?.env || 'DEV')}</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">DBMS</div>
            <div>${esc(meta.dbms || '-')}</div>
          </div>

          <div>
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">Host:Port</div>
            <div>${esc((meta.host || '-') + ':' + (meta.port || '-'))}</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">DB / Schema</div>
            <div>${esc((meta.database || '-') + ' / ' + (meta.schema || '-'))}</div>
          </div>

          <div>
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">소유팀</div>
            <div>${esc(meta.ownerTeam || '-')}</div>
          </div>
          <div>
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">응용시스템</div>
            <div>${esc(meta.systemName || '-')}</div>
          </div>

          <div style="grid-column:1 / -1;">
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">접속 방식 / 메모</div>
            <div style="color:#0f172a;">${esc((meta.connectType || '-') + ' · ' + (meta.note || ''))}</div>
          </div>

          <div style="grid-column:1 / -1;">
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">최종 갱신</div>
            <div>${esc(meta.updatedAt || '-')}</div>
          </div>
        </div>
      `;
    },

    renderMappings() {
      const state = ensureStore();
      const connId = this.selectedConnId;
      const countEl = document.getElementById('dbrMapCount');
      const body = document.getElementById('dbrMapBody');
      if (!countEl || !body) return;

      if (!connId) {
        countEl.textContent = '0건';
        body.innerHTML = `<div style="color:#64748b; font-size:12px;">선택된 DB가 없습니다.</div>`;
        return;
      }

      seedIfMissing(connId);

      const list = state.dbRegistry.mappingsByConn[connId] || [];
      countEl.textContent = `${list.length}건`;

      if (!list.length) {
        body.innerHTML = `<div style="color:#64748b; font-size:12px;">매핑 정보가 없습니다.</div>`;
        return;
      }

      body.innerHTML = `
        <div style="overflow:auto; border:1px solid #e5e7eb; border-radius:8px;">
          <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left; padding:8px;">응용시스템</th>
                <th style="text-align:left; padding:8px;">계정</th>
                <th style="text-align:left; padding:8px; width:70px;">권한</th>
                <th style="text-align:left; padding:8px; width:90px;">범위</th>
                <th style="text-align:left; padding:8px; width:60px;">삭제</th>
              </tr>
            </thead>
            <tbody>
              ${(list || []).map((m, idx) => `
                <tr style="border-bottom:1px solid #f1f5f9;">
                  <td style="padding:8px;">${esc(m.appName || '-')}</td>
                  <td style="padding:8px;">${esc(m.appAccount || '-')}</td>
                  <td style="padding:8px;">${esc(m.role || '-')}</td>
                  <td style="padding:8px;">${esc(m.scope || '-')}</td>
                  <td style="padding:8px;">
                    <button class="btn" data-dbr-rm-map="${idx}"><i class="fa-solid fa-trash"></i></button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    },

    renderAccounts() {
      const state = ensureStore();
      const connId = this.selectedConnId;
      const countEl = document.getElementById('dbrAccCount');
      const body = document.getElementById('dbrAccBody');
      if (!countEl || !body) return;

      if (!connId) {
        countEl.textContent = '0건';
        body.innerHTML = `<div style="color:#64748b; font-size:12px;">선택된 DB가 없습니다.</div>`;
        return;
      }

      seedIfMissing(connId);

      const list = state.dbRegistry.accountsByConn[connId] || [];
      countEl.textContent = `${list.length}건`;

      if (!list.length) {
        body.innerHTML = `<div style="color:#64748b; font-size:12px;">계정 정보가 없습니다.</div>`;
        return;
      }

      body.innerHTML = `
        <div style="overflow:auto; border:1px solid #e5e7eb; border-radius:8px;">
          <table style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                <th style="text-align:left; padding:8px;">계정</th>
                <th style="text-align:left; padding:8px; width:90px;">인증</th>
                <th style="text-align:left; padding:8px; width:90px;">권한</th>
                <th style="text-align:left; padding:8px; width:80px;">상태</th>
                <th style="text-align:left; padding:8px; width:60px;">삭제</th>
              </tr>
            </thead>
            <tbody>
              ${(list || []).map((a, idx) => `
                <tr style="border-bottom:1px solid #f1f5f9;">
                  <td style="padding:8px;">
                    <div style="font-weight:600;">${esc(a.accountId || '-')}</div>
                    <div style="font-size:11px; color:#64748b;">${esc(a.rotatedAt ? ('회전: ' + a.rotatedAt) : '')}</div>
                  </td>
                  <td style="padding:8px;">${esc(a.authType || '-')}</td>
                  <td style="padding:8px;">${esc(a.privilege || '-')}</td>
                  <td style="padding:8px;">${pill(a.status || 'ACTIVE', (a.status === 'DISABLED') ? 'warn' : 'ok')}</td>
                  <td style="padding:8px;">
                    <button class="btn" data-dbr-rm-acc="${idx}"><i class="fa-solid fa-trash"></i></button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    },

    handleAction(act) {
      const svc = getDbRegistryService();
      const state = ensureStore();
      const connId = this.selectedConnId;

      if (act === 'add') {
        if (W.connSettings && typeof W.connSettings.openNew === 'function') {
          W.connSettings.openNew();
        } else {
          alert('커넥션 설정 모달을 찾지 못했습니다.');
        }
        return;
      }

      if (act === 'edit') {
        if (!connId) return alert('수정할 DB를 선택하세요.');
        if (W.connSettings && typeof W.connSettings.open === 'function') {
          W.connSettings.open(connId);
        } else {
          alert('커넥션 설정 모달을 찾지 못했습니다.');
        }
        return;
      }

      if (act === 'test') {
        if (!connId) return alert('테스트할 DB를 선택하세요.');
        svc.requestConnectionTest(connId).then((r) => {
          if (!r?.ok) alert('연결 테스트 UI를 찾지 못했습니다.');
        });
        return;
      }

      if (act === 'delete') {
        if (!connId) return alert('제거할 DB를 선택하세요.');
        const c = state.availableConns.find(x => x.id === connId);
        const ok = confirm(`선택한 DB를 목록에서 제거할까요?\n\n- ${c?.label || connId} (${connId})`);
        if (!ok) return;

        svc.removeConn(connId).then(() => {
          // 트리 DOM 제거(가능할 때만)
          const li = document.querySelector(`#dbTree li[data-conn-id="${CSS.escape(connId)}"]`);
          if (li && li.parentElement) li.parentElement.removeChild(li);

          // select/active 갱신(가능할 때만)
          if (W.ui && typeof W.ui.renderConnSelect === 'function') W.ui.renderConnSelect();
          if (W.ui && typeof W.ui.setActiveConn === 'function') {
            const next = (ensureStore().availableConns[0] && ensureStore().availableConns[0].id) || null;
            if (next) W.ui.setActiveConn(next);
          }

          const nextSel = (ensureStore().availableConns[0] && ensureStore().availableConns[0].id) || null;
          this.selectedConnId = nextSel;
          this.renderAll();
        });
        return;
      }

      if (act === 'export') {
        svc.exportSnapshot().then((payload) => {
          const json = JSON.stringify(payload, null, 2);
          openModal(
            `<i class="fa-solid fa-file-export"></i> DB 목록 내보내기`,
            `
              <div style="font-size:12px; color:#475569; margin-bottom:8px;">
                아래 JSON을 복사해 보관하거나 다른 환경에 가져오기할 수 있습니다.
              </div>
              <textarea id="dbrExportText" spellcheck="false">${esc(json)}</textarea>
            `,
            [
              {
                label: '<i class="fa-solid fa-copy"></i> 복사',
                className: 'btn',
                onClick: () => {
                  const ta = document.getElementById('dbrExportText');
                  ta.select();
                  document.execCommand('copy');
                }
              },
              {
                label: '<i class="fa-solid fa-xmark"></i> 닫기',
                className: 'btn',
                onClick: () => document.getElementById('dbrModalBackdrop')?.classList.remove('show')
              }
            ]
          );
        });
        return;
      }

      if (act === 'import') {
        openModal(
          `<i class="fa-solid fa-file-import"></i> DB 목록 가져오기`,
          `
            <div style="font-size:12px; color:#475569; margin-bottom:8px;">
              내보내기 JSON을 붙여 넣고 "적용"을 누르세요.
            </div>
            <textarea id="dbrImportText" placeholder="{ ... }" spellcheck="false"></textarea>
            <div style="font-size:11px; color:#64748b; margin-top:6px;">
              ※ 기존 목록에 병합(같은 connId는 덮어쓰기)합니다.
            </div>
          `,
          [
            {
              label: '<i class="fa-solid fa-check"></i> 적용',
              className: 'btn primary',
              onClick: () => {
                try {
                  const ta = document.getElementById('dbrImportText');
                  const obj = JSON.parse(ta.value || '{}');

                  svc.importSnapshot(obj).then(() => {
                    const state2 = ensureStore();

                    // tree reflect(가능할 때만: 없는 것은 추가)
                    if (W.dbFolderUi && typeof W.dbFolderUi.addDbNode === 'function') {
                      (state2.availableConns || []).forEach(c => {
                        const li = document.querySelector(`#dbTree li[data-conn-id="${CSS.escape(c.id)}"]`);
                        if (!li) W.dbFolderUi.addDbNode({ id: c.id, label: c.label, env: c.env ?? null, profile: c.profile ?? null });
                      });
                    }

                    if (W.ui && typeof W.ui.renderConnSelect === 'function') W.ui.renderConnSelect();

                    document.getElementById('dbrModalBackdrop')?.classList.remove('show');
                    this.renderAll();
                  });
                } catch (err) {
                  alert('가져오기 JSON 파싱에 실패했습니다.\n\n' + err.message);
                }
              }
            },
            {
              label: '<i class="fa-solid fa-xmark"></i> 취소',
              className: 'btn',
              onClick: () => document.getElementById('dbrModalBackdrop')?.classList.remove('show')
            }
          ]
        );
        return;
      }

      if (act === 'add-map') {
        if (!connId) return alert('대상을 먼저 선택하세요.');
        seedIfMissing(connId);
        const meta = (state.dbRegistry.metaByConn[connId] || {});
        openModal(
          `<i class="fa-solid fa-link"></i> 응용시스템 계정 매핑 추가`,
          `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div>
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">응용시스템</div>
                <input id="dbrMapApp" class="export-input" placeholder="예) 멤버스" value="${esc(meta.systemName || '')}" />
              </div>
              <div>
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">계정</div>
                <input id="dbrMapAccount" class="export-input" placeholder="예) MBR_APP" />
              </div>
              <div>
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">권한</div>
                <select id="dbrMapRole" class="export-input">
                  <option value="READ">READ</option>
                  <option value="WRITE">WRITE</option>
                  <option value="ADMIN">ADMIN</option>
                </select>
              </div>
              <div>
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">범위(스키마)</div>
                <input id="dbrMapScope" class="export-input" placeholder="예) public" value="${esc(meta.schema || '')}" />
              </div>
              <div style="grid-column:1 / -1;">
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">메모</div>
                <input id="dbrMapNote" class="export-input" placeholder="필요 시 입력" />
              </div>
            </div>
          `,
          [
            {
              label: '<i class="fa-solid fa-check"></i> 저장',
              className: 'btn primary',
              onClick: () => {
                const appName = (document.getElementById('dbrMapApp')?.value || '').trim();
                const appAccount = (document.getElementById('dbrMapAccount')?.value || '').trim();
                const role = (document.getElementById('dbrMapRole')?.value || 'READ').trim();
                const scope = (document.getElementById('dbrMapScope')?.value || '').trim();
                const note = (document.getElementById('dbrMapNote')?.value || '').trim();
                if (!appName || !appAccount) return alert('응용시스템/계정은 필수입니다.');

                svc.addMapping(connId, { appName, appAccount, role, scope, note }).then(() => {
                  document.getElementById('dbrModalBackdrop')?.classList.remove('show');
                  this.renderMappings();
                  this.renderDetail();
                });
              }
            },
            {
              label: '<i class="fa-solid fa-xmark"></i> 취소',
              className: 'btn',
              onClick: () => document.getElementById('dbrModalBackdrop')?.classList.remove('show')
            }
          ]
        );
        return;
      }

      if (act === 'add-acc') {
        if (!connId) return alert('대상을 먼저 선택하세요.');
        seedIfMissing(connId);
        openModal(
          `<i class="fa-solid fa-id-card"></i> DB 계정 추가`,
          `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div>
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">계정</div>
                <input id="dbrAccId" class="export-input" placeholder="예) APP_RO" />
              </div>
              <div>
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">인증 방식</div>
                <select id="dbrAccAuth" class="export-input">
                  <option value="PASSWORD">PASSWORD</option>
                  <option value="KEY">KEY</option>
                  <option value="SSO">SSO</option>
                </select>
              </div>
              <div>
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">권한</div>
                <select id="dbrAccPriv" class="export-input">
                  <option value="READ">READ</option>
                  <option value="WRITE">WRITE</option>
                  <option value="ADMIN">ADMIN</option>
                </select>
              </div>
              <div>
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">상태</div>
                <select id="dbrAccStatus" class="export-input">
                  <option value="ACTIVE">ACTIVE</option>
                  <option value="DISABLED">DISABLED</option>
                </select>
              </div>
              <div style="grid-column:1 / -1;">
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">메모</div>
                <input id="dbrAccNote" class="export-input" placeholder="필요 시 입력" />
              </div>
            </div>
          `,
          [
            {
              label: '<i class="fa-solid fa-check"></i> 저장',
              className: 'btn primary',
              onClick: () => {
                const accountId = (document.getElementById('dbrAccId')?.value || '').trim();
                const authType = (document.getElementById('dbrAccAuth')?.value || 'PASSWORD').trim();
                const privilege = (document.getElementById('dbrAccPriv')?.value || 'READ').trim();
                const status = (document.getElementById('dbrAccStatus')?.value || 'ACTIVE').trim();
                const note = (document.getElementById('dbrAccNote')?.value || '').trim();
                if (!accountId) return alert('계정은 필수입니다.');

                svc.addAccount(connId, { accountId, authType, privilege, status, rotatedAt: '2025-12-01', note }).then(() => {
                  document.getElementById('dbrModalBackdrop')?.classList.remove('show');
                  this.renderAccounts();
                  this.renderDetail();
                });
              }
            },
            {
              label: '<i class="fa-solid fa-xmark"></i> 취소',
              className: 'btn',
              onClick: () => document.getElementById('dbrModalBackdrop')?.classList.remove('show')
            }
          ]
        );
        return;
      }
    },

    removeMapping(idx) {
      const svc = getDbRegistryService();
      const connId = this.selectedConnId;
      if (!connId) return;

      const state = ensureStore();
      const list = state.dbRegistry.mappingsByConn[connId] || [];
      if (idx < 0 || idx >= list.length) return;

      const ok = confirm('해당 매핑을 삭제할까요?');
      if (!ok) return;

      svc.removeMapping(connId, idx).then(() => {
        this.renderMappings();
        this.renderDetail();
      });
    },

    removeAccount(idx) {
      const svc = getDbRegistryService();
      const connId = this.selectedConnId;
      if (!connId) return;

      const state = ensureStore();
      const list = state.dbRegistry.accountsByConn[connId] || [];
      if (idx < 0 || idx >= list.length) return;

      const ok = confirm('해당 계정을 삭제할까요?');
      if (!ok) return;

      svc.removeAccount(connId, idx).then(() => {
        this.renderAccounts();
        this.renderDetail();
      });
    },
  };

  W.dbRegistryAdmin = dbRegistryAdmin;

  // --------- Patch: admin.show()에서 "데이터베이스 관리" 카드 클릭 연결 ----------
  function patchAdminShowForDbSensitive() {
    if (!W.admin || W.admin.__dbSensitivePatched) return;
    W.admin.__dbSensitivePatched = true;

    const originalShow = W.admin.show.bind(W.admin);
    W.admin.show = function (section) {
      originalShow(section);

      if (section !== 'dbSensitive') return;

      document.querySelectorAll('#adminBody .admin-card-clickable').forEach(card => {
        const h4 = card.querySelector('h4');
        const title = (h4 && h4.textContent) ? h4.textContent.trim() : '';
        if (title !== '데이터베이스 관리') return;

        if (card.dataset.dbrCardBound === '1') return;
        card.dataset.dbrCardBound = '1';

        card.style.cursor = 'pointer';
        card.addEventListener('click', () => W.dbRegistryAdmin.open());
      });
    };
  }

  // --------- Patch: connSettings 모달 값(Host/Port/DB/Schema/DBMS) 저장/로딩 (Service 연동) ----------
  function patchConnSettings() {
    if (!W.connSettings || W.connSettings.__dbrPatched) return;
    W.connSettings.__dbrPatched = true;

    const svc = getDbRegistryService();

    const originalOpen = W.connSettings.open?.bind(W.connSettings);
    const originalOpenNew = W.connSettings.openNew?.bind(W.connSettings);
    const originalSave = W.connSettings.save?.bind(W.connSettings);

    function readConnSettingsFields() {
      const get = (id) => (document.getElementById(id)?.value || '').trim();
      return {
        connId: get('connSettingsConnId'),
        label: get('connSettingsLabel'),
        env: get('connSettingsEnv'),
        dbms: get('connSettingsDbType'),
        host: get('connSettingsHost'),
        port: get('connSettingsPort'),
        database: get('connSettingsDbName'),
        schema: get('connSettingsSchema'),
      };
    }

    function ensureConnIdIfEmpty() {
      const idEl = document.getElementById('connSettingsConnId');
      if (!idEl) return null;
      if (String(idEl.value || '').trim()) return String(idEl.value).trim();

      // 기존 동작 유지(충돌 방지용 고유 값)
      const gen = 'local-' + Date.now().toString(36) + '-' + Math.floor(Math.random() * 1e6).toString(36);
      idEl.value = gen;
      return gen;
    }

    function applyMetaToFields(connId) {
      const state = ensureStore();
      seedIfMissing(connId);
      const meta = state.dbRegistry.metaByConn[connId] || {};

      const set = (id, v) => {
        const el = document.getElementById(id);
        if (el) el.value = (v ?? '');
      };

      set('connSettingsDbType', meta.dbms || '');
      set('connSettingsHost', meta.host || '');
      set('connSettingsPort', meta.port || '');
      set('connSettingsDbName', meta.database || '');
      set('connSettingsSchema', meta.schema || '');

      const urlEl = document.getElementById('connSettingsJdbcUrl');
      if (urlEl) {
        const dbms = (meta.dbms || '').toLowerCase();
        let url = '';
        if (dbms.includes('oracle')) url = `jdbc:oracle:thin:@${meta.host || 'HOST'}:${meta.port || '1521'}:${meta.database || 'SID'}`;
        else if (dbms.includes('postgres')) url = `jdbc:postgresql://${meta.host || 'HOST'}:${meta.port || '5432'}/${meta.database || 'DB'}`;
        else if (dbms.includes('mysql') || dbms.includes('mariadb')) url = `jdbc:${dbms.includes('mariadb') ? 'mariadb' : 'mysql'}://${meta.host || 'HOST'}:${meta.port || '3306'}/${meta.database || 'DB'}`;
        else if (dbms.includes('mssql')) url = `jdbc:sqlserver://${meta.host || 'HOST'}:${meta.port || '1433'};databaseName=${meta.database || 'DB'}`;
        urlEl.value = url;
      }
    }

    if (originalOpen) {
      W.connSettings.open = function (connId) {
        originalOpen(connId);
        try { applyMetaToFields(connId); } catch (_) {}
      };
    }

    if (originalOpenNew) {
      W.connSettings.openNew = function () {
        originalOpenNew();
        const urlEl = document.getElementById('connSettingsJdbcUrl');
        if (urlEl) urlEl.value = '';
      };
    }

    if (originalSave) {
      W.connSettings.save = function () {
        ensureStore();

        const ensuredId = ensureConnIdIfEmpty();
        const before = readConnSettingsFields();

        originalSave();

        const connId = ensuredId || before.connId;
        if (!connId) return;

        svc.upsertMeta(connId, {
          env: before.env,
          dbms: before.dbms,
          host: before.host,
          port: before.port,
          database: before.database,
          schema: before.schema,
        }).then(() => {
          syncEnvToState(connId, before.env);

          if (document.getElementById('dbrPage') && W.dbRegistryAdmin) {
            W.dbRegistryAdmin.selectedConnId = connId;
            W.dbRegistryAdmin.renderAll();
          }
        });
      };
    }
  }

  patchAdminShowForDbSensitive();
  patchConnSettings();

  document.addEventListener('DOMContentLoaded', () => {
    patchAdminShowForDbSensitive();
    patchConnSettings();
  });
})();
/* =========================
 * [PATCH END] Admin > DB/민감정보 관리 > 데이터베이스 관리 (DB 레지스트리)
 * ========================= */



/* =========================
 * Admin > DB/민감정보 관리 > 민감정보(테이블/컬럼) 목록
 * ========================= */

 /* =========================
  * Admin > DB/민감정보 관리 > 민감정보(테이블/컬럼) 목록 (Unified: Service + Adapter + UI)
  * - 더미 메타데이터 목록
  * - 패턴 룰 관리(*_NO, *_ID 등)
  * - 자동추천 + 확정/예외 처리
  * - 백엔드 통합: window.__sensitiveCatalogAdapter 교체만으로 연결
  * ========================= */
 (function () {
   const W = window;

   /* ---------- tiny utils ---------- */
   const LS_RULES = 'dbam.sc.rules.v1';
   const LS_DECISIONS = 'dbam.sc.decisions.v1';
   const LS_META = 'dbam.sc.meta.v1';

   const esc = (s) => String(s ?? '')
     .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
     .replaceAll('"','&quot;').replaceAll("'","&#039;");

   const nowISO = () => {
     const d = new Date();
     const p = (n) => String(n).padStart(2,'0');
     return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
   };

   const readJSON = (k, fb) => {
     try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : fb; } catch (_) { return fb; }
   };
   const writeJSON = (k, v) => {
     try { localStorage.setItem(k, JSON.stringify(v)); } catch (_) {}
   };

   const keyOf = (c) => `${c.connId}|${c.schema}|${c.table}|${c.column}`.toUpperCase();

   function wildcardToRegex(pattern) {
     // "*_NO" -> /^.*_NO$/i
     const p = String(pattern || '').trim();
     const escaped = p.replace(/[.+^${}()|[\]\\]/g, '\\$&').replaceAll('*', '.*');
     return new RegExp(`^${escaped}$`, 'i');
   }

   function pill(text, tone) {
     const map = {
       ok:      { b:'#bbf7d0', c:'#166534', bg:'#f0fdf4' },
       warn:    { b:'#fde68a', c:'#92400e', bg:'#fffbeb' },
       bad:     { b:'#fecaca', c:'#991b1b', bg:'#fef2f2' },
       neutral: { b:'#e5e7eb', c:'#374151', bg:'#f9fafb' }
     };
     const t = map[tone] || map.neutral;
     return `<span style="display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid ${t.b};background:${t.bg};color:${t.c};font-size:10px;white-space:nowrap;">${esc(text)}</span>`;
   }

   function getConnections() {
     // 기존 콘솔 state에 있으면 재사용, 없으면 최소 샘플
     const s = W.state || (W.state = {});
     s.availableConns = s.availableConns || [
       { id:'CONN-001', label:'CORE-DB', env:'PROD' },
       { id:'CONN-002', label:'DW-DB', env:'QA' },
       { id:'CONN-003', label:'CRM-DB', env:'DEV' }
     ];
     return s.availableConns;
   }

   /* ---------- Adapter (Mock) ---------- */
   function createMockAdapter() {
     function ensureDefaults() {
       const rules = readJSON(LS_RULES, null);
       if (!rules) {
         writeJSON(LS_RULES, [
           { id:'R1', pattern:'*_NO',  type:'식별번호', enabled:true, note:'일련/식별 번호 계열' },
           { id:'R2', pattern:'*_ID',  type:'식별자',   enabled:true, note:'ID 계열' },
           { id:'R3', pattern:'*JUMIN*', type:'주민번호', enabled:true, note:'키워드 기반' },
           { id:'R4', pattern:'*ACCOUNT*', type:'계좌번호', enabled:true, note:'키워드 기반' },
           { id:'R5', pattern:'*CARD*', type:'카드번호', enabled:true, note:'키워드 기반' },
           { id:'R6', pattern:'*EMAIL*', type:'이메일', enabled:true, note:'키워드 기반' },
           { id:'R7', pattern:'*PHONE*', type:'전화번호', enabled:true, note:'키워드 기반' }
         ]);
       }
       const decisions = readJSON(LS_DECISIONS, null);
       if (!decisions) writeJSON(LS_DECISIONS, {}); // key -> decision
       const meta = readJSON(LS_META, null);
       if (!meta) writeJSON(LS_META, {}); // connId -> columns[]
     }

     function genColumnsFor(conn) {
       const seed = (conn.id || '').split('').reduce((a,ch)=>a+ch.charCodeAt(0),0);
       const env = conn.env || (seed%2?'DEV':'PROD');
       const schema = (seed%2)?'APP':'SCM';
       const db = (seed%3===0)?'ORCL':'POSTGRES';
       const t1 = 'USERS', t2 = 'ACCOUNTS', t3 = 'TXN', t4 = 'CUSTOMER';

       const base = [
         // USERS
         { table:t1, column:'USER_ID', dataType:'VARCHAR2' },
         { table:t1, column:'USER_NAME', dataType:'VARCHAR2' },
         { table:t1, column:'EMAIL', dataType:'VARCHAR2' },
         { table:t1, column:(seed%2?'PHONE_NO':'PHONE'), dataType:'VARCHAR2' },
         { table:t1, column:(seed%3===0?'JUMIN_NO':'SSN_NO'), dataType:'VARCHAR2' },

         // ACCOUNTS
         { table:t2, column:'ACCOUNT_ID', dataType:'VARCHAR2' },
         { table:t2, column:'ACCOUNT_NO', dataType:'VARCHAR2' },
         { table:t2, column:'OWNER_ID', dataType:'VARCHAR2' },

         // TXN
         { table:t3, column:'TXN_ID', dataType:'VARCHAR2' },
         { table:t3, column:'CARD_NO', dataType:'VARCHAR2' },
         { table:t3, column:'AMOUNT', dataType:'NUMBER' },
         { table:t3, column:'CREATED_AT', dataType:'TIMESTAMP' },

         // CUSTOMER
         { table:t4, column:'CUST_ID', dataType:'VARCHAR2' },
         { table:t4, column:'CUST_NO', dataType:'VARCHAR2' },
         { table:t4, column:'ADDRESS', dataType:'VARCHAR2' }
       ];

       return base.map(x => ({
         connId: conn.id,
         connLabel: conn.label || conn.id,
         env,
         db,
         schema,
         table: x.table,
         column: x.column,
         dataType: x.dataType,
         discoveredAt: nowISO()
       }));
     }

     ensureDefaults();

     return {
       async listConnections() {
         return getConnections();
       },
       async fetchColumns({ connId }) {
         const store = readJSON(LS_META, {});
         if (!store[connId]) {
           const conn = getConnections().find(c => c.id === connId) || { id: connId, label: connId, env:'DEV' };
           store[connId] = genColumnsFor(conn);
           writeJSON(LS_META, store);
         }
         return store[connId];
       },
       async rescan({ connId }) {
         const store = readJSON(LS_META, {});
         const conn = getConnections().find(c => c.id === connId) || { id: connId, label: connId, env:'DEV' };
         store[connId] = genColumnsFor(conn).map(c => ({ ...c, discoveredAt: nowISO() }));
         writeJSON(LS_META, store);
         return store[connId];
       },
       async listRules() {
         return readJSON(LS_RULES, []);
       },
       async saveRules(rules) {
         writeJSON(LS_RULES, Array.isArray(rules) ? rules : []);
         return true;
       },
       async listDecisions() {
         return readJSON(LS_DECISIONS, {});
       },
       async saveDecision(decision) {
         const decisions = readJSON(LS_DECISIONS, {});
         decisions[decision.key] = decision;
         writeJSON(LS_DECISIONS, decisions);
         return true;
       },
       async removeDecision(key) {
         const decisions = readJSON(LS_DECISIONS, {});
         delete decisions[key];
         writeJSON(LS_DECISIONS, decisions);
         return true;
       }
     };
   }

   /* ---------- Service (Adapter-swappable) ---------- */
   W.sensitiveCatalogService = W.sensitiveCatalogService || (function () {
     const adapter = W.__sensitiveCatalogAdapter || createMockAdapter();

     function defaultMasking(type) {
       const map = {
         '주민번호': 'MASK_ALL',
         '계좌번호': 'MASK_ALL',
         '카드번호': 'MASK_ALL',
         '전화번호': 'PARTIAL',
         '이메일': 'PARTIAL',
         '식별자': 'HASH',
         '식별번호': 'PARTIAL'
       };
       return map[type] || 'NONE';
     }

     function recommend(columns, rules, decisions) {
       const enabled = (rules || []).filter(r => r && r.enabled && r.pattern);
       const compiled = enabled.map(r => ({ ...r, rx: wildcardToRegex(r.pattern) }));

       const out = [];
       for (const c of (columns || [])) {
         const k = keyOf(c);
         if (decisions && decisions[k]) continue; // 이미 확정/예외 처리된 건 제외

         const colName = String(c.column || '');
         const hit = compiled.find(r => r.rx.test(colName));
         if (!hit) continue;

         out.push({
           ...c,
           key: k,
           ruleId: hit.id,
           rulePattern: hit.pattern,
           type: hit.type,
           masking: defaultMasking(hit.type)
         });
       }
       return out;
     }

     return {
       adapter,
       async load({ connId }) {
         const [cols, rules, decisions] = await Promise.all([
           adapter.fetchColumns({ connId }),
           adapter.listRules(),
           adapter.listDecisions()
         ]);
         return { cols, rules, decisions };
       },
       async rescan({ connId }) {
         return adapter.rescan({ connId });
       },
       async saveRules(rules) {
         return adapter.saveRules(rules);
       },
       recommend,
       async confirm(candidate, reason) {
         const key = candidate.key || keyOf(candidate);
         const decision = {
           key,
           connId: candidate.connId,
           schema: candidate.schema,
           table: candidate.table,
           column: candidate.column,
           status: 'CONFIRMED',
           type: candidate.type,
           masking: candidate.masking,
           rulePattern: candidate.rulePattern,
           reason: reason || '',
           updatedAt: nowISO()
         };
         await adapter.saveDecision(decision);
         return decision;
       },
       async except(candidate, reason) {
         const key = candidate.key || keyOf(candidate);
         const decision = {
           key,
           connId: candidate.connId,
           schema: candidate.schema,
           table: candidate.table,
           column: candidate.column,
           status: 'EXCEPTION',
           type: '',
           masking: '',
           rulePattern: candidate.rulePattern || '',
           reason: reason || '',
           updatedAt: nowISO()
         };
         await adapter.saveDecision(decision);
         return decision;
       },
       async undo(key) {
         return adapter.removeDecision(key);
       }
     };
   })();

   /* ---------- UI (Admin) ---------- */
   const sensitiveCatalogAdmin = {
     __v: '2025-12-22',
     connId: null,
     q: '',
     _bound: false,

     open() {
       const conns = getConnections();
       if (!this.connId) this.connId = (conns[0] && conns[0].id) || 'CONN-001';

       const ov = document.getElementById('adminOverlay');
       if (ov) { ov.classList.add('show'); ov.setAttribute('aria-hidden', 'false'); }

       document.querySelectorAll('.admin-nav button').forEach(btn => {
         btn.classList.toggle('active', btn.dataset.section === 'dbSensitive');
       });

       const titleEl = document.getElementById('adminTitle');
       const descEl  = document.getElementById('adminDesc');
       const bodyEl  = document.getElementById('adminBody');

       if (titleEl) titleEl.innerHTML = `<i class="fa-solid fa-key"></i> 민감정보(테이블/컬럼) 목록`;
       if (descEl)  descEl.textContent = '컬럼 메타데이터 기반으로 패턴 룰 매칭 후보를 추천하고, 확정/예외로 분류를 관리합니다.';
       if (!bodyEl) return;

       bodyEl.innerHTML = this.getTemplateHtml();
       this.bindOnce();
       this.refresh();
     },

     getTemplateHtml() {
       return `
         <div id="scPage" class="emg-page">
           <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
             <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
               <select id="scConn" class="export-input" style="min-width:240px;"></select>
               <input id="scQ" class="export-input" placeholder="검색(테이블/컬럼)" style="min-width:220px;" />
               <button class="btn" data-sc-act="rescan"><i class="fa-solid fa-rotate"></i> 메타데이터 갱신</button>
               <button class="btn" data-sc-act="refresh"><i class="fa-solid fa-magnifying-glass"></i> 조회</button>
               <div style="margin-left:auto; font-size:12px; color:var(--muted);">
                 갱신: <span id="scUpdatedAt">-</span>
               </div>
             </div>
             <div class="admin-footer">백엔드 통합 시 window.__sensitiveCatalogAdapter 교체로 연결합니다.</div>
           </div>

           <div style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap:10px; align-items:start;">
             <!-- Left: metadata + recommendations -->
             <div>
               <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
                 <div class="admin-header">
                   <h2><i class="fa-solid fa-table"></i> 컬럼 메타데이터</h2>
                   <span class="badge" id="scMetaCount">0건</span>
                 </div>
                 <div style="overflow:auto; margin-top:10px; border:1px solid var(--line); border-radius:10px;">
                   <table style="width:100%; min-width:860px; border-collapse:collapse; font-size:12px;">
                     <thead>
                       <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                         <th style="text-align:left; padding:8px; width:80px;">환경</th>
                         <th style="text-align:left; padding:8px; width:110px;">DB</th>
                         <th style="text-align:left; padding:8px; width:110px;">스키마</th>
                         <th style="text-align:left; padding:8px; width:140px;">테이블</th>
                         <th style="text-align:left; padding:8px; width:180px;">컬럼</th>
                         <th style="text-align:left; padding:8px; width:110px;">타입</th>
                         <th style="text-align:left; padding:8px; min-width:140px;">상태</th>
                       </tr>
                     </thead>
                     <tbody id="scMetaTbody"></tbody>
                   </table>
                 </div>
               </div>

               <div class="admin-card" style="padding:12px 14px;">
                 <div class="admin-header">
                   <h2><i class="fa-solid fa-wand-magic-sparkles"></i> 자동 추천</h2>
                   <span class="badge" id="scRecoCount">0건</span>
                 </div>
                 <div style="overflow:auto; margin-top:10px; border:1px solid var(--line); border-radius:10px;">
                   <table style="width:100%; min-width:920px; border-collapse:collapse; font-size:12px;">
                     <thead>
                       <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                         <th style="text-align:left; padding:8px; width:110px;">테이블</th>
                         <th style="text-align:left; padding:8px; width:200px;">컬럼</th>
                         <th style="text-align:left; padding:8px; width:120px;">추천유형</th>
                         <th style="text-align:left; padding:8px; width:120px;">마스킹</th>
                         <th style="text-align:left; padding:8px;">근거</th>
                         <th style="text-align:right; padding:8px; width:170px;">처리</th>
                       </tr>
                     </thead>
                     <tbody id="scRecoTbody"></tbody>
                   </table>
                 </div>
                 <div class="admin-footer">확정/예외 처리된 항목은 추천 목록에서 제외됩니다.</div>
               </div>
             </div>

             <!-- Right: rule management + decisions -->
             <div>
               <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
                 <div class="admin-header">
                   <h2><i class="fa-solid fa-filter"></i> 패턴 룰</h2>
                   <span class="badge" id="scRuleCount">0건</span>
                 </div>

                 <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
                   <input id="scRulePattern" class="export-input" placeholder="패턴 (예: *_NO)" style="flex:1; min-width:140px;" />
                   <input id="scRuleType" class="export-input" placeholder="유형 (예: 주민번호)" style="flex:1; min-width:140px;" />
                   <button class="btn" data-sc-act="ruleAdd"><i class="fa-solid fa-plus"></i> 추가</button>
                 </div>

                 <div style="overflow:auto; margin-top:10px; border:1px solid var(--line); border-radius:10px; max-height:300px;">
                   <table style="width:100%; border-collapse:collapse; font-size:12px;">
                     <thead>
                       <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                         <th style="text-align:left; padding:8px;">패턴</th>
                         <th style="text-align:left; padding:8px;">유형</th>
                         <th style="text-align:center; padding:8px; width:70px;">사용</th>
                         <th style="text-align:right; padding:8px; width:70px;">삭제</th>
                       </tr>
                     </thead>
                     <tbody id="scRuleTbody"></tbody>
                   </table>
                 </div>
                 <div class="admin-footer">* 와일드카드만 지원합니다. (예: *_NO, *ACCOUNT*)</div>
               </div>

               <div class="admin-card" style="padding:12px 14px;">
                 <div class="admin-header">
                   <h2><i class="fa-solid fa-check-double"></i> 확정/예외 결과</h2>
                   <span class="badge" id="scDecCount">0건</span>
                 </div>
                 <div style="overflow:auto; margin-top:10px; border:1px solid var(--line); border-radius:10px; max-height:340px;">
                   <table style="width:100%; border-collapse:collapse; font-size:12px;">
                     <thead>
                       <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                         <th style="text-align:left; padding:8px;">대상</th>
                         <th style="text-align:left; padding:8px; width:90px;">상태</th>
                         <th style="text-align:left; padding:8px; width:110px;">유형</th>
                         <th style="text-align:right; padding:8px; width:70px;">되돌림</th>
                       </tr>
                     </thead>
                     <tbody id="scDecTbody"></tbody>
                   </table>
                 </div>
                 <div class="admin-footer">되돌림 시 추천에 다시 나타납니다.</div>
               </div>
             </div>
           </div>
         </div>
       `;
     },

     bindOnce() {
       if (this._bound) return;
       this._bound = true;

       const body = document.getElementById('adminBody');
       if (!body) return;

       body.addEventListener('click', async (e) => {
         const page = document.getElementById('scPage');
         if (!page || !page.contains(e.target)) return;

         const btn = e.target.closest('[data-sc-act]');
         if (btn) {
           const act = btn.dataset.scAct;
           if (act === 'refresh') return this.refresh();
           if (act === 'rescan')  return this.rescan();
           if (act === 'ruleAdd') return this.ruleAdd();
         }

         const a = e.target.closest('[data-sc-row-act]');
         if (!a) return;

         const act = a.dataset.scRowAct;
         if (act === 'confirm') return this.rowConfirm(a.dataset.key);
         if (act === 'except')  return this.rowExcept(a.dataset.key);
         if (act === 'ruleDel') return this.ruleDel(a.dataset.id);
         if (act === 'decUndo') return this.decUndo(a.dataset.key);
       });

       body.addEventListener('change', (e) => {
         const page = document.getElementById('scPage');
         if (!page || !page.contains(e.target)) return;

         if (e.target.id === 'scConn') { this.connId = e.target.value; this.refresh(); }
         if (e.target.id === 'scQ')    { this.q = e.target.value || ''; }
         if (e.target.dataset && e.target.dataset.scRuleToggle === '1') {
           const id = e.target.dataset.id;
           this.ruleToggle(id, e.target.checked);
         }
       });
     },

     async initConnSelect() {
       const sel = document.getElementById('scConn');
       if (!sel) return;

       const conns = await W.sensitiveCatalogService.adapter.listConnections();
       if (sel.options.length === 0) {
         sel.innerHTML = conns.map(c =>
           `<option value="${esc(c.id)}">${esc(c.label || c.id)}${c.env ? ` (${esc(c.env)})` : ''}</option>`
         ).join('');
       }
       sel.value = this.connId;
     },

     async refresh() {
       await this.initConnSelect();

       const { cols, rules, decisions } = await W.sensitiveCatalogService.load({ connId: this.connId });

       const q = (document.getElementById('scQ')?.value ?? this.q ?? '').trim().toUpperCase();
       const filtered = !q ? cols : cols.filter(c =>
         String(c.table||'').toUpperCase().includes(q) || String(c.column||'').toUpperCase().includes(q)
       );

       const reco = W.sensitiveCatalogService.recommend(filtered, rules, decisions);

       this._cache = { cols: filtered, rules, decisions, reco, recoMap: Object.fromEntries(reco.map(r => [r.key, r])) };

       this.renderMeta(filtered, decisions);
       this.renderRules(rules);
       this.renderReco(reco);
       this.renderDecisions(decisions);

       const up = document.getElementById('scUpdatedAt');
       if (up) up.textContent = nowISO();
     },

     async rescan() {
       await this.initConnSelect();
       await W.sensitiveCatalogService.rescan({ connId: this.connId });
       return this.refresh();
     },

     renderMeta(cols, decisions) {
       const tb = document.getElementById('scMetaTbody');
       if (!tb) return;

       tb.innerHTML = cols.map(c => {
         const k = keyOf(c);
         const d = decisions[k];
         let status = pill('미분류', 'neutral');
         if (d && d.status === 'CONFIRMED') status = pill('확정', 'ok');
         if (d && d.status === 'EXCEPTION') status = pill('예외', 'warn');

         return `
           <tr style="border-bottom:1px solid #f1f5f9;">
             <td style="padding:8px;">${esc(c.env || '')}</td>
             <td style="padding:8px;">${esc(c.db || '')}</td>
             <td style="padding:8px;">${esc(c.schema || '')}</td>
             <td style="padding:8px; font-weight:700;">${esc(c.table || '')}</td>
             <td style="padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace;">${esc(c.column || '')}</td>
             <td style="padding:8px;">${esc(c.dataType || '')}</td>
             <td style="padding:8px;">${status}</td>
           </tr>
         `;
       }).join('');

       const cnt = document.getElementById('scMetaCount');
       if (cnt) cnt.textContent = `${cols.length}건`;
     },

     renderRules(rules) {
       const tb = document.getElementById('scRuleTbody');
       if (!tb) return;

       tb.innerHTML = (rules || []).map(r => `
         <tr style="border-bottom:1px solid #f1f5f9;">
           <td style="padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace;">${esc(r.pattern)}</td>
           <td style="padding:8px; font-weight:700;">${esc(r.type || '')}</td>
           <td style="padding:8px; text-align:center;">
             <input type="checkbox" ${r.enabled ? 'checked' : ''} data-sc-rule-toggle="1" data-id="${esc(r.id)}" />
           </td>
           <td style="padding:8px; text-align:right;">
             <button class="btn" data-sc-row-act="ruleDel" data-id="${esc(r.id)}"><i class="fa-solid fa-trash"></i></button>
           </td>
         </tr>
       `).join('');

       const cnt = document.getElementById('scRuleCount');
       if (cnt) cnt.textContent = `${(rules||[]).length}건`;
     },

     renderReco(reco) {
       const tb = document.getElementById('scRecoTbody');
       if (!tb) return;

       tb.innerHTML = reco.map(r => `
         <tr style="border-bottom:1px solid #f1f5f9;">
           <td style="padding:8px; font-weight:700;">${esc(r.table || '')}</td>
           <td style="padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace;">${esc(r.column || '')}</td>
           <td style="padding:8px;">${pill(r.type || '-', 'neutral')}</td>
           <td style="padding:8px;">${pill(r.masking || '-', 'neutral')}</td>
           <td style="padding:8px; color:#475569;">
             ${pill(r.rulePattern || '-', 'neutral')}
           </td>
           <td style="padding:8px; text-align:right; white-space:nowrap;">
             <button class="btn" data-sc-row-act="confirm" data-key="${esc(r.key)}"><i class="fa-solid fa-check"></i> 확정</button>
             <button class="btn" data-sc-row-act="except" data-key="${esc(r.key)}"><i class="fa-solid fa-ban"></i> 예외</button>
           </td>
         </tr>
       `).join('');

       const cnt = document.getElementById('scRecoCount');
       if (cnt) cnt.textContent = `${reco.length}건`;
     },

     renderDecisions(decisions) {
       const tb = document.getElementById('scDecTbody');
       if (!tb) return;

       const rows = Object.values(decisions || {}).sort((a,b) => String(b.updatedAt||'').localeCompare(String(a.updatedAt||'')));
       tb.innerHTML = rows.map(d => {
         const target = `${d.schema}.${d.table}.${d.column}`;
         const st = (d.status === 'CONFIRMED') ? pill('확정','ok') : pill('예외','warn');
         const type = d.type ? pill(d.type,'neutral') : '-';
         return `
           <tr style="border-bottom:1px solid #f1f5f9;">
             <td style="padding:8px;">
               <div style="font-weight:700;">${esc(target)}</div>
               <div style="font-size:11px; color:#64748b; margin-top:2px;">${esc(d.updatedAt || '')}${d.reason ? ` · ${esc(d.reason)}` : ''}</div>
             </td>
             <td style="padding:8px;">${st}</td>
             <td style="padding:8px;">${type}</td>
             <td style="padding:8px; text-align:right;">
               <button class="btn" data-sc-row-act="decUndo" data-key="${esc(d.key)}"><i class="fa-solid fa-rotate-left"></i></button>
             </td>
           </tr>
         `;
       }).join('');

       const cnt = document.getElementById('scDecCount');
       if (cnt) cnt.textContent = `${rows.length}건`;
     },

     async ruleAdd() {
       const patternEl = document.getElementById('scRulePattern');
       const typeEl = document.getElementById('scRuleType');
       const pattern = (patternEl?.value || '').trim();
       const type = (typeEl?.value || '').trim();

       if (!pattern || !type) {
         alert('패턴과 유형을 입력하세요.');
         return;
       }
       if (!pattern.includes('*')) {
         alert("현재는 '*' 와일드카드 기반 패턴만 권장합니다. 예: *_NO");
         // 그래도 등록은 허용
       }

       const rules = (this._cache?.rules || []).slice();
       const id = 'R' + Math.floor(Date.now() / 1000) + '_' + Math.floor(Math.random()*1000); // UI 식별자용(보안용 아님)
       rules.unshift({ id, pattern, type, enabled:true, note:'' });

       await W.sensitiveCatalogService.saveRules(rules);
       if (patternEl) patternEl.value = '';
       if (typeEl) typeEl.value = '';
       return this.refresh();
     },

     async ruleDel(id) {
       const rules = (this._cache?.rules || []).filter(r => r.id !== id);
       await W.sensitiveCatalogService.saveRules(rules);
       return this.refresh();
     },

     async ruleToggle(id, enabled) {
       const rules = (this._cache?.rules || []).map(r => r.id === id ? { ...r, enabled: !!enabled } : r);
       await W.sensitiveCatalogService.saveRules(rules);
       return this.refresh();
     },

     async rowConfirm(key) {
       const r = this._cache?.recoMap?.[key];
       if (!r) return;
       const reason = prompt('확정 사유(선택)', '') || '';
       await W.sensitiveCatalogService.confirm(r, reason);
       return this.refresh();
     },

     async rowExcept(key) {
       const r = this._cache?.recoMap?.[key];
       if (!r) return;
       const reason = prompt('예외 사유(필수)', '');
       if (!reason) return;
       await W.sensitiveCatalogService.except(r, reason);
       return this.refresh();
     },

     async decUndo(key) {
       await W.sensitiveCatalogService.undo(key);
       return this.refresh();
     }
   };

   W.sensitiveCatalogAdmin = sensitiveCatalogAdmin;

   /* ---------- route binding (정식 라우팅 한 번만) ---------- */
   if (W.admin && typeof W.admin.registerItemHandler === 'function' && !W.admin.__dbSensitive_sensitiveCatalogBound) {
     W.admin.__dbSensitive_sensitiveCatalogBound = true;
     W.admin.registerItemHandler('dbSensitive', 'sensitiveCatalog', () => W.sensitiveCatalogAdmin.open());
   }
 })();

 
/* =========================
 * Admin > DB/민감정보 관리 > 민감 컬럼 마스킹 정책
 * - 유형별 기본 룰
 * - 예외 승인(만료 포함)
 * - 다운로드 시 적용 규칙
 * - 적용 미리보기
 * - 민감정보(테이블/컬럼) 목록에서 바로 이동 버튼 연결
 * ========================= */
(function () {
  const W = window;

  // ---- state bridge (기존 const state 우선 사용) ----
  function getState() {
    try { if (typeof state !== 'undefined' && state) return state; } catch (_) {} // eslint-disable-line no-undef
    W.__fallbackState = W.__fallbackState || {};
    return W.__fallbackState;
  }

  // -------- helpers --------
  function esc(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }
  function nowISO() {
    const d = new Date();
    const p = (n) => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${p(d.getMonth() + 1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }
  function strHash(s) {
    s = String(s ?? '');
    let h = 0 >>> 0;
    for (let i = 0; i < s.length; i++) h = (((h * 31) >>> 0) + s.charCodeAt(i)) >>> 0;
    return h >>> 0;
  }
  function uid(prefix) {
    return `${prefix}-${Date.now().toString(36)}-${Math.floor(Math.random() * 1e6).toString(36)}`;
  }
  function pill(text, tone) {
    const map = {
      ok:      { b: '#bbf7d0', c: '#166534', bg: '#f0fdf4' },
      warn:    { b: '#fde68a', c: '#92400e', bg: '#fffbeb' },
      bad:     { b: '#fecaca', c: '#991b1b', bg: '#fef2f2' },
      neutral: { b: '#e5e7eb', c: '#374151', bg: '#f9fafb' },
    };
    const t = map[tone] || map.neutral;
    return `<span style="display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid ${t.b};background:${t.bg};color:${t.c};font-size:10px;white-space:nowrap;">${esc(text)}</span>`;
  }

  function getConnLabel(connId) {
    const s = getState();
    const c = (s.availableConns || []).find(x => x.id === connId);
    return c?.label || connId;
  }
  function getConnEnv(connId) {
    const s = getState();
    if (s.connEnvs && Object.prototype.hasOwnProperty.call(s.connEnvs, connId)) return s.connEnvs[connId] || '';
    const c = (s.availableConns || []).find(x => x.id === connId);
    return c?.env || 'DEV';
  }

  // -------- store --------
  function ensureSensitiveCatalog() {
    const s = getState();
    s.sensitiveCatalog = s.sensitiveCatalog || { items: [], lastScanByConn: {} };
    return s.sensitiveCatalog;
  }

  function ensureMaskingPolicyStore() {
    const s = getState();
    if (!s.maskingPolicy) {
      s.maskingPolicy = {
        defaultsByCategory: {
          '주민번호': { masking: 'PARTIAL', exposePrefix: 6, exposeSuffix: 0, encryptedRecommend: 'Y', note: '앞 6자리 노출, 나머지 마스킹' },
          '계좌번호': { masking: 'PARTIAL', exposePrefix: 2, exposeSuffix: 3, encryptedRecommend: 'N', note: '앞 2/뒤 3 노출' },
          '카드번호': { masking: 'TOKEN',   exposePrefix: 6, exposeSuffix: 4, encryptedRecommend: 'Y', note: '토큰화 권장(대체값 사용)' },
          '연락처':   { masking: 'PARTIAL', exposePrefix: 3, exposeSuffix: 2, encryptedRecommend: 'N', note: '앞 3/뒤 2 노출' },
          '이메일':   { masking: 'PARTIAL', exposePrefix: 2, exposeSuffix: 0, encryptedRecommend: 'N', note: '로컬 파트 일부 노출' },
          '주소':     { masking: 'NONE',    exposePrefix: 0, exposeSuffix: 0, encryptedRecommend: 'N', note: '업무 특성에 따라 별도 결정' },
          '성명':     { masking: 'PARTIAL', exposePrefix: 1, exposeSuffix: 0, encryptedRecommend: 'N', note: '첫 글자만 노출' },
          '기타':     { masking: 'PARTIAL', exposePrefix: 0, exposeSuffix: 0, encryptedRecommend: 'N', note: '기본값(전체 마스킹)' },
        },
        downloadRules: {
          // 민감 포함 다운로드 처리
          mode: 'MASK',                 // BLOCK | MASK | ALLOW
          maxRowsNoApproval: 2000,      // 승인 없이 허용 건수(비민감 기준)
          maxRowsSensitive: 200,        // 민감 포함 시 기본 허용(초과 시 승인)
          requireReason: true,
          requireApprovalSensitive: true,
          expireHours: 24,
          note: '민감 포함 다운로드는 기본 마스킹 후 제공, 대량은 승인 필요',
          updatedAt: nowISO(),
        },
        exceptions: [
          // {id, scope, connId, schema, table, column, category, requestedBy, reason, status, approver, expiresAt, createdAt, decidedAt, decisionNote}
        ],
        updatedAt: nowISO(),
      };
    }
    return s.maskingPolicy;
  }

  // -------- masking engine (preview) --------
  function shortHashToken(v) {
    const h = strHash(String(v ?? ''));
    return h.toString(36).toUpperCase().padStart(6, '0').slice(0, 10);
  }

  function applyMasking(value, category, rule) {
    const v = String(value ?? '');
    const m = (rule?.masking || 'NONE').toUpperCase();

    if (!v) return '';
    if (m === 'NONE') return v;
    if (m === 'HASH') return `HASH:${shortHashToken(v)}`;
    if (m === 'TOKEN') return `TKN-${shortHashToken(v)}`;

    // PARTIAL (카테고리별 기본)
    const pre = Number(rule?.exposePrefix ?? 0);
    const suf = Number(rule?.exposeSuffix ?? 0);

    // 이메일: 로컬 파트 중심 마스킹
    if (category === '이메일') {
      const at = v.indexOf('@');
      if (at <= 0) return (pre > 0 ? v.slice(0, pre) : '') + '***';
      const local = v.slice(0, at);
      const domain = v.slice(at);
      const keep = Math.min(Math.max(pre || 1, 1), Math.max(local.length, 1));
      const head = local.slice(0, keep);
      return head + '***' + domain;
    }

    // 성명: 첫 글자만
    if (category === '성명') {
      return v.slice(0, 1) + '*'.repeat(Math.max(v.length - 1, 2));
    }

    // 공통: prefix/suffix 노출
    if (pre + suf >= v.length) return '*'.repeat(v.length);
    const head = pre > 0 ? v.slice(0, pre) : '';
    const tail = suf > 0 ? v.slice(v.length - suf) : '';
    const midLen = Math.max(v.length - head.length - tail.length, 0);
    return head + '*'.repeat(midLen) + tail;
  }

  function isExceptionActive(ex) {
    if (!ex) return false;
    if (ex.status !== 'APPROVED') return false;
    if (!ex.expiresAt) return true;
    return new Date(ex.expiresAt).getTime() > Date.now();
  }

  function getDefaultRuleForCategory(catName) {
    const mp = ensureMaskingPolicyStore();
    return mp.defaultsByCategory[catName] || mp.defaultsByCategory['기타'];
  }

  function findActiveExceptionForItem(item) {
    const mp = ensureMaskingPolicyStore();
    return (mp.exceptions || []).find(ex => {
      if (!isExceptionActive(ex)) return false;
      if (ex.scope !== 'COLUMN') return false;
      if (ex.connId !== item.connId) return false;
      if ((ex.schema || '') !== (item.schema || '')) return false;
      if ((ex.table || '') !== (item.table || '')) return false;
      if ((ex.column || '') !== (item.column || '')) return false;
      return true;
    });
  }

  // -------- modal --------
  function ensureModal() {
    let bd = document.getElementById('mpModalBackdrop');
    if (bd) return bd;

    bd = document.createElement('div');
    bd.id = 'mpModalBackdrop';
    bd.className = 'export-modal-backdrop';
    bd.innerHTML = `
      <div class="export-modal" style="max-width:960px;width:calc(100vw - 40px);">
        <div class="export-modal-header">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <h3 id="mpModalTitle" style="margin:0;font-size:14px;"></h3>
            <button class="btn" id="mpModalCloseBtn"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>
        <div id="mpModalBody" style="margin-top:10px;"></div>
        <div id="mpModalFooter" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;"></div>
      </div>
    `;
    document.body.appendChild(bd);
    bd.addEventListener('click', (e) => { if (e.target === bd) bd.classList.remove('show'); });
    bd.querySelector('#mpModalCloseBtn').addEventListener('click', () => bd.classList.remove('show'));
    return bd;
  }

  function openModal(title, bodyHtml, footerButtons) {
    const bd = ensureModal();
    bd.querySelector('#mpModalTitle').innerHTML = title;
    bd.querySelector('#mpModalBody').innerHTML = bodyHtml;
    const ft = bd.querySelector('#mpModalFooter');
    ft.innerHTML = '';
    (footerButtons || []).forEach(btn => {
      const b = document.createElement('button');
      b.className = btn.className || 'btn';
      b.innerHTML = btn.label;
      b.addEventListener('click', () => btn.onClick && btn.onClick());
      ft.appendChild(b);
    });
    bd.classList.add('show');
  }

  // -------- page --------
  const maskingPolicyAdmin = {
    tab: 'defaults', // defaults | exceptions | download | preview
    focusItemId: null, // sensitiveCatalog item id
    filters: { exStatus: 'ALL', exConn: 'ALL', q: '' },

    open(ctx) {
      ensureMaskingPolicyStore();
      ensureSensitiveCatalog();

      this.tab = (ctx && ctx.tab) ? ctx.tab : 'defaults';
      this.focusItemId = ctx && ctx.focusItemId ? ctx.focusItemId : null;

      const ov = document.getElementById('adminOverlay');
      if (ov) { ov.classList.add('show'); ov.setAttribute('aria-hidden', 'false'); }
      document.querySelectorAll('.admin-nav button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.section === 'dbSensitive');
      });

      const titleEl = document.getElementById('adminTitle');
      const descEl = document.getElementById('adminDesc');
      const bodyEl = document.getElementById('adminBody');
      if (!titleEl || !descEl || !bodyEl) return;

      titleEl.innerHTML = `<i class="fa-solid fa-mask"></i> 민감 컬럼 마스킹 정책`;
      descEl.textContent = '유형별 기본 마스킹 룰, 예외 승인(만료 포함), 다운로드 시 적용 규칙, 미리보기';

      bodyEl.innerHTML = this.getTemplateHtml();
      this.bindOnce();
      this.renderAll();
    },

    getTemplateHtml() {
      return `
        <div id="mpPage" class="emg-page">
          <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn" data-mp-tab="defaults"><i class="fa-solid fa-sliders"></i> 기본 룰</button>
                <button class="btn" data-mp-tab="exceptions"><i class="fa-solid fa-user-shield"></i> 예외 승인</button>
                <button class="btn" data-mp-tab="download"><i class="fa-solid fa-file-arrow-down"></i> 다운로드 규칙</button>
                <button class="btn" data-mp-tab="preview"><i class="fa-solid fa-wand-magic-sparkles"></i> 미리보기</button>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <button class="btn" data-mp-act="go-catalog"><i class="fa-solid fa-arrow-left"></i> 민감정보 목록</button>
                <button class="btn primary" data-mp-act="apply-defaults"><i class="fa-solid fa-check"></i> 기본 룰 적용</button>
              </div>
            </div>
            <div class="admin-footer">“기본 룰 적용”은 민감정보(테이블/컬럼) 목록의 마스킹/암호화 권장값을 일괄 업데이트합니다.</div>
          </div>

          <div id="mpTabDefaults" style="display:none;"></div>
          <div id="mpTabExceptions" style="display:none;"></div>
          <div id="mpTabDownload" style="display:none;"></div>
          <div id="mpTabPreview" style="display:none;"></div>
        </div>
      `;
    },

    bindOnce() {
      const bodyEl = document.getElementById('adminBody');
      if (!bodyEl || bodyEl.dataset.mpBound === '1') return;
      bodyEl.dataset.mpBound = '1';

      bodyEl.addEventListener('click', (e) => {
        const page = document.getElementById('mpPage');
        if (!page || !page.contains(e.target)) return;

        const tabBtn = e.target.closest('[data-mp-tab]');
        if (tabBtn) {
          this.tab = tabBtn.dataset.mpTab;
          this.renderAll();
          return;
        }

        const actBtn = e.target.closest('[data-mp-act]');
        if (actBtn) {
          this.handleAction(actBtn.dataset.mpAct);
          return;
        }

        const ruleEdit = e.target.closest('[data-mp-edit-rule]');
        if (ruleEdit) {
          this.openEditRuleModal(ruleEdit.dataset.mpEditRule);
          return;
        }

        const exBtn = e.target.closest('[data-mp-ex-act]');
        if (exBtn) {
          this.handleExceptionAction(exBtn.dataset.mpExAct, exBtn.dataset.mpExId);
          return;
        }

        const pickItem = e.target.closest('[data-mp-pick-item]');
        if (pickItem) {
          this.focusItemId = pickItem.dataset.mpPickItem;
          this.tab = 'preview';
          this.renderAll();
          return;
        }
      });

      bodyEl.addEventListener('input', (e) => {
        const page = document.getElementById('mpPage');
        if (!page || !page.contains(e.target)) return;

        if (e.target.id === 'mpExKeyword') { this.filters.q = e.target.value || ''; this.renderExceptions(); }
        if (e.target.id === 'mpPrevSample') { this.renderPreviewResult(); }
      });

      bodyEl.addEventListener('change', (e) => {
        const page = document.getElementById('mpPage');
        if (!page || !page.contains(e.target)) return;

        if (e.target.id === 'mpExStatus') { this.filters.exStatus = e.target.value; this.renderExceptions(); }
        if (e.target.id === 'mpExConn') { this.filters.exConn = e.target.value; this.renderExceptions(); }

        if (e.target.id === 'mpPrevCategory' || e.target.id === 'mpPrevMask' || e.target.id === 'mpPrevPre' || e.target.id === 'mpPrevSuf') {
          this.renderPreviewResult();
        }
        if (e.target.id === 'mpDownloadMode' || e.target.id === 'mpDownloadMaxNo' || e.target.id === 'mpDownloadMaxSens' ||
            e.target.id === 'mpDownloadReqReason' || e.target.id === 'mpDownloadReqAppr' || e.target.id === 'mpDownloadExpire') {
          // 즉시 반영은 저장 버튼에서
        }
      });
    },

    renderAll() {
      // tab highlight
      document.querySelectorAll('#mpPage [data-mp-tab]').forEach(b => b.classList.toggle('primary', b.dataset.mpTab === this.tab));

      // tab containers
      const map = {
        defaults: 'mpTabDefaults',
        exceptions: 'mpTabExceptions',
        download: 'mpTabDownload',
        preview: 'mpTabPreview',
      };
      Object.values(map).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      const active = document.getElementById(map[this.tab]);
      if (active) active.style.display = 'block';

      // render
      this.renderDefaults();
      this.renderExceptions();
      this.renderDownload();
      this.renderPreview();
    },

    // ---- defaults ----
    renderDefaults() {
      const mp = ensureMaskingPolicyStore();
      const el = document.getElementById('mpTabDefaults');
      if (!el) return;

      const rows = Object.keys(mp.defaultsByCategory || {}).sort().map(cat => {
        const r = mp.defaultsByCategory[cat];
        const tone = (r.masking === 'NONE') ? 'neutral' : (r.masking === 'PARTIAL' ? 'warn' : 'ok');
        const encTone = (r.encryptedRecommend === 'Y') ? 'ok' : 'neutral';
        return `
          <tr style="border-bottom:1px solid #f1f5f9;">
            <td style="padding:8px; font-weight:700;">${esc(cat)}</td>
            <td style="padding:8px;">${pill(r.masking, tone)}</td>
            <td style="padding:8px;">${esc(String(r.exposePrefix ?? 0))}</td>
            <td style="padding:8px;">${esc(String(r.exposeSuffix ?? 0))}</td>
            <td style="padding:8px;">${pill(r.encryptedRecommend === 'Y' ? 'Y 권장' : 'N', encTone)}</td>
            <td style="padding:8px; color:#475569;">${esc(r.note || '')}</td>
            <td style="padding:8px; width:70px;">
              <button class="btn" data-mp-edit-rule="${esc(cat)}"><i class="fa-solid fa-pen"></i></button>
            </td>
          </tr>
        `;
      }).join('');

      el.innerHTML = `
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div style="flex:1.1; min-width:520px;">
            <div class="admin-card" style="padding:12px 14px;">
              <div class="admin-header">
                <h2><i class="fa-solid fa-sliders"></i> 유형별 기본 룰</h2>
                <span class="badge">갱신: ${esc(mp.updatedAt || '-')}</span>
              </div>
              <div style="overflow:auto; margin-top:10px; border:1px solid #e5e7eb; border-radius:8px;">
                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                  <thead>
                    <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                      <th style="text-align:left; padding:8px;">유형</th>
                      <th style="text-align:left; padding:8px; width:110px;">기본 마스킹</th>
                      <th style="text-align:left; padding:8px; width:70px;">Prefix</th>
                      <th style="text-align:left; padding:8px; width:70px;">Suffix</th>
                      <th style="text-align:left; padding:8px; width:100px;">암호화</th>
                      <th style="text-align:left; padding:8px;">설명</th>
                      <th style="text-align:left; padding:8px; width:70px;">수정</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>
              <div class="admin-footer">PARTIAL은 prefix/suffix 노출 기반, HASH/TOKEN은 고정 형식으로 대체합니다.</div>
            </div>
          </div>

          <div style="flex:0.9; min-width:320px;">
            <div class="admin-card" style="padding:12px 14px;">
              <div class="admin-header">
                <h2><i class="fa-solid fa-bolt"></i> 빠른 미리보기</h2>
                <span class="badge">선택 항목 반영</span>
              </div>

              <div style="margin-top:10px; display:grid; grid-template-columns:1fr; gap:8px;">
                <div style="font-size:12px; color:#475569;">
                  민감정보 목록에서 항목을 선택한 상태라면 “미리보기” 탭에서 예외 승인/다운로드 규칙까지 함께 확인할 수 있습니다.
                </div>
                <button class="btn primary" data-mp-tab="preview"><i class="fa-solid fa-wand-magic-sparkles"></i> 미리보기로 이동</button>
              </div>
            </div>

            ${this.renderFocusPickerCardHtml()}
          </div>
        </div>
      `;
    },

    openEditRuleModal(category) {
      const mp = ensureMaskingPolicyStore();
      const r = mp.defaultsByCategory[category] || { masking: 'PARTIAL', exposePrefix: 0, exposeSuffix: 0, encryptedRecommend: 'N', note: '' };

      openModal(
        `<i class="fa-solid fa-pen"></i> 기본 룰 수정: ${esc(category)}`,
        `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">기본 마스킹</div>
              <select id="mpRuleMask" class="export-input">
                <option value="NONE">NONE</option>
                <option value="PARTIAL">PARTIAL</option>
                <option value="HASH">HASH</option>
                <option value="TOKEN">TOKEN</option>
              </select>
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">암호화 권장</div>
              <select id="mpRuleEnc" class="export-input">
                <option value="N">N</option>
                <option value="Y">Y</option>
              </select>
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">Prefix(노출)</div>
              <input id="mpRulePre" class="export-input" type="number" min="0" value="${esc(r.exposePrefix ?? 0)}" />
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">Suffix(노출)</div>
              <input id="mpRuleSuf" class="export-input" type="number" min="0" value="${esc(r.exposeSuffix ?? 0)}" />
            </div>
            <div style="grid-column:1 / -1;">
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">설명</div>
              <input id="mpRuleNote" class="export-input" value="${esc(r.note || '')}" />
            </div>
          </div>
        `,
        [
          {
            label: '<i class="fa-solid fa-check"></i> 저장',
            className: 'btn primary',
            onClick: () => {
              const masking = (document.getElementById('mpRuleMask')?.value || 'PARTIAL').trim();
              const encryptedRecommend = (document.getElementById('mpRuleEnc')?.value || 'N').trim();
              const exposePrefix = Number(document.getElementById('mpRulePre')?.value || 0);
              const exposeSuffix = Number(document.getElementById('mpRuleSuf')?.value || 0);
              const note = (document.getElementById('mpRuleNote')?.value || '').trim();

              mp.defaultsByCategory[category] = { masking, exposePrefix: Math.max(exposePrefix, 0), exposeSuffix: Math.max(exposeSuffix, 0), encryptedRecommend, note };
              mp.updatedAt = nowISO();

              document.getElementById('mpModalBackdrop')?.classList.remove('show');
              this.renderDefaults();
              this.renderPreview(); // 즉시 반영
            }
          },
          {
            label: '<i class="fa-solid fa-xmark"></i> 취소',
            className: 'btn',
            onClick: () => document.getElementById('mpModalBackdrop')?.classList.remove('show')
          }
        ]
      );

      setTimeout(() => {
        const elMask = document.getElementById('mpRuleMask');
        const elEnc = document.getElementById('mpRuleEnc');
        if (elMask) elMask.value = (r.masking || 'PARTIAL');
        if (elEnc) elEnc.value = (r.encryptedRecommend === 'Y') ? 'Y' : 'N';
      }, 0);
    },

    // ---- exceptions ----
    renderExceptions() {
      const mp = ensureMaskingPolicyStore();
      const cat = ensureSensitiveCatalog();
      const el = document.getElementById('mpTabExceptions');
      if (!el) return;

      const s = getState();
      const conns = s.availableConns || [];
      const connOpts = [
        `<option value="ALL">DB(전체)</option>`,
        ...conns.map(c => `<option value="${esc(c.id)}">${esc(c.label || c.id)} (${esc(c.id)})</option>`)
      ].join('');

      const q = (this.filters.q || '').trim().toLowerCase();
      const fStatus = this.filters.exStatus || 'ALL';
      const fConn = this.filters.exConn || 'ALL';

      const list = (mp.exceptions || []).filter(ex => {
        if (fStatus !== 'ALL' && ex.status !== fStatus) return false;
        if (fConn !== 'ALL' && ex.connId !== fConn) return false;
        if (q) {
          const blob = [
            getConnLabel(ex.connId), ex.connId, ex.schema, ex.table, ex.column, ex.category,
            ex.requestedBy, ex.reason, ex.status, ex.approver, ex.decisionNote
          ].join(' ').toLowerCase();
          if (!blob.includes(q)) return false;
        }
        return true;
      }).sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));

      const rows = list.map(ex => {
        const stTone = (ex.status === 'APPROVED') ? 'ok' : (ex.status === 'PENDING' ? 'warn' : (ex.status === 'REJECTED' ? 'bad' : 'neutral'));
        const active = isExceptionActive(ex);
        const activePill = active ? pill('유효', 'ok') : pill('만료/비유효', 'neutral');

        return `
          <tr style="border-bottom:1px solid #f1f5f9;">
            <td style="padding:8px;">
              <div style="font-weight:700;">${esc(getConnLabel(ex.connId))}</div>
              <div style="font-size:11px; color:#64748b;">${esc(ex.connId)} · ${esc(getConnEnv(ex.connId))}</div>
            </td>
            <td style="padding:8px;">
              <div style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace;">
                ${esc((ex.schema || '-') + '.' + (ex.table || '-') + '.' + (ex.column || '-'))}
              </div>
              <div style="font-size:11px; color:#64748b;">${esc(ex.category || '')}</div>
            </td>
            <td style="padding:8px;">${pill(ex.status, stTone)} ${activePill}</td>
            <td style="padding:8px;">
              <div>${esc(ex.requestedBy || '-')}</div>
              <div style="font-size:11px; color:#64748b;">${esc(ex.createdAt || '-')}</div>
            </td>
            <td style="padding:8px; color:#475569;">${esc(ex.reason || '')}</td>
            <td style="padding:8px; width:180px;">
              <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
                <button class="btn" data-mp-ex-act="approve" data-mp-ex-id="${esc(ex.id)}"><i class="fa-solid fa-check"></i></button>
                <button class="btn" data-mp-ex-act="reject" data-mp-ex-id="${esc(ex.id)}"><i class="fa-solid fa-ban"></i></button>
                <button class="btn" data-mp-ex-act="expire" data-mp-ex-id="${esc(ex.id)}"><i class="fa-solid fa-clock"></i></button>
                <button class="btn" data-mp-ex-act="delete" data-mp-ex-id="${esc(ex.id)}"><i class="fa-solid fa-trash"></i></button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      el.innerHTML = `
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div style="flex:1.2; min-width:560px;">
            <div class="admin-card" style="padding:12px 14px;">
              <div class="admin-header">
                <h2><i class="fa-solid fa-user-shield"></i> 예외 승인 목록</h2>
                <span class="badge">${list.length}건</span>
              </div>

              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px;">
                <select id="mpExConn" class="export-input" style="max-width:240px;">${connOpts}</select>
                <select id="mpExStatus" class="export-input" style="max-width:170px;">
                  <option value="ALL">상태(전체)</option>
                  <option value="PENDING">PENDING</option>
                  <option value="APPROVED">APPROVED</option>
                  <option value="REJECTED">REJECTED</option>
                  <option value="EXPIRED">EXPIRED</option>
                </select>
                <input id="mpExKeyword" class="export-input" placeholder="검색(컬럼/요청자/사유)" style="flex:1; min-width:220px;" />
                <button class="btn primary" data-mp-act="new-exception"><i class="fa-solid fa-plus"></i> 예외 요청</button>
              </div>

              <div style="overflow:auto; margin-top:10px; border:1px solid #e5e7eb; border-radius:8px;">
                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                  <thead>
                    <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                      <th style="text-align:left; padding:8px;">DB</th>
                      <th style="text-align:left; padding:8px;">대상</th>
                      <th style="text-align:left; padding:8px; width:160px;">상태</th>
                      <th style="text-align:left; padding:8px; width:150px;">요청</th>
                      <th style="text-align:left; padding:8px;">사유</th>
                      <th style="text-align:left; padding:8px; width:190px;">처리</th>
                    </tr>
                  </thead>
                  <tbody>${rows || `<tr><td colspan="6" style="padding:12px; color:#64748b;">예외 승인 데이터가 없습니다.</td></tr>`}</tbody>
                </table>
              </div>

              <div class="admin-footer">APPROVED 상태이면서 만료 전이면 미리보기/다운로드 규칙 적용 시 “예외”로 처리됩니다.</div>
            </div>
          </div>

          <div style="flex:0.8; min-width:320px;">
            ${this.renderFocusPickerCardHtml(true)}
            <div class="admin-card" style="padding:12px 14px; margin-top:10px;">
              <div class="admin-header">
                <h2><i class="fa-solid fa-circle-info"></i> 예외 승인 기준(요약)</h2>
                <span class="badge">가이드</span>
              </div>
              <div style="margin-top:10px; font-size:12px; color:#0f172a; line-height:1.5;">
                • 목적(업무사유) 명확 + 기간(만료) 필수<br/>
                • 최소 범위(컬럼/테이블)로 요청<br/>
                • 승인 이력/결정 사유 기록<br/>
                • 만료 후 자동 비유효 처리
              </div>
            </div>
          </div>
        </div>
      `;

      // set selects
      const elConn = document.getElementById('mpExConn');
      const elSt = document.getElementById('mpExStatus');
      if (elConn) elConn.value = (conns.some(c => c.id === this.filters.exConn) ? this.filters.exConn : 'ALL');
      if (elSt) elSt.value = this.filters.exStatus || 'ALL';
    },

    openNewExceptionModal() {
      const s = getState();
      const mp = ensureMaskingPolicyStore();
      const cat = ensureSensitiveCatalog();
      const conns = s.availableConns || [];
      if (!conns.length) return alert('등록된 DB가 없습니다.');

      // focus item 있으면 자동 채움
      const focus = this.getFocusItem();
      const defaultConn = focus?.connId || conns[0].id;

      const connOpts = conns.map(c => `<option value="${esc(c.id)}">${esc(c.label || c.id)} (${esc(c.id)})</option>`).join('');
      openModal(
        `<i class="fa-solid fa-plus"></i> 예외 요청 생성`,
        `
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div style="grid-column:1 / -1;">
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">대상 DB</div>
              <select id="mpExFormConn" class="export-input">${connOpts}</select>
            </div>

            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">스키마</div>
              <input id="mpExFormSchema" class="export-input" placeholder="예) public" />
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">테이블</div>
              <input id="mpExFormTable" class="export-input" placeholder="예) CUSTOMER" />
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">컬럼</div>
              <input id="mpExFormColumn" class="export-input" placeholder="예) RESIDENT_NO" />
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">유형</div>
              <select id="mpExFormCat" class="export-input">
                <option value="주민번호">주민번호</option>
                <option value="계좌번호">계좌번호</option>
                <option value="카드번호">카드번호</option>
                <option value="연락처">연락처</option>
                <option value="이메일">이메일</option>
                <option value="주소">주소</option>
                <option value="성명">성명</option>
                <option value="기타">기타</option>
              </select>
            </div>

            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">요청자</div>
              <input id="mpExFormReqBy" class="export-input" placeholder="예) honggildong" />
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">만료(일)</div>
              <input id="mpExFormExpireDays" class="export-input" type="number" min="1" value="3" />
            </div>

            <div style="grid-column:1 / -1;">
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">요청 사유</div>
              <input id="mpExFormReason" class="export-input" placeholder="예) 고객 본인확인(콜센터), 기간 한정" />
            </div>

            <div style="grid-column:1 / -1; font-size:11px; color:#64748b;">
              ※ 예외 승인 시 미리보기/다운로드 규칙에서 해당 컬럼을 “비마스킹”으로 취급하도록 확장할 수 있습니다.
            </div>
          </div>
        `,
        [
          {
            label: '<i class="fa-solid fa-check"></i> 생성',
            className: 'btn primary',
            onClick: () => {
              const connId = (document.getElementById('mpExFormConn')?.value || '').trim();
              const schema = (document.getElementById('mpExFormSchema')?.value || '').trim();
              const table = (document.getElementById('mpExFormTable')?.value || '').trim();
              const column = (document.getElementById('mpExFormColumn')?.value || '').trim();
              const category = (document.getElementById('mpExFormCat')?.value || '기타').trim();
              const requestedBy = (document.getElementById('mpExFormReqBy')?.value || '').trim();
              const reason = (document.getElementById('mpExFormReason')?.value || '').trim();
              const days = Number(document.getElementById('mpExFormExpireDays')?.value || 1);

              if (!connId || !schema || !table || !column || !requestedBy || !reason) {
                return alert('대상/요청자/사유는 필수입니다.');
              }

              const ex = {
                id: uid('ex'),
                scope: 'COLUMN',
                connId, schema, table, column,
                category,
                requestedBy,
                reason,
                status: 'PENDING',
                approver: '',
                decisionNote: '',
                createdAt: nowISO(),
                decidedAt: '',
                expiresAt: new Date(Date.now() + Math.max(days, 1) * 24 * 3600 * 1000).toISOString(),
              };
              mp.exceptions.push(ex);
              mp.updatedAt = nowISO();

              document.getElementById('mpModalBackdrop')?.classList.remove('show');
              this.renderExceptions();
            }
          },
          {
            label: '<i class="fa-solid fa-xmark"></i> 취소',
            className: 'btn',
            onClick: () => document.getElementById('mpModalBackdrop')?.classList.remove('show')
          }
        ]
      );

      setTimeout(() => {
        const elConn = document.getElementById('mpExFormConn');
        if (elConn) elConn.value = defaultConn;

        if (focus) {
          const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v ?? ''; };
          set('mpExFormSchema', focus.schema || '');
          set('mpExFormTable', focus.table || '');
          set('mpExFormColumn', focus.column || '');
          set('mpExFormCat', focus.category || '기타');
        }
      }, 0);
    },

    handleExceptionAction(action, exId) {
      const mp = ensureMaskingPolicyStore();
      const ex = (mp.exceptions || []).find(x => x.id === exId);
      if (!ex) return;

      if (action === 'delete') {
        const ok = confirm('해당 예외 요청을 삭제할까요?');
        if (!ok) return;
        mp.exceptions = mp.exceptions.filter(x => x.id !== exId);
        mp.updatedAt = nowISO();
        this.renderExceptions();
        this.renderPreview();
        return;
      }

      if (action === 'expire') {
        ex.status = 'EXPIRED';
        ex.decidedAt = nowISO();
        ex.decisionNote = ex.decisionNote || '수동 만료 처리';
        mp.updatedAt = nowISO();
        this.renderExceptions();
        this.renderPreview();
        return;
      }

      if (action === 'approve' || action === 'reject') {
        openModal(
          action === 'approve' ? `<i class="fa-solid fa-check"></i> 승인 처리` : `<i class="fa-solid fa-ban"></i> 반려 처리`,
          `
            <div style="font-size:12px; color:#0f172a; margin-bottom:10px;">
              대상: <span style="font-family:ui-monospace,monospace;">${esc(ex.schema)}.${esc(ex.table)}.${esc(ex.column)}</span>
              · ${esc(getConnLabel(ex.connId))}
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div>
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">처리자</div>
                <input id="mpExDecApprover" class="export-input" placeholder="예) security.lead" />
              </div>
              <div>
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">만료(ISO)</div>
                <input id="mpExDecExpire" class="export-input" value="${esc(ex.expiresAt || '')}" />
              </div>
              <div style="grid-column:1 / -1;">
                <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">결정 사유</div>
                <input id="mpExDecNote" class="export-input" placeholder="결정 근거/조건" />
              </div>
            </div>
          `,
          [
            {
              label: '<i class="fa-solid fa-check"></i> 확정',
              className: 'btn primary',
              onClick: () => {
                const approver = (document.getElementById('mpExDecApprover')?.value || '').trim();
                const expiresAt = (document.getElementById('mpExDecExpire')?.value || '').trim();
                const note = (document.getElementById('mpExDecNote')?.value || '').trim();
                if (!approver) return alert('처리자는 필수입니다.');

                ex.status = (action === 'approve') ? 'APPROVED' : 'REJECTED';
                ex.approver = approver;
                ex.expiresAt = expiresAt || ex.expiresAt;
                ex.decisionNote = note || ex.decisionNote || '';
                ex.decidedAt = nowISO();
                mp.updatedAt = nowISO();

                document.getElementById('mpModalBackdrop')?.classList.remove('show');
                this.renderExceptions();
                this.renderPreview();
              }
            },
            {
              label: '<i class="fa-solid fa-xmark"></i> 취소',
              className: 'btn',
              onClick: () => document.getElementById('mpModalBackdrop')?.classList.remove('show')
            }
          ]
        );
      }
    },

    // ---- download ----
    renderDownload() {
      const mp = ensureMaskingPolicyStore();
      const el = document.getElementById('mpTabDownload');
      if (!el) return;

      const r = mp.downloadRules || {};
      el.innerHTML = `
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div style="flex:1.1; min-width:520px;">
            <div class="admin-card" style="padding:12px 14px;">
              <div class="admin-header">
                <h2><i class="fa-solid fa-file-arrow-down"></i> 다운로드 시 적용 규칙</h2>
                <span class="badge">갱신: ${esc(r.updatedAt || '-')}</span>
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                <div>
                  <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">민감 포함 시 처리</div>
                  <select id="mpDownloadMode" class="export-input">
                    <option value="BLOCK">BLOCK(차단)</option>
                    <option value="MASK">MASK(마스킹 후 제공)</option>
                    <option value="ALLOW">ALLOW(허용)</option>
                  </select>
                </div>

                <div>
                  <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">예외 승인 만료(시간)</div>
                  <input id="mpDownloadExpire" class="export-input" type="number" min="1" value="${esc(r.expireHours ?? 24)}" />
                </div>

                <div>
                  <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">비민감 다운로드(무승인 최대 건수)</div>
                  <input id="mpDownloadMaxNo" class="export-input" type="number" min="0" value="${esc(r.maxRowsNoApproval ?? 2000)}" />
                </div>

                <div>
                  <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">민감 포함 다운로드(기본 허용 건수)</div>
                  <input id="mpDownloadMaxSens" class="export-input" type="number" min="0" value="${esc(r.maxRowsSensitive ?? 200)}" />
                </div>

                <div style="display:flex; gap:8px; align-items:center;">
                  <input id="mpDownloadReqReason" type="checkbox" ${r.requireReason ? 'checked' : ''} />
                  <label for="mpDownloadReqReason" style="font-size:12px;">업무사유 필수</label>
                </div>

                <div style="display:flex; gap:8px; align-items:center;">
                  <input id="mpDownloadReqAppr" type="checkbox" ${r.requireApprovalSensitive ? 'checked' : ''} />
                  <label for="mpDownloadReqAppr" style="font-size:12px;">민감 포함 시 승인 필수(대량/정책 기준)</label>
                </div>

                <div style="grid-column:1 / -1;">
                  <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">설명</div>
                  <input id="mpDownloadNote" class="export-input" value="${esc(r.note || '')}" />
                </div>
              </div>

              <div style="display:flex; justify-content:flex-end; margin-top:12px; gap:8px;">
                <button class="btn primary" data-mp-act="save-download"><i class="fa-solid fa-check"></i> 저장</button>
              </div>

              <div class="admin-footer">
                민감 포함 여부는 “민감정보(테이블/컬럼) 목록” 기준으로 판단하며, 민감 포함 시 기본 룰(마스킹) + 예외 승인(허용 범위)을 우선 적용하도록 확장할 수 있습니다.
              </div>
            </div>
          </div>

          <div style="flex:0.9; min-width:320px;">
            <div class="admin-card" style="padding:12px 14px;">
              <div class="admin-header">
                <h2><i class="fa-solid fa-lightbulb"></i> 권장 운영 흐름</h2>
                <span class="badge">요약</span>
              </div>
              <div style="margin-top:10px; font-size:12px; color:#0f172a; line-height:1.55;">
                1) 조회/다운로드 요청 시 사유 수집<br/>
                2) 민감 포함이면 기본 마스킹 적용<br/>
                3) 대량(행수 기준) 또는 예외 필요 시 승인 요청<br/>
                4) 승인 결과/만료/다운로드 로그 보관
              </div>
            </div>

            ${this.renderFocusPickerCardHtml()}
          </div>
        </div>
      `;

      setTimeout(() => {
        const elMode = document.getElementById('mpDownloadMode');
        if (elMode) elMode.value = r.mode || 'MASK';
      }, 0);
    },

    saveDownloadRules() {
      const mp = ensureMaskingPolicyStore();
      mp.downloadRules = mp.downloadRules || {};

      const mode = (document.getElementById('mpDownloadMode')?.value || 'MASK').trim();
      const maxRowsNoApproval = Number(document.getElementById('mpDownloadMaxNo')?.value || 0);
      const maxRowsSensitive = Number(document.getElementById('mpDownloadMaxSens')?.value || 0);
      const requireReason = !!document.getElementById('mpDownloadReqReason')?.checked;
      const requireApprovalSensitive = !!document.getElementById('mpDownloadReqAppr')?.checked;
      const expireHours = Number(document.getElementById('mpDownloadExpire')?.value || 24);
      const note = (document.getElementById('mpDownloadNote')?.value || '').trim();

      mp.downloadRules = Object.assign({}, mp.downloadRules, {
        mode,
        maxRowsNoApproval: Math.max(maxRowsNoApproval, 0),
        maxRowsSensitive: Math.max(maxRowsSensitive, 0),
        requireReason,
        requireApprovalSensitive,
        expireHours: Math.max(expireHours, 1),
        note,
        updatedAt: nowISO(),
      });
      mp.updatedAt = nowISO();
      alert('다운로드 규칙이 저장되었습니다.');
      this.renderDownload();
      this.renderPreview();
    },

    // ---- preview ----
    renderPreview() {
      const mp = ensureMaskingPolicyStore();
      const cat = ensureSensitiveCatalog();
      const el = document.getElementById('mpTabPreview');
      if (!el) return;

      const focus = this.getFocusItem();
      const focusRule = focus ? getDefaultRuleForCategory(focus.category || '기타') : null;
      const focusEx = focus ? findActiveExceptionForItem(focus) : null;

      const catNames = Object.keys(mp.defaultsByCategory || {}).sort();
      const catOpts = catNames.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join('');

      // default preview controls (focus 우선)
      const initCategory = focus?.category || '주민번호';
      const initRule = getDefaultRuleForCategory(initCategory);

      el.innerHTML = `
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div style="flex:1.05; min-width:520px;">
            <div class="admin-card" style="padding:12px 14px;">
              <div class="admin-header">
                <h2><i class="fa-solid fa-wand-magic-sparkles"></i> 적용 미리보기</h2>
                <span class="badge">${focus ? '선택 항목 연동' : '수동 입력'}</span>
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                <div>
                  <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">유형</div>
                  <select id="mpPrevCategory" class="export-input">${catOpts}</select>
                </div>
                <div>
                  <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">마스킹 방식</div>
                  <select id="mpPrevMask" class="export-input">
                    <option value="NONE">NONE</option>
                    <option value="PARTIAL">PARTIAL</option>
                    <option value="HASH">HASH</option>
                    <option value="TOKEN">TOKEN</option>
                  </select>
                </div>

                <div>
                  <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">Prefix</div>
                  <input id="mpPrevPre" class="export-input" type="number" min="0" value="${esc(initRule.exposePrefix ?? 0)}" />
                </div>
                <div>
                  <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">Suffix</div>
                  <input id="mpPrevSuf" class="export-input" type="number" min="0" value="${esc(initRule.exposeSuffix ?? 0)}" />
                </div>

                <div style="grid-column:1 / -1;">
                  <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">샘플 값</div>
                  <input id="mpPrevSample" class="export-input" value="${esc(this.getDefaultSampleByCategory(initCategory))}" />
                </div>
              </div>

              <div id="mpPrevResult" style="margin-top:12px;"></div>

              <div class="admin-footer">
                예외 승인(APPROVED & 만료 전)이 있는 경우, 운영 정책에 따라 “비마스킹 허용”으로 처리하도록 확장할 수 있습니다.
              </div>
            </div>
          </div>

          <div style="flex:0.95; min-width:320px;">
            ${focus ? this.renderFocusSummaryCardHtml(focus, focusEx) : this.renderFocusPickerCardHtml()}

            <div class="admin-card" style="padding:12px 14px; margin-top:10px;">
              <div class="admin-header">
                <h2><i class="fa-solid fa-file-arrow-down"></i> 다운로드 시뮬레이션</h2>
                <span class="badge">${esc(mp.downloadRules?.mode || 'MASK')}</span>
              </div>
              <div id="mpPrevDownloadSim" style="margin-top:10px; font-size:12px;"></div>
            </div>
          </div>
        </div>
      `;

      setTimeout(() => {
        const elCat = document.getElementById('mpPrevCategory');
        const elMask = document.getElementById('mpPrevMask');
        if (elCat) elCat.value = initCategory;
        if (elMask) elMask.value = initRule.masking || 'PARTIAL';
        this.renderPreviewResult();
      }, 0);
    },

    renderPreviewResult() {
      const mp = ensureMaskingPolicyStore();
      const cat = ensureSensitiveCatalog();

      const elRes = document.getElementById('mpPrevResult');
      const elSim = document.getElementById('mpPrevDownloadSim');
      if (!elRes || !elSim) return;

      const category = (document.getElementById('mpPrevCategory')?.value || '기타').trim();
      const masking = (document.getElementById('mpPrevMask')?.value || 'PARTIAL').trim();
      const pre = Number(document.getElementById('mpPrevPre')?.value || 0);
      const suf = Number(document.getElementById('mpPrevSuf')?.value || 0);
      const sample = (document.getElementById('mpPrevSample')?.value || '').trim();

      const rule = { masking, exposePrefix: Math.max(pre, 0), exposeSuffix: Math.max(suf, 0) };
      const out = applyMasking(sample, category, rule);

      elRes.innerHTML = `
        <div style="border:1px solid #e5e7eb; border-radius:10px; padding:10px; background:#f9fafb;">
          <div style="font-size:11px; color:#64748b; margin-bottom:6px;">결과</div>
          <div style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace; font-size:13px;">
            ${esc(out)}
          </div>
        </div>
      `;

      // download simulation (간단)
      const dr = mp.downloadRules || {};
      const modePill = pill(dr.mode || 'MASK', (dr.mode === 'BLOCK') ? 'bad' : (dr.mode === 'MASK' ? 'warn' : 'ok'));
      elSim.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:8px;">
          <div>정책 모드: ${modePill}</div>
          <div style="color:#475569; line-height:1.45;">
            • 비민감 무승인 최대: <b>${esc(String(dr.maxRowsNoApproval ?? 0))}</b> rows<br/>
            • 민감 포함 기본 허용: <b>${esc(String(dr.maxRowsSensitive ?? 0))}</b> rows (초과 시 승인)<br/>
            • 사유: ${dr.requireReason ? '필수' : '선택'} · 승인: ${dr.requireApprovalSensitive ? '필수(기준)' : '선택'}
          </div>
        </div>
      `;
    },

    getDefaultSampleByCategory(catName) {
      const map = {
        '주민번호': '900101-1234567',
        '계좌번호': '110-123-456789',
        '카드번호': '5333-4444-5555-6666',
        '연락처': '01012345678',
        '이메일': 'honggildong@example.com',
        '주소': '서울시 영등포구 여의대로 00',
        '성명': '홍길동',
        '기타': 'SAMPLE_VALUE_123',
      };
      return map[catName] || map['기타'];
    },

    // ---- apply defaults to sensitiveCatalog ----
    applyDefaultsToCatalog() {
      const s = getState();
      const cat = ensureSensitiveCatalog();
      const mp = ensureMaskingPolicyStore();

      if (!(cat.items || []).length) return alert('민감정보 목록이 비어 있습니다.');

      const ok = confirm(
        `유형별 기본 룰을 민감정보(테이블/컬럼) 목록에 적용할까요?\n\n` +
        `- 대상: 전체 항목\n- 적용: masking, encrypted(Y 권장)\n\n※ 수동으로 설정한 값도 덮어쓸 수 있습니다.`
      );
      if (!ok) return;

      (cat.items || []).forEach(it => {
        const r = getDefaultRuleForCategory(it.category || '기타');
        it.masking = r.masking;
        // encrypted는 "권장"이므로, 값이 비어있거나 N일 때만 Y 권장 반영
        if (r.encryptedRecommend === 'Y' && (it.encrypted !== 'Y')) it.encrypted = 'Y';
        it.updatedAt = nowISO();
      });

      // 민감정보 목록 화면이 열려있다면 재렌더 시도
      if (W.sensitiveCatalogAdmin && typeof W.sensitiveCatalogAdmin.renderAll === 'function' && document.getElementById('scPage')) {
        W.sensitiveCatalogAdmin.renderAll();
      }

      alert('기본 룰이 적용되었습니다.');
      this.renderDefaults();
      this.renderPreview();
    },

    // ---- focus helpers ----
    getFocusItem() {
      const cat = ensureSensitiveCatalog();
      if (!this.focusItemId) return null;
      return (cat.items || []).find(x => x.id === this.focusItemId) || null;
    },

    renderFocusPickerCardHtml(showHint) {
      const cat = ensureSensitiveCatalog();
      const items = (cat.items || []).slice(0, 6);
      const rows = items.map(it => `
        <tr style="border-bottom:1px solid #f1f5f9;">
          <td style="padding:8px;">
            <div style="font-weight:700;">${esc(getConnLabel(it.connId))}</div>
            <div style="font-size:11px; color:#64748b;">${esc(it.schema)}.${esc(it.table)}.${esc(it.column)}</div>
          </td>
          <td style="padding:8px; width:90px;">${pill(it.category || '기타', 'neutral')}</td>
          <td style="padding:8px; width:70px;">
            <button class="btn" data-mp-pick-item="${esc(it.id)}"><i class="fa-solid fa-arrow-right"></i></button>
          </td>
        </tr>
      `).join('');

      return `
        <div class="admin-card" style="padding:12px 14px; margin-top:${showHint ? '0' : '10px'};">
          <div class="admin-header">
            <h2><i class="fa-solid fa-crosshairs"></i> 대상 선택</h2>
            <span class="badge">최근 ${items.length}개</span>
          </div>
          ${showHint ? `<div style="margin-top:8px; font-size:12px; color:#475569;">예외 요청을 만들거나 미리보기에 연결할 항목을 선택하세요.</div>` : ``}
          <div style="overflow:auto; margin-top:10px; border:1px solid #e5e7eb; border-radius:8px;">
            <table style="width:100%; border-collapse:collapse; font-size:12px;">
              <tbody>
                ${rows || `<tr><td style="padding:12px; color:#64748b;">민감정보 목록이 비어 있습니다.</td></tr>`}
              </tbody>
            </table>
          </div>
        </div>
      `;
    },

    renderFocusSummaryCardHtml(focus, focusEx) {
      const mp = ensureMaskingPolicyStore();
      const r = getDefaultRuleForCategory(focus.category || '기타');

      const exText = focusEx
        ? `${pill('예외 승인 유효', 'ok')} <div style="font-size:11px; color:#64748b; margin-top:4px;">만료: ${esc(focusEx.expiresAt || '-')}</div>`
        : `${pill('예외 없음', 'neutral')}`;

      return `
        <div class="admin-card" style="padding:12px 14px;">
          <div class="admin-header">
            <h2><i class="fa-solid fa-crosshairs"></i> 선택 항목</h2>
            <span class="badge">${esc(focus.id)}</span>
          </div>

          <div style="margin-top:10px; display:grid; grid-template-columns:1fr; gap:8px;">
            <div style="font-weight:800;">${esc(getConnLabel(focus.connId))}</div>
            <div style="font-size:11px; color:#64748b;">${esc(focus.connId)} · ${esc(getConnEnv(focus.connId))}</div>

            <div style="padding:10px; border:1px solid #e5e7eb; border-radius:10px; background:#f9fafb;">
              <div style="font-size:11px; color:#64748b; margin-bottom:4px;">컬럼</div>
              <div style="font-family:ui-monospace,monospace;">${esc(focus.schema)}.${esc(focus.table)}.${esc(focus.column)}</div>
              <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
                ${pill(focus.category || '기타', 'neutral')}
                ${pill(focus.sensitivity || '일반', (focus.sensitivity === 'PII') ? 'bad' : (focus.sensitivity === '중요' ? 'warn' : 'neutral'))}
                ${pill('기본:' + (r.masking || 'NONE'), (r.masking === 'NONE') ? 'neutral' : (r.masking === 'PARTIAL' ? 'warn' : 'ok'))}
              </div>
            </div>

            <div style="padding:10px; border:1px solid #e5e7eb; border-radius:10px;">
              <div style="font-size:11px; color:#64748b; margin-bottom:6px;">예외 상태</div>
              ${exText}
              <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
                <button class="btn" data-mp-act="new-exception"><i class="fa-solid fa-plus"></i> 예외 요청</button>
              </div>
            </div>
          </div>
        </div>
      `;
    },

    // ---- actions ----
    handleAction(act) {
      if (act === 'go-catalog') {
        if (W.sensitiveCatalogAdmin && typeof W.sensitiveCatalogAdmin.open === 'function') {
          W.sensitiveCatalogAdmin.open();
        } else {
          alert('민감정보 목록 화면을 찾지 못했습니다.');
        }
        return;
      }

      if (act === 'apply-defaults') {
        this.applyDefaultsToCatalog();
        return;
      }

      if (act === 'new-exception') {
        this.openNewExceptionModal();
        return;
      }

      if (act === 'save-download') {
        this.saveDownloadRules();
        return;
      }
    },
  };

  W.maskingPolicyAdmin = maskingPolicyAdmin;

  // --------- Card 클릭 연결: “민감 컬럼 마스킹 정책” ----------
  function patchAdminShowForMaskingPolicyCard() {
    if (!W.admin || W.admin.__maskPolicyPatched) return;
    W.admin.__maskPolicyPatched = true;

    const prevShow = W.admin.show.bind(W.admin);
    W.admin.show = function (section) {
      prevShow(section);
      if (section !== 'dbSensitive') return;

      document.querySelectorAll('#adminBody .admin-card-clickable').forEach(card => {
        const h4 = card.querySelector('h4');
        const title = (h4 && h4.textContent) ? h4.textContent.trim() : '';
        if (!title.includes('민감 컬럼 마스킹 정책')) return;

        if (card.dataset.mpCardBound === '1') return;
        card.dataset.mpCardBound = '1';

        card.style.cursor = 'pointer';
        card.addEventListener('click', () => W.maskingPolicyAdmin.open());
      });
    };
  }

  // --------- 민감정보 목록에서 “바로 이동” 버튼 삽입 ----------
  function patchSensitiveCatalogLinkButton() {
    if (!W.sensitiveCatalogAdmin || W.sensitiveCatalogAdmin.__mpLinkPatched) return;
    W.sensitiveCatalogAdmin.__mpLinkPatched = true;

    const origRenderPolicyHint = W.sensitiveCatalogAdmin.renderPolicyHint?.bind(W.sensitiveCatalogAdmin);
    if (!origRenderPolicyHint) return;

    W.sensitiveCatalogAdmin.renderPolicyHint = function () {
      origRenderPolicyHint();

      const body = document.getElementById('scPolicyBody');
      const badge = document.getElementById('scPolicyBadge');
      if (!body) return;

      if (body.dataset.mpLinkInjected === '1') return;
      body.dataset.mpLinkInjected = '1';

      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.justifyContent = 'flex-end';
      wrap.style.marginTop = '10px';
      wrap.innerHTML = `
        <button class="btn primary" id="scGoMaskingPolicyBtn">
          <i class="fa-solid fa-mask"></i> 마스킹 정책 열기
        </button>
      `;
      body.appendChild(wrap);

      const btn = document.getElementById('scGoMaskingPolicyBtn');
      if (!btn) return;

      btn.addEventListener('click', () => {
        const cat = ensureSensitiveCatalog();
        const it = (cat.items || []).find(x => x.id === W.sensitiveCatalogAdmin.selectedItemId);
        W.maskingPolicyAdmin.open({
          tab: 'preview',
          focusItemId: it ? it.id : null,
        });
      });
    };
  }

  patchAdminShowForMaskingPolicyCard();
  patchSensitiveCatalogLinkButton();

  document.addEventListener('DOMContentLoaded', () => {
    patchAdminShowForMaskingPolicyCard();
    patchSensitiveCatalogLinkButton();
  });
})();

/* =========================
 * Admin > DB/민감정보 관리 > DB 접속 허용 IP 관리 (완성본)
 * - 허용 IP/대역(CIDR)/Range CRUD
 * - 가져오기/내보내기
 * - 접속 시뮬레이션 + IP 검증 로그
 * ========================= */
 (function () {
	  const W = window;

	  /* =========================
	   * Service (Adapter swappable)
	   * - 백엔드 연동 시: window.__ipAllowListAdapter 를 API 어댑터로 교체
	   * ========================= */
	  const LS_KEY = "dbam.ipAllowList.v1";

	  const esc = (s) => String(s ?? "")
	    .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
	    .replaceAll('"', "&quot;").replaceAll("'", "&#039;");

	  const nowISO = () => {
	    const d = new Date();
	    const p = (n) => String(n).padStart(2, "0");
	    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
	  };

	  const readJSON = (k, fb) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : fb; } catch { return fb; } };
	  const writeJSON = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };

	  function createMockAdapter() {
	    function ensureSeed() {
	      const cur = readJSON(LS_KEY, null);
	      if (cur) return;
	      writeJSON(LS_KEY, [
	        { id: "AL-1", cidr: "10.0.0.0/8",        label: "사내망", enabled: true,  note: "내부망 대역",   updatedAt: nowISO() },
	        { id: "AL-2", cidr: "172.16.0.0/12",     label: "VPN",   enabled: true,  note: "VPN 대역",     updatedAt: nowISO() },
	        { id: "AL-3", cidr: "203.0.113.10/32",   label: "예외",  enabled: false, note: "임시 허용 예시", updatedAt: nowISO() },
	      ]);
	    }
	    ensureSeed();

	    return {
	      async list() { return readJSON(LS_KEY, []); },
	      async add(entry) {
	        const list = readJSON(LS_KEY, []);
	        list.unshift(entry);
	        writeJSON(LS_KEY, list);
	        return entry;
	      },
	      async update(id, patch) {
	        const list = readJSON(LS_KEY, []).map(x => x.id === id ? { ...x, ...patch, updatedAt: nowISO() } : x);
	        writeJSON(LS_KEY, list);
	        return true;
	      },
	      async remove(id) {
	        const list = readJSON(LS_KEY, []).filter(x => x.id !== id);
	        writeJSON(LS_KEY, list);
	        return true;
	      },
	      async replaceAll(list) {
	        writeJSON(LS_KEY, Array.isArray(list) ? list : []);
	        return true;
	      }
	    };
	  }

	  W.ipAllowListService = W.ipAllowListService || (function () {
	    const adapter = W.__ipAllowListAdapter || createMockAdapter();
	    return {
	      adapter,
	      list: () => adapter.list(),
	      add: (e) => adapter.add(e),
	      update: (id, patch) => adapter.update(id, patch),
	      remove: (id) => adapter.remove(id),
	      replaceAll: (list) => adapter.replaceAll(list),
	    };
	  })();

	  /* =========================
	   * CIDR utils (IPv4 only)
	   * ========================= */
	  function ipToU32(ip) {
	    const p = String(ip || "").trim().split(".");
	    if (p.length !== 4) return null;
	    let n = 0;
	    for (const s of p) {
	      if (s === "" || isNaN(s)) return null;
	      const b = Number(s);
	      if (b < 0 || b > 255) return null;
	      n = (n << 8) | b;
	    }
	    return n >>> 0;
	  }

	  function parseCIDR(cidr) {
	    let s = String(cidr || "").trim();
	    if (!s) return null;
	    if (!s.includes("/")) s += "/32";
	    const [ip, bitsStr] = s.split("/");
	    const bits = Number(bitsStr);
	    const base = ipToU32(ip);
	    if (base == null || !Number.isFinite(bits) || bits < 0 || bits > 32) return null;
	    const mask = bits === 0 ? 0 : (0xFFFFFFFF << (32 - bits)) >>> 0;
	    const net = (base & mask) >>> 0;
	    return { raw: s, base, bits, mask, net };
	  }

	  function matchCIDR(ip, cidrObj) {
	    const x = ipToU32(ip);
	    if (x == null || !cidrObj) return false;
	    return ((x & cidrObj.mask) >>> 0) === cidrObj.net;
	  }

	  /* =========================
	   * UI: Admin module
	   * ========================= */
	  W.ipAllowListAdmin = W.ipAllowListAdmin || {
	    __v: "2025-12-22",
	    q: "",
	    _bound: false,
	    _cache: { list: [] },

	    open() {
	      // overlay open
	      const ov = document.getElementById("adminOverlay");
	      if (ov) { ov.classList.add("show"); ov.setAttribute("aria-hidden", "false"); }

	      // nav active
	      document.querySelectorAll(".admin-nav button").forEach(btn => {
	        btn.classList.toggle("active", btn.dataset.section === "dbSensitive");
	      });

	      // header
	      const titleEl = document.getElementById("adminTitle");
	      const descEl  = document.getElementById("adminDesc");
	      const bodyEl  = document.getElementById("adminBody");
	      if (titleEl) titleEl.innerHTML = `<i class="fa-solid fa-network-wired"></i> DB 접속 허용 IP 관리`;
	      if (descEl)  descEl.textContent = "화이트리스트(CIDR)를 관리하고, 특정 IP가 허용되는지 시뮬레이션합니다. (실제 403 차단은 게이트웨이/백엔드에서 수행)";
	      if (!bodyEl) return;

	      bodyEl.innerHTML = this.getTemplateHtml();
	      this.bindOnce();
	      this.refresh();
	    },

	    getTemplateHtml() {
	      return `
	        <div id="ipwlPage" class="emg-page">
	          <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
	            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
	              <input id="ipwlQ" class="export-input" placeholder="검색(CIDR/라벨)" style="min-width:220px;" />
	              <button class="btn" data-ipwl-act="refresh"><i class="fa-solid fa-rotate"></i> 새로고침</button>
	              <button class="btn" data-ipwl-act="export"><i class="fa-solid fa-download"></i> 내보내기</button>
	              <button class="btn" data-ipwl-act="import"><i class="fa-solid fa-upload"></i> 가져오기</button>
	              <div style="margin-left:auto; font-size:12px; color:var(--muted);">
	                갱신: <span id="ipwlUpdatedAt">-</span>
	              </div>
	            </div>
	            <div class="admin-footer">백엔드 통합 시 <b>window.__ipAllowListAdapter</b> 교체로 연결합니다.</div>
	          </div>

	          <div style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap:10px; align-items:start;">
	            <div class="admin-card" style="padding:12px 14px;">
	              <div class="admin-header">
	                <h2><i class="fa-solid fa-list-check"></i> 허용 목록</h2>
	                <span class="badge" id="ipwlCount">0건</span>
	              </div>

	              <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
	                <input id="ipwlCidr" class="export-input" placeholder="CIDR (예: 10.0.0.0/8 또는 203.0.113.10/32)" style="flex:1; min-width:220px;" />
	                <input id="ipwlLabel" class="export-input" placeholder="라벨 (예: 사내망/VPN/예외)" style="min-width:160px;" />
	                <button class="btn" data-ipwl-act="add"><i class="fa-solid fa-plus"></i> 추가</button>
	              </div>

	              <div style="overflow:auto; margin-top:10px; border:1px solid var(--line); border-radius:10px;">
	                <table style="width:100%; min-width:760px; border-collapse:collapse; font-size:12px;">
	                  <thead>
	                    <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
	                      <th style="text-align:left; padding:8px; width:220px;">CIDR</th>
	                      <th style="text-align:left; padding:8px; width:140px;">라벨</th>
	                      <th style="text-align:center; padding:8px; width:70px;">사용</th>
	                      <th style="text-align:left; padding:8px;">메모</th>
	                      <th style="text-align:right; padding:8px; width:110px;">삭제</th>
	                    </tr>
	                  </thead>
	                  <tbody id="ipwlTbody"></tbody>
	                </table>
	              </div>
	              <div class="admin-footer">실제 차단(403)은 게이트웨이/백엔드에서 Client-IP(또는 신뢰 프록시 기반 실제 IP)를 확인하여 집행합니다.</div>
	            </div>

	            <div>
	              <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
	                <div class="admin-header">
	                  <h2><i class="fa-solid fa-vial"></i> CIDR 시뮬레이터</h2>
	                  <span class="badge">테스트</span>
	                </div>

	                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
	                  <input id="ipwlTestIp" class="export-input" placeholder="테스트 IP (예: 10.1.2.3)" style="flex:1; min-width:200px;" />
	                  <button class="btn" data-ipwl-act="test"><i class="fa-solid fa-play"></i> 판정</button>
	                </div>

	                <div style="margin-top:10px;">
	                  <div style="font-size:12px; color:var(--muted); margin-bottom:6px;">결과</div>
	                  <div id="ipwlTestResult" style="padding:10px; border:1px solid var(--line); border-radius:10px; background:#fff; font-size:12px;">
	                    IP를 입력하고 판정 버튼을 누르세요.
	                  </div>
	                </div>
	              </div>

	              <div class="admin-card" style="padding:12px 14px;">
	                <div class="admin-header">
	                  <h2><i class="fa-solid fa-code"></i> 연동 포인트</h2>
	                  <span class="badge">API</span>
	                </div>
	                <div style="font-size:12px; color:#475569; line-height:1.6; margin-top:10px;">
	                  - 콘솔: 허용 목록 관리/테스트<br/>
	                  - 집행: 게이트웨이/백엔드에서 IP 확인 후 403<br/><br/>
	                  <div style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,'Liberation Mono','Courier New', monospace; font-size:11px; border:1px solid var(--line); border-radius:10px; padding:10px; background:#f9fafb;">
	                    GET  /api/policies/ip-allowlist<br/>
	                    POST /api/policies/ip-allowlist (add/update/remove)
	                  </div>
	                </div>
	              </div>
	            </div>
	          </div>

	          <textarea id="ipwlIO" style="display:none;"></textarea>
	        </div>
	      `;
	    },

	    bindOnce() {
	      if (this._bound) return;
	      this._bound = true;

	      const body = document.getElementById("adminBody");
	      if (!body) return;

	      body.addEventListener("click", (e) => {
	        const page = document.getElementById("ipwlPage");
	        if (!page || !page.contains(e.target)) return;

	        const btn = e.target.closest("[data-ipwl-act]");
	        if (!btn) return;

	        const act = btn.dataset.ipwlAct;
	        if (act === "refresh") return this.refresh();
	        if (act === "add") return this.add();
	        if (act === "test") return this.test();
	        if (act === "export") return this.export();
	        if (act === "import") return this.import();

	        const rowBtn = e.target.closest("[data-ipwl-row-act]");
	        if (!rowBtn) return;
	      });

	      body.addEventListener("change", (e) => {
	        const page = document.getElementById("ipwlPage");
	        if (!page || !page.contains(e.target)) return;

	        if (e.target.id === "ipwlQ") {
	          this.q = e.target.value || "";
	          return this.render();
	        }

	        if (e.target.dataset && e.target.dataset.ipwlToggle === "1") {
	          const id = e.target.dataset.id;
	          const enabled = !!e.target.checked;
	          return this.toggle(id, enabled);
	        }
	      });

	      body.addEventListener("click", (e) => {
	        const page = document.getElementById("ipwlPage");
	        if (!page || !page.contains(e.target)) return;

	        const del = e.target.closest("[data-ipwl-del]");
	        if (del) return this.remove(del.dataset.id);
	      });
	    },

	    async refresh() {
	      const list = await W.ipAllowListService.list();
	      this._cache.list = list || [];
	      const up = document.getElementById("ipwlUpdatedAt");
	      if (up) up.textContent = nowISO();
	      this.render();
	    },

	    render() {
	      const q = (document.getElementById("ipwlQ")?.value ?? this.q ?? "").trim().toUpperCase();
	      const list = this._cache.list || [];
	      const filtered = !q ? list : list.filter(x =>
	        String(x.cidr||"").toUpperCase().includes(q) ||
	        String(x.label||"").toUpperCase().includes(q) ||
	        String(x.note||"").toUpperCase().includes(q)
	      );

	      const tb = document.getElementById("ipwlTbody");
	      if (tb) {
	        tb.innerHTML = filtered.map(x => {
	          const ok = !!parseCIDR(x.cidr);
	          const cidrCell = ok ? esc(x.cidr) : `${esc(x.cidr)} ${'<span style="color:#ef4444;font-weight:700;">(형식 오류)</span>'}`;
	          return `
	            <tr style="border-bottom:1px solid #f1f5f9;">
	              <td style="padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,'Liberation Mono','Courier New', monospace;">${cidrCell}</td>
	              <td style="padding:8px; font-weight:700;">${esc(x.label || "")}</td>
	              <td style="padding:8px; text-align:center;">
	                <input type="checkbox" ${x.enabled ? "checked" : ""} data-ipwl-toggle="1" data-id="${esc(x.id)}" />
	              </td>
	              <td style="padding:8px; color:#475569;">${esc(x.note || "")}</td>
	              <td style="padding:8px; text-align:right;">
	                <button class="btn" data-ipwl-del="1" data-id="${esc(x.id)}"><i class="fa-solid fa-trash"></i></button>
	              </td>
	            </tr>
	          `;
	        }).join("");
	      }

	      const cnt = document.getElementById("ipwlCount");
	      if (cnt) cnt.textContent = `${filtered.length}건`;
	    },

	    async add() {
	      const cidrEl = document.getElementById("ipwlCidr");
	      const labelEl = document.getElementById("ipwlLabel");

	      const cidr = (cidrEl?.value || "").trim();
	      const label = (labelEl?.value || "").trim();

	      if (!cidr || !label) return alert("CIDR과 라벨을 입력하세요.");

	      const parsed = parseCIDR(cidr);
	      if (!parsed) return alert("CIDR 형식이 올바르지 않습니다. 예: 10.0.0.0/8, 203.0.113.10/32");

	      const entry = {
	        id: "AL-" + Date.now(), // UI 식별자
	        cidr: parsed.raw,
	        label,
	        enabled: true,
	        note: "",
	        updatedAt: nowISO()
	      };

	      await W.ipAllowListService.add(entry);
	      if (cidrEl) cidrEl.value = "";
	      if (labelEl) labelEl.value = "";
	      return this.refresh();
	    },

	    async toggle(id, enabled) {
	      await W.ipAllowListService.update(id, { enabled: !!enabled });
	      return this.refresh();
	    },

	    async remove(id) {
	      if (!confirm("삭제할까요?")) return;
	      await W.ipAllowListService.remove(id);
	      return this.refresh();
	    },

	    test() {
	      const ip = (document.getElementById("ipwlTestIp")?.value || "").trim();
	      const out = document.getElementById("ipwlTestResult");
	      if (!out) return;

	      const u32 = ipToU32(ip);
	      if (u32 == null) {
	        out.innerHTML = `<div style="font-weight:800; color:#ef4444;">유효하지 않은 IP입니다.</div>`;
	        return;
	      }

	      const list = (this._cache.list || []).filter(x => x.enabled);
	      let matched = null;

	      for (const x of list) {
	        const cidrObj = parseCIDR(x.cidr);
	        if (!cidrObj) continue;
	        if (matchCIDR(ip, cidrObj)) { matched = { rule: x, cidrObj }; break; }
	      }

	      if (matched) {
	        out.innerHTML = `
	          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
	            <div style="font-weight:900;">허용</div>
	            <div>${'<span style="display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid #bbf7d0;background:#f0fdf4;color:#166534;font-size:10px;">ALLOW</span>'}</div>
	          </div>
	          <div style="margin-top:8px; font-size:12px; color:#475569;">
	            매칭 룰: <b>${esc(matched.rule.label || "")}</b> · <span style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,'Liberation Mono','Courier New', monospace;">${esc(matched.rule.cidr)}</span>
	          </div>
	        `;
	      } else {
	        out.innerHTML = `
	          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
	            <div style="font-weight:900; color:#991b1b;">차단</div>
	            <div>${'<span style="display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b;font-size:10px;">DENY</span>'}</div>
	          </div>
	          <div style="margin-top:8px; font-size:12px; color:#475569;">
	            활성화된 허용 CIDR에 매칭되지 않았습니다. (집행 시 403 대상)
	          </div>
	        `;
	      }
	    },

	    export() {
	      const io = document.getElementById("ipwlIO");
	      const list = this._cache.list || [];
	      const txt = JSON.stringify(list, null, 2);
	      if (io) {
	        io.style.display = "block";
	        io.value = txt;
	        io.select();
	        document.execCommand("copy");
	        io.style.display = "none";
	        alert("허용 목록 JSON을 클립보드로 복사했습니다.");
	      } else {
	        alert(txt);
	      }
	    },

	    async import() {
	      const txt = prompt("붙여넣을 JSON을 입력하세요. (배열 형태)", "");
	      if (!txt) return;
	      let arr;
	      try { arr = JSON.parse(txt); } catch { return alert("JSON 파싱 실패"); }
	      if (!Array.isArray(arr)) return alert("배열(JSON Array)만 가능합니다.");
	      // 최소 검증
	      for (const x of arr) {
	        if (!x || !x.cidr || !x.label) return alert("항목에 cidr/label이 필요합니다.");
	        if (!parseCIDR(x.cidr)) return alert("CIDR 형식 오류 항목이 있습니다: " + x.cidr);
	        if (!x.id) x.id = "AL-" + Date.now();
	        if (typeof x.enabled !== "boolean") x.enabled = true;
	        x.updatedAt = x.updatedAt || nowISO();
	      }
	      await W.ipAllowListService.replaceAll(arr);
	      return this.refresh();
	    }
	  };

	  /* =========================
	   * Route bind (only once)
	   * ========================= */
	  if (W.admin && typeof W.admin.registerItemHandler === "function" && !W.admin.__dbSensitive_ipAllowListBound) {
	    W.admin.__dbSensitive_ipAllowListBound = true;
	    W.admin.registerItemHandler("dbSensitive", "ipAllowList", () => W.ipAllowListAdmin.open());
	  }
	})();

/* ====================== [PATCH START] dbSensitive routes + Resource Monitor/Dashboard (v2025-12-22) ====================== */
(function () {
  const W = window;

  function whenReady(fn) {
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn, { once: true });
    else fn();
  }

  // state bridge (기존 전역 state가 있으면 우선 사용)
  function getState() {
    try { if (typeof state !== 'undefined' && state) return state; } catch (_) {}
    W.state = W.state || {};
    return W.state;
  }

  function esc(s) {
    return String(s ?? '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function nowISO() {
    const d = new Date();
    const p = (n) => String(n).padStart(2, '0');
    return `${d.getFullYear()}-${p(d.getMonth() + 1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }

  function strHash(s) {
    s = String(s ?? '');
    let h = 0 >>> 0;
    for (let i = 0; i < s.length; i++) h = (((h * 31) >>> 0) + s.charCodeAt(i)) >>> 0;
    return h >>> 0;
  }

  function pill(text, tone) {
    const map = {
      ok:      { b: '#bbf7d0', c: '#166534', bg: '#f0fdf4' },
      warn:    { b: '#fde68a', c: '#92400e', bg: '#fffbeb' },
      bad:     { b: '#fecaca', c: '#991b1b', bg: '#fef2f2' },
      neutral: { b: '#e5e7eb', c: '#374151', bg: '#f9fafb' },
    };
    const t = map[tone] || map.neutral;
    return `<span style="display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid ${t.b};background:${t.bg};color:${t.c};font-size:10px;white-space:nowrap;">${esc(text)}</span>`;
  }

  function openAdminShell(sectionKey, titleHtml, descText) {
    const ov = document.getElementById('adminOverlay');
    if (ov) { ov.classList.add('show'); ov.setAttribute('aria-hidden', 'false'); }

    document.querySelectorAll('.admin-nav button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.section === sectionKey);
    });

    const titleEl = document.getElementById('adminTitle');
    const descEl = document.getElementById('adminDesc');
    const bodyEl = document.getElementById('adminBody');

    if (titleEl) titleEl.innerHTML = titleHtml;
    if (descEl) descEl.textContent = descText || '';
    return bodyEl;
  }

  /* ---------------------------
   * Service Abstraction + MockAdapter
   * - 백엔드 붙일 때: window.__dbSensitiveAdapter 를 실제 API 어댑터로 교체
   * --------------------------- */
  function createMockAdapter() {
    function ensureConns() {
      const s = getState();
      s.availableConns = s.availableConns || [];
      if (!s.availableConns.length) {
        s.availableConns = [
          { id: 'CONN-001', label: 'CORE-DB', env: 'PROD' },
          { id: 'CONN-002', label: 'DW-DB', env: 'QA' },
          { id: 'CONN-003', label: 'CRM-DB', env: 'DEV' },
        ];
      }
      return s.availableConns;
    }

    function ensureRegistryMeta() {
      const s = getState();
      s.dbRegistry = s.dbRegistry || { metaByConn: {}, mappingsByConn: {}, accountsByConn: {} };
      const conns = ensureConns();
      conns.forEach(c => {
        if (!s.dbRegistry.metaByConn[c.id]) {
          const h = strHash(c.id);
          const dbmsPool = ['Oracle', 'PostgreSQL', 'MySQL', 'MSSQL', 'MariaDB'];
          const dbms = dbmsPool[h % dbmsPool.length];
          const host = `10.${(h % 200) + 10}.${((h >>> 8) % 250)}.${((h >>> 16) % 250)}`;
          const portMap = { Oracle: '1521', PostgreSQL: '5432', MySQL: '3306', MSSQL: '1433', MariaDB: '3306' };
          s.dbRegistry.metaByConn[c.id] = {
            env: c.env || 'DEV',
            dbms,
            host,
            port: portMap[dbms] || '0000',
            database: `DB${(h % 90) + 10}`,
            schema: (dbms === 'Oracle') ? `SC${(h % 30) + 1}` : 'public',
            sensitivity: (h % 4 === 0) ? 'PII' : (h % 7 === 0 ? '중요' : '일반'),
            updatedAt: nowISO(),
          };
        }
      });
      return s.dbRegistry;
    }

    function buildSnapshot(connId, range) {
      const base = strHash(`${connId}|${range}|snap`);
      const cpu = 8 + (base % 75);
      const mem = 15 + ((base >>> 4) % 70);
      const disk = 20 + ((base >>> 9) % 60);
      const sessions = 10 + ((base >>> 12) % 240);
      const active = 1 + ((base >>> 15) % Math.max(1, Math.min(60, sessions)));
      const blocked = (base % 10 === 0) ? 3 : (base % 6 === 0 ? 1 : 0);
      const alerts = (cpu > 85 ? 1 : 0) + (mem > 85 ? 1 : 0) + (disk > 90 ? 1 : 0) + (blocked > 0 ? 1 : 0);

      let tone = 'ok';
      if (alerts >= 2) tone = 'bad';
      else if (alerts === 1) tone = 'warn';

      const params = [
        { k: 'max_sessions/limit', v: `${sessions}/300`, note: '세션 사용량' },
        { k: 'open_cursors', v: String(300 + (base % 900)), note: '커서 상한(예시)' },
        { k: 'processes', v: String(200 + ((base >>> 3) % 500)), note: '프로세스 상한(예시)' },
        { k: 'work_mem(or PGA)', v: `${64 + (base % 256)}MB`, note: '메모리 파라미터(예시)' },
        { k: 'shared_buffers(or SGA)', v: `${512 + ((base >>> 6) % 4096)}MB`, note: '버퍼/SGA(예시)' },
      ];

      const events = [];
      const eventPool = [
        { sev: 'INFO', msg: 'Health check completed' },
        { sev: 'WARN', msg: 'High CPU detected' },
        { sev: 'WARN', msg: 'Long running session detected' },
        { sev: 'ERROR', msg: 'Connection retry observed' },
        { sev: 'INFO', msg: 'Parameter baseline verified' },
      ];
      const n = 5 + (base % 4);
      for (let i = 0; i < n; i++) {
        const e = eventPool[(base + i * 7) % eventPool.length];
        events.push({ at: nowISO(), sev: e.sev, msg: e.msg });
      }

      return {
        connId,
        range,
        tone,
        cpu, mem, disk,
        sessions, active, blocked,
        alerts,
        params,
        events,
        checkedAt: nowISO(),
      };
    }

    return {
      async listConnections() {
        return ensureConns();
      },
      async getRegistryMeta() {
        return ensureRegistryMeta();
      },
      async getSnapshot(connId, range) {
        ensureRegistryMeta();
        return buildSnapshot(connId, range);
      },
      async getDashboard(range) {
        ensureRegistryMeta();
        const conns = ensureConns();
        const rows = [];
        for (const c of conns) {
          const snap = buildSnapshot(c.id, range);
          rows.push({
            id: c.id,
            label: c.label || c.id,
            env: c.env || '',
            tone: snap.tone,
            cpu: snap.cpu,
            mem: snap.mem,
            disk: snap.disk,
            sessions: snap.sessions,
            alerts: snap.alerts,
            checkedAt: snap.checkedAt,
          });
        }
        return rows;
      }
    };
  }

  W.dbSensitiveService = W.dbSensitiveService || (function () {
    const adapter = W.__dbSensitiveAdapter || createMockAdapter();
    return {
      adapter,
      registry: {
        listConnections: () => adapter.listConnections(),
        getRegistryMeta: () => adapter.getRegistryMeta(),
      },
      metrics: {
        getSnapshot: (connId, range) => adapter.getSnapshot(connId, range),
        getDashboard: (range) => adapter.getDashboard(range),
      }
    };
  })();

  /* ---------------------------
   * UI: DB 파라미터·리소스·상태 모니터링
   * --------------------------- */
  W.dbResourceMonitorAdmin = W.dbResourceMonitorAdmin || {
    __v: '2025-12-22',
    connId: null,
    range: '1h',

    open(ctx) {
      const s = getState();
      if (ctx && ctx.connId) this.connId = ctx.connId;
      if (ctx && ctx.range) this.range = ctx.range;

      // conn fallback
      const conns = s.availableConns || [];
      if (!this.connId) this.connId = (conns[0] && conns[0].id) || null;

      const bodyEl = openAdminShell(
        'dbSensitive',
        `<i class="fa-solid fa-gauge-high"></i> DB 파라미터·리소스·상태 모니터링`,
        'DB 인스턴스별 CPU/메모리/디스크/세션 및 주요 파라미터를 요약 확인합니다. (백엔드 연동 시 실시간 지표로 대체)'
      );
      if (!bodyEl) return;

      bodyEl.innerHTML = this.getTemplateHtml();
      this.bindOnce();
      this.refresh();
    },

    getTemplateHtml() {
      return `
        <div id="dbrmPage" class="emg-page">
          <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <select id="dbrmConn" class="export-input" style="min-width:260px;"></select>

              <select id="dbrmRange" class="export-input" style="max-width:160px;">
                <option value="1h">최근 1시간</option>
                <option value="24h">최근 24시간</option>
                <option value="7d">최근 7일</option>
              </select>

              <button class="btn" data-dbrm-act="refresh"><i class="fa-solid fa-rotate"></i> 새로고침</button>
              <button class="btn" data-dbrm-act="spec"><i class="fa-solid fa-code"></i> API 스펙</button>

              <div style="margin-left:auto; font-size:12px; color:var(--muted);">
                최근 점검: <span id="dbrmCheckedAt">-</span>
              </div>
            </div>
            <div class="admin-footer">지표는 MockAdapter 기반이며, window.__dbSensitiveAdapter 교체로 백엔드 API 연결이 가능합니다.</div>
          </div>

          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:10px;">
            <div class="admin-card" style="padding:12px 14px;">
              <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                <div style="font-weight:700;">상태</div>
                <div id="dbrmStatusPill">-</div>
              </div>
              <div style="margin-top:10px; font-size:12px; color:var(--muted);">
                알림 <b id="dbrmAlerts">0</b>건 / Blocked <b id="dbrmBlocked">0</b>
              </div>
            </div>

            <div class="admin-card" style="padding:12px 14px;">
              <div style="font-weight:700;">CPU</div>
              <div style="margin-top:10px; font-size:22px; font-weight:800;"><span id="dbrmCpu">-</span>%</div>
              <div style="font-size:12px; color:var(--muted);">사용률(요약)</div>
            </div>

            <div class="admin-card" style="padding:12px 14px;">
              <div style="font-weight:700;">메모리</div>
              <div style="margin-top:10px; font-size:22px; font-weight:800;"><span id="dbrmMem">-</span>%</div>
              <div style="font-size:12px; color:var(--muted);">사용률(요약)</div>
            </div>

            <div class="admin-card" style="padding:12px 14px;">
              <div style="font-weight:700;">디스크</div>
              <div style="margin-top:10px; font-size:22px; font-weight:800;"><span id="dbrmDisk">-</span>%</div>
              <div style="font-size:12px; color:var(--muted);">사용률(요약)</div>
            </div>

            <div class="admin-card" style="padding:12px 14px;">
              <div style="font-weight:700;">세션</div>
              <div style="margin-top:10px; font-size:22px; font-weight:800;"><span id="dbrmSess">-</span></div>
              <div style="font-size:12px; color:var(--muted);">Active <b id="dbrmActive">-</b></div>
            </div>
          </div>

          <div style="display:grid; grid-template-columns:1.2fr 0.8fr; gap:10px; margin-top:10px; align-items:start;">
            <div class="admin-card" style="padding:12px 14px;">
              <div class="admin-header">
                <h2><i class="fa-solid fa-sliders"></i> 주요 파라미터</h2>
                <span class="badge">요약</span>
              </div>

              <div style="overflow:auto; margin-top:10px; border:1px solid #e5e7eb; border-radius:8px;">
                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                  <thead>
                    <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                      <th style="text-align:left; padding:8px; width:45%;">키</th>
                      <th style="text-align:left; padding:8px; width:20%;">값</th>
                      <th style="text-align:left; padding:8px;">메모</th>
                    </tr>
                  </thead>
                  <tbody id="dbrmParamTbody"></tbody>
                </table>
              </div>
            </div>

            <div class="admin-card" style="padding:12px 14px;">
              <div class="admin-header">
                <h2><i class="fa-solid fa-clipboard-list"></i> 이벤트</h2>
                <span class="badge">요약</span>
              </div>

              <div style="overflow:auto; margin-top:10px; border:1px solid #e5e7eb; border-radius:8px; max-height:260px;">
                <table style="width:100%; border-collapse:collapse; font-size:12px;">
                  <thead>
                    <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                      <th style="text-align:left; padding:8px; width:70px;">등급</th>
                      <th style="text-align:left; padding:8px;">내용</th>
                    </tr>
                  </thead>
                  <tbody id="dbrmEventTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
    },

    bindOnce() {
      const bodyEl = document.getElementById('adminBody');
      if (!bodyEl || bodyEl.dataset.dbrmBound === '1') return;
      bodyEl.dataset.dbrmBound = '1';

      bodyEl.addEventListener('click', (e) => {
        const page = document.getElementById('dbrmPage');
        if (!page || !page.contains(e.target)) return;

        const btn = e.target.closest('[data-dbrm-act]');
        if (!btn) return;

        const act = btn.dataset.dbrmAct;
        if (act === 'refresh') this.refresh();
        if (act === 'spec') this.openSpec();
      });

      bodyEl.addEventListener('change', (e) => {
        const page = document.getElementById('dbrmPage');
        if (!page || !page.contains(e.target)) return;

        if (e.target && e.target.id === 'dbrmConn') {
          this.connId = e.target.value;
          this.refresh();
        }
        if (e.target && e.target.id === 'dbrmRange') {
          this.range = e.target.value;
          this.refresh();
        }
      });
    },

    async refresh() {
      const toast = W.toast || ((m) => alert(m));

      const connSel = document.getElementById('dbrmConn');
      const rangeSel = document.getElementById('dbrmRange');

      try {
        const conns = await W.dbSensitiveService.registry.listConnections();
        if (connSel && connSel.options.length === 0) {
          connSel.innerHTML = conns.map(c =>
            `<option value="${esc(c.id)}">${esc(c.label || c.id)} ${c.env ? `(${esc(c.env)})` : ''}</option>`
          ).join('');
        }

        // current selection
        if (connSel && this.connId) connSel.value = this.connId;
        if (rangeSel && this.range) rangeSel.value = this.range;

        if (!this.connId && conns[0]) this.connId = conns[0].id;

        const snap = await W.dbSensitiveService.metrics.getSnapshot(this.connId, this.range);
        this.renderSnapshot(snap);
      } catch (e) {
        console.error('[dbResourceMonitorAdmin.refresh] failed:', e);
        toast('지표 조회 실패');
      }
    },

    renderSnapshot(snap) {
      const statusText = (snap.tone === 'ok') ? '정상' : (snap.tone === 'warn' ? '주의' : '위험');
      const statusPill = pill(statusText, snap.tone);

      const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = String(v ?? '-'); };
      const setHtml = (id, v) => { const el = document.getElementById(id); if (el) el.innerHTML = String(v ?? ''); };

      setHtml('dbrmStatusPill', statusPill);
      setText('dbrmAlerts', snap.alerts);
      setText('dbrmBlocked', snap.blocked);

      setText('dbrmCpu', snap.cpu);
      setText('dbrmMem', snap.mem);
      setText('dbrmDisk', snap.disk);
      setText('dbrmSess', snap.sessions);
      setText('dbrmActive', snap.active);
      setText('dbrmCheckedAt', snap.checkedAt);

      const pt = document.getElementById('dbrmParamTbody');
      if (pt) {
        pt.innerHTML = (snap.params || []).map(p => `
          <tr style="border-bottom:1px solid #f1f5f9;">
            <td style="padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${esc(p.k)}</td>
            <td style="padding:8px; font-weight:700;">${esc(p.v)}</td>
            <td style="padding:8px; color:#475569;">${esc(p.note || '')}</td>
          </tr>
        `).join('');
      }

      const et = document.getElementById('dbrmEventTbody');
      if (et) {
        et.innerHTML = (snap.events || []).map(ev => {
          const tone = (ev.sev === 'ERROR') ? 'bad' : (ev.sev === 'WARN' ? 'warn' : 'neutral');
          return `
            <tr style="border-bottom:1px solid #f1f5f9;">
              <td style="padding:8px;">${pill(ev.sev, tone)}</td>
              <td style="padding:8px; color:#111827;">
                <div style="font-size:12px; font-weight:600;">${esc(ev.msg)}</div>
                <div style="font-size:11px; color:#64748b; margin-top:2px;">${esc(ev.at || '')}</div>
              </td>
            </tr>
          `;
        }).join('');
      }
    },

    ensureModal() {
      let bd = document.getElementById('dbrmModalBackdrop');
      if (bd) return bd;

      bd = document.createElement('div');
      bd.id = 'dbrmModalBackdrop';
      bd.className = 'export-modal-backdrop';
      bd.innerHTML = `
        <div class="export-modal" style="max-width:860px;width:calc(100vw - 40px);">
          <div class="export-modal-header">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <h3 id="dbrmModalTitle" style="margin:0;font-size:14px;"></h3>
              <button class="btn" id="dbrmModalCloseBtn"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
          <div id="dbrmModalBody" style="margin-top:10px;"></div>
          <div id="dbrmModalFooter" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;"></div>
        </div>
      `;
      document.body.appendChild(bd);

      bd.addEventListener('click', (e) => { if (e.target === bd) bd.classList.remove('show'); });
      bd.querySelector('#dbrmModalCloseBtn').addEventListener('click', () => bd.classList.remove('show'));
      return bd;
    },

    openSpec() {
      const bd = this.ensureModal();
      bd.querySelector('#dbrmModalTitle').innerHTML = `<i class="fa-solid fa-code"></i> 모니터링 API 스펙(연동용)`;

      const spec = {
        note: '백엔드 통합 시 window.__dbSensitiveAdapter 를 실제 API 어댑터로 교체하거나, 아래 엔드포인트로 구현 후 어댑터에서 fetch 호출로 연결하세요.',
        endpoints: [
          { method: 'GET', path: '/api/db/connections', desc: 'DB 연결 목록' },
          { method: 'GET', path: '/api/db/registry/meta', desc: 'DB 레지스트리 메타(환경/DBMS/host/port/스키마 등)' },
          { method: 'GET', path: '/api/db/metrics/snapshot?connId=...&range=1h|24h|7d', desc: 'CPU/MEM/DISK/세션/알림/파라미터 요약 스냅샷' },
          { method: 'GET', path: '/api/db/metrics/dashboard?range=1h|24h|7d', desc: '전체 DB 요약(대시보드)' },
        ],
        adapterHook: 'window.__dbSensitiveAdapter = { listConnections, getRegistryMeta, getSnapshot, getDashboard }'
      };

      bd.querySelector('#dbrmModalBody').innerHTML = `
        <div style="font-size:12px; color:#475569; margin-bottom:8px;">
          현재 화면은 MockAdapter 기반입니다. 아래 스펙대로 API를 만들면 화면 코드를 크게 안 건드리고 교체 가능합니다.
        </div>
        <textarea spellcheck="false" style="width:100%; min-height:260px; resize:vertical; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; border:1px solid #e5e7eb; border-radius:8px; padding:10px;">${esc(JSON.stringify(spec, null, 2))}</textarea>
      `;

      const ft = bd.querySelector('#dbrmModalFooter');
      ft.innerHTML = '';
      const copyBtn = document.createElement('button');
      copyBtn.className = 'btn';
      copyBtn.innerHTML = `<i class="fa-solid fa-copy"></i> 복사`;
      copyBtn.addEventListener('click', () => {
        const ta = bd.querySelector('textarea');
        ta.select();
        document.execCommand('copy');
      });

      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn';
      closeBtn.innerHTML = `<i class="fa-solid fa-xmark"></i> 닫기`;
      closeBtn.addEventListener('click', () => bd.classList.remove('show'));

      ft.appendChild(copyBtn);
      ft.appendChild(closeBtn);

      bd.classList.add('show');
    }
  };

  /* ---------------------------
   * UI: 전체 데이터베이스 관리 대시보드
   * --------------------------- */
  W.dbDashboardAdmin = W.dbDashboardAdmin || {
    __v: '2025-12-22',
    range: '24h',

    open(ctx) {
      if (ctx && ctx.range) this.range = ctx.range;

      const bodyEl = openAdminShell(
        'dbSensitive',
        `<i class="fa-solid fa-chart-line"></i> 전체 데이터베이스 관리 대시보드`,
        '전체 DB의 리소스/세션/알림 요약을 한 화면에서 확인합니다. (백엔드 연동 시 실시간 집계로 대체)'
      );
      if (!bodyEl) return;

      bodyEl.innerHTML = this.getTemplateHtml();
      this.bindOnce();
      this.refresh();
    },

    getTemplateHtml() {
      return `
        <div id="dbdPage" class="emg-page">
          <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <select id="dbdRange" class="export-input" style="max-width:160px;">
                <option value="1h">최근 1시간</option>
                <option value="24h">최근 24시간</option>
                <option value="7d">최근 7일</option>
              </select>

              <button class="btn" data-dbd-act="refresh"><i class="fa-solid fa-rotate"></i> 새로고침</button>

              <div style="margin-left:auto; font-size:12px; color:var(--muted);">
                최근 갱신: <span id="dbdUpdatedAt">-</span>
              </div>
            </div>
            <div class="admin-footer">행 클릭 시 “DB 파라미터·리소스·상태 모니터링”으로 이동합니다.</div>
          </div>

          <div class="admin-card" style="padding:12px 14px;">
            <div class="admin-header">
              <h2><i class="fa-solid fa-server"></i> DB 요약</h2>
              <span class="badge" id="dbdCount">0건</span>
            </div>

            <div style="overflow:auto; margin-top:10px; border:1px solid #e5e7eb; border-radius:8px;">
              <table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead>
                  <tr style="background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                    <th style="text-align:left; padding:8px; min-width:180px;">이름</th>
                    <th style="text-align:left; padding:8px; width:70px;">환경</th>
                    <th style="text-align:left; padding:8px; width:90px;">상태</th>
                    <th style="text-align:right; padding:8px; width:80px;">CPU%</th>
                    <th style="text-align:right; padding:8px; width:80px;">MEM%</th>
                    <th style="text-align:right; padding:8px; width:80px;">DISK%</th>
                    <th style="text-align:right; padding:8px; width:90px;">세션</th>
                    <th style="text-align:right; padding:8px; width:80px;">알림</th>
                    <th style="text-align:left; padding:8px; min-width:140px;">점검시각</th>
                  </tr>
                </thead>
                <tbody id="dbdTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    },

    bindOnce() {
      const bodyEl = document.getElementById('adminBody');
      if (!bodyEl || bodyEl.dataset.dbdBound === '1') return;
      bodyEl.dataset.dbdBound = '1';

      bodyEl.addEventListener('click', (e) => {
        const page = document.getElementById('dbdPage');
        if (!page || !page.contains(e.target)) return;

        const btn = e.target.closest('[data-dbd-act]');
        if (btn && btn.dataset.dbdAct === 'refresh') this.refresh();

        const tr = e.target.closest('tr[data-conn-id]');
        if (tr) {
          const connId = tr.dataset.connId;
          if (W.dbResourceMonitorAdmin && typeof W.dbResourceMonitorAdmin.open === 'function') {
            W.dbResourceMonitorAdmin.open({ connId, range: this.range });
          }
        }
      });

      bodyEl.addEventListener('change', (e) => {
        const page = document.getElementById('dbdPage');
        if (!page || !page.contains(e.target)) return;

        if (e.target && e.target.id === 'dbdRange') {
          this.range = e.target.value;
          this.refresh();
        }
      });
    },

    async refresh() {
      const toast = W.toast || ((m) => alert(m));
      try {
        const rangeSel = document.getElementById('dbdRange');
        if (rangeSel) rangeSel.value = this.range;

        const rows = await W.dbSensitiveService.metrics.getDashboard(this.range);
        const tb = document.getElementById('dbdTbody');
        if (tb) {
          tb.innerHTML = rows.map(r => `
            <tr data-conn-id="${esc(r.id)}" style="border-bottom:1px solid #f1f5f9; cursor:pointer;">
              <td style="padding:8px; font-weight:700;">${esc(r.label)}</td>
              <td style="padding:8px;">${esc(r.env || '')}</td>
              <td style="padding:8px;">${pill((r.tone==='ok'?'정상':(r.tone==='warn'?'주의':'위험')), r.tone)}</td>
              <td style="padding:8px; text-align:right;">${esc(r.cpu)}</td>
              <td style="padding:8px; text-align:right;">${esc(r.mem)}</td>
              <td style="padding:8px; text-align:right;">${esc(r.disk)}</td>
              <td style="padding:8px; text-align:right;">${esc(r.sessions)}</td>
              <td style="padding:8px; text-align:right; font-weight:800;">${esc(r.alerts)}</td>
              <td style="padding:8px; color:#64748b;">${esc(r.checkedAt || '')}</td>
            </tr>
          `).join('');
        }

        const cnt = document.getElementById('dbdCount');
        if (cnt) cnt.textContent = `${rows.length}건`;

        const up = document.getElementById('dbdUpdatedAt');
        if (up) up.textContent = nowISO();
      } catch (e) {
        console.error('[dbDashboardAdmin.refresh] failed:', e);
        toast('대시보드 갱신 실패');
      }
    }
  };

  /* ---------------------------
   * 핵심: dbSensitive 라우팅 등록(= no route 해결)
   * --------------------------- */
  function bindDbSensitiveRoutes() {
    const A = W.admin;
    if (!A) return;
    if (A.__dbSensitiveRouteFixV1) return;
    A.__dbSensitiveRouteFixV1 = true;

    function bind(sectionId, itemId, fn) {
      // 1) 등록 함수 우선
      if (typeof A.registerItemHandler === 'function') {
        try { A.registerItemHandler(sectionId, itemId, fn); } catch (_) {}
        try { A.registerItemHandler(itemId, fn); } catch (_) {}
      }
      // 2) 라우팅 저장소 직접 주입 (openItem 구현 편차 대비)
      A.__routeHandlers = A.__routeHandlers || {};
      A.__routeHandlers[sectionId] = A.__routeHandlers[sectionId] || {};
      A.__routeHandlers[sectionId][itemId] = fn;

      A.__itemHandlers = A.__itemHandlers || {};
      A.__itemHandlers[itemId] = fn;
      A.__itemHandlers[sectionId + '::' + itemId] = fn;
    }

    bind('dbSensitive', 'dbRegistry',        () => W.dbRegistryAdmin?.open?.());
    bind('dbSensitive', 'sensitiveCatalog',  () => W.sensitiveCatalogAdmin?.open?.());
    bind('dbSensitive', 'ipAllowList',       () => W.ipAllowListAdmin?.open?.());
    bind('dbSensitive', 'maskingPolicy',     () => W.maskingPolicyAdmin?.open?.());
    bind('dbSensitive', 'dbResourceMonitor', () => W.dbResourceMonitorAdmin?.open?.());
    bind('dbSensitive', 'dbDashboard',       () => W.dbDashboardAdmin?.open?.());
  }

  // 즉시 + 로드순서 대비
  bindDbSensitiveRoutes();
  whenReady(bindDbSensitiveRoutes);
})();
/* ====================== [PATCH END] dbSensitive routes + Resource Monitor/Dashboard (v2025-12-22) ====================== */



/* =========================
 * DBAM - DB/스키마/테이블/컬럼 범위
 * Entry: renderDbamScopeRangePage(mountEl)
 * Needs: (optional) window.DBAM_DB_CATALOG or localStorage("dbam_db_catalog")
 * ========================= */

/** ---------- Storage / Utils ---------- */
function dbamLoad(key, fallback) {
  try {
    const v = localStorage.getItem(key);
    return v ? JSON.parse(v) : fallback;
  } catch (e) {
    return fallback;
  }
}
function dbamSave(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}
function dbamUid(prefix = "id") {
  if (window.crypto && crypto.randomUUID) return `${prefix}_${crypto.randomUUID()}`;
  return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
}
function dbamEscHtml(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
function dbamToast(msg) {
  // 프로젝트에 토스트가 있으면 그걸 쓰고, 없으면 alert로 폴백
  if (typeof window.showToast === "function") return window.showToast(msg);
  alert(msg);
}
function dbamGlobToRegExp(glob) {
  const g = String(glob ?? "*").trim();
  // 빈 값은 전체로 처리
  if (!g) return /^.*$/i;
  const esc = g.replace(/[.+^${}()|[\]\\]/g, "\\$&");
  const rx = "^" + esc.replaceAll("*", ".*").replaceAll("?", ".") + "$";
  return new RegExp(rx, "i");
}

/** ---------- Catalog (DB/Schema/Table/Column) ---------- */
/**
 * Catalog normalized format:
 * [
 *  { name:"APPDB", schemas:[
 *      { name:"PUBLIC", tables:[
 *          { name:"USERS", columns:["ID","NAME", ...] }
 *      ]}
 *  ]}
 */
function dbamGetCatalog() {
  // 1) 전역에서 주입된 카탈로그가 있으면 사용
  if (Array.isArray(window.DBAM_DB_CATALOG) && window.DBAM_DB_CATALOG.length) {
    return window.DBAM_DB_CATALOG;
  }

  // 2) 기존 DB 관리 화면에서 저장해둔 카탈로그가 있다면 사용
  const saved = dbamLoad("dbam_db_catalog", null);
  if (Array.isArray(saved) && saved.length) return saved;

  // 3) 폴백 샘플(프로젝트 DB 관리 화면이 이미 있으면 곧 교체됨)
  return [
    {
      name: "APPDB",
      schemas: [
        {
          name: "PUBLIC",
          tables: [
            { name: "USERS", columns: ["USER_ID", "NAME", "EMAIL", "PHONE", "CREATED_AT"] },
            { name: "ORDERS", columns: ["ORDER_ID", "USER_ID", "AMOUNT", "STATUS", "CREATED_AT"] },
          ],
        },
        {
          name: "AUDIT",
          tables: [{ name: "ACCESS_LOG", columns: ["ID", "ACTOR", "ACTION", "TARGET", "CREATED_AT"] }],
        },
      ],
    },
    {
      name: "DW",
      schemas: [
        {
          name: "MART",
          tables: [{ name: "SALES_DAILY", columns: ["DT", "CHANNEL", "AMOUNT", "CNT"] }],
        },
      ],
    },
  ];
}

function dbamListDbNames(catalog) {
  return catalog.map((d) => d.name).sort((a, b) => a.localeCompare(b));
}
function dbamListSchemaNames(catalog, dbName) {
  const db = catalog.find((d) => d.name === dbName);
  if (!db) return [];
  return (db.schemas || []).map((s) => s.name).sort((a, b) => a.localeCompare(b));
}
function dbamListTableNames(catalog, dbName, schemaName) {
  const db = catalog.find((d) => d.name === dbName);
  const sc = db?.schemas?.find((s) => s.name === schemaName);
  if (!sc) return [];
  return (sc.tables || []).map((t) => t.name).sort((a, b) => a.localeCompare(b));
}
function dbamListColumnNames(catalog, dbName, schemaName, tableName) {
  const db = catalog.find((d) => d.name === dbName);
  const sc = db?.schemas?.find((s) => s.name === schemaName);
  const tb = sc?.tables?.find((t) => t.name === tableName);
  if (!tb) return [];
  return (tb.columns || []).slice().sort((a, b) => a.localeCompare(b));
}

/** ---------- Scope Range Data ---------- */
function dbamLoadScopeSets() {
  const sets = dbamLoad("dbam_scope_sets", []);
  if (Array.isArray(sets) && sets.length) return sets;

  // 초기 샘플(있어도 없어도 무방)
  const seed = [
    {
      id: dbamUid("scope"),
      name: "기본 범위",
      description: "모니터링/정책 적용 기본 범위",
      status: "ENABLED", // ENABLED | DISABLED
      mode: "INCLUDE", // INCLUDE | EXCLUDE (세트 전체 기본 모드)
      priority: 100,
      updatedAt: new Date().toISOString(),
      items: [
        { id: dbamUid("item"), db: "APPDB", schema: "PUBLIC", table: "*", column: "*" },
        { id: dbamUid("item"), db: "APPDB", schema: "AUDIT", table: "ACCESS_LOG", column: "*" },
      ],
    },
  ];
  dbamSave("dbam_scope_sets", seed);
  return seed;
}
function dbamSaveScopeSets(sets) {
  dbamSave("dbam_scope_sets", sets);
}

/** ---------- Matching / Preview ---------- */
function dbamExpandAllColumns(catalog) {
  const out = [];
  for (const d of catalog) {
    for (const s of d.schemas || []) {
      for (const t of s.tables || []) {
        const cols = (t.columns && t.columns.length) ? t.columns : ["*"];
        for (const c of cols) {
          out.push({ db: d.name, schema: s.name, table: t.name, column: c });
        }
      }
    }
  }
  return out;
}
function dbamMatchItemPath(item, path) {
  const dbRx = dbamGlobToRegExp(item.db || "*");
  const scRx = dbamGlobToRegExp(item.schema || "*");
  const tbRx = dbamGlobToRegExp(item.table || "*");
  const colRx = dbamGlobToRegExp(item.column || "*");

  return (
    dbRx.test(path.db) &&
    scRx.test(path.schema) &&
    tbRx.test(path.table) &&
    colRx.test(path.column)
  );
}
function dbamPreviewMatches(scopeSet, catalog) {
  const all = dbamExpandAllColumns(catalog);
  const includeItems = (scopeSet.items || []).filter(Boolean);

  // 세트 기본 모드:
  // INCLUDE: items에 매칭되는 대상이 범위에 포함
  // EXCLUDE: items에 매칭되는 대상을 범위에서 제외(= 전체에서 items를 뺀 나머지가 포함)
  if (scopeSet.mode === "EXCLUDE") {
    return all.filter((p) => !includeItems.some((it) => dbamMatchItemPath(it, p)));
  }
  return all.filter((p) => includeItems.some((it) => dbamMatchItemPath(it, p)));
}

/** ---------- Template ---------- */
function getDbamScopeRangeTemplateHtml() {
  return `
  <div id="scopeRangePage" class="emg-page" style="max-width:100%; overflow-x:hidden;">

    <!-- 타이틀은 adminTitle/adminDesc에서만 표시 -->
    <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
      <div style="display:flex; align-items:center; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-primary" data-action="scope_new">
          <i class="fa-solid fa-plus"></i> 새 범위 세트
        </button>

        <button class="btn btn-outline" data-action="scope_export">
          <i class="fa-solid fa-file-export"></i> 내보내기
        </button>

        <label class="btn btn-outline" style="cursor:pointer; margin:0;">
          <i class="fa-solid fa-file-import"></i> 가져오기
          <input type="file" id="scopeImportFile" accept="application/json" style="display:none;" />
        </label>
      </div>

      <div class="admin-footer">
        범위 세트를 만들어 정책 적용 대상을 일관되게 관리합니다. (와일드카드: * / ? 지원)
      </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; width:100%; min-width:0;">
      <!-- Left: list -->
      <div class="admin-card" style="flex:1 1 320px; min-width:0; padding:12px 14px;">
        <div class="admin-header">
          <h2 style="margin:0;"><i class="fa-solid fa-list"></i> 범위 세트</h2>
          <span class="badge" id="scopeSetCountBadge">0</span>
        </div>

        <div style="display:flex; gap:8px; margin-top:10px;">
          <input id="scopeSearch" class="conn-settings-input" placeholder="검색 (이름/설명)" />
          <select id="scopeFilterStatus" class="conn-settings-select" style="max-width:140px;">
            <option value="ALL">전체</option>
            <option value="ENABLED">활성</option>
            <option value="DISABLED">비활성</option>
          </select>
        </div>

        <div id="scopeSetList" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
      </div>

      <!-- Right: editor -->
      <div class="admin-card" style="flex:2 1 520px; min-width:0; overflow:hidden; padding:12px 14px;">
        <div class="admin-header">
          <h2 style="margin:0;"><i class="fa-solid fa-pen-to-square"></i> 편집</h2>
          <span class="badge" id="scopeEditorState">선택 없음</span>
        </div>

        <div id="scopeEditorEmpty" style="margin-top:12px; color:var(--muted); font-size:12px;">
          왼쪽에서 범위 세트를 선택하거나 새로 생성하세요.
        </div>

        <div id="scopeEditor" style="display:none; margin-top:12px;">
          <div style="display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:10px;">
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">세트 이름</div>
              <input id="editScopeName" class="conn-settings-input" placeholder="예) APPDB 기본 범위" />
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">상태</div>
              <select id="editScopeStatus" class="conn-settings-select">
                <option value="ENABLED">활성</option>
                <option value="DISABLED">비활성</option>
              </select>
            </div>

            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">모드</div>
              <select id="editScopeMode" class="conn-settings-select">
                <option value="INCLUDE">포함(Items에 매칭되는 대상 포함)</option>
                <option value="EXCLUDE">제외(Items에 매칭되는 대상 제외)</option>
              </select>
            </div>
            <div>
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">우선순위</div>
              <input id="editScopePriority" type="number" class="conn-settings-input" placeholder="100" />
            </div>

            <div style="grid-column:1 / -1;">
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">설명</div>
              <input id="editScopeDesc" class="conn-settings-input" placeholder="정책 적용 대상 설명" />
            </div>
          </div>

          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:14px; flex-wrap:wrap;">
            <div style="display:flex; gap:8px; align-items:center;">
              <h3 style="margin:0; font-size:13px;"><i class="fa-solid fa-diagram-project"></i> 범위 항목</h3>
              <span style="color:var(--muted); font-size:11px;">DB/스키마/테이블/컬럼 단위로 추가</span>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="btn btn-outline btn-sm" data-action="item_add"><i class="fa-solid fa-plus"></i> 항목 추가</button>
              <button class="btn btn-primary btn-sm" data-action="scope_save"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
              <button class="btn btn-outline btn-sm" data-action="scope_delete" style="border-color:rgba(255,0,0,.35);">
                <i class="fa-solid fa-trash"></i> 삭제
              </button>
            </div>
          </div>

          <div class="table-scroll-x scope-items-wrap"
        	     style="margin-top:10px; border:1px solid var(--line); border-radius:10px; overflow-x:auto; padding-bottom:6px;">
        	     <table class="scope-items-table" style="width:100%; min-width:1140px; border-collapse:collapse; table-layout:fixed;">
	        	     <colgroup>
	        	       <col style="width:160px;">
	        	       <col style="width:160px;">
	        	       <col style="width:220px;">
	        	       <col style="width:480px;">
	        	       <col style="width:120px;">
	        	     </colgroup>

        	    <thead>
        	      <tr>
        	        <th>DB</th>
        	        <th>스키마</th>
        	        <th>테이블</th>
        	        <th>컬럼</th>
        	        <th>동작</th>
        	      </tr>
        	    </thead>

        	    <tbody id="scopeItemTbody"></tbody>
        	  </table>
        	</div>

		  <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:12px; flex-wrap:wrap;">
          <div style="color:var(--muted); font-size:12px;"><span id="scopeUpdatedAt"></span></div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn btn-outline btn-sm" data-action="scope_preview"><i class="fa-solid fa-magnifying-glass"></i> 적용 미리보기</button>
            <span class="badge" id="scopePreviewBadge">0</span>
          </div>
        </div>

        <div id="scopePreviewBox" style="display:none; margin-top:10px; border:1px solid var(--line); border-radius:12px; padding:10px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <div style="font-size:12px;">
              <b>매칭 결과</b> <span style="color:var(--muted);" id="scopePreviewHint"></span>
            </div>
            <button class="btn btn-outline btn-sm" data-action="scope_preview_close"><i class="fa-solid fa-xmark"></i> 닫기</button>
          </div>
          <div id="scopePreviewList" style="margin-top:8px; max-height:240px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;"></div>
        </div>

        </div><!-- /#scopeEditor -->
      </div><!-- /Right card -->
    </div><!-- /flex row -->
  </div><!-- /#scopeRangePage -->
  `;
}



/** ---------- Render / Bind ---------- */
function renderDbamScopeRangePage(mountEl) {
  if (!mountEl) throw new Error("mountEl is required");
  mountEl.innerHTML = getDbamScopeRangeTemplateHtml();

  const state = {
    catalog: dbamGetCatalog(),
    scopeSets: dbamLoadScopeSets(),
    selectedId: null,
    search: "",
    statusFilter: "ALL",
  };

  // --- DOM refs
  const $ = (sel) => mountEl.querySelector(sel);
  const listEl = $("#scopeSetList");
  const countBadgeEl = $("#scopeSetCountBadge");
  const editorEl = $("#scopeEditor");
  const editorEmptyEl = $("#scopeEditorEmpty");
  const editorStateEl = $("#scopeEditorState");
  const itemTbodyEl = $("#scopeItemTbody");
  const updatedAtEl = $("#scopeUpdatedAt");
  const previewBoxEl = $("#scopePreviewBox");
  const previewListEl = $("#scopePreviewList");
  const previewBadgeEl = $("#scopePreviewBadge");
  const previewHintEl = $("#scopePreviewHint");

  // --- helpers
  function getSelectedSet() {
    return state.scopeSets.find((s) => s.id === state.selectedId) || null;
  }
  function persist() {
    dbamSaveScopeSets(state.scopeSets);
  }
  function setSelected(id) {
    state.selectedId = id;
    renderList();
    renderEditor();
  }
  function formatIso(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")} `
      + `${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
  }

  function renderList() {
    const q = state.search.trim().toLowerCase();
    const filtered = state.scopeSets.filter((s) => {
      const hit = !q || (s.name || "").toLowerCase().includes(q) || (s.description || "").toLowerCase().includes(q);
      const st = state.statusFilter === "ALL" || s.status === state.statusFilter;
      return hit && st;
    });

    countBadgeEl.textContent = String(filtered.length);

    listEl.innerHTML = filtered
      .sort((a, b) => (Number(b.priority || 0) - Number(a.priority || 0)) || (String(a.name).localeCompare(String(b.name))))
      .map((s) => {
        const active = s.id === state.selectedId;
        const badge = s.status === "ENABLED" ? "활성" : "비활성";
        const mode = s.mode === "EXCLUDE" ? "제외" : "포함";
        return `
          <div class="admin-card scope-set-row"
               data-scope-id="${dbamEscHtml(s.id)}"
               style="padding:10px 12px; cursor:pointer; border:1px solid var(--line); border-radius:12px; ${active ? "box-shadow:0 0 0 2px rgba(80,140,255,.25) inset;" : ""}">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <div style="min-width:0;">
                <div style="font-weight:700; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  ${dbamEscHtml(s.name || "(이름 없음)")}
                </div>
                <div style="margin-top:4px; font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  ${dbamEscHtml(s.description || "")}
                </div>
              </div>
              <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
                <span class="badge">${dbamEscHtml(badge)}</span>
                <span class="badge">${dbamEscHtml(mode)} · P${dbamEscHtml(s.priority ?? 0)}</span>
              </div>
            </div>
          </div>
        `;
      })
      .join("");

    // 빈 상태
    if (!filtered.length) {
      listEl.innerHTML = `<div style="color:var(--muted); font-size:12px; padding:10px;">표시할 범위 세트가 없습니다.</div>`;
    }
  }

  function renderEditor() {
    const set = getSelectedSet();

    if (!set) {
      editorEl.style.display = "none";
      editorEmptyEl.style.display = "block";
      editorStateEl.textContent = "선택 없음";
      previewBoxEl.style.display = "none";
      previewBadgeEl.textContent = "0";
      return;
    }

    editorEl.style.display = "block";
    editorEmptyEl.style.display = "none";
    editorStateEl.textContent = "편집 중";

    $("#editScopeName").value = set.name || "";
    $("#editScopeStatus").value = set.status || "ENABLED";
    $("#editScopeMode").value = set.mode || "INCLUDE";
    $("#editScopePriority").value = String(set.priority ?? 100);
    $("#editScopeDesc").value = set.description || "";
    updatedAtEl.textContent = set.updatedAt ? `마지막 저장: ${formatIso(set.updatedAt)}` : "";

    // items
    const items = Array.isArray(set.items) ? set.items : [];
    itemTbodyEl.innerHTML = items.map((it) => renderItemRow(set, it)).join("");

    // preview state reset
    previewBoxEl.style.display = "none";
    previewBadgeEl.textContent = "0";
  }

  function renderItemRow(set, item) {
	  const dbNames = ["*", ...dbamListDbNames(state.catalog)];
	  const dbVal = item.db || "*";

	  const schemaNames = dbVal === "*" ? ["*"] : ["*", ...dbamListSchemaNames(state.catalog, dbVal)];
	  const schemaVal = item.schema || "*";

	  const tableNames =
	    dbVal === "*" || schemaVal === "*" ? ["*"] : ["*", ...dbamListTableNames(state.catalog, dbVal, schemaVal)];
	  const tableVal = item.table || "*";

	  const colNames =
	    dbVal === "*" || schemaVal === "*" || tableVal === "*"
	      ? ["*"]
	      : ["*", ...dbamListColumnNames(state.catalog, dbVal, schemaVal, tableVal)];

	  // ✅ 컬럼 값이 목록에 있으면: select로 표현, input은 비워둠
	  // ✅ 목록에 없으면(와일드카드/직접입력): select는 "*", input에 값 넣음
	  const rawCol = item.column || "*";
	  const colInList = colNames.includes(rawCol);
	  const colSelVal = colInList ? rawCol : "*";
	  const colInputVal = colInList ? "" : rawCol;
	  const colLast = colInputVal ? "input" : "select";

	  const opt = (arr, val) =>
	    arr.map((x) => `<option value="${dbamEscHtml(x)}" ${String(x) === String(val) ? "selected" : ""}>${dbamEscHtml(x)}</option>`).join("");

	  return `
	    <tr data-item-id="${dbamEscHtml(item.id)}" data-col-last="${colLast}">
	      <td style="padding:10px;">
	        <select class="conn-settings-select scope-db">${opt(dbNames, dbVal)}</select>
	      </td>
	      <td style="padding:10px;">
	        <select class="conn-settings-select scope-schema">${opt(schemaNames, schemaVal)}</select>
	      </td>
	      <td style="padding:10px;">
	        <select class="conn-settings-select scope-table">${opt(tableNames, tableVal)}</select>
	      </td>

	      <!-- ✅ 여기(컬럼 칸): 가로 배치 금지, 세로로 정리 -->
	      <td style="padding:10px;">
	        <div class="scope-colbox">
	          <select class="conn-settings-select scope-column">${opt(colNames, colSelVal)}</select>

	          <input class="conn-settings-input scope-column-input"
	                 placeholder="직접 입력(예: *_ID, PHONE, ?ATE_AT)"
	                 value="${dbamEscHtml(colInputVal)}" />

	          <div class="scope-hint">선택값/직접입력 중 마지막 입력값이 저장됩니다.</div>
	        </div>
	      </td>

	      <td style="padding:10px;">
	        <button class="btn btn-outline btn-sm" data-action="item_remove" style="padding:7px 10px;">
	          <i class="fa-solid fa-xmark"></i> 제거
	        </button>
	      </td>
	    </tr>
	  `;
	}


  function collectEditorToSelectedSet() {
    const set = getSelectedSet();
    if (!set) return null;

    const name = $("#editScopeName").value.trim();
    if (!name) {
      dbamToast("세트 이름을 입력하세요.");
      return null;
    }

    const status = $("#editScopeStatus").value;
    const mode = $("#editScopeMode").value;
    const priority = Number($("#editScopePriority").value);
    const desc = $("#editScopeDesc").value.trim();

    // collect items from table
    const rows = [...itemTbodyEl.querySelectorAll("tr[data-item-id]")];
    const items = rows.map((tr) => {
      const id = tr.getAttribute("data-item-id");
      const db = tr.querySelector(".scope-db")?.value || "*";
      const schema = tr.querySelector(".scope-schema")?.value || "*";
      const table = tr.querySelector(".scope-table")?.value || "*";

      // 컬럼은 "직접입력"을 최종값으로 채택 (사용자가 와일드카드 입력 가능)
      const colInput = tr.querySelector(".scope-column-input")?.value;
      const colSel = tr.querySelector(".scope-column")?.value;
      const column = (colInput != null ? String(colInput).trim() : "") || (colSel || "*");

      return { id, db, schema, table, column: column || "*" };
    });

    if (!items.length) {
      dbamToast("범위 항목을 1개 이상 추가하세요.");
      return null;
    }

    set.name = name;
    set.status = status;
    set.mode = mode;
    set.priority = Number.isFinite(priority) ? priority : 100;
    set.description = desc;
    set.items = items;
    set.updatedAt = new Date().toISOString();

    return set;
  }

  function addNewScopeSet() {
    const s = {
      id: dbamUid("scope"),
      name: "새 범위 세트",
      description: "",
      status: "ENABLED",
      mode: "INCLUDE",
      priority: 100,
      updatedAt: new Date().toISOString(),
      items: [{ id: dbamUid("item"), db: "*", schema: "*", table: "*", column: "*" }],
    };
    state.scopeSets.unshift(s);
    persist();
    setSelected(s.id);
    dbamToast("새 범위 세트를 생성했습니다.");
  }

  function deleteSelectedScopeSet() {
    const set = getSelectedSet();
    if (!set) return;

    const ok = confirm(`"${set.name}" 을(를) 삭제할까요?`);
    if (!ok) return;

    state.scopeSets = state.scopeSets.filter((x) => x.id !== set.id);
    persist();
    state.selectedId = null;
    renderList();
    renderEditor();
    dbamToast("삭제했습니다.");
  }

  function addItemRow() {
    const set = getSelectedSet();
    if (!set) return;

    const newItem = { id: dbamUid("item"), db: "*", schema: "*", table: "*", column: "*" };
    set.items = Array.isArray(set.items) ? set.items : [];
    set.items.push(newItem);
    persist();
    renderEditor();
  }

  function removeItemRow(itemId) {
    const set = getSelectedSet();
    if (!set) return;

    set.items = (set.items || []).filter((it) => it.id !== itemId);
    persist();
    renderEditor();
  }

  function saveSelected() {
    const set = collectEditorToSelectedSet();
    if (!set) return;

    persist();
    renderList();
    renderEditor();
    dbamToast("저장했습니다.");
  }

  function runPreview() {
    const set = collectEditorToSelectedSet();
    if (!set) return;

    // 미리보기는 저장 없이도 가능하도록: in-memory 반영 후 계산
    const matches = dbamPreviewMatches(set, state.catalog);

    previewBadgeEl.textContent = String(matches.length);
    previewHintEl.textContent = ` (표시: 최대 80건 / 전체 ${matches.length}건)`;
    previewBoxEl.style.display = "block";

    const shown = matches.slice(0, 80).map((p) => {
      return `<div style="padding:4px 0; border-bottom:1px dashed rgba(255,255,255,.08);">
        ${dbamEscHtml(`${p.db}.${p.schema}.${p.table}.${p.column}`)}
      </div>`;
    }).join("");

    previewListEl.innerHTML = shown || `<div style="color:var(--muted); font-size:12px; padding:6px 0;">매칭 결과가 없습니다.</div>`;
  }

  function closePreview() {
    previewBoxEl.style.display = "none";
  }

  function exportJson() {
    const payload = {
      exportedAt: new Date().toISOString(),
      scopeSets: state.scopeSets,
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `dbam_scope_sets_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    setTimeout(() => URL.revokeObjectURL(url), 250);
    dbamToast("내보내기 파일을 생성했습니다.");
  }

  async function importJsonFile(file) {
    try {
      const text = await file.text();
      const json = JSON.parse(text);

      const sets = Array.isArray(json.scopeSets) ? json.scopeSets : (Array.isArray(json) ? json : null);
      if (!sets || !Array.isArray(sets)) {
        dbamToast("가져오기 형식이 올바르지 않습니다.");
        return;
      }

      // 최소 정규화
      const normalized = sets.map((s) => ({
        id: s.id || dbamUid("scope"),
        name: s.name || "가져온 범위 세트",
        description: s.description || "",
        status: s.status === "DISABLED" ? "DISABLED" : "ENABLED",
        mode: s.mode === "EXCLUDE" ? "EXCLUDE" : "INCLUDE",
        priority: Number.isFinite(Number(s.priority)) ? Number(s.priority) : 100,
        updatedAt: s.updatedAt || new Date().toISOString(),
        items: Array.isArray(s.items) && s.items.length ? s.items.map((it) => ({
          id: it.id || dbamUid("item"),
          db: it.db || "*",
          schema: it.schema || "*",
          table: it.table || "*",
          column: it.column || "*",
        })) : [{ id: dbamUid("item"), db: "*", schema: "*", table: "*", column: "*" }],
      }));

      state.scopeSets = normalized;
      persist();
      state.selectedId = normalized[0]?.id || null;

      renderList();
      renderEditor();
      dbamToast("가져오기를 완료했습니다.");
    } catch (e) {
      console.error(e);
      dbamToast("가져오기에 실패했습니다. (JSON 파싱 오류)");
    }
  }

  function syncRowOptions(tr) {
    const db = tr.querySelector(".scope-db")?.value || "*";
    const schemaSel = tr.querySelector(".scope-schema");
    const tableSel = tr.querySelector(".scope-table");
    const colSel = tr.querySelector(".scope-column");

    const setOptions = (sel, arr, keepVal = "*") => {
      if (!sel) return;
      const cur = sel.value;
      sel.innerHTML = arr.map((x) => `<option value="${dbamEscHtml(x)}">${dbamEscHtml(x)}</option>`).join("");
      // cur 유지 시도
      const tryVal = arr.includes(cur) ? cur : (arr.includes(keepVal) ? keepVal : arr[0]);
      sel.value = tryVal;
    };

    const schemas = db === "*" ? ["*"] : ["*", ...dbamListSchemaNames(state.catalog, db)];
    setOptions(schemaSel, schemas, "*");

    const schema = schemaSel?.value || "*";
    const tables = (db === "*" || schema === "*") ? ["*"] : ["*", ...dbamListTableNames(state.catalog, db, schema)];
    setOptions(tableSel, tables, "*");

    const table = tableSel?.value || "*";
    const cols = (db === "*" || schema === "*" || table === "*") ? ["*"] : ["*", ...dbamListColumnNames(state.catalog, db, schema, table)];
    setOptions(colSel, cols, "*");
  }

  // --- events
  mountEl.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-action]");
    const row = e.target.closest(".scope-set-row");
    const tr = e.target.closest("tr[data-item-id]");

    // select set
    if (row && row.getAttribute("data-scope-id")) {
      setSelected(row.getAttribute("data-scope-id"));
      return;
    }

    if (!btn) return;
    const action = btn.getAttribute("data-action");

    if (action === "scope_new") addNewScopeSet();
    if (action === "scope_save") saveSelected();
    if (action === "scope_delete") deleteSelectedScopeSet();
    if (action === "item_add") addItemRow();
    if (action === "item_remove" && tr) removeItemRow(tr.getAttribute("data-item-id"));
    if (action === "scope_preview") runPreview();
    if (action === "scope_preview_close") closePreview();
    if (action === "scope_export") exportJson();
  });

  mountEl.addEventListener("change", (e) => {
    const t = e.target;

    // search/filter
    if (t && t.id === "scopeSearch") {
      state.search = t.value || "";
      renderList();
      return;
    }
    if (t && t.id === "scopeFilterStatus") {
      state.statusFilter = t.value || "ALL";
      renderList();
      return;
    }

    // per-row cascading selects
    const tr = t.closest?.("tr[data-item-id]");
    if (!tr) return;

    if (t.classList.contains("scope-db") || t.classList.contains("scope-schema") || t.classList.contains("scope-table")) {
      syncRowOptions(tr);
    }

    // 컬럼 select 바뀌면 입력창에도 반영
    if (t.classList.contains("scope-column")) {
      const input = tr.querySelector(".scope-column-input");
      if (input) input.value = t.value || "*";
    }
  });

  // import file
  $("#scopeImportFile").addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    importJsonFile(file);
    e.target.value = "";
  });

  // initial render
  renderList();
  // 최초 선택
  if (state.scopeSets[0]?.id) state.selectedId = state.scopeSets[0].id;
  renderEditor();

  // 외부에서 쓰고 싶으면 반환
  return {
    getState: () => ({ ...state }),
    refreshCatalog: (newCatalog) => {
      if (Array.isArray(newCatalog) && newCatalog.length) {
        state.catalog = newCatalog;
        renderEditor();
      }
    },
  };
}

window.DBAM = window.DBAM || {};
window.DBAM.renderDbamScopeRangePage = renderDbamScopeRangePage;

/* =========================
 * 카드 클릭 이벤트에서 호출 예시:
 *   const bodyEl = document.getElementById("adminBody");
 *   window.DBAM.renderDbamScopeRangePage(bodyEl);
 * ========================= */

 
 /* =========================
  * scopePolicy > DB/스키마/테이블/컬럼 범위 (objectScope) - SINGLE PATCH
  * - admin.show는 1번만 패치
  * - 카드 클릭은 1번만 바인딩
  * - 렌더링은 반드시 #adminBody 에만
  * ========================= */
 (function () {
   const W = window;
   if (!W.admin || typeof W.admin.show !== "function") return;
   if (!W.DBAM || typeof W.DBAM.renderDbamScopeRangePage !== "function") return;

   // ✅ 기존 중복 패치/수정 불가 문제 방지용: 새 가드 키 사용
   if (W.admin.__scopePolicyObjectScopePatched_v2) return;
   W.admin.__scopePolicyObjectScopePatched_v2 = true;

   const LABEL = "DB/스키마/테이블/컬럼 범위";

   const objectScopeAdmin = {
     open() {
       try {
         const ov = document.getElementById("adminOverlay");
         if (ov) { ov.classList.add("show"); ov.setAttribute("aria-hidden", "false"); }

         // nav active 유지
         W.admin.current = "scopePolicy";
         document.querySelectorAll(".admin-nav button").forEach(btn => {
           btn.classList.toggle("active", btn.dataset.section === "scopePolicy");
         });

         const titleEl = document.getElementById("adminTitle");
         const descEl  = document.getElementById("adminDesc");
         const bodyEl  = document.getElementById("adminBody");
         if (!titleEl || !descEl || !bodyEl) return;

         titleEl.innerHTML = `<i class="fa-solid fa-table"></i> ${LABEL}`;
         descEl.textContent = "사용자/역할 단위로 접근 가능한 DB/스키마/테이블/컬럼 범위를 정의합니다.";

         // ✅ 여기만 사용 (다른 컨테이너 쓰면 레이아웃 깨질 수 있음)
         W.DBAM.renderDbamScopeRangePage(bodyEl);
       } catch (e) {
         console.warn("objectScopeAdmin.open error", e);
       }
     },

     attachCardHandler() {
       const bodyEl = document.getElementById("adminBody");
       if (!bodyEl) return;

       const cards = Array.from(bodyEl.querySelectorAll(".admin-card.admin-card-clickable"));
       const target = cards.find(card => {
         const h4 = card.querySelector("h4");
         return h4 && (h4.textContent || "").includes(LABEL);
       });

       if (!target) return;
       if (target.dataset.objectScopeBound === "1") return;
       target.dataset.objectScopeBound = "1";

       const footer = target.querySelector(".admin-footer");
       if (footer) footer.textContent = "DB/스키마/테이블/컬럼 단위 접근 범위 세트를 관리";

       target.addEventListener("click", (e) => {
         e.preventDefault();
         e.stopPropagation();
         objectScopeAdmin.open();
       });
     }
   };

   // 필요하면 외부에서도 호출 가능하게 노출
   W.objectScopeAdmin = objectScopeAdmin;

   // ✅ admin.show 1회 패치
   const originalShow = W.admin.show.bind(W.admin);
   W.admin.show = function (section) {
     originalShow(section);
     if (section === "scopePolicy") {
       try { objectScopeAdmin.attachCardHandler(); }
       catch (e) { console.warn("scopePolicy objectScope 바인딩 오류", e); }
     }
   };

   // ✅ 이미 scopePolicy 화면이면 즉시 바인딩
   try {
     if (W.admin.current === "scopePolicy") objectScopeAdmin.attachCardHandler();
   } catch (_) {}
 })();

  /* =========================
   * DBAM - 허용 범위 밖 SQL 사전 차단 (preBlock)
   * Entry: window.DBAM.renderDbamPreBlockPage(mountEl)
   * ========================= */
  (function () {
    const W = window;
    W.DBAM = W.DBAM || {};

    const KEY_POLICIES = "dbam_preblock_policies";
    const KEY_LOGS = "dbam_preblock_logs";

    const SAMPLE_ROLES = ["DEV", "DBA", "AUDIT", "SECURITY"];
    const SAMPLE_USERS = ["kim.dev", "lee.sec", "park.dba", "choi.audit"];

    function nowISO() { return new Date().toISOString(); }
    function safeLoad(key, fallback) {
      try { return (typeof dbamLoad === "function") ? dbamLoad(key, fallback) : fallback; }
      catch (_) { return fallback; }
    }
    function safeSave(key, value) {
      try { if (typeof dbamSave === "function") dbamSave(key, value); }
      catch (_) {}
    }
    function toast(msg) { (typeof dbamToast === "function") ? dbamToast(msg) : alert(msg); }

    function ensureStyle() {
      if (document.getElementById("dbamPreBlockStyle")) return;
      const st = document.createElement("style");
      st.id = "dbamPreBlockStyle";
      st.textContent = `
        .pb-row{border:1px solid var(--line); border-radius:12px; padding:10px 12px; cursor:pointer;}
        .pb-row.active{box-shadow:0 0 0 2px rgba(80,140,255,.25) inset;}
        .pb-kv{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px;}
        .pb-checks{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
        .pb-check{display:flex; align-items:center; gap:6px; font-size:12px; color:var(--text);}
        .pb-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;}
        .pb-badge-pass{background:rgba(0,160,90,.12); border:1px solid rgba(0,160,90,.25); color:#0a7a4a;}
        .pb-badge-warn{background:rgba(255,170,0,.12); border:1px solid rgba(255,170,0,.28); color:#a86b00;}
        .pb-badge-block{background:rgba(255,0,0,.10); border:1px solid rgba(255,0,0,.22); color:#b30000;}
        .pb-table{width:100%; border-collapse:collapse;}
        .pb-table th,.pb-table td{padding:10px; border-bottom:1px solid var(--line); vertical-align:top;}
        .pb-table th{background:var(--panel,#f8fafc); text-align:left; white-space:nowrap;}
        .pb-table td{font-size:12px;}
        .pb-ellipsis{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
        .pb-wrap{white-space:normal; word-break:break-word;}
        .pb-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
      `;
      document.head.appendChild(st);
    }

    function loadPolicies(scopeSets) {
      const arr = safeLoad(KEY_POLICIES, []);
      if (Array.isArray(arr) && arr.length) return arr;

      const defaultScopeId = (scopeSets && scopeSets[0] && scopeSets[0].id) ? scopeSets[0].id : "";
      const seed = [
        {
          id: (typeof dbamUid === "function" ? dbamUid("pb") : ("pb_" + Date.now())),
          name: "기본 사전 차단",
          status: "ENABLED",          // ENABLED | DISABLED
          enforce: "BLOCK",           // BLOCK | WARN
          targetType: "ROLE",         // ROLE | USER
          target: "DEV",
          defaultDb: "APPDB",
          scopeSetId: defaultScopeId, // dbam_scope_sets의 id
          allowSelect: true,
          allowDml: false,
          allowDdl: false,
          allowAdmin: false,
          blockNoWhere: true,
          updatedAt: nowISO(),
        }
      ];
      safeSave(KEY_POLICIES, seed);
      return seed;
    }

    function savePolicies(policies) {
      safeSave(KEY_POLICIES, policies);
    }

    function loadLogs() {
      const arr = safeLoad(KEY_LOGS, []);
      return Array.isArray(arr) ? arr : [];
    }
    function saveLogs(logs) {
      safeSave(KEY_LOGS, logs);
    }

    function formatIso(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} `
           + `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    // ---- SQL parse helpers (가벼운 정규식 기반) ----
    function stripComments(sql) {
      const s = String(sql || "");
      return s
        .replace(/\/\*[\s\S]*?\*\//g, " ")
        .replace(/--.*?(\r?\n|$)/g, " ");
    }

    function detectCommand(sqlUpper) {
      const m = String(sqlUpper || "").match(/\b(SELECT|INSERT|UPDATE|DELETE|MERGE|DROP|TRUNCATE|ALTER|CREATE|GRANT|REVOKE)\b/);
      return m ? m[1] : "UNKNOWN";
    }

    function cleanIdent(raw) {
      let s = String(raw || "").trim();
      while (/[;,)]$/.test(s)) s = s.slice(0, -1);
      s = s.replace(/["`]/g, "");
      s = s.split(/\s+/)[0];      // alias 제거
      s = s.replace(/@.*/g, "");  // dblink 제거
      return s.trim();
    }

    function resolveSchemaFromCatalog(catalog, db, table) {
      try {
        const hit = [];
        const dbObj = (catalog || []).find(d => d.name === db);
        (dbObj?.schemas || []).forEach(sc => {
          (sc.tables || []).forEach(tb => {
            if (String(tb.name).toUpperCase() === String(table).toUpperCase()) hit.push(sc.name);
          });
        });
        return hit.length === 1 ? hit[0] : "*";
      } catch (_) {
        return "*";
      }
    }

    function parseObjectIdent(ident, defaultDb, catalog) {
      const cleaned = cleanIdent(ident);
      if (!cleaned) return null;

      const parts = cleaned.split(".").filter(Boolean);
      let db = defaultDb || "*";
      let schema = "*";
      let table = cleaned;

      if (parts.length >= 3) {
        db = parts[0] || db;
        schema = parts[1] || "*";
        table = parts[2] || "*";
      } else if (parts.length === 2) {
        schema = parts[0] || "*";
        table = parts[1] || "*";
      } else if (parts.length === 1) {
        table = parts[0] || "*";
        schema = resolveSchemaFromCatalog(catalog, db, table);
      }

      return { db, schema, table, column: "*" };
    }

    function extractObjectRefs(sqlUpper) {
      const refs = [];

      function add(raw) {
        const c = cleanIdent(raw);
        if (!c) return;
        if (c.startsWith("(")) return;
        if (!refs.includes(c)) refs.push(c);
      }

      // UPDATE/DELETE/INSERT/MERGE 타깃
      (sqlUpper.match(/\bUPDATE\s+([A-Z0-9_.$"`]+)/g) || []).forEach(seg => add(seg.replace(/\bUPDATE\s+/,"")));
      (sqlUpper.match(/\bDELETE\s+FROM\s+([A-Z0-9_.$"`]+)/g) || []).forEach(seg => add(seg.replace(/\bDELETE\s+FROM\s+/,"")));
      (sqlUpper.match(/\bMERGE\s+INTO\s+([A-Z0-9_.$"`]+)/g) || []).forEach(seg => add(seg.replace(/\bMERGE\s+INTO\s+/,"")));
      (sqlUpper.match(/\bINTO\s+([A-Z0-9_.$"`]+)/g) || []).forEach(seg => add(seg.replace(/\bINTO\s+/,"")));

      // FROM절(첫 테이블 + 콤마로 나열된 테이블 일부 커버)
      const fromSegRx = /\bFROM\b([\s\S]*?)(\bWHERE\b|\bGROUP\b|\bHAVING\b|\bORDER\b|\bFETCH\b|\bLIMIT\b|\bUNION\b|$)/gi;
      let m;
      while ((m = fromSegRx.exec(sqlUpper))) {
        const seg = String(m[1] || "").replace(/\s+/g, " ").trim();
        if (!seg) continue;
        seg.split(",").forEach(part => {
          const t = part.trim();
          const mm = t.match(/^([A-Z0-9_.$"`]+)/);
          if (mm && mm[1]) add(mm[1]);
        });
      }

      // JOIN 테이블
      const joinRx = /\bJOIN\s+([A-Z0-9_.$"`]+)/g;
      while ((m = joinRx.exec(sqlUpper))) {
        if (m[1]) add(m[1]);
      }

      return refs;
    }

    function matchScopeItem(item, obj) {
      const rx = (glob) => (typeof dbamGlobToRegExp === "function" ? dbamGlobToRegExp(glob) : /.*/i);
      const dbOk = rx(item.db || "*").test(obj.db || "");
      const scOk = rx(item.schema || "*").test(obj.schema || "");
      const tbOk = rx(item.table || "*").test(obj.table || "");
      const colOk = rx(item.column || "*").test(obj.column || "*");
      return dbOk && scOk && tbOk && colOk;
    }

    function isAllowedByScopeSet(scopeSet, obj) {
      if (!scopeSet) return true;
      if (scopeSet.status && scopeSet.status !== "ENABLED") return true;

      const items = Array.isArray(scopeSet.items) ? scopeSet.items : [];
      if (!items.length) return true;

      const hit = items.some(it => matchScopeItem(it, obj));
      if (scopeSet.mode === "EXCLUDE") return !hit;
      return hit; // INCLUDE
    }

    function evaluateSql(policy, scopeSet, catalog, sql) {
      const raw = String(sql || "");
      const stripped = stripComments(raw);
      const upper = stripped.toUpperCase().replace(/\s+/g, " ").trim();

      const res = {
        command: detectCommand(upper),
        objects: [],
        outOfScope: [],
        issues: [],
        decision: "PASS", // PASS | WARN | BLOCK
      };

      if (!upper) return res;
      if (!policy || policy.status !== "ENABLED") return res;

      const cmd = res.command;

      const DML = ["INSERT","UPDATE","DELETE","MERGE"];
      const DDL = ["DROP","TRUNCATE","ALTER","CREATE"];
      const ADM = ["GRANT","REVOKE"];

      if (cmd === "SELECT" && !policy.allowSelect) res.issues.push("SELECT 실행이 허용되지 않습니다.");
      if (DML.includes(cmd) && !policy.allowDml) res.issues.push(`DML(${cmd}) 실행이 허용되지 않습니다.`);
      if (DDL.includes(cmd) && !policy.allowDdl) res.issues.push(`DDL(${cmd}) 실행이 허용되지 않습니다.`);
      if (ADM.includes(cmd) && !policy.allowAdmin) res.issues.push(`권한 명령(${cmd}) 실행이 허용되지 않습니다.`);

      if (policy.blockNoWhere && (cmd === "UPDATE" || cmd === "DELETE")) {
        if (!/\bWHERE\b/i.test(upper)) {
          res.issues.push(`${cmd}에 WHERE 조건이 없습니다.`);
        }
      }

      // scope check
      const refs = extractObjectRefs(upper);
      const objs = refs
        .map(r => parseObjectIdent(r, policy.defaultDb || "*", catalog))
        .filter(Boolean);

      res.objects = objs;

      if (scopeSet) {
        const oos = objs.filter(o => !isAllowedByScopeSet(scopeSet, o));
        res.outOfScope = oos;
        if (oos.length) {
          res.issues.push(`허용 범위 밖 객체 접근: ${oos.map(o => `${o.db}.${o.schema}.${o.table}`).join(", ")}`);
        }
      }

      if (res.issues.length) {
        res.decision = (policy.enforce === "WARN") ? "WARN" : "BLOCK";
      }
      return res;
    }

    function downloadJson(filename, payload) {
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function readJsonFile(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          try { resolve(JSON.parse(String(fr.result || ""))); }
          catch (e) { reject(e); }
        };
        fr.onerror = reject;
        fr.readAsText(file);
      });
    }

    // ---- Template ----
    function getTemplateHtml() {
      return `
        <div id="preBlockPage" class="emg-page" style="width:100%;">

          <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-primary" data-pb-act="new">
                <i class="fa-solid fa-plus"></i> 새 정책
              </button>
              <button class="btn btn-outline" data-pb-act="export">
                <i class="fa-solid fa-file-export"></i> 내보내기
              </button>
              <label class="btn btn-outline" style="cursor:pointer; margin:0;">
                <i class="fa-solid fa-file-import"></i> 가져오기
                <input type="file" id="pbImportFile" accept="application/json" style="display:none;" />
              </label>
              <button class="btn btn-outline" data-pb-act="gotoScope">
                <i class="fa-solid fa-table"></i> 범위 세트 관리
              </button>
            </div>
            <div class="admin-footer">
              허용 범위를 벗어나는 SQL을 실행 전에 차단/경고하고 로그를 남깁니다. (객체 범위는 “범위 세트”와 연계)
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; min-width:0;">
            <!-- Left: policies -->
            <div class="admin-card" style="flex:1; min-width:320px; padding:12px 14px; min-width:320px;">
              <div class="admin-header">
                <h2 style="margin:0;"><i class="fa-solid fa-list"></i> 사전 차단 정책</h2>
                <span class="badge" id="pbCountBadge">0</span>
              </div>

              <div style="display:flex; gap:8px; margin-top:10px;">
                <input id="pbSearch" class="conn-settings-input" placeholder="검색 (이름/대상)" />
                <select id="pbFilterStatus" class="conn-settings-select" style="max-width:140px;">
                  <option value="ALL">전체</option>
                  <option value="ENABLED">활성</option>
                  <option value="DISABLED">비활성</option>
                </select>
              </div>

              <div id="pbList" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
            </div>

            <!-- Right: editor -->
            <div class="admin-card" style="flex:2; min-width:520px; padding:12px 14px; min-width:520px;">
              <div class="admin-header">
                <h2 style="margin:0;"><i class="fa-solid fa-pen-to-square"></i> 편집</h2>
                <span class="badge" id="pbEditorState">선택 없음</span>
              </div>

              <div id="pbEditorEmpty" style="margin-top:12px; color:var(--muted); font-size:12px;">
                왼쪽에서 정책을 선택하거나 새로 생성하세요.
              </div>

              <div id="pbEditor" style="display:none; margin-top:12px;">
                <div class="pb-kv">
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">정책 이름</div>
                    <input id="pbName" class="conn-settings-input" placeholder="예) 개발자 기본 사전 차단" />
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">상태</div>
                    <select id="pbStatus" class="conn-settings-select">
                      <option value="ENABLED">활성</option>
                      <option value="DISABLED">비활성</option>
                    </select>
                  </div>

                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">동작</div>
                    <select id="pbEnforce" class="conn-settings-select">
                      <option value="BLOCK">차단</option>
                      <option value="WARN">경고(로그만)</option>
                    </select>
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">기본 DB</div>
                    <select id="pbDefaultDb" class="conn-settings-select"></select>
                  </div>

                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">적용 대상 유형</div>
                    <select id="pbTargetType" class="conn-settings-select">
                      <option value="ROLE">역할</option>
                      <option value="USER">사용자</option>
                    </select>
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">적용 대상</div>
                    <select id="pbTarget" class="conn-settings-select"></select>
                  </div>

                  <div style="grid-column:1 / -1;">
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">연결 범위 세트</div>
                    <select id="pbScopeSet" class="conn-settings-select"></select>
                    <div style="margin-top:6px; color:var(--muted); font-size:11px;">
                      선택한 범위 세트에 포함되지 않은 객체 접근이 감지되면 차단/경고됩니다.
                    </div>
                  </div>
                </div>

                <div class="pb-checks">
                  <label class="pb-check"><input type="checkbox" id="pbAllowSelect"> SELECT 허용</label>
                  <label class="pb-check"><input type="checkbox" id="pbAllowDml"> DML(INSERT/UPDATE/DELETE/MERGE) 허용</label>
                  <label class="pb-check"><input type="checkbox" id="pbAllowDdl"> DDL(CREATE/ALTER/DROP/TRUNCATE) 허용</label>
                  <label class="pb-check"><input type="checkbox" id="pbAllowAdmin"> GRANT/REVOKE 허용</label>
                  <label class="pb-check"><input type="checkbox" id="pbBlockNoWhere"> UPDATE/DELETE WHERE 없으면 차단</label>
                </div>

                <div class="pb-actions" style="margin-top:14px; justify-content:flex-end;">
                  <button class="btn btn-primary btn-sm" data-pb-act="save"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
                  <button class="btn btn-outline btn-sm" data-pb-act="delete" style="border-color:rgba(255,0,0,.35);">
                    <i class="fa-solid fa-trash"></i> 삭제
                  </button>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:10px; flex-wrap:wrap;">
                  <div style="color:var(--muted); font-size:12px;"><span id="pbUpdatedAt"></span></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tester -->
          <div class="admin-card" style="padding:12px 14px; margin-top:10px;">
            <div class="admin-header">
              <h2 style="margin:0;"><i class="fa-solid fa-magnifying-glass"></i> SQL 사전 검증</h2>
              <span class="badge" id="pbTestBadge">준비</span>
            </div>

            <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; align-items:center;">
              <div style="font-size:11px; color:var(--muted);">사용자</div>
              <select id="pbTestUser" class="conn-settings-select" style="max-width:200px;"></select>

              <button class="btn btn-primary btn-sm" data-pb-act="test">
                <i class="fa-solid fa-play"></i> 검증 실행
              </button>
            </div>

            <textarea id="pbSql" class="conn-settings-input pb-mono"
              style="margin-top:10px; width:100%; height:120px; resize:vertical;"
              placeholder="예) SELECT * FROM APPDB.PUBLIC.USERS;"></textarea>

            <div id="pbTestResult" style="margin-top:10px; display:none; border:1px solid var(--line); border-radius:12px; padding:10px;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <span class="badge" id="pbDecisionBadge"></span>
                  <span style="font-size:12px; color:var(--muted);" id="pbCmdText"></span>
                </div>
                <div style="font-size:12px; color:var(--muted);" id="pbPolicyHint"></div>
              </div>

              <div style="margin-top:10px;">
                <div style="font-size:12px; font-weight:700;">판정 사유</div>
                <div id="pbIssues" style="margin-top:6px; font-size:12px; color:var(--text);"></div>
              </div>

              <div style="margin-top:10px;">
                <div style="font-size:12px; font-weight:700;">감지 객체</div>
                <div id="pbObjects" class="pb-mono" style="margin-top:6px; font-size:12px; color:var(--text);"></div>
              </div>
            </div>
          </div>

          <!-- Logs -->
          <div class="admin-card" style="padding:12px 14px; margin-top:10px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div class="admin-header" style="margin:0;">
                <h2 style="margin:0;"><i class="fa-solid fa-clipboard-list"></i> 차단/경고 로그</h2>
              </div>
              <button class="btn btn-outline btn-sm" data-pb-act="clearLogs"><i class="fa-solid fa-trash"></i> 로그 비우기</button>
            </div>

            <div style="margin-top:10px; overflow:auto; border:1px solid var(--line); border-radius:10px;">
              <table class="pb-table" style="min-width:980px;">
                <thead>
                  <tr>
                    <th style="width:140px;">시간</th>
                    <th style="width:70px;">결과</th>
                    <th style="width:160px;">정책</th>
                    <th style="width:120px;">사용자</th>
                    <th style="width:80px;">명령</th>
                    <th>내용</th>
                  </tr>
                </thead>
                <tbody id="pbLogsTbody"></tbody>
              </table>
            </div>
          </div>

        </div>
      `;
    }

    // ---- Render ----
    function renderDbamPreBlockPage(mountEl) {
      if (!mountEl) throw new Error("mountEl is required");
      ensureStyle();
      mountEl.innerHTML = getTemplateHtml();

      const catalog = (typeof dbamGetCatalog === "function") ? dbamGetCatalog() : [];
      const scopeSets = (typeof dbamLoadScopeSets === "function") ? dbamLoadScopeSets() : [];

      const state = {
        catalog,
        scopeSets,
        policies: loadPolicies(scopeSets),
        logs: loadLogs(),
        selectedId: null,
        search: "",
        statusFilter: "ALL",
      };

      const $ = (sel) => mountEl.querySelector(sel);

      const listEl = $("#pbList");
      const countBadgeEl = $("#pbCountBadge");
      const editorEl = $("#pbEditor");
      const editorEmptyEl = $("#pbEditorEmpty");
      const editorStateEl = $("#pbEditorState");
      const updatedAtEl = $("#pbUpdatedAt");

      const selDefaultDbEl = $("#pbDefaultDb");
      const selTargetTypeEl = $("#pbTargetType");
      const selTargetEl = $("#pbTarget");
      const selScopeSetEl = $("#pbScopeSet");

      const testBadgeEl = $("#pbTestBadge");
      const testUserEl = $("#pbTestUser");
      const sqlEl = $("#pbSql");
      const testResultEl = $("#pbTestResult");
      const decisionBadgeEl = $("#pbDecisionBadge");
      const cmdTextEl = $("#pbCmdText");
      const policyHintEl = $("#pbPolicyHint");
      const issuesEl = $("#pbIssues");
      const objectsEl = $("#pbObjects");

      const logsTbodyEl = $("#pbLogsTbody");

      function getSelectedPolicy() {
        return state.policies.find(p => p.id === state.selectedId) || null;
      }
      function getScopeSetById(id) {
        return state.scopeSets.find(s => s.id === id) || null;
      }

      function setSelected(id) {
        state.selectedId = id;
        renderList();
        renderEditor();
        renderTestHeader();
      }

      function renderList() {
        const q = state.search.trim().toLowerCase();
        const filtered = state.policies.filter(p => {
          const hit = !q || (p.name || "").toLowerCase().includes(q) || (p.target || "").toLowerCase().includes(q);
          const st = state.statusFilter === "ALL" || p.status === state.statusFilter;
          return hit && st;
        });

        countBadgeEl.textContent = String(filtered.length);

        listEl.innerHTML = filtered
          .slice()
          .sort((a,b) => String(a.name||"").localeCompare(String(b.name||"")))
          .map(p => {
            const active = p.id === state.selectedId;
            const st = (p.status === "ENABLED") ? "활성" : "비활성";
            const ef = (p.enforce === "WARN") ? "경고" : "차단";
            const scopeName = getScopeSetById(p.scopeSetId)?.name || "(범위 세트 없음)";
            const tgt = (p.targetType === "USER" ? "사용자" : "역할") + " · " + (p.target || "-");
            return `
              <div class="pb-row ${active ? "active" : ""}" data-pb-id="${(typeof dbamEscHtml==="function"?dbamEscHtml(p.id):p.id)}">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                  <div style="min-width:0;">
                    <div style="font-weight:700; font-size:13px;" class="pb-ellipsis">${typeof dbamEscHtml==="function"?dbamEscHtml(p.name||"(이름 없음)"):(p.name||"(이름 없음)")}</div>
                    <div style="margin-top:4px; font-size:12px; color:var(--muted);" class="pb-ellipsis">${typeof dbamEscHtml==="function"?dbamEscHtml(tgt):tgt}</div>
                    <div style="margin-top:4px; font-size:12px; color:var(--muted);" class="pb-ellipsis">${typeof dbamEscHtml==="function"?dbamEscHtml(scopeName):scopeName}</div>
                  </div>
                  <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
                    <span class="badge">${st}</span>
                    <span class="badge">${ef}</span>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");

        if (!filtered.length) {
          listEl.innerHTML = `<div style="color:var(--muted); font-size:12px; padding:10px;">표시할 정책이 없습니다.</div>`;
        }
      }

      function fillSelect(el, options, selected) {
        el.innerHTML = options.map(v => `<option value="${typeof dbamEscHtml==="function"?dbamEscHtml(v):v}" ${String(v)===String(selected)?"selected":""}>${typeof dbamEscHtml==="function"?dbamEscHtml(v):v}</option>`).join("");
      }

      function renderEditor() {
        const p = getSelectedPolicy();
        if (!p) {
          editorEl.style.display = "none";
          editorEmptyEl.style.display = "block";
          editorStateEl.textContent = "선택 없음";
          updatedAtEl.textContent = "";
          return;
        }

        editorEl.style.display = "block";
        editorEmptyEl.style.display = "none";
        editorStateEl.textContent = "편집 중";

        $("#pbName").value = p.name || "";
        $("#pbStatus").value = p.status || "ENABLED";
        $("#pbEnforce").value = p.enforce || "BLOCK";

        // 기본 DB 목록
        const dbNames = (typeof dbamListDbNames === "function") ? dbamListDbNames(state.catalog) : ["APPDB"];
        fillSelect(selDefaultDbEl, dbNames.length ? dbNames : ["APPDB"], p.defaultDb || (dbNames[0]||"APPDB"));

        selTargetTypeEl.value = p.targetType || "ROLE";
        renderTargetOptions();
        selTargetEl.value = p.target || "";

        // 범위 세트 목록
        const scopeOpts = state.scopeSets.map(s => ({ id: s.id, name: s.name || s.id, status: s.status }));
        selScopeSetEl.innerHTML =
          scopeOpts.map(s => `<option value="${typeof dbamEscHtml==="function"?dbamEscHtml(s.id):s.id}" ${String(s.id)===String(p.scopeSetId)?"selected":""}>${typeof dbamEscHtml==="function"?dbamEscHtml(s.name):s.name} ${s.status==="DISABLED"?"(비활성)":""}</option>`).join("");

        $("#pbAllowSelect").checked = !!p.allowSelect;
        $("#pbAllowDml").checked = !!p.allowDml;
        $("#pbAllowDdl").checked = !!p.allowDdl;
        $("#pbAllowAdmin").checked = !!p.allowAdmin;
        $("#pbBlockNoWhere").checked = !!p.blockNoWhere;

        updatedAtEl.textContent = p.updatedAt ? `마지막 저장: ${formatIso(p.updatedAt)}` : "";
      }

      function renderTargetOptions() {
        const type = selTargetTypeEl.value || "ROLE";
        if (type === "USER") fillSelect(selTargetEl, SAMPLE_USERS, getSelectedPolicy()?.target || SAMPLE_USERS[0]);
        else fillSelect(selTargetEl, SAMPLE_ROLES, getSelectedPolicy()?.target || SAMPLE_ROLES[0]);
      }

      function renderTestHeader() {
        const p = getSelectedPolicy();
        fillSelect(testUserEl, SAMPLE_USERS, SAMPLE_USERS[0]);
        testBadgeEl.textContent = p ? "준비" : "정책 선택 필요";
        testResultEl.style.display = "none";
      }

      function renderLogs() {
        const logs = state.logs.slice().reverse();
        logsTbodyEl.innerHTML = logs.map(l => {
          const cls = l.decision === "BLOCK" ? "pb-badge-block" : (l.decision === "WARN" ? "pb-badge-warn" : "pb-badge-pass");
          return `
            <tr>
              <td class="pb-ellipsis">${formatIso(l.at)}</td>
              <td><span class="badge ${cls}">${l.decision}</span></td>
              <td class="pb-ellipsis">${typeof dbamEscHtml==="function"?dbamEscHtml(l.policyName||""):(l.policyName||"")}</td>
              <td class="pb-ellipsis">${typeof dbamEscHtml==="function"?dbamEscHtml(l.user||""):(l.user||"")}</td>
              <td class="pb-ellipsis">${typeof dbamEscHtml==="function"?dbamEscHtml(l.command||""):(l.command||"")}</td>
              <td class="pb-wrap">
                <div style="color:var(--muted);">${typeof dbamEscHtml==="function"?dbamEscHtml(l.reason||""):(l.reason||"")}</div>
                <div class="pb-mono" style="margin-top:6px; font-size:12px;">${typeof dbamEscHtml==="function"?dbamEscHtml(l.sql||""):(l.sql||"")}</div>
              </td>
            </tr>
          `;
        }).join("");

        if (!logs.length) {
          logsTbodyEl.innerHTML = `<tr><td colspan="6" style="padding:12px; color:var(--muted);">로그가 없습니다.</td></tr>`;
        }
      }

      function collectEditor() {
        const p = getSelectedPolicy();
        if (!p) return null;

        const name = $("#pbName").value.trim();
        if (!name) { toast("정책 이름을 입력하세요."); return null; }

        const targetType = selTargetTypeEl.value;
        const target = selTargetEl.value;
        if (!target) { toast("적용 대상을 선택하세요."); return null; }

        const scopeSetId = selScopeSetEl.value;
        if (!scopeSetId) { toast("연결 범위 세트를 선택하세요."); return null; }

        p.name = name;
        p.status = $("#pbStatus").value;
        p.enforce = $("#pbEnforce").value;
        p.defaultDb = selDefaultDbEl.value || "APPDB";
        p.targetType = targetType;
        p.target = target;
        p.scopeSetId = scopeSetId;

        p.allowSelect = !!$("#pbAllowSelect").checked;
        p.allowDml = !!$("#pbAllowDml").checked;
        p.allowDdl = !!$("#pbAllowDdl").checked;
        p.allowAdmin = !!$("#pbAllowAdmin").checked;
        p.blockNoWhere = !!$("#pbBlockNoWhere").checked;

        p.updatedAt = nowISO();
        return p;
      }

      function addPolicy() {
        const dbNames = (typeof dbamListDbNames === "function") ? dbamListDbNames(state.catalog) : ["APPDB"];
        const defaultDb = dbNames[0] || "APPDB";
        const firstScope = state.scopeSets[0]?.id || "";

        const p = {
          id: (typeof dbamUid === "function" ? dbamUid("pb") : ("pb_" + Date.now())),
          name: "새 사전 차단 정책",
          status: "ENABLED",
          enforce: "BLOCK",
          targetType: "ROLE",
          target: SAMPLE_ROLES[0],
          defaultDb,
          scopeSetId: firstScope,
          allowSelect: true,
          allowDml: false,
          allowDdl: false,
          allowAdmin: false,
          blockNoWhere: true,
          updatedAt: nowISO(),
        };
        state.policies.push(p);
        savePolicies(state.policies);
        setSelected(p.id);
        toast("새 정책을 생성했습니다. 내용을 수정 후 저장하세요.");
      }

      function deletePolicy() {
        const p = getSelectedPolicy();
        if (!p) return;
        const ok = confirm("정책을 삭제할까요?");
        if (!ok) return;

        state.policies = state.policies.filter(x => x.id !== p.id);
        savePolicies(state.policies);
        state.selectedId = state.policies[0]?.id || null;
        renderList();
        renderEditor();
        renderTestHeader();
        toast("삭제했습니다.");
      }

      function runTest() {
        const p = getSelectedPolicy();
        if (!p) { toast("정책을 선택하세요."); return; }

        const scopeSet = getScopeSetById(p.scopeSetId);
        const sql = sqlEl.value;

        const result = evaluateSql(p, scopeSet, state.catalog, sql);

        // UI
        testResultEl.style.display = "block";
        cmdTextEl.textContent = `명령: ${result.command}`;
        policyHintEl.textContent = `${p.name} · ${p.enforce === "WARN" ? "경고" : "차단"} · ${p.targetType === "USER" ? "사용자" : "역할"}:${p.target}`;

        const cls = result.decision === "BLOCK" ? "pb-badge-block" : (result.decision === "WARN" ? "pb-badge-warn" : "pb-badge-pass");
        decisionBadgeEl.className = `badge ${cls}`;
        decisionBadgeEl.textContent = result.decision;

        issuesEl.innerHTML = result.issues.length
          ? `<ul style="margin:0; padding-left:16px;">${result.issues.map(x => `<li>${typeof dbamEscHtml==="function"?dbamEscHtml(x):x}</li>`).join("")}</ul>`
          : `<span style="color:var(--muted);">이슈 없음</span>`;

        const objText = result.objects.length
          ? result.objects.map(o => `${o.db}.${o.schema}.${o.table}`).join("\n")
          : "(감지된 객체 없음)";
        objectsEl.textContent = objText;

        testBadgeEl.textContent = (result.decision === "PASS") ? "통과" : (result.decision === "WARN" ? "경고" : "차단");

        // 로그(경고/차단만 적재)
        if (result.decision !== "PASS") {
          const user = testUserEl.value || "unknown";
          const log = {
            id: "log_" + Date.now(),
            at: nowISO(),
            decision: result.decision,
            policyId: p.id,
            policyName: p.name,
            user,
            command: result.command,
            reason: result.issues.join(" / "),
            sql: (String(sql || "").trim().slice(0, 240)),
          };
          state.logs.push(log);
          // keep last 200
          if (state.logs.length > 200) state.logs = state.logs.slice(state.logs.length - 200);
          saveLogs(state.logs);
          renderLogs();
        }
      }

      // ---- Bind ----
      mountEl.addEventListener("click", async (e) => {
        const row = e.target.closest?.("[data-pb-id]");
        if (row) {
          const id = row.getAttribute("data-pb-id");
          setSelected(id);
          return;
        }

        const actBtn = e.target.closest?.("[data-pb-act]");
        if (actBtn) {
          const act = actBtn.getAttribute("data-pb-act");
          if (act === "new") addPolicy();
          if (act === "save") {
            const p = collectEditor();
            if (!p) return;
            savePolicies(state.policies);
            renderList();
            renderEditor();
            toast("저장했습니다.");
          }
          if (act === "delete") deletePolicy();
          if (act === "test") runTest();
          if (act === "clearLogs") {
            const ok = confirm("로그를 모두 비울까요?");
            if (!ok) return;
            state.logs = [];
            saveLogs(state.logs);
            renderLogs();
          }
          if (act === "export") {
            downloadJson("dbam_preblock_export.json", {
              exportedAt: nowISO(),
              policies: state.policies,
              logs: state.logs,
            });
            toast("내보내기를 완료했습니다.");
          }
          if (act === "gotoScope") {
            if (W.objectScopeAdmin && typeof W.objectScopeAdmin.open === "function") {
              W.objectScopeAdmin.open();
            } else if (W.DBAM && typeof W.DBAM.renderDbamScopeRangePage === "function") {
              const bodyEl = document.getElementById("adminBody");
              if (bodyEl) W.DBAM.renderDbamScopeRangePage(bodyEl);
            } else {
              toast("범위 세트 화면 로더를 찾지 못했습니다.");
            }
          }
          return;
        }
      });

      mountEl.addEventListener("input", (e) => {
        if (e.target.id === "pbSearch") {
          state.search = e.target.value || "";
          renderList();
        }
      });

      mountEl.addEventListener("change", (e) => {
        if (e.target.id === "pbFilterStatus") {
          state.statusFilter = e.target.value || "ALL";
          renderList();
        }
        if (e.target.id === "pbTargetType") {
          renderTargetOptions();
        }
      });

      // import file
      const importEl = $("#pbImportFile");
      importEl.addEventListener("change", async () => {
        const f = importEl.files && importEl.files[0];
        importEl.value = "";
        if (!f) return;
        try {
          const data = await readJsonFile(f);
          const policies = Array.isArray(data?.policies) ? data.policies : null;
          const logs = Array.isArray(data?.logs) ? data.logs : null;
          if (!policies) throw new Error("policies가 없습니다.");

          state.policies = policies;
          state.logs = logs || [];
          savePolicies(state.policies);
          saveLogs(state.logs);

          state.selectedId = state.policies[0]?.id || null;
          renderList();
          renderEditor();
          renderTestHeader();
          renderLogs();
          toast("가져오기를 완료했습니다.");
        } catch (err) {
          console.warn(err);
          toast("가져오기 실패: 파일 형식을 확인하세요.");
        }
      });

      // initial render
      state.selectedId = state.policies[0]?.id || null;
      renderList();
      renderEditor();
      renderTestHeader();
      renderLogs();
    }

    W.DBAM.renderDbamPreBlockPage = renderDbamPreBlockPage;

    // ---- scopePolicy 카드 바인딩 + open ----
    const preBlockAdmin = {
      open() {
        const titleEl = document.getElementById("adminTitle");
        const descEl  = document.getElementById("adminDesc");
        const bodyEl  = document.getElementById("adminBody");
        if (!titleEl || !descEl || !bodyEl) return;

        try {
          W.admin.current = "scopePolicy";
          document.querySelectorAll(".admin-nav button").forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.section === "scopePolicy");
          });
        } catch (_) {}

        titleEl.innerHTML = '<i class="fa-solid fa-ban"></i> 허용 범위 밖 SQL 사전 차단';
        descEl.textContent = "허용된 범위를 벗어나는 SQL을 실행 전에 차단/경고하고 사유·로그를 기록합니다.";

        W.DBAM.renderDbamPreBlockPage(bodyEl);
      },

      attachPreBlockCardHandler() {
        const bodyEl = document.getElementById("adminBody");
        if (!bodyEl) return;

        bodyEl.querySelectorAll(".admin-card-clickable").forEach((card) => {
          const h4 = card.querySelector("h4");
          const title = (h4 && h4.textContent ? h4.textContent : "").trim();
          if (!title.includes("허용 범위 밖 SQL 사전 차단")) return;

          if (card.dataset.preBlockBound === "1") return;
          card.dataset.preBlockBound = "1";

          const footer = card.querySelector(".admin-footer");
          if (footer) footer.textContent = "허용 범위 밖 SQL 차단/경고 규칙 관리";

          card.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            preBlockAdmin.open();
          });
        });
      },
    };

    W.preBlockAdmin = preBlockAdmin;

    (function patchAdminShowForScopePolicyPreBlock() {
      if (!W.admin || typeof W.admin.show !== "function") return;
      if (W.admin.__scopePolicyPreBlockPatched) return;
      W.admin.__scopePolicyPreBlockPatched = true;

      const originalShow = W.admin.show.bind(W.admin);
      W.admin.show = function (section) {
        originalShow(section);
        if (section === "scopePolicy") {
          try { preBlockAdmin.attachPreBlockCardHandler(); }
          catch (e) { console.warn("preBlock 카드 바인딩 오류", e); }
        }
      };

      try {
        if (W.admin.current === "scopePolicy") preBlockAdmin.attachPreBlockCardHandler();
      } catch (_) {}
    })();
  })();

 
  /* =========================
   * DBAM - 대량 조회/반출 임계값 정책 (downloadThreshold)
   * window.DBAM.renderDbamDownloadThresholdPage(mountEl)
   * ========================= */
  (function () {
    const W = window;
    W.DBAM = W.DBAM || {};

    // 중복 설치 방지
    if (W.DBAM.__downloadThresholdInstalled) return;
    W.DBAM.__downloadThresholdInstalled = true;

    const KEY_POLICIES  = "dbam_download_threshold_policies";
    const KEY_REQUESTS  = "dbam_download_threshold_requests";
    const KEY_LOGS      = "dbam_download_threshold_logs";

    const SAMPLE_ROLES = ["DEV", "DBA", "AUDIT", "SECURITY"];
    const SAMPLE_USERS = ["kim.dev", "lee.sec", "park.dba", "choi.audit"];
    const USER_ROLE_MAP = {
      "kim.dev": "DEV",
      "lee.sec": "SECURITY",
      "park.dba": "DBA",
      "choi.audit": "AUDIT",
    };

    function nowISO() { return new Date().toISOString(); }
    function toast(msg) { (typeof dbamToast === "function") ? dbamToast(msg) : alert(msg); }

    function safeLoad(key, fallback) {
      try { return (typeof dbamLoad === "function") ? dbamLoad(key, fallback) : fallback; }
      catch (_) { return fallback; }
    }
    function safeSave(key, value) {
      try { if (typeof dbamSave === "function") dbamSave(key, value); }
      catch (_) {}
    }

    function formatIso(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} `
        + `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    function ensureStyle() {
      if (document.getElementById("dbamDownloadThresholdStyle")) return;
      const st = document.createElement("style");
      st.id = "dbamDownloadThresholdStyle";
      st.textContent = `
        .dt-row{border:1px solid var(--line); border-radius:12px; padding:10px 12px; cursor:pointer;}
        .dt-row.active{box-shadow:0 0 0 2px rgba(80,140,255,.25) inset;}
        .dt-kv{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px;}
        .dt-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
        .dt-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;}
        .dt-badge-pass{background:rgba(0,160,90,.12); border:1px solid rgba(0,160,90,.25); color:#0a7a4a;}
        .dt-badge-warn{background:rgba(255,170,0,.12); border:1px solid rgba(255,170,0,.28); color:#a86b00;}
        .dt-badge-block{background:rgba(255,0,0,.10); border:1px solid rgba(255,0,0,.22); color:#b30000;}
        .dt-badge-need{background:rgba(80,140,255,.12); border:1px solid rgba(80,140,255,.22); color:#2b5dbb;}
        .dt-table{width:100%; border-collapse:collapse;}
        .dt-table th,.dt-table td{padding:10px; border-bottom:1px solid var(--line); vertical-align:top;}
        .dt-table th{background:var(--panel,#f8fafc); text-align:left; white-space:nowrap;}
        .dt-ellipsis{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
        .dt-wrap{white-space:normal; word-break:break-word;}
      `;
      document.head.appendChild(st);
    }

    function downloadJson(filename, payload) {
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function readJsonFile(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          try { resolve(JSON.parse(String(fr.result || ""))); }
          catch (e) { reject(e); }
        };
        fr.onerror = reject;
        fr.readAsText(file);
      });
    }

    // ---------- Scope matching ----------
    function parseObj(input, defaultDb) {
      const s = String(input || "").trim().replace(/["`]/g, "");
      if (!s) return null;
      const parts = s.split(".").filter(Boolean);
      let db = defaultDb || "*";
      let schema = "*";
      let table = "*";
      if (parts.length >= 3) {
        db = parts[0] || db;
        schema = parts[1] || "*";
        table = parts[2] || "*";
      } else if (parts.length === 2) {
        schema = parts[0] || "*";
        table = parts[1] || "*";
      } else {
        table = parts[0] || "*";
      }
      return { db, schema, table, column: "*" };
    }

    function matchScopeItem(item, obj) {
      const rx = (glob) => (typeof dbamGlobToRegExp === "function" ? dbamGlobToRegExp(glob) : /.*/i);
      return rx(item.db || "*").test(obj.db || "")
        && rx(item.schema || "*").test(obj.schema || "")
        && rx(item.table || "*").test(obj.table || "")
        && rx(item.column || "*").test(obj.column || "*");
    }

    function isInScopeSet(scopeSet, obj) {
      if (!scopeSet) return true;
      if (scopeSet.status && scopeSet.status !== "ENABLED") return true;

      const items = Array.isArray(scopeSet.items) ? scopeSet.items : [];
      if (!items.length) return true;

      const hit = items.some(it => matchScopeItem(it, obj));
      if (scopeSet.mode === "EXCLUDE") return !hit;
      return hit; // INCLUDE
    }

    // ---------- Storage seed ----------
    function loadPolicies(scopeSets, catalog) {
      const arr = safeLoad(KEY_POLICIES, []);
      if (Array.isArray(arr) && arr.length) return arr;

      const dbNames = (typeof dbamListDbNames === "function") ? dbamListDbNames(catalog) : ["APPDB"];
      const defaultDb = dbNames[0] || "APPDB";
      const firstScopeId = scopeSets?.[0]?.id || "";

      const seed = [
        {
          id: (typeof dbamUid === "function" ? dbamUid("dt") : ("dt_" + Date.now())),
          name: "개발자 반출 임계값",
          status: "ENABLED",              // ENABLED | DISABLED
          targetType: "ROLE",             // ROLE | USER
          target: "DEV",
          priority: 100,
          actionOnExceed: "REQUIRE_APPROVAL", // BLOCK | REQUIRE_APPROVAL | WARN
          defaultDb,
          scopeSetId: firstScopeId,       // ""(전체) 또는 scopeSet id
          queryRowsLimit: 5000,
          exportRowsLimit: 2000,
          exportSizeMbLimit: 10,
          updatedAt: nowISO(),
        }
      ];
      safeSave(KEY_POLICIES, seed);
      return seed;
    }

    function loadRequests() {
      const arr = safeLoad(KEY_REQUESTS, []);
      return Array.isArray(arr) ? arr : [];
    }
    function loadLogs() {
      const arr = safeLoad(KEY_LOGS, []);
      return Array.isArray(arr) ? arr : [];
    }

    // ---------- Template ----------
    function getTemplateHtml() {
      return `
        <div id="downloadThresholdPage" class="emg-page" style="width:100%; max-width:100%; overflow-x:hidden;">

          <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-primary" data-dt-act="new">
                <i class="fa-solid fa-plus"></i> 새 정책
              </button>
              <button class="btn btn-outline" data-dt-act="export">
                <i class="fa-solid fa-file-export"></i> 내보내기
              </button>
              <label class="btn btn-outline" style="cursor:pointer; margin:0;">
                <i class="fa-solid fa-file-import"></i> 가져오기
                <input type="file" id="dtImportFile" accept="application/json" style="display:none;" />
              </label>
              <button class="btn btn-outline" data-dt-act="gotoScope">
                <i class="fa-solid fa-table"></i> 범위 세트
              </button>
            </div>
            <div class="admin-footer">
              행 수/용량 임계값을 설정하고, 초과 시 차단·추가 승인·경고 동작을 관리합니다.
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; min-width:0;">
            <!-- Left -->
            <div class="admin-card" style="flex:1 1 320px; min-width:0; padding:12px 14px;">
              <div class="admin-header">
                <h2 style="margin:0;"><i class="fa-solid fa-list"></i> 임계값 정책</h2>
                <span class="badge" id="dtCountBadge">0</span>
              </div>

              <div style="display:flex; gap:8px; margin-top:10px;">
                <input id="dtSearch" class="conn-settings-input" placeholder="검색 (이름/대상)" />
                <select id="dtFilterStatus" class="conn-settings-select" style="max-width:140px;">
                  <option value="ALL">전체</option>
                  <option value="ENABLED">활성</option>
                  <option value="DISABLED">비활성</option>
                </select>
              </div>

              <div id="dtList" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
            </div>

            <!-- Right -->
            <div class="admin-card" style="flex:2 1 520px; min-width:0; padding:12px 14px;">
              <div class="admin-header">
                <h2 style="margin:0;"><i class="fa-solid fa-pen-to-square"></i> 편집</h2>
                <span class="badge" id="dtEditorState">선택 없음</span>
              </div>

              <div id="dtEditorEmpty" style="margin-top:12px; color:var(--muted); font-size:12px;">
                왼쪽에서 정책을 선택하거나 새로 생성하세요.
              </div>

              <div id="dtEditor" style="display:none; margin-top:12px;">
                <div class="dt-kv">
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">정책 이름</div>
                    <input id="dtName" class="conn-settings-input" placeholder="예) 개발자 반출 임계값" />
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">상태</div>
                    <select id="dtStatus" class="conn-settings-select">
                      <option value="ENABLED">활성</option>
                      <option value="DISABLED">비활성</option>
                    </select>
                  </div>

                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">우선순위</div>
                    <input id="dtPriority" type="number" class="conn-settings-input" placeholder="100" />
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">초과 시 동작</div>
                    <select id="dtAction" class="conn-settings-select">
                      <option value="BLOCK">차단</option>
                      <option value="REQUIRE_APPROVAL">추가 승인</option>
                      <option value="WARN">경고(로그만)</option>
                    </select>
                  </div>

                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">적용 대상 유형</div>
                    <select id="dtTargetType" class="conn-settings-select">
                      <option value="ROLE">역할</option>
                      <option value="USER">사용자</option>
                    </select>
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">적용 대상</div>
                    <select id="dtTarget" class="conn-settings-select"></select>
                  </div>

                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">기본 DB</div>
                    <select id="dtDefaultDb" class="conn-settings-select"></select>
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">적용 범위 세트</div>
                    <select id="dtScopeSet" class="conn-settings-select"></select>
                  </div>

                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">조회 임계값(행 수)</div>
                    <input id="dtQueryRows" type="number" class="conn-settings-input" placeholder="예) 5000" />
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">반출 임계값(행 수)</div>
                    <input id="dtExportRows" type="number" class="conn-settings-input" placeholder="예) 2000" />
                  </div>

                  <div style="grid-column:1 / -1;">
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">반출 임계값(용량 MB)</div>
                    <input id="dtExportMb" type="number" class="conn-settings-input" placeholder="예) 10" />
                    <div style="margin-top:6px; color:var(--muted); font-size:11px;">
                      값이 비어있거나 0이면 해당 조건은 검사하지 않습니다.
                    </div>
                  </div>
                </div>

                <div class="dt-actions" style="margin-top:14px; justify-content:flex-end;">
                  <button class="btn btn-primary btn-sm" data-dt-act="save"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
                  <button class="btn btn-outline btn-sm" data-dt-act="delete" style="border-color:rgba(255,0,0,.35);">
                    <i class="fa-solid fa-trash"></i> 삭제
                  </button>
                </div>

                <div style="margin-top:10px; color:var(--muted); font-size:12px;"><span id="dtUpdatedAt"></span></div>
              </div>
            </div>
          </div>

          <!-- Simulator -->
          <div class="admin-card" style="padding:12px 14px; margin-top:10px;">
            <div class="admin-header">
              <h2 style="margin:0;"><i class="fa-solid fa-vial"></i> 임계값 검증</h2>
              <span class="badge" id="dtTestBadge">준비</span>
            </div>

            <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; align-items:center;">
              <div style="font-size:11px; color:var(--muted);">사용자</div>
              <select id="dtTestUser" class="conn-settings-select" style="max-width:200px;"></select>

              <div style="font-size:11px; color:var(--muted);">동작</div>
              <select id="dtTestType" class="conn-settings-select" style="max-width:160px;">
                <option value="QUERY">조회(SELECT)</option>
                <option value="EXPORT">반출(다운로드)</option>
              </select>

              <div style="font-size:11px; color:var(--muted);">객체</div>
              <input id="dtTestObj" class="conn-settings-input dt-mono" style="max-width:340px;"
                placeholder="예) APPDB.PUBLIC.USERS / PUBLIC.USERS" />

              <div style="font-size:11px; color:var(--muted);">행 수</div>
              <input id="dtTestRows" type="number" class="conn-settings-input" style="max-width:140px;" placeholder="예) 12000" />

              <div style="font-size:11px; color:var(--muted);">용량(MB)</div>
              <input id="dtTestMb" type="number" class="conn-settings-input" style="max-width:140px;" placeholder="예) 25" />

              <button class="btn btn-primary btn-sm" data-dt-act="test">
                <i class="fa-solid fa-play"></i> 검증 실행
              </button>
            </div>

            <div id="dtTestResult" style="margin-top:10px; display:none; border:1px solid var(--line); border-radius:12px; padding:10px;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <span class="badge" id="dtDecisionBadge"></span>
                  <span style="font-size:12px; color:var(--muted);" id="dtDecisionHint"></span>
                </div>
                <div style="font-size:12px; color:var(--muted);" id="dtAppliedPolicyHint"></div>
              </div>
              <div style="margin-top:10px;">
                <div style="font-size:12px; font-weight:700;">판정 사유</div>
                <div id="dtIssues" style="margin-top:6px; font-size:12px;"></div>
              </div>
            </div>
          </div>

          <!-- Requests -->
          <div class="admin-card" style="padding:12px 14px; margin-top:10px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div class="admin-header" style="margin:0;">
                <h2 style="margin:0;"><i class="fa-solid fa-circle-check"></i> 추가 승인 대기</h2>
              </div>
              <button class="btn btn-outline btn-sm" data-dt-act="clearReq"><i class="fa-solid fa-trash"></i> 대기 비우기</button>
            </div>

            <div style="margin-top:10px; overflow:auto; border:1px solid var(--line); border-radius:10px;">
              <table class="dt-table" style="min-width:980px;">
                <thead>
                  <tr>
                    <th style="width:140px;">시간</th>
                    <th style="width:120px;">사용자</th>
                    <th style="width:120px;">동작</th>
                    <th style="width:220px;">객체</th>
                    <th style="width:80px;">행</th>
                    <th style="width:80px;">MB</th>
                    <th>정책</th>
                    <th style="width:160px;">처리</th>
                  </tr>
                </thead>
                <tbody id="dtReqTbody"></tbody>
              </table>
            </div>
          </div>

          <!-- Logs -->
          <div class="admin-card" style="padding:12px 14px; margin-top:10px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div class="admin-header" style="margin:0;">
                <h2 style="margin:0;"><i class="fa-solid fa-clipboard-list"></i> 임계값 로그</h2>
              </div>
              <button class="btn btn-outline btn-sm" data-dt-act="clearLogs"><i class="fa-solid fa-trash"></i> 로그 비우기</button>
            </div>

            <div style="margin-top:10px; overflow:auto; border:1px solid var(--line); border-radius:10px;">
              <table class="dt-table" style="min-width:980px;">
                <thead>
                  <tr>
                    <th style="width:140px;">시간</th>
                    <th style="width:90px;">결과</th>
                    <th style="width:120px;">사용자</th>
                    <th style="width:120px;">동작</th>
                    <th style="width:220px;">객체</th>
                    <th style="width:80px;">행</th>
                    <th style="width:80px;">MB</th>
                    <th>사유</th>
                  </tr>
                </thead>
                <tbody id="dtLogsTbody"></tbody>
              </table>
            </div>
          </div>

        </div>
      `;
    }

    // ---------- Evaluation ----------
    function pickApplicablePolicy(policies, user, role, obj) {
      const applicable = policies
        .filter(p => p.status === "ENABLED")
        .filter(p => (p.targetType === "USER" ? p.target === user : p.target === role))
        .filter(p => {
          if (!p.scopeSetId) return true; // 전체
          const scopeSets = (typeof dbamLoadScopeSets === "function") ? dbamLoadScopeSets() : [];
          const ss = scopeSets.find(s => s.id === p.scopeSetId) || null;
          return isInScopeSet(ss, obj);
        })
        .sort((a,b) => (Number(b.priority||0) - Number(a.priority||0)) || String(a.name||"").localeCompare(String(b.name||"")));
      return applicable[0] || null;
    }

    function evalThreshold(policy, type, rows, mb) {
      const issues = [];
      const r = Number(rows || 0);
      const m = Number(mb || 0);

      const qLimit = Number(policy?.queryRowsLimit || 0);
      const eLimit = Number(policy?.exportRowsLimit || 0);
      const mbLimit = Number(policy?.exportSizeMbLimit || 0);

      if (type === "QUERY" && qLimit > 0 && r > qLimit) issues.push(`조회 행 수 초과: ${r} > ${qLimit}`);
      if (type === "EXPORT" && eLimit > 0 && r > eLimit) issues.push(`반출 행 수 초과: ${r} > ${eLimit}`);
      if (type === "EXPORT" && mbLimit > 0 && m > mbLimit) issues.push(`반출 용량 초과: ${m}MB > ${mbLimit}MB`);

      if (!issues.length) return { decision: "PASS", issues };
      if (policy.actionOnExceed === "WARN") return { decision: "WARN", issues };
      if (policy.actionOnExceed === "REQUIRE_APPROVAL") return { decision: "NEED_APPROVAL", issues };
      return { decision: "BLOCK", issues };
    }

    // ---------- Render ----------
    function renderDbamDownloadThresholdPage(mountEl) {
      if (!mountEl) throw new Error("mountEl is required");
      ensureStyle();
      mountEl.innerHTML = getTemplateHtml();

      const catalog = (typeof dbamGetCatalog === "function") ? dbamGetCatalog() : [];
      const scopeSets = (typeof dbamLoadScopeSets === "function") ? dbamLoadScopeSets() : [];

      const state = {
        catalog,
        scopeSets,
        policies: loadPolicies(scopeSets, catalog),
        requests: loadRequests(),
        logs: loadLogs(),
        selectedId: null,
        search: "",
        statusFilter: "ALL",
      };

      const $ = (sel) => mountEl.querySelector(sel);

      const listEl = $("#dtList");
      const countBadgeEl = $("#dtCountBadge");
      const editorEl = $("#dtEditor");
      const editorEmptyEl = $("#dtEditorEmpty");
      const editorStateEl = $("#dtEditorState");
      const updatedAtEl = $("#dtUpdatedAt");

      const selTargetTypeEl = $("#dtTargetType");
      const selTargetEl = $("#dtTarget");
      const selDefaultDbEl = $("#dtDefaultDb");
      const selScopeSetEl = $("#dtScopeSet");

      const reqTbodyEl = $("#dtReqTbody");
      const logsTbodyEl = $("#dtLogsTbody");

      const testBadgeEl = $("#dtTestBadge");
      const testUserEl = $("#dtTestUser");
      const testTypeEl = $("#dtTestType");
      const testObjEl = $("#dtTestObj");
      const testRowsEl = $("#dtTestRows");
      const testMbEl = $("#dtTestMb");

      const testResultEl = $("#dtTestResult");
      const decisionBadgeEl = $("#dtDecisionBadge");
      const decisionHintEl = $("#dtDecisionHint");
      const appliedPolicyHintEl = $("#dtAppliedPolicyHint");
      const issuesEl = $("#dtIssues");

      function saveAll() {
        safeSave(KEY_POLICIES, state.policies);
        safeSave(KEY_REQUESTS, state.requests);
        safeSave(KEY_LOGS, state.logs);
      }

      function getSelectedPolicy() {
        return state.policies.find(p => p.id === state.selectedId) || null;
      }

      function fillSelect(el, options, selected) {
        el.innerHTML = options.map(v => {
          const vv = String(v);
          return `<option value="${dbamEscHtml(vv)}" ${vv === String(selected) ? "selected" : ""}>${dbamEscHtml(vv)}</option>`;
        }).join("");
      }

      function renderTargetOptions() {
        const type = selTargetTypeEl.value || "ROLE";
        if (type === "USER") fillSelect(selTargetEl, SAMPLE_USERS, getSelectedPolicy()?.target || SAMPLE_USERS[0]);
        else fillSelect(selTargetEl, SAMPLE_ROLES, getSelectedPolicy()?.target || SAMPLE_ROLES[0]);
      }

      function renderList() {
        const q = state.search.trim().toLowerCase();
        const filtered = state.policies.filter(p => {
          const hit = !q || (p.name||"").toLowerCase().includes(q) || (p.target||"").toLowerCase().includes(q);
          const st = state.statusFilter === "ALL" || p.status === state.statusFilter;
          return hit && st;
        });

        countBadgeEl.textContent = String(filtered.length);

        listEl.innerHTML = filtered
          .slice()
          .sort((a,b) => (Number(b.priority||0) - Number(a.priority||0)) || String(a.name||"").localeCompare(String(b.name||"")))
          .map(p => {
            const active = p.id === state.selectedId;
            const st = (p.status === "ENABLED") ? "활성" : "비활성";
            const tt = (p.targetType === "USER" ? "사용자" : "역할") + " · " + (p.target || "-");
            const act = (p.actionOnExceed === "BLOCK") ? "차단" : (p.actionOnExceed === "WARN" ? "경고" : "추가 승인");
            const lim = `조회>${p.queryRowsLimit||0}, 반출>${p.exportRowsLimit||0}, MB>${p.exportSizeMbLimit||0}`;
            return `
              <div class="dt-row ${active ? "active" : ""}" data-dt-id="${dbamEscHtml(p.id)}">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                  <div style="min-width:0;">
                    <div style="font-weight:700; font-size:13px;" class="dt-ellipsis">${dbamEscHtml(p.name||"(이름 없음)")}</div>
                    <div style="margin-top:4px; font-size:12px; color:var(--muted);" class="dt-ellipsis">${dbamEscHtml(tt)}</div>
                    <div style="margin-top:4px; font-size:12px; color:var(--muted);" class="dt-ellipsis">${dbamEscHtml(lim)}</div>
                  </div>
                  <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
                    <span class="badge">${st}</span>
                    <span class="badge">${act}</span>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");

        if (!filtered.length) {
          listEl.innerHTML = `<div style="color:var(--muted); font-size:12px; padding:10px;">표시할 정책이 없습니다.</div>`;
        }
      }

      function renderEditor() {
        const p = getSelectedPolicy();
        if (!p) {
          editorEl.style.display = "none";
          editorEmptyEl.style.display = "block";
          editorStateEl.textContent = "선택 없음";
          updatedAtEl.textContent = "";
          return;
        }

        editorEl.style.display = "block";
        editorEmptyEl.style.display = "none";
        editorStateEl.textContent = "편집 중";

        $("#dtName").value = p.name || "";
        $("#dtStatus").value = p.status || "ENABLED";
        $("#dtPriority").value = String(p.priority ?? 100);
        $("#dtAction").value = p.actionOnExceed || "REQUIRE_APPROVAL";

        // DB 목록
        const dbNames = (typeof dbamListDbNames === "function") ? dbamListDbNames(state.catalog) : ["APPDB"];
        fillSelect(selDefaultDbEl, dbNames.length ? dbNames : ["APPDB"], p.defaultDb || dbNames[0] || "APPDB");

        selTargetTypeEl.value = p.targetType || "ROLE";
        renderTargetOptions();
        selTargetEl.value = p.target || "";

        // scope sets (전체 옵션 포함)
        const scopeOpts = [{ id: "", name: "(전체)", status: "ENABLED" }].concat(
          state.scopeSets.map(s => ({ id: s.id, name: s.name || s.id, status: s.status }))
        );

        selScopeSetEl.innerHTML = scopeOpts.map(s => {
          const label = `${s.name}${s.id && s.status==="DISABLED" ? " (비활성)" : ""}`;
          return `<option value="${dbamEscHtml(s.id)}" ${String(s.id)===String(p.scopeSetId||"")?"selected":""}>${dbamEscHtml(label)}</option>`;
        }).join("");

        $("#dtQueryRows").value = String(p.queryRowsLimit ?? "");
        $("#dtExportRows").value = String(p.exportRowsLimit ?? "");
        $("#dtExportMb").value = String(p.exportSizeMbLimit ?? "");

        updatedAtEl.textContent = p.updatedAt ? `마지막 저장: ${formatIso(p.updatedAt)}` : "";
      }

      function renderRequests() {
        const pending = state.requests.filter(r => r.status === "PENDING");
        reqTbodyEl.innerHTML = pending.map(r => `
          <tr data-req-id="${dbamEscHtml(r.id)}">
            <td class="dt-ellipsis">${formatIso(r.at)}</td>
            <td class="dt-ellipsis">${dbamEscHtml(r.user||"")}</td>
            <td class="dt-ellipsis">${dbamEscHtml(r.type||"")}</td>
            <td class="dt-ellipsis dt-mono">${dbamEscHtml(r.object||"")}</td>
            <td class="dt-ellipsis">${dbamEscHtml(String(r.rows||0))}</td>
            <td class="dt-ellipsis">${dbamEscHtml(String(r.mb||0))}</td>
            <td class="dt-wrap">${dbamEscHtml(r.policyName||"")}</td>
            <td>
              <div class="dt-actions">
                <button class="btn btn-primary btn-sm" data-dt-act="approveReq">승인</button>
                <button class="btn btn-outline btn-sm" data-dt-act="denyReq" style="border-color:rgba(255,0,0,.35);">반려</button>
              </div>
            </td>
          </tr>
        `).join("");

        if (!pending.length) {
          reqTbodyEl.innerHTML = `<tr><td colspan="8" style="padding:12px; color:var(--muted);">대기 중인 요청이 없습니다.</td></tr>`;
        }
      }

      function renderLogs() {
        const logs = state.logs.slice().reverse();
        logsTbodyEl.innerHTML = logs.map(l => {
          const cls =
            l.decision === "BLOCK" ? "dt-badge-block" :
            l.decision === "WARN" ? "dt-badge-warn" :
            l.decision === "NEED_APPROVAL" ? "dt-badge-need" : "dt-badge-pass";
          return `
            <tr>
              <td class="dt-ellipsis">${formatIso(l.at)}</td>
              <td><span class="badge ${cls}">${dbamEscHtml(l.decision||"")}</span></td>
              <td class="dt-ellipsis">${dbamEscHtml(l.user||"")}</td>
              <td class="dt-ellipsis">${dbamEscHtml(l.type||"")}</td>
              <td class="dt-ellipsis dt-mono">${dbamEscHtml(l.object||"")}</td>
              <td class="dt-ellipsis">${dbamEscHtml(String(l.rows||0))}</td>
              <td class="dt-ellipsis">${dbamEscHtml(String(l.mb||0))}</td>
              <td class="dt-wrap">${dbamEscHtml(l.reason||"")}</td>
            </tr>
          `;
        }).join("");

        if (!logs.length) {
          logsTbodyEl.innerHTML = `<tr><td colspan="8" style="padding:12px; color:var(--muted);">로그가 없습니다.</td></tr>`;
        }
      }

      function setSelected(id) {
        state.selectedId = id;
        renderList();
        renderEditor();
        testBadgeEl.textContent = id ? "준비" : "정책 선택 필요";
        testResultEl.style.display = "none";
      }

      function addPolicy() {
        const dbNames = (typeof dbamListDbNames === "function") ? dbamListDbNames(state.catalog) : ["APPDB"];
        const defaultDb = dbNames[0] || "APPDB";
        const p = {
          id: (typeof dbamUid === "function" ? dbamUid("dt") : ("dt_" + Date.now())),
          name: "새 임계값 정책",
          status: "ENABLED",
          targetType: "ROLE",
          target: SAMPLE_ROLES[0],
          priority: 100,
          actionOnExceed: "REQUIRE_APPROVAL",
          defaultDb,
          scopeSetId: "", // 전체
          queryRowsLimit: 5000,
          exportRowsLimit: 2000,
          exportSizeMbLimit: 10,
          updatedAt: nowISO(),
        };
        state.policies.push(p);
        safeSave(KEY_POLICIES, state.policies);
        setSelected(p.id);
        toast("새 정책을 생성했습니다. 내용을 수정 후 저장하세요.");
      }

      function collectEditor() {
        const p = getSelectedPolicy();
        if (!p) return null;

        const name = $("#dtName").value.trim();
        if (!name) { toast("정책 이름을 입력하세요."); return null; }

        const priority = Number($("#dtPriority").value || 0);
        const targetType = selTargetTypeEl.value || "ROLE";
        const target = selTargetEl.value || "";
        if (!target) { toast("적용 대상을 선택하세요."); return null; }

        p.name = name;
        p.status = $("#dtStatus").value || "ENABLED";
        p.priority = Number.isFinite(priority) ? priority : 0;
        p.actionOnExceed = $("#dtAction").value || "REQUIRE_APPROVAL";
        p.targetType = targetType;
        p.target = target;

        p.defaultDb = selDefaultDbEl.value || "APPDB";
        p.scopeSetId = selScopeSetEl.value || "";

        p.queryRowsLimit = Number($("#dtQueryRows").value || 0);
        p.exportRowsLimit = Number($("#dtExportRows").value || 0);
        p.exportSizeMbLimit = Number($("#dtExportMb").value || 0);

        p.updatedAt = nowISO();
        return p;
      }

      function deletePolicy() {
        const p = getSelectedPolicy();
        if (!p) return;
        if (!confirm("정책을 삭제할까요?")) return;

        state.policies = state.policies.filter(x => x.id !== p.id);
        safeSave(KEY_POLICIES, state.policies);
        setSelected(state.policies[0]?.id || null);
        toast("삭제했습니다.");
      }

      function runTest() {
        const user = testUserEl.value || "";
        const role = USER_ROLE_MAP[user] || "DEV";
        const type = testTypeEl.value || "QUERY";
        const rows = Number(testRowsEl.value || 0);
        const mb = Number(testMbEl.value || 0);

        const p = getSelectedPolicy();
        if (!p) { toast("정책을 선택하세요."); return; }

        const obj = parseObj(testObjEl.value || "", p.defaultDb || "APPDB") || { db: p.defaultDb || "APPDB", schema:"*", table:"*", column:"*" };

        // "선택한 정책"이 아니라 "적용 가능한 정책" 기준으로 판단(우선순위 반영)
        const applicable = pickApplicablePolicy(state.policies, user, role, obj);
        if (!applicable) {
          testResultEl.style.display = "block";
          testBadgeEl.textContent = "통과";
          decisionBadgeEl.className = "badge dt-badge-pass";
          decisionBadgeEl.textContent = "PASS";
          decisionHintEl.textContent = "적용 가능한 활성 정책이 없습니다.";
          appliedPolicyHintEl.textContent = "";
          issuesEl.innerHTML = `<span style="color:var(--muted);">이슈 없음</span>`;
          return;
        }

        const out = evalThreshold(applicable, type, rows, mb);

        // UI
        testResultEl.style.display = "block";
        testBadgeEl.textContent =
          out.decision === "PASS" ? "통과" :
          out.decision === "WARN" ? "경고" :
          out.decision === "NEED_APPROVAL" ? "추가 승인" : "차단";

        const cls =
          out.decision === "BLOCK" ? "dt-badge-block" :
          out.decision === "WARN" ? "dt-badge-warn" :
          out.decision === "NEED_APPROVAL" ? "dt-badge-need" : "dt-badge-pass";

        decisionBadgeEl.className = `badge ${cls}`;
        decisionBadgeEl.textContent = out.decision;

        decisionHintEl.textContent = `사용자:${user} (역할:${role}) · ${type} · ${obj.db}.${obj.schema}.${obj.table}`;
        appliedPolicyHintEl.textContent = `${applicable.name} · ${applicable.targetType}:${applicable.target} · 우선순위:${applicable.priority||0}`;

        issuesEl.innerHTML = out.issues.length
          ? `<ul style="margin:0; padding-left:16px;">${out.issues.map(x => `<li>${dbamEscHtml(x)}</li>`).join("")}</ul>`
          : `<span style="color:var(--muted);">이슈 없음</span>`;

        // 로그 적재(경고/차단/추가승인)
        if (out.decision !== "PASS") {
          state.logs.push({
            id: "log_" + Date.now(),
            at: nowISO(),
            decision: out.decision,
            user,
            type,
            object: `${obj.db}.${obj.schema}.${obj.table}`,
            rows,
            mb,
            reason: out.issues.join(" / "),
          });
          if (state.logs.length > 200) state.logs = state.logs.slice(state.logs.length - 200);
        }

        // 추가 승인 요청 생성
        if (out.decision === "NEED_APPROVAL") {
          state.requests.push({
            id: "req_" + Date.now(),
            at: nowISO(),
            status: "PENDING",
            user,
            role,
            type,
            object: `${obj.db}.${obj.schema}.${obj.table}`,
            rows,
            mb,
            policyId: applicable.id,
            policyName: applicable.name,
            reason: out.issues.join(" / "),
          });
          if (state.requests.length > 200) state.requests = state.requests.slice(state.requests.length - 200);
        }

        saveAll();
        renderRequests();
        renderLogs();
      }

      function approveOrDeny(reqId, status) {
        const r = state.requests.find(x => x.id === reqId);
        if (!r) return;
        r.status = status;
        r.processedAt = nowISO();

        // 처리 로그 남김
        state.logs.push({
          id: "log_" + Date.now(),
          at: nowISO(),
          decision: status === "APPROVED" ? "APPROVED" : "DENIED",
          user: r.user,
          type: r.type,
          object: r.object,
          rows: r.rows,
          mb: r.mb,
          reason: `${status === "APPROVED" ? "승인" : "반려"} · ${r.reason || ""}`.trim(),
        });
        if (state.logs.length > 200) state.logs = state.logs.slice(state.logs.length - 200);

        saveAll();
        renderRequests();
        renderLogs();
      }

      // ---------- Bind ----------
      mountEl.addEventListener("click", async (e) => {
        const row = e.target.closest?.("[data-dt-id]");
        if (row) {
          setSelected(row.getAttribute("data-dt-id"));
          return;
        }

        const btn = e.target.closest?.("[data-dt-act]");
        if (!btn) return;
        const act = btn.getAttribute("data-dt-act");

        if (act === "new") addPolicy();
        if (act === "save") {
          const p = collectEditor();
          if (!p) return;
          safeSave(KEY_POLICIES, state.policies);
          renderList();
          renderEditor();
          toast("저장했습니다.");
        }
        if (act === "delete") deletePolicy();
        if (act === "test") runTest();

        if (act === "approveReq" || act === "denyReq") {
          const tr = e.target.closest?.("tr[data-req-id]");
          const reqId = tr?.getAttribute("data-req-id");
          if (!reqId) return;
          approveOrDeny(reqId, act === "approveReq" ? "APPROVED" : "DENIED");
        }

        if (act === "clearReq") {
          if (!confirm("대기 중인 요청을 모두 비울까요?")) return;
          state.requests = [];
          safeSave(KEY_REQUESTS, state.requests);
          renderRequests();
        }

        if (act === "clearLogs") {
          if (!confirm("로그를 모두 비울까요?")) return;
          state.logs = [];
          safeSave(KEY_LOGS, state.logs);
          renderLogs();
        }

        if (act === "export") {
          downloadJson("dbam_download_threshold_export.json", {
            exportedAt: nowISO(),
            policies: state.policies,
            requests: state.requests,
            logs: state.logs,
          });
          toast("내보내기를 완료했습니다.");
        }

        if (act === "gotoScope") {
          if (W.objectScopeAdmin && typeof W.objectScopeAdmin.open === "function") {
            W.objectScopeAdmin.open();
          } else if (W.DBAM && typeof W.DBAM.renderDbamScopeRangePage === "function") {
            const bodyEl = document.getElementById("adminBody");
            if (bodyEl) W.DBAM.renderDbamScopeRangePage(bodyEl);
          } else {
            toast("범위 세트 화면 로더를 찾지 못했습니다.");
          }
        }
      });

      mountEl.addEventListener("input", (e) => {
        if (e.target.id === "dtSearch") {
          state.search = e.target.value || "";
          renderList();
        }
      });

      mountEl.addEventListener("change", (e) => {
        if (e.target.id === "dtFilterStatus") {
          state.statusFilter = e.target.value || "ALL";
          renderList();
        }
        if (e.target.id === "dtTargetType") {
          renderTargetOptions();
        }
      });

      // import
      const importEl = $("#dtImportFile");
      importEl.addEventListener("change", async () => {
        const f = importEl.files && importEl.files[0];
        importEl.value = "";
        if (!f) return;

        try {
          const data = await readJsonFile(f);
          const policies = Array.isArray(data?.policies) ? data.policies : null;
          if (!policies) throw new Error("policies가 없습니다.");

          state.policies = policies;
          state.requests = Array.isArray(data?.requests) ? data.requests : [];
          state.logs = Array.isArray(data?.logs) ? data.logs : [];

          saveAll();
          state.selectedId = state.policies[0]?.id || null;
          renderList(); renderEditor(); renderRequests(); renderLogs();
          toast("가져오기를 완료했습니다.");
        } catch (err) {
          console.warn(err);
          toast("가져오기 실패: 파일 형식을 확인하세요.");
        }
      });

      // initial
      fillSelect(testUserEl, SAMPLE_USERS, SAMPLE_USERS[0]);
      testBadgeEl.textContent = state.policies.length ? "준비" : "정책 없음";
      state.selectedId = state.policies[0]?.id || null;

      // editor selects
      const dbNames = (typeof dbamListDbNames === "function") ? dbamListDbNames(state.catalog) : ["APPDB"];
      fillSelect(selDefaultDbEl, dbNames.length ? dbNames : ["APPDB"], dbNames[0] || "APPDB");
      renderTargetOptions();

      renderList();
      renderEditor();
      renderRequests();
      renderLogs();
    }

    W.DBAM.renderDbamDownloadThresholdPage = renderDbamDownloadThresholdPage;

    // ---------- Admin open + card click (event delegation 방식) ----------
    const downloadThresholdAdmin = {
      open() {
        const titleEl = document.getElementById("adminTitle");
        const descEl  = document.getElementById("adminDesc");
        const bodyEl  = document.getElementById("adminBody");
        if (!titleEl || !descEl || !bodyEl) return;

        try {
          W.admin.current = "scopePolicy";
          document.querySelectorAll(".admin-nav button").forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.section === "scopePolicy");
          });
        } catch (_) {}

        titleEl.innerHTML = '<i class="fa-solid fa-download"></i> 대량 조회/반출 임계값 정책';
        descEl.textContent = "행 수/용량 임계값을 기준으로 추가 승인 또는 차단/경고 정책을 관리합니다.";

        W.DBAM.renderDbamDownloadThresholdPage(bodyEl);
      }
    };
    W.downloadThresholdAdmin = downloadThresholdAdmin;

    // admin.show를 또 감싸지 않고, 클릭 이벤트 위임으로 카드 진입 처리
    document.addEventListener("click", (e) => {
      const card = e.target.closest?.("#adminBody .admin-card.admin-card-clickable");
      if (!card) return;

      // scopePolicy 화면에서만 동작(불필요한 오작동 방지)
      if (!W.admin || W.admin.current !== "scopePolicy") return;

      const h4 = card.querySelector("h4");
      const title = (h4?.textContent || "").trim();
      if (!title.includes("대량 조회/반출 임계값 정책")) return;

      e.preventDefault();
      e.stopPropagation();
      downloadThresholdAdmin.open();
    }, true);
  })();

  /* =========================
   * DBAM - 접속 위치/시간대 정책 (timeLocationPolicy)
   * window.DBAM.renderDbamTimeLocationPolicyPage(mountEl)
   * ========================= */
  (function () {
    const W = window;
    W.DBAM = W.DBAM || {};
    if (W.DBAM.__timeLocationPolicyInstalled) return;
    W.DBAM.__timeLocationPolicyInstalled = true;

    const KEY_POLICIES = "dbam_time_location_policies";
    const KEY_REQUESTS = "dbam_time_location_requests";
    const KEY_LOGS     = "dbam_time_location_logs";

    const SAMPLE_ROLES = ["DEV", "DBA", "AUDIT", "SECURITY"];
    const SAMPLE_USERS = ["kim.dev", "lee.sec", "park.dba", "choi.audit"];
    const USER_ROLE_MAP = {
      "kim.dev": "DEV",
      "lee.sec": "SECURITY",
      "park.dba": "DBA",
      "choi.audit": "AUDIT",
    };

    // 위치 태그(필요하면 추가)
    const LOCATION_TAGS = ["OFFICE", "VPN", "HOME", "OVERSEAS", "UNKNOWN"];

    // 시간대(오프셋 분)
    const TZ_OPTIONS = [
      { label: "로컬(브라우저)", value: "LOCAL" },
      { label: "UTC(+00:00)", value: "0" },
      { label: "KST(+09:00)", value: String(9 * 60) },
      { label: "JST(+09:00)", value: String(9 * 60) },
      { label: "CST(+08:00)", value: String(8 * 60) },
      { label: "IST(+05:30)", value: String(5 * 60 + 30) },
      { label: "EST(-05:00)", value: String(-5 * 60) },
      { label: "PST(-08:00)", value: String(-8 * 60) },
    ];

    function nowISO() { return new Date().toISOString(); }
    function toast(msg) { (typeof dbamToast === "function") ? dbamToast(msg) : alert(msg); }

    function safeLoad(key, fallback) {
      try { return (typeof dbamLoad === "function") ? dbamLoad(key, fallback) : fallback; }
      catch (_) { return fallback; }
    }
    function safeSave(key, value) {
      try { if (typeof dbamSave === "function") dbamSave(key, value); }
      catch (_) {}
    }
    function esc(s) { return (typeof dbamEscHtml === "function") ? dbamEscHtml(String(s ?? "")) : String(s ?? ""); }

    function formatIso(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return iso;
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} `
        + `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    function ensureStyle() {
      if (document.getElementById("dbamTimeLocStyle")) return;
      const st = document.createElement("style");
      st.id = "dbamTimeLocStyle";
      st.textContent = `
        .tl-row{border:1px solid var(--line); border-radius:12px; padding:10px 12px; cursor:pointer;}
        .tl-row.active{box-shadow:0 0 0 2px rgba(80,140,255,.25) inset;}
        .tl-kv{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px;}
        .tl-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
        .tl-checks{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
        .tl-check{display:flex; align-items:center; gap:6px; font-size:12px; color:var(--text);}
        .tl-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;}
        .tl-badge-pass{background:rgba(0,160,90,.12); border:1px solid rgba(0,160,90,.25); color:#0a7a4a;}
        .tl-badge-warn{background:rgba(255,170,0,.12); border:1px solid rgba(255,170,0,.28); color:#a86b00;}
        .tl-badge-block{background:rgba(255,0,0,.10); border:1px solid rgba(255,0,0,.22); color:#b30000;}
        .tl-badge-need{background:rgba(80,140,255,.12); border:1px solid rgba(80,140,255,.22); color:#2b5dbb;}
        .tl-table{width:100%; border-collapse:collapse;}
        .tl-table th,.tl-table td{padding:10px; border-bottom:1px solid var(--line); vertical-align:top;}
        .tl-table th{background:var(--panel,#f8fafc); text-align:left; white-space:nowrap;}
        .tl-ellipsis{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
        .tl-wrap{white-space:normal; word-break:break-word;}
      `;
      document.head.appendChild(st);
    }

    // ---------------------
    // IP utils (CIDR + wildcard)
    // ---------------------
    function isValidIpv4(ip) {
      const m = String(ip||"").trim().match(/^(\d{1,3}\.){3}\d{1,3}$/);
      if (!m) return false;
      return String(ip).split(".").every(x => {
        const n = Number(x);
        return Number.isInteger(n) && n >= 0 && n <= 255;
      });
    }
    function ipToInt(ip) {
      if (!isValidIpv4(ip)) return null;
      const parts = ip.split(".").map(Number);
      return ((parts[0] << 24) >>> 0) + (parts[1] << 16) + (parts[2] << 8) + parts[3];
    }
    function cidrContains(cidr, ip) {
      const s = String(cidr||"").trim();
      const m = s.match(/^(.+?)\/(\d{1,2})$/);
      if (!m) return false;
      const base = m[1].trim();
      const bits = Number(m[2]);
      if (!isValidIpv4(base) || !isValidIpv4(ip)) return false;
      if (bits < 0 || bits > 32) return false;

      const baseInt = ipToInt(base);
      const ipInt = ipToInt(ip);
      if (baseInt == null || ipInt == null) return false;

      const mask = bits === 0 ? 0 : ((0xFFFFFFFF << (32 - bits)) >>> 0);
      return ((baseInt & mask) >>> 0) === ((ipInt & mask) >>> 0);
    }

    // ---------------------
    // Time utils
    // ---------------------
    // 요일: 월(1)~일(7) UI / 내부는 0~6(일요일=0)로 처리
    const WEEK_LABELS = [
      { key: 1, label: "월" },
      { key: 2, label: "화" },
      { key: 3, label: "수" },
      { key: 4, label: "목" },
      { key: 5, label: "금" },
      { key: 6, label: "토" },
      { key: 0, label: "일" }, // 내부 기준으로 0
    ];

    function hhmmToMin(hhmm) {
      const s = String(hhmm||"").trim();
      const m = s.match(/^(\d{1,2}):(\d{2})$/);
      if (!m) return null;
      const hh = Number(m[1]), mm = Number(m[2]);
      if (!Number.isInteger(hh) || !Number.isInteger(mm)) return null;
      if (hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;
      return hh * 60 + mm;
    }

    // date(로컬 Date) -> 정책 시간대 기준 (요일/분)
    function getZonedParts(date, tzOffsetMinStr) {
      const d = date instanceof Date ? date : new Date();
      if (tzOffsetMinStr === "LOCAL") {
        return {
          dow: d.getDay(), // 0=Sun
          minOfDay: d.getHours() * 60 + d.getMinutes(),
        };
      }
      const offsetMin = Number(tzOffsetMinStr || 0);
      // UTC 기준 밀리초로 변환 -> 오프셋 적용
      const utcMs = d.getTime() + (d.getTimezoneOffset() * 60000);
      const zonedMs = utcMs + (offsetMin * 60000);
      const z = new Date(zonedMs);
      return {
        dow: z.getUTCDay(),
        minOfDay: z.getUTCHours() * 60 + z.getUTCMinutes(),
      };
    }

    function isWithinTimeWindow(minOfDay, startMin, endMin) {
      // start/end 둘 다 유효하지 않으면 전체 허용
      if (startMin == null || endMin == null) return true;

      if (startMin === endMin) {
        // 같은 값이면 "하루 종일"로 보는게 UX상 안전
        return true;
      }
      if (startMin < endMin) {
        return minOfDay >= startMin && minOfDay <= endMin;
      }
      // 자정 넘어감(예: 22:00 ~ 06:00)
      return (minOfDay >= startMin) || (minOfDay <= endMin);
    }

    // ---------------------
    // Policy evaluation
    // ---------------------
    function parseCsvLines(s) {
      return String(s || "")
        .split(/\r?\n|,/g)
        .map(x => x.trim())
        .filter(Boolean);
    }

    function pickApplicablePolicy(policies, user, role) {
      const list = (policies || [])
        .filter(p => p.status === "ENABLED")
        .filter(p => (p.targetType === "USER" ? p.target === user : p.target === role))
        .sort((a,b) => (Number(b.priority||0) - Number(a.priority||0)) || String(a.name||"").localeCompare(String(b.name||"")));
      return list[0] || null;
    }

    function matchAnyGlob(patterns, value) {
      const val = String(value || "");
      const arr = Array.isArray(patterns) ? patterns : [];
      if (!arr.length) return null; // "정의 안됨"
      for (const p of arr) {
        const rx = (typeof dbamGlobToRegExp === "function") ? dbamGlobToRegExp(p) : /^.*$/i;
        if (rx.test(val)) return true;
      }
      return false;
    }

    function matchIpRules(ipRules, ip) {
      const rules = Array.isArray(ipRules) ? ipRules : [];
      if (!rules.length) return null; // "정의 안됨"
      const val = String(ip || "").trim();
      for (const r of rules) {
        const rule = String(r || "").trim();
        if (!rule) continue;
        if (rule.includes("/") && cidrContains(rule, val)) return true;
        // wildcard
        const rx = (typeof dbamGlobToRegExp === "function") ? dbamGlobToRegExp(rule) : /^.*$/i;
        if (rx.test(val)) return true;
      }
      return false;
    }

    function evaluateAttempt(policy, attempt) {
      const res = { decision: "PASS", issues: [], applied: policy || null };

      if (!policy || policy.status !== "ENABLED") return res;

      // 1) 요일/시간대 검사
      const z = getZonedParts(attempt.at, policy.tzOffsetMin);
      const allowedDays = Array.isArray(policy.weekdays) ? policy.weekdays : []; // 0~6
      if (allowedDays.length && !allowedDays.includes(z.dow)) {
        res.issues.push(`허용 요일이 아님 (현재:${z.dow})`);
      }

      const startMin = hhmmToMin(policy.timeStart);
      const endMin   = hhmmToMin(policy.timeEnd);
      if (!isWithinTimeWindow(z.minOfDay, startMin, endMin)) {
        res.issues.push(`허용 시간대 밖 (${policy.timeStart || "-"}~${policy.timeEnd || "-"})`);
      }

      // 2) 위치(태그/IP) 검사
      const tags = parseCsvLines(policy.allowedLocationTags);
      const ips  = parseCsvLines(policy.allowedIpRules);

      const tagHit = matchAnyGlob(tags, attempt.locationTag);
      const ipHit  = matchIpRules(ips, attempt.ip);

      // 정의가 없으면(둘 다 null) 위치 검사는 통과
      let locationMatched;
      if (tagHit == null && ipHit == null) {
        locationMatched = true;
      } else {
        locationMatched = (tagHit === true) || (ipHit === true);
      }

      const mode = policy.locationMode || "INCLUDE"; // INCLUDE | EXCLUDE
      if (mode === "INCLUDE") {
        if (!locationMatched) res.issues.push("허용 위치/대역에 포함되지 않음");
      } else {
        // EXCLUDE: 매칭되면 차단
        if (locationMatched) res.issues.push("차단 위치/대역에 해당");
      }

      if (!res.issues.length) return res;

      const action = policy.actionOnViolation || "BLOCK"; // BLOCK | REQUIRE_APPROVAL | WARN
      if (action === "WARN") res.decision = "WARN";
      else if (action === "REQUIRE_APPROVAL") res.decision = "NEED_APPROVAL";
      else res.decision = "BLOCK";

      return res;
    }

    // ---------------------
    // Storage seed
    // ---------------------
    function loadPolicies() {
      const arr = safeLoad(KEY_POLICIES, []);
      if (Array.isArray(arr) && arr.length) return arr;

      const seed = [
        {
          id: (typeof dbamUid === "function" ? dbamUid("tl") : ("tl_" + Date.now())),
          name: "개발자 업무시간/내부망 제한",
          status: "ENABLED",
          priority: 100,
          targetType: "ROLE",
          target: "DEV",

          tzOffsetMin: String(9 * 60),   // KST
          weekdays: [1,2,3,4,5],          // 월~금 (0=일)
          timeStart: "09:00",
          timeEnd: "19:00",

          locationMode: "INCLUDE",        // INCLUDE(허용목록) | EXCLUDE(차단목록)
          allowedLocationTags: "OFFICE, VPN",
          allowedIpRules: "10.*.*.*, 192.168.*.*, 172.16.0.0/12",

          actionOnViolation: "REQUIRE_APPROVAL", // BLOCK | REQUIRE_APPROVAL | WARN
          updatedAt: nowISO(),
        }
      ];
      safeSave(KEY_POLICIES, seed);
      return seed;
    }

    function loadRequests() {
      const arr = safeLoad(KEY_REQUESTS, []);
      return Array.isArray(arr) ? arr : [];
    }
    function loadLogs() {
      const arr = safeLoad(KEY_LOGS, []);
      return Array.isArray(arr) ? arr : [];
    }

    function saveAll(state) {
      safeSave(KEY_POLICIES, state.policies);
      safeSave(KEY_REQUESTS, state.requests);
      safeSave(KEY_LOGS, state.logs);
    }

    // ---------------------
    // Template
    // ---------------------
    function getTemplateHtml() {
      const weekdayChecks = WEEK_LABELS.map(w => {
        const id = `tlDay_${w.key}`;
        return `<label class="tl-check"><input type="checkbox" data-tl-day="${w.key}" id="${id}"> ${w.label}</label>`;
      }).join("");

      const tzOptions = TZ_OPTIONS.map(o => `<option value="${esc(o.value)}">${esc(o.label)}</option>`).join("");

      const locOptions = LOCATION_TAGS.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join("");

      return `
        <div id="timeLocationPolicyPage" class="emg-page" style="width:100%; max-width:100%; overflow-x:hidden;">

          <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-primary" data-tl-act="new"><i class="fa-solid fa-plus"></i> 새 정책</button>
              <button class="btn btn-outline" data-tl-act="export"><i class="fa-solid fa-file-export"></i> 내보내기</button>
              <label class="btn btn-outline" style="cursor:pointer; margin:0;">
                <i class="fa-solid fa-file-import"></i> 가져오기
                <input type="file" id="tlImportFile" accept="application/json" style="display:none;" />
              </label>
            </div>
            <div class="admin-footer">
              접속 위치(태그/IP대역)와 시간대(요일/업무시간/야간)를 기준으로 접속을 차단·경고·추가승인 처리합니다.
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; min-width:0;">
            <!-- Left -->
            <div class="admin-card" style="flex:1 1 320px; min-width:0; padding:12px 14px;">
              <div class="admin-header">
                <h2 style="margin:0;"><i class="fa-solid fa-list"></i> 정책 목록</h2>
                <span class="badge" id="tlCountBadge">0</span>
              </div>

              <div style="display:flex; gap:8px; margin-top:10px;">
                <input id="tlSearch" class="conn-settings-input" placeholder="검색 (이름/대상)" />
                <select id="tlFilterStatus" class="conn-settings-select" style="max-width:140px;">
                  <option value="ALL">전체</option>
                  <option value="ENABLED">활성</option>
                  <option value="DISABLED">비활성</option>
                </select>
              </div>

              <div id="tlList" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
            </div>

            <!-- Right -->
            <div class="admin-card" style="flex:2 1 520px; min-width:0; padding:12px 14px;">
              <div class="admin-header">
                <h2 style="margin:0;"><i class="fa-solid fa-pen-to-square"></i> 편집</h2>
                <span class="badge" id="tlEditorState">선택 없음</span>
              </div>

              <div id="tlEditorEmpty" style="margin-top:12px; color:var(--muted); font-size:12px;">
                왼쪽에서 정책을 선택하거나 새로 생성하세요.
              </div>

              <div id="tlEditor" style="display:none; margin-top:12px;">
                <div class="tl-kv">
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">정책 이름</div>
                    <input id="tlName" class="conn-settings-input" placeholder="예) 개발자 업무시간/내부망 제한" />
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">상태</div>
                    <select id="tlStatus" class="conn-settings-select">
                      <option value="ENABLED">활성</option>
                      <option value="DISABLED">비활성</option>
                    </select>
                  </div>

                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">우선순위</div>
                    <input id="tlPriority" type="number" class="conn-settings-input" placeholder="100" />
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">위반 시 동작</div>
                    <select id="tlAction" class="conn-settings-select">
                      <option value="BLOCK">차단</option>
                      <option value="REQUIRE_APPROVAL">추가 승인</option>
                      <option value="WARN">경고(로그만)</option>
                    </select>
                  </div>

                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">적용 대상 유형</div>
                    <select id="tlTargetType" class="conn-settings-select">
                      <option value="ROLE">역할</option>
                      <option value="USER">사용자</option>
                    </select>
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">적용 대상</div>
                    <select id="tlTarget" class="conn-settings-select"></select>
                  </div>

                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">정책 기준 시간대</div>
                    <select id="tlTz" class="conn-settings-select">${tzOptions}</select>
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">허용 시간</div>
                    <div style="display:flex; gap:8px;">
                      <input id="tlStart" class="conn-settings-input" placeholder="09:00" />
                      <input id="tlEnd" class="conn-settings-input" placeholder="19:00" />
                    </div>
                    <div style="margin-top:6px; color:var(--muted); font-size:11px;">
                      시작 &gt; 종료면 “야간(자정 넘어감)”으로 처리됩니다. (예: 22:00~06:00)
                    </div>
                  </div>

                  <div style="grid-column:1 / -1;">
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">허용 요일</div>
                    <div class="tl-checks">${weekdayChecks}</div>
                    <div style="margin-top:6px; color:var(--muted); font-size:11px;">
                      선택이 없으면 “모든 요일 허용”으로 처리합니다.
                    </div>
                  </div>

                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">위치 모드</div>
                    <select id="tlLocMode" class="conn-settings-select">
                      <option value="INCLUDE">포함(허용 목록)</option>
                      <option value="EXCLUDE">제외(차단 목록)</option>
                    </select>
                  </div>
                  <div>
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">허용 위치 태그(쉼표/줄바꿈)</div>
                    <input id="tlLocTags" class="conn-settings-input" placeholder="예) OFFICE, VPN" />
                  </div>

                  <div style="grid-column:1 / -1;">
                    <div style="font-size:11px; color:var(--muted); margin-bottom:4px;">IP 대역 규칙(쉼표/줄바꿈)</div>
                    <input id="tlIpRules" class="conn-settings-input tl-mono" placeholder="예) 10.*.*.*, 192.168.0.0/24" />
                    <div style="margin-top:6px; color:var(--muted); font-size:11px;">
                      CIDR(예: 192.168.0.0/24) 또는 와일드카드(예: 10.*.*.*) 지원
                    </div>
                  </div>
                </div>

                <div class="tl-actions" style="margin-top:14px; justify-content:flex-end;">
                  <button class="btn btn-primary btn-sm" data-tl-act="save"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
                  <button class="btn btn-outline btn-sm" data-tl-act="delete" style="border-color:rgba(255,0,0,.35);">
                    <i class="fa-solid fa-trash"></i> 삭제
                  </button>
                </div>

                <div style="margin-top:10px; color:var(--muted); font-size:12px;"><span id="tlUpdatedAt"></span></div>
              </div>
            </div>
          </div>

          <!-- Simulator -->
          <div class="admin-card" style="padding:12px 14px; margin-top:10px;">
            <div class="admin-header">
              <h2 style="margin:0;"><i class="fa-solid fa-vial"></i> 접속 시도 검증</h2>
              <span class="badge" id="tlTestBadge">준비</span>
            </div>

            <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; align-items:center;">
              <div style="font-size:11px; color:var(--muted);">사용자</div>
              <select id="tlTestUser" class="conn-settings-select" style="max-width:200px;"></select>

              <div style="font-size:11px; color:var(--muted);">위치 태그</div>
              <select id="tlTestLoc" class="conn-settings-select" style="max-width:180px;">${locOptions}</select>

              <div style="font-size:11px; color:var(--muted);">IP</div>
              <input id="tlTestIp" class="conn-settings-input tl-mono" style="max-width:220px;" placeholder="예) 10.0.1.23" />

              <div style="font-size:11px; color:var(--muted);">시간(로컬)</div>
              <input id="tlTestTime" class="conn-settings-input" style="max-width:180px;" placeholder="예) 2025-12-16 21:30" />

              <button class="btn btn-primary btn-sm" data-tl-act="test">
                <i class="fa-solid fa-play"></i> 검증 실행
              </button>
            </div>

            <div id="tlTestResult" style="margin-top:10px; display:none; border:1px solid var(--line); border-radius:12px; padding:10px;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <span class="badge" id="tlDecisionBadge"></span>
                  <span style="font-size:12px; color:var(--muted);" id="tlDecisionHint"></span>
                </div>
                <div style="font-size:12px; color:var(--muted);" id="tlAppliedHint"></div>
              </div>

              <div style="margin-top:10px;">
                <div style="font-size:12px; font-weight:700;">판정 사유</div>
                <div id="tlIssues" style="margin-top:6px; font-size:12px;"></div>
              </div>
            </div>
          </div>

          <!-- Requests -->
          <div class="admin-card" style="padding:12px 14px; margin-top:10px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div class="admin-header" style="margin:0;">
                <h2 style="margin:0;"><i class="fa-solid fa-circle-check"></i> 추가 승인 대기</h2>
              </div>
              <button class="btn btn-outline btn-sm" data-tl-act="clearReq"><i class="fa-solid fa-trash"></i> 대기 비우기</button>
            </div>

            <div style="margin-top:10px; overflow:auto; border:1px solid var(--line); border-radius:10px;">
              <table class="tl-table" style="min-width:980px;">
                <thead>
                  <tr>
                    <th style="width:140px;">시간</th>
                    <th style="width:120px;">사용자</th>
                    <th style="width:120px;">위치</th>
                    <th style="width:160px;">IP</th>
                    <th>사유</th>
                    <th style="width:170px;">처리</th>
                  </tr>
                </thead>
                <tbody id="tlReqTbody"></tbody>
              </table>
            </div>
          </div>

          <!-- Logs -->
          <div class="admin-card" style="padding:12px 14px; margin-top:10px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <div class="admin-header" style="margin:0;">
                <h2 style="margin:0;"><i class="fa-solid fa-clipboard-list"></i> 정책 로그</h2>
              </div>
              <button class="btn btn-outline btn-sm" data-tl-act="clearLogs"><i class="fa-solid fa-trash"></i> 로그 비우기</button>
            </div>

            <div style="margin-top:10px; overflow:auto; border:1px solid var(--line); border-radius:10px;">
              <table class="tl-table" style="min-width:980px;">
                <thead>
                  <tr>
                    <th style="width:140px;">시간</th>
                    <th style="width:100px;">결과</th>
                    <th style="width:120px;">사용자</th>
                    <th style="width:120px;">위치</th>
                    <th style="width:160px;">IP</th>
                    <th>사유</th>
                  </tr>
                </thead>
                <tbody id="tlLogsTbody"></tbody>
              </table>
            </div>
          </div>

        </div>
      `;
    }

    // ---------------------
    // Render / bind
    // ---------------------
    function renderDbamTimeLocationPolicyPage(mountEl) {
      if (!mountEl) throw new Error("mountEl is required");
      ensureStyle();
      mountEl.innerHTML = getTemplateHtml();

      const state = {
        policies: loadPolicies(),
        requests: loadRequests(),
        logs: loadLogs(),
        selectedId: null,
        search: "",
        statusFilter: "ALL",
      };

      const $ = (sel) => mountEl.querySelector(sel);

      const listEl = $("#tlList");
      const countEl = $("#tlCountBadge");

      const editorEl = $("#tlEditor");
      const emptyEl  = $("#tlEditorEmpty");
      const editorStateEl = $("#tlEditorState");
      const updatedAtEl = $("#tlUpdatedAt");

      const testBadgeEl = $("#tlTestBadge");
      const testUserEl  = $("#tlTestUser");
      const testLocEl   = $("#tlTestLoc");
      const testIpEl    = $("#tlTestIp");
      const testTimeEl  = $("#tlTestTime");

      const testResultEl = $("#tlTestResult");
      const decisionBadgeEl = $("#tlDecisionBadge");
      const decisionHintEl  = $("#tlDecisionHint");
      const appliedHintEl   = $("#tlAppliedHint");
      const issuesEl        = $("#tlIssues");

      const reqTbodyEl  = $("#tlReqTbody");
      const logsTbodyEl = $("#tlLogsTbody");

      function getSelectedPolicy() {
        return state.policies.find(p => p.id === state.selectedId) || null;
      }

      function fillSelect(el, options, selected) {
        el.innerHTML = options.map(v => `<option value="${esc(v)}" ${String(v)===String(selected)?"selected":""}>${esc(v)}</option>`).join("");
      }

      function renderTargetOptions() {
        const p = getSelectedPolicy();
        const type = $("#tlTargetType").value || (p?.targetType || "ROLE");
        if (type === "USER") fillSelect($("#tlTarget"), SAMPLE_USERS, p?.target || SAMPLE_USERS[0]);
        else fillSelect($("#tlTarget"), SAMPLE_ROLES, p?.target || SAMPLE_ROLES[0]);
      }

      function renderList() {
        const q = (state.search || "").trim().toLowerCase();
        const filtered = state.policies.filter(p => {
          const hit = !q || (p.name||"").toLowerCase().includes(q) || (p.target||"").toLowerCase().includes(q);
          const st = state.statusFilter === "ALL" || p.status === state.statusFilter;
          return hit && st;
        });

        countEl.textContent = String(filtered.length);

        listEl.innerHTML = filtered
          .slice()
          .sort((a,b) => (Number(b.priority||0) - Number(a.priority||0)) || String(a.name||"").localeCompare(String(b.name||"")))
          .map(p => {
            const active = p.id === state.selectedId;
            const st = p.status === "ENABLED" ? "활성" : "비활성";
            const tgt = (p.targetType === "USER" ? "사용자" : "역할") + " · " + (p.target || "-");
            const act = p.actionOnViolation === "WARN" ? "경고" : (p.actionOnViolation === "REQUIRE_APPROVAL" ? "추가 승인" : "차단");
            const time = `${p.timeStart||"-"}~${p.timeEnd||"-"}`;
            const days = Array.isArray(p.weekdays) && p.weekdays.length ? ("요일 " + p.weekdays.join(",")) : "요일 전체";
            return `
              <div class="tl-row ${active ? "active" : ""}" data-tl-id="${esc(p.id)}">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                  <div style="min-width:0;">
                    <div style="font-weight:700; font-size:13px;" class="tl-ellipsis">${esc(p.name||"(이름 없음)")}</div>
                    <div style="margin-top:4px; font-size:12px; color:var(--muted);" class="tl-ellipsis">${esc(tgt)}</div>
                    <div style="margin-top:4px; font-size:12px; color:var(--muted);" class="tl-ellipsis">${esc(days)} · ${esc(time)}</div>
                  </div>
                  <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
                    <span class="badge">${esc(st)}</span>
                    <span class="badge">${esc(act)}</span>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");

        if (!filtered.length) {
          listEl.innerHTML = `<div style="color:var(--muted); font-size:12px; padding:10px;">표시할 정책이 없습니다.</div>`;
        }
      }

      function renderEditor() {
        const p = getSelectedPolicy();
        if (!p) {
          editorEl.style.display = "none";
          emptyEl.style.display = "block";
          editorStateEl.textContent = "선택 없음";
          updatedAtEl.textContent = "";
          return;
        }

        editorEl.style.display = "block";
        emptyEl.style.display  = "none";
        editorStateEl.textContent = "편집 중";

        $("#tlName").value = p.name || "";
        $("#tlStatus").value = p.status || "ENABLED";
        $("#tlPriority").value = String(p.priority ?? 100);
        $("#tlAction").value = p.actionOnViolation || "BLOCK";

        $("#tlTargetType").value = p.targetType || "ROLE";
        renderTargetOptions();
        $("#tlTarget").value = p.target || "";

        $("#tlTz").value = (p.tzOffsetMin ?? String(9 * 60));
        $("#tlStart").value = p.timeStart || "09:00";
        $("#tlEnd").value   = p.timeEnd || "19:00";

        // weekday checks
        const days = Array.isArray(p.weekdays) ? p.weekdays : [];
        mountEl.querySelectorAll("[data-tl-day]").forEach(cb => {
          const k = Number(cb.getAttribute("data-tl-day"));
          cb.checked = days.includes(k);
        });

        $("#tlLocMode").value = p.locationMode || "INCLUDE";
        $("#tlLocTags").value = p.allowedLocationTags || "";
        $("#tlIpRules").value = p.allowedIpRules || "";

        updatedAtEl.textContent = p.updatedAt ? `마지막 저장: ${formatIso(p.updatedAt)}` : "";
      }

      function renderRequests() {
        const pending = state.requests.filter(r => r.status === "PENDING");
        reqTbodyEl.innerHTML = pending.map(r => `
          <tr data-req-id="${esc(r.id)}">
            <td class="tl-ellipsis">${formatIso(r.at)}</td>
            <td class="tl-ellipsis">${esc(r.user||"")}</td>
            <td class="tl-ellipsis">${esc(r.locationTag||"")}</td>
            <td class="tl-ellipsis tl-mono">${esc(r.ip||"")}</td>
            <td class="tl-wrap">${esc(r.reason||"")}</td>
            <td>
              <div class="tl-actions">
                <button class="btn btn-primary btn-sm" data-tl-act="approveReq">승인</button>
                <button class="btn btn-outline btn-sm" data-tl-act="denyReq" style="border-color:rgba(255,0,0,.35);">반려</button>
              </div>
            </td>
          </tr>
        `).join("");

        if (!pending.length) {
          reqTbodyEl.innerHTML = `<tr><td colspan="6" style="padding:12px; color:var(--muted);">대기 중인 요청이 없습니다.</td></tr>`;
        }
      }

      function renderLogs() {
        const logs = state.logs.slice().reverse();
        logsTbodyEl.innerHTML = logs.map(l => {
          const cls =
            l.decision === "BLOCK" ? "tl-badge-block" :
            l.decision === "WARN" ? "tl-badge-warn" :
            l.decision === "NEED_APPROVAL" ? "tl-badge-need" : "tl-badge-pass";
          return `
            <tr>
              <td class="tl-ellipsis">${formatIso(l.at)}</td>
              <td><span class="badge ${cls}">${esc(l.decision||"")}</span></td>
              <td class="tl-ellipsis">${esc(l.user||"")}</td>
              <td class="tl-ellipsis">${esc(l.locationTag||"")}</td>
              <td class="tl-ellipsis tl-mono">${esc(l.ip||"")}</td>
              <td class="tl-wrap">${esc(l.reason||"")}</td>
            </tr>
          `;
        }).join("");

        if (!logs.length) {
          logsTbodyEl.innerHTML = `<tr><td colspan="6" style="padding:12px; color:var(--muted);">로그가 없습니다.</td></tr>`;
        }
      }

      function setSelected(id) {
        state.selectedId = id;
        renderList();
        renderEditor();
        testBadgeEl.textContent = id ? "준비" : "정책 선택 필요";
        testResultEl.style.display = "none";
      }

      function addPolicy() {
        const p = {
          id: (typeof dbamUid === "function" ? dbamUid("tl") : ("tl_" + Date.now())),
          name: "새 접속 정책",
          status: "ENABLED",
          priority: 100,
          targetType: "ROLE",
          target: SAMPLE_ROLES[0],

          tzOffsetMin: "LOCAL",
          weekdays: [],
          timeStart: "09:00",
          timeEnd: "19:00",

          locationMode: "INCLUDE",
          allowedLocationTags: "OFFICE",
          allowedIpRules: "10.*.*.*",

          actionOnViolation: "BLOCK",
          updatedAt: nowISO(),
        };
        state.policies.push(p);
        saveAll(state);
        setSelected(p.id);
        toast("새 정책을 생성했습니다. 내용을 수정 후 저장하세요.");
      }

      function collectEditor() {
        const p = getSelectedPolicy();
        if (!p) return null;

        const name = $("#tlName").value.trim();
        if (!name) { toast("정책 이름을 입력하세요."); return null; }

        p.name = name;
        p.status = $("#tlStatus").value || "ENABLED";
        p.priority = Number($("#tlPriority").value || 0);
        p.actionOnViolation = $("#tlAction").value || "BLOCK";

        p.targetType = $("#tlTargetType").value || "ROLE";
        p.target = $("#tlTarget").value || "";
        if (!p.target) { toast("적용 대상을 선택하세요."); return null; }

        p.tzOffsetMin = $("#tlTz").value || "LOCAL";
        p.timeStart = $("#tlStart").value.trim();
        p.timeEnd   = $("#tlEnd").value.trim();

        const days = [];
        mountEl.querySelectorAll("[data-tl-day]").forEach(cb => {
          if (cb.checked) days.push(Number(cb.getAttribute("data-tl-day")));
        });
        p.weekdays = days;

        p.locationMode = $("#tlLocMode").value || "INCLUDE";
        p.allowedLocationTags = $("#tlLocTags").value || "";
        p.allowedIpRules = $("#tlIpRules").value || "";

        p.updatedAt = nowISO();
        return p;
      }

      function deletePolicy() {
        const p = getSelectedPolicy();
        if (!p) return;
        if (!confirm("정책을 삭제할까요?")) return;

        state.policies = state.policies.filter(x => x.id !== p.id);
        saveAll(state);
        setSelected(state.policies[0]?.id || null);
        toast("삭제했습니다.");
      }

      function parseTestTimeInput(s) {
        const t = String(s || "").trim();
        if (!t) return new Date(); // 비면 현재
        // "YYYY-MM-DD HH:mm" 형태 지원
        const m = t.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{1,2}):(\d{2})$/);
        if (m) {
          const yy = Number(m[1]), mm = Number(m[2]) - 1, dd = Number(m[3]);
          const hh = Number(m[4]), mi = Number(m[5]);
          const d = new Date(yy, mm, dd, hh, mi, 0, 0);
          if (!Number.isNaN(d.getTime())) return d;
        }
        const d2 = new Date(t);
        return Number.isNaN(d2.getTime()) ? new Date() : d2;
      }

      function runTest() {
        const user = testUserEl.value || "";
        const role = USER_ROLE_MAP[user] || "DEV";
        const locTag = testLocEl.value || "UNKNOWN";
        const ip = String(testIpEl.value || "").trim();
        const at = parseTestTimeInput(testTimeEl.value);

        const applicable = pickApplicablePolicy(state.policies, user, role);
        if (!applicable) {
          testResultEl.style.display = "block";
          testBadgeEl.textContent = "통과";
          decisionBadgeEl.className = "badge tl-badge-pass";
          decisionBadgeEl.textContent = "PASS";
          decisionHintEl.textContent = "적용 가능한 활성 정책이 없습니다.";
          appliedHintEl.textContent = "";
          issuesEl.innerHTML = `<span style="color:var(--muted);">이슈 없음</span>`;
          return;
        }

        const result = evaluateAttempt(applicable, { user, role, locationTag: locTag, ip, at });

        testResultEl.style.display = "block";
        testBadgeEl.textContent =
          result.decision === "PASS" ? "통과" :
          result.decision === "WARN" ? "경고" :
          result.decision === "NEED_APPROVAL" ? "추가 승인" : "차단";

        const cls =
          result.decision === "BLOCK" ? "tl-badge-block" :
          result.decision === "WARN" ? "tl-badge-warn" :
          result.decision === "NEED_APPROVAL" ? "tl-badge-need" : "tl-badge-pass";

        decisionBadgeEl.className = `badge ${cls}`;
        decisionBadgeEl.textContent = result.decision;

        decisionHintEl.textContent = `사용자:${user} (역할:${role}) · 위치:${locTag} · IP:${ip||"-"}`;
        appliedHintEl.textContent = `${applicable.name} · ${applicable.targetType}:${applicable.target} · 우선순위:${applicable.priority||0}`;

        issuesEl.innerHTML = result.issues.length
          ? `<ul style="margin:0; padding-left:16px;">${result.issues.map(x => `<li>${esc(x)}</li>`).join("")}</ul>`
          : `<span style="color:var(--muted);">이슈 없음</span>`;

        // 로그(통과 제외)
        if (result.decision !== "PASS") {
          state.logs.push({
            id: "log_" + Date.now(),
            at: nowISO(),
            decision: result.decision,
            user,
            role,
            locationTag: locTag,
            ip,
            reason: result.issues.join(" / "),
            policyId: applicable.id,
            policyName: applicable.name,
          });
          if (state.logs.length > 200) state.logs = state.logs.slice(state.logs.length - 200);
        }

        // 추가 승인 요청
        if (result.decision === "NEED_APPROVAL") {
          state.requests.push({
            id: "req_" + Date.now(),
            at: nowISO(),
            status: "PENDING",
            user,
            role,
            locationTag: locTag,
            ip,
            reason: result.issues.join(" / "),
            policyId: applicable.id,
            policyName: applicable.name,
          });
          if (state.requests.length > 200) state.requests = state.requests.slice(state.requests.length - 200);
        }

        saveAll(state);
        renderRequests();
        renderLogs();
      }

      function approveOrDeny(reqId, status) {
        const r = state.requests.find(x => x.id === reqId);
        if (!r) return;
        r.status = status;
        r.processedAt = nowISO();

        // 처리 로그
        state.logs.push({
          id: "log_" + Date.now(),
          at: nowISO(),
          decision: status === "APPROVED" ? "APPROVED" : "DENIED",
          user: r.user,
          role: r.role,
          locationTag: r.locationTag,
          ip: r.ip,
          reason: `${status === "APPROVED" ? "승인" : "반려"} · ${r.reason || ""}`.trim(),
          policyId: r.policyId,
          policyName: r.policyName,
        });
        if (state.logs.length > 200) state.logs = state.logs.slice(state.logs.length - 200);

        saveAll(state);
        renderRequests();
        renderLogs();
      }

      // bind: click
      mountEl.addEventListener("click", async (e) => {
        const row = e.target.closest?.("[data-tl-id]");
        if (row) {
          setSelected(row.getAttribute("data-tl-id"));
          return;
        }

        const btn = e.target.closest?.("[data-tl-act]");
        if (!btn) return;
        const act = btn.getAttribute("data-tl-act");

        if (act === "new") addPolicy();
        if (act === "save") {
          const p = collectEditor();
          if (!p) return;
          saveAll(state);
          renderList();
          renderEditor();
          toast("저장했습니다.");
        }
        if (act === "delete") deletePolicy();
        if (act === "test") runTest();

        if (act === "approveReq" || act === "denyReq") {
          const tr = e.target.closest?.("tr[data-req-id]");
          const reqId = tr?.getAttribute("data-req-id");
          if (!reqId) return;
          approveOrDeny(reqId, act === "approveReq" ? "APPROVED" : "DENIED");
        }

        if (act === "clearReq") {
          if (!confirm("대기 중인 요청을 모두 비울까요?")) return;
          state.requests = [];
          saveAll(state);
          renderRequests();
        }

        if (act === "clearLogs") {
          if (!confirm("로그를 모두 비울까요?")) return;
          state.logs = [];
          saveAll(state);
          renderLogs();
        }

        if (act === "export") {
          const payload = { exportedAt: nowISO(), policies: state.policies, requests: state.requests, logs: state.logs };
          const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "dbam_time_location_policy_export.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          toast("내보내기를 완료했습니다.");
        }
      });

      // bind: input/search
      mountEl.addEventListener("input", (e) => {
        if (e.target.id === "tlSearch") {
          state.search = e.target.value || "";
          renderList();
        }
      });

      // bind: change
      mountEl.addEventListener("change", (e) => {
        if (e.target.id === "tlFilterStatus") {
          state.statusFilter = e.target.value || "ALL";
          renderList();
        }
        if (e.target.id === "tlTargetType") {
          renderTargetOptions();
        }
      });

      // import
      const importEl = $("#tlImportFile");
      importEl.addEventListener("change", async () => {
        const f = importEl.files && importEl.files[0];
        importEl.value = "";
        if (!f) return;
        try {
          const txt = await f.text();
          const data = JSON.parse(txt);
          const policies = Array.isArray(data?.policies) ? data.policies : null;
          if (!policies) throw new Error("policies가 없습니다.");

          state.policies = policies;
          state.requests = Array.isArray(data?.requests) ? data.requests : [];
          state.logs = Array.isArray(data?.logs) ? data.logs : [];
          saveAll(state);

          setSelected(state.policies[0]?.id || null);
          renderRequests();
          renderLogs();
          toast("가져오기를 완료했습니다.");
        } catch (err) {
          console.warn(err);
          toast("가져오기 실패: 파일 형식을 확인하세요.");
        }
      });

      // initial
      fillSelect(testUserEl, SAMPLE_USERS, SAMPLE_USERS[0]);
      testBadgeEl.textContent = state.policies.length ? "준비" : "정책 없음";
      state.selectedId = state.policies[0]?.id || null;

      renderList();
      renderEditor();
      renderRequests();
      renderLogs();
    }

    W.DBAM.renderDbamTimeLocationPolicyPage = renderDbamTimeLocationPolicyPage;

    // ---------------------
    // Admin open + card click (이벤트 위임)
    // ---------------------
    const timeLocationPolicyAdmin = {
      open() {
        const titleEl = document.getElementById("adminTitle");
        const descEl  = document.getElementById("adminDesc");
        const bodyEl  = document.getElementById("adminBody");
        if (!titleEl || !descEl || !bodyEl) return;

        try {
          W.admin.current = "scopePolicy";
          document.querySelectorAll(".admin-nav button").forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.section === "scopePolicy");
          });
        } catch (_) {}

        titleEl.innerHTML = '<i class="fa-solid fa-clock"></i> 접속 위치/시간대 정책';
        descEl.textContent = "IP/망대역/시간대(업무시간/야간/휴일) 기반으로 접속 허용·제한 정책을 정의합니다.";

        W.DBAM.renderDbamTimeLocationPolicyPage(bodyEl);
      }
    };
    W.timeLocationPolicyAdmin = timeLocationPolicyAdmin;

    // scopePolicy 카드 클릭 -> open
    document.addEventListener("click", (e) => {
      const card = e.target.closest?.("#adminBody .admin-card.admin-card-clickable");
      if (!card) return;
      if (!W.admin || W.admin.current !== "scopePolicy") return;

      const h4 = card.querySelector("h4");
      const title = (h4?.textContent || "").trim();
      if (!title.includes("접속 위치/시간대 정책")) return;

      e.preventDefault();
      e.stopPropagation();
      timeLocationPolicyAdmin.open();
    }, true);
  })();

  
  
  
  
  
  
  /* =========================
   * DBAM - 로그인 실패 횟수·계정 잠금 (loginLock)
   * Entry: window.DBAM.renderDbamLoginLockPage(mountEl)
   * ========================= */
  (function () {
    const W = window;
    W.DBAM = W.DBAM || {};
    if (W.DBAM.__loginLockInstalled) return;
    W.DBAM.__loginLockInstalled = true;

    const KEY_POLICY = "dbam_auth_login_lock_policy";
    const KEY_USERS  = "dbam_auth_login_lock_users";
    const KEY_LOGS   = "dbam_auth_login_lock_logs";

    // ---------------- Utils ----------------
    function toast(msg) { (typeof dbamToast === "function") ? dbamToast(msg) : alert(msg); }
    function esc(s) { return (typeof dbamEscHtml === "function") ? dbamEscHtml(s) : String(s ?? ""); }
    function safeLoad(key, fallback) {
      try { return (typeof dbamLoad === "function") ? dbamLoad(key, fallback) : fallback; }
      catch (_) { return fallback; }
    }
    function safeSave(key, value) {
      try { if (typeof dbamSave === "function") dbamSave(key, value); }
      catch (_) {}
    }
    function uid(prefix) { return (typeof dbamUid === "function") ? dbamUid(prefix) : `${prefix}_${Date.now()}`; }
    function nowISO() { return new Date().toISOString(); }
    function fmtISO(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return String(iso);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      const ss = String(d.getSeconds()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    }

    function ensureStyle() {
      if (document.getElementById("dbamLoginLockStyle")) return;
      const st = document.createElement("style");
      st.id = "dbamLoginLockStyle";
      st.textContent = `
        .ll-kv{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px;}
        .ll-kv .label{font-size:11px; color:var(--muted); margin-bottom:4px;}
        .ll-row{border:1px solid var(--line); border-radius:12px; padding:10px 12px;}
        .ll-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
        .ll-badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid var(--line);}
        .ll-badge.ok{background:rgba(0,160,90,.10); border-color:rgba(0,160,90,.18); color:#0a7a4a;}
        .ll-badge.lock{background:rgba(255,0,0,.08); border-color:rgba(255,0,0,.18); color:#b30000;}
        .ll-badge.off{background:rgba(107,114,128,.10); border-color:rgba(107,114,128,.18); color:#4b5563;}
        .ll-table{width:100%; border-collapse:collapse; font-size:12px;}
        .ll-table th,.ll-table td{padding:10px; border-bottom:1px solid var(--line); vertical-align:top;}
        .ll-table th{background:var(--panel,#f8fafc); text-align:left; white-space:nowrap;}
        .ll-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;}
        .ll-ellipsis{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:240px;}
        .ll-scroll-x{overflow-x:auto; -webkit-overflow-scrolling:touch;}
        .ll-mini-btn{padding:4px 8px; font-size:11px; line-height:1.1;}
      `;
      document.head.appendChild(st);
    }

    // ---------------- Storage seed ----------------
    function defaultPolicy() {
      return {
        enabled: true,
        maxFails: 5,                 // 실패 허용 횟수
        lockMode: "TEMP",            // TEMP | PERM
        lockDurationMin: 30,         // TEMP일 때 자동 해제까지(분)
        resetOnSuccess: true,        // 로그인 성공 시 실패 카운트 초기화
        windowMin: 0,                // (옵션) 0이면 미사용, >0이면 해당 분 안의 실패만 누적(간단 구현)
        note: "기본 로그인 실패/잠금 정책"
      };
    }

    function seedUsersIfEmpty(policy) {
      const existing = safeLoad(KEY_USERS, null);
      if (Array.isArray(existing) && existing.length) return existing;

      const sample = Array.isArray(W.DBAM_USER_SAMPLE) ? W.DBAM_USER_SAMPLE : [];
      const base = sample.length ? sample : [
        { id: "u1001", name: "홍길동", dept: "정보보안실", team: "DB보안팀", title: "대리", status: "ACTIVE", mfa: "ON", lastLogin: "2025-12-10 09:12", lastLoginIp: "10.10.1.15", failCount: 0 },
        { id: "u1002", name: "김감사", dept: "정보보안실", team: "감사팀",   title: "과장", status: "LOCKED", mfa: "ON", lastLogin: "2025-12-09 18:02", lastLoginIp: "10.10.2.22", failCount: 6 },
        { id: "u1003", name: "박개발", dept: "플랫폼개발부", team: "API팀",  title: "사원", status: "ACTIVE", mfa: "OFF", lastLogin: "2025-12-11 11:44", lastLoginIp: "10.20.1.3",  failCount: 2 },
      ];

      const now = Date.now();
      const users = base.map((u, idx) => {
        const status = u.status || "ACTIVE";
        const failCount = Number(u.failCount || 0);
        let lockedAt = null;
        let lockUntil = null;
        if (status === "LOCKED") {
          lockedAt = new Date(now - (idx + 1) * 7 * 60 * 1000).toISOString();
          if (policy.lockMode === "TEMP") {
            lockUntil = new Date(new Date(lockedAt).getTime() + policy.lockDurationMin * 60 * 1000).toISOString();
          }
        }
        return {
          accountId: String(u.id || u.accountId || ""),
          name: u.name || "-",
          dept: u.dept || "-",
          team: u.team || "-",
          title: u.title || "-",
          mfa: u.mfa || "OFF",
          status,
          failCount,
          failHistory: [],            // [{at, ip}] (windowMin 사용 시)
          lastFailAt: null,
          lastFailIp: null,
          lockedAt,
          lockUntil,
          lockReason: status === "LOCKED" ? "실패 횟수 초과(샘플)" : "",
          lastLogin: u.lastLogin || "",
          lastLoginIp: u.lastLoginIp || ""
        };
      });

      safeSave(KEY_USERS, users);
      return users;
    }

    function seedLogsIfEmpty() {
      const existing = safeLoad(KEY_LOGS, null);
      if (Array.isArray(existing) && existing.length) return existing;

      const seed = [
        { id: uid("llog"), at: nowISO(), accountId: "u1002", type: "LOCK", ip: "10.10.2.22", detail: "실패 횟수 초과로 잠금" },
        { id: uid("llog"), at: nowISO(), accountId: "u1003", type: "FAIL", ip: "10.20.1.3",  detail: "비밀번호 불일치" },
      ];
      safeSave(KEY_LOGS, seed);
      return seed;
    }

    function ensureSeed() {
      const p = safeLoad(KEY_POLICY, null);
      if (!p) safeSave(KEY_POLICY, defaultPolicy());
      const policy = safeLoad(KEY_POLICY, defaultPolicy());
      const users = seedUsersIfEmpty(policy);
      const logs = seedLogsIfEmpty();
      return { policy, users, logs };
    }

    // ---------------- Core logic ----------------
    function pushLog(accountId, type, ip, detail) {
      const logs = Array.isArray(safeLoad(KEY_LOGS, [])) ? safeLoad(KEY_LOGS, []) : [];
      logs.unshift({
        id: uid("llog"),
        at: nowISO(),
        accountId: String(accountId || ""),
        type: String(type || ""),
        ip: String(ip || ""),
        detail: String(detail || "")
      });
      // 로그가 너무 커지는 것 방지(간단 상한)
      if (logs.length > 800) logs.length = 800;
      safeSave(KEY_LOGS, logs);
      return logs;
    }

    function normalizeAutoUnlock(policy, users) {
      if (!policy || !Array.isArray(users)) return { users, changed: false };
      let changed = false;
      const now = Date.now();

      users.forEach(u => {
        if (u.status !== "LOCKED") return;
        if (policy.lockMode !== "TEMP") return;
        if (!u.lockUntil) return;

        const until = new Date(u.lockUntil).getTime();
        if (Number.isNaN(until)) return;
        if (until > now) return;

        // 자동 해제
        u.status = "ACTIVE";
        u.failCount = 0;
        u.failHistory = [];
        u.lockedAt = null;
        u.lockUntil = null;
        u.lockReason = "";
        changed = true;

        pushLog(u.accountId, "AUTO_UNLOCK", "-", "잠금 기간 만료로 자동 해제");
      });

      return { users, changed };
    }

    function applyWindowedFails(policy, user) {
      // windowMin > 0 일 때: window 밖 실패 기록은 제거하고 failCount 재계산
      const win = Number(policy.windowMin || 0);
      if (!win || win <= 0) return;
      const now = Date.now();
      const cutoff = now - win * 60 * 1000;
      user.failHistory = Array.isArray(user.failHistory) ? user.failHistory : [];
      user.failHistory = user.failHistory.filter(x => {
        const t = x?.at ? new Date(x.at).getTime() : 0;
        return t && !Number.isNaN(t) && t >= cutoff;
      });
      user.failCount = user.failHistory.length;
    }

    function lockUser(policy, user, reason, ip) {
      user.status = "LOCKED";
      user.lockedAt = nowISO();
      user.lockReason = reason || "정책에 의해 잠금";
      if (policy.lockMode === "TEMP") {
        const until = new Date(Date.now() + Number(policy.lockDurationMin || 0) * 60 * 1000);
        user.lockUntil = until.toISOString();
      } else {
        user.lockUntil = null; // PERM
      }
      pushLog(user.accountId, "LOCK", ip || "-", user.lockReason);
    }

    function unlockUser(user, ip, reason) {
      user.status = "ACTIVE";
      user.failCount = 0;
      user.failHistory = [];
      user.lockedAt = null;
      user.lockUntil = null;
      user.lockReason = "";
      pushLog(user.accountId, "UNLOCK", ip || "-", reason || "관리자 해제");
    }

    function resetFails(user, ip, reason) {
      user.failCount = 0;
      user.failHistory = [];
      user.lastFailAt = null;
      user.lastFailIp = null;
      pushLog(user.accountId, "RESET_FAIL", ip || "-", reason || "실패 카운트 초기화");
    }

    function recordFail(policy, user, ip, detail) {
      if (user.status === "DISABLED") {
        toast("비활성 계정입니다.");
        return;
      }
      if (user.status === "LOCKED") {
        toast("이미 잠금 상태입니다.");
        return;
      }
      const at = nowISO();
      user.lastFailAt = at;
      user.lastFailIp = ip || "-";

      user.failHistory = Array.isArray(user.failHistory) ? user.failHistory : [];
      user.failHistory.push({ at, ip: ip || "-" });

      if (Number(policy.windowMin || 0) > 0) {
        applyWindowedFails(policy, user);
      } else {
        user.failCount = Number(user.failCount || 0) + 1;
      }

      pushLog(user.accountId, "FAIL", ip || "-", detail || "로그인 실패");

      const maxFails = Number(policy.maxFails || 0);
      if (policy.enabled && maxFails > 0 && user.failCount >= maxFails) {
        lockUser(policy, user, `실패 횟수 ${user.failCount}/${maxFails} 초과`, ip || "-");
      }
    }

    function recordSuccess(policy, user, ip) {
      if (user.status === "LOCKED") {
        toast("잠금 상태에서는 성공 처리할 수 없습니다. 해제 후 진행하세요.");
        return;
      }
      if (policy.resetOnSuccess) {
        resetFails(user, ip || "-", "로그인 성공으로 실패 카운트 초기화");
      } else {
        pushLog(user.accountId, "SUCCESS", ip || "-", "로그인 성공");
      }
      user.lastLogin = fmtISO(nowISO());
      user.lastLoginIp = ip || "-";
    }

    // ---------------- UI ----------------
    function badgeHtml(status) {
      const s = String(status || "");
      if (s === "ACTIVE") return `<span class="ll-badge ok"><i class="fa-solid fa-circle-check"></i> ACTIVE</span>`;
      if (s === "LOCKED") return `<span class="ll-badge lock"><i class="fa-solid fa-lock"></i> LOCKED</span>`;
      return `<span class="ll-badge off"><i class="fa-solid fa-circle-minus"></i> ${esc(s || "OFF")}</span>`;
    }

    function templateHtml() {
      return `
        <div id="loginLockPage" class="emg-page" style="width:100%; max-width:100%; overflow-x:hidden;">
          <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-primary" data-ll-act="save"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
              <button class="btn btn-outline" data-ll-act="reset"><i class="fa-solid fa-rotate"></i> 초기화</button>
              <button class="btn btn-outline" data-ll-act="export"><i class="fa-solid fa-file-export"></i> 내보내기</button>
              <label class="btn btn-outline" style="cursor:pointer; margin:0;">
                <i class="fa-solid fa-file-import"></i> 가져오기
                <input type="file" id="llImportFile" accept="application/json" style="display:none;" />
              </label>
            </div>
            <div class="admin-footer">로그인 실패 제한/잠금 정책을 설정하고, 계정 잠금 현황 및 이력을 조회합니다.</div>
          </div>

          <div style="display:grid; grid-template-columns:360px minmax(0,1fr); gap:12px; align-items:flex-start;">
            <div style="display:flex; flex-direction:column; gap:10px;">
              <div class="admin-card" id="llPolicyCard" style="padding:12px 14px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                  <div style="font-weight:700;"><i class="fa-solid fa-sliders"></i> 정책 설정</div>
                  <div id="llPolicyEnabledBadge"></div>
                </div>

                <div class="ll-kv" style="margin-top:10px;">
                  <div>
                    <div class="label">정책 사용</div>
                    <select id="llEnabled" class="export-input">
                      <option value="true">ENABLED</option>
                      <option value="false">DISABLED</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">실패 허용 횟수</div>
                    <input id="llMaxFails" type="number" min="1" max="20" class="export-input" placeholder="예: 5" />
                  </div>

                  <div>
                    <div class="label">잠금 방식</div>
                    <select id="llLockMode" class="export-input">
                      <option value="TEMP">TEMP (자동 해제)</option>
                      <option value="PERM">PERM (수동 해제)</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">자동 해제까지(분)</div>
                    <input id="llLockDurationMin" type="number" min="1" max="1440" class="export-input" placeholder="예: 30" />
                  </div>

                  <div>
                    <div class="label">성공 시 실패 카운트 초기화</div>
                    <select id="llResetOnSuccess" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">실패 누적 윈도우(분)</div>
                    <input id="llWindowMin" type="number" min="0" max="240" class="export-input" placeholder="0=미사용" />
                  </div>
                </div>

                <div class="admin-footer" style="margin-top:10px;">
                  윈도우(분)를 0보다 크게 설정하면, 해당 시간 안의 실패만 누적하여 잠금을 판단합니다.
                </div>
              </div>

              <div class="admin-card" id="llSimCard" style="padding:12px 14px;">
                <div style="font-weight:700;"><i class="fa-solid fa-vial"></i> 동작 테스트</div>

                <div class="ll-kv" style="margin-top:10px;">
                  <div style="grid-column:1 / -1;">
                    <div class="label">대상 계정</div>
                    <select id="llSimUser" class="export-input"></select>
                  </div>
                  <div>
                    <div class="label">IP</div>
                    <input id="llSimIp" class="export-input ll-mono" placeholder="예: 10.0.0.1" />
                  </div>
                  <div>
                    <div class="label">사유(선택)</div>
                    <input id="llSimReason" class="export-input" placeholder="예: 비밀번호 오입력" />
                  </div>
                </div>

                <div class="ll-actions" style="margin-top:10px;">
                  <button class="btn btn-outline ll-mini-btn" data-ll-sim="fail"><i class="fa-solid fa-xmark"></i> 실패 +1</button>
                  <button class="btn btn-outline ll-mini-btn" data-ll-sim="success"><i class="fa-solid fa-check"></i> 성공</button>
                  <button class="btn btn-outline ll-mini-btn" data-ll-sim="reset"><i class="fa-solid fa-broom"></i> 실패 초기화</button>
                  <button class="btn btn-outline ll-mini-btn" data-ll-sim="lock"><i class="fa-solid fa-lock"></i> 강제 잠금</button>
                  <button class="btn btn-outline ll-mini-btn" data-ll-sim="unlock"><i class="fa-solid fa-unlock"></i> 강제 해제</button>
                </div>

                <div class="ll-row" style="margin-top:10px;">
                  <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                    <div style="font-size:12px;">
                      <div style="color:var(--muted); font-size:11px;">현재 상태</div>
                      <div id="llSimStatus" style="margin-top:4px;"></div>
                    </div>
                    <div style="font-size:12px;">
                      <div style="color:var(--muted); font-size:11px;">실패 카운트</div>
                      <div id="llSimFail" style="margin-top:4px; font-weight:700;"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px;">
              <div class="admin-card" id="llUsersCard" style="padding:12px 14px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                  <div style="font-weight:700;"><i class="fa-solid fa-users"></i> 계정 현황</div>
                  <div class="ll-actions">
                    <input id="llUserSearch" class="export-input" style="width:220px;" placeholder="검색: 계정/이름/부서" />
                    <select id="llUserStatusFilter" class="export-input" style="width:160px;">
                      <option value="">전체</option>
                      <option value="ACTIVE">ACTIVE</option>
                      <option value="LOCKED">LOCKED</option>
                      <option value="DISABLED">DISABLED</option>
                    </select>
                  </div>
                </div>

                <div id="llUserSummary" class="admin-footer" style="margin-top:8px;"></div>

                <div class="ll-scroll-x" style="margin-top:8px;">
                  <table class="ll-table">
                    <thead>
                      <tr>
                        <th>계정</th>
                        <th>이름</th>
                        <th>부서/팀</th>
                        <th>상태</th>
                        <th>실패</th>
                        <th>잠금 만료</th>
                        <th>최근 실패</th>
                        <th>조치</th>
                      </tr>
                    </thead>
                    <tbody id="llUsersTbody"></tbody>
                  </table>
                </div>
              </div>

              <div class="admin-card" id="llLogsCard" style="padding:12px 14px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                  <div style="font-weight:700;"><i class="fa-solid fa-clock-rotate-left"></i> 잠금/실패 이력</div>
                  <div class="ll-actions">
                    <select id="llLogTypeFilter" class="export-input" style="width:180px;">
                      <option value="">전체</option>
                      <option value="FAIL">FAIL</option>
                      <option value="LOCK">LOCK</option>
                      <option value="UNLOCK">UNLOCK</option>
                      <option value="AUTO_UNLOCK">AUTO_UNLOCK</option>
                      <option value="RESET_FAIL">RESET_FAIL</option>
                      <option value="SUCCESS">SUCCESS</option>
                    </select>
                    <button class="btn btn-outline ll-mini-btn" data-ll-act="clearLogs"><i class="fa-solid fa-trash"></i> 로그 비우기</button>
                  </div>
                </div>

                <div class="ll-scroll-x" style="margin-top:8px;">
                  <table class="ll-table">
                    <thead>
                      <tr>
                        <th>시간</th>
                        <th>계정</th>
                        <th>이벤트</th>
                        <th>IP</th>
                        <th>상세</th>
                      </tr>
                    </thead>
                    <tbody id="llLogsTbody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function downloadJson(filename, payload) {
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function readJsonFile(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          try { resolve(JSON.parse(String(fr.result || ""))); }
          catch (e) { reject(e); }
        };
        fr.onerror = reject;
        fr.readAsText(file);
      });
    }

    // ---------------- Render + Bind ----------------
    const pageState = {
      selectedAccountId: null,
      timerId: null,
    };

    function renderAll(mountEl) {
      const policy = safeLoad(KEY_POLICY, defaultPolicy());
      let users = Array.isArray(safeLoad(KEY_USERS, [])) ? safeLoad(KEY_USERS, []) : [];
      const logs = Array.isArray(safeLoad(KEY_LOGS, [])) ? safeLoad(KEY_LOGS, []) : [];

      // auto unlock reconcile
      const reconciled = normalizeAutoUnlock(policy, users);
      users = reconciled.users;
      if (reconciled.changed) safeSave(KEY_USERS, users);

      // policy badge
      const badgeEl = mountEl.querySelector("#llPolicyEnabledBadge");
      if (badgeEl) {
        badgeEl.innerHTML = policy.enabled
          ? `<span class="ll-badge ok"><i class="fa-solid fa-shield-halved"></i> ENABLED</span>`
          : `<span class="ll-badge off"><i class="fa-solid fa-circle-minus"></i> DISABLED</span>`;
      }

      // policy fields
      const setVal = (id, v) => { const el = mountEl.querySelector(id); if (el) el.value = String(v ?? ""); };
      setVal("#llEnabled", policy.enabled ? "true" : "false");
      setVal("#llMaxFails", policy.maxFails);
      setVal("#llLockMode", policy.lockMode);
      setVal("#llLockDurationMin", policy.lockDurationMin);
      setVal("#llResetOnSuccess", policy.resetOnSuccess ? "true" : "false");
      setVal("#llWindowMin", policy.windowMin);

      // sim user select
      const simSel = mountEl.querySelector("#llSimUser");
      if (simSel) {
        const current = pageState.selectedAccountId || (simSel.value || "");
        simSel.innerHTML = users
          .map(u => `<option value="${esc(u.accountId)}">${esc(u.accountId)} · ${esc(u.name)} (${esc(u.dept)})</option>`)
          .join("");
        const fallback = current && users.some(u => u.accountId === current) ? current : (users[0]?.accountId || "");
        simSel.value = fallback;
        pageState.selectedAccountId = simSel.value || fallback;
      }

      // sim status
      const simUser = users.find(u => u.accountId === pageState.selectedAccountId) || users[0];
      const simStatusEl = mountEl.querySelector("#llSimStatus");
      const simFailEl = mountEl.querySelector("#llSimFail");
      if (simUser && simStatusEl) simStatusEl.innerHTML = badgeHtml(simUser.status);
      if (simUser && simFailEl) simFailEl.textContent = `${Number(simUser.failCount || 0)} / ${Number(policy.maxFails || 0)}`;

      // user list render (filters)
      const q = String(mountEl.querySelector("#llUserSearch")?.value || "").trim().toLowerCase();
      const st = String(mountEl.querySelector("#llUserStatusFilter")?.value || "").trim();

      let filtered = users.slice();
      if (st) filtered = filtered.filter(u => String(u.status || "") === st);
      if (q) {
        filtered = filtered.filter(u => {
          const hay = `${u.accountId} ${u.name} ${u.dept} ${u.team} ${u.title}`.toLowerCase();
          return hay.includes(q);
        });
      }

      // summary
      const active = users.filter(u => u.status === "ACTIVE").length;
      const locked = users.filter(u => u.status === "LOCKED").length;
      const disabled = users.filter(u => u.status === "DISABLED").length;
      const sumEl = mountEl.querySelector("#llUserSummary");
      if (sumEl) {
        sumEl.textContent = `전체 ${users.length}명 · ACTIVE ${active} · LOCKED ${locked} · DISABLED ${disabled}`;
      }

      // tbody users
      const tbody = mountEl.querySelector("#llUsersTbody");
      if (tbody) {
        tbody.innerHTML = filtered.length
          ? filtered.map(u => {
              const exp = u.status === "LOCKED"
                ? (u.lockUntil ? fmtISO(u.lockUntil) : "— (수동 해제)")
                : "—";
              const lastFail = u.lastFailAt ? `${fmtISO(u.lastFailAt)} (${esc(u.lastFailIp || "-")})` : "—";
              const deptTeam = `${esc(u.dept || "-")}${u.team ? " / " + esc(u.team) : ""}`;
              const actions = `
                <div class="ll-actions">
                  ${u.status === "LOCKED"
                    ? `<button class="btn btn-outline ll-mini-btn" data-ll-user-act="unlock" data-ll-id="${esc(u.accountId)}"><i class="fa-solid fa-unlock"></i> 해제</button>`
                    : `<button class="btn btn-outline ll-mini-btn" data-ll-user-act="lock" data-ll-id="${esc(u.accountId)}"><i class="fa-solid fa-lock"></i> 잠금</button>`
                  }
                  <button class="btn btn-outline ll-mini-btn" data-ll-user-act="reset" data-ll-id="${esc(u.accountId)}"><i class="fa-solid fa-broom"></i> 실패 초기화</button>
                </div>
              `;
              return `
                <tr>
                  <td class="ll-mono">${esc(u.accountId)}</td>
                  <td>${esc(u.name)}</td>
                  <td class="ll-ellipsis" title="${esc(deptTeam)}">${deptTeam}</td>
                  <td>${badgeHtml(u.status)}</td>
                  <td class="ll-mono">${Number(u.failCount || 0)}</td>
                  <td class="ll-mono">${esc(exp)}</td>
                  <td class="ll-ellipsis" title="${esc(lastFail)}">${esc(lastFail)}</td>
                  <td>${actions}</td>
                </tr>
              `;
            }).join("")
          : `<tr><td colspan="8" style="padding:14px; color:var(--muted);">조건에 맞는 계정이 없습니다.</td></tr>`;
      }

      // logs render
      const logType = String(mountEl.querySelector("#llLogTypeFilter")?.value || "").trim();
      let filteredLogs = logs.slice();
      if (logType) filteredLogs = filteredLogs.filter(l => String(l.type || "") === logType);

      const logsTbody = mountEl.querySelector("#llLogsTbody");
      if (logsTbody) {
        logsTbody.innerHTML = filteredLogs.length
          ? filteredLogs.slice(0, 250).map(l => `
              <tr>
                <td class="ll-mono">${esc(fmtISO(l.at))}</td>
                <td class="ll-mono">${esc(l.accountId)}</td>
                <td class="ll-mono">${esc(l.type)}</td>
                <td class="ll-mono">${esc(l.ip || "-")}</td>
                <td class="ll-ellipsis" title="${esc(l.detail)}">${esc(l.detail)}</td>
              </tr>
            `).join("")
          : `<tr><td colspan="5" style="padding:14px; color:var(--muted);">이력이 없습니다.</td></tr>`;
      }
    }

    function bindEvents(mountEl) {
      // 상단 actions
      mountEl.querySelector('[data-ll-act="save"]')?.addEventListener("click", () => {
        const enabled = mountEl.querySelector("#llEnabled")?.value === "true";
        const maxFails = Math.max(1, Math.min(20, Number(mountEl.querySelector("#llMaxFails")?.value || 5)));
        const lockMode = String(mountEl.querySelector("#llLockMode")?.value || "TEMP");
        const lockDurationMin = Math.max(1, Math.min(1440, Number(mountEl.querySelector("#llLockDurationMin")?.value || 30)));
        const resetOnSuccess = mountEl.querySelector("#llResetOnSuccess")?.value === "true";
        const windowMin = Math.max(0, Math.min(240, Number(mountEl.querySelector("#llWindowMin")?.value || 0)));

        const policy = {
          enabled,
          maxFails,
          lockMode: (lockMode === "PERM" ? "PERM" : "TEMP"),
          lockDurationMin,
          resetOnSuccess,
          windowMin,
          note: "loginLock policy"
        };

        safeSave(KEY_POLICY, policy);
        pushLog("-", "POLICY", "-", `정책 저장: enabled=${enabled}, maxFails=${maxFails}, lockMode=${policy.lockMode}, lockDurationMin=${lockDurationMin}, windowMin=${windowMin}`);
        toast("정책이 저장되었습니다.");
        renderAll(mountEl);
      });

      mountEl.querySelector('[data-ll-act="reset"]')?.addEventListener("click", () => {
        const ok = confirm("정책/계정 상태/로그를 초기화할까요?");
        if (!ok) return;
        safeSave(KEY_POLICY, defaultPolicy());
        safeSave(KEY_USERS, []);
        safeSave(KEY_LOGS, []);
        ensureSeed();
        toast("초기화 완료");
        renderAll(mountEl);
      });

      mountEl.querySelector('[data-ll-act="export"]')?.addEventListener("click", () => {
        const payload = {
          exportedAt: nowISO(),
          policy: safeLoad(KEY_POLICY, defaultPolicy()),
          users: safeLoad(KEY_USERS, []),
          logs: safeLoad(KEY_LOGS, [])
        };
        downloadJson(`dbam_login_lock_export_${Date.now()}.json`, payload);
      });

      const importFile = mountEl.querySelector("#llImportFile");
      if (importFile) {
        importFile.addEventListener("change", async () => {
          const f = importFile.files?.[0];
          if (!f) return;
          try {
            const json = await readJsonFile(f);
            if (json && typeof json === "object") {
              if (json.policy) safeSave(KEY_POLICY, json.policy);
              if (Array.isArray(json.users)) safeSave(KEY_USERS, json.users);
              if (Array.isArray(json.logs)) safeSave(KEY_LOGS, json.logs);
              toast("가져오기 완료");
              renderAll(mountEl);
            } else {
              toast("가져오기 실패: 형식이 올바르지 않습니다.");
            }
          } catch (e) {
            console.warn(e);
            toast("가져오기 실패: 파일을 확인하세요.");
          } finally {
            importFile.value = "";
          }
        });
      }

      mountEl.querySelector('[data-ll-act="clearLogs"]')?.addEventListener("click", () => {
        const ok = confirm("로그를 모두 비울까요?");
        if (!ok) return;
        safeSave(KEY_LOGS, []);
        toast("로그를 비웠습니다.");
        renderAll(mountEl);
      });

      // filters re-render
      mountEl.querySelector("#llUserSearch")?.addEventListener("input", () => renderAll(mountEl));
      mountEl.querySelector("#llUserStatusFilter")?.addEventListener("change", () => renderAll(mountEl));
      mountEl.querySelector("#llLogTypeFilter")?.addEventListener("change", () => renderAll(mountEl));

      // sim selected change
      mountEl.querySelector("#llSimUser")?.addEventListener("change", () => {
        pageState.selectedAccountId = mountEl.querySelector("#llSimUser")?.value || null;
        renderAll(mountEl);
      });

      // sim actions
      mountEl.querySelectorAll("[data-ll-sim]")?.forEach(btn => {
        btn.addEventListener("click", () => {
          const policy = safeLoad(KEY_POLICY, defaultPolicy());
          const users = Array.isArray(safeLoad(KEY_USERS, [])) ? safeLoad(KEY_USERS, []) : [];
          const accountId = mountEl.querySelector("#llSimUser")?.value || "";
          const ip = String(mountEl.querySelector("#llSimIp")?.value || "").trim() || "-";
          const reason = String(mountEl.querySelector("#llSimReason")?.value || "").trim();

          const user = users.find(u => u.accountId === accountId);
          if (!user) return;

          const act = btn.getAttribute("data-ll-sim");
          if (act === "fail") {
            recordFail(policy, user, ip, reason || "로그인 실패");
          } else if (act === "success") {
            recordSuccess(policy, user, ip);
          } else if (act === "reset") {
            resetFails(user, ip, reason || "관리자 조치");
          } else if (act === "lock") {
            if (user.status !== "LOCKED") lockUser(policy, user, reason || "관리자 강제 잠금", ip);
          } else if (act === "unlock") {
            if (user.status === "LOCKED") unlockUser(user, ip, reason || "관리자 강제 해제");
          }

          safeSave(KEY_USERS, users);
          renderAll(mountEl);
        });
      });

      // user table actions (event delegation)
      mountEl.addEventListener("click", (e) => {
        const btn = e.target.closest?.("[data-ll-user-act]");
        if (!btn) return;

        const act = btn.getAttribute("data-ll-user-act");
        const id = btn.getAttribute("data-ll-id");
        if (!id) return;

        const policy = safeLoad(KEY_POLICY, defaultPolicy());
        const users = Array.isArray(safeLoad(KEY_USERS, [])) ? safeLoad(KEY_USERS, []) : [];
        const user = users.find(u => u.accountId === id);
        if (!user) return;

        const ip = "-";
        if (act === "unlock") {
          const reason = prompt("해제 사유를 입력하세요.", "관리자 해제") || "관리자 해제";
          unlockUser(user, ip, reason);
        } else if (act === "lock") {
          const reason = prompt("잠금 사유를 입력하세요.", "관리자 잠금") || "관리자 잠금";
          lockUser(policy, user, reason, ip);
        } else if (act === "reset") {
          const reason = prompt("초기화 사유를 입력하세요.", "실패 카운트 초기화") || "실패 카운트 초기화";
          resetFails(user, ip, reason);
        }

        safeSave(KEY_USERS, users);
        renderAll(mountEl);
      }, true);
    }

    function renderDbamLoginLockPage(mountEl) {
      if (!mountEl) return;
      ensureStyle();
      ensureSeed();

      mountEl.innerHTML = templateHtml();
      bindEvents(mountEl);
      renderAll(mountEl);

      // 5초마다 잠금 만료 체크(페이지 열려있는 동안만)
      try {
        if (pageState.timerId) clearInterval(pageState.timerId);
        pageState.timerId = setInterval(() => {
          try { renderAll(mountEl); } catch (_) {}
        }, 5000);
      } catch (_) {}
    }

    W.DBAM.renderDbamLoginLockPage = renderDbamLoginLockPage;

    // ---------------- Admin open + card click (authPolicy) ----------------
    const loginLockAdmin = {
      open() {
        const titleEl = document.getElementById("adminTitle");
        const descEl  = document.getElementById("adminDesc");
        const bodyEl  = document.getElementById("adminBody");
        if (!titleEl || !descEl || !bodyEl) return;

        try {
          W.admin.current = "authPolicy";
          document.querySelectorAll(".admin-nav button").forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.section === "authPolicy");
          });
        } catch (_) {}

        titleEl.innerHTML = '<i class="fa-solid fa-lock"></i> 로그인 실패 횟수·계정 잠금';
        descEl.textContent = "로그인 실패 허용 횟수, 자동 잠금/해제 기준 및 잠금 이력을 관리합니다.";

        W.DBAM.renderDbamLoginLockPage(bodyEl);
      }
    };
    W.loginLockAdmin = loginLockAdmin;

    // 카드 클릭 -> open (authPolicy에서만)
    document.addEventListener("click", (e) => {
      const card = e.target.closest?.("#adminBody .admin-card.admin-card-clickable");
      if (!card) return;
      if (!W.admin || W.admin.current !== "authPolicy") return;

      const h4 = card.querySelector("h4");
      const title = (h4?.textContent || "").trim();
      if (!title.includes("로그인 실패 횟수·계정 잠금")) return;

      e.preventDefault();
      e.stopPropagation();
      loginLockAdmin.open();
    }, true);

  })(); // end loginLock

  /* =========================
   * DBAM - 비밀번호 정책 관리 (passwordPolicy)
   * Entry: window.DBAM.renderDbamPasswordPolicyPage(mountEl)
   * ========================= */
  (function () {
    const W = window;
    W.DBAM = W.DBAM || {};
    if (W.DBAM.__passwordPolicyInstalled) return;
    W.DBAM.__passwordPolicyInstalled = true;

    const KEY_POLICY = "dbam_auth_password_policy";
    const KEY_USERS  = "dbam_auth_password_users";
    const KEY_LOGS   = "dbam_auth_password_logs";

    // (선택) 로그인잠금 모듈에서 저장한 계정 목록이 있으면 가져와서 씀
    const KEY_LOGINLOCK_USERS = "dbam_auth_login_lock_users";

    // ---------- utils ----------
    function toast(msg) { (typeof dbamToast === "function") ? dbamToast(msg) : alert(msg); }
    function esc(s) { return (typeof dbamEscHtml === "function") ? dbamEscHtml(s) : String(s ?? ""); }
    function safeLoad(key, fallback) {
      try { return (typeof dbamLoad === "function") ? dbamLoad(key, fallback) : fallback; }
      catch (_) { return fallback; }
    }
    function safeSave(key, value) {
      try { if (typeof dbamSave === "function") dbamSave(key, value); }
      catch (_) {}
    }
    function uid(prefix) { return (typeof dbamUid === "function") ? dbamUid(prefix) : `${prefix}_${Date.now()}`; }
    function nowISO() { return new Date().toISOString(); }
    function fmtISO(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return String(iso);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      const ss = String(d.getSeconds()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    }
    function clamp(n, a, b) { n = Number(n); if (Number.isNaN(n)) return a; return Math.min(b, Math.max(a, n)); }

    // 보안 목적 해시 아님(프론트 단독 저장용 간단 해시)
    function fnv1a(str) {
      let h = 0x811c9dc5;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0;
      }
      return ("00000000" + h.toString(16)).slice(-8);
    }
    function pwHash(userId, pw) {
      const salt = `DBAM|PW|${String(userId || "").toUpperCase()}`;
      return `h_${fnv1a(salt + "|" + String(pw || ""))}`;
    }

    function ensureStyle() {
      if (document.getElementById("dbamPasswordPolicyStyle")) return;
      const st = document.createElement("style");
      st.id = "dbamPasswordPolicyStyle";
      st.textContent = `
        .pp-grid{display:grid; grid-template-columns:360px minmax(0,1fr); gap:12px; align-items:start;}
        .pp-kv{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px;}
        .pp-kv .label{font-size:11px; color:var(--muted); margin-bottom:4px;}
        .pp-row{border:1px solid var(--line); border-radius:12px; padding:10px 12px;}
        .pp-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
        .pp-badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid var(--line);}
        .pp-badge.ok{background:rgba(0,160,90,.10); border-color:rgba(0,160,90,.18); color:#0a7a4a;}
        .pp-badge.warn{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.22); color:#a16207;}
        .pp-badge.bad{background:rgba(255,0,0,.08); border-color:rgba(255,0,0,.18); color:#b30000;}
        .pp-table{width:100%; border-collapse:collapse; font-size:12px;}
        .pp-table th,.pp-table td{padding:10px; border-bottom:1px solid var(--line); vertical-align:top;}
        .pp-table th{background:var(--panel,#f8fafc); text-align:left; white-space:nowrap;}
        .pp-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;}
        .pp-ellipsis{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:260px;}
        .pp-scroll-x{overflow-x:auto; -webkit-overflow-scrolling:touch;}
        .pp-mini-btn{padding:4px 8px; font-size:11px; line-height:1.1;}
        .pp-checklist{margin:8px 0 0; padding-left:18px; color:#334155;}
        .pp-checklist li{margin:3px 0;}
        .pp-checklist li.ok{color:#0a7a4a;}
        .pp-checklist li.bad{color:#b30000;}
      `;
      document.head.appendChild(st);
    }

    // ---------- defaults / seed ----------
    function defaultPolicy() {
      return {
        enabled: true,

        minLength: 10,
        maxLength: 64,

        requireUpper: true,
        requireLower: true,
        requireNumber: true,
        requireSpecial: true,

        // 특수문자 허용(입력된 특수문자는 이 집합에 포함되어야 함)
        allowedSpecial: "!@#$%^&*()-_=+[]{};:,.?/`~|\\",

        noWhitespace: true,
        disallowAccountId: true,
        disallowName: true,

        disallowSequence: true,      // 4자리 이상 연속(1234/abcd 등)
        disallowRepeat: true,        // 동일문자 3회 이상 반복(aaa/111 등)

        expiryDays: 90,              // 0이면 미사용
        minAgeDays: 1,               // 0이면 미사용(너무 잦은 변경 방지)
        historyCount: 5,             // 최근 N개 재사용 금지

        note: "기본 비밀번호 정책"
      };
    }

    function seedUsersIfEmpty(policy) {
      const existing = safeLoad(KEY_USERS, null);
      if (Array.isArray(existing) && existing.length) return existing;

      // 1) 로그인잠금 모듈 계정이 있으면 우선 사용
      const llUsers = safeLoad(KEY_LOGINLOCK_USERS, null);
      let base = Array.isArray(llUsers) && llUsers.length
        ? llUsers.map(u => ({
            accountId: u.accountId,
            name: u.name || "-",
            dept: u.dept || "-",
            team: u.team || "-",
            title: u.title || "-",
            status: u.status || "ACTIVE"
          }))
        : [];

      // 2) 없으면 샘플
      if (!base.length) {
        const sample = Array.isArray(W.DBAM_USER_SAMPLE) ? W.DBAM_USER_SAMPLE : [];
        base = sample.length ? sample.map(u => ({
          accountId: String(u.id || u.accountId || ""),
          name: u.name || "-",
          dept: u.dept || "-",
          team: u.team || "-",
          title: u.title || "-",
          status: u.status || "ACTIVE"
        })) : [
          { accountId:"u1001", name:"홍길동", dept:"정보보안실", team:"DB보안팀", title:"대리", status:"ACTIVE" },
          { accountId:"u1002", name:"김감사", dept:"정보보안실", team:"감사팀",   title:"과장", status:"ACTIVE" },
          { accountId:"u1003", name:"박개발", dept:"플랫폼개발부", team:"API팀",  title:"사원", status:"ACTIVE" },
        ];
      }

      const now = Date.now();
      const lastChangedAt = new Date(now - 25 * 24 * 60 * 60 * 1000).toISOString();
      const expiresAt = (policy.expiryDays > 0)
        ? new Date(new Date(lastChangedAt).getTime() + policy.expiryDays * 24 * 60 * 60 * 1000).toISOString()
        : null;

      const users = base.map(u => {
        const initPw = `P@ssw0rd!_${u.accountId}`; // 초기값(표시 안함)
        const h = pwHash(u.accountId, initPw);
        return {
          accountId: u.accountId,
          name: u.name,
          dept: u.dept,
          team: u.team,
          title: u.title,
          status: u.status || "ACTIVE",

          pwHash: h,
          pwHistory: [h],
          lastChangedAt,
          expiresAt,
          mustChange: false,
          lastPolicyCheckAt: null
        };
      });

      safeSave(KEY_USERS, users);
      return users;
    }

    function seedLogsIfEmpty() {
      const existing = safeLoad(KEY_LOGS, null);
      if (Array.isArray(existing) && existing.length) return existing;

      const seed = [
        { id: uid("pwlog"), at: nowISO(), accountId: "u1001", type: "POLICY", ip: "-", detail: "비밀번호 정책 초기 생성" },
        { id: uid("pwlog"), at: nowISO(), accountId: "u1002", type: "CHANGE", ip: "10.10.2.22", detail: "비밀번호 변경(샘플)" },
      ];
      safeSave(KEY_LOGS, seed);
      return seed;
    }

    function ensureSeed() {
      const p = safeLoad(KEY_POLICY, null);
      if (!p) safeSave(KEY_POLICY, defaultPolicy());
      const policy = safeLoad(KEY_POLICY, defaultPolicy());
      const users = seedUsersIfEmpty(policy);
      const logs = seedLogsIfEmpty();
      return { policy, users, logs };
    }

    // ---------- logs ----------
    function pushLog(accountId, type, ip, detail) {
      const logs = Array.isArray(safeLoad(KEY_LOGS, [])) ? safeLoad(KEY_LOGS, []) : [];
      logs.unshift({
        id: uid("pwlog"),
        at: nowISO(),
        accountId: String(accountId || "-"),
        type: String(type || ""),
        ip: String(ip || "-"),
        detail: String(detail || "")
      });
      if (logs.length > 800) logs.length = 800;
      safeSave(KEY_LOGS, logs);
      return logs;
    }

    // ---------- validation ----------
    function hasSequence(pw, seqLen = 4) {
      const s = String(pw || "");
      if (s.length < seqLen) return false;

      // 연속 증가/감소(영문/숫자) 단순 체크
      for (let i = 0; i <= s.length - seqLen; i++) {
        let inc = true, dec = true;
        for (let j = 1; j < seqLen; j++) {
          const a = s.charCodeAt(i + j - 1);
          const b = s.charCodeAt(i + j);
          if (b !== a + 1) inc = false;
          if (b !== a - 1) dec = false;
        }
        if (inc || dec) return true;
      }
      return false;
    }

    function hasRepeat(pw, rep = 3) {
      const s = String(pw || "");
      if (s.length < rep) return false;
      let run = 1;
      for (let i = 1; i < s.length; i++) {
        if (s[i] === s[i - 1]) {
          run++;
          if (run >= rep) return true;
        } else {
          run = 1;
        }
      }
      return false;
    }

    function evaluatePassword(policy, user, newPw, opts) {
      const pw = String(newPw || "");
      const issues = [];
      const okPush = (cond, msg) => { if (!cond) issues.push(msg); };

      const enabled = !!policy.enabled;
      if (!enabled) return { ok: true, issues: [], checks: buildChecks(policy, user, pw, true) };

      const minL = clamp(policy.minLength, 6, 128);
      const maxL = clamp(policy.maxLength, minL, 256);

      okPush(pw.length >= minL, `길이: 최소 ${minL}자`);
      okPush(pw.length <= maxL, `길이: 최대 ${maxL}자`);

      if (policy.noWhitespace) okPush(!/\s/.test(pw), "공백 포함 금지");

      if (policy.requireUpper) okPush(/[A-Z]/.test(pw), "영문 대문자 포함");
      if (policy.requireLower) okPush(/[a-z]/.test(pw), "영문 소문자 포함");
      if (policy.requireNumber) okPush(/[0-9]/.test(pw), "숫자 포함");
      if (policy.requireSpecial) okPush(/[^A-Za-z0-9]/.test(pw), "특수문자 포함");

      const allowed = String(policy.allowedSpecial || "");
      if (allowed) {
        // 특수문자가 있다면 allowedSpecial 집합 내인지 확인
        const specials = pw.replace(/[A-Za-z0-9]/g, "");
        const allAllowed = [...specials].every(ch => allowed.includes(ch));
        okPush(allAllowed, "허용된 특수문자 집합 내 사용");
      }

      if (policy.disallowAccountId && user?.accountId) {
        const id = String(user.accountId).toLowerCase();
        okPush(!pw.toLowerCase().includes(id), "계정 ID 포함 금지");
      }
      if (policy.disallowName && user?.name) {
        const nm = String(user.name).replace(/\s+/g, "").toLowerCase();
        if (nm.length >= 2) okPush(!pw.toLowerCase().includes(nm), "사용자명 포함 금지");
      }

      if (policy.disallowSequence) okPush(!hasSequence(pw, 4), "연속 패턴(1234/abcd 등) 금지");
      if (policy.disallowRepeat) okPush(!hasRepeat(pw, 3), "반복 패턴(aaa/111 등) 금지");

      // 히스토리 재사용 금지
      const hCount = clamp(policy.historyCount, 0, 24);
      if (hCount > 0 && user) {
        const h = pwHash(user.accountId, pw);
        const hist = Array.isArray(user.pwHistory) ? user.pwHistory : [];
        const recent = hist.slice(0, hCount);
        okPush(!recent.includes(h), `최근 ${hCount}회 비밀번호 재사용 금지`);
      }

      // 최소 변경 간격
      const minAge = clamp(policy.minAgeDays, 0, 365);
      const force = !!opts?.force;
      if (!force && minAge > 0 && user?.lastChangedAt) {
        const last = new Date(user.lastChangedAt).getTime();
        const now = Date.now();
        const diffDays = (now - last) / (24 * 60 * 60 * 1000);
        okPush(diffDays >= minAge, `변경 간격: 최소 ${minAge}일`);
      }

      const ok = issues.length === 0;
      return { ok, issues, checks: buildChecks(policy, user, pw, ok, opts) };
    }

    function buildChecks(policy, user, pw, finalOk, opts) {
      const enabled = !!policy.enabled;
      const minL = clamp(policy.minLength, 6, 128);
      const maxL = clamp(policy.maxLength, minL, 256);
      const allowed = String(policy.allowedSpecial || "");
      const specials = String(pw || "").replace(/[A-Za-z0-9]/g, "");
      const force = !!opts?.force;

      const checks = [];
      const add = (ok, label) => checks.push({ ok: !!ok, label });

      add(!enabled || (pw.length >= minL), `길이 ≥ ${minL}`);
      add(!enabled || (pw.length <= maxL), `길이 ≤ ${maxL}`);
      add(!enabled || !policy.noWhitespace || !/\s/.test(pw), "공백 없음");
      add(!enabled || !policy.requireUpper || /[A-Z]/.test(pw), "대문자");
      add(!enabled || !policy.requireLower || /[a-z]/.test(pw), "소문자");
      add(!enabled || !policy.requireNumber || /[0-9]/.test(pw), "숫자");
      add(!enabled || !policy.requireSpecial || /[^A-Za-z0-9]/.test(pw), "특수문자");
      add(!enabled || !allowed || [...specials].every(ch => allowed.includes(ch)), "허용 특수문자 집합");
      add(!enabled || !policy.disallowAccountId || !user?.accountId || !String(pw).toLowerCase().includes(String(user.accountId).toLowerCase()), "ID 미포함");
      add(!enabled || !policy.disallowName || !user?.name || !String(pw).toLowerCase().includes(String(user.name).replace(/\s+/g,"").toLowerCase()), "이름 미포함");
      add(!enabled || !policy.disallowSequence || !hasSequence(pw, 4), "연속패턴 없음");
      add(!enabled || !policy.disallowRepeat || !hasRepeat(pw, 3), "반복패턴 없음");

      const hCount = clamp(policy.historyCount, 0, 24);
      if (hCount > 0 && enabled && user) {
        const h = pwHash(user.accountId, pw);
        const hist = Array.isArray(user.pwHistory) ? user.pwHistory : [];
        add(!hist.slice(0, hCount).includes(h), `히스토리(${hCount}) 미재사용`);
      } else {
        add(true, `히스토리(${hCount})`);
      }

      const minAge = clamp(policy.minAgeDays, 0, 365);
      if (enabled && minAge > 0 && user?.lastChangedAt && !force) {
        const last = new Date(user.lastChangedAt).getTime();
        const diffDays = (Date.now() - last) / (24 * 60 * 60 * 1000);
        add(diffDays >= minAge, `변경 간격(${minAge}일)`);
      } else {
        add(true, `변경 간격(${minAge}일)`);
      }

      add(!!finalOk, "최종 통과");
      return checks;
    }

    function computeExpiresAt(policy, changedAtISO) {
      const days = clamp(policy.expiryDays, 0, 3650);
      if (!days) return null;
      const t = new Date(changedAtISO).getTime();
      if (Number.isNaN(t)) return null;
      return new Date(t + days * 24 * 60 * 60 * 1000).toISOString();
    }

    function isExpired(policy, u) {
      const enabled = !!policy.enabled;
      const days = clamp(policy.expiryDays, 0, 3650);
      if (!enabled || !days) return false;
      if (!u.expiresAt) return false;
      const t = new Date(u.expiresAt).getTime();
      if (Number.isNaN(t)) return false;
      return Date.now() > t;
    }

    // ---------- UI ----------
    function templateHtml() {
      return `
        <div id="passwordPolicyPage" class="emg-page" style="width:100%; max-width:100%; overflow-x:hidden;">
          <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-primary" data-pp-act="save"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
              <button class="btn btn-outline" data-pp-act="reset"><i class="fa-solid fa-rotate"></i> 초기화</button>
              <button class="btn btn-outline" data-pp-act="export"><i class="fa-solid fa-file-export"></i> 내보내기</button>
              <label class="btn btn-outline" style="cursor:pointer; margin:0;">
                <i class="fa-solid fa-file-import"></i> 가져오기
                <input type="file" id="ppImportFile" accept="application/json" style="display:none;" />
              </label>
            </div>
            <div class="admin-footer">비밀번호 복잡도/주기/재사용 금지 규칙을 설정하고, 계정별 만료/변경 요구 상태 및 변경 이력을 조회합니다.</div>
          </div>

          <div class="pp-grid">
            <div style="display:flex; flex-direction:column; gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                  <div style="font-weight:700;"><i class="fa-solid fa-sliders"></i> 정책 설정</div>
                  <div id="ppPolicyEnabledBadge"></div>
                </div>

                <div class="pp-kv" style="margin-top:10px;">
                  <div>
                    <div class="label">정책 사용</div>
                    <select id="ppEnabled" class="export-input">
                      <option value="true">ENABLED</option>
                      <option value="false">DISABLED</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">만료(일)</div>
                    <input id="ppExpiryDays" type="number" min="0" max="3650" class="export-input" placeholder="0=미사용" />
                  </div>

                  <div>
                    <div class="label">최소 길이</div>
                    <input id="ppMinLength" type="number" min="6" max="128" class="export-input" />
                  </div>
                  <div>
                    <div class="label">최대 길이</div>
                    <input id="ppMaxLength" type="number" min="6" max="256" class="export-input" />
                  </div>

                  <div>
                    <div class="label">재사용 금지(최근 N회)</div>
                    <input id="ppHistoryCount" type="number" min="0" max="24" class="export-input" placeholder="예: 5" />
                  </div>
                  <div>
                    <div class="label">최소 변경 간격(일)</div>
                    <input id="ppMinAgeDays" type="number" min="0" max="365" class="export-input" placeholder="예: 1" />
                  </div>

                  <div style="grid-column:1 / -1;">
                    <div class="label">허용 특수문자 집합</div>
                    <input id="ppAllowedSpecial" class="export-input pp-mono" placeholder="예: !@#$%^&*..." />
                  </div>

                  <div>
                    <div class="label">대문자 필수</div>
                    <select id="ppRequireUpper" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">소문자 필수</div>
                    <select id="ppRequireLower" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">숫자 필수</div>
                    <select id="ppRequireNumber" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">특수문자 필수</div>
                    <select id="ppRequireSpecial" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>

                  <div>
                    <div class="label">공백 금지</div>
                    <select id="ppNoWhitespace" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">ID 포함 금지</div>
                    <select id="ppDisallowAccountId" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">이름 포함 금지</div>
                    <select id="ppDisallowName" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">연속 패턴 금지</div>
                    <select id="ppDisallowSequence" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">반복 패턴 금지</div>
                    <select id="ppDisallowRepeat" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>
                </div>

                <div class="admin-footer" style="margin-top:10px;">
                  만료(일)=0이면 만료 정책을 적용하지 않습니다. 허용 특수문자 집합은 “입력된 특수문자”가 해당 집합에 포함되는지 검사합니다.
                </div>
              </div>

              <div class="admin-card" style="padding:12px 14px;">
                <div style="font-weight:700;"><i class="fa-solid fa-vial"></i> 적용 테스트 / 변경 시뮬레이션</div>

                <div class="pp-kv" style="margin-top:10px;">
                  <div style="grid-column:1 / -1;">
                    <div class="label">대상 계정</div>
                    <select id="ppSimUser" class="export-input"></select>
                  </div>
                  <div style="grid-column:1 / -1;">
                    <div class="label">새 비밀번호</div>
                    <input id="ppNewPw" type="password" class="export-input pp-mono" placeholder="규칙에 맞는 비밀번호 입력" />
                  </div>
                  <div style="grid-column:1 / -1;">
                    <div class="label">확인</div>
                    <input id="ppNewPw2" type="password" class="export-input pp-mono" placeholder="동일하게 한번 더 입력" />
                  </div>
                  <div>
                    <div class="label">IP</div>
                    <input id="ppSimIp" class="export-input pp-mono" placeholder="예: 10.0.0.1" />
                  </div>
                  <div>
                    <div class="label">관리자 강제(변경 간격 무시)</div>
                    <select id="ppForce" class="export-input">
                      <option value="false">OFF</option>
                      <option value="true">ON</option>
                    </select>
                  </div>
                </div>

                <div class="pp-actions" style="margin-top:10px;">
                  <button class="btn btn-outline pp-mini-btn" data-pp-sim="check"><i class="fa-solid fa-list-check"></i> 규칙 검사</button>
                  <button class="btn btn-outline pp-mini-btn" data-pp-sim="apply"><i class="fa-solid fa-key"></i> 변경 적용</button>
                  <button class="btn btn-outline pp-mini-btn" data-pp-sim="requireChange"><i class="fa-solid fa-triangle-exclamation"></i> 변경 요구</button>
                  <button class="btn btn-outline pp-mini-btn" data-pp-sim="clearRequire"><i class="fa-solid fa-circle-check"></i> 요구 해제</button>
                </div>

                <div class="pp-row" style="margin-top:10px;">
                  <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                    <div style="font-size:12px;">
                      <div style="color:var(--muted); font-size:11px;">검사 결과</div>
                      <div id="ppSimResult" style="margin-top:4px;"></div>
                    </div>
                    <div style="font-size:12px;">
                      <div style="color:var(--muted); font-size:11px;">만료/상태</div>
                      <div id="ppSimState" style="margin-top:4px;"></div>
                    </div>
                  </div>
                  <ul id="ppChecklist" class="pp-checklist"></ul>
                </div>
              </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                  <div style="font-weight:700;"><i class="fa-solid fa-users"></i> 계정별 비밀번호 상태</div>
                  <div class="pp-actions">
                    <input id="ppUserSearch" class="export-input" style="width:220px;" placeholder="검색: 계정/이름/부서" />
                    <select id="ppPwStateFilter" class="export-input" style="width:170px;">
                      <option value="">전체</option>
                      <option value="OK">OK</option>
                      <option value="EXPIRED">EXPIRED</option>
                      <option value="REQUIRED">REQUIRED</option>
                    </select>
                  </div>
                </div>

                <div id="ppUserSummary" class="admin-footer" style="margin-top:8px;"></div>

                <div class="pp-scroll-x" style="margin-top:8px;">
                  <table class="pp-table">
                    <thead>
                      <tr>
                        <th>계정</th>
                        <th>이름</th>
                        <th>부서/팀</th>
                        <th>마지막 변경</th>
                        <th>만료</th>
                        <th>요구</th>
                        <th>히스토리</th>
                        <th>조치</th>
                      </tr>
                    </thead>
                    <tbody id="ppUsersTbody"></tbody>
                  </table>
                </div>
              </div>

              <div class="admin-card" style="padding:12px 14px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                  <div style="font-weight:700;"><i class="fa-solid fa-clock-rotate-left"></i> 비밀번호/정책 이력</div>
                  <div class="pp-actions">
                    <select id="ppLogTypeFilter" class="export-input" style="width:180px;">
                      <option value="">전체</option>
                      <option value="POLICY">POLICY</option>
                      <option value="CHANGE">CHANGE</option>
                      <option value="REQUIRE">REQUIRE</option>
                      <option value="CLEAR_REQUIRE">CLEAR_REQUIRE</option>
                      <option value="EXPIRE">EXPIRE</option>
                    </select>
                    <button class="btn btn-outline pp-mini-btn" data-pp-act="clearLogs"><i class="fa-solid fa-trash"></i> 로그 비우기</button>
                  </div>
                </div>

                <div class="pp-scroll-x" style="margin-top:8px;">
                  <table class="pp-table">
                    <thead>
                      <tr>
                        <th>시간</th>
                        <th>계정</th>
                        <th>이벤트</th>
                        <th>IP</th>
                        <th>상세</th>
                      </tr>
                    </thead>
                    <tbody id="ppLogsTbody"></tbody>
                  </table>
                </div>
              </div>

            </div>
          </div>
        </div>
      `;
    }

    function badgeEnabled(policy) {
      return policy.enabled
        ? `<span class="pp-badge ok"><i class="fa-solid fa-shield-halved"></i> ENABLED</span>`
        : `<span class="pp-badge warn"><i class="fa-solid fa-circle-minus"></i> DISABLED</span>`;
    }

    function badgePwState(policy, u) {
      const expired = isExpired(policy, u);
      if (expired) return `<span class="pp-badge bad"><i class="fa-solid fa-hourglass-end"></i> EXPIRED</span>`;
      if (u.mustChange) return `<span class="pp-badge warn"><i class="fa-solid fa-triangle-exclamation"></i> REQUIRED</span>`;
      return `<span class="pp-badge ok"><i class="fa-solid fa-circle-check"></i> OK</span>`;
    }

    // ---------- render ----------
    const pageState = { selectedAccountId: null };

    function renderAll(mountEl) {
      const policy = safeLoad(KEY_POLICY, defaultPolicy());
      let users = Array.isArray(safeLoad(KEY_USERS, [])) ? safeLoad(KEY_USERS, []) : [];
      const logs = Array.isArray(safeLoad(KEY_LOGS, [])) ? safeLoad(KEY_LOGS, []) : [];

      // policy badge + fields
      const badgeEl = mountEl.querySelector("#ppPolicyEnabledBadge");
      if (badgeEl) badgeEl.innerHTML = badgeEnabled(policy);

      const setVal = (id, v) => { const el = mountEl.querySelector(id); if (el) el.value = String(v ?? ""); };
      setVal("#ppEnabled", policy.enabled ? "true" : "false");
      setVal("#ppExpiryDays", policy.expiryDays);
      setVal("#ppMinLength", policy.minLength);
      setVal("#ppMaxLength", policy.maxLength);
      setVal("#ppHistoryCount", policy.historyCount);
      setVal("#ppMinAgeDays", policy.minAgeDays);
      setVal("#ppAllowedSpecial", policy.allowedSpecial);

      setVal("#ppRequireUpper", policy.requireUpper ? "true" : "false");
      setVal("#ppRequireLower", policy.requireLower ? "true" : "false");
      setVal("#ppRequireNumber", policy.requireNumber ? "true" : "false");
      setVal("#ppRequireSpecial", policy.requireSpecial ? "true" : "false");

      setVal("#ppNoWhitespace", policy.noWhitespace ? "true" : "false");
      setVal("#ppDisallowAccountId", policy.disallowAccountId ? "true" : "false");
      setVal("#ppDisallowName", policy.disallowName ? "true" : "false");
      setVal("#ppDisallowSequence", policy.disallowSequence ? "true" : "false");
      setVal("#ppDisallowRepeat", policy.disallowRepeat ? "true" : "false");

      // sim user select
      const sel = mountEl.querySelector("#ppSimUser");
      if (sel) {
        const current = pageState.selectedAccountId || sel.value || "";
        sel.innerHTML = users.map(u => {
          const txt = `${u.accountId} · ${u.name} (${u.dept})`;
          return `<option value="${esc(u.accountId)}">${esc(txt)}</option>`;
        }).join("");
        const chosen = (current && users.some(u => u.accountId === current)) ? current : (users[0]?.accountId || "");
        sel.value = chosen;
        pageState.selectedAccountId = chosen;
      }

      // sim state info
      const u0 = users.find(u => u.accountId === pageState.selectedAccountId) || users[0];
      const stateEl = mountEl.querySelector("#ppSimState");
      if (u0 && stateEl) {
        const exp = u0.expiresAt ? fmtISO(u0.expiresAt) : "—";
        stateEl.innerHTML = `${badgePwState(policy, u0)} <span class="pp-mono" style="margin-left:8px; color:var(--muted);">만료: ${esc(exp)}</span>`;
      }

      // user list filter
      const q = String(mountEl.querySelector("#ppUserSearch")?.value || "").trim().toLowerCase();
      const st = String(mountEl.querySelector("#ppPwStateFilter")?.value || "").trim();

      let filtered = users.slice();
      if (q) {
        filtered = filtered.filter(u => {
          const hay = `${u.accountId} ${u.name} ${u.dept} ${u.team} ${u.title}`.toLowerCase();
          return hay.includes(q);
        });
      }
      if (st) {
        filtered = filtered.filter(u => {
          const expired = isExpired(policy, u);
          const required = !!u.mustChange;
          if (st === "EXPIRED") return expired;
          if (st === "REQUIRED") return (!expired && required);
          if (st === "OK") return (!expired && !required);
          return true;
        });
      }

      // summary
      const okCnt = users.filter(u => !isExpired(policy, u) && !u.mustChange).length;
      const expCnt = users.filter(u => isExpired(policy, u)).length;
      const reqCnt = users.filter(u => !isExpired(policy, u) && u.mustChange).length;
      const sumEl = mountEl.querySelector("#ppUserSummary");
      if (sumEl) sumEl.textContent = `전체 ${users.length}명 · OK ${okCnt} · EXPIRED ${expCnt} · REQUIRED ${reqCnt}`;

      // tbody users
      const tbody = mountEl.querySelector("#ppUsersTbody");
      if (tbody) {
        tbody.innerHTML = filtered.length ? filtered.map(u => {
          const deptTeam = `${esc(u.dept || "-")}${u.team ? " / " + esc(u.team) : ""}`;
          const lastCh = u.lastChangedAt ? fmtISO(u.lastChangedAt) : "—";
          const exp = u.expiresAt ? fmtISO(u.expiresAt) : "—";
          const must = u.mustChange ? "YES" : "NO";
          const hist = Array.isArray(u.pwHistory) ? u.pwHistory.length : 0;

          const actions = `
            <div class="pp-actions">
              <button class="btn btn-outline pp-mini-btn" data-pp-user-act="select" data-pp-id="${esc(u.accountId)}"><i class="fa-solid fa-bullseye"></i> 선택</button>
              <button class="btn btn-outline pp-mini-btn" data-pp-user-act="expire" data-pp-id="${esc(u.accountId)}"><i class="fa-solid fa-hourglass-end"></i> 만료</button>
              ${u.mustChange
                ? `<button class="btn btn-outline pp-mini-btn" data-pp-user-act="clearRequire" data-pp-id="${esc(u.accountId)}"><i class="fa-solid fa-circle-check"></i> 요구 해제</button>`
                : `<button class="btn btn-outline pp-mini-btn" data-pp-user-act="requireChange" data-pp-id="${esc(u.accountId)}"><i class="fa-solid fa-triangle-exclamation"></i> 요구</button>`
              }
            </div>
          `;

          return `
            <tr>
              <td class="pp-mono">${esc(u.accountId)}</td>
              <td>${esc(u.name)}</td>
              <td class="pp-ellipsis" title="${esc(deptTeam)}">${deptTeam}</td>
              <td class="pp-mono">${esc(lastCh)}</td>
              <td class="pp-mono">${esc(exp)}<div style="margin-top:4px;">${badgePwState(policy, u)}</div></td>
              <td class="pp-mono">${esc(must)}</td>
              <td class="pp-mono">${esc(hist)}</td>
              <td>${actions}</td>
            </tr>
          `;
        }).join("") : `<tr><td colspan="8" style="padding:14px; color:var(--muted);">조건에 맞는 계정이 없습니다.</td></tr>`;
      }

      // logs
      const logType = String(mountEl.querySelector("#ppLogTypeFilter")?.value || "").trim();
      let fLogs = logs.slice();
      if (logType) fLogs = fLogs.filter(l => String(l.type || "") === logType);

      const logsTbody = mountEl.querySelector("#ppLogsTbody");
      if (logsTbody) {
        logsTbody.innerHTML = fLogs.length ? fLogs.slice(0, 250).map(l => `
          <tr>
            <td class="pp-mono">${esc(fmtISO(l.at))}</td>
            <td class="pp-mono">${esc(l.accountId)}</td>
            <td class="pp-mono">${esc(l.type)}</td>
            <td class="pp-mono">${esc(l.ip || "-")}</td>
            <td class="pp-ellipsis" title="${esc(l.detail)}">${esc(l.detail)}</td>
          </tr>
        `).join("") : `<tr><td colspan="5" style="padding:14px; color:var(--muted);">이력이 없습니다.</td></tr>`;
      }

      // sim result: if input exists, show quick check
      const newPw = String(mountEl.querySelector("#ppNewPw")?.value || "");
      const chkEl = mountEl.querySelector("#ppChecklist");
      const resEl = mountEl.querySelector("#ppSimResult");
      if (u0 && (newPw.length > 0) && chkEl && resEl) {
        const force = mountEl.querySelector("#ppForce")?.value === "true";
        const r = evaluatePassword(policy, u0, newPw, { force });
        resEl.innerHTML = r.ok
          ? `<span class="pp-badge ok"><i class="fa-solid fa-circle-check"></i> PASS</span>`
          : `<span class="pp-badge bad"><i class="fa-solid fa-circle-xmark"></i> FAIL</span>`;
        chkEl.innerHTML = (r.checks || []).map(c =>
          `<li class="${c.ok ? "ok" : "bad"}">${c.ok ? "✔" : "✖"} ${esc(c.label)}</li>`
        ).join("");
      } else if (chkEl) {
        chkEl.innerHTML = "";
        if (resEl) resEl.innerHTML = `<span class="pp-badge warn"><i class="fa-solid fa-list-check"></i> 입력 후 검사</span>`;
      }
    }

    function downloadJson(filename, payload) {
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function readJsonFile(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => { try { resolve(JSON.parse(String(fr.result || ""))); } catch (e) { reject(e); } };
        fr.onerror = reject;
        fr.readAsText(file);
      });
    }

    // ---------- bind ----------
    function bindEvents(mountEl) {
      // 상단 actions
      mountEl.querySelector('[data-pp-act="save"]')?.addEventListener("click", () => {
        const enabled = mountEl.querySelector("#ppEnabled")?.value === "true";

        const minLength = clamp(mountEl.querySelector("#ppMinLength")?.value, 6, 128);
        const maxLength = clamp(mountEl.querySelector("#ppMaxLength")?.value, minLength, 256);

        const expiryDays = clamp(mountEl.querySelector("#ppExpiryDays")?.value, 0, 3650);
        const minAgeDays = clamp(mountEl.querySelector("#ppMinAgeDays")?.value, 0, 365);
        const historyCount = clamp(mountEl.querySelector("#ppHistoryCount")?.value, 0, 24);

        const allowedSpecial = String(mountEl.querySelector("#ppAllowedSpecial")?.value || "");

        const policy = {
          enabled,
          minLength,
          maxLength,
          requireUpper: mountEl.querySelector("#ppRequireUpper")?.value === "true",
          requireLower: mountEl.querySelector("#ppRequireLower")?.value === "true",
          requireNumber: mountEl.querySelector("#ppRequireNumber")?.value === "true",
          requireSpecial: mountEl.querySelector("#ppRequireSpecial")?.value === "true",
          allowedSpecial,

          noWhitespace: mountEl.querySelector("#ppNoWhitespace")?.value === "true",
          disallowAccountId: mountEl.querySelector("#ppDisallowAccountId")?.value === "true",
          disallowName: mountEl.querySelector("#ppDisallowName")?.value === "true",
          disallowSequence: mountEl.querySelector("#ppDisallowSequence")?.value === "true",
          disallowRepeat: mountEl.querySelector("#ppDisallowRepeat")?.value === "true",

          expiryDays,
          minAgeDays,
          historyCount,
          note: "password policy"
        };

        safeSave(KEY_POLICY, policy);
        pushLog("-", "POLICY", "-", `정책 저장: enabled=${enabled}, minLen=${minLength}, maxLen=${maxLength}, expiryDays=${expiryDays}, history=${historyCount}, minAge=${minAgeDays}`);
        toast("정책이 저장되었습니다.");
        renderAll(mountEl);
      });

      mountEl.querySelector('[data-pp-act="reset"]')?.addEventListener("click", () => {
        const ok = confirm("정책/계정 상태/로그를 초기화할까요?");
        if (!ok) return;
        safeSave(KEY_POLICY, defaultPolicy());
        safeSave(KEY_USERS, []);
        safeSave(KEY_LOGS, []);
        ensureSeed();
        toast("초기화 완료");
        renderAll(mountEl);
      });

      mountEl.querySelector('[data-pp-act="export"]')?.addEventListener("click", () => {
        const payload = {
          exportedAt: nowISO(),
          policy: safeLoad(KEY_POLICY, defaultPolicy()),
          users: safeLoad(KEY_USERS, []),
          logs: safeLoad(KEY_LOGS, [])
        };
        downloadJson(`dbam_password_policy_export_${Date.now()}.json`, payload);
      });

      const importFile = mountEl.querySelector("#ppImportFile");
      if (importFile) {
        importFile.addEventListener("change", async () => {
          const f = importFile.files?.[0];
          if (!f) return;
          try {
            const json = await readJsonFile(f);
            if (json && typeof json === "object") {
              if (json.policy) safeSave(KEY_POLICY, json.policy);
              if (Array.isArray(json.users)) safeSave(KEY_USERS, json.users);
              if (Array.isArray(json.logs)) safeSave(KEY_LOGS, json.logs);
              toast("가져오기 완료");
              renderAll(mountEl);
            } else {
              toast("가져오기 실패: 형식이 올바르지 않습니다.");
            }
          } catch (e) {
            console.warn(e);
            toast("가져오기 실패: 파일을 확인하세요.");
          } finally {
            importFile.value = "";
          }
        });
      }

      mountEl.querySelector('[data-pp-act="clearLogs"]')?.addEventListener("click", () => {
        const ok = confirm("로그를 모두 비울까요?");
        if (!ok) return;
        safeSave(KEY_LOGS, []);
        toast("로그를 비웠습니다.");
        renderAll(mountEl);
      });

      // filters
      mountEl.querySelector("#ppUserSearch")?.addEventListener("input", () => renderAll(mountEl));
      mountEl.querySelector("#ppPwStateFilter")?.addEventListener("change", () => renderAll(mountEl));
      mountEl.querySelector("#ppLogTypeFilter")?.addEventListener("change", () => renderAll(mountEl));

      // sim select
      mountEl.querySelector("#ppSimUser")?.addEventListener("change", () => {
        pageState.selectedAccountId = mountEl.querySelector("#ppSimUser")?.value || null;
        renderAll(mountEl);
      });

      // new pw input -> live check
      mountEl.querySelector("#ppNewPw")?.addEventListener("input", () => renderAll(mountEl));
      mountEl.querySelector("#ppForce")?.addEventListener("change", () => renderAll(mountEl));

      // sim actions
      mountEl.querySelectorAll("[data-pp-sim]")?.forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-pp-sim");
          const policy = safeLoad(KEY_POLICY, defaultPolicy());
          const users = Array.isArray(safeLoad(KEY_USERS, [])) ? safeLoad(KEY_USERS, []) : [];

          const accountId = mountEl.querySelector("#ppSimUser")?.value || "";
          const ip = String(mountEl.querySelector("#ppSimIp")?.value || "").trim() || "-";
          const force = mountEl.querySelector("#ppForce")?.value === "true";

          const user = users.find(u => u.accountId === accountId);
          if (!user) return;

          if (act === "check") {
            const pw = String(mountEl.querySelector("#ppNewPw")?.value || "");
            const r = evaluatePassword(policy, user, pw, { force });
            if (!pw) return toast("새 비밀번호를 입력하세요.");
            if (r.ok) toast("규칙 통과");
            else toast("규칙 미통과: 체크리스트를 확인하세요.");
            renderAll(mountEl);
            return;
          }

          if (act === "apply") {
            const pw1 = String(mountEl.querySelector("#ppNewPw")?.value || "");
            const pw2 = String(mountEl.querySelector("#ppNewPw2")?.value || "");
            if (!pw1) return toast("새 비밀번호를 입력하세요.");
            if (pw1 !== pw2) return toast("확인 비밀번호가 일치하지 않습니다.");

            const r = evaluatePassword(policy, user, pw1, { force });
            if (!r.ok) {
              toast("변경 실패: 규칙 미통과");
              renderAll(mountEl);
              return;
            }

            const h = pwHash(user.accountId, pw1);
            user.pwHash = h;
            user.pwHistory = Array.isArray(user.pwHistory) ? user.pwHistory : [];
            user.pwHistory.unshift(h);

            const keep = clamp(policy.historyCount, 0, 24);
            const keepMax = Math.max(1, keep + 3); // 최근 N보다 약간 더 보관
            user.pwHistory = user.pwHistory.slice(0, keepMax);

            user.lastChangedAt = nowISO();
            user.expiresAt = computeExpiresAt(policy, user.lastChangedAt);
            user.mustChange = false;

            safeSave(KEY_USERS, users);
            pushLog(user.accountId, "CHANGE", ip, `비밀번호 변경 적용(force=${force})`);
            toast("비밀번호 변경이 적용되었습니다.");
            mountEl.querySelector("#ppNewPw").value = "";
            mountEl.querySelector("#ppNewPw2").value = "";
            renderAll(mountEl);
            return;
          }

          if (act === "requireChange") {
            user.mustChange = true;
            safeSave(KEY_USERS, users);
            pushLog(user.accountId, "REQUIRE", ip, "비밀번호 변경 요구 설정");
            toast("변경 요구가 설정되었습니다.");
            renderAll(mountEl);
            return;
          }

          if (act === "clearRequire") {
            user.mustChange = false;
            safeSave(KEY_USERS, users);
            pushLog(user.accountId, "CLEAR_REQUIRE", ip, "비밀번호 변경 요구 해제");
            toast("변경 요구가 해제되었습니다.");
            renderAll(mountEl);
            return;
          }
        });
      });

      // user table actions (delegation)
      mountEl.addEventListener("click", (e) => {
        const btn = e.target.closest?.("[data-pp-user-act]");
        if (!btn) return;

        const act = btn.getAttribute("data-pp-user-act");
        const id = btn.getAttribute("data-pp-id");
        if (!id) return;

        const policy = safeLoad(KEY_POLICY, defaultPolicy());
        const users = Array.isArray(safeLoad(KEY_USERS, [])) ? safeLoad(KEY_USERS, []) : [];
        const u = users.find(x => x.accountId === id);
        if (!u) return;

        if (act === "select") {
          pageState.selectedAccountId = id;
          const sel = mountEl.querySelector("#ppSimUser");
          if (sel) sel.value = id;
          toast(`선택됨: ${id}`);
          renderAll(mountEl);
          return;
        }

        if (act === "expire") {
          const ok = confirm("즉시 만료 처리할까요? (다음 로그인 시 변경 필요)");
          if (!ok) return;
          u.expiresAt = new Date(Date.now() - 60 * 1000).toISOString();
          u.mustChange = true;
          safeSave(KEY_USERS, users);
          pushLog(u.accountId, "EXPIRE", "-", "관리자 만료 처리");
          toast("만료 처리 완료");
          renderAll(mountEl);
          return;
        }

        if (act === "requireChange") {
          u.mustChange = true;
          safeSave(KEY_USERS, users);
          pushLog(u.accountId, "REQUIRE", "-", "관리자 변경 요구 설정");
          toast("변경 요구 설정");
          renderAll(mountEl);
          return;
        }

        if (act === "clearRequire") {
          u.mustChange = false;
          // 만료가 비어있으면 정책 기준으로 재계산
          if (!u.expiresAt && u.lastChangedAt) u.expiresAt = computeExpiresAt(policy, u.lastChangedAt);
          safeSave(KEY_USERS, users);
          pushLog(u.accountId, "CLEAR_REQUIRE", "-", "관리자 변경 요구 해제");
          toast("변경 요구 해제");
          renderAll(mountEl);
          return;
        }
      }, true);
    }

    function renderDbamPasswordPolicyPage(mountEl) {
      if (!mountEl) return;
      ensureStyle();
      ensureSeed();

      mountEl.innerHTML = templateHtml();
      bindEvents(mountEl);
      renderAll(mountEl);
    }

    W.DBAM.renderDbamPasswordPolicyPage = renderDbamPasswordPolicyPage;

    // ---------- Admin open + card click (authPolicy) ----------
    const passwordPolicyAdmin = {
      open() {
        const titleEl = document.getElementById("adminTitle");
        const descEl  = document.getElementById("adminDesc");
        const bodyEl  = document.getElementById("adminBody");
        if (!titleEl || !descEl || !bodyEl) return;

        try {
          W.admin.current = "authPolicy";
          document.querySelectorAll(".admin-nav button").forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.section === "authPolicy");
          });
        } catch (_) {}

        titleEl.innerHTML = '<i class="fa-solid fa-key"></i> 비밀번호 정책 관리';
        descEl.textContent = "비밀번호 최소 길이/복잡도, 변경 주기, 재사용 금지, 만료 및 변경 요구를 관리합니다.";

        W.DBAM.renderDbamPasswordPolicyPage(bodyEl);
      }
    };
    W.passwordPolicyAdmin = passwordPolicyAdmin;

    // 카드 클릭 -> open
    document.addEventListener("click", (e) => {
      const card = e.target.closest?.("#adminBody .admin-card.admin-card-clickable");
      if (!card) return;
      if (!W.admin || W.admin.current !== "authPolicy") return;

      const h4 = card.querySelector("h4");
      const title = (h4?.textContent || "").trim();
      if (!title.includes("비밀번호 정책 관리")) return;

      e.preventDefault();
      e.stopPropagation();
      passwordPolicyAdmin.open();
    }, true);

  })(); // end passwordPolicy

  /* =========================
   * DBAM - 비밀번호 초기화/임시 비밀번호 로그 (passwordReset)
   * - 임시 비밀번호 발급/복호화 불가(1회 표시), 만료/사용/회수 이력
   * - passwordPolicy 모듈의 사용자 저장소(dbam_auth_password_users)를 공용으로 사용
   *
   * Entry: window.DBAM.renderDbamPasswordResetPage(mountEl)
   * ========================= */
  (function () {
    const W = window;
    W.DBAM = W.DBAM || {};
    if (W.DBAM.__passwordResetInstalled) return;
    W.DBAM.__passwordResetInstalled = true;

    // 공용(비밀번호 정책 모듈) 사용자 저장소
    const KEY_PW_USERS = "dbam_auth_password_users";

    // 본 모듈 저장소
    const KEY_RESET_POLICY = "dbam_auth_password_reset_policy";
    const KEY_RESET_LOGS   = "dbam_auth_password_reset_logs";

    // (선택) 로그인잠금 모듈 사용자(공용 users 없을 때 seed용)
    const KEY_LOGINLOCK_USERS = "dbam_auth_login_lock_users";

    // ---------- utils ----------
    function toast(msg) { (typeof dbamToast === "function") ? dbamToast(msg) : alert(msg); }
    function esc(s) { return (typeof dbamEscHtml === "function") ? dbamEscHtml(s) : String(s ?? ""); }
    function safeLoad(key, fallback) {
      try { return (typeof dbamLoad === "function") ? dbamLoad(key, fallback) : fallback; }
      catch (_) { return fallback; }
    }
    function safeSave(key, value) {
      try { if (typeof dbamSave === "function") dbamSave(key, value); }
      catch (_) {}
    }
    function uid(prefix) { return (typeof dbamUid === "function") ? dbamUid(prefix) : `${prefix}_${Date.now()}`; }
    function nowISO() { return new Date().toISOString(); }
    function fmtISO(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return String(iso);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      const ss = String(d.getSeconds()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    }
    function clamp(n, a, b) { n = Number(n); if (Number.isNaN(n)) return a; return Math.min(b, Math.max(a, n)); }

    function getAdminName() {
      const c1 = W.DBAM?.currentUser?.name;
      const c2 = W.DBAM_CURRENT_ADMIN?.name;
      const c3 = safeLoad("dbam_current_user", null)?.name;
      return String(c1 || c2 || c3 || "관리자");
    }

    // ---------- simple hash (표시용/재사용방지용) ----------
    function fnv1a(str) {
      let h = 0x811c9dc5;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0;
      }
      return ("00000000" + h.toString(16)).slice(-8);
    }
    function pwHash(userId, pw) {
      const salt = `DBAM|PW|${String(userId || "").toUpperCase()}`;
      return `h_${fnv1a(salt + "|" + String(pw || ""))}`;
    }

    // ---------- random ----------
    function cryptoRandInt(maxExclusive) {
      const m = Math.max(1, Number(maxExclusive || 1));
      if (W.crypto?.getRandomValues) {
        const u = new Uint32Array(1);
        W.crypto.getRandomValues(u);
        return u[0] % m;
      }
      return Math.floor(Math.random() * m);
    }
    function pick(chars) { return chars[cryptoRandInt(chars.length)]; }
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = cryptoRandInt(i + 1);
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ---------- style ----------
    function ensureStyle() {
      if (document.getElementById("dbamPasswordResetStyle")) return;
      const st = document.createElement("style");
      st.id = "dbamPasswordResetStyle";
      st.textContent = `
        .pr-grid{display:grid; grid-template-columns:360px minmax(0,1fr); gap:12px; align-items:flex-start;}
        .pr-kv{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px;}
        .pr-kv .label{font-size:11px; color:var(--muted); margin-bottom:4px;}
        .pr-row{border:1px solid var(--line); border-radius:12px; padding:10px 12px;}
        .pr-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
        .pr-badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid var(--line);}
        .pr-badge.issued{background:rgba(2,132,199,.10); border-color:rgba(2,132,199,.18); color:#075985;}
        .pr-badge.used{background:rgba(0,160,90,.10); border-color:rgba(0,160,90,.18); color:#0a7a4a;}
        .pr-badge.expired{background:rgba(255,0,0,.08); border-color:rgba(255,0,0,.18); color:#b30000;}
        .pr-badge.revoked{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.22); color:#a16207;}
        .pr-table{width:100%; border-collapse:collapse; font-size:12px;}
        .pr-table th,.pr-table td{padding:10px; border-bottom:1px solid var(--line); vertical-align:top;}
        .pr-table th{background:var(--panel,#f8fafc); text-align:left; white-space:nowrap;}
        .pr-scroll-x{overflow-x:auto; -webkit-overflow-scrolling:touch;}
        .pr-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;}
        .pr-mini-btn{padding:4px 8px; font-size:11px; line-height:1.1;}
        .pr-ellipsis{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:260px;}
        .pr-secret{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
        .pr-secret input{flex:1; min-width:240px;}
      `;
      document.head.appendChild(st);
    }

    // ---------- defaults / seed ----------
    function defaultResetPolicy() {
      return {
        enabled: true,

        // 임시 비밀번호 생성 규칙
        tempLength: 12,
        includeUpper: true,
        includeLower: true,
        includeNumber: true,
        includeSpecial: true,
        allowedSpecial: "!@#$%^&*()-_=+[]{};:,.?/`~|\\",

        // 임시 비밀번호 유효시간
        tempValidMin: 60,           // 분
        // 발급 시 사용자 상태 처리
        forceMustChange: true,
        // 발급 시 만료를 임시 유효시간으로 덮어쓰기(기존 만료보다 이르게 강제)
        overrideUserExpiresAt: true,

        note: "비밀번호 초기화/임시 비밀번호 정책"
      };
    }

    function seedUsersIfEmpty() {
      const existing = safeLoad(KEY_PW_USERS, null);
      if (Array.isArray(existing) && existing.length) return existing;

      const llUsers = safeLoad(KEY_LOGINLOCK_USERS, null);
      let base = Array.isArray(llUsers) && llUsers.length
        ? llUsers.map(u => ({
            accountId: u.accountId,
            name: u.name || "-",
            dept: u.dept || "-",
            team: u.team || "-",
            title: u.title || "-",
            status: u.status || "ACTIVE"
          }))
        : [
          { accountId:"u1001", name:"홍길동", dept:"정보보안실", team:"DB보안팀", title:"대리", status:"ACTIVE" },
          { accountId:"u1002", name:"김감사", dept:"정보보안실", team:"감사팀",   title:"과장", status:"ACTIVE" },
          { accountId:"u1003", name:"박개발", dept:"플랫폼개발부", team:"API팀",  title:"사원", status:"ACTIVE" },
        ];

      const now = Date.now();
      const lastChangedAt = new Date(now - 20 * 24 * 60 * 60 * 1000).toISOString();

      const users = base.map(u => {
        const initPw = `P@ssw0rd!_${u.accountId}`;
        const h = pwHash(u.accountId, initPw);
        return {
          accountId: u.accountId,
          name: u.name,
          dept: u.dept,
          team: u.team,
          title: u.title,
          status: u.status || "ACTIVE",

          pwHash: h,
          pwHistory: [h],
          lastChangedAt,
          expiresAt: null,
          mustChange: false
        };
      });

      safeSave(KEY_PW_USERS, users);
      return users;
    }

    function seedLogsIfEmpty() {
      const existing = safeLoad(KEY_RESET_LOGS, null);
      if (Array.isArray(existing) && existing.length) return existing;

      const seed = [
        { id: uid("rlog"), at: nowISO(), accountId: "u1001", type: "ISSUE", issuedBy: "관리자", ip: "10.10.1.15", delivery: "NONE", status: "ISSUED", expiresAt: null, usedAt: null, detail: "임시 비밀번호 발급(샘플)" },
      ];
      safeSave(KEY_RESET_LOGS, seed);
      return seed;
    }

    function ensureSeed() {
      const p = safeLoad(KEY_RESET_POLICY, null);
      if (!p) safeSave(KEY_RESET_POLICY, defaultResetPolicy());
      const policy = safeLoad(KEY_RESET_POLICY, defaultResetPolicy());
      const users = seedUsersIfEmpty();
      const logs = seedLogsIfEmpty();
      return { policy, users, logs };
    }

    // ---------- logs ----------
    function pushResetLog(row) {
      const logs = Array.isArray(safeLoad(KEY_RESET_LOGS, [])) ? safeLoad(KEY_RESET_LOGS, []) : [];
      logs.unshift({
        id: uid("rlog"),
        at: nowISO(),
        accountId: String(row.accountId || "-"),
        type: String(row.type || ""),
        issuedBy: String(row.issuedBy || getAdminName()),
        ip: String(row.ip || "-"),
        delivery: String(row.delivery || "NONE"), // SMS | EMAIL | NONE
        status: String(row.status || ""),
        expiresAt: row.expiresAt || null,
        usedAt: row.usedAt || null,
        // 임시 비밀번호 원문 저장 금지
        tempHash: row.tempHash || null,
        detail: String(row.detail || "")
      });
      if (logs.length > 800) logs.length = 800;
      safeSave(KEY_RESET_LOGS, logs);
      return logs;
    }

    function statusBadge(st) {
      const s = String(st || "");
      if (s === "ISSUED") return `<span class="pr-badge issued"><i class="fa-solid fa-ticket"></i> ISSUED</span>`;
      if (s === "USED") return `<span class="pr-badge used"><i class="fa-solid fa-circle-check"></i> USED</span>`;
      if (s === "EXPIRED") return `<span class="pr-badge expired"><i class="fa-solid fa-hourglass-end"></i> EXPIRED</span>`;
      if (s === "REVOKED") return `<span class="pr-badge revoked"><i class="fa-solid fa-ban"></i> REVOKED</span>`;
      return `<span class="pr-badge revoked"><i class="fa-solid fa-circle-minus"></i> ${esc(s || "-")}</span>`;
    }

    // ---------- expire reconcile ----------
    function reconcileExpiry(logs) {
      const now = Date.now();
      let changed = false;
      logs.forEach(l => {
        if (l.status !== "ISSUED") return;
        if (!l.expiresAt) return;
        const t = new Date(l.expiresAt).getTime();
        if (Number.isNaN(t)) return;
        if (t <= now) { l.status = "EXPIRED"; changed = true; }
      });
      if (changed) safeSave(KEY_RESET_LOGS, logs);
      return { logs, changed };
    }

    // ---------- temp password generator ----------
    function generateTempPassword(policy) {
      const len = clamp(policy.tempLength, 8, 64);

      const U = "ABCDEFGHJKLMNPQRSTUVWXYZ";        // 혼동 문자 제거(I/O)
      const L = "abcdefghijkmnpqrstuvwxyz";        // 혼동 문자 제거(l/o)
      const N = "23456789";                        // 혼동 문자 제거(0/1)
      const S = String(policy.allowedSpecial || "!@#$%^&*");

      const pools = [];
      if (policy.includeUpper) pools.push(U);
      if (policy.includeLower) pools.push(L);
      if (policy.includeNumber) pools.push(N);
      if (policy.includeSpecial) pools.push(S);

      const all = pools.join("") || (U + L + N);
      const out = [];

      // 최소 1개씩 보장
      pools.forEach(p => out.push(pick(p)));

      while (out.length < len) out.push(pick(all));
      shuffle(out);
      return out.join("");
    }

    // ---------- apply reset ----------
    function issueTempPassword(policy, users, accountId, opts) {
      const u = users.find(x => x.accountId === accountId);
      if (!u) return { ok: false, msg: "대상 계정을 찾을 수 없습니다." };
      if (String(u.status || "") === "DISABLED") return { ok: false, msg: "비활성 계정입니다." };

      const tempPw = generateTempPassword(policy);
      const tempH = pwHash(u.accountId, tempPw);

      // 사용자 비밀번호를 임시 비밀번호로 교체 + mustChange 강제
      u.pwHash = tempH;
      u.pwHistory = Array.isArray(u.pwHistory) ? u.pwHistory : [];
      u.pwHistory.unshift(tempH);
      if (u.pwHistory.length > 30) u.pwHistory.length = 30;

      u.lastChangedAt = nowISO();
      if (policy.forceMustChange) u.mustChange = true;

      const expiresAt = new Date(Date.now() + clamp(policy.tempValidMin, 5, 7 * 24 * 60) * 60 * 1000).toISOString();
      if (policy.overrideUserExpiresAt) u.expiresAt = expiresAt;

      pushResetLog({
        accountId: u.accountId,
        type: "ISSUE",
        issuedBy: opts.issuedBy,
        ip: opts.ip,
        delivery: opts.delivery,
        status: "ISSUED",
        expiresAt,
        usedAt: null,
        tempHash: tempH,
        detail: opts.reason ? `발급 사유: ${opts.reason}` : "임시 비밀번호 발급"
      });

      safeSave(KEY_PW_USERS, users);

      return { ok: true, tempPw, expiresAt };
    }

    function revokeIssued(logs, id, opts) {
      const l = logs.find(x => x.id === id);
      if (!l) return { ok:false, msg:"로그를 찾을 수 없습니다." };
      if (l.status !== "ISSUED") return { ok:false, msg:"ISSUED 상태만 회수할 수 있습니다." };
      l.status = "REVOKED";
      pushResetLog({
        accountId: l.accountId,
        type: "REVOKE",
        issuedBy: opts.issuedBy,
        ip: opts.ip,
        delivery: l.delivery || "NONE",
        status: "REVOKED",
        expiresAt: l.expiresAt || null,
        usedAt: null,
        detail: opts.reason ? `회수 사유: ${opts.reason}` : "임시 비밀번호 회수"
      });
      safeSave(KEY_RESET_LOGS, logs);
      return { ok:true };
    }

    function markUsed(logs, id, opts) {
      const l = logs.find(x => x.id === id);
      if (!l) return { ok:false, msg:"로그를 찾을 수 없습니다." };
      if (l.status !== "ISSUED") return { ok:false, msg:"ISSUED 상태만 USED 처리할 수 있습니다." };
      l.status = "USED";
      l.usedAt = nowISO();
      pushResetLog({
        accountId: l.accountId,
        type: "USED",
        issuedBy: opts.issuedBy,
        ip: opts.ip,
        delivery: l.delivery || "NONE",
        status: "USED",
        expiresAt: l.expiresAt || null,
        usedAt: l.usedAt,
        detail: opts.reason ? `사용 처리: ${opts.reason}` : "임시 비밀번호 사용 처리"
      });
      safeSave(KEY_RESET_LOGS, logs);
      return { ok:true };
    }

    // ---------- UI ----------
    function templateHtml() {
      return `
        <div id="passwordResetPage" class="emg-page" style="width:100%; max-width:100%; overflow-x:hidden;">
          <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-primary" data-pr-act="save"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
              <button class="btn btn-outline" data-pr-act="reset"><i class="fa-solid fa-rotate"></i> 초기화</button>
              <button class="btn btn-outline" data-pr-act="export"><i class="fa-solid fa-file-export"></i> 내보내기</button>
              <label class="btn btn-outline" style="cursor:pointer; margin:0;">
                <i class="fa-solid fa-file-import"></i> 가져오기
                <input type="file" id="prImportFile" accept="application/json" style="display:none;" />
              </label>
              <button class="btn btn-outline" data-pr-act="clearLogs"><i class="fa-solid fa-trash"></i> 로그 비우기</button>
            </div>
            <div class="admin-footer">임시 비밀번호 발급/회수/만료/사용 처리 이력을 남기고, 발급 시 비밀번호를 1회 표시합니다.</div>
          </div>

          <div class="pr-grid">
            <div style="display:flex; flex-direction:column; gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                  <div style="font-weight:700;"><i class="fa-solid fa-sliders"></i> 발급 정책</div>
                  <div id="prEnabledBadge"></div>
                </div>

                <div class="pr-kv" style="margin-top:10px;">
                  <div>
                    <div class="label">기능 사용</div>
                    <select id="prEnabled" class="export-input">
                      <option value="true">ENABLED</option>
                      <option value="false">DISABLED</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">임시 비밀번호 유효(분)</div>
                    <input id="prTempValidMin" type="number" min="5" max="10080" class="export-input" placeholder="예: 60" />
                  </div>

                  <div>
                    <div class="label">길이</div>
                    <input id="prTempLength" type="number" min="8" max="64" class="export-input" placeholder="예: 12" />
                  </div>
                  <div>
                    <div class="label">허용 특수문자</div>
                    <input id="prAllowedSpecial" class="export-input pr-mono" />
                  </div>

                  <div>
                    <div class="label">대문자 포함</div>
                    <select id="prUpper" class="export-input"><option value="true">ON</option><option value="false">OFF</option></select>
                  </div>
                  <div>
                    <div class="label">소문자 포함</div>
                    <select id="prLower" class="export-input"><option value="true">ON</option><option value="false">OFF</option></select>
                  </div>
                  <div>
                    <div class="label">숫자 포함</div>
                    <select id="prNumber" class="export-input"><option value="true">ON</option><option value="false">OFF</option></select>
                  </div>
                  <div>
                    <div class="label">특수문자 포함</div>
                    <select id="prSpecial" class="export-input"><option value="true">ON</option><option value="false">OFF</option></select>
                  </div>

                  <div>
                    <div class="label">발급 시 변경 요구</div>
                    <select id="prMustChange" class="export-input"><option value="true">ON</option><option value="false">OFF</option></select>
                  </div>
                  <div>
                    <div class="label">만료 강제(유효시간 적용)</div>
                    <select id="prOverrideExpires" class="export-input"><option value="true">ON</option><option value="false">OFF</option></select>
                  </div>
                </div>

                <div class="admin-footer" style="margin-top:10px;">
                  임시 비밀번호 원문은 저장하지 않고, 발급 직후 화면에 1회 표시합니다.
                </div>
              </div>

              <div class="admin-card" style="padding:12px 14px;">
                <div style="font-weight:700;"><i class="fa-solid fa-ticket"></i> 임시 비밀번호 발급</div>

                <div class="pr-kv" style="margin-top:10px;">
                  <div style="grid-column:1 / -1;">
                    <div class="label">대상 계정</div>
                    <select id="prTargetUser" class="export-input"></select>
                  </div>
                  <div>
                    <div class="label">전달 방식</div>
                    <select id="prDelivery" class="export-input">
                      <option value="NONE">NONE</option>
                      <option value="SMS">SMS</option>
                      <option value="EMAIL">EMAIL</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">IP</div>
                    <input id="prIp" class="export-input pr-mono" placeholder="예: 10.0.0.1" />
                  </div>
                  <div style="grid-column:1 / -1;">
                    <div class="label">발급 사유(선택)</div>
                    <input id="prReason" class="export-input" placeholder="예: 사용자 요청 / 계정 복구 / 초기화" />
                  </div>
                </div>

                <div class="pr-actions" style="margin-top:10px;">
                  <button class="btn btn-outline pr-mini-btn" data-pr-issue="issue"><i class="fa-solid fa-key"></i> 임시 비밀번호 발급</button>
                  <button class="btn btn-outline pr-mini-btn" data-pr-issue="copy"><i class="fa-solid fa-copy"></i> 복사</button>
                  <button class="btn btn-outline pr-mini-btn" data-pr-issue="clear"><i class="fa-solid fa-broom"></i> 표시 지우기</button>
                </div>

                <div class="pr-row" style="margin-top:10px;">
                  <div style="color:var(--muted); font-size:11px;">최근 발급(1회 표시)</div>
                  <div class="pr-secret" style="margin-top:6px;">
                    <input id="prTempShown" class="export-input pr-mono" readonly placeholder="발급 후 여기에서만 표시됩니다." />
                    <span id="prTempMeta" class="pr-mono" style="font-size:11px; color:var(--muted);"></span>
                  </div>
                </div>
              </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                  <div style="font-weight:700;"><i class="fa-solid fa-list"></i> 임시 비밀번호 로그</div>
                  <div class="pr-actions">
                    <input id="prSearch" class="export-input" style="width:220px;" placeholder="검색: 계정/발급자/상세" />
                    <select id="prStatusFilter" class="export-input" style="width:170px;">
                      <option value="">전체</option>
                      <option value="ISSUED">ISSUED</option>
                      <option value="USED">USED</option>
                      <option value="EXPIRED">EXPIRED</option>
                      <option value="REVOKED">REVOKED</option>
                    </select>
                  </div>
                </div>

                <div id="prSummary" class="admin-footer" style="margin-top:8px;"></div>

                <div class="pr-scroll-x" style="margin-top:8px;">
                  <table class="pr-table">
                    <thead>
                      <tr>
                        <th>시간</th>
                        <th>계정</th>
                        <th>상태</th>
                        <th>만료</th>
                        <th>사용</th>
                        <th>발급자</th>
                        <th>전달</th>
                        <th>IP</th>
                        <th>상세</th>
                        <th>조치</th>
                      </tr>
                    </thead>
                    <tbody id="prLogsTbody"></tbody>
                  </table>
                </div>
              </div>

              <div class="admin-card" style="padding:12px 14px;">
                <div style="font-weight:700;"><i class="fa-solid fa-users"></i> 계정 선택(빠른 이동)</div>
                <div class="pr-scroll-x" style="margin-top:8px;">
                  <table class="pr-table">
                    <thead>
                      <tr>
                        <th>계정</th>
                        <th>이름</th>
                        <th>부서/팀</th>
                        <th>상태</th>
                        <th>조치</th>
                      </tr>
                    </thead>
                    <tbody id="prUsersTbody"></tbody>
                  </table>
                </div>
              </div>

            </div>
          </div>
        </div>
      `;
    }

    function enabledBadge(on) {
      return on
        ? `<span class="pr-badge used"><i class="fa-solid fa-shield-halved"></i> ENABLED</span>`
        : `<span class="pr-badge revoked"><i class="fa-solid fa-circle-minus"></i> DISABLED</span>`;
    }

    // ---------- render / bind ----------
    const pageState = { lastTemp: "", lastMeta: "" , timerId: null };

    function renderAll(mountEl) {
      const policy = safeLoad(KEY_RESET_POLICY, defaultResetPolicy());
      const users = Array.isArray(safeLoad(KEY_PW_USERS, [])) ? safeLoad(KEY_PW_USERS, []) : [];
      let logs = Array.isArray(safeLoad(KEY_RESET_LOGS, [])) ? safeLoad(KEY_RESET_LOGS, []) : [];

      // expire reconcile
      logs = reconcileExpiry(logs).logs;

      // policy UI
      const badgeEl = mountEl.querySelector("#prEnabledBadge");
      if (badgeEl) badgeEl.innerHTML = enabledBadge(!!policy.enabled);

      const setVal = (id, v) => { const el = mountEl.querySelector(id); if (el) el.value = String(v ?? ""); };
      setVal("#prEnabled", policy.enabled ? "true" : "false");
      setVal("#prTempValidMin", policy.tempValidMin);
      setVal("#prTempLength", policy.tempLength);
      setVal("#prAllowedSpecial", policy.allowedSpecial);
      setVal("#prUpper", policy.includeUpper ? "true" : "false");
      setVal("#prLower", policy.includeLower ? "true" : "false");
      setVal("#prNumber", policy.includeNumber ? "true" : "false");
      setVal("#prSpecial", policy.includeSpecial ? "true" : "false");
      setVal("#prMustChange", policy.forceMustChange ? "true" : "false");
      setVal("#prOverrideExpires", policy.overrideUserExpiresAt ? "true" : "false");

      // user select
      const sel = mountEl.querySelector("#prTargetUser");
      if (sel) {
        const current = sel.value || (users[0]?.accountId || "");
        sel.innerHTML = users.map(u => `<option value="${esc(u.accountId)}">${esc(u.accountId)} · ${esc(u.name)} (${esc(u.dept)})</option>`).join("");
        sel.value = users.some(u => u.accountId === current) ? current : (users[0]?.accountId || "");
      }

      // last temp display
      const tempEl = mountEl.querySelector("#prTempShown");
      const metaEl = mountEl.querySelector("#prTempMeta");
      if (tempEl) tempEl.value = pageState.lastTemp || "";
      if (metaEl) metaEl.textContent = pageState.lastMeta || "";

      // logs filter
      const q = String(mountEl.querySelector("#prSearch")?.value || "").trim().toLowerCase();
      const st = String(mountEl.querySelector("#prStatusFilter")?.value || "").trim();

      let filtered = logs.slice();
      if (st) filtered = filtered.filter(l => String(l.status || "") === st);

      if (q) {
        filtered = filtered.filter(l => {
          const hay = `${l.accountId} ${l.issuedBy} ${l.detail} ${l.type}`.toLowerCase();
          return hay.includes(q);
        });
      }

      // summary
      const issued = logs.filter(l => l.status === "ISSUED").length;
      const used   = logs.filter(l => l.status === "USED").length;
      const exp    = logs.filter(l => l.status === "EXPIRED").length;
      const rev    = logs.filter(l => l.status === "REVOKED").length;
      const sumEl  = mountEl.querySelector("#prSummary");
      if (sumEl) sumEl.textContent = `전체 ${logs.length}건 · ISSUED ${issued} · USED ${used} · EXPIRED ${exp} · REVOKED ${rev}`;

      // logs table
      const tbody = mountEl.querySelector("#prLogsTbody");
      if (tbody) {
        tbody.innerHTML = filtered.length ? filtered.slice(0, 300).map(l => {
          const expAt = l.expiresAt ? fmtISO(l.expiresAt) : "—";
          const usedAt = l.usedAt ? fmtISO(l.usedAt) : "—";
          const actions = `
            <div class="pr-actions">
              ${l.status === "ISSUED"
                ? `<button class="btn btn-outline pr-mini-btn" data-pr-log-act="used" data-pr-id="${esc(l.id)}"><i class="fa-solid fa-circle-check"></i> USED</button>
                   <button class="btn btn-outline pr-mini-btn" data-pr-log-act="revoke" data-pr-id="${esc(l.id)}"><i class="fa-solid fa-ban"></i> 회수</button>`
                : `<span style="color:var(--muted); font-size:11px;">—</span>`
              }
            </div>
          `;
          return `
            <tr>
              <td class="pr-mono">${esc(fmtISO(l.at))}</td>
              <td class="pr-mono">${esc(l.accountId)}</td>
              <td>${statusBadge(l.status)}</td>
              <td class="pr-mono">${esc(expAt)}</td>
              <td class="pr-mono">${esc(usedAt)}</td>
              <td>${esc(l.issuedBy || "-")}</td>
              <td class="pr-mono">${esc(l.delivery || "NONE")}</td>
              <td class="pr-mono">${esc(l.ip || "-")}</td>
              <td class="pr-ellipsis" title="${esc(l.detail)}">${esc(l.detail)}</td>
              <td>${actions}</td>
            </tr>
          `;
        }).join("") : `<tr><td colspan="10" style="padding:14px; color:var(--muted);">로그가 없습니다.</td></tr>`;
      }

      // users table (quick select)
      const ubody = mountEl.querySelector("#prUsersTbody");
      if (ubody) {
        ubody.innerHTML = users.length ? users.slice(0, 80).map(u => {
          const deptTeam = `${esc(u.dept || "-")}${u.team ? " / " + esc(u.team) : ""}`;
          const st = String(u.status || "ACTIVE");
          const stBadge = st === "LOCKED"
            ? `<span class="pr-badge expired"><i class="fa-solid fa-lock"></i> LOCKED</span>`
            : (st === "DISABLED"
                ? `<span class="pr-badge revoked"><i class="fa-solid fa-user-slash"></i> DISABLED</span>`
                : `<span class="pr-badge used"><i class="fa-solid fa-user-check"></i> ACTIVE</span>`);

          return `
            <tr>
              <td class="pr-mono">${esc(u.accountId)}</td>
              <td>${esc(u.name)}</td>
              <td class="pr-ellipsis" title="${esc(deptTeam)}">${deptTeam}</td>
              <td>${stBadge}</td>
              <td>
                <button class="btn btn-outline pr-mini-btn" data-pr-user-act="select" data-pr-id="${esc(u.accountId)}">
                  <i class="fa-solid fa-bullseye"></i> 선택
                </button>
              </td>
            </tr>
          `;
        }).join("") : `<tr><td colspan="5" style="padding:14px; color:var(--muted);">계정이 없습니다.</td></tr>`;
      }
    }

    function downloadJson(filename, payload) {
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function readJsonFile(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => { try { resolve(JSON.parse(String(fr.result || ""))); } catch (e) { reject(e); } };
        fr.onerror = reject;
        fr.readAsText(file);
      });
    }

    function bindEvents(mountEl) {
      // 저장
      mountEl.querySelector('[data-pr-act="save"]')?.addEventListener("click", () => {
        const policy = {
          enabled: mountEl.querySelector("#prEnabled")?.value === "true",
          tempValidMin: clamp(mountEl.querySelector("#prTempValidMin")?.value, 5, 10080),
          tempLength: clamp(mountEl.querySelector("#prTempLength")?.value, 8, 64),
          includeUpper: mountEl.querySelector("#prUpper")?.value === "true",
          includeLower: mountEl.querySelector("#prLower")?.value === "true",
          includeNumber: mountEl.querySelector("#prNumber")?.value === "true",
          includeSpecial: mountEl.querySelector("#prSpecial")?.value === "true",
          allowedSpecial: String(mountEl.querySelector("#prAllowedSpecial")?.value || "!@#$%^&*"),
          forceMustChange: mountEl.querySelector("#prMustChange")?.value === "true",
          overrideUserExpiresAt: mountEl.querySelector("#prOverrideExpires")?.value === "true",
          note: "password reset policy"
        };
        safeSave(KEY_RESET_POLICY, policy);
        toast("정책이 저장되었습니다.");
        renderAll(mountEl);
      });

      // 초기화
      mountEl.querySelector('[data-pr-act="reset"]')?.addEventListener("click", () => {
        const ok = confirm("발급 정책/로그를 초기화할까요? (사용자 계정은 유지)");
        if (!ok) return;
        safeSave(KEY_RESET_POLICY, defaultResetPolicy());
        safeSave(KEY_RESET_LOGS, []);
        seedLogsIfEmpty();
        pageState.lastTemp = "";
        pageState.lastMeta = "";
        toast("초기화 완료");
        renderAll(mountEl);
      });

      // 내보내기
      mountEl.querySelector('[data-pr-act="export"]')?.addEventListener("click", () => {
        const payload = {
          exportedAt: nowISO(),
          resetPolicy: safeLoad(KEY_RESET_POLICY, defaultResetPolicy()),
          resetLogs: safeLoad(KEY_RESET_LOGS, [])
        };
        downloadJson(`dbam_password_reset_export_${Date.now()}.json`, payload);
      });

      // 가져오기
      const importFile = mountEl.querySelector("#prImportFile");
      if (importFile) {
        importFile.addEventListener("change", async () => {
          const f = importFile.files?.[0];
          if (!f) return;
          try {
            const json = await readJsonFile(f);
            if (json && typeof json === "object") {
              if (json.resetPolicy) safeSave(KEY_RESET_POLICY, json.resetPolicy);
              if (Array.isArray(json.resetLogs)) safeSave(KEY_RESET_LOGS, json.resetLogs);
              toast("가져오기 완료");
              renderAll(mountEl);
            } else {
              toast("가져오기 실패: 형식이 올바르지 않습니다.");
            }
          } catch (e) {
            console.warn(e);
            toast("가져오기 실패: 파일을 확인하세요.");
          } finally {
            importFile.value = "";
          }
        });
      }

      // 로그 비우기
      mountEl.querySelector('[data-pr-act="clearLogs"]')?.addEventListener("click", () => {
        const ok = confirm("로그를 모두 비울까요?");
        if (!ok) return;
        safeSave(KEY_RESET_LOGS, []);
        toast("로그를 비웠습니다.");
        renderAll(mountEl);
      });

      // 검색/필터
      mountEl.querySelector("#prSearch")?.addEventListener("input", () => renderAll(mountEl));
      mountEl.querySelector("#prStatusFilter")?.addEventListener("change", () => renderAll(mountEl));

      // 발급/복사/지우기
      mountEl.querySelectorAll("[data-pr-issue]")?.forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-pr-issue");
          const policy = safeLoad(KEY_RESET_POLICY, defaultResetPolicy());
          if (!policy.enabled) return toast("현재 기능이 DISABLED 상태입니다.");

          if (act === "copy") {
            const v = String(mountEl.querySelector("#prTempShown")?.value || "");
            if (!v) return toast("복사할 값이 없습니다.");
            navigator.clipboard?.writeText(v).then(() => toast("복사되었습니다.")).catch(() => toast("복사 실패"));
            return;
          }
          if (act === "clear") {
            pageState.lastTemp = "";
            pageState.lastMeta = "";
            renderAll(mountEl);
            return;
          }

          // issue
          const users = Array.isArray(safeLoad(KEY_PW_USERS, [])) ? safeLoad(KEY_PW_USERS, []) : [];
          const accountId = mountEl.querySelector("#prTargetUser")?.value || "";
          const delivery = String(mountEl.querySelector("#prDelivery")?.value || "NONE");
          const ip = String(mountEl.querySelector("#prIp")?.value || "").trim() || "-";
          const reason = String(mountEl.querySelector("#prReason")?.value || "").trim();
          const issuedBy = getAdminName();

          const ok = confirm(`임시 비밀번호를 발급할까요?\n\n계정: ${accountId}\n전달: ${delivery}\n유효(분): ${policy.tempValidMin}`);
          if (!ok) return;

          const r = issueTempPassword(policy, users, accountId, { delivery, ip, reason, issuedBy });
          if (!r.ok) return toast(r.msg || "발급 실패");

          // 1회 표시
          pageState.lastTemp = r.tempPw;
          pageState.lastMeta = `만료: ${fmtISO(r.expiresAt)} · 계정: ${accountId}`;
          // 입력 초기화
          mountEl.querySelector("#prReason").value = "";
          toast("임시 비밀번호가 발급되었습니다. (하단에 1회 표시)");
          renderAll(mountEl);
        });
      });

      // 로그 행 조치(used/revoke), 사용자 선택
      mountEl.addEventListener("click", (e) => {
        const logBtn = e.target.closest?.("[data-pr-log-act]");
        if (logBtn) {
          const act = logBtn.getAttribute("data-pr-log-act");
          const id = logBtn.getAttribute("data-pr-id");
          if (!id) return;

          const logs = Array.isArray(safeLoad(KEY_RESET_LOGS, [])) ? safeLoad(KEY_RESET_LOGS, []) : [];
          const ip = "-";
          const issuedBy = getAdminName();

          if (act === "revoke") {
            const reason = prompt("회수 사유를 입력하세요.", "보안상 회수") || "보안상 회수";
            const r = revokeIssued(logs, id, { ip, issuedBy, reason });
            if (!r.ok) toast(r.msg || "회수 실패");
            else toast("회수 처리 완료");
            renderAll(mountEl);
            return;
          }

          if (act === "used") {
            const reason = prompt("사용 처리 메모(선택)", "사용 확인") || "사용 확인";
            const r = markUsed(logs, id, { ip, issuedBy, reason });
            if (!r.ok) toast(r.msg || "처리 실패");
            else toast("USED 처리 완료");
            renderAll(mountEl);
            return;
          }
        }

        const userBtn = e.target.closest?.("[data-pr-user-act]");
        if (userBtn) {
          const id = userBtn.getAttribute("data-pr-id");
          if (!id) return;
          const sel = mountEl.querySelector("#prTargetUser");
          if (sel) sel.value = id;
          toast(`선택됨: ${id}`);
          renderAll(mountEl);
        }
      }, true);
    }

    function renderDbamPasswordResetPage(mountEl) {
      if (!mountEl) return;
      ensureStyle();
      ensureSeed();

      mountEl.innerHTML = templateHtml();
      bindEvents(mountEl);
      renderAll(mountEl);

      // 만료 자동 반영(페이지 열려있는 동안만)
      try {
        if (pageState.timerId) clearInterval(pageState.timerId);
        pageState.timerId = setInterval(() => {
          try { renderAll(mountEl); } catch (_) {}
        }, 5000);
      } catch (_) {}
    }

    W.DBAM.renderDbamPasswordResetPage = renderDbamPasswordResetPage;

    // ---------- Admin open + card click (authPolicy) ----------
    const passwordResetAdmin = {
      open() {
        const titleEl = document.getElementById("adminTitle");
        const descEl  = document.getElementById("adminDesc");
        const bodyEl  = document.getElementById("adminBody");
        if (!titleEl || !descEl || !bodyEl) return;

        try {
          W.admin.current = "authPolicy";
          document.querySelectorAll(".admin-nav button").forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.section === "authPolicy");
          });
        } catch (_) {}

        titleEl.innerHTML = '<i class="fa-solid fa-key"></i> 비밀번호 초기화/임시 비밀번호 로그';
        descEl.textContent = "임시 비밀번호 발급 및 만료/사용/회수 이력을 관리합니다.";

        W.DBAM.renderDbamPasswordResetPage(bodyEl);
      }
    };
    W.passwordResetAdmin = passwordResetAdmin;

    // 카드 클릭 -> open
    document.addEventListener("click", (e) => {
      const card = e.target.closest?.("#adminBody .admin-card.admin-card-clickable");
      if (!card) return;
      if (!W.admin || W.admin.current !== "authPolicy") return;

      const h4 = card.querySelector("h4");
      const title = (h4?.textContent || "").trim();
      if (!title.includes("비밀번호 초기화/임시 비밀번호 로그")) return;

      e.preventDefault();
      e.stopPropagation();
      passwordResetAdmin.open();
    }, true);

  })(); // end passwordReset

  /* =========================
   * DBAM - MFA 적용 정책 (관리자/특수 권한) (mfaPolicy)
   * - 관리자/특수권한 계정에 대해 MFA 강제 + 민감 액션 Step-up 인증 시뮬레이션
   * - 사용자별 MFA 등록/방법, 관리자/특수권한 플래그 관리
   *
   * Entry: window.DBAM.renderDbamMfaPolicyPage(mountEl)
   * ========================= */
  (function () {
    const W = window;
    W.DBAM = W.DBAM || {};
    if (W.DBAM.__mfaPolicyInstalled) return;
    W.DBAM.__mfaPolicyInstalled = true;

    const KEY_POLICY   = "dbam_auth_mfa_policy";
    const KEY_USERS    = "dbam_auth_mfa_users";
    const KEY_LOGS     = "dbam_auth_mfa_logs";
    const KEY_SESSIONS = "dbam_auth_mfa_sessions";

    // 참조(있으면 활용)
    const KEY_PW_USERS       = "dbam_auth_password_users";
    const KEY_LOGINLOCK_USERS= "dbam_auth_login_lock_users";

    // ---------- utils ----------
    function toast(msg) { (typeof dbamToast === "function") ? dbamToast(msg) : alert(msg); }
    function esc(s) { return (typeof dbamEscHtml === "function") ? dbamEscHtml(s) : String(s ?? ""); }
    function safeLoad(key, fallback) {
      try { return (typeof dbamLoad === "function") ? dbamLoad(key, fallback) : fallback; }
      catch (_) { return fallback; }
    }
    function safeSave(key, value) {
      try { if (typeof dbamSave === "function") dbamSave(key, value); }
      catch (_) {}
    }
    function uid(prefix) { return (typeof dbamUid === "function") ? dbamUid(prefix) : `${prefix}_${Date.now()}`; }
    function nowISO() { return new Date().toISOString(); }
    function fmtISO(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return String(iso);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      const ss = String(d.getSeconds()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    }
    function clamp(n, a, b) { n = Number(n); if (Number.isNaN(n)) return a; return Math.min(b, Math.max(a, n)); }
    function getAdminName() {
      const c1 = W.DBAM?.currentUser?.name;
      const c2 = W.DBAM_CURRENT_ADMIN?.name;
      const c3 = safeLoad("dbam_current_user", null)?.name;
      return String(c1 || c2 || c3 || "관리자");
    }

    function ensureStyle() {
      if (document.getElementById("dbamMfaPolicyStyle")) return;
      const st = document.createElement("style");
      st.id = "dbamMfaPolicyStyle";
      st.textContent = `
        .mfa-grid{display:grid; grid-template-columns:360px minmax(0,1fr); gap:12px; align-items:flex-start;}
        .mfa-kv{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px;}
        .mfa-kv .label{font-size:11px; color:var(--muted); margin-bottom:4px;}
        .mfa-row{border:1px solid var(--line); border-radius:12px; padding:10px 12px;}
        .mfa-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
        .mfa-table{width:100%; border-collapse:collapse; font-size:12px;}
        .mfa-table th,.mfa-table td{padding:10px; border-bottom:1px solid var(--line); vertical-align:top;}
        .mfa-table th{background:var(--panel,#f8fafc); text-align:left; white-space:nowrap;}
        .mfa-scroll-x{overflow-x:auto; -webkit-overflow-scrolling:touch;}
        .mfa-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;}
        .mfa-mini-btn{padding:4px 8px; font-size:11px; line-height:1.1;}
        .mfa-ellipsis{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:260px;}
        .mfa-badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid var(--line);}
        .mfa-badge.ok{background:rgba(0,160,90,.10); border-color:rgba(0,160,90,.18); color:#0a7a4a;}
        .mfa-badge.warn{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.22); color:#a16207;}
        .mfa-badge.bad{background:rgba(255,0,0,.08); border-color:rgba(255,0,0,.18); color:#b30000;}
        .mfa-codebox{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
        .mfa-codebox input{min-width:180px;}
      `;
      document.head.appendChild(st);
    }

    // ---------- storage seed ----------
    function defaultPolicy() {
      return {
        enabled: true,

        enforceForAdmins: true,
        enforceForPrivileged: true,

        // 민감 액션(선택된 항목은 Step-up MFA 필요)
        requireForActions: [
          "권한/역할 변경",
          "정책 변경",
          "DB 반출/다운로드",
          "민감정보 조회(전체)",
          "응급 권한 요청 승인",
          "접속 허용 IP 변경"
        ],

        // Step-up 인증 유지
        stepUpDurationMin: 15,   // 인증 유지(분)
        stepUpScope: "GLOBAL",   // GLOBAL | ACTION (GLOBAL: 특수 권한 액션 전반, ACTION: 해당 액션만)

        // 등록 없으면 차단
        blockIfNotEnrolled: true,

        note: "MFA 정책"
      };
    }

    function seedUsersIfEmpty() {
      const existing = safeLoad(KEY_USERS, null);
      if (Array.isArray(existing) && existing.length) return existing;

      let base = [];
      const pwUsers = safeLoad(KEY_PW_USERS, null);
      const llUsers = safeLoad(KEY_LOGINLOCK_USERS, null);

      if (Array.isArray(pwUsers) && pwUsers.length) {
        base = pwUsers.map(u => ({
          accountId: u.accountId,
          name: u.name || "-",
          dept: u.dept || "-",
          team: u.team || "-",
          title: u.title || "-",
          status: u.status || "ACTIVE"
        }));
      } else if (Array.isArray(llUsers) && llUsers.length) {
        base = llUsers.map(u => ({
          accountId: u.accountId,
          name: u.name || "-",
          dept: u.dept || "-",
          team: u.team || "-",
          title: u.title || "-",
          status: u.status || "ACTIVE"
        }));
      } else if (Array.isArray(W.DBAM_USER_SAMPLE) && W.DBAM_USER_SAMPLE.length) {
        base = W.DBAM_USER_SAMPLE.map(u => ({
          accountId: String(u.id || u.accountId || ""),
          name: u.name || "-",
          dept: u.dept || "-",
          team: u.team || "-",
          title: u.title || "-",
          status: u.status || "ACTIVE"
        }));
      } else {
        base = [
          { accountId:"u1001", name:"홍길동", dept:"정보보안실", team:"DB보안팀", title:"대리", status:"ACTIVE" },
          { accountId:"u1002", name:"김감사", dept:"정보보안실", team:"감사팀",   title:"과장", status:"ACTIVE" },
          { accountId:"u1003", name:"박개발", dept:"플랫폼개발부", team:"API팀",  title:"사원", status:"ACTIVE" },
        ];
      }

      // 기본값: u1001을 관리자, u1002를 특수 권한 예시
      const users = base.map(u => {
        const id = String(u.accountId || "");
        const isAdmin = (id === "u1001");
        const isPriv = (id === "u1002");
        return {
          accountId: id,
          name: u.name || "-",
          dept: u.dept || "-",
          team: u.team || "-",
          title: u.title || "-",
          status: u.status || "ACTIVE",

          isAdmin: !!isAdmin,
          isPrivileged: !!isPriv,

          mfaEnrolled: (isAdmin || isPriv) ? true : false,
          mfaMethod: (isAdmin || isPriv) ? "TOTP" : "OFF", // TOTP | SMS | EMAIL | FIDO2 | OFF

          // 예외(필요 시 사용): bypassUntil, bypassReason
          bypassUntil: null,
          bypassReason: ""
        };
      });

      safeSave(KEY_USERS, users);
      return users;
    }

    function seedLogsIfEmpty() {
      const existing = safeLoad(KEY_LOGS, null);
      if (Array.isArray(existing) && existing.length) return existing;

      const seed = [
        { id: uid("mfalog"), at: nowISO(), actor: "관리자", accountId: "u1001", type: "POLICY", ip: "-", detail: "MFA 정책 초기 생성" },
        { id: uid("mfalog"), at: nowISO(), actor: "관리자", accountId: "u1002", type: "ENROLL", ip: "-", detail: "MFA 등록(샘플)" },
      ];
      safeSave(KEY_LOGS, seed);
      return seed;
    }

    function ensureSeed() {
      const p = safeLoad(KEY_POLICY, null);
      if (!p) safeSave(KEY_POLICY, defaultPolicy());
      const policy = safeLoad(KEY_POLICY, defaultPolicy());
      const users = seedUsersIfEmpty();
      const logs = seedLogsIfEmpty();
      const sessions = Array.isArray(safeLoad(KEY_SESSIONS, [])) ? safeLoad(KEY_SESSIONS, []) : [];
      return { policy, users, logs, sessions };
    }

    // ---------- logs ----------
    function pushLog(accountId, type, ip, detail, actor) {
      const logs = Array.isArray(safeLoad(KEY_LOGS, [])) ? safeLoad(KEY_LOGS, []) : [];
      logs.unshift({
        id: uid("mfalog"),
        at: nowISO(),
        actor: String(actor || getAdminName()),
        accountId: String(accountId || "-"),
        type: String(type || ""),
        ip: String(ip || "-"),
        detail: String(detail || "")
      });
      if (logs.length > 800) logs.length = 800;
      safeSave(KEY_LOGS, logs);
      return logs;
    }

    // ---------- sessions (step-up) ----------
    function pruneSessions() {
      const now = Date.now();
      let sessions = Array.isArray(safeLoad(KEY_SESSIONS, [])) ? safeLoad(KEY_SESSIONS, []) : [];
      const before = sessions.length;
      sessions = sessions.filter(s => {
        const t = s?.expiresAt ? new Date(s.expiresAt).getTime() : 0;
        return t && !Number.isNaN(t) && t > now;
      });
      if (sessions.length !== before) safeSave(KEY_SESSIONS, sessions);
      return sessions;
    }

    function hasValidSession(accountId, scope, actionName) {
      const sessions = pruneSessions();
      const now = Date.now();
      if (scope === "GLOBAL") {
        return sessions.some(s => s.accountId === accountId && s.scope === "GLOBAL" && new Date(s.expiresAt).getTime() > now);
      }
      // ACTION
      return sessions.some(s => s.accountId === accountId && s.scope === "ACTION" && s.action === actionName && new Date(s.expiresAt).getTime() > now);
    }

    function createSession(accountId, scope, actionName, minutes) {
      const sessions = pruneSessions();
      const expiresAt = new Date(Date.now() + clamp(minutes, 1, 240) * 60 * 1000).toISOString();
      const row = { id: uid("mfasess"), accountId, scope, action: (scope === "ACTION" ? actionName : "*"), verifiedAt: nowISO(), expiresAt };
      sessions.unshift(row);
      if (sessions.length > 300) sessions.length = 300;
      safeSave(KEY_SESSIONS, sessions);
      return row;
    }

    // ---------- policy evaluation ----------
    function isBypassActive(user) {
      if (!user?.bypassUntil) return false;
      const t = new Date(user.bypassUntil).getTime();
      if (!t || Number.isNaN(t)) return false;
      return Date.now() < t;
    }

    function isPrivilegedUser(user) {
      return !!user?.isAdmin || !!user?.isPrivileged;
    }

    function isMfaRequired(policy, user, actionName) {
      if (!policy?.enabled) return { required: false, reason: "정책 비활성" };
      if (!user) return { required: false, reason: "사용자 없음" };

      if (isBypassActive(user)) return { required: false, reason: `예외 적용(${fmtISO(user.bypassUntil)})` };

      const adminNeed = policy.enforceForAdmins && !!user.isAdmin;
      const privNeed  = policy.enforceForPrivileged && !!user.isPrivileged;
      const scopeNeed = adminNeed || privNeed;

      if (!scopeNeed) return { required: false, reason: "대상 아님" };

      const actions = Array.isArray(policy.requireForActions) ? policy.requireForActions : [];
      if (actions.length === 0) return { required: true, reason: "대상(액션 전체)" };

      if (actions.includes(actionName)) return { required: true, reason: "민감 액션" };
      return { required: false, reason: "민감 액션 아님" };
    }

    // ---------- MFA challenge (in-memory) ----------
    const pageState = {
      selectedAccountId: null,
      selectedAction: null,
      issuedCode: null,
      issuedTo: null,        // accountId
      issuedAt: null,
      issuedAction: null,
      issuedExpAt: null
    };

    function issueCode(user, actionName) {
      // 6-digit
      const code = String(Math.floor(100000 + Math.random() * 900000));
      const expAt = new Date(Date.now() + 5 * 60 * 1000).toISOString(); // 5분
      pageState.issuedCode = code;
      pageState.issuedTo = user.accountId;
      pageState.issuedAt = nowISO();
      pageState.issuedAction = actionName;
      pageState.issuedExpAt = expAt;

      pushLog(user.accountId, "CHALLENGE_ISSUE", "-", `MFA 코드 발급(${user.mfaMethod}) · 액션=${actionName} · 만료=${fmtISO(expAt)}`);
      return { code, expAt };
    }

    function verifyCode(user, actionName, inputCode, policy) {
      const exp = pageState.issuedExpAt ? new Date(pageState.issuedExpAt).getTime() : 0;
      const okContext =
        pageState.issuedTo === user.accountId &&
        pageState.issuedAction === actionName &&
        exp && !Number.isNaN(exp) && Date.now() <= exp;

      if (!okContext) {
        pushLog(user.accountId, "CHALLENGE_FAIL", "-", `검증 실패(컨텍스트/만료) · 액션=${actionName}`);
        return { ok: false, msg: "코드가 만료되었거나 컨텍스트가 일치하지 않습니다." };
      }

      if (String(inputCode || "").trim() !== String(pageState.issuedCode || "")) {
        pushLog(user.accountId, "CHALLENGE_FAIL", "-", `검증 실패(불일치) · 액션=${actionName}`);
        return { ok: false, msg: "코드가 일치하지 않습니다." };
      }

      // 성공 -> step-up 세션 생성
      const sess = createSession(user.accountId, policy.stepUpScope, actionName, policy.stepUpDurationMin);
      pushLog(user.accountId, "CHALLENGE_OK", "-", `검증 성공 · 세션만료=${fmtISO(sess.expiresAt)} · scope=${sess.scope}`);

      // 1회성 코드 비움
      pageState.issuedCode = null;
      pageState.issuedTo = null;
      pageState.issuedAt = null;
      pageState.issuedAction = null;
      pageState.issuedExpAt = null;

      return { ok: true, session: sess };
    }

    // ---------- UI ----------
    function badgeEnabled(on) {
      return on
        ? `<span class="mfa-badge ok"><i class="fa-solid fa-shield-halved"></i> ENABLED</span>`
        : `<span class="mfa-badge.warn"><i class="fa-solid fa-circle-minus"></i> DISABLED</span>`;
    }
    function badgeYesNo(on, yesLabel, noLabel) {
      return on
        ? `<span class="mfa-badge ok"><i class="fa-solid fa-circle-check"></i> ${esc(yesLabel || "ON")}</span>`
        : `<span class="mfa-badge.warn"><i class="fa-solid fa-circle-minus"></i> ${esc(noLabel || "OFF")}</span>`;
    }
    function badgeRole(user) {
      const arr = [];
      if (user.isAdmin) arr.push(`<span class="mfa-badge ok"><i class="fa-solid fa-user-shield"></i> ADMIN</span>`);
      if (user.isPrivileged) arr.push(`<span class="mfa-badge.warn"><i class="fa-solid fa-star"></i> PRIV</span>`);
      if (!arr.length) arr.push(`<span class="mfa-badge.warn"><i class="fa-solid fa-user"></i> USER</span>`);
      return arr.join(" ");
    }
    function badgeMfa(user) {
      if (!user.mfaEnrolled || user.mfaMethod === "OFF") return `<span class="mfa-badge.bad"><i class="fa-solid fa-lock-open"></i> 미등록</span>`;
      return `<span class="mfa-badge.ok"><i class="fa-solid fa-lock"></i> ${esc(user.mfaMethod)}</span>`;
    }

    const ACTIONS_DEFAULT = [
      "권한/역할 변경",
      "정책 변경",
      "DB 반출/다운로드",
      "민감정보 조회(전체)",
      "응급 권한 요청 승인",
      "접속 허용 IP 변경",
      "계정 잠금 해제",
      "비밀번호 초기화"
    ];

    function templateHtml() {
      return `
        <div id="mfaPolicyPage" class="emg-page" style="width:100%; max-width:100%; overflow-x:hidden;">
          <div class="admin-card" style="padding:12px 14px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-primary" data-mfa-act="save"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
              <button class="btn btn-outline" data-mfa-act="reset"><i class="fa-solid fa-rotate"></i> 초기화</button>
              <button class="btn btn-outline" data-mfa-act="export"><i class="fa-solid fa-file-export"></i> 내보내기</button>
              <label class="btn btn-outline" style="cursor:pointer; margin:0;">
                <i class="fa-solid fa-file-import"></i> 가져오기
                <input type="file" id="mfaImportFile" accept="application/json" style="display:none;" />
              </label>
              <button class="btn btn-outline" data-mfa-act="clearLogs"><i class="fa-solid fa-trash"></i> 로그 비우기</button>
            </div>
            <div class="admin-footer">관리자/특수 권한 계정에 대해 민감 액션 수행 시 MFA를 강제하고, Step-up 인증 이력을 관리합니다.</div>
          </div>

          <div class="mfa-grid">
            <div style="display:flex; flex-direction:column; gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                  <div style="font-weight:700;"><i class="fa-solid fa-sliders"></i> MFA 정책</div>
                  <div id="mfaEnabledBadge"></div>
                </div>

                <div class="mfa-kv" style="margin-top:10px;">
                  <div>
                    <div class="label">정책 사용</div>
                    <select id="mfaEnabled" class="export-input">
                      <option value="true">ENABLED</option>
                      <option value="false">DISABLED</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">미등록 시 차단</div>
                    <select id="mfaBlockIfNotEnrolled" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>

                  <div>
                    <div class="label">관리자 계정 강제</div>
                    <select id="mfaForAdmins" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>
                  <div>
                    <div class="label">특수 권한 강제</div>
                    <select id="mfaForPriv" class="export-input">
                      <option value="true">ON</option>
                      <option value="false">OFF</option>
                    </select>
                  </div>

                  <div>
                    <div class="label">Step-up 유지(분)</div>
                    <input id="mfaStepUpMin" type="number" min="1" max="240" class="export-input" placeholder="예: 15" />
                  </div>
                  <div>
                    <div class="label">유지 범위</div>
                    <select id="mfaStepUpScope" class="export-input">
                      <option value="GLOBAL">GLOBAL (특수 권한 액션 전반)</option>
                      <option value="ACTION">ACTION (해당 액션만)</option>
                    </select>
                  </div>

                  <div style="grid-column:1 / -1;">
                    <div class="label">민감 액션 선택</div>
                    <div id="mfaActionChecklist" class="mfa-row" style="padding:10px 12px;"></div>
                  </div>
                </div>

                <div class="admin-footer" style="margin-top:10px;">
                  민감 액션으로 선택된 항목은 관리자/특수 권한 계정이 수행할 때 Step-up MFA가 요구됩니다.
                </div>
              </div>

              <div class="admin-card" style="padding:12px 14px;">
                <div style="font-weight:700;"><i class="fa-solid fa-vial"></i> Step-up 인증 시뮬레이션</div>

                <div class="mfa-kv" style="margin-top:10px;">
                  <div style="grid-column:1 / -1;">
                    <div class="label">대상 계정</div>
                    <select id="mfaSimUser" class="export-input"></select>
                  </div>

                  <div style="grid-column:1 / -1;">
                    <div class="label">액션</div>
                    <select id="mfaSimAction" class="export-input"></select>
                  </div>

                  <div>
                    <div class="label">상태</div>
                    <div id="mfaSimState" style="margin-top:6px;"></div>
                  </div>
                  <div>
                    <div class="label">세션</div>
                    <div id="mfaSimSession" style="margin-top:6px;"></div>
                  </div>

                  <div style="grid-column:1 / -1;">
                    <div class="label">코드(6자리)</div>
                    <div class="mfa-codebox">
                      <input id="mfaCodeInput" class="export-input mfa-mono" placeholder="예: 123456" />
                      <button class="btn btn-outline mfa-mini-btn" data-mfa-sim="issue"><i class="fa-solid fa-paper-plane"></i> 코드 발급</button>
                      <button class="btn btn-outline mfa-mini-btn" data-mfa-sim="verify"><i class="fa-solid fa-circle-check"></i> 검증</button>
                    </div>
                    <div class="admin-footer" style="margin-top:6px;">
                      발급된 코드는 이 화면에서만 확인됩니다. (저장되지 않음)
                      <span id="mfaIssuedHint" class="mfa-mono" style="margin-left:8px;"></span>
                    </div>
                  </div>

                  <div style="grid-column:1 / -1;">
                    <div class="mfa-actions">
                      <button class="btn btn-outline mfa-mini-btn" data-mfa-sim="attempt"><i class="fa-solid fa-play"></i> 액션 수행 시도</button>
                      <button class="btn btn-outline mfa-mini-btn" data-mfa-sim="clearSession"><i class="fa-solid fa-eraser"></i> 세션 초기화</button>
                    </div>
                  </div>
                </div>

                <div id="mfaSimResult" class="mfa-row" style="margin-top:10px; color:var(--muted);">
                  선택 후 “액션 수행 시도”를 눌러 요구 여부를 확인하세요.
                </div>
              </div>
            </div>

            <div style="display:flex; flex-direction:column; gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                  <div style="font-weight:700;"><i class="fa-solid fa-users"></i> 대상 계정(MFA/권한)</div>
                  <div class="mfa-actions">
                    <input id="mfaUserSearch" class="export-input" style="width:220px;" placeholder="검색: 계정/이름/부서" />
                    <select id="mfaRoleFilter" class="export-input" style="width:170px;">
                      <option value="">전체</option>
                      <option value="ADMIN">ADMIN</option>
                      <option value="PRIV">PRIV</option>
                      <option value="TARGET">대상(ADMIN/PRIV)</option>
                      <option value="NON">일반</option>
                    </select>
                  </div>
                </div>

                <div id="mfaUserSummary" class="admin-footer" style="margin-top:8px;"></div>

                <div class="mfa-scroll-x" style="margin-top:8px;">
                  <table class="mfa-table">
                    <thead>
                      <tr>
                        <th>계정</th>
                        <th>이름</th>
                        <th>부서/팀</th>
                        <th>권한</th>
                        <th>MFA</th>
                        <th>예외</th>
                        <th>조치</th>
                      </tr>
                    </thead>
                    <tbody id="mfaUsersTbody"></tbody>
                  </table>
                </div>
              </div>

              <div class="admin-card" style="padding:12px 14px;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                  <div style="font-weight:700;"><i class="fa-solid fa-clock-rotate-left"></i> MFA 이력</div>
                  <div class="mfa-actions">
                    <select id="mfaLogTypeFilter" class="export-input" style="width:200px;">
                      <option value="">전체</option>
                      <option value="POLICY">POLICY</option>
                      <option value="ENROLL">ENROLL</option>
                      <option value="UNENROLL">UNENROLL</option>
                      <option value="CHALLENGE_ISSUE">CHALLENGE_ISSUE</option>
                      <option value="CHALLENGE_OK">CHALLENGE_OK</option>
                      <option value="CHALLENGE_FAIL">CHALLENGE_FAIL</option>
                      <option value="ATTEMPT_ALLOW">ATTEMPT_ALLOW</option>
                      <option value="ATTEMPT_BLOCK">ATTEMPT_BLOCK</option>
                      <option value="BYPASS_SET">BYPASS_SET</option>
                      <option value="BYPASS_CLEAR">BYPASS_CLEAR</option>
                      <option value="SESSION_CLEAR">SESSION_CLEAR</option>
                    </select>
                  </div>
                </div>

                <div class="mfa-scroll-x" style="margin-top:8px;">
                  <table class="mfa-table">
                    <thead>
                      <tr>
                        <th>시간</th>
                        <th>행위자</th>
                        <th>계정</th>
                        <th>유형</th>
                        <th>IP</th>
                        <th>상세</th>
                      </tr>
                    </thead>
                    <tbody id="mfaLogsTbody"></tbody>
                  </table>
                </div>
              </div>

            </div>
          </div>
        </div>
      `;
    }

    function renderActionChecklist(mountEl, policy) {
      const wrap = mountEl.querySelector("#mfaActionChecklist");
      if (!wrap) return;

      const selected = new Set(Array.isArray(policy.requireForActions) ? policy.requireForActions : []);
      const items = ACTIONS_DEFAULT.slice();

      wrap.innerHTML = `
        <div style="display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:6px;">
          ${items.map(a => {
            const checked = selected.has(a) ? "checked" : "";
            return `
              <label style="display:flex; gap:8px; align-items:center; font-size:12px;">
                <input type="checkbox" class="mfaActionChk" value="${esc(a)}" ${checked} />
                <span>${esc(a)}</span>
              </label>
            `;
          }).join("")}
        </div>
      `;

      wrap.querySelectorAll(".mfaActionChk").forEach(chk => {
        chk.addEventListener("change", () => {
          const chosen = Array.from(wrap.querySelectorAll(".mfaActionChk"))
            .filter(x => x.checked)
            .map(x => x.value);

          const p = safeLoad(KEY_POLICY, defaultPolicy());
          p.requireForActions = chosen;
          safeSave(KEY_POLICY, p);
          pushLog("-", "POLICY", "-", `민감 액션 변경: ${chosen.join(", ") || "(없음)"}`);
          renderAll(mountEl);
        });
      });
    }

    function renderAll(mountEl) {
      const policy = safeLoad(KEY_POLICY, defaultPolicy());
      let users = Array.isArray(safeLoad(KEY_USERS, [])) ? safeLoad(KEY_USERS, []) : [];
      const logs = Array.isArray(safeLoad(KEY_LOGS, [])) ? safeLoad(KEY_LOGS, []) : [];
      pruneSessions();

      // policy badge & fields
      const badgeEl = mountEl.querySelector("#mfaEnabledBadge");
      if (badgeEl) badgeEl.innerHTML = badgeEnabled(!!policy.enabled);

      const setVal = (id, v) => { const el = mountEl.querySelector(id); if (el) el.value = String(v ?? ""); };
      setVal("#mfaEnabled", policy.enabled ? "true" : "false");
      setVal("#mfaBlockIfNotEnrolled", policy.blockIfNotEnrolled ? "true" : "false");
      setVal("#mfaForAdmins", policy.enforceForAdmins ? "true" : "false");
      setVal("#mfaForPriv", policy.enforceForPrivileged ? "true" : "false");
      setVal("#mfaStepUpMin", policy.stepUpDurationMin);
      setVal("#mfaStepUpScope", policy.stepUpScope);

      renderActionChecklist(mountEl, policy);

      // sim selects
      const simUserSel = mountEl.querySelector("#mfaSimUser");
      if (simUserSel) {
        const cur = pageState.selectedAccountId || simUserSel.value || "";
        simUserSel.innerHTML = users.map(u => {
          const label = `${u.accountId} · ${u.name} (${u.dept})`;
          return `<option value="${esc(u.accountId)}">${esc(label)}</option>`;
        }).join("");
        const chosen = (cur && users.some(u => u.accountId === cur)) ? cur : (users[0]?.accountId || "");
        simUserSel.value = chosen;
        pageState.selectedAccountId = chosen;
      }

      const simActionSel = mountEl.querySelector("#mfaSimAction");
      if (simActionSel) {
        const curA = pageState.selectedAction || simActionSel.value || "";
        simActionSel.innerHTML = ACTIONS_DEFAULT.map(a => `<option value="${esc(a)}">${esc(a)}</option>`).join("");
        const chosenA = curA && ACTIONS_DEFAULT.includes(curA) ? curA : ACTIONS_DEFAULT[0];
        simActionSel.value = chosenA;
        pageState.selectedAction = chosenA;
      }

      const simUser = users.find(u => u.accountId === pageState.selectedAccountId) || users[0];
      const actionName = pageState.selectedAction || ACTIONS_DEFAULT[0];

      // sim state / session
      const stateEl = mountEl.querySelector("#mfaSimState");
      if (stateEl && simUser) {
        stateEl.innerHTML = `${badgeRole(simUser)} <span style="margin-left:6px;"></span>${badgeMfa(simUser)}`;
      }
      const sessEl = mountEl.querySelector("#mfaSimSession");
      if (sessEl && simUser) {
        const has = hasValidSession(simUser.accountId, policy.stepUpScope, actionName);
        sessEl.innerHTML = has
          ? `<span class="mfa-badge.ok"><i class="fa-solid fa-hourglass-half"></i> VALID</span>`
          : `<span class="mfa-badge.warn"><i class="fa-solid fa-hourglass-end"></i> NONE</span>`;
      }

      // issued hint
      const hint = mountEl.querySelector("#mfaIssuedHint");
      if (hint) {
        if (pageState.issuedTo && pageState.issuedExpAt) {
          hint.textContent = `발급됨: ${pageState.issuedTo} · 만료: ${fmtISO(pageState.issuedExpAt)}`;
        } else {
          hint.textContent = "";
        }
      }

      // users filter render
      const q = String(mountEl.querySelector("#mfaUserSearch")?.value || "").trim().toLowerCase();
      const rf = String(mountEl.querySelector("#mfaRoleFilter")?.value || "").trim();

      let filtered = users.slice();
      if (rf) {
        filtered = filtered.filter(u => {
          if (rf === "ADMIN") return !!u.isAdmin;
          if (rf === "PRIV") return !!u.isPrivileged;
          if (rf === "TARGET") return !!u.isAdmin || !!u.isPrivileged;
          if (rf === "NON") return !u.isAdmin && !u.isPrivileged;
          return true;
        });
      }
      if (q) {
        filtered = filtered.filter(u => {
          const hay = `${u.accountId} ${u.name} ${u.dept} ${u.team} ${u.title}`.toLowerCase();
          return hay.includes(q);
        });
      }

      const tgtCnt = users.filter(u => isPrivilegedUser(u)).length;
      const enrCnt = users.filter(u => isPrivilegedUser(u) && u.mfaEnrolled && u.mfaMethod !== "OFF").length;
      const sumEl = mountEl.querySelector("#mfaUserSummary");
      if (sumEl) sumEl.textContent = `전체 ${users.length}명 · 대상(ADMIN/PRIV) ${tgtCnt} · MFA 등록 ${enrCnt}`;

      const tbody = mountEl.querySelector("#mfaUsersTbody");
      if (tbody) {
        tbody.innerHTML = filtered.length ? filtered.map(u => {
          const deptTeam = `${esc(u.dept || "-")}${u.team ? " / " + esc(u.team) : ""}`;
          const bypass = isBypassActive(u)
            ? `<span class="mfa-badge.warn"><i class="fa-solid fa-person-circle-minus"></i> ${esc(fmtISO(u.bypassUntil))}</span>`
            : `<span class="mfa-badge.ok"><i class="fa-solid fa-circle-check"></i> 없음</span>`;

          const actions = `
            <div class="mfa-actions">
              <button class="btn btn-outline mfa-mini-btn" data-mfa-user-act="select" data-mfa-id="${esc(u.accountId)}"><i class="fa-solid fa-bullseye"></i> 선택</button>

              <button class="btn btn-outline mfa-mini-btn" data-mfa-user-act="toggleAdmin" data-mfa-id="${esc(u.accountId)}">
                <i class="fa-solid fa-user-shield"></i> ADMIN
              </button>
              <button class="btn btn-outline mfa-mini-btn" data-mfa-user-act="togglePriv" data-mfa-id="${esc(u.accountId)}">
                <i class="fa-solid fa-star"></i> PRIV
              </button>

              ${u.mfaEnrolled && u.mfaMethod !== "OFF"
                ? `<button class="btn btn-outline mfa-mini-btn" data-mfa-user-act="unenroll" data-mfa-id="${esc(u.accountId)}"><i class="fa-solid fa-lock-open"></i> 해제</button>`
                : `<button class="btn btn-outline mfa-mini-btn" data-mfa-user-act="enroll" data-mfa-id="${esc(u.accountId)}"><i class="fa-solid fa-lock"></i> 등록</button>`
              }

              <button class="btn btn-outline mfa-mini-btn" data-mfa-user-act="bypass" data-mfa-id="${esc(u.accountId)}"><i class="fa-solid fa-person-circle-minus"></i> 예외</button>
            </div>
          `;

          return `
            <tr>
              <td class="mfa-mono">${esc(u.accountId)}</td>
              <td>${esc(u.name)}</td>
              <td class="mfa-ellipsis" title="${esc(deptTeam)}">${deptTeam}</td>
              <td>${badgeRole(u)}</td>
              <td>${badgeMfa(u)}</td>
              <td>${bypass}</td>
              <td>${actions}</td>
            </tr>
          `;
        }).join("") : `<tr><td colspan="7" style="padding:14px; color:var(--muted);">조건에 맞는 계정이 없습니다.</td></tr>`;
      }

      // logs filter render
      const lt = String(mountEl.querySelector("#mfaLogTypeFilter")?.value || "").trim();
      let fLogs = logs.slice();
      if (lt) fLogs = fLogs.filter(l => String(l.type || "") === lt);

      const logBody = mountEl.querySelector("#mfaLogsTbody");
      if (logBody) {
        logBody.innerHTML = fLogs.length ? fLogs.slice(0, 250).map(l => `
          <tr>
            <td class="mfa-mono">${esc(fmtISO(l.at))}</td>
            <td>${esc(l.actor || "-")}</td>
            <td class="mfa-mono">${esc(l.accountId)}</td>
            <td class="mfa-mono">${esc(l.type)}</td>
            <td class="mfa-mono">${esc(l.ip || "-")}</td>
            <td class="mfa-ellipsis" title="${esc(l.detail)}">${esc(l.detail)}</td>
          </tr>
        `).join("") : `<tr><td colspan="6" style="padding:14px; color:var(--muted);">이력이 없습니다.</td></tr>`;
      }
    }

    // ---------- export/import ----------
    function downloadJson(filename, payload) {
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
    function readJsonFile(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => { try { resolve(JSON.parse(String(fr.result || ""))); } catch (e) { reject(e); } };
        fr.onerror = reject;
        fr.readAsText(file);
      });
    }

    // ---------- bind ----------
    function bindEvents(mountEl) {
      // top actions
      mountEl.querySelector('[data-mfa-act="save"]')?.addEventListener("click", () => {
        const policy = safeLoad(KEY_POLICY, defaultPolicy());
        policy.enabled = mountEl.querySelector("#mfaEnabled")?.value === "true";
        policy.blockIfNotEnrolled = mountEl.querySelector("#mfaBlockIfNotEnrolled")?.value === "true";
        policy.enforceForAdmins = mountEl.querySelector("#mfaForAdmins")?.value === "true";
        policy.enforceForPrivileged = mountEl.querySelector("#mfaForPriv")?.value === "true";
        policy.stepUpDurationMin = clamp(mountEl.querySelector("#mfaStepUpMin")?.value, 1, 240);
        policy.stepUpScope = String(mountEl.querySelector("#mfaStepUpScope")?.value || "GLOBAL") === "ACTION" ? "ACTION" : "GLOBAL";

        // requireForActions는 체크박스 change에서 즉시 저장됨(여기서는 그대로 유지)
        safeSave(KEY_POLICY, policy);
        pushLog("-", "POLICY", "-", `정책 저장: enabled=${policy.enabled}, admins=${policy.enforceForAdmins}, priv=${policy.enforceForPrivileged}, blockNoEnroll=${policy.blockIfNotEnrolled}, stepUp=${policy.stepUpDurationMin}m, scope=${policy.stepUpScope}`);
        toast("정책이 저장되었습니다.");
        renderAll(mountEl);
      });

      mountEl.querySelector('[data-mfa-act="reset"]')?.addEventListener("click", () => {
        const ok = confirm("MFA 정책/계정 플래그/로그/세션을 초기화할까요?");
        if (!ok) return;
        safeSave(KEY_POLICY, defaultPolicy());
        safeSave(KEY_USERS, []);
        safeSave(KEY_LOGS, []);
        safeSave(KEY_SESSIONS, []);
        ensureSeed();
        toast("초기화 완료");
        renderAll(mountEl);
      });

      mountEl.querySelector('[data-mfa-act="export"]')?.addEventListener("click", () => {
        const payload = {
          exportedAt: nowISO(),
          policy: safeLoad(KEY_POLICY, defaultPolicy()),
          users: safeLoad(KEY_USERS, []),
          logs: safeLoad(KEY_LOGS, []),
          sessions: safeLoad(KEY_SESSIONS, [])
        };
        downloadJson(`dbam_mfa_policy_export_${Date.now()}.json`, payload);
      });

      const importFile = mountEl.querySelector("#mfaImportFile");
      if (importFile) {
        importFile.addEventListener("change", async () => {
          const f = importFile.files?.[0];
          if (!f) return;
          try {
            const json = await readJsonFile(f);
            if (json && typeof json === "object") {
              if (json.policy) safeSave(KEY_POLICY, json.policy);
              if (Array.isArray(json.users)) safeSave(KEY_USERS, json.users);
              if (Array.isArray(json.logs)) safeSave(KEY_LOGS, json.logs);
              if (Array.isArray(json.sessions)) safeSave(KEY_SESSIONS, json.sessions);
              toast("가져오기 완료");
              renderAll(mountEl);
            } else {
              toast("가져오기 실패: 형식이 올바르지 않습니다.");
            }
          } catch (e) {
            console.warn(e);
            toast("가져오기 실패: 파일을 확인하세요.");
          } finally {
            importFile.value = "";
          }
        });
      }

      mountEl.querySelector('[data-mfa-act="clearLogs"]')?.addEventListener("click", () => {
        const ok = confirm("로그를 모두 비울까요?");
        if (!ok) return;
        safeSave(KEY_LOGS, []);
        toast("로그를 비웠습니다.");
        renderAll(mountEl);
      });

      // filters
      mountEl.querySelector("#mfaUserSearch")?.addEventListener("input", () => renderAll(mountEl));
      mountEl.querySelector("#mfaRoleFilter")?.addEventListener("change", () => renderAll(mountEl));
      mountEl.querySelector("#mfaLogTypeFilter")?.addEventListener("change", () => renderAll(mountEl));

      // sim selects
      mountEl.querySelector("#mfaSimUser")?.addEventListener("change", () => {
        pageState.selectedAccountId = mountEl.querySelector("#mfaSimUser")?.value || null;
        renderAll(mountEl);
      });
      mountEl.querySelector("#mfaSimAction")?.addEventListener("change", () => {
        pageState.selectedAction = mountEl.querySelector("#mfaSimAction")?.value || null;
        renderAll(mountEl);
      });

      // sim buttons
      mountEl.querySelectorAll("[data-mfa-sim]")?.forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-mfa-sim");
          const policy = safeLoad(KEY_POLICY, defaultPolicy());
          const users = Array.isArray(safeLoad(KEY_USERS, [])) ? safeLoad(KEY_USERS, []) : [];

          const accountId = mountEl.querySelector("#mfaSimUser")?.value || "";
          const actionName = mountEl.querySelector("#mfaSimAction")?.value || ACTIONS_DEFAULT[0];
          const user = users.find(u => u.accountId === accountId);
          if (!user) return;

          const resultEl = mountEl.querySelector("#mfaSimResult");

          if (act === "issue") {
            if (!user.mfaEnrolled || user.mfaMethod === "OFF") {
              toast("MFA 미등록 계정입니다.");
              if (resultEl) resultEl.innerHTML = `<span class="mfa-badge.bad"><i class="fa-solid fa-circle-xmark"></i> 코드 발급 불가</span> MFA 미등록`;
              return renderAll(mountEl);
            }
            const r = issueCode(user, actionName);
            toast("코드가 발급되었습니다.");
            if (resultEl) {
              resultEl.innerHTML = `
                <div>${badgeYesNo(true, "CODE ISSUED", "")} <span class="mfa-mono" style="margin-left:8px;">${esc(r.code)}</span></div>
                <div class="admin-footer" style="margin-top:6px;">만료: ${esc(fmtISO(r.expAt))}</div>
              `;
            }
            return renderAll(mountEl);
          }

          if (act === "verify") {
            const code = String(mountEl.querySelector("#mfaCodeInput")?.value || "").trim();
            if (!code) return toast("코드를 입력하세요.");
            const r = verifyCode(user, actionName, code, policy);
            if (!r.ok) {
              toast(r.msg || "검증 실패");
              if (resultEl) resultEl.innerHTML = `<span class="mfa-badge.bad"><i class="fa-solid fa-circle-xmark"></i> VERIFY FAIL</span> ${esc(r.msg || "")}`;
            } else {
              toast("검증 성공");
              if (resultEl) resultEl.innerHTML = `<span class="mfa-badge.ok"><i class="fa-solid fa-circle-check"></i> VERIFY OK</span> 세션 만료: <span class="mfa-mono">${esc(fmtISO(r.session.expiresAt))}</span>`;
              mountEl.querySelector("#mfaCodeInput").value = "";
            }
            return renderAll(mountEl);
          }

          if (act === "attempt") {
            const evalr = isMfaRequired(policy, user, actionName);

            // 대상+민감일 때 세션 체크
            if (evalr.required) {
              if (!user.mfaEnrolled || user.mfaMethod === "OFF") {
                if (policy.blockIfNotEnrolled) {
                  pushLog(user.accountId, "ATTEMPT_BLOCK", "-", `차단: MFA 미등록 · 액션=${actionName}`);
                  if (resultEl) resultEl.innerHTML = `<span class="mfa-badge.bad"><i class="fa-solid fa-ban"></i> BLOCK</span> MFA 미등록(차단) · ${esc(actionName)}`;
                  toast("차단: MFA 미등록");
                  return renderAll(mountEl);
                }
              }

              const okSess = hasValidSession(user.accountId, policy.stepUpScope, actionName);
              if (!okSess) {
                pushLog(user.accountId, "ATTEMPT_BLOCK", "-", `차단: Step-up 필요 · 액션=${actionName}`);
                if (resultEl) resultEl.innerHTML = `<span class="mfa-badge.warn"><i class="fa-solid fa-lock"></i> STEP-UP 필요</span> 코드 발급/검증 후 재시도 · ${esc(actionName)}`;
                toast("Step-up MFA 필요");
                return renderAll(mountEl);
              }
            }

            pushLog(user.accountId, "ATTEMPT_ALLOW", "-", `허용: 액션 수행 · 액션=${actionName} · reason=${evalr.reason}`);
            if (resultEl) resultEl.innerHTML = `<span class="mfa-badge.ok"><i class="fa-solid fa-circle-check"></i> ALLOW</span> 액션 수행 허용 · ${esc(actionName)} <span style="color:var(--muted);">(${esc(evalr.reason)})</span>`;
            toast("허용");
            return renderAll(mountEl);
          }

          if (act === "clearSession") {
            // 해당 사용자 세션 삭제
            let sessions = Array.isArray(safeLoad(KEY_SESSIONS, [])) ? safeLoad(KEY_SESSIONS, []) : [];
            const before = sessions.length;
            sessions = sessions.filter(s => s.accountId !== user.accountId);
            safeSave(KEY_SESSIONS, sessions);
            pushLog(user.accountId, "SESSION_CLEAR", "-", `세션 초기화(${before - sessions.length}건)`);
            toast("세션을 초기화했습니다.");
            if (resultEl) resultEl.innerHTML = `<span class="mfa-badge.warn"><i class="fa-solid fa-eraser"></i> SESSION CLEARED</span>`;
            return renderAll(mountEl);
          }
        });
      });

      // user actions (delegation)
      mountEl.addEventListener("click", (e) => {
        const btn = e.target.closest?.("[data-mfa-user-act]");
        if (!btn) return;

        const act = btn.getAttribute("data-mfa-user-act");
        const id = btn.getAttribute("data-mfa-id");
        if (!id) return;

        const users = Array.isArray(safeLoad(KEY_USERS, [])) ? safeLoad(KEY_USERS, []) : [];
        const u = users.find(x => x.accountId === id);
        if (!u) return;

        if (act === "select") {
          pageState.selectedAccountId = id;
          const sel = mountEl.querySelector("#mfaSimUser");
          if (sel) sel.value = id;
          toast(`선택됨: ${id}`);
          safeSave(KEY_USERS, users);
          return renderAll(mountEl);
        }

        if (act === "toggleAdmin") {
          u.isAdmin = !u.isAdmin;
          pushLog(u.accountId, "ROLE", "-", `ADMIN 토글 -> ${u.isAdmin}`);
          safeSave(KEY_USERS, users);
          return renderAll(mountEl);
        }

        if (act === "togglePriv") {
          u.isPrivileged = !u.isPrivileged;
          pushLog(u.accountId, "ROLE", "-", `PRIV 토글 -> ${u.isPrivileged}`);
          safeSave(KEY_USERS, users);
          return renderAll(mountEl);
        }

        if (act === "enroll") {
          const method = prompt("MFA 방법을 입력하세요. (TOTP/SMS/EMAIL/FIDO2)", "TOTP") || "TOTP";
          const m = String(method).toUpperCase();
          const allowed = ["TOTP", "SMS", "EMAIL", "FIDO2"];
          u.mfaEnrolled = allowed.includes(m);
          u.mfaMethod = u.mfaEnrolled ? m : "OFF";
          pushLog(u.accountId, "ENROLL", "-", `MFA 등록: ${u.mfaMethod}`);
          safeSave(KEY_USERS, users);
          toast("등록 완료");
          return renderAll(mountEl);
        }

        if (act === "unenroll") {
          const ok = confirm("MFA 등록을 해제할까요?");
          if (!ok) return;
          u.mfaEnrolled = false;
          u.mfaMethod = "OFF";
          pushLog(u.accountId, "UNENROLL", "-", "MFA 해제");
          safeSave(KEY_USERS, users);
          toast("해제 완료");
          return renderAll(mountEl);
        }

        if (act === "bypass") {
          const mode = prompt("예외 설정: minutes(예: 30) / clear 입력", "30");
          const v = String(mode || "").trim().toLowerCase();
          if (!v) return;

          if (v === "clear") {
            u.bypassUntil = null;
            u.bypassReason = "";
            pushLog(u.accountId, "BYPASS_CLEAR", "-", "예외 해제");
            safeSave(KEY_USERS, users);
            toast("예외 해제");
            return renderAll(mountEl);
          }

          const mins = clamp(v, 1, 240);
          const reason = prompt("예외 사유(선택)", "긴급 작업") || "";
          u.bypassUntil = new Date(Date.now() + mins * 60 * 1000).toISOString();
          u.bypassReason = reason;
          pushLog(u.accountId, "BYPASS_SET", "-", `예외 설정 ${mins}분 · until=${fmtISO(u.bypassUntil)} · ${reason ? "reason=" + reason : ""}`);
          safeSave(KEY_USERS, users);
          toast("예외 설정 완료");
          return renderAll(mountEl);
        }
      }, true);
    }

    // ---------- main render ----------
    function renderDbamMfaPolicyPage(mountEl) {
      if (!mountEl) return;
      ensureStyle();
      ensureSeed();

      mountEl.innerHTML = templateHtml();
      bindEvents(mountEl);
      renderAll(mountEl);

      // 예외/세션 만료 반영(페이지 열려있는 동안만)
      try {
        setInterval(() => { try { renderAll(mountEl); } catch (_) {} }, 5000);
      } catch (_) {}
    }

    W.DBAM.renderDbamMfaPolicyPage = renderDbamMfaPolicyPage;

    // ---------- Admin open + card click (authPolicy) ----------
    const mfaPolicyAdmin = {
      open() {
        const titleEl = document.getElementById("adminTitle");
        const descEl  = document.getElementById("adminDesc");
        const bodyEl  = document.getElementById("adminBody");
        if (!titleEl || !descEl || !bodyEl) return;

        try {
          W.admin.current = "authPolicy";
          document.querySelectorAll(".admin-nav button").forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.section === "authPolicy");
          });
        } catch (_) {}

        titleEl.innerHTML = '<i class="fa-solid fa-shield-keyhole"></i> MFA 적용 정책 (관리자/특수 권한)';
        descEl.textContent = "관리자/특수 권한 계정의 민감 액션 수행 시 Step-up MFA를 강제하고, 등록/예외/이력을 관리합니다.";

        W.DBAM.renderDbamMfaPolicyPage(bodyEl);
      }
    };
    W.mfaPolicyAdmin = mfaPolicyAdmin;

    // 카드 클릭 -> open
    document.addEventListener("click", (e) => {
      const card = e.target.closest?.("#adminBody .admin-card.admin-card-clickable");
      if (!card) return;
      if (!W.admin || W.admin.current !== "authPolicy") return;

      const h4 = card.querySelector("h4");
      const title = (h4?.textContent || "").trim();
      if (!title.includes("MFA 적용 정책")) return;

      e.preventDefault();
      e.stopPropagation();
      mfaPolicyAdmin.open();
    }, true);

  })(); // end mfaPolicy

  
  /* ------------------------------------------------------------------
   * 공용계정 사용 사유·승인 (sharedAccountReason)
   *  - 요청 등록(샘플 생성) / 목록 필터 / 상세 / 결재(진행·승인·반려) / 사용 시작·종료 / 내보내기
   *  - localStorage 저장 (새로고침해도 유지)
   * ------------------------------------------------------------------ */
  const W = window;
  const sharedAccountReasonAdmin = {
    _storeKey: 'dbam_sharedAccountReason_v1',
    _boundKey: 'sharedAccountReasonBound',
    state: {
      selectedId: null,
      filters: { status: 'ALL', env: 'ALL', accountId: 'ALL', q: '' }
    },

    // ---- utils ----
    _pad(n) { return String(n).padStart(2, '0'); },
    _nowLocal() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = this._pad(d.getMonth() + 1);
      const dd = this._pad(d.getDate());
      const hh = this._pad(d.getHours());
      const mi = this._pad(d.getMinutes());
      const ss = this._pad(d.getSeconds());
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    },
    _esc(s) {
      const v = (s === null || s === undefined) ? '' : String(s);
      return v
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    },
    _uuid(prefix) {
      const d = new Date();
      const y = d.getFullYear();
      const m = this._pad(d.getMonth() + 1);
      const day = this._pad(d.getDate());
      const raw = `${prefix || 'SA'}-${y}${m}${day}-` + Math.random().toString(16).slice(2, 8).toUpperCase();
      return raw;
    },

    _statusColor(st) {
      const map = {
        '결재대기': { bg: '#fff7ed', fg: '#9a3412' },
        '결재중'  : { bg: '#eff6ff', fg: '#1d4ed8' },
        '승인'    : { bg: '#ecfdf5', fg: '#047857' },
        '반려'    : { bg: '#fef2f2', fg: '#b91c1c' },
        '취소'    : { bg: '#f3f4f6', fg: '#374151' },
        '사용중'  : { bg: '#f0f9ff', fg: '#0369a1' },
        '종료'    : { bg: '#f8fafc', fg: '#0f172a' }
      };
      return map[st] || { bg: '#f3f4f6', fg: '#374151' };
    },
    _statusBadge(st) {
      const c = this._statusColor(st);
      return `<span style="display:inline-block;padding:3px 8px;border-radius:999px;background:${c.bg};color:${c.fg};font-size:12px;font-weight:700;">${this._esc(st)}</span>`;
    },

    // ---- modal (전용) ----
    _ensureModal() {
      let bd = document.getElementById('sarModalBackdrop');
      if (bd) return bd;

      bd = document.createElement('div');
      bd.id = 'sarModalBackdrop';
      bd.className = 'export-modal-backdrop';
      bd.innerHTML = `
        <div class="export-modal" style="max-width:900px;width:calc(100vw - 40px);">
          <div class="export-modal-header">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <h3 id="sarModalTitle" style="margin:0;font-size:14px;"></h3>
              <button class="btn" id="sarModalCloseBtn"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
          <div id="sarModalBody" style="margin-top:10px;"></div>
          <div id="sarModalFooter" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;"></div>
        </div>
      `;
      document.body.appendChild(bd);

      bd.addEventListener('click', (e) => { if (e.target === bd) bd.classList.remove('show'); });
      bd.querySelector('#sarModalCloseBtn').addEventListener('click', () => bd.classList.remove('show'));
      return bd;
    },
    _openModal(titleHtml, bodyHtml, footerButtons) {
      const bd = this._ensureModal();
      bd.querySelector('#sarModalTitle').innerHTML = titleHtml;
      bd.querySelector('#sarModalBody').innerHTML = bodyHtml;

      const ft = bd.querySelector('#sarModalFooter');
      ft.innerHTML = '';
      (footerButtons || []).forEach(btn => {
        const b = document.createElement('button');
        b.className = btn.className || 'btn';
        b.innerHTML = btn.label;
        b.addEventListener('click', () => btn.onClick && btn.onClick());
        ft.appendChild(b);
      });

      bd.classList.add('show');
    },
    _closeModal() {
      document.getElementById('sarModalBackdrop')?.classList.remove('show');
    },

    // ---- store ----
    _seedRequests() {
      // publicAccountAdmin 샘플 계정이 있으면 일부 참조
      const pa = (typeof W !== 'undefined') ? W.publicAccountAdmin : null;
      const accounts = (pa && Array.isArray(pa.sampleAccounts) && pa.sampleAccounts.length)
        ? pa.sampleAccounts
        : [
            { id:'PA-CRM-PROD-READ', accountName:'crm_readonly', system:'CRM-PROD', ownerDept:'CRM운영팀', purpose:'조회/감사 대응', risk:'LOW', status:'LOCKED', rotateCycleDays:90, lastUsed:'2025-11-28 10:05' },
            { id:'PA-ORA-PROD-DBA', accountName:'oracle', system:'ORA-PROD', ownerDept:'IT운영센터/DBA팀', purpose:'장애 대응', risk:'HIGH', status:'ACTIVE', rotateCycleDays:30, lastUsed:'2025-12-10 02:12' }
          ];

      const a1 = accounts[0];
      const a2 = accounts[Math.min(1, accounts.length - 1)];

      return [
        {
          id: 'SA-20251216-001',
          env: 'PRD',
          accountId: a1?.id || 'PA-CRM-PROD-READ',
          accountName: a1?.accountName || 'crm_readonly',
          system: a1?.system || 'CRM-PROD',
          risk: a1?.risk || 'LOW',
          requester: '김개발',
          dept: '채널개발팀',
          itsm: 'INC-20251216-0103',
          reason: '프로덕션 장애 원인 분석(로그/데이터 확인)',
          periodStart: '2025-12-16 13:00:00',
          periodEnd:   '2025-12-16 16:00:00',
          status: '결재대기',
          approvers: [
            { name: '채널개발팀장', role: '요청부서', status: '대기', actedAt: '', comment: '' },
            { name: '보안담당자', role: '보안', status: '대기', actedAt: '', comment: '' }
          ],
          used: { startAt:'', endAt:'' },
          logs: [
            { at:'2025-12-16 12:55:10', actor:'김개발', action:'요청등록', detail:'사유 등록 및 결재 상신' }
          ]
        },
        {
          id: 'SA-20251215-002',
          env: 'PRD',
          accountId: a2?.id || 'PA-ORA-PROD-DBA',
          accountName: a2?.accountName || 'oracle',
          system: a2?.system || 'ORA-PROD',
          risk: a2?.risk || 'HIGH',
          requester: '박운영',
          dept: 'IT운영센터/DBA팀',
          itsm: 'CHG-20251215-0042',
          reason: '배치 지연 이슈 조치(세션 확인/잠금 해소)',
          periodStart: '2025-12-15 02:00:00',
          periodEnd:   '2025-12-15 03:30:00',
          status: '승인',
          approvers: [
            { name: 'DBA팀장', role: '요청부서', status: '승인', actedAt: '2025-12-15 01:55:00', comment: '긴급 조치 승인' },
            { name: '보안담당자', role: '보안', status: '승인', actedAt: '2025-12-15 01:58:10', comment: '사후 로그 필수' }
          ],
          used: { startAt:'2025-12-15 02:05:00', endAt:'2025-12-15 03:10:00' },
          logs: [
            { at:'2025-12-15 01:50:00', actor:'박운영', action:'요청등록', detail:'사유 등록 및 결재 상신' },
            { at:'2025-12-15 01:58:10', actor:'보안담당자', action:'승인', detail:'승인 처리' },
            { at:'2025-12-15 02:05:00', actor:'박운영', action:'사용시작', detail:'공용계정 사용 시작' },
            { at:'2025-12-15 03:10:00', actor:'박운영', action:'사용종료', detail:'공용계정 사용 종료' }
          ]
        },
        {
          id: 'SA-20251214-003',
          env: 'DEV',
          accountId: a1?.id || 'PA-CRM-PROD-READ',
          accountName: a1?.accountName || 'crm_readonly',
          system: a1?.system || 'CRM-PROD',
          risk: a1?.risk || 'LOW',
          requester: '이테스트',
          dept: 'QA팀',
          itsm: '',
          reason: '테스트 목적(사유 불충분 예시)',
          periodStart: '2025-12-14 10:00:00',
          periodEnd:   '2025-12-14 11:00:00',
          status: '반려',
          approvers: [
            { name: 'QA팀장', role: '요청부서', status: '승인', actedAt: '2025-12-14 09:50:00', comment: '' },
            { name: '보안담당자', role: '보안', status: '반려', actedAt: '2025-12-14 09:55:30', comment: '사유/범위 보강 필요' }
          ],
          used: { startAt:'', endAt:'' },
          logs: [
            { at:'2025-12-14 09:45:00', actor:'이테스트', action:'요청등록', detail:'사유 등록 및 결재 상신' },
            { at:'2025-12-14 09:55:30', actor:'보안담당자', action:'반려', detail:'사유/범위 보강 필요' }
          ]
        }
      ];
    },

    _loadStore() {
      try {
        const raw = localStorage.getItem(this._storeKey);
        if (raw) return JSON.parse(raw);
      } catch (e) {}
      return null;
    },
    _saveStore(store) {
      try { localStorage.setItem(this._storeKey, JSON.stringify(store)); } catch (e) {}
    },
    _ensureStore() {
      let st = this._loadStore();
      if (!st || !Array.isArray(st.requests)) {
        st = { requests: this._seedRequests() };
        this._saveStore(st);
      }
      return st;
    },

    _getAccounts() {
      const pa = (typeof W !== 'undefined') ? W.publicAccountAdmin : null;
      const list = (pa && Array.isArray(pa.sampleAccounts)) ? pa.sampleAccounts : [];
      return list;
    },

    // ---- entry / binding ----
    attachSharedAccountReasonCardHandler() {
      const bodyEl = document.getElementById('adminBody');
      if (!bodyEl) return;

      const cards = bodyEl.querySelectorAll('.admin-card');
      let target = null;

      cards.forEach(card => {
        const title = (card.querySelector('h4')?.textContent || '').trim();
        if (title.includes('공용계정 사용 사유·승인') || title.includes('공용계정 사용 사유')) target = card;
      });

      if (!target) return;
      if (target.dataset[this._boundKey] === '1') return;
      target.dataset[this._boundKey] = '1';

      target.classList.add('admin-card-clickable');
      target.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.open();
      });

      const footer = target.querySelector('.admin-footer, .card-footer');
      if (footer) footer.textContent = '클릭하여 사용 사유 등록/승인 처리 화면을 엽니다.';
    },

    open() {
      // overlay open + nav active
      const ov = document.getElementById('adminOverlay');
      if (ov) { ov.classList.add('show'); ov.setAttribute('aria-hidden', 'false'); }

      document.querySelectorAll('.admin-nav button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.section === 'sharedEmergency');
      });

      const titleEl = document.getElementById('adminTitle');
      const descEl = document.getElementById('adminDesc');
      const bodyEl = document.getElementById('adminBody');
      if (!titleEl || !descEl || !bodyEl) return;

      titleEl.innerHTML = `<i class="fa-solid fa-key"></i> 공용계정 사용 사유·승인`;
      descEl.textContent = '공용 계정 사용 요청의 사유 등록, 결재(상신/승인/반려), 사용 시작/종료 로그를 관리합니다.';

      bodyEl.innerHTML = this.getTemplateHtml();
      this.bindOnce();
      this.renderAll();
    },

    getTemplateHtml() {
      return `
        <div id="sarPage" class="emg-page" style="display:flex;flex-direction:column;gap:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <div style="display:flex;gap:8px;align-items:center;">
              <button id="sarBack" class="btn" type="button"><i class="fa-solid fa-arrow-left"></i></button>
              <div style="font-weight:800;">요청/승인 관리</div>
            </div>
            <div style="font-size:12px;color:var(--muted);">
              결재 흐름(대기→중→승인/반려) + 승인 후 사용 시작/종료를 기록
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <div style="flex:1.25; min-width:420px; display:flex; flex-direction:column; gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div class="admin-header">
                  <h2><i class="fa-solid fa-list-check"></i> 요청 목록</h2>
                  <span class="badge" id="sarCount">0건</span>
                </div>

                <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:10px;">
                  <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <select id="sarFilterStatus" class="input" style="min-width:120px;">
                      <option value="ALL">상태(전체)</option>
                      <option value="결재대기">결재대기</option>
                      <option value="결재중">결재중</option>
                      <option value="승인">승인</option>
                      <option value="반려">반려</option>
                      <option value="취소">취소</option>
                      <option value="사용중">사용중</option>
                      <option value="종료">종료</option>
                    </select>

                    <select id="sarFilterEnv" class="input" style="min-width:110px;">
                      <option value="ALL">환경(전체)</option>
                      <option value="PRD">PRD</option>
                      <option value="STG">STG</option>
                      <option value="DEV">DEV</option>
                    </select>

                    <select id="sarFilterAccount" class="input" style="min-width:260px;">
                      <option value="ALL">공용계정(전체)</option>
                    </select>
                  </div>

                  <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                    <input id="sarFilterQ" class="input" style="min-width:240px;" placeholder="검색(요청자/부서/티켓/계정)" />
                    <button id="sarBtnNew" class="btn primary" type="button"><i class="fa-solid fa-plus"></i> 요청 생성</button>
                    <button id="sarBtnExport" class="btn" type="button"><i class="fa-solid fa-file-export"></i> 내보내기</button>
                  </div>
                </div>

                <div class="table-scroll-x scope-items-wrap" style="margin-top:10px; border:1px solid var(--line); border-radius:10px; overflow:auto; padding-bottom:6px; max-height:540px;">
                  <table class="scope-items-table" style="width:100%; min-width:860px; border-collapse:collapse; table-layout:fixed;">
                    <colgroup>
                      <col style="width:150px;">
                      <col style="width:100px;">
                      <col style="width:230px;">
                      <col style="width:160px;">
                      <col style="width:170px;">
                    </colgroup>
                    <thead>
                      <tr style="background:#f9fafb;">
                        <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">요청ID</th>
                        <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">상태</th>
                        <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">공용계정</th>
                        <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">요청자</th>
                        <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">기간</th>
                      </tr>
                    </thead>
                    <tbody id="sarTbody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div style="flex:1; min-width:340px; display:flex; flex-direction:column; gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div class="admin-header">
                  <h2><i class="fa-solid fa-clipboard-check"></i> 승인 상세</h2>
                  <span class="badge" id="sarSelBadge">미선택</span>
                </div>

                <div id="sarDetail" style="margin-top:10px; color:#111827;">
                  <div style="color:#6b7280; font-size:13px;">
                    좌측 목록에서 요청을 선택하세요.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    },

    bindOnce() {
      const bodyEl = document.getElementById('adminBody');
      if (!bodyEl) return;
      if (bodyEl.dataset.sarBound === '1') return;
      bodyEl.dataset.sarBound = '1';

      bodyEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        const row = e.target.closest('tr[data-id]');
        if (row) {
          this.state.selectedId = row.dataset.id;
          this.renderDetail();
          this.renderList(); // 선택 강조
          return;
        }
        if (!btn) return;

        if (btn.id === 'sarBack') {
          if (W.admin && typeof W.admin.show === 'function') W.admin.show('sharedEmergency');
          return;
        }
        if (btn.id === 'sarBtnNew') {
          this.openNewRequestModal();
          return;
        }
        if (btn.id === 'sarBtnExport') {
          this.exportFiltered();
          return;
        }

        // detail actions
        const act = btn.dataset.action;
        const id  = btn.dataset.id;
        if (!act || !id) return;

        if (act === 'advance') this.advanceApproval(id);
        if (act === 'approve') this.approveRequest(id);
        if (act === 'reject')  this.rejectRequest(id);
        if (act === 'cancel')  this.cancelRequest(id);
        if (act === 'startUse') this.startUse(id);
        if (act === 'endUse')   this.endUse(id);
        if (act === 'resubmit') this.resubmit(id);
      });

      bodyEl.addEventListener('change', (e) => {
        const t = e.target;
        if (!t) return;
        if (t.id === 'sarFilterStatus') this.state.filters.status = t.value;
        if (t.id === 'sarFilterEnv') this.state.filters.env = t.value;
        if (t.id === 'sarFilterAccount') this.state.filters.accountId = t.value;
        this.renderList();
        this.renderDetail(); // 선택이 필터로 사라질 수 있음
      });

      bodyEl.addEventListener('input', (e) => {
        const t = e.target;
        if (!t) return;
        if (t.id === 'sarFilterQ') {
          this.state.filters.q = t.value || '';
          this.renderList();
        }
      });
    },

    // ---- query ----
    _getAll() {
      const st = this._ensureStore();
      return st.requests || [];
    },
    _find(id) {
      return this._getAll().find(x => x.id === id);
    },
    _persistAll(nextAll) {
      const st = this._ensureStore();
      st.requests = nextAll;
      this._saveStore(st);
    },
    _filtered() {
      const { status, env, accountId, q } = this.state.filters;
      const kw = (q || '').trim().toLowerCase();

      return this._getAll().filter(r => {
        if (status !== 'ALL' && r.status !== status) return false;
        if (env !== 'ALL' && r.env !== env) return false;
        if (accountId !== 'ALL' && r.accountId !== accountId) return false;

        if (kw) {
          const blob = [
            r.id, r.accountId, r.accountName, r.system,
            r.requester, r.dept, r.itsm, r.reason
          ].join(' ').toLowerCase();
          if (!blob.includes(kw)) return false;
        }
        return true;
      }).sort((a,b) => (b.id || '').localeCompare(a.id || ''));
    },

    // ---- render ----
    renderAll() {
      this.renderAccountFilterOptions();
      this.renderList();
      this.renderDetail();
    },

    renderAccountFilterOptions() {
      const sel = document.getElementById('sarFilterAccount');
      if (!sel) return;

      const accounts = this._getAccounts();
      const curr = this.state.filters.accountId || 'ALL';

      const opts = [
        `<option value="ALL">공용계정(전체)</option>`,
        ...accounts.map(a => {
          const label = `${a.id} (${a.accountName || ''} / ${a.system || ''})`;
          return `<option value="${this._esc(a.id)}">${this._esc(label)}</option>`;
        })
      ].join('');

      sel.innerHTML = opts;
      sel.value = (accounts.some(a => a.id === curr) ? curr : 'ALL');
    },

    renderList() {
      const tbody = document.getElementById('sarTbody');
      const countEl = document.getElementById('sarCount');
      if (!tbody || !countEl) return;

      const list = this._filtered();
      countEl.textContent = `${list.length}건`;

      const selectedId = this.state.selectedId;

      tbody.innerHTML = list.map(r => {
        const isSel = selectedId && selectedId === r.id;
        const trBg = isSel ? 'background:#eef2ff;' : '';
        const account = `${r.accountId} / ${r.accountName || ''}<div style="color:#9ca3af;font-size:12px;">${this._esc(r.system || '')} · ${this._esc(r.env || '')} · RISK:${this._esc(r.risk || '')}</div>`;
        const who = `${this._esc(r.requester || '')}<div style="color:#9ca3af;font-size:12px;">${this._esc(r.dept || '')}</div>`;
        const period = `${this._esc(r.periodStart || '')}<div style="color:#9ca3af;font-size:12px;">~ ${this._esc(r.periodEnd || '')}</div>`;
        return `
          <tr data-id="${this._esc(r.id)}" style="border-bottom:1px solid #f3f4f6; cursor:pointer; ${trBg}">
            <td style="padding:10px; font-weight:800;">${this._esc(r.id)}</td>
            <td style="padding:10px;">${this._statusBadge(r.status)}</td>
            <td style="padding:10px;">${account}</td>
            <td style="padding:10px;">${who}</td>
            <td style="padding:10px;">${period}</td>
          </tr>
        `;
      }).join('');

      // 선택된 항목이 필터로 사라졌으면 선택 해제
      if (selectedId && !list.some(x => x.id === selectedId)) {
        this.state.selectedId = null;
        const badge = document.getElementById('sarSelBadge');
        if (badge) badge.textContent = '미선택';
      }
    },

    _renderApprovers(aprs) {
      const list = Array.isArray(aprs) ? aprs : [];
      if (!list.length) return `<div style="color:#6b7280;font-size:13px;">(결재선 없음)</div>`;
      return list.map(a => {
        const st = a.status || '대기';
        const c = this._statusColor(st === '대기' ? '결재대기' : (st === '승인' ? '승인' : (st === '반려' ? '반려' : '결재중')));
        const dot = `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${c.fg};margin-right:6px;"></span>`;
        const meta = [
          a.role ? `(${a.role})` : '',
          a.actedAt ? `· ${a.actedAt}` : ''
        ].filter(Boolean).join(' ');
        const comment = a.comment ? `<div style="color:#6b7280;font-size:12px;margin-top:2px;">${this._esc(a.comment)}</div>` : '';
        return `
          <div style="padding:8px 10px;border:1px solid #eef2f7;border-radius:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
              <div style="font-weight:700; display:flex; align-items:center;">${dot}${this._esc(a.name || '')} <span style="color:#9ca3af;font-weight:600;margin-left:6px;">${this._esc(meta)}</span></div>
              <div>${this._statusBadge(st === '대기' ? '결재대기' : (st === '승인' ? '승인' : '반려'))}</div>
            </div>
            ${comment}
          </div>
        `;
      }).join('');
    },

    _renderLogs(logs) {
      const list = Array.isArray(logs) ? logs : [];
      if (!list.length) return `<div style="color:#6b7280;font-size:13px;">(이력 없음)</div>`;
      return list.slice().reverse().map(l => {
        return `
          <div style="padding:8px 10px;border:1px solid #eef2f7;border-radius:10px;">
            <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
              <div style="font-weight:800;">${this._esc(l.action || '')} <span style="color:#9ca3af;font-weight:600;">· ${this._esc(l.actor || '')}</span></div>
              <div style="color:#6b7280;font-size:12px;">${this._esc(l.at || '')}</div>
            </div>
            <div style="color:#475569;font-size:13px;margin-top:4px;">${this._esc(l.detail || '')}</div>
          </div>
        `;
      }).join('');
    },

    renderDetail() {
      const badge = document.getElementById('sarSelBadge');
      const box = document.getElementById('sarDetail');
      if (!box) return;

      const id = this.state.selectedId;
      if (!id) {
        if (badge) badge.textContent = '미선택';
        box.innerHTML = `<div style="color:#6b7280;font-size:13px;">좌측 목록에서 요청을 선택하세요.</div>`;
        return;
      }

      const r = this._find(id);
      if (!r) {
        this.state.selectedId = null;
        if (badge) badge.textContent = '미선택';
        box.innerHTML = `<div style="color:#6b7280;font-size:13px;">선택된 요청을 찾을 수 없습니다.</div>`;
        return;
      }

      if (badge) badge.textContent = r.id;

      const actions = this._renderActions(r);
      const infoRows = [
        ['상태', this._statusBadge(r.status)],
        ['환경', this._esc(r.env || '')],
        ['시스템', this._esc(r.system || '')],
        ['공용계정', `<b>${this._esc(r.accountId || '')}</b> <span style="color:#9ca3af;">(${this._esc(r.accountName || '')})</span>`],
        ['RISK', this._esc(r.risk || '')],
        ['요청자', `${this._esc(r.requester || '')} <span style="color:#9ca3af;">(${this._esc(r.dept || '')})</span>`],
        ['ITSM', this._esc(r.itsm || '') || '-'],
        ['사용기간', `${this._esc(r.periodStart || '')} ~ ${this._esc(r.periodEnd || '')}`]
      ];

      const used = r.used || {};
      const usedHtml = (used.startAt || used.endAt)
        ? `<div style="display:grid;grid-template-columns:120px 1fr;gap:6px 10px;">
             <div style="color:#6b7280;font-size:12px;">사용 시작</div><div>${this._esc(used.startAt || '-')}</div>
             <div style="color:#6b7280;font-size:12px;">사용 종료</div><div>${this._esc(used.endAt || '-')}</div>
           </div>`
        : `<div style="color:#6b7280;font-size:13px;">(사용 시작/종료 기록 없음)</div>`;

      box.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div style="font-weight:900;font-size:14px;">요청 정보</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">${actions}</div>
        </div>

        <div style="margin-top:10px; border:1px solid var(--line); border-radius:12px; padding:10px;">
          <div style="display:grid; grid-template-columns:120px 1fr; gap:6px 10px; font-size:13px;">
            ${infoRows.map(([k,v]) => `
              <div style="color:#6b7280;">${k}</div>
              <div>${v}</div>
            `).join('')}
          </div>

          <div style="margin-top:10px;">
            <div style="color:#6b7280;font-size:12px;margin-bottom:6px;">사용 사유</div>
            <div style="white-space:pre-wrap; background:#f9fafb; border:1px solid #eef2f7; border-radius:10px; padding:10px; font-size:13px;">
              ${this._esc(r.reason || '')}
            </div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div style="font-weight:900;font-size:14px;margin-bottom:8px;">결재선</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            ${this._renderApprovers(r.approvers)}
          </div>
        </div>

        <div style="margin-top:12px;">
          <div style="font-weight:900;font-size:14px;margin-bottom:8px;">사용 기록</div>
          ${usedHtml}
        </div>

        <div style="margin-top:12px;">
          <div style="font-weight:900;font-size:14px;margin-bottom:8px;">이력</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            ${this._renderLogs(r.logs)}
          </div>
        </div>
      `;
    },

    _renderActions(r) {
      const id = this._esc(r.id);
      const btn = (label, cls, act) => `<button class="${cls}" data-action="${act}" data-id="${id}" type="button">${label}</button>`;

      if (r.status === '결재대기' || r.status === '결재중') {
        return [
          btn('<i class="fa-solid fa-forward"></i> 결재 진행', 'btn', 'advance'),
          btn('<i class="fa-solid fa-check"></i> 승인', 'btn primary', 'approve'),
          btn('<i class="fa-solid fa-ban"></i> 반려', 'btn', 'reject'),
          btn('<i class="fa-solid fa-xmark"></i> 취소', 'btn', 'cancel')
        ].join('');
      }
      if (r.status === '승인') {
        return [
          btn('<i class="fa-solid fa-play"></i> 사용 시작', 'btn primary', 'startUse'),
          btn('<i class="fa-solid fa-rotate-left"></i> 재상신', 'btn', 'resubmit')
        ].join('');
      }
      if (r.status === '사용중') {
        return [
          btn('<i class="fa-solid fa-stop"></i> 사용 종료', 'btn primary', 'endUse')
        ].join('');
      }
      if (r.status === '반려' || r.status === '취소' || r.status === '종료') {
        return [
          btn('<i class="fa-solid fa-rotate-left"></i> 재상신', 'btn primary', 'resubmit')
        ].join('');
      }
      return '';
    },

    // ---- actions ----
    _pushLog(r, actor, action, detail) {
      r.logs = Array.isArray(r.logs) ? r.logs : [];
      r.logs.push({ at: this._nowLocal(), actor, action, detail });
    },

    _recalcStatus(r) {
      const aps = Array.isArray(r.approvers) ? r.approvers : [];
      if (!aps.length) return r.status;

      if (aps.some(a => a.status === '반려')) return '반려';
      if (aps.every(a => a.status === '승인')) return '승인';
      if (aps.some(a => a.status === '승인')) return '결재중';
      return '결재대기';
    },

    advanceApproval(id) {
      const all = this._getAll();
      const r = all.find(x => x.id === id);
      if (!r) return;

      if (!(r.status === '결재대기' || r.status === '결재중')) return alert('결재 진행 가능한 상태가 아닙니다.');

      const aps = Array.isArray(r.approvers) ? r.approvers : [];
      const nextIdx = aps.findIndex(a => a.status !== '승인' && a.status !== '반려');
      if (nextIdx < 0) {
        r.status = '승인';
        this._pushLog(r, '시스템', '결재완료', '모든 결재가 완료되어 승인 처리');
      } else {
        aps[nextIdx].status = '승인';
        aps[nextIdx].actedAt = this._nowLocal();
        aps[nextIdx].comment = aps[nextIdx].comment || '';
        r.status = this._recalcStatus(r);
        this._pushLog(r, aps[nextIdx].name || '결재자', '결재진행', `결재 진행(승인) - ${aps[nextIdx].name || ''}`);
      }

      this._persistAll(all);
      this.renderList();
      this.renderDetail();
    },

    approveRequest(id) {
      const all = this._getAll();
      const r = all.find(x => x.id === id);
      if (!r) return;

      if (!(r.status === '결재대기' || r.status === '결재중')) return alert('승인 가능한 상태가 아닙니다.');

      this._openModal(
        `<i class="fa-solid fa-check"></i> 승인 처리`,
        `
          <div style="font-size:12px;color:#475569;margin-bottom:8px;">
            승인 코멘트를 남길 수 있습니다(선택).
          </div>
          <textarea id="sarApproveComment" placeholder="예) 장애 대응 승인 / 사후 로그 필수" style="width:100%;min-height:120px;"></textarea>
        `,
        [
          { label:'<i class="fa-solid fa-xmark"></i> 취소', className:'btn', onClick: () => this._closeModal() },
          {
            label:'<i class="fa-solid fa-check"></i> 승인',
            className:'btn primary',
            onClick: () => {
              const c = document.getElementById('sarApproveComment')?.value || '';
              (r.approvers || []).forEach(a => {
                if (a.status !== '승인') {
                  a.status = '승인';
                  a.actedAt = a.actedAt || this._nowLocal();
                  if (c && !a.comment) a.comment = c;
                }
              });
              r.status = '승인';
              this._pushLog(r, '관리자', '승인', c ? `승인 코멘트: ${c}` : '승인 처리');
              this._persistAll(all);
              this._closeModal();
              this.renderList();
              this.renderDetail();
            }
          }
        ]
      );
    },

    rejectRequest(id) {
      const all = this._getAll();
      const r = all.find(x => x.id === id);
      if (!r) return;

      if (!(r.status === '결재대기' || r.status === '결재중')) return alert('반려 가능한 상태가 아닙니다.');

      this._openModal(
        `<i class="fa-solid fa-ban"></i> 반려 처리`,
        `
          <div style="font-size:12px;color:#475569;margin-bottom:8px;">
            반려 사유를 입력하세요.
          </div>
          <textarea id="sarRejectReason" placeholder="예) 사유/범위 불충분, 기간 과다, 티켓 미첨부" style="width:100%;min-height:120px;"></textarea>
        `,
        [
          { label:'<i class="fa-solid fa-xmark"></i> 취소', className:'btn', onClick: () => this._closeModal() },
          {
            label:'<i class="fa-solid fa-ban"></i> 반려',
            className:'btn primary',
            onClick: () => {
              const reason = (document.getElementById('sarRejectReason')?.value || '').trim();
              if (!reason) return alert('반려 사유를 입력하세요.');

              // 마지막 결재자를 반려 처리로 기록(없으면 보안담당자 가정)
              const aps = Array.isArray(r.approvers) ? r.approvers : [];
              let idx = aps.findIndex(a => a.status !== '승인' && a.status !== '반려');
              if (idx < 0) idx = Math.max(aps.length - 1, 0);
              if (aps[idx]) {
                aps[idx].status = '반려';
                aps[idx].actedAt = this._nowLocal();
                aps[idx].comment = reason;
              }
              r.status = '반려';
              this._pushLog(r, '관리자', '반려', reason);

              this._persistAll(all);
              this._closeModal();
              this.renderList();
              this.renderDetail();
            }
          }
        ]
      );
    },

    cancelRequest(id) {
      const all = this._getAll();
      const r = all.find(x => x.id === id);
      if (!r) return;

      if (!(r.status === '결재대기' || r.status === '결재중')) return alert('취소 가능한 상태가 아닙니다.');
      if (!confirm('요청을 취소할까요?')) return;

      r.status = '취소';
      this._pushLog(r, '요청자', '취소', '요청 취소');
      this._persistAll(all);
      this.renderList();
      this.renderDetail();
    },

    startUse(id) {
      const all = this._getAll();
      const r = all.find(x => x.id === id);
      if (!r) return;

      if (r.status !== '승인') return alert('승인된 요청만 사용 시작할 수 있습니다.');
      r.used = r.used || {};
      r.used.startAt = this._nowLocal();
      r.status = '사용중';
      this._pushLog(r, r.requester || '사용자', '사용시작', '공용계정 사용 시작');
      this._persistAll(all);
      this.renderList();
      this.renderDetail();
    },

    endUse(id) {
      const all = this._getAll();
      const r = all.find(x => x.id === id);
      if (!r) return;

      if (r.status !== '사용중') return alert('사용중 상태에서만 종료할 수 있습니다.');
      r.used = r.used || {};
      r.used.endAt = this._nowLocal();
      r.status = '종료';
      this._pushLog(r, r.requester || '사용자', '사용종료', '공용계정 사용 종료');
      this._persistAll(all);
      this.renderList();
      this.renderDetail();
    },

    resubmit(id) {
      const all = this._getAll();
      const r = all.find(x => x.id === id);
      if (!r) return;

      if (!(r.status === '반려' || r.status === '취소' || r.status === '종료' || r.status === '승인')) {
        return alert('재상신 가능한 상태가 아닙니다.');
      }

      // approver 상태 초기화
      (r.approvers || []).forEach(a => {
        a.status = '대기';
        a.actedAt = '';
        a.comment = '';
      });

      r.used = { startAt:'', endAt:'' };
      r.status = '결재대기';
      this._pushLog(r, r.requester || '요청자', '재상신', '결재 재상신');
      this._persistAll(all);
      this.renderList();
      this.renderDetail();
    },

    // ---- create / export ----
    openNewRequestModal() {
      const accounts = this._getAccounts();
      const opts = accounts.length
        ? accounts.map(a => `<option value="${this._esc(a.id)}">${this._esc(a.id)} (${this._esc(a.accountName || '')} / ${this._esc(a.system || '')})</option>`).join('')
        : `<option value="PA-CRM-PROD-READ">PA-CRM-PROD-READ</option>`;

      this._openModal(
        `<i class="fa-solid fa-plus"></i> 공용계정 사용 요청 생성`,
        `
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div style="grid-column:1 / -1;">
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">공용계정</div>
              <select id="sarNewAccountId" class="export-input">${opts}</select>
            </div>

            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">환경</div>
              <select id="sarNewEnv" class="export-input">
                <option value="PRD">PRD</option>
                <option value="STG">STG</option>
                <option value="DEV">DEV</option>
              </select>
            </div>
            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">ITSM 티켓</div>
              <input id="sarNewItsm" class="export-input" placeholder="예) INC-YYYYMMDD-0001" />
            </div>

            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">요청자</div>
              <input id="sarNewRequester" class="export-input" placeholder="예) 홍길동" />
            </div>
            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">부서</div>
              <input id="sarNewDept" class="export-input" placeholder="예) 데이터플랫폼팀" />
            </div>

            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">사용 시작</div>
              <input id="sarNewStart" class="export-input" placeholder="YYYY-MM-DD HH:mm:ss" />
            </div>
            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">사용 종료</div>
              <input id="sarNewEnd" class="export-input" placeholder="YYYY-MM-DD HH:mm:ss" />
            </div>

            <div style="grid-column:1 / -1;">
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">사용 사유</div>
              <textarea id="sarNewReason" class="export-input" style="min-height:120px;" placeholder="사유/범위/필요성/사후조치 등을 구체적으로 작성"></textarea>
            </div>

            <div style="grid-column:1 / -1;">
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">결재선(콤마로 구분)</div>
              <input id="sarNewApprovers" class="export-input" value="요청부서 팀장,보안담당자" />
            </div>
          </div>
        `,
        [
          { label:'<i class="fa-solid fa-xmark"></i> 취소', className:'btn', onClick: () => this._closeModal() },
          {
            label:'<i class="fa-solid fa-check"></i> 생성',
            className:'btn primary',
            onClick: () => {
              const accountId = document.getElementById('sarNewAccountId')?.value || '';
              const env = document.getElementById('sarNewEnv')?.value || 'PRD';
              const itsm = (document.getElementById('sarNewItsm')?.value || '').trim();
              const requester = (document.getElementById('sarNewRequester')?.value || '').trim();
              const dept = (document.getElementById('sarNewDept')?.value || '').trim();
              const start = (document.getElementById('sarNewStart')?.value || '').trim() || this._nowLocal();
              const end = (document.getElementById('sarNewEnd')?.value || '').trim() || this._nowLocal();
              const reason = (document.getElementById('sarNewReason')?.value || '').trim();
              const apprStr = (document.getElementById('sarNewApprovers')?.value || '').trim();

              if (!accountId) return alert('공용계정을 선택하세요.');
              if (!requester) return alert('요청자를 입력하세요.');
              if (!dept) return alert('부서를 입력하세요.');
              if (!reason) return alert('사용 사유를 입력하세요.');

              const acc = this._getAccounts().find(a => a.id === accountId);
              const approvers = apprStr
                ? apprStr.split(',').map(s => s.trim()).filter(Boolean)
                : ['요청부서 팀장', '보안담당자'];

              const req = {
                id: this._uuid('SA'),
                env,
                accountId,
                accountName: acc?.accountName || '',
                system: acc?.system || '',
                risk: acc?.risk || '',
                requester,
                dept,
                itsm,
                reason,
                periodStart: start,
                periodEnd: end,
                status: '결재대기',
                approvers: approvers.map((nm, i) => ({
                  name: nm,
                  role: i === 0 ? '요청부서' : (nm.includes('보안') ? '보안' : '결재'),
                  status: '대기',
                  actedAt: '',
                  comment: ''
                })),
                used: { startAt:'', endAt:'' },
                logs: []
              };
              this._pushLog(req, requester, '요청등록', '사유 등록 및 결재 상신');

              const all = this._getAll();
              all.unshift(req);
              this._persistAll(all);

              this.state.selectedId = req.id;

              this._closeModal();
              this.renderAll();
            }
          }
        ]
      );
    },

    exportFiltered() {
      const list = this._filtered();
      const payload = {
        exportedAt: this._nowLocal(),
        filters: Object.assign({}, this.state.filters),
        count: list.length,
        requests: list
      };
      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `shared_account_reason_export_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }
  };

  // 전역 노출
  W.sharedAccountReasonAdmin = sharedAccountReasonAdmin;

//admin item handler 등록 (card router 방식)
  const tryRegisterSar = () => {
    const W = window;
    if (!W.admin || typeof W.admin.registerItemHandler !== "function") return false;
    W.admin.registerItemHandler("sharedAccountReason", () => W.sharedAccountReasonAdmin.open());
    return true;
  };
  if (!tryRegisterSar()) {
    document.addEventListener("DOMContentLoaded", () => { tryRegisterSar(); });
  }

  /* ------------------------------------------------------------------
   * 응급 권한 사용 내역 (emergencyUseLog)
   * - 접속/쿼리/다운로드 이벤트 포함 사용 세션 이력 조회
   * - 필터/상세/사후승인(완료/반려)/강제종료/내보내기(JSON)
   * - localStorage 저장 (새로고침 유지)
   * ------------------------------------------------------------------ */
  (() => {
    const W = window;

    const emergencyUseLogAdmin = {
      _storeKey: "dbam_emergency_use_log_v1",
      state: {
        selectedId: null,
        filters: {
          from: "",
          to: "",
          env: "ALL",
          status: "ALL",        // 사용중/종료/강제종료
          review: "ALL",        // 대기/완료/반려
          q: ""
        }
      },

      // ---------- utils ----------
      _pad(n) { return String(n).padStart(2, "0"); },
      _now() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = this._pad(d.getMonth() + 1);
        const dd = this._pad(d.getDate());
        const hh = this._pad(d.getHours());
        const mi = this._pad(d.getMinutes());
        const ss = this._pad(d.getSeconds());
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
      },
      _today() {
        const d = new Date();
        return `${d.getFullYear()}-${this._pad(d.getMonth() + 1)}-${this._pad(d.getDate())}`;
      },
      _esc(v) {
        const s = (v === null || v === undefined) ? "" : String(v);
        return s
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      },
      _inRange(ts, from, to) {
        // ts: "YYYY-MM-DD HH:mm:ss" (사전순 비교 가능)
        if (from) {
          const f = `${from} 00:00:00`;
          if (ts < f) return false;
        }
        if (to) {
          const t = `${to} 23:59:59`;
          if (ts > t) return false;
        }
        return true;
      },
      _badge(text, bg, fg) {
        return `<span style="display:inline-block;padding:3px 8px;border-radius:999px;background:${bg};color:${fg};font-size:12px;font-weight:800;">${this._esc(text)}</span>`;
      },
      _statusBadge(st) {
        if (st === "사용중") return this._badge("사용중", "#f0f9ff", "#0369a1");
        if (st === "강제종료") return this._badge("강제종료", "#fff7ed", "#9a3412");
        return this._badge("종료", "#f8fafc", "#0f172a");
      },
      _reviewBadge(rv) {
        if (rv === "완료") return this._badge("사후승인 완료", "#ecfdf5", "#047857");
        if (rv === "반려") return this._badge("사후승인 반려", "#fef2f2", "#b91c1c");
        return this._badge("사후승인 대기", "#eff6ff", "#1d4ed8");
      },

      // ---------- store ----------
      _load() {
        try {
          const raw = localStorage.getItem(this._storeKey);
          if (raw) return JSON.parse(raw);
        } catch (e) {}
        return null;
      },
      _save(st) {
        try { localStorage.setItem(this._storeKey, JSON.stringify(st)); } catch (e) {}
      },
      _seed() {
        const t = this._today();
        return {
          seq: 3,
          sessions: [
            {
              id: `EUL-${t.replaceAll("-","")}-001`,
              env: "PRD",
              system: "ORA-PROD",
              target: "ORCLPROD/APP_OWNER",
              privilege: "DBA(응급)",
              account: "oracle",
              requester: "박운영",
              dept: "IT운영센터/DBA팀",
              itsm: "INC-20251216-0103",
              reason: "장애 대응(세션 확인/잠금 해소)",
              startAt: "2025-12-16 02:05:00",
              endAt: "2025-12-16 03:10:00",
              status: "종료",
              review: { status: "완료", by: "보안담당자", at: "2025-12-16 03:25:10", comment: "사후 로그 확인" },
              events: [
                { at:"2025-12-16 02:05:02", type:"CONNECT", detail:"접속 성공 (VPN:ON / MFA:PASS)" },
                { at:"2025-12-16 02:10:11", type:"QUERY", detail:"SELECT ... (세션/락 확인)" },
                { at:"2025-12-16 02:18:03", type:"QUERY", detail:"ALTER SYSTEM KILL SESSION ..." },
                { at:"2025-12-16 03:10:00", type:"DISCONNECT", detail:"정상 종료" }
              ]
            },
            {
              id: `EUL-${t.replaceAll("-","")}-002`,
              env: "PRD",
              system: "CRM-PROD",
              target: "CRMDB/CRM_OWNER",
              privilege: "READ(응급)",
              account: "crm_readonly",
              requester: "김개발",
              dept: "채널개발팀",
              itsm: "INC-20251216-0103",
              reason: "프로덕션 장애 원인 분석(로그/데이터 확인)",
              startAt: "2025-12-16 12:58:10",
              endAt: "",
              status: "사용중",
              review: { status: "대기", by: "", at: "", comment: "" },
              events: [
                { at:"2025-12-16 12:58:12", type:"CONNECT", detail:"접속 성공 (MFA:PASS)" },
                { at:"2025-12-16 13:03:41", type:"QUERY", detail:"SELECT ... (에러 구간 확인)" }
              ]
            }
          ]
        };
      },
      _ensureStore() {
        let st = this._load();
        if (!st || !Array.isArray(st.sessions)) {
          st = this._seed();
          this._save(st);
        }
        return st;
      },
      _all() { return this._ensureStore().sessions || []; },
      _persistAll(next) {
        const st = this._ensureStore();
        st.sessions = next;
        this._save(st);
      },
      _find(id) { return this._all().find(s => s.id === id); },

      // ---------- modal ----------
      _ensureModal() {
        let bd = document.getElementById("eulModalBackdrop");
        if (bd) return bd;

        bd = document.createElement("div");
        bd.id = "eulModalBackdrop";
        bd.className = "export-modal-backdrop";
        bd.innerHTML = `
          <div class="export-modal" style="max-width:860px;width:calc(100vw - 40px);">
            <div class="export-modal-header">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <h3 id="eulModalTitle" style="margin:0;font-size:14px;"></h3>
                <button class="btn" id="eulModalCloseBtn"><i class="fa-solid fa-xmark"></i></button>
              </div>
            </div>
            <div id="eulModalBody" style="margin-top:10px;"></div>
            <div id="eulModalFooter" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;"></div>
          </div>
        `;
        document.body.appendChild(bd);

        bd.addEventListener("click", (e) => { if (e.target === bd) bd.classList.remove("show"); });
        bd.querySelector("#eulModalCloseBtn").addEventListener("click", () => bd.classList.remove("show"));
        return bd;
      },
      _openModal(titleHtml, bodyHtml, buttons) {
        const bd = this._ensureModal();
        bd.querySelector("#eulModalTitle").innerHTML = titleHtml;
        bd.querySelector("#eulModalBody").innerHTML = bodyHtml;

        const ft = bd.querySelector("#eulModalFooter");
        ft.innerHTML = "";
        (buttons || []).forEach(b => {
          const btn = document.createElement("button");
          btn.className = b.className || "btn";
          btn.innerHTML = b.label;
          btn.addEventListener("click", () => b.onClick && b.onClick());
          ft.appendChild(btn);
        });

        bd.classList.add("show");
      },
      _closeModal() { document.getElementById("eulModalBackdrop")?.classList.remove("show"); },

      // ---------- open / template ----------
      open() {
        // overlay show
        const ov = document.getElementById("adminOverlay");
        if (ov) { ov.classList.add("show"); ov.setAttribute("aria-hidden", "false"); }

        // nav active
        document.querySelectorAll(".admin-nav button").forEach(btn => {
          btn.classList.toggle("active", btn.dataset.section === "sharedEmergency");
        });

        const titleEl = document.getElementById("adminTitle");
        const descEl = document.getElementById("adminDesc");
        const bodyEl = document.getElementById("adminBody");
        if (!bodyEl) return;

        if (titleEl) titleEl.innerHTML = `<i class="fa-solid fa-bolt"></i> 응급 권한 사용 내역`;
        if (descEl) descEl.textContent = "응급 권한 사용 세션(접속/쿼리/다운로드)을 조회하고 사후 승인 상태 및 강제종료를 관리합니다.";

        bodyEl.innerHTML = this.getTemplateHtml();

        // 기본 필터 초기값(오늘)
        if (!this.state.filters.from && !this.state.filters.to) {
          this.state.filters.from = this._today();
          this.state.filters.to = this._today();
        }

        this.bindOnce();
        this.renderAll();
      },

      getTemplateHtml() {
        return `
          <div id="eulPage" class="emg-page" style="display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
              <div style="display:flex;gap:8px;align-items:center;">
                <button id="eulBack" class="btn" type="button"><i class="fa-solid fa-arrow-left"></i></button>
                <div style="font-weight:900;">사용 세션 이력</div>
              </div>
              <div style="font-size:12px;color:var(--muted);">
                세션 단위로 접속/쿼리/다운로드 이벤트를 확인합니다.
              </div>
            </div>

            <div class="admin-card" style="padding:12px 14px;">
              <div class="admin-header">
                <h2><i class="fa-solid fa-clipboard-list"></i> 필터</h2>
                <span class="badge" id="eulSummary">-</span>
              </div>

              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center;">
                <div style="display:flex;gap:6px;align-items:center;">
                  <span style="font-size:12px;color:#6b7280;">기간</span>
                  <input id="eulFrom" class="input" style="min-width:140px;" type="date" />
                  <span style="color:#9ca3af;">~</span>
                  <input id="eulTo" class="input" style="min-width:140px;" type="date" />
                </div>

                <select id="eulEnv" class="input" style="min-width:110px;">
                  <option value="ALL">환경(전체)</option>
                  <option value="PRD">PRD</option>
                  <option value="STG">STG</option>
                  <option value="DEV">DEV</option>
                </select>

                <select id="eulStatus" class="input" style="min-width:130px;">
                  <option value="ALL">상태(전체)</option>
                  <option value="사용중">사용중</option>
                  <option value="종료">종료</option>
                  <option value="강제종료">강제종료</option>
                </select>

                <select id="eulReview" class="input" style="min-width:160px;">
                  <option value="ALL">사후승인(전체)</option>
                  <option value="대기">대기</option>
                  <option value="완료">완료</option>
                  <option value="반려">반려</option>
                </select>

                <input id="eulQ" class="input" style="min-width:260px;flex:1;" placeholder="검색(사용자/부서/ITSM/시스템/권한/계정/대상)" />

                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-left:auto;">
                  <button id="eulReset" class="btn" type="button"><i class="fa-solid fa-rotate-left"></i> 초기화</button>
                  <button id="eulExport" class="btn primary" type="button"><i class="fa-solid fa-file-export"></i> 내보내기</button>
                </div>
              </div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <div style="flex:1.15;min-width:420px;display:flex;flex-direction:column;gap:10px;">
                <div class="admin-card" style="padding:12px 14px;">
                  <div class="admin-header">
                    <h2><i class="fa-solid fa-table"></i> 세션 목록</h2>
                    <span class="badge" id="eulCount">0건</span>
                  </div>

                  <div class="table-scroll-x scope-items-wrap" style="margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow:auto;padding-bottom:6px;max-height:520px;">
                    <table class="scope-items-table" style="width:100%;min-width:980px;border-collapse:collapse;table-layout:fixed;">
                      <colgroup>
                        <col style="width:170px;">
                        <col style="width:110px;">
                        <col style="width:90px;">
                        <col style="width:180px;">
                        <col style="width:170px;">
                        <col style="width:210px;">
                        <col style="width:170px;">
                      </colgroup>
                      <thead>
                        <tr style="background:#f9fafb;">
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">세션ID</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">상태</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">ENV</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">사용자</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">시스템</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">권한/계정/대상</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">사후승인</th>
                        </tr>
                      </thead>
                      <tbody id="eulTbody"></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div style="flex:1;min-width:360px;display:flex;flex-direction:column;gap:10px;">
                <div class="admin-card" style="padding:12px 14px;">
                  <div class="admin-header">
                    <h2><i class="fa-solid fa-circle-info"></i> 상세</h2>
                    <span class="badge" id="eulSel">미선택</span>
                  </div>
                  <div id="eulDetail" style="margin-top:10px;color:#111827;">
                    <div style="color:#6b7280;font-size:13px;">좌측 목록에서 세션을 선택하세요.</div>
                  </div>
                </div>

                <div class="admin-card" style="padding:12px 14px;">
                  <div class="admin-header">
                    <h2><i class="fa-solid fa-list-check"></i> 이벤트</h2>
                    <span class="badge" id="eulEvtCount">0</span>
                  </div>

                  <div class="table-scroll-x scope-items-wrap" style="margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow:auto;padding-bottom:6px;max-height:260px;">
                    <table class="scope-items-table" style="width:100%;min-width:760px;border-collapse:collapse;table-layout:fixed;">
                      <colgroup>
                        <col style="width:170px;">
                        <col style="width:140px;">
                        <col style="width:auto;">
                      </colgroup>
                      <thead>
                        <tr style="background:#f9fafb;">
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">시각</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">유형</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">내용</th>
                        </tr>
                      </thead>
                      <tbody id="eulEvtTbody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      },

      // ---------- bind ----------
      bindOnce() {
        const bodyEl = document.getElementById("adminBody");
        if (!bodyEl) return;
        if (bodyEl.dataset.eulBound === "1") return;
        bodyEl.dataset.eulBound = "1";

        // 필터값 UI 반영
        const fromEl = document.getElementById("eulFrom");
        const toEl = document.getElementById("eulTo");
        if (fromEl) fromEl.value = this.state.filters.from || "";
        if (toEl) toEl.value = this.state.filters.to || "";

        bodyEl.addEventListener("click", (e) => {
          const row = e.target.closest("tr[data-id]");
          if (row) {
            this.state.selectedId = row.dataset.id;
            this.renderList();
            this.renderDetail();
            this.renderEvents();
            return;
          }

          const btn = e.target.closest("button");
          if (!btn) return;

          if (btn.id === "eulBack") {
            if (W.admin && typeof W.admin.show === "function") W.admin.show("sharedEmergency");
            return;
          }
          if (btn.id === "eulReset") {
            this.state.filters = { from: this._today(), to: this._today(), env:"ALL", status:"ALL", review:"ALL", q:"" };
            this.state.selectedId = null;
            this.renderAll();
            return;
          }
          if (btn.id === "eulExport") {
            this.exportFiltered();
            return;
          }

          const act = btn.dataset.action;
          const id = btn.dataset.id;
          if (!act || !id) return;

          if (act === "forceEnd") this.forceEnd(id);
          if (act === "reviewOk") this.reviewApprove(id);
          if (act === "reviewReject") this.reviewReject(id);
        });

        bodyEl.addEventListener("change", (e) => {
          const t = e.target;
          if (!t) return;
          if (t.id === "eulFrom") this.state.filters.from = t.value || "";
          if (t.id === "eulTo") this.state.filters.to = t.value || "";
          if (t.id === "eulEnv") this.state.filters.env = t.value;
          if (t.id === "eulStatus") this.state.filters.status = t.value;
          if (t.id === "eulReview") this.state.filters.review = t.value;
          this.renderAll();
        });

        bodyEl.addEventListener("input", (e) => {
          const t = e.target;
          if (!t) return;
          if (t.id === "eulQ") {
            this.state.filters.q = t.value || "";
            this.renderList();
          }
        });
      },

      // ---------- query ----------
      _filtered() {
        const { from, to, env, status, review, q } = this.state.filters;
        const kw = (q || "").trim().toLowerCase();

        return this._all()
          .filter(s => {
            const ts = s.startAt || "";
            if ((from || to) && ts && !this._inRange(ts, from, to)) return false;
            if (env !== "ALL" && s.env !== env) return false;
            if (status !== "ALL" && s.status !== status) return false;
            if (review !== "ALL" && (s.review?.status || "대기") !== review) return false;

            if (kw) {
              const blob = [
                s.id, s.env, s.system, s.target, s.privilege, s.account,
                s.requester, s.dept, s.itsm, s.reason
              ].join(" ").toLowerCase();
              if (!blob.includes(kw)) return false;
            }
            return true;
          })
          .sort((a, b) => (b.startAt || "").localeCompare(a.startAt || ""));
      },

      // ---------- render ----------
      renderAll() {
        // 필터 UI 동기화
        const fromEl = document.getElementById("eulFrom");
        const toEl = document.getElementById("eulTo");
        const envEl = document.getElementById("eulEnv");
        const stEl = document.getElementById("eulStatus");
        const rvEl = document.getElementById("eulReview");
        const qEl = document.getElementById("eulQ");

        if (fromEl) fromEl.value = this.state.filters.from || "";
        if (toEl) toEl.value = this.state.filters.to || "";
        if (envEl) envEl.value = this.state.filters.env || "ALL";
        if (stEl) stEl.value = this.state.filters.status || "ALL";
        if (rvEl) rvEl.value = this.state.filters.review || "ALL";
        if (qEl) qEl.value = this.state.filters.q || "";

        this.renderList();
        this.renderDetail();
        this.renderEvents();
        this.renderSummary();
      },

      renderSummary() {
        const badge = document.getElementById("eulSummary");
        if (!badge) return;
        const all = this._all();
        const using = all.filter(x => x.status === "사용중").length;
        const pending = all.filter(x => (x.review?.status || "대기") === "대기" && x.status !== "사용중").length;
        badge.textContent = `전체 ${all.length} · 사용중 ${using} · 사후승인 대기 ${pending}`;
      },

      renderList() {
        const tbody = document.getElementById("eulTbody");
        const countEl = document.getElementById("eulCount");
        if (!tbody || !countEl) return;

        const list = this._filtered();
        countEl.textContent = `${list.length}건`;

        const sel = this.state.selectedId;

        tbody.innerHTML = list.map(s => {
          const isSel = sel && sel === s.id;
          const trBg = isSel ? "background:#eef2ff;" : "";
          const who = `${this._esc(s.requester)}<div style="color:#9ca3af;font-size:12px;">${this._esc(s.dept || "")}</div>`;
          const sys = `${this._esc(s.system)}<div style="color:#9ca3af;font-size:12px;">${this._esc(s.itsm || "-")}</div>`;
          const scope = `
            <b>${this._esc(s.privilege)}</b>
            <div style="color:#9ca3af;font-size:12px;">
              ${this._esc(s.account)} · ${this._esc(s.target)}
            </div>
          `;
          const rv = this._reviewBadge(s.review?.status || "대기");

          return `
            <tr data-id="${this._esc(s.id)}" style="border-bottom:1px solid #f3f4f6;cursor:pointer;${trBg}">
              <td style="padding:10px;font-weight:900;">${this._esc(s.id)}</td>
              <td style="padding:10px;">${this._statusBadge(s.status)}</td>
              <td style="padding:10px;font-weight:800;">${this._esc(s.env)}</td>
              <td style="padding:10px;">${who}</td>
              <td style="padding:10px;">${sys}</td>
              <td style="padding:10px;">${scope}</td>
              <td style="padding:10px;">${rv}</td>
            </tr>
          `;
        }).join("");

        // 선택 항목이 필터로 사라졌으면 해제
        if (sel && !list.some(x => x.id === sel)) this.state.selectedId = null;
      },

      renderDetail() {
        const badge = document.getElementById("eulSel");
        const box = document.getElementById("eulDetail");
        if (!box) return;

        const id = this.state.selectedId;
        if (!id) {
          if (badge) badge.textContent = "미선택";
          box.innerHTML = `<div style="color:#6b7280;font-size:13px;">좌측 목록에서 세션을 선택하세요.</div>`;
          return;
        }

        const s = this._find(id);
        if (!s) {
          this.state.selectedId = null;
          if (badge) badge.textContent = "미선택";
          box.innerHTML = `<div style="color:#6b7280;font-size:13px;">선택된 세션을 찾을 수 없습니다.</div>`;
          return;
        }

        if (badge) badge.textContent = s.id;

        const rv = s.review || { status:"대기", by:"", at:"", comment:"" };
        const endAt = s.endAt || (s.status === "사용중" ? "-" : "");

        const btn = (label, cls, act) =>
          `<button class="${cls}" type="button" data-action="${act}" data-id="${this._esc(s.id)}">${label}</button>`;

        const actions = [];
        if (s.status === "사용중") actions.push(btn(`<i class="fa-solid fa-ban"></i> 강제 종료`, "btn primary", "forceEnd"));
        if (s.status !== "사용중" && (rv.status || "대기") === "대기") {
          actions.push(btn(`<i class="fa-solid fa-check"></i> 사후승인 완료`, "btn primary", "reviewOk"));
          actions.push(btn(`<i class="fa-solid fa-xmark"></i> 사후승인 반려`, "btn", "reviewReject"));
        }

        box.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div style="font-weight:900;font-size:14px;">세션 정보</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">${actions.join("")}</div>
          </div>

          <div style="margin-top:10px;border:1px solid var(--line);border-radius:12px;padding:10px;">
            <div style="display:grid;grid-template-columns:120px 1fr;gap:6px 10px;font-size:13px;">
              <div style="color:#6b7280;">상태</div><div>${this._statusBadge(s.status)} &nbsp; ${this._reviewBadge(rv.status || "대기")}</div>
              <div style="color:#6b7280;">ENV</div><div>${this._esc(s.env)}</div>
              <div style="color:#6b7280;">시스템</div><div>${this._esc(s.system)}</div>
              <div style="color:#6b7280;">대상</div><div>${this._esc(s.target)}</div>
              <div style="color:#6b7280;">권한</div><div><b>${this._esc(s.privilege)}</b></div>
              <div style="color:#6b7280;">계정</div><div>${this._esc(s.account)}</div>
              <div style="color:#6b7280;">요청자</div><div>${this._esc(s.requester)} <span style="color:#9ca3af;">(${this._esc(s.dept || "")})</span></div>
              <div style="color:#6b7280;">ITSM</div><div>${this._esc(s.itsm || "-")}</div>
              <div style="color:#6b7280;">시작</div><div>${this._esc(s.startAt)}</div>
              <div style="color:#6b7280;">종료</div><div>${this._esc(endAt || "-")}</div>
              <div style="color:#6b7280;">사후승인자</div><div>${this._esc(rv.by || "-")}</div>
              <div style="color:#6b7280;">사후승인시각</div><div>${this._esc(rv.at || "-")}</div>
            </div>

            <div style="margin-top:10px;">
              <div style="color:#6b7280;font-size:12px;margin-bottom:6px;">사용 사유</div>
              <div style="white-space:pre-wrap;background:#f9fafb;border:1px solid #eef2f7;border-radius:10px;padding:10px;font-size:13px;">
                ${this._esc(s.reason || "")}
              </div>
            </div>

            ${rv.comment ? `
              <div style="margin-top:10px;">
                <div style="color:#6b7280;font-size:12px;margin-bottom:6px;">사후승인 코멘트</div>
                <div style="white-space:pre-wrap;background:#fff;border:1px solid #eef2f7;border-radius:10px;padding:10px;font-size:13px;">
                  ${this._esc(rv.comment)}
                </div>
              </div>
            ` : ""}
          </div>
        `;
      },

      renderEvents() {
        const badge = document.getElementById("eulEvtCount");
        const tbody = document.getElementById("eulEvtTbody");
        if (!tbody) return;

        const id = this.state.selectedId;
        if (!id) {
          if (badge) badge.textContent = "0";
          tbody.innerHTML = `<tr><td colspan="3" style="padding:10px;color:#6b7280;">세션을 선택하면 이벤트가 표시됩니다.</td></tr>`;
          return;
        }

        const s = this._find(id);
        const evts = Array.isArray(s?.events) ? s.events : [];
        if (badge) badge.textContent = String(evts.length);

        tbody.innerHTML = evts.map(e => `
          <tr style="border-bottom:1px solid #f3f4f6;">
            <td style="padding:10px;">${this._esc(e.at || "")}</td>
            <td style="padding:10px;font-weight:900;">${this._esc(e.type || "")}</td>
            <td style="padding:10px;">${this._esc(e.detail || "")}</td>
          </tr>
        `).join("") || `<tr><td colspan="3" style="padding:10px;color:#6b7280;">(이벤트 없음)</td></tr>`;
      },

      // ---------- actions ----------
      forceEnd(id) {
        const all = this._all();
        const s = all.find(x => x.id === id);
        if (!s) return;
        if (s.status !== "사용중") return alert("사용중 세션만 강제 종료할 수 있습니다.");
        if (!confirm("해당 세션을 강제 종료할까요?")) return;

        s.endAt = this._now();
        s.status = "강제종료";
        s.events = Array.isArray(s.events) ? s.events : [];
        s.events.push({ at: s.endAt, type: "FORCE_END", detail: "관리자 강제 종료" });

        this._persistAll(all);
        this.renderList();
        this.renderDetail();
        this.renderEvents();
        this.renderSummary();
      },

      reviewApprove(id) {
        const all = this._all();
        const s = all.find(x => x.id === id);
        if (!s) return;

        this._openModal(
          `<i class="fa-solid fa-check"></i> 사후승인 완료`,
          `
            <div style="font-size:12px;color:#475569;margin-bottom:8px;">
              사후승인 코멘트(선택)를 남길 수 있습니다.
            </div>
            <textarea id="eulReviewOkComment" placeholder="예) 로그 확인 완료 / 다운로드 없음" style="width:100%;min-height:120px;"></textarea>
          `,
          [
            { label:`<i class="fa-solid fa-xmark"></i> 취소`, className:"btn", onClick: () => this._closeModal() },
            { label:`<i class="fa-solid fa-check"></i> 완료`, className:"btn primary", onClick: () => {
                const c = document.getElementById("eulReviewOkComment")?.value || "";
                s.review = { status:"완료", by:"보안담당자", at:this._now(), comment:c };
                this._persistAll(all);
                this._closeModal();
                this.renderList(); this.renderDetail(); this.renderSummary();
              }
            }
          ]
        );
      },

      reviewReject(id) {
        const all = this._all();
        const s = all.find(x => x.id === id);
        if (!s) return;

        this._openModal(
          `<i class="fa-solid fa-xmark"></i> 사후승인 반려`,
          `
            <div style="font-size:12px;color:#475569;margin-bottom:8px;">
              반려 사유를 입력하세요.
            </div>
            <textarea id="eulReviewRejectReason" placeholder="예) 사유/범위 불충분, 이벤트 로그 누락" style="width:100%;min-height:120px;"></textarea>
          `,
          [
            { label:`<i class="fa-solid fa-xmark"></i> 취소`, className:"btn", onClick: () => this._closeModal() },
            { label:`<i class="fa-solid fa-ban"></i> 반려`, className:"btn primary", onClick: () => {
                const r = (document.getElementById("eulReviewRejectReason")?.value || "").trim();
                if (!r) return alert("반려 사유를 입력하세요.");
                s.review = { status:"반려", by:"보안담당자", at:this._now(), comment:r };
                this._persistAll(all);
                this._closeModal();
                this.renderList(); this.renderDetail(); this.renderSummary();
              }
            }
          ]
        );
      },

      // ---------- export ----------
      exportFiltered() {
        const list = this._filtered();
        const payload = {
          exportedAt: this._now(),
          filters: { ...this.state.filters },
          count: list.length,
          sessions: list
        };
        const json = JSON.stringify(payload, null, 2);
        const blob = new Blob([json], { type:"application/json;charset=utf-8" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `emergency_use_log_export_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
      }
    };

    // 전역 노출
    W.emergencyUseLogAdmin = emergencyUseLogAdmin;

    // admin item handler 등록 (admin 로더 순서 안전 처리)
    const tryRegister = () => {
      if (!W.admin || typeof W.admin.registerItemHandler !== "function") return false;
      W.admin.registerItemHandler("emergencyUseLog", () => W.emergencyUseLogAdmin.open());
      return true;
    };
    if (!tryRegister()) document.addEventListener("DOMContentLoaded", () => { tryRegister(); });

  })();

  
  /* =========================================================
   * Admin 카드 클릭 연결: 공용·응급 계정 관리(sharedEmergency)
   * - 공용계정 사용 사유·승인 / 응급 권한 사용 내역 카드 클릭 시 각 open() 호출
   * - 다른 섹션/카드에는 영향 없음
   * ========================================================= */
  (function () {
    const W = window;
    if (W.__sharedEmergencyCardClickBound) return;
    W.__sharedEmergencyCardClickBound = true;

    document.addEventListener("click", (e) => {
      const card = e.target.closest?.("#adminBody .admin-card.admin-card-clickable");
      if (!card) return;
      if (!W.admin || W.admin.current !== "sharedEmergency") return;

      const title = (card.querySelector("h4")?.textContent || "").trim();

      // 1) 공용계정 사용 사유·승인
      if (title.includes("공용계정 사용 사유")) {
        e.preventDefault();
        e.stopImmediatePropagation();
        e.stopPropagation();

        if (typeof W.sharedAccountReasonAdmin?.open === "function") return W.sharedAccountReasonAdmin.open();
        if (typeof W.sharedAccountReasonAdmin?.openSharedAccountReason === "function") return W.sharedAccountReasonAdmin.openSharedAccountReason();
        console.warn("[sharedEmergency] sharedAccountReasonAdmin.open() not found");
        return;
      }

      // 2) 응급 권한 사용 내역
      if (title.includes("응급 권한 사용 내역")) {
        e.preventDefault();
        e.stopImmediatePropagation();
        e.stopPropagation();

        if (typeof W.emergencyUseLogAdmin?.open === "function") return W.emergencyUseLogAdmin.open();
        if (typeof W.emergencyUseLogAdmin?.openEmergencyUseLog === "function") return W.emergencyUseLogAdmin.openEmergencyUseLog();
        console.warn("[sharedEmergency] emergencyUseLogAdmin.open() not found");
        return;
      }
    }, true);
  })();
  
  
  /* ------------------------------------------------------------------
   * 로그 조회·감사 뷰 > 사용자 활동 로그 (activityLog)
   * - 카드 클릭 시 open() 진입
   * - localStorage 저장(필터/목록/선택 유지)
   * - export(JSON) / 샘플추가 / 목록+상세 / 페이지네이션
   * ------------------------------------------------------------------ */
  (() => {
    const W = window;

    // 이미 최신 구현이 있으면 중복 주입 방지
    if (W.activityLogAdmin && W.activityLogAdmin.__activityLogV1) {
      // 그래도 카드 바인딩 패치만 없을 수 있으니 show 패치만 보강
      try { patchAdminShowForLogAudit(); } catch (e) {}
      return;
    }

    const STORE_KEY = "DBAM_ACTIVITY_LOGS_V1";
    const UI_KEY    = "DBAM_ACTIVITY_LOG_UI_V1";
    const SEQ_KEY   = "DBAM_ACTIVITY_LOG_SEQ_V1";

    const pad2 = (n) => String(n).padStart(2, "0");
    const pad6 = (n) => String(n).padStart(6, "0");

    const esc = (s) =>
      String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");

    function todayLocal() {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    }
    function daysAgo(n) {
      const d = new Date();
      d.setDate(d.getDate() - n);
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    }
    function fmtLocal(ts) {
      const d = new Date(ts);
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())} ${pad2(
        d.getHours()
      )}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }
    function getCurrentEnvLabel() {
      try {
        const b = document.body;
        if (b.classList.contains("env-prod")) return "PROD";
        if (b.classList.contains("env-qa")) return "QA";
        if (b.classList.contains("env-dev")) return "DEV";
        const meta = document.getElementById("envBannerMeta")?.textContent || "";
        const token = meta.split("·")[0].trim();
        if (token) return token.toUpperCase();
      } catch (e) {}
      return "DEV";
    }
    function downloadText(filename, text, mime = "application/json;charset=utf-8") {
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1500);
    }

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      } catch (e) {
        return fallback;
      }
    }
    function saveJSON(key, v) {
      try { localStorage.setItem(key, JSON.stringify(v)); } catch (e) {}
    }

    function seedLogs() {
      const base = Date.now();
      const mk = (minusH, env, user, cat, action, target, result, sev, ip, ua, detail) => ({
        id: "", // 나중에 부여
        ts: base - minusH * 3600 * 1000,
        env, user, cat, action, target, result, sev,
        ip, ua,
        detail
      });

      return [
        mk(2,  "PROD", "박운영", "LOGIN", "LOGIN_SUCCESS", "관리콘솔", "SUCCESS", "INFO", "10.10.2.15", "Chrome", "로그인 성공"),
        mk(3,  "PROD", "박운영", "MENU",  "OPEN_SECTION", "공용·응급 계정 관리", "SUCCESS", "INFO", "10.10.2.15", "Chrome", "섹션 진입"),
        mk(5,  "PROD", "김개발", "MENU",  "OPEN_ITEM", "공용계정 사용 사유·승인", "SUCCESS", "INFO", "10.10.3.21", "Chrome", "항목 화면 진입"),
        mk(9,  "QA",   "이테스트", "LOGIN", "LOGIN_FAIL", "관리콘솔", "FAIL", "WARN", "10.20.1.10", "Edge", "비밀번호 오류(2회차)"),
        mk(15, "DEV",  "김개발", "MENU",  "OPEN_SECTION", "로그 조회·감사 뷰", "SUCCESS", "INFO", "192.168.0.24", "Chrome", "감사 섹션 진입"),
        mk(20, "DEV",  "김개발", "EXPORT","EXPORT_LOGS", "사용자 활동 로그", "SUCCESS", "INFO", "192.168.0.24", "Chrome", "필터 결과 JSON 내보내기"),
      ].map((x, i) => ({ ...x, _seedIdx: i }));
    }

    function ensureStore() {
      const cur = loadJSON(STORE_KEY, null);
      if (cur && Array.isArray(cur) && cur.length) return cur;

      // seq 초기화 + seed
      let seq = Number(localStorage.getItem(SEQ_KEY) || "0");
      const seeded = seedLogs().map((x) => {
        seq += 1;
        const d = new Date(x.ts);
        const ymd = `${d.getFullYear()}${pad2(d.getMonth() + 1)}${pad2(d.getDate())}`;
        return { ...x, id: `AL-${ymd}-${pad6(seq)}` };
      });
      localStorage.setItem(SEQ_KEY, String(seq));
      saveJSON(STORE_KEY, seeded);
      return seeded;
    }

    function nextId(ts) {
      let seq = Number(localStorage.getItem(SEQ_KEY) || "0");
      seq += 1;
      localStorage.setItem(SEQ_KEY, String(seq));
      const d = new Date(ts);
      const ymd = `${d.getFullYear()}${pad2(d.getMonth() + 1)}${pad2(d.getDate())}`;
      return `AL-${ymd}-${pad6(seq)}`;
    }

    function sevBadge(sev) {
      const map = {
        INFO: { bg: "#eff6ff", fg: "#1d4ed8" },
        WARN: { bg: "#fff7ed", fg: "#9a3412" },
        HIGH: { bg: "#fef2f2", fg: "#b91c1c" },
      };
      const c = map[sev] || { bg: "#f3f4f6", fg: "#374151" };
      return `<span style="display:inline-block;padding:2px 8px;border-radius:999px;background:${c.bg};color:${c.fg};font-size:12px;font-weight:800;">${esc(sev)}</span>`;
    }
    function resBadge(res) {
      const c = res === "SUCCESS"
        ? { bg: "#ecfdf5", fg: "#047857" }
        : { bg: "#fef2f2", fg: "#b91c1c" };
      return `<span style="display:inline-block;padding:2px 8px;border-radius:999px;background:${c.bg};color:${c.fg};font-size:12px;font-weight:800;">${esc(res)}</span>`;
    }

    const activityLogAdmin = {
      __activityLogV1: true,
      state: {
        filters: {
          from: daysAgo(7),
          to: todayLocal(),
          env: "ALL",
          cat: "ALL",
          result: "ALL",
          sev: "ALL",
          user: "",
          q: "",
        },
        page: 1,
        pageSize: 20,
        selectedId: null,
      },

      open() {
        const ov = document.getElementById("adminOverlay");
        if (ov) { ov.classList.add("show"); ov.setAttribute("aria-hidden", "false"); }

        // nav active: logAudit
        try {
          document.querySelectorAll(".admin-nav button").forEach((b) => {
            const sid = b.dataset?.section || b.getAttribute("data-section");
            b.classList.toggle("active", sid === "logAudit");
          });
        } catch (e) {}

        const titleEl = document.getElementById("adminTitle");
        const descEl  = document.getElementById("adminDesc");
        const bodyEl  = document.getElementById("adminBody");
        if (!titleEl || !descEl || !bodyEl) return;

        titleEl.innerHTML = `<i class="fa-solid fa-person-walking"></i> 사용자 활동 로그`;
        descEl.textContent = "로그인/메뉴 사용/내보내기 등 사용자 주요 활동 이벤트를 기간·사용자·환경별로 조회합니다.";

        // UI 상태 복원
        const saved = loadJSON(UI_KEY, null);
        if (saved && saved.filters) this.state.filters = { ...this.state.filters, ...saved.filters };
        if (saved && saved.page) this.state.page = saved.page;
        if (saved && saved.selectedId !== undefined) this.state.selectedId = saved.selectedId;

        bodyEl.innerHTML = this.getTemplateHtml();
        this.bindOnce();
        this.renderAll();
      },

      getTemplateHtml() {
        return `
          <div id="alPage" class="emg-page" style="display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
              <div style="display:flex;gap:8px;align-items:center;">
                <button id="alBack" class="btn" type="button"><i class="fa-solid fa-arrow-left"></i></button>
                <div style="font-weight:900;">사용자 활동 로그</div>
              </div>
              <div style="font-size:12px;color:var(--muted);">
                기간/사용자/환경/유형/결과/심각도 필터 + 상세 확인
              </div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <div style="flex:1.35;min-width:520px;display:flex;flex-direction:column;gap:10px;">
                <div class="admin-card" style="padding:12px 14px;">
                  <div class="admin-header">
                    <h2><i class="fa-solid fa-list"></i> 목록</h2>
                    <span class="badge" id="alCount">0건</span>
                  </div>

                  <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:10px;">
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                      <input id="alFrom" class="input" type="date" style="min-width:140px;" />
                      <input id="alTo" class="input" type="date" style="min-width:140px;" />

                      <select id="alEnv" class="input" style="min-width:110px;">
                        <option value="ALL">환경(전체)</option>
                        <option value="PROD">PROD</option>
                        <option value="QA">QA</option>
                        <option value="DEV">DEV</option>
                      </select>

                      <select id="alCat" class="input" style="min-width:130px;">
                        <option value="ALL">유형(전체)</option>
                        <option value="LOGIN">LOGIN</option>
                        <option value="MENU">MENU</option>
                        <option value="EXPORT">EXPORT</option>
                        <option value="APPROVAL">APPROVAL</option>
                        <option value="ADMIN">ADMIN</option>
                      </select>

                      <select id="alResult" class="input" style="min-width:120px;">
                        <option value="ALL">결과(전체)</option>
                        <option value="SUCCESS">SUCCESS</option>
                        <option value="FAIL">FAIL</option>
                      </select>

                      <select id="alSev" class="input" style="min-width:120px;">
                        <option value="ALL">심각도(전체)</option>
                        <option value="INFO">INFO</option>
                        <option value="WARN">WARN</option>
                        <option value="HIGH">HIGH</option>
                      </select>
                    </div>

                    <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                      <input id="alUser" class="input" style="min-width:160px;" placeholder="사용자" />
                      <input id="alQ" class="input" style="min-width:240px;" placeholder="검색(액션/대상/상세/IP)" />
                      <button id="alAdd" class="btn" type="button"><i class="fa-solid fa-plus"></i> 샘플추가</button>
                      <button id="alExport" class="btn" type="button"><i class="fa-solid fa-file-export"></i> 내보내기</button>
                    </div>
                  </div>

                  <div class="table-scroll-x scope-items-wrap"
                       style="margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow:auto;padding-bottom:6px;max-height:560px;">
                    <table class="scope-items-table" style="width:100%;min-width:980px;border-collapse:collapse;table-layout:fixed;">
                      <colgroup>
                        <col style="width:170px;">
                        <col style="width:90px;">
                        <col style="width:140px;">
                        <col style="width:130px;">
                        <col style="width:220px;">
                        <col style="width:110px;">
                        <col style="width:120px;">
                      </colgroup>
                      <thead>
                        <tr style="background:#f9fafb;">
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">시간</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">환경</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">사용자</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">유형</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">액션/대상</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">결과</th>
                          <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">심각도</th>
                        </tr>
                      </thead>
                      <tbody id="alTbody"></tbody>
                    </table>
                  </div>

                  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-top:10px;">
                    <div style="color:#6b7280;font-size:12px;" id="alPageInfo">-</div>
                    <div style="display:flex;gap:8px;align-items:center;">
                      <button id="alPrev" class="btn" type="button"><i class="fa-solid fa-chevron-left"></i></button>
                      <button id="alNext" class="btn" type="button"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                  </div>
                </div>
              </div>

              <div style="flex:1;min-width:340px;display:flex;flex-direction:column;gap:10px;">
                <div class="admin-card" style="padding:12px 14px;">
                  <div class="admin-header">
                    <h2><i class="fa-solid fa-circle-info"></i> 상세</h2>
                    <span class="badge" id="alSelBadge">미선택</span>
                  </div>
                  <div id="alDetail" style="margin-top:10px;color:#111827;">
                    <div style="color:#6b7280;font-size:13px;">좌측 목록에서 로그를 선택하세요.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      },

      bindOnce() {
        const bodyEl = document.getElementById("adminBody");
        if (!bodyEl) return;
        if (bodyEl.dataset.alBound === "1") return;
        bodyEl.dataset.alBound = "1";

        bodyEl.addEventListener("click", (e) => {
          const btn = e.target.closest("button");
          const row = e.target.closest("tr[data-id]");
          if (row) {
            this.state.selectedId = row.dataset.id;
            this.persistUI();
            this.renderList();   // 선택 강조
            this.renderDetail();
            return;
          }
          if (!btn) return;

          if (btn.id === "alBack") {
            if (W.admin && typeof W.admin.show === "function") W.admin.show("logAudit");
            return;
          }
          if (btn.id === "alPrev") {
            this.state.page = Math.max(1, (this.state.page || 1) - 1);
            this.persistUI();
            this.renderList();
            this.renderDetail();
            return;
          }
          if (btn.id === "alNext") {
            this.state.page = (this.state.page || 1) + 1;
            this.persistUI();
            this.renderList();
            this.renderDetail();
            return;
          }
          if (btn.id === "alExport") {
            this.exportFiltered();
            return;
          }
          if (btn.id === "alAdd") {
            this.addSampleNow();
            return;
          }
        });

        bodyEl.addEventListener("change", (e) => {
          const t = e.target;
          if (!t) return;

          if (t.id === "alFrom") this.state.filters.from = t.value || daysAgo(7);
          if (t.id === "alTo")   this.state.filters.to   = t.value || todayLocal();
          if (t.id === "alEnv")  this.state.filters.env  = t.value;
          if (t.id === "alCat")  this.state.filters.cat  = t.value;
          if (t.id === "alResult") this.state.filters.result = t.value;
          if (t.id === "alSev")    this.state.filters.sev = t.value;

          this.state.page = 1;
          this.persistUI();
          this.renderAll();
        });

        bodyEl.addEventListener("input", (e) => {
          const t = e.target;
          if (!t) return;

          if (t.id === "alUser") this.state.filters.user = t.value || "";
          if (t.id === "alQ")    this.state.filters.q    = t.value || "";

          this.state.page = 1;
          this.persistUI();
          this.renderList();
          this.renderDetail();
        });
      },

      persistUI() {
        saveJSON(UI_KEY, {
          filters: this.state.filters,
          page: this.state.page,
          selectedId: this.state.selectedId,
        });
      },

      // ----- data -----
      getAll() {
        return ensureStore();
      },
      saveAll(arr) {
        saveJSON(STORE_KEY, arr);
      },
      findById(id) {
        return this.getAll().find((x) => x.id === id);
      },

      filtered() {
        const { from, to, env, cat, result, sev, user, q } = this.state.filters;
        const kwUser = (user || "").trim().toLowerCase();
        const kw = (q || "").trim().toLowerCase();

        const fromD = from ? new Date(from + "T00:00:00").getTime() : 0;
        const toD   = to ? new Date(to + "T23:59:59").getTime() : Date.now();

        return this.getAll()
          .filter((r) => {
            if (r.ts < fromD || r.ts > toD) return false;
            if (env !== "ALL" && r.env !== env) return false;
            if (cat !== "ALL" && r.cat !== cat) return false;
            if (result !== "ALL" && r.result !== result) return false;
            if (sev !== "ALL" && r.sev !== sev) return false;

            if (kwUser && !(String(r.user || "").toLowerCase().includes(kwUser))) return false;

            if (kw) {
              const blob = [
                r.action, r.target, r.detail, r.ip, r.ua, r.user, r.env, r.cat
              ].join(" ").toLowerCase();
              if (!blob.includes(kw)) return false;
            }
            return true;
          })
          .sort((a, b) => b.ts - a.ts);
      },

      // ----- render -----
      renderAll() {
        // filter inputs sync
        const f = this.state.filters;

        const setVal = (id, v) => {
          const el = document.getElementById(id);
          if (el) el.value = v ?? "";
        };
        setVal("alFrom", f.from);
        setVal("alTo", f.to);
        setVal("alEnv", f.env);
        setVal("alCat", f.cat);
        setVal("alResult", f.result);
        setVal("alSev", f.sev);
        setVal("alUser", f.user);
        setVal("alQ", f.q);

        this.renderList();
        this.renderDetail();
      },

      renderList() {
        const tbody = document.getElementById("alTbody");
        const countEl = document.getElementById("alCount");
        const pageInfo = document.getElementById("alPageInfo");
        if (!tbody || !countEl) return;

        const list = this.filtered();
        countEl.textContent = `${list.length}건`;

        const ps = Number(this.state.pageSize || 20);
        const page = Math.max(1, Number(this.state.page || 1));
        const totalPages = Math.max(1, Math.ceil(list.length / ps));
        const safePage = Math.min(page, totalPages);
        if (safePage !== page) this.state.page = safePage;

        const startIdx = (safePage - 1) * ps;
        const pageList = list.slice(startIdx, startIdx + ps);

        const selId = this.state.selectedId;

        tbody.innerHTML = pageList
          .map((r) => {
            const isSel = selId && selId === r.id;
            const trBg = isSel ? "background:#eef2ff;" : "";
            const act = `${esc(r.action || "")}<div style="color:#9ca3af;font-size:12px;">${esc(
              r.target || ""
            )}</div>`;
            return `
              <tr data-id="${esc(r.id)}" style="border-bottom:1px solid #f3f4f6;cursor:pointer;${trBg}">
                <td style="padding:10px;font-weight:800;">${esc(fmtLocal(r.ts))}</td>
                <td style="padding:10px;">${esc(r.env || "")}</td>
                <td style="padding:10px;">${esc(r.user || "")}<div style="color:#9ca3af;font-size:12px;">${esc(r.ip || "")}</div></td>
                <td style="padding:10px;">${esc(r.cat || "")}</td>
                <td style="padding:10px;">${act}</td>
                <td style="padding:10px;">${resBadge(r.result || "")}</td>
                <td style="padding:10px;">${sevBadge(r.sev || "")}</td>
              </tr>
            `;
          })
          .join("");

        if (pageInfo) {
          pageInfo.textContent = `Page ${safePage} / ${totalPages} · 표시 ${startIdx + 1}-${Math.min(
            startIdx + ps,
            list.length
          )} / ${list.length}`;
        }

        // 선택된 항목이 필터/페이지로 사라지면 선택 해제
        if (selId && !list.some((x) => x.id === selId)) {
          this.state.selectedId = null;
          this.persistUI();
          const badge = document.getElementById("alSelBadge");
          if (badge) badge.textContent = "미선택";
        }
      },

      renderDetail() {
        const badge = document.getElementById("alSelBadge");
        const box = document.getElementById("alDetail");
        if (!box) return;

        const id = this.state.selectedId;
        if (!id) {
          if (badge) badge.textContent = "미선택";
          box.innerHTML = `<div style="color:#6b7280;font-size:13px;">좌측 목록에서 로그를 선택하세요.</div>`;
          return;
        }

        const r = this.findById(id);
        if (!r) {
          this.state.selectedId = null;
          this.persistUI();
          if (badge) badge.textContent = "미선택";
          box.innerHTML = `<div style="color:#6b7280;font-size:13px;">선택된 로그를 찾을 수 없습니다.</div>`;
          return;
        }

        if (badge) badge.textContent = r.id;

        const rows = [
          ["ID", esc(r.id)],
          ["시간", esc(fmtLocal(r.ts))],
          ["환경", esc(r.env)],
          ["사용자", esc(r.user)],
          ["IP", esc(r.ip || "-")],
          ["User-Agent", esc(r.ua || "-")],
          ["유형", esc(r.cat)],
          ["액션", esc(r.action)],
          ["대상", esc(r.target)],
          ["결과", resBadge(r.result)],
          ["심각도", sevBadge(r.sev)],
        ];

        box.innerHTML = `
          <div style="border:1px solid var(--line);border-radius:12px;padding:10px;">
            <div style="display:grid;grid-template-columns:110px 1fr;gap:6px 10px;font-size:13px;">
              ${rows
                .map(
                  ([k, v]) => `
                <div style="color:#6b7280;">${k}</div>
                <div>${v}</div>
              `
                )
                .join("")}
            </div>

            <div style="margin-top:10px;">
              <div style="color:#6b7280;font-size:12px;margin-bottom:6px;">상세</div>
              <div style="white-space:pre-wrap;background:#f9fafb;border:1px solid #eef2f7;border-radius:10px;padding:10px;font-size:13px;">
                ${esc(r.detail || "")}
              </div>
            </div>

            <div style="margin-top:10px;">
              <div style="color:#6b7280;font-size:12px;margin-bottom:6px;">원본(JSON)</div>
              <pre style="margin:0;white-space:pre-wrap;background:#0b1020;color:#e5e7eb;border-radius:10px;padding:10px;font-size:12px;">${esc(
                JSON.stringify(r, null, 2)
              )}</pre>
            </div>
          </div>
        `;
      },

      // ----- actions -----
      addSampleNow() {
        const all = this.getAll().slice();
        const now = Date.now();
        const env = getCurrentEnvLabel();
        const id = nextId(now);

        const sample = {
          id,
          ts: now,
          env,
          user: "김개발",
          cat: "MENU",
          action: "OPEN_ITEM",
          target: "사용자 활동 로그",
          result: "SUCCESS",
          sev: "INFO",
          ip: "192.168.0.24",
          ua: navigator.userAgent || "browser",
          detail: "사용자 활동 로그 화면 진입",
        };

        all.unshift(sample);
        this.saveAll(all);

        this.state.selectedId = id;
        this.state.page = 1;
        this.persistUI();
        this.renderAll();
      },

      exportFiltered() {
        const list = this.filtered();
        const payload = {
          exportedAt: fmtLocal(Date.now()),
          filters: { ...this.state.filters },
          count: list.length,
          logs: list,
        };
        downloadText(
          `activity_log_export_${Date.now()}.json`,
          JSON.stringify(payload, null, 2)
        );
      },

      // ----- card binding (logAudit 섹션에서만) -----
      attachActivityLogCardHandler() {
        const bodyEl = document.getElementById("adminBody");
        if (!bodyEl) return;

        // 카드 타이틀로 찾기 (섹션 내부 카드만 대상)
        const cards = bodyEl.querySelectorAll(".admin-card");
        let target = null;

        cards.forEach((card) => {
          const t = (card.querySelector("h4")?.textContent || "").trim();
          if (t.includes("사용자 활동 로그")) target = card;
        });

        if (!target) return;

        // 중복 바인딩 방지
        if (target.dataset.activityLogBound === "1") return;
        target.dataset.activityLogBound = "1";

        target.classList.add("admin-card-clickable");
        target.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          this.open();
        });

        const footer = target.querySelector(".admin-footer, .card-footer");
        if (footer) footer.textContent = "클릭하여 사용자 활동 로그 조회 화면을 엽니다.";
      },
    };

    // 전역 노출
    W.activityLogAdmin = activityLogAdmin;

    // (선택) 라우터 패치가 남아있어도 동작하도록 핸들러만 등록 (라우터를 새로 만들진 않음)
    try {
      if (W.admin && typeof W.admin.registerItemHandler === "function") {
        W.admin.registerItemHandler("activityLog", () => activityLogAdmin.open());
      }
    } catch (e) {}

    // 이미 logAudit 화면이 떠있는 상태에서 붙이는 경우 대비
    try {
      const active = document.querySelector(".admin-nav button.active");
      const sid = active?.dataset?.section || active?.getAttribute("data-section");
      if (sid === "logAudit") activityLogAdmin.attachActivityLogCardHandler();
    } catch (e) {}
  })();

   /* ------------------------------------------------------------------
    * 로그 조회·감사 뷰 > DB 접속·SQL 실행·다운로드 로그 (dbAccessLog)
    * - 필터(기간/환경/이벤트/DB/계정유형/결과/심각도/사용자/검색) + 목록/상세
    * - localStorage 저장(필터/페이지/선택 유지)
    * - 내보내기(JSON) / 샘플 추가
    * - logAudit 섹션에서 해당 카드만 클릭 바인딩(다른 카드 영향 없음)
    * ------------------------------------------------------------------ */
   (() => {
     const W = window;

     // 중복 주입 방지
     if (W.dbAccessLogAdmin && W.dbAccessLogAdmin.__dbAccessLogV1) {
       try { patchAdminShowForLogAudit_DbAccess(); } catch (e) {}
       return;
     }

     const STORE_KEY = "DBAM_DB_ACCESS_LOGS_V1";
     const UI_KEY    = "DBAM_DB_ACCESS_LOG_UI_V1";
     const SEQ_KEY   = "DBAM_DB_ACCESS_LOG_SEQ_V1";

     const pad2 = (n) => String(n).padStart(2, "0");
     const pad6 = (n) => String(n).padStart(6, "0");

     const esc = (s) =>
       String(s ?? "")
         .replaceAll("&", "&amp;")
         .replaceAll("<", "&lt;")
         .replaceAll(">", "&gt;")
         .replaceAll('"', "&quot;")
         .replaceAll("'", "&#39;");

     function todayLocal() {
       const d = new Date();
       return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
     }
     function daysAgo(n) {
       const d = new Date();
       d.setDate(d.getDate() - n);
       return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
     }
     function fmtLocal(ts) {
       const d = new Date(ts);
       return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())} ${pad2(
         d.getHours()
       )}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
     }
     function hash32(str) {
       const s = String(str ?? "");
       let h = 0;
       for (let i = 0; i < s.length; i++) {
         h = ((h << 5) - h + s.charCodeAt(i)) | 0;
       }
       return "H" + (h >>> 0).toString(16).toUpperCase();
     }
     function loadJSON(key, fallback) {
       try {
         const raw = localStorage.getItem(key);
         if (!raw) return fallback;
         return JSON.parse(raw);
       } catch (e) {
         return fallback;
       }
     }
     function saveJSON(key, v) {
       try { localStorage.setItem(key, JSON.stringify(v)); } catch (e) {}
     }
     function nextId(ts) {
       let seq = Number(localStorage.getItem(SEQ_KEY) || "0");
       seq += 1;
       localStorage.setItem(SEQ_KEY, String(seq));
       const d = new Date(ts);
       const ymd = `${d.getFullYear()}${pad2(d.getMonth() + 1)}${pad2(d.getDate())}`;
       return `DBL-${ymd}-${pad6(seq)}`;
     }
     function downloadText(filename, text, mime = "application/json;charset=utf-8") {
       const blob = new Blob([text], { type: mime });
       const url = URL.createObjectURL(blob);
       const a = document.createElement("a");
       a.href = url;
       a.download = filename;
       document.body.appendChild(a);
       a.click();
       a.remove();
       setTimeout(() => URL.revokeObjectURL(url), 1500);
     }

     function sevBadge(sev) {
       const map = {
         INFO: { bg: "#eff6ff", fg: "#1d4ed8" },
         WARN: { bg: "#fff7ed", fg: "#9a3412" },
         HIGH: { bg: "#fef2f2", fg: "#b91c1c" },
       };
       const c = map[sev] || { bg: "#f3f4f6", fg: "#374151" };
       return `<span style="display:inline-block;padding:2px 8px;border-radius:999px;background:${c.bg};color:${c.fg};font-size:12px;font-weight:800;">${esc(sev)}</span>`;
     }
     function resBadge(res) {
       const map = {
         SUCCESS: { bg: "#ecfdf5", fg: "#047857" },
         FAIL:    { bg: "#fef2f2", fg: "#b91c1c" },
         BLOCK:   { bg: "#fef3c7", fg: "#92400e" },
       };
       const c = map[res] || { bg: "#f3f4f6", fg: "#374151" };
       return `<span style="display:inline-block;padding:2px 8px;border-radius:999px;background:${c.bg};color:${c.fg};font-size:12px;font-weight:800;">${esc(res)}</span>`;
     }
     function evtBadge(evt) {
       const map = {
         CONNECT:  { bg: "#eef2ff", fg: "#3730a3" },
         SQL:      { bg: "#eff6ff", fg: "#1d4ed8" },
         DOWNLOAD: { bg: "#f0fdf4", fg: "#166534" },
       };
       const c = map[evt] || { bg: "#f3f4f6", fg: "#374151" };
       return `<span style="display:inline-block;padding:2px 8px;border-radius:999px;background:${c.bg};color:${c.fg};font-size:12px;font-weight:800;">${esc(evt)}</span>`;
     }

     function seedDbAccessLogs() {
       const base = Date.now();
       const mk = (minusMin, env, user, accountType, accountId, db, evt, action, result, sev, rows, durMs, ip, app, sqlText, dl) => {
         const ts = base - minusMin * 60 * 1000;
         const sql = sqlText || "";
         return {
           id: "",
           ts,
           env,
           user,
           accountType,   // INDIVIDUAL | SHARED | EMERGENCY
           accountId,
           db,
           event: evt,    // CONNECT | SQL | DOWNLOAD
           action,        // e.g. DB_LOGIN / EXECUTE / EXPORT
           result,        // SUCCESS | FAIL | BLOCK
           severity: sev, // INFO | WARN | HIGH
           rows: Number(rows || 0),
           durationMs: Number(durMs || 0),
           clientIp: ip || "",
           app: app || "",
           sql,
           sqlHash: sql ? hash32(sql) : "",
           download: dl || null, // { format, fileName, sizeKB, reason }
           ticket: "",
           reasonRef: "",     // sharedAccountReason 같은 외부 참조 ID가 있으면 표시
           emergencyRef: "",  // emergencyUseLog 같은 외부 참조 ID가 있으면 표시
           note: "",
         };
       };

       return [
         mk( 30, "PROD", "박운영", "EMERGENCY", "EA-OPS-DBA", "ORA-PROD", "CONNECT",  "DB_LOGIN",  "SUCCESS", "INFO", 0, 1200, "10.10.2.15", "AdminConsole", "", null),
         mk( 28, "PROD", "박운영", "EMERGENCY", "EA-OPS-DBA", "ORA-PROD", "SQL",      "EXECUTE",   "SUCCESS", "WARN", 12, 840,  "10.10.2.15", "SQLRunner", "SELECT * FROM TB_SESSION WHERE STATUS='BLOCKED' AND ROWNUM < 50", null),
         mk( 26, "PROD", "김개발", "SHARED",    "oracle",     "CRM-PROD", "CONNECT",  "DB_LOGIN",  "SUCCESS", "INFO", 0, 900,  "10.10.3.21", "AdminConsole", "", null),
         mk( 25, "PROD", "김개발", "SHARED",    "oracle",     "CRM-PROD", "SQL",      "EXECUTE",   "BLOCK",   "HIGH", 0, 20,   "10.10.3.21", "SQLRunner", "DELETE FROM TB_CUSTOMER", null),
         mk( 20, "QA",   "이테스트","INDIVIDUAL","u-qa-102",  "CRM-QA",   "SQL",      "EXECUTE",   "SUCCESS", "INFO", 150, 350, "10.20.1.10", "SQLRunner", "SELECT CUST_ID, NAME, PHONE FROM TB_CUSTOMER WHERE ROWNUM < 200", null),
         mk( 18, "QA",   "이테스트","INDIVIDUAL","u-qa-102",  "CRM-QA",   "DOWNLOAD", "EXPORT_CSV","SUCCESS", "WARN", 150, 1200,"10.20.1.10", "Exporter", "", { format:"CSV", fileName:"customer_export.csv", sizeKB: 220, reason:"QA 검증용" }),
       ];
     }

     function ensureStore() {
       const cur = loadJSON(STORE_KEY, null);
       if (Array.isArray(cur) && cur.length) return cur;

       let seq = Number(localStorage.getItem(SEQ_KEY) || "0");
       const seeded = seedDbAccessLogs().map((x) => {
         seq += 1;
         const d = new Date(x.ts);
         const ymd = `${d.getFullYear()}${pad2(d.getMonth() + 1)}${pad2(d.getDate())}`;
         return { ...x, id: `DBL-${ymd}-${pad6(seq)}` };
       });
       localStorage.setItem(SEQ_KEY, String(seq));
       saveJSON(STORE_KEY, seeded);
       return seeded;
     }

     const dbAccessLogAdmin = {
       __dbAccessLogV1: true,
       state: {
         filters: {
           from: daysAgo(7),
           to: todayLocal(),
           env: "ALL",
           event: "ALL",        // CONNECT | SQL | DOWNLOAD
           db: "ALL",
           accountType: "ALL",  // INDIVIDUAL | SHARED | EMERGENCY
           result: "ALL",       // SUCCESS | FAIL | BLOCK
           severity: "ALL",     // INFO | WARN | HIGH
           user: "",
           q: "",
         },
         page: 1,
         pageSize: 20,
         selectedId: null,
       },

       open() {
         const ov = document.getElementById("adminOverlay");
         if (ov) { ov.classList.add("show"); ov.setAttribute("aria-hidden", "false"); }

         // nav active: logAudit
         try {
           document.querySelectorAll(".admin-nav button").forEach((b) => {
             const sid = b.dataset?.section || b.getAttribute("data-section");
             b.classList.toggle("active", sid === "logAudit");
           });
         } catch (e) {}

         const titleEl = document.getElementById("adminTitle");
         const descEl  = document.getElementById("adminDesc");
         const bodyEl  = document.getElementById("adminBody");
         if (!titleEl || !descEl || !bodyEl) return;

         titleEl.innerHTML = `<i class="fa-solid fa-file-lines"></i> DB 접속·SQL 실행·다운로드 로그`;
         descEl.textContent = "DB 접속/SQL 실행/다운로드 이벤트를 기간·DB·계정유형·결과 기준으로 조회합니다.";

         const saved = loadJSON(UI_KEY, null);
         if (saved?.filters) this.state.filters = { ...this.state.filters, ...saved.filters };
         if (saved?.page) this.state.page = saved.page;
         if (saved?.selectedId !== undefined) this.state.selectedId = saved.selectedId;

         bodyEl.innerHTML = this.getTemplateHtml();
         this.bindOnce();
         this.renderAll();
       },

       getTemplateHtml() {
         return `
           <div id="dblPage" class="emg-page" style="display:flex;flex-direction:column;gap:10px;">
             <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
               <div style="display:flex;gap:8px;align-items:center;">
                 <button id="dblBack" class="btn" type="button"><i class="fa-solid fa-arrow-left"></i></button>
                 <div style="font-weight:900;">DB 접속·SQL 실행·다운로드 로그</div>
               </div>
               <div style="font-size:12px;color:var(--muted);">CONNECT / SQL / DOWNLOAD 이벤트 통합 조회</div>
             </div>

             <div style="display:flex;gap:10px;flex-wrap:wrap;">
               <div style="flex:1.45;min-width:560px;display:flex;flex-direction:column;gap:10px;">
                 <div class="admin-card" style="padding:12px 14px;">
                   <div class="admin-header">
                     <h2><i class="fa-solid fa-list"></i> 목록</h2>
                     <span class="badge" id="dblCount">0건</span>
                   </div>

                   <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:10px;">
                     <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                       <input id="dblFrom" class="input" type="date" style="min-width:140px;" />
                       <input id="dblTo" class="input" type="date" style="min-width:140px;" />

                       <select id="dblEnv" class="input" style="min-width:110px;">
                         <option value="ALL">환경(전체)</option>
                         <option value="PROD">PROD</option>
                         <option value="QA">QA</option>
                         <option value="DEV">DEV</option>
                       </select>

                       <select id="dblEvent" class="input" style="min-width:120px;">
                         <option value="ALL">이벤트(전체)</option>
                         <option value="CONNECT">CONNECT</option>
                         <option value="SQL">SQL</option>
                         <option value="DOWNLOAD">DOWNLOAD</option>
                       </select>

                       <select id="dblDb" class="input" style="min-width:140px;">
                         <option value="ALL">DB(전체)</option>
                       </select>

                       <select id="dblAcctType" class="input" style="min-width:140px;">
                         <option value="ALL">계정유형(전체)</option>
                         <option value="INDIVIDUAL">INDIVIDUAL</option>
                         <option value="SHARED">SHARED</option>
                         <option value="EMERGENCY">EMERGENCY</option>
                       </select>

                       <select id="dblResult" class="input" style="min-width:120px;">
                         <option value="ALL">결과(전체)</option>
                         <option value="SUCCESS">SUCCESS</option>
                         <option value="FAIL">FAIL</option>
                         <option value="BLOCK">BLOCK</option>
                       </select>

                       <select id="dblSev" class="input" style="min-width:120px;">
                         <option value="ALL">심각도(전체)</option>
                         <option value="INFO">INFO</option>
                         <option value="WARN">WARN</option>
                         <option value="HIGH">HIGH</option>
                       </select>
                     </div>

                     <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                       <input id="dblUser" class="input" style="min-width:160px;" placeholder="사용자" />
                       <input id="dblQ" class="input" style="min-width:240px;" placeholder="검색(DB/계정/액션/SQL해시/IP/파일명)" />
                       <button id="dblAdd" class="btn" type="button"><i class="fa-solid fa-plus"></i> 샘플추가</button>
                       <button id="dblExport" class="btn" type="button"><i class="fa-solid fa-file-export"></i> 내보내기</button>
                     </div>
                   </div>

                   <div class="table-scroll-x scope-items-wrap"
                        style="margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow:auto;padding-bottom:6px;max-height:560px;">
                     <table class="scope-items-table" style="width:100%;min-width:1100px;border-collapse:collapse;table-layout:fixed;">
                       <colgroup>
                         <col style="width:170px;">
                         <col style="width:90px;">
                         <col style="width:220px;">
                         <col style="width:140px;">
                         <col style="width:280px;">
                         <col style="width:110px;">
                         <col style="width:110px;">
                         <col style="width:110px;">
                       </colgroup>
                       <thead>
                         <tr style="background:#f9fafb;">
                           <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">시간</th>
                           <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">환경</th>
                           <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">사용자/계정</th>
                           <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">DB</th>
                           <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">이벤트</th>
                           <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">Rows</th>
                           <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">결과</th>
                           <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">심각도</th>
                         </tr>
                       </thead>
                       <tbody id="dblTbody"></tbody>
                     </table>
                   </div>

                   <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-top:10px;">
                     <div style="color:#6b7280;font-size:12px;" id="dblPageInfo">-</div>
                     <div style="display:flex;gap:8px;align-items:center;">
                       <button id="dblPrev" class="btn" type="button"><i class="fa-solid fa-chevron-left"></i></button>
                       <button id="dblNext" class="btn" type="button"><i class="fa-solid fa-chevron-right"></i></button>
                     </div>
                   </div>
                 </div>
               </div>

               <div style="flex:1;min-width:360px;display:flex;flex-direction:column;gap:10px;">
                 <div class="admin-card" style="padding:12px 14px;">
                   <div class="admin-header">
                     <h2><i class="fa-solid fa-circle-info"></i> 상세</h2>
                     <span class="badge" id="dblSelBadge">미선택</span>
                   </div>
                   <div id="dblDetail" style="margin-top:10px;color:#111827;">
                     <div style="color:#6b7280;font-size:13px;">좌측 목록에서 로그를 선택하세요.</div>
                   </div>
                 </div>
               </div>
             </div>
           </div>
         `;
       },

       bindOnce() {
         const bodyEl = document.getElementById("adminBody");
         if (!bodyEl) return;
         if (bodyEl.dataset.dblBound === "1") return;
         bodyEl.dataset.dblBound = "1";

         bodyEl.addEventListener("click", (e) => {
           const btn = e.target.closest("button");
           const row = e.target.closest("tr[data-id]");

           if (row) {
             this.state.selectedId = row.dataset.id;
             this.persistUI();
             this.renderList();
             this.renderDetail();
             return;
           }
           if (!btn) return;

           if (btn.id === "dblBack") {
             if (W.admin && typeof W.admin.show === "function") W.admin.show("logAudit");
             return;
           }
           if (btn.id === "dblPrev") {
             this.state.page = Math.max(1, (this.state.page || 1) - 1);
             this.persistUI();
             this.renderList();
             this.renderDetail();
             return;
           }
           if (btn.id === "dblNext") {
             this.state.page = (this.state.page || 1) + 1;
             this.persistUI();
             this.renderList();
             this.renderDetail();
             return;
           }
           if (btn.id === "dblExport") {
             this.exportFiltered();
             return;
           }
           if (btn.id === "dblAdd") {
             this.addSampleNow();
             return;
           }
         });

         bodyEl.addEventListener("change", (e) => {
           const t = e.target;
           if (!t) return;

           if (t.id === "dblFrom") this.state.filters.from = t.value || daysAgo(7);
           if (t.id === "dblTo")   this.state.filters.to   = t.value || todayLocal();
           if (t.id === "dblEnv")  this.state.filters.env  = t.value;
           if (t.id === "dblEvent") this.state.filters.event = t.value;
           if (t.id === "dblDb")    this.state.filters.db    = t.value;
           if (t.id === "dblAcctType") this.state.filters.accountType = t.value;
           if (t.id === "dblResult") this.state.filters.result = t.value;
           if (t.id === "dblSev")    this.state.filters.severity = t.value;

           this.state.page = 1;
           this.persistUI();
           this.renderAll();
         });

         bodyEl.addEventListener("input", (e) => {
           const t = e.target;
           if (!t) return;

           if (t.id === "dblUser") this.state.filters.user = t.value || "";
           if (t.id === "dblQ")    this.state.filters.q    = t.value || "";

           this.state.page = 1;
           this.persistUI();
           this.renderList();
           this.renderDetail();
         });
       },

       persistUI() {
         saveJSON(UI_KEY, {
           filters: this.state.filters,
           page: this.state.page,
           selectedId: this.state.selectedId,
         });
       },

       // ----- data -----
       getAll() { return ensureStore(); },
       saveAll(arr) { saveJSON(STORE_KEY, arr); },
       findById(id) { return this.getAll().find((x) => x.id === id); },

       uniqueDbs() {
         const set = new Set(this.getAll().map((x) => x.db).filter(Boolean));
         return Array.from(set).sort();
       },

       filtered() {
         const f = this.state.filters;
         const kwUser = (f.user || "").trim().toLowerCase();
         const kw = (f.q || "").trim().toLowerCase();

         const fromD = f.from ? new Date(f.from + "T00:00:00").getTime() : 0;
         const toD   = f.to ? new Date(f.to + "T23:59:59").getTime() : Date.now();

         return this.getAll()
           .filter((r) => {
             if (r.ts < fromD || r.ts > toD) return false;
             if (f.env !== "ALL" && r.env !== f.env) return false;
             if (f.event !== "ALL" && r.event !== f.event) return false;
             if (f.db !== "ALL" && r.db !== f.db) return false;
             if (f.accountType !== "ALL" && r.accountType !== f.accountType) return false;
             if (f.result !== "ALL" && r.result !== f.result) return false;
             if (f.severity !== "ALL" && r.severity !== f.severity) return false;

             if (kwUser && !String(r.user || "").toLowerCase().includes(kwUser)) return false;

             if (kw) {
               const blob = [
                 r.db, r.user, r.accountId, r.accountType,
                 r.event, r.action, r.sqlHash, r.clientIp,
                 r.download?.fileName, r.download?.format
               ].join(" ").toLowerCase();
               if (!blob.includes(kw)) return false;
             }
             return true;
           })
           .sort((a, b) => b.ts - a.ts);
       },

       // ----- render -----
       renderAll() {
         const f = this.state.filters;

         const setVal = (id, v) => {
           const el = document.getElementById(id);
           if (el) el.value = v ?? "";
         };

         setVal("dblFrom", f.from);
         setVal("dblTo", f.to);
         setVal("dblEnv", f.env);
         setVal("dblEvent", f.event);
         setVal("dblAcctType", f.accountType);
         setVal("dblResult", f.result);
         setVal("dblSev", f.severity);
         setVal("dblUser", f.user);
         setVal("dblQ", f.q);

         // DB 옵션 렌더
         const dbSel = document.getElementById("dblDb");
         if (dbSel) {
           const curr = f.db || "ALL";
           const dbs = this.uniqueDbs();
           dbSel.innerHTML = [
             `<option value="ALL">DB(전체)</option>`,
             ...dbs.map((d) => `<option value="${esc(d)}">${esc(d)}</option>`)
           ].join("");
           dbSel.value = dbs.includes(curr) ? curr : "ALL";
         }

         this.renderList();
         this.renderDetail();
       },

       renderList() {
         const tbody = document.getElementById("dblTbody");
         const countEl = document.getElementById("dblCount");
         const pageInfo = document.getElementById("dblPageInfo");
         if (!tbody || !countEl) return;

         const list = this.filtered();
         countEl.textContent = `${list.length}건`;

         const ps = Number(this.state.pageSize || 20);
         const page = Math.max(1, Number(this.state.page || 1));
         const totalPages = Math.max(1, Math.ceil(list.length / ps));
         const safePage = Math.min(page, totalPages);
         if (safePage !== page) this.state.page = safePage;

         const startIdx = (safePage - 1) * ps;
         const pageList = list.slice(startIdx, startIdx + ps);

         const selId = this.state.selectedId;

         tbody.innerHTML = pageList.map((r) => {
           const isSel = selId && selId === r.id;
           const trBg = isSel ? "background:#eef2ff;" : "";

           const who = `${esc(r.user || "")}<div style="color:#9ca3af;font-size:12px;">${esc(r.accountType || "")} · ${esc(r.accountId || "")}</div>`;
           const evt = `${evtBadge(r.event)} <span style="color:#6b7280;font-size:12px;font-weight:700;">${esc(r.action || "")}</span>
                        <div style="color:#9ca3af;font-size:12px;">${r.sqlHash ? `SQL:${esc(r.sqlHash)}` : (r.download?.fileName ? `FILE:${esc(r.download.fileName)}` : `IP:${esc(r.clientIp || "")}`)}</div>`;

           const rows = r.rows ? `${esc(r.rows)}<div style="color:#9ca3af;font-size:12px;">${esc(r.durationMs)}ms</div>` : `<span style="color:#9ca3af;">-</span><div style="color:#9ca3af;font-size:12px;">${esc(r.durationMs)}ms</div>`;

           return `
             <tr data-id="${esc(r.id)}" style="border-bottom:1px solid #f3f4f6;cursor:pointer;${trBg}">
               <td style="padding:10px;font-weight:800;">${esc(fmtLocal(r.ts))}</td>
               <td style="padding:10px;">${esc(r.env || "")}</td>
               <td style="padding:10px;">${who}</td>
               <td style="padding:10px;">${esc(r.db || "")}</td>
               <td style="padding:10px;">${evt}</td>
               <td style="padding:10px;">${rows}</td>
               <td style="padding:10px;">${resBadge(r.result || "")}</td>
               <td style="padding:10px;">${sevBadge(r.severity || "")}</td>
             </tr>
           `;
         }).join("");

         if (pageInfo) {
           pageInfo.textContent = `Page ${safePage} / ${totalPages} · 표시 ${startIdx + 1}-${Math.min(
             startIdx + ps,
             list.length
           )} / ${list.length}`;
         }

         if (selId && !list.some((x) => x.id === selId)) {
           this.state.selectedId = null;
           this.persistUI();
           const badge = document.getElementById("dblSelBadge");
           if (badge) badge.textContent = "미선택";
         }
       },

       renderDetail() {
         const badge = document.getElementById("dblSelBadge");
         const box = document.getElementById("dblDetail");
         if (!box) return;

         const id = this.state.selectedId;
         if (!id) {
           if (badge) badge.textContent = "미선택";
           box.innerHTML = `<div style="color:#6b7280;font-size:13px;">좌측 목록에서 로그를 선택하세요.</div>`;
           return;
         }

         const r = this.findById(id);
         if (!r) {
           this.state.selectedId = null;
           this.persistUI();
           if (badge) badge.textContent = "미선택";
           box.innerHTML = `<div style="color:#6b7280;font-size:13px;">선택된 로그를 찾을 수 없습니다.</div>`;
           return;
         }

         if (badge) badge.textContent = r.id;

         const rows = [
           ["ID", esc(r.id)],
           ["시간", esc(fmtLocal(r.ts))],
           ["환경", esc(r.env)],
           ["사용자", esc(r.user)],
           ["계정유형", esc(r.accountType)],
           ["계정ID", esc(r.accountId)],
           ["DB", esc(r.db)],
           ["이벤트", evtBadge(r.event)],
           ["액션", esc(r.action)],
           ["결과", resBadge(r.result)],
           ["심각도", sevBadge(r.severity)],
           ["Rows", r.rows ? esc(r.rows) : "-"],
           ["Duration", `${esc(r.durationMs)}ms`],
           ["Client IP", esc(r.clientIp || "-")],
           ["App", esc(r.app || "-")],
           ["SQL Hash", r.sqlHash ? `<b>${esc(r.sqlHash)}</b>` : "-"],
           ["티켓", esc(r.ticket || "-")],
           ["사유참조", esc(r.reasonRef || "-")],
           ["응급참조", esc(r.emergencyRef || "-")],
         ];

         const sqlHtml = r.sql
           ? `<pre style="margin:0;white-space:pre-wrap;background:#0b1020;color:#e5e7eb;border-radius:10px;padding:10px;font-size:12px;">${esc(r.sql)}</pre>`
           : `<div style="color:#6b7280;font-size:13px;">(SQL 없음)</div>`;

         const dl = r.download
           ? `<div style="display:grid;grid-template-columns:110px 1fr;gap:6px 10px;font-size:13px;">
                <div style="color:#6b7280;">Format</div><div>${esc(r.download.format || "")}</div>
                <div style="color:#6b7280;">File</div><div>${esc(r.download.fileName || "")}</div>
                <div style="color:#6b7280;">Size</div><div>${esc(r.download.sizeKB ?? "")} KB</div>
                <div style="color:#6b7280;">Reason</div><div>${esc(r.download.reason || "")}</div>
              </div>`
           : `<div style="color:#6b7280;font-size:13px;">(다운로드 정보 없음)</div>`;

         box.innerHTML = `
           <div style="border:1px solid var(--line);border-radius:12px;padding:10px;">
             <div style="display:grid;grid-template-columns:110px 1fr;gap:6px 10px;font-size:13px;">
               ${rows.map(([k, v]) => `
                 <div style="color:#6b7280;">${k}</div>
                 <div>${v}</div>
               `).join("")}
             </div>

             <div style="margin-top:10px;">
               <div style="color:#6b7280;font-size:12px;margin-bottom:6px;">SQL</div>
               ${sqlHtml}
             </div>

             <div style="margin-top:10px;">
               <div style="color:#6b7280;font-size:12px;margin-bottom:6px;">다운로드</div>
               ${dl}
             </div>

             <div style="margin-top:10px;">
               <div style="color:#6b7280;font-size:12px;margin-bottom:6px;">원본(JSON)</div>
               <pre style="margin:0;white-space:pre-wrap;background:#0b1020;color:#e5e7eb;border-radius:10px;padding:10px;font-size:12px;">${esc(JSON.stringify(r, null, 2))}</pre>
             </div>
           </div>
         `;
       },

       // ----- actions -----
       addSampleNow() {
         const all = this.getAll().slice();
         const now = Date.now();
         const id = nextId(now);

         const sampleSql = "SELECT ORDER_ID, AMOUNT, CREATED_AT FROM TB_ORDER WHERE CREATED_AT >= SYSDATE-1 AND ROWNUM <= 200";
         const sample = {
           id,
           ts: now,
           env: "DEV",
           user: "김개발",
           accountType: "INDIVIDUAL",
           accountId: "u-dev-001",
           db: "CRM-DEV",
           event: "SQL",
           action: "EXECUTE",
           result: "SUCCESS",
           severity: "INFO",
           rows: 200,
           durationMs: 420,
           clientIp: "192.168.0.24",
           app: "SQLRunner",
           sql: sampleSql,
           sqlHash: hash32(sampleSql),
           download: null,
           ticket: "",
           reasonRef: "",
           emergencyRef: "",
           note: "샘플 추가",
         };

         all.unshift(sample);
         this.saveAll(all);

         this.state.selectedId = id;
         this.state.page = 1;
         this.persistUI();
         this.renderAll();
       },

       exportFiltered() {
         const list = this.filtered();
         const payload = {
           exportedAt: fmtLocal(Date.now()),
           filters: { ...this.state.filters },
           count: list.length,
           logs: list,
         };
         downloadText(`db_access_log_export_${Date.now()}.json`, JSON.stringify(payload, null, 2));
       },

       // ----- card binding (logAudit 섹션에서만) -----
       attachDbAccessLogCardHandler() {
         const bodyEl = document.getElementById("adminBody");
         if (!bodyEl) return;

         const cards = bodyEl.querySelectorAll(".admin-card");
         let target = null;

         cards.forEach((card) => {
           const t = (card.querySelector("h4, h3, h2")?.textContent || "").trim();
           if (t.includes("DB 접속·SQL 실행·다운로드 로그") || (t.includes("DB 접속") && t.includes("SQL"))) {
             target = card;
           }
         });

         if (!target) return;
         if (target.dataset.dbAccessLogBound === "1") return;
         target.dataset.dbAccessLogBound = "1";

         target.classList.add("admin-card-clickable");
         target.addEventListener("click", (e) => {
           e.preventDefault();
           e.stopPropagation();
           this.open();
         });

         const footer = target.querySelector(".admin-footer, .card-footer");
         if (footer) footer.textContent = "클릭하여 DB 접속/SQL/다운로드 로그 조회 화면을 엽니다.";
       },
     };

     W.dbAccessLogAdmin = dbAccessLogAdmin;

     // 라우터 패치가 남아있는 경우에도 이 아이템은 열리도록 핸들러만 등록(새 라우터 생성 X)
     try {
       if (W.admin && typeof W.admin.registerItemHandler === "function") {
         W.admin.registerItemHandler("dbAccessLog", () => dbAccessLogAdmin.open());
       }
     } catch (e) {}

     // 이미 logAudit 화면이 열려있는 상태에서 추가한 경우 즉시 바인딩
     try {
       const active = document.querySelector(".admin-nav button.active");
       const sid = active?.dataset?.section || active?.getAttribute("data-section");
       if (sid === "logAudit") dbAccessLogAdmin.attachDbAccessLogCardHandler();
     } catch (e) {}
   })();
   
    /* ---------------- Admin: 정책 변경 이력 (로그 조회·감사 뷰 > 정책 변경 이력) start ---------------- */
    (() => {
      const W = window;

      const policyChangeLogAdmin = {
        _storeKey: "dbam_policyChangeLog_v1",
        state: {
          selectedId: null,
          filters: {
            from: "",
            to: "",
            env: "ALL",
            domain: "ALL",
            result: "ALL",
            actor: "",
            q: "",
          },
        },

        // ---------- utils ----------
        _pad(n) { return String(n).padStart(2, "0"); },
        _nowLocal() {
          const d = new Date();
          const yyyy = d.getFullYear();
          const mm = this._pad(d.getMonth() + 1);
          const dd = this._pad(d.getDate());
          const hh = this._pad(d.getHours());
          const mi = this._pad(d.getMinutes());
          const ss = this._pad(d.getSeconds());
          return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
        },
        _todayYmd() {
          const d = new Date();
          return `${d.getFullYear()}-${this._pad(d.getMonth()+1)}-${this._pad(d.getDate())}`;
        },
        _esc(s) {
          const v = (s === null || s === undefined) ? "" : String(s);
          return v
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        },
        _uuid(prefix) {
          const d = new Date();
          const y = d.getFullYear();
          const m = this._pad(d.getMonth() + 1);
          const day = this._pad(d.getDate());
          const raw = `${prefix || "PCL"}-${y}${m}${day}-` + Math.random().toString(16).slice(2, 8).toUpperCase();
          return raw;
        },
        _copy(text) {
          const t = String(text ?? "");
          if (navigator.clipboard && navigator.clipboard.writeText) {
            return navigator.clipboard.writeText(t).then(() => true).catch(() => false);
          }
          try {
            const ta = document.createElement("textarea");
            ta.value = t;
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
            return Promise.resolve(true);
          } catch (e) {
            return Promise.resolve(false);
          }
        },
        _badge(text, bg, fg) {
          return `<span style="display:inline-block;padding:3px 8px;border-radius:999px;background:${bg};color:${fg};font-size:12px;font-weight:800;">${this._esc(text)}</span>`;
        },
        _resultBadge(st) {
          const map = {
            APPLIED:   { bg:"#ecfdf5", fg:"#047857", label:"적용" },
            FAILED:    { bg:"#fef2f2", fg:"#b91c1c", label:"실패" },
            PENDING:   { bg:"#eff6ff", fg:"#1d4ed8", label:"대기" },
            ROLLBACK:  { bg:"#fff7ed", fg:"#9a3412", label:"롤백" },
          };
          const c = map[st] || { bg:"#f3f4f6", fg:"#374151", label: st || "-" };
          return this._badge(c.label, c.bg, c.fg);
        },
        _typeBadge(tp) {
          const map = {
            CREATE: { bg:"#f0f9ff", fg:"#0369a1", label:"생성" },
            UPDATE: { bg:"#eff6ff", fg:"#1d4ed8", label:"변경" },
            DELETE: { bg:"#fef2f2", fg:"#b91c1c", label:"삭제" },
            APPLY:  { bg:"#ecfdf5", fg:"#047857", label:"적용" },
            ROLLBACK:{ bg:"#fff7ed", fg:"#9a3412", label:"롤백" },
          };
          const c = map[tp] || { bg:"#f3f4f6", fg:"#374151", label: tp || "-" };
          return this._badge(c.label, c.bg, c.fg);
        },
        _jsonPretty(obj) {
          try { return JSON.stringify(obj ?? {}, null, 2); } catch (e) { return String(obj ?? ""); }
        },
        _shaLike(s) {
          // 실제 해시가 아닌 UI용 짧은 식별자
          const str = String(s ?? "");
          let h = 0;
          for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) >>> 0;
          return ("00000000" + h.toString(16)).slice(-8).toUpperCase();
        },

        // ---------- modal ----------
        _ensureModal() {
          let bd = document.getElementById("pclModalBackdrop");
          if (bd) return bd;

          bd = document.createElement("div");
          bd.id = "pclModalBackdrop";
          bd.className = "export-modal-backdrop";
          bd.innerHTML = `
            <div class="export-modal" style="max-width:980px;width:calc(100vw - 40px);">
              <div class="export-modal-header">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                  <h3 id="pclModalTitle" style="margin:0;font-size:14px;"></h3>
                  <button class="btn" id="pclModalCloseBtn"><i class="fa-solid fa-xmark"></i></button>
                </div>
              </div>
              <div id="pclModalBody" style="margin-top:10px;"></div>
              <div id="pclModalFooter" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;"></div>
            </div>
          `;
          document.body.appendChild(bd);

          bd.addEventListener("click", (e) => { if (e.target === bd) bd.classList.remove("show"); });
          bd.querySelector("#pclModalCloseBtn").addEventListener("click", () => bd.classList.remove("show"));
          return bd;
        },
        _openModal(titleHtml, bodyHtml, footerButtons) {
          const bd = this._ensureModal();
          bd.querySelector("#pclModalTitle").innerHTML = titleHtml;
          bd.querySelector("#pclModalBody").innerHTML = bodyHtml;

          const ft = bd.querySelector("#pclModalFooter");
          ft.innerHTML = "";
          (footerButtons || []).forEach((btn) => {
            const b = document.createElement("button");
            b.className = btn.className || "btn";
            b.innerHTML = btn.label;
            b.addEventListener("click", () => btn.onClick && btn.onClick());
            ft.appendChild(b);
          });

          bd.classList.add("show");
        },
        _closeModal() {
          document.getElementById("pclModalBackdrop")?.classList.remove("show");
        },

        // ---------- store ----------
        _seed() {
          const base = [
            {
              at: "2025-12-16 09:12:03",
              env: "PRD",
              domain: "계정·비밀번호·MFA 정책",
              policyKey: "passwordPolicy",
              policyName: "비밀번호 정책 관리",
              changeType: "UPDATE",
              result: "APPLIED",
              actor: { id: "sec01", name: "김보안", dept: "보안운영팀" },
              approver: { id: "mgr01", name: "박팀장", dept: "보안운영팀" },
              ticket: "CHG-20251216-0007",
              ip: "10.10.12.34",
              reason: "최소 길이/복잡도 강화",
              before: { minLen: 10, requireUpper: true, requireLower: true, requireDigit: true, requireSpecial: true, history: 6, maxAgeDays: 90 },
              after:  { minLen: 12, requireUpper: true, requireLower: true, requireDigit: true, requireSpecial: true, history: 8, maxAgeDays: 60 },
            },
            {
              at: "2025-12-15 21:40:11",
              env: "PRD",
              domain: "접근 통제 정책",
              policyKey: "sqlPreblock",
              policyName: "허용 범위 밖 SQL 사전 차단",
              changeType: "UPDATE",
              result: "APPLIED",
              actor: { id: "ops02", name: "이운영", dept: "DBA팀" },
              approver: { id: "sec02", name: "정보안", dept: "보안운영팀" },
              ticket: "CHG-20251215-0049",
              ip: "10.20.0.18",
              reason: "위험 DDL/무조건 UPDATE 차단 룰 보강",
              before: { denyPatterns: ["DROP TABLE", "TRUNCATE", "DELETE(?!.*WHERE)"], allowOverride: false },
              after:  { denyPatterns: ["DROP TABLE", "TRUNCATE", "DELETE(?!.*WHERE)", "UPDATE(?!.*WHERE)"], allowOverride: true, overrideRequireApproval: true },
            },
            {
              at: "2025-12-14 14:03:55",
              env: "STG",
              domain: "계정·비밀번호·MFA 정책",
              policyKey: "mfaPolicy",
              policyName: "MFA 적용 정책",
              changeType: "UPDATE",
              result: "FAILED",
              actor: { id: "sec03", name: "최보안", dept: "보안운영팀" },
              approver: { id: "mgr02", name: "한팀장", dept: "보안운영팀" },
              ticket: "CHG-20251214-0011",
              ip: "10.10.9.77",
              reason: "관리자/특수권한 계정 MFA 강제 적용",
              before: { adminRequired: true, privilegedRequired: false, graceDays: 7 },
              after:  { adminRequired: true, privilegedRequired: true, graceDays: 3 },
              error: "정책 저장 중 검증 실패(예: graceDays 최소값 미만)",
            },
          ];

          return base.map((x, idx) => {
            const id = `PCL-202512${this._pad(16 - idx)}-${this._pad(idx + 1)}`;
            const hash = this._shaLike(x.domain + "|" + x.policyKey + "|" + x.at);
            return { id, hash, ...x };
          });
        },
        _loadStore() {
          try {
            const raw = localStorage.getItem(this._storeKey);
            if (raw) return JSON.parse(raw);
          } catch (e) {}
          return null;
        },
        _saveStore(st) {
          try { localStorage.setItem(this._storeKey, JSON.stringify(st)); } catch (e) {}
        },
        _ensureStore() {
          let st = this._loadStore();
          if (!st || !Array.isArray(st.items)) {
            st = { items: this._seed() };
            this._saveStore(st);
          }
          return st;
        },
        _all() {
          return (this._ensureStore().items || []);
        },
        _find(id) {
          return this._all().find((x) => x.id === id);
        },
        _persist(all) {
          const st = this._ensureStore();
          st.items = all;
          this._saveStore(st);
        },

        // ---------- entry ----------
        open() {
          const ov = document.getElementById("adminOverlay");
          if (ov) { ov.classList.add("show"); ov.setAttribute("aria-hidden", "false"); }

          document.querySelectorAll(".admin-nav button").forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.section === "logAudit");
          });

          const titleEl = document.getElementById("adminTitle");
          const descEl = document.getElementById("adminDesc");
          const bodyEl = document.getElementById("adminBody");
          if (!titleEl || !descEl || !bodyEl) return;

          titleEl.innerHTML = `<i class="fa-solid fa-sliders"></i> 정책 변경 이력`;
          descEl.textContent = "보안/접근/권한/마스킹 등 정책 변경의 전·후 스냅샷과 변경자/승인자/티켓 정보를 조회합니다.";

          bodyEl.innerHTML = this.getTemplateHtml();
          this._initDefaultFilter();
          this.bindOnce();
          this.renderAll();
        },

        _initDefaultFilter() {
          // 최초 진입 시만 기본 기간 세팅(오늘)
          if (!this.state.filters.from && !this.state.filters.to) {
            const ymd = this._todayYmd();
            this.state.filters.from = ymd;
            this.state.filters.to = ymd;
          }
        },

        getTemplateHtml() {
          return `
            <div id="pclPage" class="emg-page" style="display:flex;flex-direction:column;gap:10px;">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
                <div style="display:flex;gap:8px;align-items:center;">
                  <button id="pclBack" class="btn" type="button"><i class="fa-solid fa-arrow-left"></i></button>
                  <div style="font-weight:900;">정책 변경 이력 조회</div>
                </div>
                <div style="font-size:12px;color:var(--muted);">
                  변경 전/후 스냅샷 · 변경자/승인자 · 티켓 · 결과
                </div>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <div style="flex:1.25; min-width:520px; display:flex; flex-direction:column; gap:10px;">
                  <div class="admin-card" style="padding:12px 14px;">
                    <div class="admin-header">
                      <h2><i class="fa-solid fa-list"></i> 변경 내역</h2>
                      <span class="badge" id="pclCount">0건</span>
                    </div>

                    <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:10px;">
                      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                        <div style="display:flex;gap:6px;align-items:center;">
                          <span style="font-size:12px;color:#6b7280;">기간</span>
                          <input id="pclFrom" class="input" type="date" style="min-width:140px;" />
                          <span style="color:#9ca3af;">~</span>
                          <input id="pclTo" class="input" type="date" style="min-width:140px;" />
                        </div>

                        <select id="pclEnv" class="input" style="min-width:110px;">
                          <option value="ALL">환경(전체)</option>
                          <option value="PRD">PRD</option>
                          <option value="STG">STG</option>
                          <option value="DEV">DEV</option>
                        </select>

                        <select id="pclDomain" class="input" style="min-width:220px;">
                          <option value="ALL">구분(전체)</option>
                          <option value="계정·비밀번호·MFA 정책">계정·비밀번호·MFA 정책</option>
                          <option value="접근 통제 정책">접근 통제 정책</option>
                          <option value="DB/민감정보 관리">DB/민감정보 관리</option>
                          <option value="공용·응급 계정 관리">공용·응급 계정 관리</option>
                          <option value="기타">기타</option>
                        </select>

                        <select id="pclResult" class="input" style="min-width:120px;">
                          <option value="ALL">결과(전체)</option>
                          <option value="APPLIED">적용</option>
                          <option value="FAILED">실패</option>
                          <option value="PENDING">대기</option>
                          <option value="ROLLBACK">롤백</option>
                        </select>
                      </div>

                      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                        <input id="pclActor" class="input" style="min-width:160px;" placeholder="변경자(이름/ID)" />
                        <input id="pclQ" class="input" style="min-width:240px;" placeholder="검색(정책명/키/티켓/사유/해시)" />
                        <button id="pclBtnSeed" class="btn" type="button"><i class="fa-solid fa-wand-magic-sparkles"></i> 샘플 추가</button>
                        <button id="pclBtnExport" class="btn" type="button"><i class="fa-solid fa-file-export"></i> 내보내기</button>
                      </div>
                    </div>

                    <div class="table-scroll-x scope-items-wrap" style="margin-top:10px; border:1px solid var(--line); border-radius:10px; overflow:auto; padding-bottom:6px; max-height:560px;">
                      <table class="scope-items-table" style="width:100%; min-width:980px; border-collapse:collapse; table-layout:fixed;">
                        <colgroup>
                          <col style="width:160px;">
                          <col style="width:80px;">
                          <col style="width:180px;">
                          <col style="width:260px;">
                          <col style="width:160px;">
                          <col style="width:140px;">
                        </colgroup>
                        <thead>
                          <tr style="background:#f9fafb;">
                            <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">시각</th>
                            <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">환경</th>
                            <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">구분</th>
                            <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">정책</th>
                            <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">변경자</th>
                            <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">결과</th>
                          </tr>
                        </thead>
                        <tbody id="pclTbody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div style="flex:1; min-width:360px; display:flex; flex-direction:column; gap:10px;">
                  <div class="admin-card" style="padding:12px 14px;">
                    <div class="admin-header">
                      <h2><i class="fa-solid fa-circle-info"></i> 상세</h2>
                      <span class="badge" id="pclSelBadge">미선택</span>
                    </div>
                    <div id="pclDetail" style="margin-top:10px; color:#111827;">
                      <div style="color:#6b7280; font-size:13px;">좌측 목록에서 항목을 선택하세요.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        },

        bindOnce() {
          const bodyEl = document.getElementById("adminBody");
          if (!bodyEl) return;
          if (bodyEl.dataset.pclBound === "1") return;
          bodyEl.dataset.pclBound = "1";

          bodyEl.addEventListener("click", (e) => {
            const row = e.target.closest("tr[data-id]");
            if (row) {
              this.state.selectedId = row.dataset.id;
              this.renderDetail();
              this.renderList();
              return;
            }

            const btn = e.target.closest("button");
            if (!btn) return;

            if (btn.id === "pclBack") {
              if (W.admin && typeof W.admin.show === "function") W.admin.show("logAudit");
              return;
            }
            if (btn.id === "pclBtnExport") {
              this.exportFiltered();
              return;
            }
            if (btn.id === "pclBtnSeed") {
              this.addSample();
              return;
            }

            const act = btn.dataset.action;
            const id = btn.dataset.id;

            if (act === "view") this.openViewModal(id);
            if (act === "rollback") this.rollbackSimulate(id);
            if (act === "copyBefore") this.copySnapshot(id, "before");
            if (act === "copyAfter") this.copySnapshot(id, "after");
          });

          bodyEl.addEventListener("change", (e) => {
            const t = e.target;
            if (!t) return;

            if (t.id === "pclFrom") this.state.filters.from = t.value || "";
            if (t.id === "pclTo") this.state.filters.to = t.value || "";
            if (t.id === "pclEnv") this.state.filters.env = t.value;
            if (t.id === "pclDomain") this.state.filters.domain = t.value;
            if (t.id === "pclResult") this.state.filters.result = t.value;

            this.renderList();
            this.renderDetail();
          });

          bodyEl.addEventListener("input", (e) => {
            const t = e.target;
            if (!t) return;

            if (t.id === "pclActor") {
              this.state.filters.actor = t.value || "";
              this.renderList();
              this.renderDetail();
            }
            if (t.id === "pclQ") {
              this.state.filters.q = t.value || "";
              this.renderList();
            }
          });
        },

        // ---------- filter/query ----------
        _inDateRange(atStr, fromYmd, toYmd) {
          // at: "YYYY-MM-DD HH:mm:ss"  / from,to: "YYYY-MM-DD"
          const d = String(atStr || "").slice(0, 10);
          if (fromYmd && d < fromYmd) return false;
          if (toYmd && d > toYmd) return false;
          return true;
        },
        _filtered() {
          const { from, to, env, domain, result, actor, q } = this.state.filters;
          const kw = (q || "").trim().toLowerCase();
          const ak = (actor || "").trim().toLowerCase();

          return this._all()
            .filter((r) => {
              if (!this._inDateRange(r.at, from, to)) return false;
              if (env !== "ALL" && r.env !== env) return false;
              if (domain !== "ALL" && r.domain !== domain) return false;
              if (result !== "ALL" && r.result !== result) return false;

              if (ak) {
                const a = r.actor || {};
                const blobA = `${a.id || ""} ${a.name || ""} ${a.dept || ""}`.toLowerCase();
                if (!blobA.includes(ak)) return false;
              }

              if (kw) {
                const blob = [
                  r.id, r.hash, r.domain, r.policyKey, r.policyName,
                  r.ticket, r.reason, r.env, r.ip, r.changeType, r.result
                ].join(" ").toLowerCase();
                if (!blob.includes(kw)) return false;
              }
              return true;
            })
            .sort((a, b) => String(b.at || "").localeCompare(String(a.at || "")));
        },

        // ---------- render ----------
        renderAll() {
          // 초기 입력값 동기화
          const fromEl = document.getElementById("pclFrom");
          const toEl = document.getElementById("pclTo");
          const envEl = document.getElementById("pclEnv");
          const domEl = document.getElementById("pclDomain");
          const resEl = document.getElementById("pclResult");
          const actorEl = document.getElementById("pclActor");
          const qEl = document.getElementById("pclQ");

          if (fromEl) fromEl.value = this.state.filters.from || "";
          if (toEl) toEl.value = this.state.filters.to || "";
          if (envEl) envEl.value = this.state.filters.env || "ALL";
          if (domEl) domEl.value = this.state.filters.domain || "ALL";
          if (resEl) resEl.value = this.state.filters.result || "ALL";
          if (actorEl) actorEl.value = this.state.filters.actor || "";
          if (qEl) qEl.value = this.state.filters.q || "";

          this.renderList();
          this.renderDetail();
        },

        renderList() {
          const tbody = document.getElementById("pclTbody");
          const countEl = document.getElementById("pclCount");
          if (!tbody || !countEl) return;

          const list = this._filtered();
          countEl.textContent = `${list.length}건`;

          const selectedId = this.state.selectedId;

          tbody.innerHTML = list.map((r) => {
            const isSel = selectedId && selectedId === r.id;
            const trBg = isSel ? "background:#eef2ff;" : "";
            const pol = `
              <div style="font-weight:900;">${this._esc(r.policyName || "-")}</div>
              <div style="color:#9ca3af;font-size:12px;">${this._esc(r.policyKey || "")} · ${this._esc(r.ticket || "-")} · #${this._esc(r.hash || "")}</div>
            `;
            const who = `
              <div style="font-weight:800;">${this._esc(r.actor?.name || "-")} <span style="color:#9ca3af;font-weight:700;">(${this._esc(r.actor?.id || "")})</span></div>
              <div style="color:#9ca3af;font-size:12px;">${this._esc(r.actor?.dept || "")}</div>
            `;
            return `
              <tr data-id="${this._esc(r.id)}" style="border-bottom:1px solid #f3f4f6; cursor:pointer; ${trBg}">
                <td style="padding:10px; font-weight:800;">${this._esc(r.at || "")}</td>
                <td style="padding:10px;">${this._esc(r.env || "")}</td>
                <td style="padding:10px;">
                  ${this._esc(r.domain || "")}
                  <div style="margin-top:6px;">${this._typeBadge(r.changeType)}</div>
                </td>
                <td style="padding:10px;">${pol}</td>
                <td style="padding:10px;">${who}</td>
                <td style="padding:10px;">${this._resultBadge(r.result)}</td>
              </tr>
            `;
          }).join("");

          if (selectedId && !list.some((x) => x.id === selectedId)) {
            this.state.selectedId = null;
            const badge = document.getElementById("pclSelBadge");
            if (badge) badge.textContent = "미선택";
          }
        },

        renderDetail() {
          const badge = document.getElementById("pclSelBadge");
          const box = document.getElementById("pclDetail");
          if (!box) return;

          const id = this.state.selectedId;
          if (!id) {
            if (badge) badge.textContent = "미선택";
            box.innerHTML = `<div style="color:#6b7280;font-size:13px;">좌측 목록에서 항목을 선택하세요.</div>`;
            return;
          }

          const r = this._find(id);
          if (!r) {
            this.state.selectedId = null;
            if (badge) badge.textContent = "미선택";
            box.innerHTML = `<div style="color:#6b7280;font-size:13px;">선택된 항목을 찾을 수 없습니다.</div>`;
            return;
          }

          if (badge) badge.textContent = r.id;

          const beforeJson = this._jsonPretty(r.before);
          const afterJson = this._jsonPretty(r.after);

          const infoRows = [
            ["시각", this._esc(r.at || "")],
            ["환경", this._esc(r.env || "")],
            ["구분", this._esc(r.domain || "")],
            ["정책", `<b>${this._esc(r.policyName || "")}</b> <span style="color:#9ca3af;">(${this._esc(r.policyKey || "")})</span>`],
            ["유형", this._typeBadge(r.changeType)],
            ["결과", this._resultBadge(r.result)],
            ["변경자", `${this._esc(r.actor?.name || "")} <span style="color:#9ca3af;">(${this._esc(r.actor?.id || "")})</span><div style="color:#9ca3af;font-size:12px;">${this._esc(r.actor?.dept || "")}</div>`],
            ["승인자", (r.approver?.name ? `${this._esc(r.approver.name)} <span style="color:#9ca3af;">(${this._esc(r.approver.id || "")})</span><div style="color:#9ca3af;font-size:12px;">${this._esc(r.approver.dept || "")}</div>` : "-")],
            ["티켓", this._esc(r.ticket || "-")],
            ["IP", this._esc(r.ip || "-")],
            ["해시", `<code style="background:#f3f4f6;padding:2px 6px;border-radius:6px;">${this._esc(r.hash || "")}</code>`],
          ];

          const actions = `
            <button class="btn" data-action="view" data-id="${this._esc(r.id)}" type="button">
              <i class="fa-solid fa-up-right-from-square"></i> 크게 보기
            </button>
            <button class="btn" data-action="rollback" data-id="${this._esc(r.id)}" type="button">
              <i class="fa-solid fa-rotate-left"></i> 롤백(시뮬)
            </button>
          `;

          box.innerHTML = `
            <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
              <div style="font-weight:900;font-size:14px;">상세 정보</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">${actions}</div>
            </div>

            <div style="margin-top:10px; border:1px solid var(--line); border-radius:12px; padding:10px;">
              <div style="display:grid; grid-template-columns:110px 1fr; gap:6px 10px; font-size:13px;">
                ${infoRows.map(([k,v]) => `
                  <div style="color:#6b7280;">${k}</div>
                  <div>${v}</div>
                `).join("")}
              </div>

              <div style="margin-top:10px;">
                <div style="color:#6b7280;font-size:12px;margin-bottom:6px;">변경 사유</div>
                <div style="white-space:pre-wrap; background:#f9fafb; border:1px solid #eef2f7; border-radius:10px; padding:10px; font-size:13px;">
                  ${this._esc(r.reason || "-")}
                </div>
                ${r.error ? `<div style="margin-top:8px;color:#b91c1c;font-size:12px;">오류: ${this._esc(r.error)}</div>` : ""}
              </div>
            </div>

            <div style="margin-top:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                <div style="font-weight:900;font-size:14px;">스냅샷</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button class="btn" data-action="copyBefore" data-id="${this._esc(r.id)}" type="button"><i class="fa-solid fa-copy"></i> Before 복사</button>
                  <button class="btn" data-action="copyAfter" data-id="${this._esc(r.id)}" type="button"><i class="fa-solid fa-copy"></i> After 복사</button>
                </div>
              </div>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                <div style="border:1px solid #eef2f7;border-radius:12px;padding:10px;">
                  <div style="font-weight:900;font-size:13px;margin-bottom:6px;color:#475569;">Before</div>
                  <pre style="margin:0;white-space:pre-wrap;word-break:break-word;background:#0b1020;color:#e5e7eb;border-radius:10px;padding:10px;font-size:12px;max-height:240px;overflow:auto;">${this._esc(beforeJson)}</pre>
                </div>
                <div style="border:1px solid #eef2f7;border-radius:12px;padding:10px;">
                  <div style="font-weight:900;font-size:13px;margin-bottom:6px;color:#475569;">After</div>
                  <pre style="margin:0;white-space:pre-wrap;word-break:break-word;background:#0b1020;color:#e5e7eb;border-radius:10px;padding:10px;font-size:12px;max-height:240px;overflow:auto;">${this._esc(afterJson)}</pre>
                </div>
              </div>
            </div>
          `;
        },

        // ---------- actions ----------
        addSample() {
          const all = this._all();
          const now = this._nowLocal();

          const sample = {
            id: this._uuid("PCL"),
            at: now,
            env: "PRD",
            domain: "공용·응급 계정 관리",
            policyKey: "sharedAccountReason",
            policyName: "공용계정 사용 사유·승인",
            changeType: "UPDATE",
            result: "APPLIED",
            actor: { id: "ops10", name: "김운영", dept: "운영팀" },
            approver: { id: "sec10", name: "이보안", dept: "보안운영팀" },
            ticket: `CHG-${now.slice(0,10).replaceAll("-","")}-00${Math.floor(Math.random()*9)+1}`,
            ip: "10.30.1.22",
            reason: "결재/로그 필드 보강",
            before: { requireItsm: false, requireApprover2: true, logRetentionDays: 90 },
            after:  { requireItsm: true,  requireApprover2: true, logRetentionDays: 180 },
          };
          sample.hash = this._shaLike(sample.domain + "|" + sample.policyKey + "|" + sample.at);

          all.unshift(sample);
          this._persist(all);
          this.state.selectedId = sample.id;
          this.renderList();
          this.renderDetail();
        },

        rollbackSimulate(id) {
          const all = this._all();
          const r = all.find((x) => x.id === id);
          if (!r) return;

          // 이미 롤백 로그면 중복 방지
          if (r.changeType === "ROLLBACK" || r.result === "ROLLBACK") {
            alert("이미 롤백 기록으로 보입니다.");
            return;
          }

          const now = this._nowLocal();
          const rb = {
            id: this._uuid("PCL"),
            at: now,
            env: r.env,
            domain: r.domain,
            policyKey: r.policyKey,
            policyName: r.policyName,
            changeType: "ROLLBACK",
            result: "ROLLBACK",
            actor: { id: "admin", name: "관리자", dept: "보안운영팀" },
            approver: r.approver || null,
            ticket: r.ticket ? `${r.ticket}-RB` : `RB-${now.slice(0,10).replaceAll("-","")}`,
            ip: "127.0.0.1",
            reason: `롤백(시뮬) - 원본:${r.id}`,
            before: r.after ?? {},
            after: r.before ?? {},
          };
          rb.hash = this._shaLike(rb.domain + "|" + rb.policyKey + "|" + rb.at);

          all.unshift(rb);
          this._persist(all);

          this.state.selectedId = rb.id;
          this.renderList();
          this.renderDetail();
        },

        copySnapshot(id, which) {
          const r = this._find(id);
          if (!r) return;
          const txt = this._jsonPretty(which === "before" ? r.before : r.after);
          this._copy(txt).then((ok) => { if (!ok) alert("복사에 실패했습니다."); });
        },

        openViewModal(id) {
          const r = this._find(id);
          if (!r) return;

          const beforeJson = this._jsonPretty(r.before);
          const afterJson = this._jsonPretty(r.after);

          this._openModal(
            `<i class="fa-solid fa-sliders"></i> 정책 변경 상세 (${this._esc(r.id)})`,
            `
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div style="border:1px solid #eef2f7;border-radius:12px;padding:10px;">
                  <div style="font-weight:900;font-size:13px;margin-bottom:6px;color:#475569;">Before</div>
                  <pre style="margin:0;white-space:pre-wrap;word-break:break-word;background:#0b1020;color:#e5e7eb;border-radius:10px;padding:10px;font-size:12px;max-height:420px;overflow:auto;">${this._esc(beforeJson)}</pre>
                </div>
                <div style="border:1px solid #eef2f7;border-radius:12px;padding:10px;">
                  <div style="font-weight:900;font-size:13px;margin-bottom:6px;color:#475569;">After</div>
                  <pre style="margin:0;white-space:pre-wrap;word-break:break-word;background:#0b1020;color:#e5e7eb;border-radius:10px;padding:10px;font-size:12px;max-height:420px;overflow:auto;">${this._esc(afterJson)}</pre>
                </div>
              </div>
              <div style="margin-top:10px;color:#6b7280;font-size:12px;">
                ${this._esc(r.domain || "")} · ${this._esc(r.policyName || "")} · ${this._esc(r.ticket || "-")} · #${this._esc(r.hash || "")}
              </div>
            `,
            [
              { label:'<i class="fa-solid fa-copy"></i> Before 복사', className:"btn", onClick: () => this._copy(beforeJson) },
              { label:'<i class="fa-solid fa-copy"></i> After 복사', className:"btn", onClick: () => this._copy(afterJson) },
              { label:'<i class="fa-solid fa-xmark"></i> 닫기', className:"btn primary", onClick: () => this._closeModal() },
            ]
          );
        },

        exportFiltered() {
          const list = this._filtered();
          const payload = {
            exportedAt: this._nowLocal(),
            filters: { ...this.state.filters },
            count: list.length,
            items: list,
          };
          const json = JSON.stringify(payload, null, 2);
          const blob = new Blob([json], { type: "application/json;charset=utf-8" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = `policy_change_log_${Date.now()}.json`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
        },
      };

      // expose
      W.policyChangeLogAdmin = policyChangeLogAdmin;

      // (선택) 외부에서 정책변경 로그 적재 API
      W.dbamAudit = W.dbamAudit || {};
      W.dbamAudit.recordPolicyChange = function (entry) {
        try {
          const e = entry || {};
          const all = W.policyChangeLogAdmin._all();
          const now = W.policyChangeLogAdmin._nowLocal();
          const it = {
            id: e.id || W.policyChangeLogAdmin._uuid("PCL"),
            at: e.at || now,
            env: e.env || "PRD",
            domain: e.domain || "기타",
            policyKey: e.policyKey || "unknown",
            policyName: e.policyName || "정책",
            changeType: e.changeType || "UPDATE",
            result: e.result || "APPLIED",
            actor: e.actor || { id: "system", name: "시스템", dept: "-" },
            approver: e.approver || null,
            ticket: e.ticket || "",
            ip: e.ip || "",
            reason: e.reason || "",
            before: e.before || {},
            after: e.after || {},
            error: e.error || "",
          };
          it.hash = e.hash || W.policyChangeLogAdmin._shaLike(it.domain + "|" + it.policyKey + "|" + it.at);
          all.unshift(it);
          W.policyChangeLogAdmin._persist(all);
          return it.id;
        } catch (e) {}
      };

      /* ------------------------------------------------------------
       * 카드 클릭 연결
       * - (1) 카드 라우터 패치가 있으면 registerItemHandler로 연결
       * - (2) 없으면 logAudit 섹션 렌더 시 카드 제목 매칭으로만 클릭 바인딩
       * ------------------------------------------------------------ */
      function tryRegister() {
        if (!W.admin || typeof W.admin.registerItemHandler !== "function") return false;
        W.admin.registerItemHandler("policyChangeLog", () => W.policyChangeLogAdmin.open());
        return true;
      }

      function attachCardByTitleOnly() {
        const bodyEl = document.getElementById("adminBody");
        if (!bodyEl) return;

        const cards = bodyEl.querySelectorAll(".admin-card");
        let target = null;

        cards.forEach((card) => {
          const title = (card.querySelector("h4")?.textContent || "").trim();
          if (title.includes("정책 변경 이력")) target = card;
        });

        if (!target) return;
        if (target.dataset.pclBound === "1") return;
        target.dataset.pclBound = "1";

        target.classList.add("admin-card-clickable");
        target.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          W.policyChangeLogAdmin.open();
        });

        const footer = target.querySelector(".admin-footer, .card-footer");
        if (footer) footer.textContent = "클릭하여 정책 변경 이력(전/후 스냅샷)을 조회합니다.";
      }

      function patchAdminShowForLogAudit() {
        if (!W.admin || W.admin.__pclShowPatched) return;
        W.admin.__pclShowPatched = true;

        const originalShow = W.admin.show;
        W.admin.show = function (sectionId) {
          originalShow.call(this, sectionId);
          if (sectionId === "logAudit") {
            try { attachCardByTitleOnly(); } catch (e) {}
          }
        };
      }

      if (!tryRegister()) patchAdminShowForLogAudit();
    })();
    /* ---------------- Admin: 정책 변경 이력 (로그 조회·감사 뷰 > 정책 변경 이력) end ---------------- */
   
    /* ---------------- Admin: 보안담당/감사자 전용 뷰 (auditView) start ---------------- */
(() => {
  const W = window;

  const auditViewAdmin = {
    _storeKey: "dbam_auditView_v1",
    state: {
      selectedId: null,
      presetId: "ALL",
      filters: {
        from: "",
        to: "",
        env: "ALL",
        source: "ALL",
        severity: "ALL",
        result: "ALL",
        user: "",
        target: "",
        q: "",
        onlyRisk: false,
        onlyBlocked: false,
        onlyDownload: false,
      },
    },

    // ---------- utils ----------
    _pad(n) { return String(n).padStart(2, "0"); },
    _nowLocal() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = this._pad(d.getMonth() + 1);
      const dd = this._pad(d.getDate());
      const hh = this._pad(d.getHours());
      const mi = this._pad(d.getMinutes());
      const ss = this._pad(d.getSeconds());
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    },
    _todayYmd() {
      const d = new Date();
      return `${d.getFullYear()}-${this._pad(d.getMonth() + 1)}-${this._pad(d.getDate())}`;
    },
    _esc(s) {
      const v = (s === null || s === undefined) ? "" : String(s);
      return v
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    },
    _uuid(prefix) {
      const d = new Date();
      const y = d.getFullYear();
      const m = this._pad(d.getMonth() + 1);
      const day = this._pad(d.getDate());
      return `${prefix || "AUD"}-${y}${m}${day}-` + Math.random().toString(16).slice(2, 8).toUpperCase();
    },
    _badge(txt, bg, fg) {
      return `<span style="display:inline-block;padding:3px 8px;border-radius:999px;background:${bg};color:${fg};font-size:12px;font-weight:800;">${this._esc(txt)}</span>`;
    },
    _sevBadge(sev) {
      const m = {
        INFO: { bg: "#f3f4f6", fg: "#374151", label: "INFO" },
        WARN: { bg: "#fff7ed", fg: "#9a3412", label: "WARN" },
        HIGH: { bg: "#fef2f2", fg: "#b91c1c", label: "HIGH" },
      };
      const c = m[sev] || m.INFO;
      return this._badge(c.label, c.bg, c.fg);
    },
    _srcBadge(src) {
      const m = {
        ACTIVITY: { bg: "#eff6ff", fg: "#1d4ed8", label: "활동" },
        DB:       { bg: "#f0f9ff", fg: "#0369a1", label: "DB" },
        DOWNLOAD: { bg: "#ecfdf5", fg: "#047857", label: "다운로드" },
        POLICY:   { bg: "#f5f3ff", fg: "#6d28d9", label: "정책" },
        SHARED:   { bg: "#fff7ed", fg: "#9a3412", label: "공용계정" },
        EMERGENCY:{ bg: "#fef2f2", fg: "#b91c1c", label: "응급권한" },
      };
      const c = m[src] || { bg: "#f3f4f6", fg: "#374151", label: src || "-" };
      return this._badge(c.label, c.bg, c.fg);
    },
    _resBadge(r) {
      // 결과는 다양한 값을 허용
      const v = String(r || "").toUpperCase();
      if (v.includes("DENY") || v.includes("BLOCK") || v.includes("FAIL") || v.includes("REJECT")) return this._badge("차단/실패", "#fef2f2", "#b91c1c");
      if (v.includes("APPROV") || v.includes("ALLOW") || v.includes("SUCCESS") || v.includes("APPLIED")) return this._badge("정상/적용", "#ecfdf5", "#047857");
      if (v.includes("PENDING") || v.includes("WAIT")) return this._badge("대기", "#eff6ff", "#1d4ed8");
      if (v.includes("ROLLBACK")) return this._badge("롤백", "#fff7ed", "#9a3412");
      return this._badge(r || "-", "#f3f4f6", "#374151");
    },

    _copy(text) {
      const t = String(text ?? "");
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(t).then(() => true).catch(() => false);
      }
      try {
        const ta = document.createElement("textarea");
        ta.value = t;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        return Promise.resolve(true);
      } catch (e) {
        return Promise.resolve(false);
      }
    },

    // ---------- modal ----------
    _ensureModal() {
      let bd = document.getElementById("avModalBackdrop");
      if (bd) return bd;

      bd = document.createElement("div");
      bd.id = "avModalBackdrop";
      bd.className = "export-modal-backdrop";
      bd.innerHTML = `
        <div class="export-modal" style="max-width:980px;width:calc(100vw - 40px);">
          <div class="export-modal-header">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <h3 id="avModalTitle" style="margin:0;font-size:14px;"></h3>
              <button class="btn" id="avModalCloseBtn"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
          <div id="avModalBody" style="margin-top:10px;"></div>
          <div id="avModalFooter" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;"></div>
        </div>
      `;
      document.body.appendChild(bd);

      bd.addEventListener("click", (e) => { if (e.target === bd) bd.classList.remove("show"); });
      bd.querySelector("#avModalCloseBtn").addEventListener("click", () => bd.classList.remove("show"));
      return bd;
    },
    _openModal(titleHtml, bodyHtml, footerButtons) {
      const bd = this._ensureModal();
      bd.querySelector("#avModalTitle").innerHTML = titleHtml;
      bd.querySelector("#avModalBody").innerHTML = bodyHtml;

      const ft = bd.querySelector("#avModalFooter");
      ft.innerHTML = "";
      (footerButtons || []).forEach((btn) => {
        const b = document.createElement("button");
        b.className = btn.className || "btn";
        b.innerHTML = btn.label;
        b.addEventListener("click", () => btn.onClick && btn.onClick());
        ft.appendChild(b);
      });

      bd.classList.add("show");
    },
    _closeModal() {
      document.getElementById("avModalBackdrop")?.classList.remove("show");
    },

    // ---------- store ----------
    _loadStore() {
      try {
        const raw = localStorage.getItem(this._storeKey);
        if (raw) return JSON.parse(raw);
      } catch (e) {}
      return null;
    },
    _saveStore(st) {
      try { localStorage.setItem(this._storeKey, JSON.stringify(st)); } catch (e) {}
    },
    _seedStore() {
      const now = this._nowLocal();
      return {
        events: [
          {
            id: "AUD-20251216-001",
            ts: "2025-12-16 09:20:10",
            env: "PRD",
            source: "DB",
            severity: "WARN",
            result: "DENY",
            actor: { id: "u102", name: "김개발", dept: "채널개발팀" },
            action: "SQL_EXEC",
            target: { system: "CRM-PROD", db: "CRM01", schema: "APP", object: "CUSTOMER", ip: "10.10.12.34" },
            summary: "WHERE 없는 UPDATE 시도(차단)",
            flags: ["위험쿼리", "차단"],
            refs: { dbAccessLogId: "DBL-20251216-0003" },
            raw: { sql: "UPDATE CUSTOMER SET ...", rule: "UPDATE(?!.*WHERE) 차단" },
          },
          {
            id: "AUD-20251216-002",
            ts: "2025-12-16 09:12:03",
            env: "PRD",
            source: "POLICY",
            severity: "INFO",
            result: "APPLIED",
            actor: { id: "sec01", name: "김보안", dept: "보안운영팀" },
            action: "POLICY_UPDATE",
            target: { policyKey: "passwordPolicy", policyName: "비밀번호 정책 관리" },
            summary: "최소 길이/히스토리 강화",
            flags: ["정책변경"],
            refs: { policyChangeId: "PCL-20251216-01" },
            raw: { before: { minLen: 10, history: 6 }, after: { minLen: 12, history: 8 } },
          },
          {
            id: "AUD-20251216-003",
            ts: "2025-12-16 08:55:10",
            env: "PRD",
            source: "SHARED",
            severity: "WARN",
            result: "결재대기",
            actor: { id: "u201", name: "박운영", dept: "IT운영센터/DBA팀" },
            action: "SHARED_ACCOUNT_REQUEST",
            target: { accountId: "PA-ORA-PROD-DBA", system: "ORA-PROD", risk: "HIGH" },
            summary: "공용계정 사용 사유 등록 및 상신",
            flags: ["공용계정", "결재"],
            refs: { sharedAccountId: "SA-20251216-001" },
            raw: { itsm: "INC-20251216-0103", period: "13:00~16:00" },
          },
          {
            id: "AUD-20251215-021",
            ts: "2025-12-15 21:40:11",
            env: "PRD",
            source: "POLICY",
            severity: "WARN",
            result: "APPLIED",
            actor: { id: "ops02", name: "이운영", dept: "DBA팀" },
            action: "POLICY_UPDATE",
            target: { policyKey: "sqlPreblock", policyName: "허용 범위 밖 SQL 사전 차단" },
            summary: "무조건 UPDATE 차단 룰 보강",
            flags: ["정책변경"],
            refs: { policyChangeId: "PCL-20251215-02" },
            raw: { added: ["UPDATE(?!.*WHERE)"] },
          },
          {
            id: "AUD-20251215-033",
            ts: "2025-12-15 02:05:00",
            env: "PRD",
            source: "EMERGENCY",
            severity: "HIGH",
            result: "SUCCESS",
            actor: { id: "u310", name: "박운영", dept: "IT운영센터/DBA팀" },
            action: "EMERGENCY_PRIV_USE",
            target: { system: "ORA-PROD", account: "oracle", ip: "10.20.0.18" },
            summary: "응급 권한 사용 시작(장애 대응)",
            flags: ["응급권한", "사후로그필수"],
            refs: { emergencyLogId: "EUL-20251215-0001" },
            raw: { ticket: "CHG-20251215-0042" },
          },
          {
            id: "AUD-20251214-008",
            ts: "2025-12-14 14:03:55",
            env: "STG",
            source: "POLICY",
            severity: "HIGH",
            result: "FAILED",
            actor: { id: "sec03", name: "최보안", dept: "보안운영팀" },
            action: "POLICY_UPDATE",
            target: { policyKey: "mfaPolicy", policyName: "MFA 적용 정책" },
            summary: "정책 저장 검증 실패",
            flags: ["정책변경", "실패"],
            refs: { policyChangeId: "PCL-20251214-03" },
            raw: { error: "검증 실패(graceDays 최소값 미만)" },
          },
          {
            id: "AUD-20251214-101",
            ts: "2025-12-14 23:58:19",
            env: "PRD",
            source: "DOWNLOAD",
            severity: "HIGH",
            result: "SUCCESS",
            actor: { id: "u102", name: "김개발", dept: "채널개발팀" },
            action: "EXPORT",
            target: { system: "CRM-PROD", db: "CRM01", object: "CUSTOMER", rows: 52000, ip: "10.10.12.34" },
            summary: "대량 다운로드(52,000 rows)",
            flags: ["대량다운로드"],
            refs: { dbAccessLogId: "DBL-20251214-0099" },
            raw: { format: "CSV", reason: "장애 분석" },
          },
        ],
        presets: [
          {
            id: "PRESET-RISK",
            name: "위험/차단만",
            createdAt: now,
            filters: { onlyRisk: true, onlyBlocked: true, severity: "ALL", result: "ALL", source: "ALL", env: "ALL" },
          },
          {
            id: "PRESET-DOWNLOAD",
            name: "대량 다운로드 추적",
            createdAt: now,
            filters: { onlyDownload: true, severity: "ALL", result: "ALL", source: "ALL", env: "ALL" },
          },
        ],
      };
    },
    _ensureStore() {
      let st = this._loadStore();
      if (!st || !Array.isArray(st.events) || !Array.isArray(st.presets)) {
        st = this._seedStore();
        this._saveStore(st);
      }
      return st;
    },
    _getStore() { return this._ensureStore(); },
    _persist(st) { this._saveStore(st); },

    // 다른 화면 localStorage가 있으면 합쳐서 “감사 뷰”에서 같이 검색 가능
    _pullExternalEvents() {
      const merged = [];

      // 1) 정책 변경 이력
      try {
        const raw = localStorage.getItem("dbam_policyChangeLog_v1");
        if (raw) {
          const st = JSON.parse(raw);
          const items = Array.isArray(st?.items) ? st.items : [];
          items.forEach((p) => {
            merged.push({
              id: `AUD-POL-${p.id || this._uuid("P")}`,
              ts: p.at || "",
              env: p.env || "PRD",
              source: "POLICY",
              severity: (p.result === "FAILED" ? "HIGH" : (p.result === "ROLLBACK" ? "WARN" : "INFO")),
              result: p.result || "APPLIED",
              actor: p.actor || { id: "", name: "", dept: "" },
              action: "POLICY_UPDATE",
              target: { policyKey: p.policyKey, policyName: p.policyName },
              summary: p.reason || "정책 변경",
              flags: ["정책변경"],
              refs: { policyChangeId: p.id },
              raw: p,
            });
          });
        }
      } catch (e) {}

      // 2) 공용계정 사용 사유·승인
      try {
        const raw = localStorage.getItem("dbam_sharedAccountReason_v1");
        if (raw) {
          const st = JSON.parse(raw);
          const reqs = Array.isArray(st?.requests) ? st.requests : [];
          reqs.forEach((r) => {
            const sev = (String(r.risk || "").toUpperCase() === "HIGH") ? "HIGH" : "WARN";
            merged.push({
              id: `AUD-SA-${r.id || this._uuid("SA")}`,
              ts: (r.logs?.[0]?.at) || r.periodStart || "",
              env: r.env || "PRD",
              source: "SHARED",
              severity: sev,
              result: r.status || "결재대기",
              actor: { id: "", name: r.requester || "", dept: r.dept || "" },
              action: "SHARED_ACCOUNT",
              target: { accountId: r.accountId, system: r.system, risk: r.risk },
              summary: r.reason || "공용계정 요청",
              flags: ["공용계정"],
              refs: { sharedAccountId: r.id },
              raw: r,
            });
          });
        }
      } catch (e) {}

      // 3) (있다면) 응급 권한 사용 내역
      try {
        const raw = localStorage.getItem("dbam_emergencyUseLog_v1");
        if (raw) {
          const st = JSON.parse(raw);
          const logs = Array.isArray(st?.logs) ? st.logs : [];
          logs.forEach((x) => {
            merged.push({
              id: `AUD-EU-${x.id || this._uuid("EU")}`,
              ts: x.at || x.startAt || "",
              env: x.env || "PRD",
              source: "EMERGENCY",
              severity: x.severity || "HIGH",
              result: x.result || "SUCCESS",
              actor: x.actor || { id: "", name: x.user || "", dept: x.dept || "" },
              action: x.action || "EMERGENCY",
              target: x.target || { system: x.system || "", ip: x.ip || "" },
              summary: x.summary || "응급 권한 사용",
              flags: Array.isArray(x.flags) ? x.flags : ["응급권한"],
              refs: { emergencyLogId: x.id },
              raw: x,
            });
          });
        }
      } catch (e) {}

      return merged;
    },

    _getAllEvents() {
      const st = this._getStore();
      const base = Array.isArray(st.events) ? st.events.slice() : [];
      const ext = this._pullExternalEvents();

      // id 기준 중복 제거(같은 화면에서 여러 번 open해도 안정)
      const seen = new Set();
      const out = [];
      [...ext, ...base].forEach((e) => {
        const id = String(e?.id || "");
        if (!id || seen.has(id)) return;
        seen.add(id);
        out.push(e);
      });

      // 최신순
      out.sort((a, b) => String(b.ts || "").localeCompare(String(a.ts || "")));
      return out;
    },

    // ---------- entry ----------
    open() {
      const ov = document.getElementById("adminOverlay");
      if (ov) { ov.classList.add("show"); ov.setAttribute("aria-hidden", "false"); }

      document.querySelectorAll(".admin-nav button").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.section === "logAudit");
      });

      const titleEl = document.getElementById("adminTitle");
      const descEl = document.getElementById("adminDesc");
      const bodyEl = document.getElementById("adminBody");
      if (!titleEl || !descEl || !bodyEl) return;

      titleEl.innerHTML = `<i class="fa-solid fa-magnifying-glass"></i> 보안담당/감사자 전용 뷰`;
      descEl.textContent = "기간/환경/구분/사용자/대상/키워드로 전체 로그를 교차 검색하고, 케이스 단위로 내보낼 수 있습니다.";

      bodyEl.innerHTML = this.getTemplateHtml();
      this._initDefaultFilters();
      this.bindOnce();
      this.renderAll();
    },

    _initDefaultFilters() {
      // 최초 진입 기본값: 오늘
      if (!this.state.filters.from && !this.state.filters.to) {
        const ymd = this._todayYmd();
        this.state.filters.from = ymd;
        this.state.filters.to = ymd;
      }
      // 프리셋 초기화
      this.state.presetId = this.state.presetId || "ALL";
    },

    getTemplateHtml() {
      return `
        <div id="avPage" class="emg-page" style="display:flex;flex-direction:column;gap:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <div style="display:flex;gap:8px;align-items:center;">
              <button id="avBack" class="btn" type="button"><i class="fa-solid fa-arrow-left"></i></button>
              <div style="font-weight:900;">감사 전용 교차 검색</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
              <select id="avPreset" class="input" style="min-width:220px;">
                <option value="ALL">프리셋(선택)</option>
              </select>
              <button id="avBtnSavePreset" class="btn" type="button"><i class="fa-solid fa-bookmark"></i> 프리셋 저장</button>
              <button id="avBtnReset" class="btn" type="button"><i class="fa-solid fa-rotate-left"></i> 초기화</button>
              <button id="avBtnCaseExport" class="btn" type="button"><i class="fa-solid fa-suitcase"></i> 케이스 내보내기</button>
              <button id="avBtnExport" class="btn" type="button"><i class="fa-solid fa-file-export"></i> 내보내기</button>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:10px;">
            <div class="admin-card" style="padding:10px 12px;">
              <div style="font-size:12px;color:#6b7280;">총 이벤트</div>
              <div id="avKpiTotal" style="font-size:20px;font-weight:900;margin-top:4px;">0</div>
            </div>
            <div class="admin-card" style="padding:10px 12px;">
              <div style="font-size:12px;color:#6b7280;">HIGH</div>
              <div id="avKpiHigh" style="font-size:20px;font-weight:900;margin-top:4px;">0</div>
            </div>
            <div class="admin-card" style="padding:10px 12px;">
              <div style="font-size:12px;color:#6b7280;">차단/실패</div>
              <div id="avKpiBlocked" style="font-size:20px;font-weight:900;margin-top:4px;">0</div>
            </div>
            <div class="admin-card" style="padding:10px 12px;">
              <div style="font-size:12px;color:#6b7280;">다운로드</div>
              <div id="avKpiDownload" style="font-size:20px;font-weight:900;margin-top:4px;">0</div>
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <div style="flex:1.35;min-width:560px;display:flex;flex-direction:column;gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div class="admin-header">
                  <h2><i class="fa-solid fa-filter"></i> 필터</h2>
                  <span class="badge" id="avCount">0건</span>
                </div>

                <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:10px;">
                  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                    <div style="display:flex;gap:6px;align-items:center;">
                      <span style="font-size:12px;color:#6b7280;">기간</span>
                      <input id="avFrom" class="input" type="date" style="min-width:140px;" />
                      <span style="color:#9ca3af;">~</span>
                      <input id="avTo" class="input" type="date" style="min-width:140px;" />
                    </div>

                    <select id="avEnv" class="input" style="min-width:110px;">
                      <option value="ALL">환경(전체)</option>
                      <option value="PRD">PRD</option>
                      <option value="STG">STG</option>
                      <option value="DEV">DEV</option>
                    </select>

                    <select id="avSource" class="input" style="min-width:130px;">
                      <option value="ALL">구분(전체)</option>
                      <option value="ACTIVITY">활동</option>
                      <option value="DB">DB</option>
                      <option value="DOWNLOAD">다운로드</option>
                      <option value="POLICY">정책</option>
                      <option value="SHARED">공용계정</option>
                      <option value="EMERGENCY">응급권한</option>
                    </select>

                    <select id="avSeverity" class="input" style="min-width:120px;">
                      <option value="ALL">심각도(전체)</option>
                      <option value="INFO">INFO</option>
                      <option value="WARN">WARN</option>
                      <option value="HIGH">HIGH</option>
                    </select>

                    <select id="avResult" class="input" style="min-width:120px;">
                      <option value="ALL">결과(전체)</option>
                      <option value="ALLOW">ALLOW</option>
                      <option value="DENY">DENY</option>
                      <option value="SUCCESS">SUCCESS</option>
                      <option value="FAIL">FAIL</option>
                      <option value="APPLIED">APPLIED</option>
                      <option value="FAILED">FAILED</option>
                      <option value="결재대기">결재대기</option>
                      <option value="승인">승인</option>
                      <option value="반려">반려</option>
                    </select>
                  </div>

                  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                    <label style="display:flex;gap:6px;align-items:center;font-size:12px;color:#475569;">
                      <input id="avOnlyRisk" type="checkbox" /> 위험만
                    </label>
                    <label style="display:flex;gap:6px;align-items:center;font-size:12px;color:#475569;">
                      <input id="avOnlyBlocked" type="checkbox" /> 차단/실패만
                    </label>
                    <label style="display:flex;gap:6px;align-items:center;font-size:12px;color:#475569;">
                      <input id="avOnlyDownload" type="checkbox" /> 다운로드만
                    </label>
                  </div>
                </div>

                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
                  <input id="avUser" class="input" style="min-width:220px;flex:1;" placeholder="사용자(이름/ID/부서)" />
                  <input id="avTarget" class="input" style="min-width:220px;flex:1;" placeholder="대상(시스템/DB/정책/계정/오브젝트)" />
                  <input id="avQ" class="input" style="min-width:260px;flex:2;" placeholder="키워드(사유/티켓/SQL요약/해시/플래그)" />
                </div>

                <div class="table-scroll-x scope-items-wrap" style="margin-top:10px; border:1px solid var(--line); border-radius:10px; overflow:auto; padding-bottom:6px; max-height:520px;">
                  <table class="scope-items-table" style="width:100%; min-width:1120px; border-collapse:collapse; table-layout:fixed;">
                    <colgroup>
                      <col style="width:160px;">
                      <col style="width:110px;">
                      <col style="width:90px;">
                      <col style="width:110px;">
                      <col style="width:200px;">
                      <col style="width:230px;">
                      <col style="width:220px;">
                    </colgroup>
                    <thead>
                      <tr style="background:#f9fafb;">
                        <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">시각</th>
                        <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">구분</th>
                        <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">환경</th>
                        <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">심각도</th>
                        <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">사용자</th>
                        <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">행위</th>
                        <th style="text-align:left; padding:8px 10px; font-size:12px; color:#6b7280;">대상/결과</th>
                      </tr>
                    </thead>
                    <tbody id="avTbody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div style="flex:1;min-width:360px;display:flex;flex-direction:column;gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div class="admin-header">
                  <h2><i class="fa-solid fa-circle-info"></i> 상세</h2>
                  <span class="badge" id="avSelBadge">미선택</span>
                </div>
                <div id="avDetail" style="margin-top:10px;color:#111827;">
                  <div style="color:#6b7280;font-size:13px;">좌측 목록에서 항목을 선택하세요.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    },

    // ---------- binding ----------
    bindOnce() {
      const bodyEl = document.getElementById("adminBody");
      if (!bodyEl) return;
      if (bodyEl.dataset.avBound === "1") return;
      bodyEl.dataset.avBound = "1";

      bodyEl.addEventListener("click", (e) => {
        const row = e.target.closest("tr[data-id]");
        if (row) {
          this.state.selectedId = row.dataset.id;
          this.renderDetail();
          this.renderList();
          return;
        }

        const btn = e.target.closest("button");
        if (!btn) return;

        if (btn.id === "avBack") {
          if (W.admin && typeof W.admin.show === "function") W.admin.show("logAudit");
          return;
        }
        if (btn.id === "avBtnExport") {
          this.exportFiltered();
          return;
        }
        if (btn.id === "avBtnCaseExport") {
          this.exportCasePack();
          return;
        }
        if (btn.id === "avBtnReset") {
          this.resetFilters();
          return;
        }
        if (btn.id === "avBtnSavePreset") {
          this.openSavePresetModal();
          return;
        }

        const act = btn.dataset.action;
        const id = btn.dataset.id;
        if (act === "openOrigin") this.openOrigin(id);
        if (act === "copyJson") this.copyRawJson(id);
        if (act === "pinCase") this.pinToCase(id);
        if (act === "unpinCase") this.unpinFromCase(id);
      });

      bodyEl.addEventListener("change", (e) => {
        const t = e.target;
        if (!t) return;

        if (t.id === "avFrom") this.state.filters.from = t.value || "";
        if (t.id === "avTo") this.state.filters.to = t.value || "";
        if (t.id === "avEnv") this.state.filters.env = t.value;
        if (t.id === "avSource") this.state.filters.source = t.value;
        if (t.id === "avSeverity") this.state.filters.severity = t.value;
        if (t.id === "avResult") this.state.filters.result = t.value;

        if (t.id === "avOnlyRisk") this.state.filters.onlyRisk = !!t.checked;
        if (t.id === "avOnlyBlocked") this.state.filters.onlyBlocked = !!t.checked;
        if (t.id === "avOnlyDownload") this.state.filters.onlyDownload = !!t.checked;

        if (t.id === "avPreset") {
          this.state.presetId = t.value || "ALL";
          this.applyPreset(this.state.presetId);
        }

        this.renderAll();
      });

      bodyEl.addEventListener("input", (e) => {
        const t = e.target;
        if (!t) return;

        if (t.id === "avUser") this.state.filters.user = t.value || "";
        if (t.id === "avTarget") this.state.filters.target = t.value || "";
        if (t.id === "avQ") this.state.filters.q = t.value || "";

        this.renderList();
        this.renderDetail();
        this.renderKpis();
      });
    },

    // ---------- filters ----------
    _inDateRange(ts, fromYmd, toYmd) {
      const d = String(ts || "").slice(0, 10);
      if (fromYmd && d < fromYmd) return false;
      if (toYmd && d > toYmd) return false;
      return true;
    },
    _isBlockedResult(result) {
      const v = String(result || "").toUpperCase();
      return v.includes("DENY") || v.includes("BLOCK") || v.includes("FAIL") || v.includes("REJECT");
    },
    _isDownloadEvent(e) {
      return e?.source === "DOWNLOAD" || e?.action === "EXPORT" || (Array.isArray(e?.flags) && e.flags.some(f => String(f).includes("다운로드")));
    },
    _matchKeyword(e, kw) {
      if (!kw) return true;
      const k = kw.trim().toLowerCase();
      if (!k) return true;

      const a = e.actor || {};
      const t = e.target || {};

      const blob = [
        e.id, e.ts, e.env, e.source, e.severity, e.result, e.action,
        e.summary,
        a.id, a.name, a.dept,
        t.system, t.db, t.schema, t.object, t.policyKey, t.policyName, t.accountId, t.account,
        t.ip, t.rows,
        (e.flags || []).join(" "),
        JSON.stringify(e.refs || {}),
        JSON.stringify(e.raw || {}),
      ].join(" ").toLowerCase();

      return blob.includes(k);
    },
    _filtered() {
      const f = this.state.filters;
      const kw = (f.q || "").trim();
      const userKw = (f.user || "").trim().toLowerCase();
      const targetKw = (f.target || "").trim().toLowerCase();

      return this._getAllEvents().filter((e) => {
        if (!this._inDateRange(e.ts, f.from, f.to)) return false;
        if (f.env !== "ALL" && e.env !== f.env) return false;
        if (f.source !== "ALL" && e.source !== f.source) return false;
        if (f.severity !== "ALL" && e.severity !== f.severity) return false;

        if (f.result !== "ALL") {
          const r = String(e.result || "");
          if (r !== f.result) return false;
        }

        if (f.onlyRisk && e.severity !== "HIGH") return false;
        if (f.onlyBlocked && !this._isBlockedResult(e.result)) return false;
        if (f.onlyDownload && !this._isDownloadEvent(e)) return false;

        if (userKw) {
          const a = e.actor || {};
          const blobU = `${a.id || ""} ${a.name || ""} ${a.dept || ""}`.toLowerCase();
          if (!blobU.includes(userKw)) return false;
        }

        if (targetKw) {
          const t = e.target || {};
          const blobT = `${t.system || ""} ${t.db || ""} ${t.schema || ""} ${t.object || ""} ${t.policyKey || ""} ${t.policyName || ""} ${t.accountId || ""} ${t.account || ""}`.toLowerCase();
          if (!blobT.includes(targetKw)) return false;
        }

        if (!this._matchKeyword(e, kw)) return false;

        return true;
      });
    },

    // ---------- presets ----------
    _getPresets() {
      const st = this._getStore();
      return Array.isArray(st.presets) ? st.presets : [];
    },
    applyPreset(presetId) {
      if (!presetId || presetId === "ALL") return;

      const p = this._getPresets().find(x => x.id === presetId);
      if (!p || !p.filters) return;

      // 프리셋은 “일부 필터만 덮어쓰기”
      const f = p.filters;
      Object.keys(f).forEach((k) => {
        if (k in this.state.filters) this.state.filters[k] = f[k];
      });
    },
    openSavePresetModal() {
      const f = this.state.filters;

      this._openModal(
        `<i class="fa-solid fa-bookmark"></i> 프리셋 저장`,
        `
          <div style="font-size:12px;color:#475569;margin-bottom:8px;">
            현재 필터 조건을 프리셋으로 저장합니다.
          </div>
          <div style="display:grid;grid-template-columns:1fr;gap:10px;">
            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">프리셋 이름</div>
              <input id="avPresetName" class="export-input" placeholder="예) PRD 차단/실패 추적" />
            </div>
            <div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">저장할 필터(미리보기)</div>
              <pre style="margin:0;white-space:pre-wrap;word-break:break-word;background:#0b1020;color:#e5e7eb;border-radius:10px;padding:10px;font-size:12px;max-height:220px;overflow:auto;">${this._esc(JSON.stringify(f, null, 2))}</pre>
            </div>
          </div>
        `,
        [
          { label: '<i class="fa-solid fa-xmark"></i> 취소', className: "btn", onClick: () => this._closeModal() },
          {
            label: '<i class="fa-solid fa-check"></i> 저장',
            className: "btn primary",
            onClick: () => {
              const name = (document.getElementById("avPresetName")?.value || "").trim();
              if (!name) return alert("프리셋 이름을 입력하세요.");

              const st = this._getStore();
              st.presets = Array.isArray(st.presets) ? st.presets : [];
              const id = this._uuid("PRESET");
              st.presets.unshift({ id, name, createdAt: this._nowLocal(), filters: { ...this.state.filters } });
              this._persist(st);

              this.state.presetId = id;
              this._closeModal();
              this.renderAll();
            }
          }
        ]
      );
    },

    // ---------- render ----------
    renderAll() {
      this.renderPresetOptions();
      this.renderFilterControls();
      this.renderList();
      this.renderDetail();
      this.renderKpis();
    },

    renderPresetOptions() {
      const sel = document.getElementById("avPreset");
      if (!sel) return;

      const presets = this._getPresets();
      const opts = [
        `<option value="ALL">프리셋(선택)</option>`,
        ...presets.map(p => `<option value="${this._esc(p.id)}">${this._esc(p.name)}</option>`)
      ].join("");
      sel.innerHTML = opts;
      sel.value = this.state.presetId || "ALL";
    },

    renderFilterControls() {
      const f = this.state.filters;

      const fromEl = document.getElementById("avFrom");
      const toEl = document.getElementById("avTo");
      const envEl = document.getElementById("avEnv");
      const srcEl = document.getElementById("avSource");
      const sevEl = document.getElementById("avSeverity");
      const resEl = document.getElementById("avResult");
      const userEl = document.getElementById("avUser");
      const tgtEl = document.getElementById("avTarget");
      const qEl = document.getElementById("avQ");

      const riskEl = document.getElementById("avOnlyRisk");
      const blkEl = document.getElementById("avOnlyBlocked");
      const dlEl = document.getElementById("avOnlyDownload");

      if (fromEl) fromEl.value = f.from || "";
      if (toEl) toEl.value = f.to || "";
      if (envEl) envEl.value = f.env || "ALL";
      if (srcEl) srcEl.value = f.source || "ALL";
      if (sevEl) sevEl.value = f.severity || "ALL";
      if (resEl) resEl.value = f.result || "ALL";
      if (userEl) userEl.value = f.user || "";
      if (tgtEl) tgtEl.value = f.target || "";
      if (qEl) qEl.value = f.q || "";

      if (riskEl) riskEl.checked = !!f.onlyRisk;
      if (blkEl) blkEl.checked = !!f.onlyBlocked;
      if (dlEl) dlEl.checked = !!f.onlyDownload;
    },

    renderList() {
      const tbody = document.getElementById("avTbody");
      const countEl = document.getElementById("avCount");
      if (!tbody || !countEl) return;

      const list = this._filtered();
      countEl.textContent = `${list.length}건`;

      const selId = this.state.selectedId;

      tbody.innerHTML = list.map((e) => {
        const isSel = selId && selId === e.id;
        const trBg = isSel ? "background:#eef2ff;" : "";
        const a = e.actor || {};
        const t = e.target || {};
        const user = `${this._esc(a.name || "-")}<div style="color:#9ca3af;font-size:12px;">${this._esc(a.dept || "")} ${a.id ? `· ${this._esc(a.id)}` : ""}</div>`;
        const act = `${this._esc(e.action || "-")}<div style="color:#9ca3af;font-size:12px;">${this._esc(e.summary || "")}</div>`;
        const tgt = (() => {
          if (e.source === "POLICY") return `${this._esc(t.policyName || "-")}<div style="color:#9ca3af;font-size:12px;">${this._esc(t.policyKey || "")}</div>`;
          if (e.source === "SHARED") return `${this._esc(t.accountId || "-")}<div style="color:#9ca3af;font-size:12px;">${this._esc(t.system || "")} · RISK:${this._esc(t.risk || "")}</div>`;
          if (e.source === "DB" || e.source === "DOWNLOAD") return `${this._esc(t.system || "-")} / ${this._esc(t.db || "")}<div style="color:#9ca3af;font-size:12px;">${this._esc(t.schema || "")} ${t.object ? `· ${this._esc(t.object)}` : ""}</div>`;
          return `${this._esc(t.system || t.policyName || t.accountId || "-")}<div style="color:#9ca3af;font-size:12px;">${this._esc(t.ip || "")}</div>`;
        })();
        const tail = `${this._resBadge(e.result)}<div style="margin-top:6px;color:#9ca3af;font-size:12px;">${(e.flags || []).slice(0, 3).map(f => `#${this._esc(f)}`).join(" ")}</div>`;

        return `
          <tr data-id="${this._esc(e.id)}" style="border-bottom:1px solid #f3f4f6; cursor:pointer; ${trBg}">
            <td style="padding:10px; font-weight:800;">${this._esc(e.ts || "")}</td>
            <td style="padding:10px;">${this._srcBadge(e.source)}</td>
            <td style="padding:10px;">${this._esc(e.env || "")}</td>
            <td style="padding:10px;">${this._sevBadge(e.severity)}</td>
            <td style="padding:10px;">${user}</td>
            <td style="padding:10px;">${act}</td>
            <td style="padding:10px;">${tgt}<div style="margin-top:6px;">${tail}</div></td>
          </tr>
        `;
      }).join("");

      if (selId && !list.some(x => x.id === selId)) {
        this.state.selectedId = null;
        const b = document.getElementById("avSelBadge");
        if (b) b.textContent = "미선택";
      }
    },

    renderDetail() {
      const badge = document.getElementById("avSelBadge");
      const box = document.getElementById("avDetail");
      if (!box) return;

      const id = this.state.selectedId;
      if (!id) {
        if (badge) badge.textContent = "미선택";
        box.innerHTML = `<div style="color:#6b7280;font-size:13px;">좌측 목록에서 항목을 선택하세요.</div>`;
        return;
      }

      const e = this._getAllEvents().find(x => x.id === id);
      if (!e) {
        this.state.selectedId = null;
        if (badge) badge.textContent = "미선택";
        box.innerHTML = `<div style="color:#6b7280;font-size:13px;">선택된 항목을 찾을 수 없습니다.</div>`;
        return;
      }

      if (badge) badge.textContent = e.id;

      const a = e.actor || {};
      const t = e.target || {};
      const flags = (e.flags || []).map(f => `<span class="admin-tag" style="margin-right:6px;">${this._esc(f)}</span>`).join("");

      const pinned = this._isPinned(e.id);
      const pinBtn = pinned
        ? `<button class="btn" data-action="unpinCase" data-id="${this._esc(e.id)}" type="button"><i class="fa-solid fa-minus"></i> 케이스 제외</button>`
        : `<button class="btn" data-action="pinCase" data-id="${this._esc(e.id)}" type="button"><i class="fa-solid fa-plus"></i> 케이스 포함</button>`;

      const rawJson = (() => {
        try { return JSON.stringify(e.raw ?? e, null, 2); } catch (x) { return String(e.raw ?? ""); }
      })();

      box.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div style="font-weight:900;font-size:14px;">이벤트 상세</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn" data-action="openOrigin" data-id="${this._esc(e.id)}" type="button"><i class="fa-solid fa-arrow-up-right-from-square"></i> 원본 화면</button>
            <button class="btn" data-action="copyJson" data-id="${this._esc(e.id)}" type="button"><i class="fa-solid fa-copy"></i> JSON 복사</button>
            ${pinBtn}
          </div>
        </div>

        <div style="margin-top:10px;border:1px solid var(--line);border-radius:12px;padding:10px;">
          <div style="display:grid;grid-template-columns:110px 1fr;gap:6px 10px;font-size:13px;">
            <div style="color:#6b7280;">시각</div><div>${this._esc(e.ts || "")}</div>
            <div style="color:#6b7280;">환경</div><div>${this._esc(e.env || "")}</div>
            <div style="color:#6b7280;">구분</div><div>${this._srcBadge(e.source)} <span style="margin-left:8px;">${this._sevBadge(e.severity)}</span></div>
            <div style="color:#6b7280;">결과</div><div>${this._resBadge(e.result)}</div>
            <div style="color:#6b7280;">사용자</div><div>${this._esc(a.name || "")} <span style="color:#9ca3af;">(${this._esc(a.id || "")})</span><div style="color:#9ca3af;font-size:12px;">${this._esc(a.dept || "")}</div></div>
            <div style="color:#6b7280;">행위</div><div><b>${this._esc(e.action || "")}</b><div style="color:#6b7280;font-size:12px;margin-top:2px;">${this._esc(e.summary || "")}</div></div>
            <div style="color:#6b7280;">대상</div><div>${this._esc(t.policyName || t.accountId || t.system || "-")} <span style="color:#9ca3af;">${this._esc(t.db || t.policyKey || "")}</span>
              <div style="color:#9ca3af;font-size:12px;">${[t.schema, t.object, t.ip].filter(Boolean).map(x => this._esc(x)).join(" · ")}</div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <div style="color:#6b7280;font-size:12px;margin-bottom:6px;">플래그</div>
            <div class="admin-tags">${flags || `<span style="color:#9ca3af;font-size:12px;">(없음)</span>`}</div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div style="font-weight:900;font-size:14px;margin-bottom:8px;">원본(JSON)</div>
          <pre style="margin:0;white-space:pre-wrap;word-break:break-word;background:#0b1020;color:#e5e7eb;border-radius:10px;padding:10px;font-size:12px;max-height:360px;overflow:auto;">${this._esc(rawJson)}</pre>
        </div>
      `;
    },

    renderKpis() {
      const list = this._filtered();
      const totalEl = document.getElementById("avKpiTotal");
      const highEl = document.getElementById("avKpiHigh");
      const blkEl = document.getElementById("avKpiBlocked");
      const dlEl = document.getElementById("avKpiDownload");

      const high = list.filter(x => x.severity === "HIGH").length;
      const blocked = list.filter(x => this._isBlockedResult(x.result)).length;
      const download = list.filter(x => this._isDownloadEvent(x)).length;

      if (totalEl) totalEl.textContent = String(list.length);
      if (highEl) highEl.textContent = String(high);
      if (blkEl) blkEl.textContent = String(blocked);
      if (dlEl) dlEl.textContent = String(download);
    },

    // ---------- case pack ----------
    _getPinnedSet() {
      const st = this._getStore();
      st.casePinned = st.casePinned || [];
      return new Set(st.casePinned);
    },
    _isPinned(id) {
      const st = this._getStore();
      st.casePinned = st.casePinned || [];
      return st.casePinned.includes(id);
    },
    pinToCase(id) {
      const st = this._getStore();
      st.casePinned = st.casePinned || [];
      if (!st.casePinned.includes(id)) st.casePinned.push(id);
      this._persist(st);
      this.renderDetail();
    },
    unpinFromCase(id) {
      const st = this._getStore();
      st.casePinned = st.casePinned || [];
      st.casePinned = st.casePinned.filter(x => x !== id);
      this._persist(st);
      this.renderDetail();
    },
    exportCasePack() {
      const st = this._getStore();
      const pinned = Array.isArray(st.casePinned) ? st.casePinned : [];
      const all = this._getAllEvents();
      const items = all.filter(x => pinned.includes(x.id));

      if (!items.length) return alert("케이스 포함된 항목이 없습니다.");

      const payload = {
        exportedAt: this._nowLocal(),
        type: "audit_case_pack",
        count: items.length,
        items,
      };

      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `audit_case_pack_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    },

    // ---------- actions ----------
    resetFilters() {
      const ymd = this._todayYmd();
      this.state.filters = {
        from: ymd,
        to: ymd,
        env: "ALL",
        source: "ALL",
        severity: "ALL",
        result: "ALL",
        user: "",
        target: "",
        q: "",
        onlyRisk: false,
        onlyBlocked: false,
        onlyDownload: false,
      };
      this.state.presetId = "ALL";
      this.state.selectedId = null;
      this.renderAll();
    },

    copyRawJson(id) {
      const e = this._getAllEvents().find(x => x.id === id);
      if (!e) return;
      const txt = (() => { try { return JSON.stringify(e.raw ?? e, null, 2); } catch (_) { return String(e.raw ?? ""); } })();
      this._copy(txt).then(ok => { if (!ok) alert("복사 실패"); });
    },

    openOrigin(id) {
      const e = this._getAllEvents().find(x => x.id === id);
      if (!e) return;

      // 원본 화면이 구현되어 있으면 해당 open()으로 이동
      if (e.source === "POLICY" && W.policyChangeLogAdmin?.open) return W.policyChangeLogAdmin.open();
      if (e.source === "SHARED" && W.sharedAccountReasonAdmin?.open) return W.sharedAccountReasonAdmin.open();
      if (e.source === "EMERGENCY" && W.emergencyUseLogAdmin?.open) return W.emergencyUseLogAdmin.open();
      if ((e.source === "DB" || e.source === "DOWNLOAD") && W.dbAccessLogAdmin?.open) return W.dbAccessLogAdmin.open();
      if (e.source === "ACTIVITY" && W.activityLogAdmin?.open) return W.activityLogAdmin.open();

      // 카드 라우터가 남아있다면 openItem으로 이동 시도
      if (W.admin?.openItem) {
        const map = { POLICY: "policyChangeLog", SHARED: "sharedAccountReason", EMERGENCY: "emergencyUseLog", DB: "dbAccessLog", DOWNLOAD: "dbAccessLog", ACTIVITY: "activityLog" };
        const itemId = map[e.source];
        if (itemId) return W.admin.openItem(itemId, "logAudit");
      }

      alert("연결된 원본 화면이 아직 구현되어 있지 않습니다.");
    },

    exportFiltered() {
      const list = this._filtered();
      const payload = {
        exportedAt: this._nowLocal(),
        type: "audit_export",
        filters: { ...this.state.filters },
        presetId: this.state.presetId,
        count: list.length,
        items: list,
      };

      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `audit_view_export_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    },
  };

  // expose
  W.auditViewAdmin = auditViewAdmin;

  /* ------------------------------------------------------------
   * 카드 클릭 연결 (auditView에만 적용)
   * 1) 카드 라우터가 있으면 registerItemHandler로만 연결
   * 2) 없으면 logAudit 섹션 렌더 후 제목 매칭으로만 클릭 바인딩
   * ------------------------------------------------------------ */
  function tryRegister() {
    if (!W.admin || typeof W.admin.registerItemHandler !== "function") return false;
    W.admin.registerItemHandler("auditView", () => W.auditViewAdmin.open());
    return true;
  }

  function attachCardByTitleOnly() {
    const bodyEl = document.getElementById("adminBody");
    if (!bodyEl) return;

    const cards = bodyEl.querySelectorAll(".admin-card");
    let target = null;

    cards.forEach((card) => {
      const title = (card.querySelector("h4")?.textContent || "").trim();
      if (title.includes("보안담당/감사자 전용 뷰") || title.includes("감사자 전용 뷰")) target = card;
    });

    if (!target) return;
    if (target.dataset.auditViewBound === "1") return;
    target.dataset.auditViewBound = "1";

    target.classList.add("admin-card-clickable");
    target.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      W.auditViewAdmin.open();
    });

    const footer = target.querySelector(".admin-footer, .card-footer");
    if (footer) footer.textContent = "클릭하여 감사 전용 교차 검색 화면을 엽니다.";
  }

  function patchAdminShowForLogAudit() {
    if (!W.admin || W.admin.__auditViewShowPatched) return;
    W.admin.__auditViewShowPatched = true;

    const prevShow = W.admin.show;
    W.admin.show = function (sectionId) {
      prevShow.call(this, sectionId);
      if (sectionId === "logAudit") {
        try { attachCardByTitleOnly(); } catch (e) {}
      }
    };
  }

  if (!tryRegister()) patchAdminShowForLogAudit();
})();
/* ---------------- Admin: 보안담당/감사자 전용 뷰 (auditView) end ---------------- */


/* =========================================================
 * 이상행위 탐지·리포트 > 이상행위 탐지 프리셋 (anomalyPreset)
 * - 프리셋(룰) 관리(생성/수정/삭제/활성화)
 * - 탐지 실행(샘플 이벤트 + 로컬스토리지 내 다른 로그 키 자동 스캔)
 * - 탐지 결과(알림) 생성/확인/ACK/종료/내보내기(JSON)
 * - 다른 카드 영향 방지: admin.current === 'anomalyReport' && 카드 타이틀 매칭일 때만 동작
 * ========================================================= */
(function () {
  const W = window;

  // 이미 설치되었으면 중복 설치 방지
  if (W.__dbamAnomalyPresetInstalled) return;
  W.__dbamAnomalyPresetInstalled = true;

  // toast 유틸(있으면 사용)
  function toast(msg) {
    if (typeof W.dbamToast === "function") return W.dbamToast(msg);
    alert(msg);
  }

  function esc(s) {
    const v = (s === null || s === undefined) ? "" : String(s);
    return v
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function pad2(n) { return String(n).padStart(2, "0"); }

  function nowLocalStr() {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  // "YYYY-MM-DD HH:mm:ss" / ISO / Date 모두 파싱
  function parseTime(v) {
    if (!v) return null;
    if (v instanceof Date) return isNaN(v.getTime()) ? null : v;
    const s = String(v).trim();
    // "YYYY-MM-DD HH:mm:ss" -> "YYYY-MM-DDTHH:mm:ss"
    const isoLike = s.includes("T") ? s : s.replace(" ", "T");
    const d = new Date(isoLike);
    return isNaN(d.getTime()) ? null : d;
  }

  function hourOf(d) { return d ? d.getHours() : -1; }
  function isWeekend(d) {
    if (!d) return false;
    const day = d.getDay(); // 0 Sun ~ 6 Sat
    return day === 0 || day === 6;
  }

  function withinHoursWrap(h, startH, endH) {
    // 예: 22~6 (wrap)
    if (startH === endH) return true; // 전 시간
    if (startH < endH) return (h >= startH && h < endH);
    return (h >= startH || h < endH);
  }

  // localStorage 전체 중 "dbam_" prefix를 훑어 logs/events/records 배열을 대충 이벤트로 정규화
  function collectExternalEvents(maxPerKey = 500) {
    const out = [];
    try {
      for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        if (!k || !k.startsWith("dbam_")) continue;

        let raw;
        try { raw = JSON.parse(localStorage.getItem(k)); } catch (_) { continue; }
        if (!raw || typeof raw !== "object") continue;

        // 흔한 배열 필드 후보
        const arr =
          (Array.isArray(raw.logs) && raw.logs) ||
          (Array.isArray(raw.events) && raw.events) ||
          (Array.isArray(raw.records) && raw.records) ||
          (Array.isArray(raw.items) && raw.items) ||
          null;

        if (!arr || !arr.length) continue;

        const slice = arr.slice(0, maxPerKey);
        slice.forEach((r) => {
          const t = parseTime(r.at || r.time || r.timestamp || r.createdAt || r.date || r.when);
          if (!t) return;

          const ev = {
            sourceKey: k,
            at: t,
            atStr: r.at || r.time || r.timestamp || r.createdAt || nowLocalStr(),
            env: r.env || r.environment || r.stage || "PRD",
            system: r.system || r.db || r.target || r.app || "",
            user: r.user || r.username || r.actor || r.requester || "",
            ip: r.ip || r.clientIp || "",
            action: r.action || r.event || r.type || r.kind || "",
            detail: r.detail || r.message || r.sql || r.query || "",
            sql: r.sql || r.query || "",
            rows: Number(r.rows || r.rowCount || r.exportRows || 0) || 0,
            bytes: Number(r.bytes || r.size || r.exportBytes || 0) || 0,
            raw: r
          };
          out.push(ev);
        });
      }
    } catch (_) {}
    return out;
  }

  // 기본(내장) 샘플 이벤트: 로그 기능이 아직 없어도 프리셋 동작 확인 가능
  function seedSampleEvents() {
    // “지금” 기준으로 상대시간 생성
    const base = new Date();
    function minusMin(min) {
      const d = new Date(base.getTime() - min * 60 * 1000);
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }

    return [
      // 로그인 실패 다발
      { at: minusMin(15), env: "PRD", system: "PORTAL", user: "kim.dev", ip: "10.10.1.23", action: "LOGIN_FAIL", detail: "비밀번호 오류" },
      { at: minusMin(14), env: "PRD", system: "PORTAL", user: "kim.dev", ip: "10.10.1.23", action: "LOGIN_FAIL", detail: "비밀번호 오류" },
      { at: minusMin(13), env: "PRD", system: "PORTAL", user: "kim.dev", ip: "10.10.1.23", action: "LOGIN_FAIL", detail: "비밀번호 오류" },
      { at: minusMin(12), env: "PRD", system: "PORTAL", user: "kim.dev", ip: "10.10.1.23", action: "LOGIN_FAIL", detail: "비밀번호 오류" },
      { at: minusMin(11), env: "PRD", system: "PORTAL", user: "kim.dev", ip: "10.10.1.23", action: "LOGIN_FAIL", detail: "비밀번호 오류" },

      // 대량 다운로드
      { at: minusMin(55), env: "PRD", system: "ORA-PROD", user: "park.dba", ip: "10.20.9.8", action: "DOWNLOAD", detail: "EXPORT users.csv", rows: 150000, bytes: 120 * 1024 * 1024 },

      // 위험 SQL
      { at: minusMin(70), env: "PRD", system: "CRM-PROD", user: "lee.sec", ip: "10.9.0.7", action: "SQL_EXEC", sql: "DELETE FROM customer;", detail: "DELETE without WHERE" },

      // 야간/휴일 접속 (실제 시간대에 따라 다르게 보일 수 있어도 룰은 동작)
      { at: "2025-12-15 02:33:10", env: "PRD", system: "APPDB", user: "unknown", ip: "172.16.2.44", action: "DB_LOGIN", detail: "night access" }
    ].map(x => ({
      sourceKey: "__seed__",
      at: parseTime(x.at),
      atStr: x.at,
      env: x.env,
      system: x.system,
      user: x.user,
      ip: x.ip,
      action: x.action,
      detail: x.detail || "",
      sql: x.sql || "",
      rows: Number(x.rows || 0) || 0,
      bytes: Number(x.bytes || 0) || 0,
      raw: x
    }));
  }

  // ---------------- store ----------------
  const STORE_KEY = "dbam_anomaly_preset_v1";

  function loadStore() {
    try {
      const raw = localStorage.getItem(STORE_KEY);
      if (raw) return JSON.parse(raw);
    } catch (_) {}
    return null;
  }

  function saveStore(st) {
    try { localStorage.setItem(STORE_KEY, JSON.stringify(st)); } catch (_) {}
  }

  function seedPresets() {
    return [
      {
        id: "P-LARGE-DL",
        name: "대량 다운로드 탐지",
        enabled: true,
        severity: "HIGH",
        type: "LARGE_DOWNLOAD",
        desc: "단건 다운로드가 행/용량 임계값을 초과하면 탐지",
        config: { minRows: 10000, minBytes: 50 * 1024 * 1024, env: "ALL" }
      },
      {
        id: "P-NIGHT-ACC",
        name: "야간/휴일 접속 탐지",
        enabled: true,
        severity: "MED",
        type: "NIGHT_ACCESS",
        desc: "야간 시간대 또는 주말 접속 이벤트 탐지",
        config: { startHour: 22, endHour: 6, includeWeekend: true, env: "PRD" }
      },
      {
        id: "P-REPEAT-FAIL",
        name: "반복 로그인 실패 탐지",
        enabled: true,
        severity: "MED",
        type: "REPEAT_LOGIN_FAIL",
        desc: "짧은 시간 내 로그인 실패 횟수 임계값 초과 탐지",
        config: { windowMin: 10, minCount: 5, env: "ALL" }
      },
      {
        id: "P-RISK-SQL",
        name: "위험 SQL 패턴 탐지",
        enabled: true,
        severity: "CRIT",
        type: "RISK_SQL",
        desc: "DROP/TRUNCATE 또는 WHERE 없는 UPDATE/DELETE 등 패턴 탐지",
        config: {
          env: "PRD",
          patterns: [
            "DROP\\s+TABLE",
            "TRUNCATE\\s+TABLE",
            "^\\s*DELETE\\s+FROM\\s+\\w+\\s*;?\\s*$",
            "^\\s*UPDATE\\s+\\w+\\s+SET\\s+.+;?\\s*$"
          ]
        }
      },
      {
        id: "P-MULTI-SYS",
        name: "단기간 다수 시스템 접근 탐지",
        enabled: false,
        severity: "LOW",
        type: "MULTI_SYSTEM_ACCESS",
        desc: "짧은 시간에 여러 시스템/DB로 이동 접근하는 패턴 탐지",
        config: { windowMin: 30, minSystems: 3, env: "ALL" }
      }
    ];
  }

  function ensureStore() {
    let st = loadStore();
    if (!st || typeof st !== "object") st = {};
    if (!Array.isArray(st.presets)) st.presets = seedPresets();
    if (!Array.isArray(st.alerts)) st.alerts = [];
    if (!Array.isArray(st.seedEvents)) st.seedEvents = seedSampleEvents().map(e => e.raw); // 저장은 raw 형태로
    if (typeof st.seq !== "number") st.seq = 1;
    if (!st.lastRunAt) st.lastRunAt = "";
    saveStore(st);
    return st;
  }

  function nextId(st, prefix) {
    st.seq = (typeof st.seq === "number" ? st.seq : 1) + 1;
    saveStore(st);
    const d = new Date();
    const ymd = `${d.getFullYear()}${pad2(d.getMonth() + 1)}${pad2(d.getDate())}`;
    return `${prefix}-${ymd}-${String(st.seq).padStart(4, "0")}`;
  }

  // ---------------- detection engine ----------------
  function buildEventPool() {
    const st = ensureStore();

    // seed events
    const seed = (st.seedEvents || []).map(r => ({
      sourceKey: "__seed__",
      at: parseTime(r.at || r.time || r.timestamp),
      atStr: r.at || "",
      env: r.env || "PRD",
      system: r.system || "",
      user: r.user || "",
      ip: r.ip || "",
      action: r.action || "",
      detail: r.detail || "",
      sql: r.sql || "",
      rows: Number(r.rows || 0) || 0,
      bytes: Number(r.bytes || 0) || 0,
      raw: r
    })).filter(e => e.at);

    // external events (best-effort)
    const ext = collectExternalEvents(600);

    // merge + sort desc
    const all = seed.concat(ext).filter(e => e && e.at);
    all.sort((a, b) => (b.at.getTime() - a.at.getTime()));
    return all;
  }

  function matchPreset(preset, events, filters) {
    const cfg = preset.config || {};
    const envFilter = (filters.env || "ALL");
    const from = filters.from ? parseTime(filters.from) : null;
    const to = filters.to ? parseTime(filters.to) : null;

    function envOk(ev) {
      const pEnv = cfg.env || "ALL";
      const okPreset = (pEnv === "ALL" || (ev.env || "") === pEnv);
      const okUserFilter = (envFilter === "ALL" || (ev.env || "") === envFilter);
      return okPreset && okUserFilter;
    }

    function timeOk(ev) {
      const t = ev.at;
      if (!t) return false;
      if (from && t < from) return false;
      if (to && t > to) return false;
      return true;
    }

    const pool = events.filter(ev => envOk(ev) && timeOk(ev));

    // 결과: alerts candidates
    const out = [];

    if (preset.type === "LARGE_DOWNLOAD") {
      const minRows = Number(cfg.minRows || 0) || 0;
      const minBytes = Number(cfg.minBytes || 0) || 0;

      pool.forEach(ev => {
        const isDl = String(ev.action || "").toUpperCase().includes("DOWNLOAD") || String(ev.detail || "").toUpperCase().includes("EXPORT");
        const hit = (ev.rows >= minRows && minRows > 0) || (ev.bytes >= minBytes && minBytes > 0);
        if (isDl && hit) {
          out.push({
            groupKey: `${ev.user}|${ev.system}|${ev.env}|DL`,
            when: ev.at,
            title: `대량 다운로드: ${ev.user || "(unknown)"} @ ${ev.system || "-"}`,
            summary: `rows=${ev.rows.toLocaleString()} / bytes=${Math.round(ev.bytes / (1024 * 1024))}MB`,
            samples: [ev]
          });
        }
      });
      return out;
    }

    if (preset.type === "NIGHT_ACCESS") {
      const startH = Number(cfg.startHour ?? 22);
      const endH = Number(cfg.endHour ?? 6);
      const includeWeekend = !!cfg.includeWeekend;

      pool.forEach(ev => {
        const h = hourOf(ev.at);
        const isNight = withinHoursWrap(h, startH, endH);
        const wk = includeWeekend && isWeekend(ev.at);
        if (isNight || wk) {
          out.push({
            groupKey: `${ev.user}|${ev.system}|${ev.env}|NIGHT`,
            when: ev.at,
            title: `야간/휴일 접근: ${ev.user || "(unknown)"} @ ${ev.system || "-"}`,
            summary: `${ev.atStr || nowLocalStr()} / ${ev.ip ? "ip=" + ev.ip : ""}`.trim(),
            samples: [ev]
          });
        }
      });
      return out;
    }

    if (preset.type === "REPEAT_LOGIN_FAIL") {
      const windowMin = Number(cfg.windowMin || 10) || 10;
      const minCount = Number(cfg.minCount || 5) || 5;

      // 실패 이벤트만
      const fails = pool.filter(ev => String(ev.action || "").toUpperCase().includes("LOGIN_FAIL") || String(ev.detail || "").toUpperCase().includes("FAIL"));
      // user+ip 단위로 시간순(desc)
      const byKey = {};
      fails.forEach(ev => {
        const k = `${ev.user || "unknown"}|${ev.ip || "-"}`;
        (byKey[k] = byKey[k] || []).push(ev);
      });

      Object.keys(byKey).forEach(k => {
        const list = byKey[k].slice().sort((a,b)=>a.at.getTime()-b.at.getTime()); // asc
        // sliding window
        let left = 0;
        for (let right = 0; right < list.length; right++) {
          while (left < right && (list[right].at.getTime() - list[left].at.getTime()) > windowMin * 60 * 1000) left++;
          const cnt = right - left + 1;
          if (cnt >= minCount) {
            const sample = list.slice(Math.max(left, right - 4), right + 1);
            out.push({
              groupKey: `${k}|FAIL|${windowMin}|${minCount}`,
              when: list[right].at,
              title: `반복 로그인 실패: ${k.split("|")[0]} (${cnt}회/${windowMin}분)`,
              summary: `ip=${k.split("|")[1]}`,
              samples: sample
            });
            break; // 동일 키는 1건만 생성
          }
        }
      });
      return out;
    }

    if (preset.type === "RISK_SQL") {
      const pats = Array.isArray(cfg.patterns) ? cfg.patterns : [];
      const regs = pats.map(p => {
        try { return new RegExp(p, "i"); } catch (_) { return null; }
      }).filter(Boolean);

      pool.forEach(ev => {
        const sql = (ev.sql || ev.detail || "").trim();
        if (!sql) return;
        const hit = regs.some(r => r.test(sql));
        if (hit) {
          out.push({
            groupKey: `${ev.user}|${ev.system}|${ev.env}|RISKSQL|${sql.slice(0,40)}`,
            when: ev.at,
            title: `위험 SQL: ${ev.user || "(unknown)"} @ ${ev.system || "-"}`,
            summary: sql.length > 120 ? (sql.slice(0, 120) + "...") : sql,
            samples: [ev]
          });
        }
      });
      return out;
    }

    if (preset.type === "MULTI_SYSTEM_ACCESS") {
      const windowMin = Number(cfg.windowMin || 30) || 30;
      const minSystems = Number(cfg.minSystems || 3) || 3;

      const byUser = {};
      pool.forEach(ev => {
        const u = ev.user || "unknown";
        (byUser[u] = byUser[u] || []).push(ev);
      });

      Object.keys(byUser).forEach(u => {
        const list = byUser[u].slice().sort((a,b)=>a.at.getTime()-b.at.getTime()); // asc
        let left = 0;
        for (let right = 0; right < list.length; right++) {
          while (left < right && (list[right].at.getTime() - list[left].at.getTime()) > windowMin * 60 * 1000) left++;
          const window = list.slice(left, right + 1);
          const systems = new Set(window.map(x => x.system || "").filter(Boolean));
          if (systems.size >= minSystems) {
            out.push({
              groupKey: `${u}|MULTI|${windowMin}|${minSystems}`,
              when: list[right].at,
              title: `다수 시스템 접근: ${u} (${systems.size}개/${windowMin}분)`,
              summary: Array.from(systems).slice(0, 6).join(", "),
              samples: window.slice(Math.max(0, window.length - 6))
            });
            break;
          }
        }
      });

      return out;
    }

    return out;
  }

  // ---------------- UI / Admin open ----------------
  const anomalyPresetAdmin = {
    state: {
      selectedPresetId: null,
      selectedAlertId: null,
      filters: {
        env: "ALL",
        range: "7D",     // 24H / 7D / 30D / ALL / CUSTOM
        from: "",
        to: ""
      }
    },

    open() {
      const titleEl = document.getElementById("adminTitle");
      const descEl  = document.getElementById("adminDesc");
      const bodyEl  = document.getElementById("adminBody");
      if (!titleEl || !descEl || !bodyEl) return;

      // nav active + current 보정
      try {
        if (W.admin) W.admin.current = "anomalyReport";
        document.querySelectorAll(".admin-nav button").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.section === "anomalyReport");
        });
      } catch (_) {}

      titleEl.innerHTML = '<i class="fa-solid fa-wave-square"></i> 이상행위 탐지 프리셋';
      descEl.textContent = "탐지 조건(프리셋)을 관리하고, 로그(샘플/저장 데이터)를 기반으로 이상행위를 탐지해 알림을 생성합니다.";

      bodyEl.innerHTML = this.getTemplateHtml();
      this.bindOnce();
      this.renderAll();
    },

    getTemplateHtml() {
      return `
        <div id="apPage" class="emg-page" style="display:flex;flex-direction:column;gap:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <div style="display:flex;gap:8px;align-items:center;">
              <button id="apBack" class="btn" type="button"><i class="fa-solid fa-arrow-left"></i></button>
              <div style="font-weight:900;">프리셋 관리 · 탐지 실행</div>
              <span class="badge" id="apLastRunBadge" style="margin-left:6px;">미실행</span>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
              <button id="apRun" class="btn primary" type="button"><i class="fa-solid fa-play"></i> 탐지 실행</button>
              <button id="apExportAlerts" class="btn" type="button"><i class="fa-solid fa-file-export"></i> 알림 내보내기</button>
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <div style="flex:1;min-width:420px;display:flex;flex-direction:column;gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div class="admin-header">
                  <h2><i class="fa-solid fa-sliders"></i> 프리셋 목록</h2>
                  <span class="badge" id="apPresetCount">0</span>
                </div>

                <div style="display:flex;gap:8px;justify-content:space-between;flex-wrap:wrap;margin-top:10px;">
                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button id="apNewPreset" class="btn" type="button"><i class="fa-solid fa-plus"></i> 프리셋 추가</button>
                    <button id="apEditPreset" class="btn" type="button"><i class="fa-solid fa-pen"></i> 수정</button>
                    <button id="apDeletePreset" class="btn" type="button"><i class="fa-solid fa-trash"></i> 삭제</button>
                  </div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                    <select id="apFilterEnv" class="input" style="min-width:120px;">
                      <option value="ALL">환경(전체)</option>
                      <option value="PRD">PRD</option>
                      <option value="STG">STG</option>
                      <option value="DEV">DEV</option>
                    </select>
                    <select id="apFilterRange" class="input" style="min-width:120px;">
                      <option value="24H">최근 24시간</option>
                      <option value="7D" selected>최근 7일</option>
                      <option value="30D">최근 30일</option>
                      <option value="ALL">전체</option>
                      <option value="CUSTOM">직접 지정</option>
                    </select>
                    <input id="apFilterFrom" class="input" style="min-width:190px;display:none;" placeholder="from (YYYY-MM-DD HH:mm:ss)" />
                    <input id="apFilterTo" class="input" style="min-width:190px;display:none;" placeholder="to (YYYY-MM-DD HH:mm:ss)" />
                  </div>
                </div>

                <div class="table-scroll-x scope-items-wrap" style="margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow:auto;padding-bottom:6px;max-height:420px;">
                  <table class="scope-items-table" style="width:100%;min-width:780px;border-collapse:collapse;table-layout:fixed;">
                    <colgroup>
                      <col style="width:80px;">
                      <col style="width:90px;">
                      <col style="width:220px;">
                      <col style="width:160px;">
                      <col style="width:230px;">
                    </colgroup>
                    <thead>
                      <tr style="background:#f9fafb;">
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">ON</th>
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">등급</th>
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">이름</th>
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">유형</th>
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">설명</th>
                      </tr>
                    </thead>
                    <tbody id="apPresetTbody"></tbody>
                  </table>
                </div>

                <div style="margin-top:10px;color:#6b7280;font-size:12px;">
                  ※ 탐지는 “샘플 이벤트 + localStorage 내 dbam_* 로그(있을 경우)”를 함께 사용합니다.
                </div>
              </div>
            </div>

            <div style="flex:1;min-width:420px;display:flex;flex-direction:column;gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div class="admin-header">
                  <h2><i class="fa-solid fa-bell"></i> 탐지 알림</h2>
                  <span class="badge" id="apAlertCount">0</span>
                </div>

                <div class="table-scroll-x scope-items-wrap" style="margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow:auto;padding-bottom:6px;max-height:260px;">
                  <table class="scope-items-table" style="width:100%;min-width:860px;border-collapse:collapse;table-layout:fixed;">
                    <colgroup>
                      <col style="width:150px;">
                      <col style="width:110px;">
                      <col style="width:220px;">
                      <col style="width:380px;">
                    </colgroup>
                    <thead>
                      <tr style="background:#f9fafb;">
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">시간</th>
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">상태</th>
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">프리셋</th>
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">내용</th>
                      </tr>
                    </thead>
                    <tbody id="apAlertTbody"></tbody>
                  </table>
                </div>

                <div id="apAlertDetail" style="margin-top:10px;">
                  <div style="color:#6b7280;font-size:13px;">알림을 선택하면 상세가 표시됩니다.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    },

    // 전용 모달
    _ensureModal() {
      let bd = document.getElementById("apModalBackdrop");
      if (bd) return bd;

      bd = document.createElement("div");
      bd.id = "apModalBackdrop";
      bd.className = "export-modal-backdrop";
      bd.innerHTML = `
        <div class="export-modal" style="max-width:900px;width:calc(100vw - 40px);">
          <div class="export-modal-header">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <h3 id="apModalTitle" style="margin:0;font-size:14px;"></h3>
              <button class="btn" id="apModalCloseBtn"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
          <div id="apModalBody" style="margin-top:10px;"></div>
          <div id="apModalFooter" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;"></div>
        </div>
      `;
      document.body.appendChild(bd);

      bd.addEventListener("click", (e) => { if (e.target === bd) bd.classList.remove("show"); });
      bd.querySelector("#apModalCloseBtn").addEventListener("click", () => bd.classList.remove("show"));
      return bd;
    },

    _openModal(titleHtml, bodyHtml, footerButtons) {
      const bd = this._ensureModal();
      bd.querySelector("#apModalTitle").innerHTML = titleHtml;
      bd.querySelector("#apModalBody").innerHTML = bodyHtml;

      const ft = bd.querySelector("#apModalFooter");
      ft.innerHTML = "";
      (footerButtons || []).forEach(btn => {
        const b = document.createElement("button");
        b.className = btn.className || "btn";
        b.innerHTML = btn.label;
        b.addEventListener("click", () => btn.onClick && btn.onClick());
        ft.appendChild(b);
      });

      bd.classList.add("show");
    },

    _closeModal() {
      document.getElementById("apModalBackdrop")?.classList.remove("show");
    },

    bindOnce() {
      const bodyEl = document.getElementById("adminBody");
      if (!bodyEl) return;
      if (bodyEl.dataset.apBound === "1") return;
      bodyEl.dataset.apBound = "1";

      // click delegation
      bodyEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        const presetRow = e.target.closest("tr[data-preset-id]");
        const alertRow  = e.target.closest("tr[data-alert-id]");

        if (presetRow) {
          this.state.selectedPresetId = presetRow.dataset.presetId || null;
          this.renderPresets();
          return;
        }
        if (alertRow) {
          this.state.selectedAlertId = alertRow.dataset.alertId || null;
          this.renderAlerts();
          this.renderAlertDetail();
          return;
        }
        if (!btn) return;

        if (btn.id === "apBack") {
          if (W.admin && typeof W.admin.show === "function") W.admin.show("anomalyReport");
          return;
        }
        if (btn.id === "apRun") { this.runDetection(); return; }
        if (btn.id === "apExportAlerts") { this.exportAlerts(); return; }
        if (btn.id === "apNewPreset") { this.openPresetModal("NEW"); return; }
        if (btn.id === "apEditPreset") { this.openPresetModal("EDIT"); return; }
        if (btn.id === "apDeletePreset") { this.deleteSelectedPreset(); return; }

        // preset toggle
        const pToggle = btn.dataset.presetToggle;
        if (pToggle) { this.togglePreset(pToggle); return; }

        // alert actions
        const act = btn.dataset.alertAction;
        const id  = btn.dataset.alertId;
        if (act && id) {
          if (act === "ack") this.setAlertStatus(id, "ACK");
          if (act === "close") this.setAlertStatus(id, "CLOSED");
          return;
        }
      });

      // filters
      bodyEl.addEventListener("change", (e) => {
        const t = e.target;
        if (!t) return;

        if (t.id === "apFilterEnv") this.state.filters.env = t.value;
        if (t.id === "apFilterRange") this.state.filters.range = t.value;

        // custom range input 토글
        this.applyRangeUi();
        this.renderAll();
      });

      bodyEl.addEventListener("input", (e) => {
        const t = e.target;
        if (!t) return;
        if (t.id === "apFilterFrom") this.state.filters.from = t.value || "";
        if (t.id === "apFilterTo") this.state.filters.to = t.value || "";
      });
    },

    applyRangeUi() {
      const range = this.state.filters.range;
      const fromEl = document.getElementById("apFilterFrom");
      const toEl   = document.getElementById("apFilterTo");
      if (!fromEl || !toEl) return;

      const show = (range === "CUSTOM");
      fromEl.style.display = show ? "" : "none";
      toEl.style.display   = show ? "" : "none";

      if (range !== "CUSTOM") {
        this.state.filters.from = "";
        this.state.filters.to = "";
        fromEl.value = "";
        toEl.value = "";
      }
    },

    _applyRangeToFilter() {
      const f = this.state.filters;
      const now = new Date();
      if (f.range === "ALL") return { from: null, to: null };

      if (f.range === "CUSTOM") {
        return {
          from: f.from ? parseTime(f.from) : null,
          to: f.to ? parseTime(f.to) : null
        };
      }

      let mins = 0;
      if (f.range === "24H") mins = 24 * 60;
      if (f.range === "7D")  mins = 7 * 24 * 60;
      if (f.range === "30D") mins = 30 * 24 * 60;

      const from = new Date(now.getTime() - mins * 60 * 1000);
      return { from, to: now };
    },

    renderAll() {
      ensureStore();
      this.applyRangeUi();
      this.renderLastRun();
      this.renderPresets();
      this.renderAlerts();
      this.renderAlertDetail();
    },

    renderLastRun() {
      const st = ensureStore();
      const b = document.getElementById("apLastRunBadge");
      if (!b) return;
      b.textContent = st.lastRunAt ? `최근 실행: ${st.lastRunAt}` : "미실행";
    },

    renderPresets() {
      const st = ensureStore();
      const tbody = document.getElementById("apPresetTbody");
      const cnt = document.getElementById("apPresetCount");
      if (!tbody || !cnt) return;

      const selected = this.state.selectedPresetId || (st.presets[0]?.id || null);
      this.state.selectedPresetId = selected;

      cnt.textContent = String(st.presets.length);

      tbody.innerHTML = st.presets.map(p => {
        const isSel = (p.id === selected);
        const trBg = isSel ? "background:#eef2ff;" : "";
        const on = p.enabled ? "ON" : "OFF";
        const sev = p.severity || "-";
        const typ = p.type || "-";

        return `
          <tr data-preset-id="${esc(p.id)}" style="border-bottom:1px solid #f3f4f6;cursor:pointer;${trBg}">
            <td style="padding:10px;">
              <button type="button" class="btn" data-preset-toggle="${esc(p.id)}" style="padding:6px 10px;">
                ${p.enabled ? '<i class="fa-solid fa-toggle-on"></i>' : '<i class="fa-solid fa-toggle-off"></i>'}
                ${esc(on)}
              </button>
            </td>
            <td style="padding:10px;font-weight:800;">${esc(sev)}</td>
            <td style="padding:10px;font-weight:900;">${esc(p.name)}</td>
            <td style="padding:10px;color:#374151;">${esc(typ)}</td>
            <td style="padding:10px;color:#475569;font-size:13px;">${esc(p.desc || "")}</td>
          </tr>
        `;
      }).join("");
    },

    _alertStatusBadge(st) {
      const map = {
        OPEN:   { bg:"#fff7ed", fg:"#9a3412", label:"OPEN" },
        ACK:    { bg:"#eff6ff", fg:"#1d4ed8", label:"ACK" },
        CLOSED: { bg:"#ecfdf5", fg:"#047857", label:"CLOSED" }
      };
      const c = map[st] || { bg:"#f3f4f6", fg:"#374151", label: (st || "-") };
      return `<span style="display:inline-block;padding:3px 8px;border-radius:999px;background:${c.bg};color:${c.fg};font-size:12px;font-weight:800;">${esc(c.label)}</span>`;
    },

    renderAlerts() {
      const st = ensureStore();
      const tbody = document.getElementById("apAlertTbody");
      const cnt = document.getElementById("apAlertCount");
      if (!tbody || !cnt) return;

      const list = (st.alerts || []).slice().sort((a,b) => (parseTime(b.when)?.getTime() || 0) - (parseTime(a.when)?.getTime() || 0));
      cnt.textContent = String(list.length);

      if (!this.state.selectedAlertId && list[0]) this.state.selectedAlertId = list[0].id;

      tbody.innerHTML = list.map(a => {
        const isSel = (a.id === this.state.selectedAlertId);
        const trBg = isSel ? "background:#eef2ff;" : "";
        return `
          <tr data-alert-id="${esc(a.id)}" style="border-bottom:1px solid #f3f4f6;cursor:pointer;${trBg}">
            <td style="padding:10px;font-weight:800;">${esc(a.when || "")}</td>
            <td style="padding:10px;">${this._alertStatusBadge(a.status || "OPEN")}</td>
            <td style="padding:10px;">
              <div style="font-weight:900;">${esc(a.presetName || a.presetId || "")}</div>
              <div style="color:#9ca3af;font-size:12px;">${esc(a.severity || "")}</div>
            </td>
            <td style="padding:10px;color:#111827;">
              <div style="font-weight:800;">${esc(a.title || "")}</div>
              <div style="color:#475569;font-size:13px;margin-top:2px;">${esc(a.summary || "")}</div>
            </td>
          </tr>
        `;
      }).join("");
    },

    renderAlertDetail() {
      const st = ensureStore();
      const box = document.getElementById("apAlertDetail");
      if (!box) return;

      const id = this.state.selectedAlertId;
      if (!id) {
        box.innerHTML = `<div style="color:#6b7280;font-size:13px;">알림을 선택하면 상세가 표시됩니다.</div>`;
        return;
      }
      const a = (st.alerts || []).find(x => x.id === id);
      if (!a) {
        this.state.selectedAlertId = null;
        box.innerHTML = `<div style="color:#6b7280;font-size:13px;">선택된 알림을 찾을 수 없습니다.</div>`;
        return;
      }

      const samples = Array.isArray(a.samples) ? a.samples : [];
      const sampleHtml = samples.length
        ? samples.slice(0, 8).map(ev => `
            <div style="padding:8px 10px;border:1px solid #eef2f7;border-radius:10px;">
              <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
                <div style="font-weight:900;">${esc(ev.action || "")} <span style="color:#9ca3af;font-weight:600;">· ${esc(ev.user || "")}</span></div>
                <div style="color:#6b7280;font-size:12px;">${esc(ev.atStr || "")}</div>
              </div>
              <div style="color:#475569;font-size:13px;margin-top:4px;white-space:pre-wrap;">${esc(ev.sql || ev.detail || "")}</div>
              ${(ev.rows || ev.bytes) ? `<div style="color:#9ca3af;font-size:12px;margin-top:4px;">rows=${Number(ev.rows||0).toLocaleString()} / bytes=${Math.round(Number(ev.bytes||0)/(1024*1024))}MB</div>` : ``}
              <div style="color:#9ca3af;font-size:12px;margin-top:4px;">env=${esc(ev.env||"")} · system=${esc(ev.system||"")} · ip=${esc(ev.ip||"")}</div>
            </div>
          `).join("")
        : `<div style="color:#6b7280;font-size:13px;">(샘플 이벤트 없음)</div>`;

      box.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
          <div style="font-weight:900;font-size:14px;">알림 상세</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn" type="button" data-alert-action="ack" data-alert-id="${esc(a.id)}"><i class="fa-solid fa-check"></i> ACK</button>
            <button class="btn primary" type="button" data-alert-action="close" data-alert-id="${esc(a.id)}"><i class="fa-solid fa-circle-xmark"></i> 종료</button>
          </div>
        </div>

        <div style="margin-top:10px;border:1px solid var(--line);border-radius:12px;padding:10px;">
          <div style="display:grid;grid-template-columns:120px 1fr;gap:6px 10px;font-size:13px;">
            <div style="color:#6b7280;">상태</div><div>${this._alertStatusBadge(a.status || "OPEN")}</div>
            <div style="color:#6b7280;">시간</div><div>${esc(a.when || "")}</div>
            <div style="color:#6b7280;">프리셋</div><div><b>${esc(a.presetName || a.presetId || "")}</b> <span style="color:#9ca3af;">(${esc(a.severity || "")})</span></div>
            <div style="color:#6b7280;">내용</div><div>${esc(a.title || "")}<div style="color:#475569;font-size:13px;margin-top:2px;">${esc(a.summary || "")}</div></div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div style="font-weight:900;font-size:14px;margin-bottom:8px;">근거 이벤트(샘플)</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            ${sampleHtml}
          </div>
        </div>
      `;
    },

    togglePreset(presetId) {
      const st = ensureStore();
      const p = st.presets.find(x => x.id === presetId);
      if (!p) return;
      p.enabled = !p.enabled;
      saveStore(st);
      this.renderPresets();
    },

    deleteSelectedPreset() {
      const st = ensureStore();
      const id = this.state.selectedPresetId;
      if (!id) return toast("선택된 프리셋이 없습니다.");
      const p = st.presets.find(x => x.id === id);
      if (!p) return toast("선택된 프리셋을 찾을 수 없습니다.");
      if (!confirm(`프리셋을 삭제할까요?\n- ${p.name}`)) return;

      st.presets = st.presets.filter(x => x.id !== id);
      // 연관 알림은 남겨둠(감사 목적) — 원하면 여기서 같이 제거 가능
      saveStore(st);

      this.state.selectedPresetId = st.presets[0]?.id || null;
      this.renderAll();
    },

    openPresetModal(mode) {
      const st = ensureStore();
      const isEdit = (mode === "EDIT");

      const p = isEdit
        ? st.presets.find(x => x.id === this.state.selectedPresetId)
        : null;

      if (isEdit && !p) return toast("수정할 프리셋을 선택하세요.");

      const seed = p ? JSON.parse(JSON.stringify(p)) : {
        id: "",
        name: "",
        enabled: true,
        severity: "MED",
        type: "LARGE_DOWNLOAD",
        desc: "",
        config: { minRows: 10000, minBytes: 50 * 1024 * 1024, env: "ALL" }
      };

      const typeOptions = [
        { v:"LARGE_DOWNLOAD", label:"대량 다운로드" },
        { v:"NIGHT_ACCESS", label:"야간/휴일 접근" },
        { v:"REPEAT_LOGIN_FAIL", label:"반복 로그인 실패" },
        { v:"RISK_SQL", label:"위험 SQL" },
        { v:"MULTI_SYSTEM_ACCESS", label:"다수 시스템 접근" }
      ];

      const bodyHtml = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div style="grid-column:1 / -1;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">이름</div>
            <input id="apEditName" class="export-input" value="${esc(seed.name)}" placeholder="예) 야간 접속 탐지" />
          </div>

          <div>
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">유형</div>
            <select id="apEditType" class="export-input">
              ${typeOptions.map(o => `<option value="${esc(o.v)}" ${seed.type===o.v?"selected":""}>${esc(o.label)}</option>`).join("")}
            </select>
          </div>

          <div>
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">등급</div>
            <select id="apEditSeverity" class="export-input">
              ${["LOW","MED","HIGH","CRIT"].map(s => `<option value="${s}" ${seed.severity===s?"selected":""}>${s}</option>`).join("")}
            </select>
          </div>

          <div style="grid-column:1 / -1;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">설명</div>
            <input id="apEditDesc" class="export-input" value="${esc(seed.desc)}" placeholder="룰 설명을 입력" />
          </div>

          <div style="grid-column:1 / -1;display:flex;gap:10px;align-items:center;">
            <label style="display:flex;gap:8px;align-items:center;">
              <input id="apEditEnabled" type="checkbox" ${seed.enabled ? "checked" : ""} />
              <span style="font-weight:700;">활성화</span>
            </label>
          </div>

          <div style="grid-column:1 / -1;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">환경(ALL/PRD/STG/DEV)</div>
            <input id="apEditEnv" class="export-input" value="${esc(seed.config?.env || "ALL")}" placeholder="ALL" />
          </div>

          <div style="grid-column:1 / -1;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px;">세부 설정(JSON)</div>
            <textarea id="apEditConfig" class="export-input" style="min-height:160px;">${esc(JSON.stringify(seed.config || {}, null, 2))}</textarea>
          </div>

          <div style="grid-column:1 / -1;color:#6b7280;font-size:12px;line-height:1.5;">
            ※ 유형별 권장 키 예시<br/>
            - LARGE_DOWNLOAD: {"minRows":10000,"minBytes":52428800,"env":"ALL"}<br/>
            - NIGHT_ACCESS: {"startHour":22,"endHour":6,"includeWeekend":true,"env":"PRD"}<br/>
            - REPEAT_LOGIN_FAIL: {"windowMin":10,"minCount":5,"env":"ALL"}<br/>
            - RISK_SQL: {"patterns":["DROP\\\\s+TABLE", "..."],"env":"PRD"}<br/>
            - MULTI_SYSTEM_ACCESS: {"windowMin":30,"minSystems":3,"env":"ALL"}
          </div>
        </div>
      `;

      this._openModal(
        isEdit ? `<i class="fa-solid fa-pen"></i> 프리셋 수정` : `<i class="fa-solid fa-plus"></i> 프리셋 추가`,
        bodyHtml,
        [
          { label:'<i class="fa-solid fa-xmark"></i> 취소', className:'btn', onClick: () => this._closeModal() },
          {
            label: isEdit ? '<i class="fa-solid fa-check"></i> 저장' : '<i class="fa-solid fa-check"></i> 생성',
            className:'btn primary',
            onClick: () => {
              const name = (document.getElementById("apEditName")?.value || "").trim();
              const type = document.getElementById("apEditType")?.value || "LARGE_DOWNLOAD";
              const severity = document.getElementById("apEditSeverity")?.value || "MED";
              const desc = (document.getElementById("apEditDesc")?.value || "").trim();
              const enabled = !!document.getElementById("apEditEnabled")?.checked;
              const env = (document.getElementById("apEditEnv")?.value || "ALL").trim() || "ALL";
              const cfgText = document.getElementById("apEditConfig")?.value || "{}";

              if (!name) return toast("이름을 입력하세요.");

              let cfg;
              try { cfg = JSON.parse(cfgText); }
              catch (e) { return toast("세부 설정(JSON) 형식이 올바르지 않습니다."); }

              cfg.env = env;

              if (isEdit) {
                p.name = name;
                p.type = type;
                p.severity = severity;
                p.desc = desc;
                p.enabled = enabled;
                p.config = cfg;
                saveStore(st);
                this._closeModal();
                this.renderAll();
                toast("저장했습니다.");
              } else {
                const newPreset = {
                  id: nextId(st, "P"),
                  name, type, severity, desc,
                  enabled,
                  config: cfg
                };
                st.presets.unshift(newPreset);
                saveStore(st);
                this.state.selectedPresetId = newPreset.id;
                this._closeModal();
                this.renderAll();
                toast("생성했습니다.");
              }
            }
          }
        ]
      );
    },

    runDetection() {
      const st = ensureStore();

      // range filter 계산
      const rng = this._applyRangeToFilter();
      const f = this.state.filters;
      const filterPack = {
        env: f.env || "ALL",
        from: rng.from ? nowLocalStrFromDate(rng.from) : (f.from || ""),
        to: rng.to ? nowLocalStrFromDate(rng.to) : (f.to || "")
      };

      // 이벤트 풀 생성
      const events = buildEventPool();

      // enabled presets
      const presets = (st.presets || []).filter(p => p && p.enabled);

      let newCount = 0;

      presets.forEach(p => {
        const hits = matchPreset(p, events, filterPack);

        hits.forEach(hit => {
          // dedup key: presetId + groupKey + yyyy-mm-dd
          const d = hit.when || new Date();
          const dayKey = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
          const dedupKey = `${p.id}|${hit.groupKey}|${dayKey}`;

          const exists = (st.alerts || []).some(a => a.dedupKey === dedupKey);
          if (exists) return;

          const alert = {
            id: nextId(st, "AL"),
            status: "OPEN",
            dedupKey,
            when: nowLocalStrFromDate(hit.when),
            presetId: p.id,
            presetName: p.name,
            severity: p.severity || "MED",
            title: hit.title || "",
            summary: hit.summary || "",
            samples: (hit.samples || []).map(ev => ({
              atStr: ev.atStr || "",
              env: ev.env || "",
              system: ev.system || "",
              user: ev.user || "",
              ip: ev.ip || "",
              action: ev.action || "",
              detail: ev.detail || "",
              sql: ev.sql || "",
              rows: Number(ev.rows || 0) || 0,
              bytes: Number(ev.bytes || 0) || 0,
              sourceKey: ev.sourceKey || ""
            }))
          };

          st.alerts.unshift(alert);
          newCount++;
        });
      });

      st.lastRunAt = nowLocalStr();
      saveStore(st);

      this.renderAll();
      toast(newCount ? `탐지 완료: 신규 알림 ${newCount}건` : "탐지 완료: 신규 알림 없음");
    },

    setAlertStatus(alertId, status) {
      const st = ensureStore();
      const a = (st.alerts || []).find(x => x.id === alertId);
      if (!a) return;
      a.status = status;
      a.statusAt = nowLocalStr();
      saveStore(st);
      this.renderAlerts();
      this.renderAlertDetail();
    },

    exportAlerts() {
      const st = ensureStore();
      const payload = {
        exportedAt: nowLocalStr(),
        alerts: st.alerts || []
      };
      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `dbam_anomaly_alerts_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }
  };

  function nowLocalStrFromDate(d) {
    if (!d) return "";
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  // 전역 노출
  W.anomalyPresetAdmin = anomalyPresetAdmin;

  // (선택) router 방식이 존재하면 등록 (있어도 다른 카드 영향 없음)
  try {
    if (W.admin && typeof W.admin.registerItemHandler === "function") {
      W.admin.registerItemHandler("anomalyPreset", () => anomalyPresetAdmin.open());
    }
  } catch (_) {}

  // 카드 클릭 진입(기존 방식과 통일: event delegation + 섹션 가드)
  document.addEventListener("click", (e) => {
    const card = e.target.closest?.("#adminBody .admin-card.admin-card-clickable");
    if (!card) return;

    // anomalyReport 섹션에서만 반응
    if (!W.admin || W.admin.current !== "anomalyReport") return;

    const title = (card.querySelector("h4")?.textContent || "").trim();
    if (!title.includes("이상행위 탐지 프리셋")) return;

    e.preventDefault();
    e.stopPropagation();
    anomalyPresetAdmin.open();
  }, true);

})();


/* =========================================================
 * 위험 쿼리 실행 세션 표시 (riskQueryFlag)
 * - localStorage 내 dbam_* 로그를 스캔해서 SQL 실행 이벤트를 모으고
 * - 사용자/시스템/IP/환경 기준으로 세션화(기본 15분 갭)
 * - 위험 쿼리 패턴 매칭(DELETE/UPDATE without WHERE 포함)
 * - 세션 상태(OPEN/ACK/CLOSED) + 메모 + 내보내기(JSON)
 * - 다른 카드 영향 방지: admin.current==='anomalyReport' && 카드 타이틀 매칭일 때만 open()
 * ========================================================= */
(function () {
  const W = window;
  if (W.__dbamRiskQueryFlagInstalled) return;
  W.__dbamRiskQueryFlagInstalled = true;

  const STORE_KEY = "dbam_riskQueryFlag_v1";

  function esc(s) {
    const v = (s === null || s === undefined) ? "" : String(s);
    return v.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
            .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function nowStr(){
    const d=new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  function parseTime(v){
    if(!v) return null;
    if(v instanceof Date) return isNaN(v.getTime())?null:v;
    const s=String(v).trim();
    const iso = s.includes("T") ? s : s.replace(" ","T");
    const d=new Date(iso);
    return isNaN(d.getTime())?null:d;
  }
  function toast(msg){
    if (typeof W.dbamToast === "function") return W.dbamToast(msg);
    alert(msg);
  }

  function loadStore(){
    try{
      const raw=localStorage.getItem(STORE_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return null;
  }
  function saveStore(st){
    try{ localStorage.setItem(STORE_KEY, JSON.stringify(st)); }catch(e){}
  }
  function ensureStore(){
    let st=loadStore();
    if(!st || typeof st!=="object") st={};
    if(typeof st.seq!=="number") st.seq=1;
    if(!Array.isArray(st.sessions)) st.sessions=[];
    if(!st.lastScanAt) st.lastScanAt="";
    saveStore(st);
    return st;
  }
  function nextId(st,prefix){
    st.seq=(typeof st.seq==="number"?st.seq:1)+1;
    saveStore(st);
    const d=new Date();
    const ymd=`${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}`;
    return `${prefix}-${ymd}-${String(st.seq).padStart(4,"0")}`;
  }

  // ---------------- SQL 이벤트 수집 ----------------
  function collectSqlEvents(maxPerKey=800){
    const out=[];
    const candidates=(obj)=>{
      if(!obj || typeof obj!=="object") return null;
      return (Array.isArray(obj.logs) && obj.logs) ||
             (Array.isArray(obj.events) && obj.events) ||
             (Array.isArray(obj.records) && obj.records) ||
             (Array.isArray(obj.items) && obj.items) || null;
    };

    try{
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(!k || !k.startsWith("dbam_")) continue;

        let raw;
        try{ raw=JSON.parse(localStorage.getItem(k)); }catch(e){ continue; }
        const arr=candidates(raw);
        if(!arr || !arr.length) continue;

        arr.slice(0,maxPerKey).forEach(r=>{
          const t=parseTime(r.at || r.time || r.timestamp || r.createdAt || r.when || r.date);
          if(!t) return;

          const sql = (r.sql || r.query || r.statement || r.execSql || r.text || "").toString();
          const detail = (r.detail || r.message || r.desc || "").toString();
          const action = (r.action || r.event || r.type || r.kind || "").toString();

          // SQL이 비어있어도 detail에 SQL이 들어오는 경우가 있음
          const sqlText = (sql && sql.trim()) ? sql.trim() : (looksLikeSql(detail) ? detail.trim() : "");
          if(!sqlText) return;

          out.push({
            sourceKey: k,
            at: t,
            atStr: r.at || r.time || r.timestamp || r.createdAt || nowStr(),
            env: r.env || r.environment || r.stage || "PRD",
            system: r.system || r.db || r.target || r.app || "",
            user: r.user || r.username || r.actor || r.requester || "",
            ip: r.ip || r.clientIp || r.remoteIp || "",
            action,
            sql: sqlText,
            raw: r
          });
        });
      }
    }catch(e){}
    return out;
  }

  function looksLikeSql(s){
    if(!s) return false;
    const t=String(s).trim().toUpperCase();
    return /^(SELECT|UPDATE|DELETE|INSERT|MERGE|DROP|TRUNCATE|ALTER|GRANT|REVOKE)\b/.test(t);
  }

  // ---------------- 위험 판정 ----------------
  function riskCheck(sql){
    const s=(sql||"").trim();
    const u=s.toUpperCase();

    const reasons=[];
    if(/\bDROP\s+TABLE\b/i.test(s)) reasons.push("DROP TABLE");
    if(/\bTRUNCATE\s+TABLE\b/i.test(s)) reasons.push("TRUNCATE TABLE");
    if(/\bALTER\s+USER\b/i.test(s) || /\bALTER\s+SYSTEM\b/i.test(s)) reasons.push("ALTER USER/SYSTEM");
    if(/\bGRANT\b/i.test(s) && /\bDBA\b/i.test(s)) reasons.push("GRANT DBA");

    // DELETE without WHERE (단순/보수적)
    if(/^\s*DELETE\s+FROM\s+\w+/i.test(s) && !/\bWHERE\b/i.test(u)) reasons.push("DELETE (no WHERE)");
    // UPDATE without WHERE
    if(/^\s*UPDATE\s+\w+\s+SET\s+/i.test(s) && !/\bWHERE\b/i.test(u)) reasons.push("UPDATE (no WHERE)");

    // 아주 거친 민감 테이블 키워드 예시(원하면 확장)
    if(/\b(CUSTOMER|USER|ACCOUNT|CARD|PAY|SSN|RRN)\b/i.test(u) && /^\s*SELECT\b/i.test(u)) {
      // 단, 이건 "위험"이라기보다 "주의"에 가까움 — 표시용
      reasons.push("SENSITIVE KEYWORD");
    }

    return { hit: reasons.length>0, reasons };
  }

  // ---------------- 세션화 ----------------
  function buildSessionsFromEvents(events, gapMin=15){
    // key: env|system|user|ip
    const byKey={};
    events.forEach(ev=>{
      const k=[ev.env||"", ev.system||"", ev.user||"", ev.ip||""].join("|");
      (byKey[k]=byKey[k]||[]).push(ev);
    });

    const sessions=[];
    Object.keys(byKey).forEach(k=>{
      const list=byKey[k].slice().sort((a,b)=>a.at.getTime()-b.at.getTime()); // asc
      let cur=null;

      list.forEach(ev=>{
        const rc=riskCheck(ev.sql);
        ev._riskHit=rc.hit;
        ev._riskReasons=rc.reasons;

        if(!cur){
          cur=newSession(k, ev);
          sessions.push(cur);
          return;
        }
        const gap=(ev.at.getTime()-cur._lastAt)/60000;
        if(gap>gapMin){
          cur=newSession(k, ev);
          sessions.push(cur);
          return;
        }
        // merge into current
        cur._lastAt=ev.at.getTime();
        cur.endAt=fmt(ev.at);
        cur.queryCount++;
        if(ev._riskHit) cur.riskCount++;
        cur.events.push(minifyEvent(ev));
      });
    });

    // 최신 세션이 위로
    sessions.sort((a,b)=>parseTime(b.endAt).getTime()-parseTime(a.endAt).getTime());
    return sessions;
  }

  function fmt(d){
    if(!d) return "";
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }

  function newSession(key, ev){
    const parts=key.split("|");
    const start=ev.at;
    const s={
      // id는 merge 단계에서 부여/재사용
      id:"",
      dedupKey:"",         // merge용
      status:"OPEN",
      note:"",
      env: parts[0]||"",
      system: parts[1]||"",
      user: parts[2]||"",
      ip: parts[3]||"",
      startAt: fmt(start),
      endAt: fmt(start),
      queryCount: 1,
      riskCount: ev._riskHit ? 1 : 0,
      events: [minifyEvent(ev)],
      _lastAt: ev.at.getTime()
    };
    // dedupKey: 동일 시작시각 기준(초까지)으로 고정
    s.dedupKey = [s.env,s.system,s.user,s.ip,s.startAt].join("|");
    return s;
  }

  function minifyEvent(ev){
    const rc = ev._riskReasons || [];
    return {
      at: ev.atStr || fmt(ev.at),
      env: ev.env || "",
      system: ev.system || "",
      user: ev.user || "",
      ip: ev.ip || "",
      action: ev.action || "",
      sql: ev.sql || "",
      risk: (ev._riskHit ? "Y" : "N"),
      reasons: rc.slice(0,6),
      sourceKey: ev.sourceKey || ""
    };
  }

  // store merge: 기존 세션 status/note 유지
  function mergeSessions(st, fresh){
    const prev = Array.isArray(st.sessions) ? st.sessions : [];
    const prevMap = {};
    prev.forEach(s=>{ if(s && s.dedupKey) prevMap[s.dedupKey]=s; });

    const merged = fresh.map(s=>{
      const old = prevMap[s.dedupKey];
      if(old){
        s.id = old.id || s.id;
        s.status = old.status || s.status;
        s.note = old.note || "";
      }
      if(!s.id) s.id = nextId(st, "RQS");
      return s;
    });

    st.sessions = merged;
    st.lastScanAt = nowStr();
    saveStore(st);
    return merged;
  }

  // ---------------- UI ----------------
  const riskQueryFlagAdmin = {
    state: {
      selectedId: null,
      filters: {
        env: "ALL",
        status: "ALL",
        onlyRisk: "Y",      // Y/N
        q: ""
      }
    },

    open(){
      const titleEl=document.getElementById("adminTitle");
      const descEl=document.getElementById("adminDesc");
      const bodyEl=document.getElementById("adminBody");
      if(!titleEl || !descEl || !bodyEl) return;

      try{
        if(W.admin) W.admin.current="anomalyReport";
        document.querySelectorAll(".admin-nav button").forEach(btn=>{
          btn.classList.toggle("active", btn.dataset.section==="anomalyReport");
        });
      }catch(e){}

      titleEl.innerHTML = '<i class="fa-solid fa-bolt"></i> 위험 쿼리 실행 세션 표시';
      descEl.textContent = "위험 SQL 실행을 세션 단위로 묶어 표시하고, 감사 처리(ACK/종료)와 메모 기록을 관리합니다.";

      bodyEl.innerHTML = this.getTemplateHtml();
      this.bindOnce();
      this.rescan(true);
      this.renderAll();
    },

    getTemplateHtml(){
      return `
        <div id="rqPage" class="emg-page" style="display:flex;flex-direction:column;gap:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
            <div style="display:flex;gap:8px;align-items:center;">
              <button id="rqBack" class="btn" type="button"><i class="fa-solid fa-arrow-left"></i></button>
              <div style="font-weight:900;">위험 쿼리 세션</div>
              <span class="badge" id="rqScanBadge">미스캔</span>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
              <button id="rqRescan" class="btn primary" type="button"><i class="fa-solid fa-rotate"></i> 세션 재스캔</button>
              <button id="rqExport" class="btn" type="button"><i class="fa-solid fa-file-export"></i> 내보내기</button>
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <div style="flex:1.1;min-width:460px;display:flex;flex-direction:column;gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div class="admin-header">
                  <h2><i class="fa-solid fa-layer-group"></i> 세션 목록</h2>
                  <span class="badge" id="rqCount">0</span>
                </div>

                <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:10px;">
                  <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <select id="rqFilterEnv" class="input" style="min-width:120px;">
                      <option value="ALL">환경(전체)</option>
                      <option value="PRD">PRD</option>
                      <option value="STG">STG</option>
                      <option value="DEV">DEV</option>
                    </select>
                    <select id="rqFilterStatus" class="input" style="min-width:120px;">
                      <option value="ALL">상태(전체)</option>
                      <option value="OPEN">OPEN</option>
                      <option value="ACK">ACK</option>
                      <option value="CLOSED">CLOSED</option>
                    </select>
                    <select id="rqOnlyRisk" class="input" style="min-width:140px;">
                      <option value="Y">위험 세션만</option>
                      <option value="N">전체 세션</option>
                    </select>
                  </div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                    <input id="rqFilterQ" class="input" style="min-width:260px;" placeholder="검색(사용자/시스템/IP)" />
                  </div>
                </div>

                <div class="table-scroll-x scope-items-wrap" style="margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow:auto;padding-bottom:6px;max-height:520px;">
                  <table class="scope-items-table" style="width:100%;min-width:980px;border-collapse:collapse;table-layout:fixed;">
                    <colgroup>
                      <col style="width:180px;">
                      <col style="width:110px;">
                      <col style="width:220px;">
                      <col style="width:260px;">
                      <col style="width:130px;">
                      <col style="width:80px;">
                    </colgroup>
                    <thead>
                      <tr style="background:#f9fafb;">
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">기간</th>
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">위험</th>
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">사용자/IP</th>
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">시스템/환경</th>
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">상태</th>
                        <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">쿼리</th>
                      </tr>
                    </thead>
                    <tbody id="rqTbody"></tbody>
                  </table>
                </div>

                <div style="margin-top:10px;color:#6b7280;font-size:12px;">
                  ※ 스캔 대상: localStorage 내 <b>dbam_*</b> 키의 logs/events/records/items 배열 중 SQL 형태로 파싱 가능한 항목
                </div>
              </div>
            </div>

            <div style="flex:1;min-width:420px;display:flex;flex-direction:column;gap:10px;">
              <div class="admin-card" style="padding:12px 14px;">
                <div class="admin-header">
                  <h2><i class="fa-solid fa-circle-info"></i> 세션 상세</h2>
                  <span class="badge" id="rqSel">미선택</span>
                </div>
                <div id="rqDetail" style="margin-top:10px;color:#111827;">
                  <div style="color:#6b7280;font-size:13px;">좌측에서 세션을 선택하세요.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    },

    _statusBadge(st){
      const map={
        OPEN:{bg:"#fff7ed",fg:"#9a3412"},
        ACK:{bg:"#eff6ff",fg:"#1d4ed8"},
        CLOSED:{bg:"#ecfdf5",fg:"#047857"}
      };
      const c=map[st]||{bg:"#f3f4f6",fg:"#374151"};
      return `<span style="display:inline-block;padding:3px 8px;border-radius:999px;background:${c.bg};color:${c.fg};font-size:12px;font-weight:800;">${esc(st||"-")}</span>`;
    },

    _riskBadge(riskCount, queryCount){
      const hit = (Number(riskCount||0) > 0);
      const bg = hit ? "#fef2f2" : "#f3f4f6";
      const fg = hit ? "#b91c1c" : "#374151";
      const txt = hit ? `RISK ${riskCount}/${queryCount}` : `0/${queryCount}`;
      return `<span style="display:inline-block;padding:3px 8px;border-radius:999px;background:${bg};color:${fg};font-size:12px;font-weight:900;">${esc(txt)}</span>`;
    },

    bindOnce(){
      const bodyEl=document.getElementById("adminBody");
      if(!bodyEl) return;
      if(bodyEl.dataset.rqBound==="1") return;
      bodyEl.dataset.rqBound="1";

      bodyEl.addEventListener("click",(e)=>{
        const btn=e.target.closest("button");
        const row=e.target.closest("tr[data-id]");

        if(row){
          this.state.selectedId=row.dataset.id||null;
          this.renderList();
          this.renderDetail();
          return;
        }
        if(!btn) return;

        if(btn.id==="rqBack"){
          if(W.admin && typeof W.admin.show==="function") W.admin.show("anomalyReport");
          return;
        }
        if(btn.id==="rqRescan"){ this.rescan(true); this.renderAll(); return; }
        if(btn.id==="rqExport"){ this.exportAll(); return; }

        const act=btn.dataset.action;
        const id=btn.dataset.id;
        if(act && id){
          if(act==="ack") this.setStatus(id,"ACK");
          if(act==="close") this.setStatus(id,"CLOSED");
          if(act==="open") this.setStatus(id,"OPEN");
          if(act==="note") this.openNoteModal(id);
        }
      });

      bodyEl.addEventListener("change",(e)=>{
        const t=e.target;
        if(!t) return;
        if(t.id==="rqFilterEnv") this.state.filters.env=t.value;
        if(t.id==="rqFilterStatus") this.state.filters.status=t.value;
        if(t.id==="rqOnlyRisk") this.state.filters.onlyRisk=t.value;
        this.renderAll();
      });

      bodyEl.addEventListener("input",(e)=>{
        const t=e.target;
        if(!t) return;
        if(t.id==="rqFilterQ"){
          this.state.filters.q=t.value||"";
          this.renderList();
          this.renderDetail();
        }
      });
    },

    rescan(showToast){
      const st=ensureStore();
      const events=collectSqlEvents(900);

      // 이벤트가 너무 비어있으면 최소 샘플 2개를 생성해서 화면이 비지 않게
      const fallback = events.length ? [] : [
        { sourceKey:"__seed__", at:parseTime("2025-12-15 02:33:10"), atStr:"2025-12-15 02:33:10", env:"PRD", system:"CRM-PROD", user:"lee.sec", ip:"10.9.0.7", action:"SQL_EXEC", sql:"DELETE FROM customer;" },
        { sourceKey:"__seed__", at:parseTime("2025-12-15 02:35:12"), atStr:"2025-12-15 02:35:12", env:"PRD", system:"CRM-PROD", user:"lee.sec", ip:"10.9.0.7", action:"SQL_EXEC", sql:"UPDATE user SET role='ADMIN';" }
      ].map(ev=>{
        ev._riskHit = riskCheck(ev.sql).hit;
        ev._riskReasons = riskCheck(ev.sql).reasons;
        return ev;
      });

      const allEvents = events.concat(fallback).filter(e=>e && e.at);

      // 세션 생성 + merge
      const fresh = buildSessionsFromEvents(allEvents, 15);
      const merged = mergeSessions(st, fresh);

      const badge=document.getElementById("rqScanBadge");
      if(badge) badge.textContent = `최근 스캔: ${st.lastScanAt}`;

      if(!this.state.selectedId && merged[0]) this.state.selectedId = merged[0].id;

      if(showToast) toast(`세션 스캔 완료: ${merged.length}건`);
    },

    _filtered(){
      const st=ensureStore();
      const { env, status, onlyRisk, q } = this.state.filters;
      const kw=(q||"").trim().toLowerCase();

      return (st.sessions||[]).filter(s=>{
        if(env!=="ALL" && (s.env||"")!==env) return false;
        if(status!=="ALL" && (s.status||"")!==status) return false;
        if(onlyRisk==="Y" && Number(s.riskCount||0)===0) return false;

        if(kw){
          const blob=[s.user,s.ip,s.system,s.env].join(" ").toLowerCase();
          if(!blob.includes(kw)) return false;
        }
        return true;
      });
    },

    renderAll(){
      const badge=document.getElementById("rqScanBadge");
      const st=ensureStore();
      if(badge) badge.textContent = st.lastScanAt ? `최근 스캔: ${st.lastScanAt}` : "미스캔";

      // 필터 UI 값 동기화
      const envEl=document.getElementById("rqFilterEnv");
      const stEl=document.getElementById("rqFilterStatus");
      const rEl=document.getElementById("rqOnlyRisk");
      const qEl=document.getElementById("rqFilterQ");
      if(envEl) envEl.value=this.state.filters.env;
      if(stEl) stEl.value=this.state.filters.status;
      if(rEl) rEl.value=this.state.filters.onlyRisk;
      if(qEl && qEl.value!==this.state.filters.q) qEl.value=this.state.filters.q;

      this.renderList();
      this.renderDetail();
    },

    renderList(){
      const tbody=document.getElementById("rqTbody");
      const cnt=document.getElementById("rqCount");
      if(!tbody || !cnt) return;

      const list=this._filtered();
      cnt.textContent = `${list.length}`;

      // 선택 유지
      if(this.state.selectedId && !list.some(x=>x.id===this.state.selectedId)){
        this.state.selectedId = list[0]?.id || null;
      }

      tbody.innerHTML = list.map(s=>{
        const isSel = (s.id===this.state.selectedId);
        const bg = isSel ? "background:#eef2ff;" : "";
        const period = `${esc(s.startAt||"")}<div style="color:#9ca3af;font-size:12px;">~ ${esc(s.endAt||"")}</div>`;
        const who = `<b>${esc(s.user||"(unknown)")}</b><div style="color:#9ca3af;font-size:12px;">${esc(s.ip||"-")}</div>`;
        const sys = `<b>${esc(s.system||"-")}</b><div style="color:#9ca3af;font-size:12px;">env=${esc(s.env||"")}</div>`;
        return `
          <tr data-id="${esc(s.id)}" style="border-bottom:1px solid #f3f4f6;cursor:pointer;${bg}">
            <td style="padding:10px;">${period}</td>
            <td style="padding:10px;">${this._riskBadge(s.riskCount,s.queryCount)}</td>
            <td style="padding:10px;">${who}</td>
            <td style="padding:10px;">${sys}</td>
            <td style="padding:10px;">${this._statusBadge(s.status||"OPEN")}</td>
            <td style="padding:10px;font-weight:900;">${Number(s.queryCount||0)}</td>
          </tr>
        `;
      }).join("");
    },

    renderDetail(){
      const sel=document.getElementById("rqSel");
      const box=document.getElementById("rqDetail");
      if(!box) return;

      const st=ensureStore();
      const id=this.state.selectedId;

      if(!id){
        if(sel) sel.textContent="미선택";
        box.innerHTML=`<div style="color:#6b7280;font-size:13px;">좌측에서 세션을 선택하세요.</div>`;
        return;
      }

      const s=(st.sessions||[]).find(x=>x.id===id);
      if(!s){
        this.state.selectedId=null;
        if(sel) sel.textContent="미선택";
        box.innerHTML=`<div style="color:#6b7280;font-size:13px;">선택된 세션을 찾을 수 없습니다.</div>`;
        return;
      }

      if(sel) sel.textContent=s.id;

      const actions = `
        <button class="btn" type="button" data-action="open" data-id="${esc(s.id)}"><i class="fa-solid fa-arrow-rotate-left"></i> OPEN</button>
        <button class="btn" type="button" data-action="ack" data-id="${esc(s.id)}"><i class="fa-solid fa-check"></i> ACK</button>
        <button class="btn primary" type="button" data-action="close" data-id="${esc(s.id)}"><i class="fa-solid fa-circle-xmark"></i> 종료</button>
        <button class="btn" type="button" data-action="note" data-id="${esc(s.id)}"><i class="fa-solid fa-pen"></i> 메모</button>
      `;

      const info = `
        <div style="display:grid;grid-template-columns:120px 1fr;gap:6px 10px;font-size:13px;">
          <div style="color:#6b7280;">상태</div><div>${this._statusBadge(s.status||"OPEN")}</div>
          <div style="color:#6b7280;">기간</div><div>${esc(s.startAt||"")} ~ ${esc(s.endAt||"")}</div>
          <div style="color:#6b7280;">사용자</div><div><b>${esc(s.user||"(unknown)")}</b> <span style="color:#9ca3af;">(${esc(s.ip||"-")})</span></div>
          <div style="color:#6b7280;">시스템</div><div><b>${esc(s.system||"-")}</b> <span style="color:#9ca3af;">env=${esc(s.env||"")}</span></div>
          <div style="color:#6b7280;">위험</div><div>${this._riskBadge(s.riskCount,s.queryCount)}</div>
          <div style="color:#6b7280;">메모</div><div>${s.note ? esc(s.note) : '<span style="color:#9ca3af;">(없음)</span>'}</div>
        </div>
      `;

      const events = Array.isArray(s.events)?s.events:[];
      const evHtml = events.slice(0, 80).map(ev=>{
        const risk = ev.risk==="Y";
        const badge = risk
          ? `<span style="display:inline-block;padding:2px 8px;border-radius:999px;background:#fef2f2;color:#b91c1c;font-size:12px;font-weight:900;">RISK</span>`
          : `<span style="display:inline-block;padding:2px 8px;border-radius:999px;background:#f3f4f6;color:#374151;font-size:12px;font-weight:800;">OK</span>`;
        const rs = (ev.reasons && ev.reasons.length) ? `<div style="color:#b91c1c;font-size:12px;margin-top:4px;">${esc(ev.reasons.join(", "))}</div>` : "";
        return `
          <div style="padding:10px;border:1px solid #eef2f7;border-radius:10px;${risk?'background:#fffafa;':''}">
            <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
              <div style="font-weight:900;">${badge} <span style="margin-left:6px;">${esc(ev.action||"SQL")}</span> <span style="color:#9ca3af;font-weight:600;">· ${esc(ev.at||"")}</span></div>
              <div style="color:#9ca3af;font-size:12px;">${esc(ev.sourceKey||"")}</div>
            </div>
            <div style="margin-top:6px;color:#111827;font-size:13px;white-space:pre-wrap;">${esc(ev.sql||"")}</div>
            ${rs}
            <div style="color:#9ca3af;font-size:12px;margin-top:6px;">env=${esc(ev.env||"")} · system=${esc(ev.system||"")} · user=${esc(ev.user||"")} · ip=${esc(ev.ip||"")}</div>
          </div>
        `;
      }).join("");

      box.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
          <div style="font-weight:900;font-size:14px;">세션 정보</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">${actions}</div>
        </div>

        <div style="margin-top:10px;border:1px solid var(--line);border-radius:12px;padding:10px;">
          ${info}
        </div>

        <div style="margin-top:12px;">
          <div style="font-weight:900;font-size:14px;margin-bottom:8px;">쿼리 이벤트</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            ${evHtml || '<div style="color:#6b7280;font-size:13px;">(이벤트 없음)</div>'}
          </div>
        </div>
      `;
    },

    setStatus(id, status){
      const st=ensureStore();
      const s=(st.sessions||[]).find(x=>x.id===id);
      if(!s) return;
      s.status=status;
      s.statusAt=nowStr();
      saveStore(st);
      this.renderList();
      this.renderDetail();
    },

    // 메모 모달
    _ensureModal(){
      let bd=document.getElementById("rqModalBackdrop");
      if(bd) return bd;

      bd=document.createElement("div");
      bd.id="rqModalBackdrop";
      bd.className="export-modal-backdrop";
      bd.innerHTML=`
        <div class="export-modal" style="max-width:820px;width:calc(100vw - 40px);">
          <div class="export-modal-header">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <h3 id="rqModalTitle" style="margin:0;font-size:14px;"></h3>
              <button class="btn" id="rqModalCloseBtn"><i class="fa-solid fa-xmark"></i></button>
            </div>
          </div>
          <div id="rqModalBody" style="margin-top:10px;"></div>
          <div id="rqModalFooter" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;"></div>
        </div>
      `;
      document.body.appendChild(bd);
      bd.addEventListener("click",(e)=>{ if(e.target===bd) bd.classList.remove("show"); });
      bd.querySelector("#rqModalCloseBtn").addEventListener("click",()=>bd.classList.remove("show"));
      return bd;
    },

    _openModal(titleHtml, bodyHtml, footerButtons){
      const bd=this._ensureModal();
      bd.querySelector("#rqModalTitle").innerHTML=titleHtml;
      bd.querySelector("#rqModalBody").innerHTML=bodyHtml;

      const ft=bd.querySelector("#rqModalFooter");
      ft.innerHTML="";
      (footerButtons||[]).forEach(btn=>{
        const b=document.createElement("button");
        b.className=btn.className||"btn";
        b.innerHTML=btn.label;
        b.addEventListener("click",()=>btn.onClick && btn.onClick());
        ft.appendChild(b);
      });

      bd.classList.add("show");
    },

    _closeModal(){
      document.getElementById("rqModalBackdrop")?.classList.remove("show");
    },

    openNoteModal(id){
      const st=ensureStore();
      const s=(st.sessions||[]).find(x=>x.id===id);
      if(!s) return;

      this._openModal(
        `<i class="fa-solid fa-pen"></i> 세션 메모`,
        `
          <div style="font-size:12px;color:#475569;margin-bottom:8px;">
            감사 메모 / 처리 내역 / 티켓 번호 등을 기록하세요.
          </div>
          <textarea id="rqNoteText" style="width:100%;min-height:140px;">${esc(s.note||"")}</textarea>
        `,
        [
          { label:'<i class="fa-solid fa-xmark"></i> 취소', className:'btn', onClick:()=>this._closeModal() },
          { label:'<i class="fa-solid fa-check"></i> 저장', className:'btn primary', onClick:()=>{
              const v=document.getElementById("rqNoteText")?.value || "";
              s.note=v.trim();
              s.noteAt=nowStr();
              saveStore(st);
              this._closeModal();
              this.renderDetail();
              this.renderList();
              toast("저장했습니다.");
          }}
        ]
      );
    },

    exportAll(){
      const st=ensureStore();
      const payload={
        exportedAt: nowStr(),
        sessions: st.sessions || []
      };
      const json=JSON.stringify(payload,null,2);
      const blob=new Blob([json],{type:"application/json;charset=utf-8"});
      const url=URL.createObjectURL(blob);

      const a=document.createElement("a");
      a.href=url;
      a.download=`risk_query_sessions_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url),1000);
    }
  };

  // 전역 노출
  W.riskQueryFlagAdmin = riskQueryFlagAdmin;

  // router 방식이 존재하면 등록(있어도 영향 없음)
  try{
    if(W.admin && typeof W.admin.registerItemHandler==="function"){
      W.admin.registerItemHandler("riskQueryFlag", ()=>riskQueryFlagAdmin.open());
    }
  }catch(e){}

  // 카드 클릭 진입(섹션 가드 + 제목 매칭)
  document.addEventListener("click",(e)=>{
    const card = e.target.closest?.("#adminBody .admin-card.admin-card-clickable");
    if(!card) return;
    if(!W.admin || W.admin.current!=="anomalyReport") return;

    const title=(card.querySelector("h4")?.textContent||"").trim();
    if(!title.includes("위험 쿼리 실행 세션 표시")) return;

    e.preventDefault();
    e.stopPropagation();
    riskQueryFlagAdmin.open();
  }, true);

})();


 /* =========================================================
  * 월간/분기별 DB 접근 리포트 (periodicReport)
  * - localStorage(dbam_*) 내 logs/events/records/items 배열을 스캔해 접근 이벤트 집계
  * - 월간/분기 선택 + 환경 필터 + 시스템/사용자 TOP
  * - 리포트 코멘트 저장/불러오기 + 내보내기(JSON)
  * - 다른 카드 영향 방지: admin.current==='anomalyReport' && 카드 타이틀 매칭일 때만 open()
  * ========================================================= */
 (function () {
   const W = window;
   if (W.__dbamPeriodicReportInstalled) return;
   W.__dbamPeriodicReportInstalled = true;

   const STORE_KEY = "dbam_periodicReport_v1";

   function esc(s) {
     const v = (s === null || s === undefined) ? "" : String(s);
     return v.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
             .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
   }
   function pad2(n){ return String(n).padStart(2,"0"); }
   function nowStr(){
     const d=new Date();
     return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
   }
   function parseTime(v){
     if(!v) return null;
     if(v instanceof Date) return isNaN(v.getTime()) ? null : v;
     const s=String(v).trim();
     const iso = s.includes("T") ? s : s.replace(" ","T");
     const d=new Date(iso);
     return isNaN(d.getTime()) ? null : d;
   }
   function toast(msg){
     if (typeof W.dbamToast === "function") return W.dbamToast(msg);
     alert(msg);
   }

   function loadStore(){
     try{ const raw=localStorage.getItem(STORE_KEY); if(raw) return JSON.parse(raw); }catch(e){}
     return null;
   }
   function saveStore(st){
     try{ localStorage.setItem(STORE_KEY, JSON.stringify(st)); }catch(e){}
   }
   function ensureStore(){
     let st=loadStore();
     if(!st || typeof st!=="object") st={};
     if(!st.comments || typeof st.comments!=="object") st.comments={};
     if(!st.lastScanAt) st.lastScanAt="";
     saveStore(st);
     return st;
   }

   function looksLikeSql(s){
     if(!s) return false;
     const t=String(s).trim().toUpperCase();
     return /^(SELECT|UPDATE|DELETE|INSERT|MERGE|DROP|TRUNCATE|ALTER|GRANT|REVOKE)\b/.test(t);
   }

   function riskCheck(sql){
     const s=(sql||"").trim();
     const u=s.toUpperCase();
     const reasons=[];
     if(/\bDROP\s+TABLE\b/i.test(s)) reasons.push("DROP TABLE");
     if(/\bTRUNCATE\s+TABLE\b/i.test(s)) reasons.push("TRUNCATE TABLE");
     if(/^\s*DELETE\s+FROM\s+\w+/i.test(s) && !/\bWHERE\b/i.test(u)) reasons.push("DELETE (no WHERE)");
     if(/^\s*UPDATE\s+\w+\s+SET\s+/i.test(s) && !/\bWHERE\b/i.test(u)) reasons.push("UPDATE (no WHERE)");
     return { hit: reasons.length>0, reasons };
   }

   function normalizeEnv(v){
     const s=(v||"").toString().toUpperCase();
     if(s.includes("PRD") || s.includes("PROD")) return "PRD";
     if(s.includes("STG") || s.includes("STAGE")) return "STG";
     if(s.includes("DEV")) return "DEV";
     return (s==="PRD"||s==="STG"||s==="DEV") ? s : "PRD";
   }

   function classifyType(action, sql){
     const a=(action||"").toString().toUpperCase();
     if(sql && looksLikeSql(sql)) return "SQL";
     if(a.includes("SQL")) return "SQL";
     if(a.includes("EXPORT") || a.includes("DOWNLOAD") || a.includes("반출") || a.includes("다운로드")) return "DOWNLOAD";
     if(a.includes("LOGIN") || a.includes("CONNECT") || a.includes("접속") || a.includes("AUTH")) return "CONNECT";
     return "OTHER";
   }

   function pickArray(obj){
     if(!obj || typeof obj!=="object") return null;
     return (Array.isArray(obj.logs) && obj.logs) ||
            (Array.isArray(obj.events) && obj.events) ||
            (Array.isArray(obj.records) && obj.records) ||
            (Array.isArray(obj.items) && obj.items) ||
            (Array.isArray(obj.rows) && obj.rows) || null;
   }

   // localStorage dbam_* 스캔 → 접근 이벤트 목록 생성
   function collectAccessEvents(maxPerKey=1200){
     const out=[];
     try{
       for(let i=0;i<localStorage.length;i++){
         const k=localStorage.key(i);
         if(!k || !k.startsWith("dbam_")) continue;
         if(k === STORE_KEY) continue;

         let raw;
         try{ raw = JSON.parse(localStorage.getItem(k)); }catch(e){ continue; }

         const arr = pickArray(raw);
         if(!arr || !arr.length) continue;

         arr.slice(0,maxPerKey).forEach(r=>{
           const t = parseTime(r.at || r.time || r.timestamp || r.createdAt || r.when || r.date);
           if(!t) return;

           const action = (r.action || r.event || r.type || r.kind || r.op || "").toString();
           const detail = (r.detail || r.message || r.desc || "").toString();
           const sql0 = (r.sql || r.query || r.statement || r.execSql || "").toString();
           const sql = (sql0 && sql0.trim()) ? sql0.trim() : (looksLikeSql(detail) ? detail.trim() : "");

           const env = normalizeEnv(r.env || r.environment || r.stage || "");
           const system = (r.system || r.db || r.target || r.app || r.instance || "").toString() || "UNKNOWN";
           const user = (r.user || r.username || r.actor || r.requester || r.owner || "").toString() || "UNKNOWN";
           const ip   = (r.ip || r.clientIp || r.remoteIp || r.sourceIp || "").toString() || "-";

           const type = classifyType(action, sql);
           const risk = (type==="SQL" && sql) ? riskCheck(sql) : { hit:false, reasons:[] };

           // 접근 이벤트로 보기 애매한 것들은 최소 기준(타입이 OTHER면 제외)
           if(type==="OTHER") return;

           out.push({
             at: t,
             atStr: r.at || r.time || r.timestamp || r.createdAt || nowStr(),
             env, system, user, ip,
             type,
             action: action || type,
             sql: sql || "",
             riskHit: !!risk.hit,
             riskReasons: risk.reasons.slice(0,6),
             sourceKey: k
           });
         });
       }
     }catch(e){}

     // 데이터가 비어있으면 고정 샘플(랜덤 없음)
     if(!out.length){
       const seed = [
         { at:"2025-10-03 09:12:10", env:"PRD", system:"CRM-PROD", user:"kim.dev", ip:"10.10.1.12", type:"CONNECT", action:"DB_CONNECT" },
         { at:"2025-10-03 09:13:00", env:"PRD", system:"CRM-PROD", user:"kim.dev", ip:"10.10.1.12", type:"SQL", action:"SQL_EXEC", sql:"SELECT * FROM customer WHERE id=1001;" },
         { at:"2025-10-15 02:11:30", env:"PRD", system:"DW-PROD", user:"batch", ip:"10.10.9.90", type:"SQL", action:"SQL_EXEC", sql:"UPDATE user SET role='ADMIN';" },
         { at:"2025-11-02 13:22:00", env:"STG", system:"PAY-STG", user:"lee.qa", ip:"10.20.1.7", type:"CONNECT", action:"LOGIN_SUCCESS" },
         { at:"2025-11-02 13:26:40", env:"STG", system:"PAY-STG", user:"lee.qa", ip:"10.20.1.7", type:"DOWNLOAD", action:"EXPORT_DOWNLOAD" },
         { at:"2025-12-08 01:05:10", env:"PRD", system:"ORA-PROD", user:"park.ops", ip:"10.30.2.4", type:"SQL", action:"SQL_EXEC", sql:"DELETE FROM orders;" },
         { at:"2025-12-08 01:08:55", env:"PRD", system:"ORA-PROD", user:"park.ops", ip:"10.30.2.4", type:"DOWNLOAD", action:"DOWNLOAD" }
       ].map(x=>{
         const t=parseTime(x.at);
         const risk = (x.type==="SQL" && x.sql) ? riskCheck(x.sql) : { hit:false, reasons:[] };
         return {
           at: t, atStr: x.at, env: x.env, system: x.system, user: x.user, ip: x.ip,
           type: x.type, action: x.action, sql: x.sql||"",
           riskHit: !!risk.hit, riskReasons: risk.reasons.slice(0,6),
           sourceKey: "__seed__"
         };
       });
       out.push(...seed);
     }

     // 최신 우선
     out.sort((a,b)=>b.at.getTime()-a.at.getTime());
     return out;
   }

   function periodRange(periodType, year, month, quarter){
     const y = Number(year);
     if(periodType==="M"){
       const m = Number(month); // 1..12
       const start = new Date(y, m-1, 1, 0,0,0);
       const end   = new Date(y, m,   1, 0,0,0);
       return { key:`${y}-${pad2(m)}`, label:`${y}년 ${pad2(m)}월`, start, end };
     }else{
       const q = Number(quarter); // 1..4
       const sm = (q-1)*3; // 0,3,6,9
       const start = new Date(y, sm, 1, 0,0,0);
       const end   = new Date(y, sm+3, 1, 0,0,0);
       return { key:`${y}-Q${q}`, label:`${y}년 Q${q}`, start, end };
     }
   }

   function aggReport(events, range, envFilter){
     const startT = range.start.getTime();
     const endT   = range.end.getTime();

     const inRange = events.filter(e=>{
       const t=e.at.getTime();
       if(t<startT || t>=endT) return false;
       if(envFilter!=="ALL" && e.env!==envFilter) return false;
       return true;
     });

     const total = inRange.length;
     const byType = { CONNECT:0, SQL:0, DOWNLOAD:0 };
     const uniqUsers=new Set(), uniqSystems=new Set(), uniqIps=new Set();
     let riskSql = 0;

     const sysMap = {};  // system -> stats
     const userMap = {}; // user -> stats

     inRange.forEach(e=>{
       if(byType[e.type]!==undefined) byType[e.type]++;

       uniqUsers.add(e.user||"UNKNOWN");
       uniqSystems.add(e.system||"UNKNOWN");
       uniqIps.add(e.ip||"-");

       const sys = e.system||"UNKNOWN";
       const usr = e.user||"UNKNOWN";

       sysMap[sys] = sysMap[sys] || { system:sys, env:e.env, total:0, connect:0, sql:0, download:0, riskSql:0, topUsers:{} };
       userMap[usr]= userMap[usr]|| { user:usr, total:0, connect:0, sql:0, download:0, riskSql:0, topSystems:{} };

       sysMap[sys].total++;
       userMap[usr].total++;

       if(e.type==="CONNECT"){ sysMap[sys].connect++; userMap[usr].connect++; }
       if(e.type==="SQL"){
         sysMap[sys].sql++; userMap[usr].sql++;
         if(e.riskHit){ sysMap[sys].riskSql++; userMap[usr].riskSql++; riskSql++; }
       }
       if(e.type==="DOWNLOAD"){ sysMap[sys].download++; userMap[usr].download++; }

       sysMap[sys].topUsers[usr] = (sysMap[sys].topUsers[usr]||0)+1;
       userMap[usr].topSystems[sys] = (userMap[usr].topSystems[sys]||0)+1;
     });

     const systems = Object.values(sysMap).sort((a,b)=>b.total-a.total);
     const users   = Object.values(userMap).sort((a,b)=>b.total-a.total);

     function topKV(map, n){
       const arr=Object.keys(map||{}).map(k=>({k, v:map[k]})).sort((a,b)=>b.v-a.v);
       return arr.slice(0,n);
     }

     // top 부가정보 붙이기
     systems.forEach(s=>{
       const t = topKV(s.topUsers, 3);
       s.topUsersText = t.map(x=>`${x.k}(${x.v})`).join(", ");
     });
     users.forEach(u=>{
       const t = topKV(u.topSystems, 3);
       u.topSystemsText = t.map(x=>`${x.k}(${x.v})`).join(", ");
     });

     return {
       periodKey: range.key,
       periodLabel: range.label,
       env: envFilter,
       range: { start: range.start.toISOString(), end: range.end.toISOString() },
       totals: {
         events: total,
         connect: byType.CONNECT,
         sql: byType.SQL,
         download: byType.DOWNLOAD,
         riskSql,
         uniqUsers: uniqUsers.size,
         uniqSystems: uniqSystems.size,
         uniqIps: uniqIps.size
       },
       systems,
       users,
       sample: inRange.slice(0, 30) // 최신 30건(표시/내보내기 참고용)
     };
   }

   function badge(txt, bg, fg){
     return `<span style="display:inline-block;padding:3px 8px;border-radius:999px;background:${bg};color:${fg};font-size:12px;font-weight:900;">${esc(txt)}</span>`;
   }

   const periodicReportAdmin = {
     state: {
       periodType: "M",   // M / Q
       env: "ALL",
       year: String(new Date().getFullYear()),
       month: String(new Date().getMonth()+1),
       quarter: String(Math.floor(new Date().getMonth()/3)+1),
       selectedTab: "system", // system/user
       report: null,
       selectedRowKey: null
     },
     _events: [],

     open(){
       const titleEl=document.getElementById("adminTitle");
       const descEl=document.getElementById("adminDesc");
       const bodyEl=document.getElementById("adminBody");
       if(!titleEl || !descEl || !bodyEl) return;

       try{
         if(W.admin) W.admin.current="anomalyReport";
         document.querySelectorAll(".admin-nav button").forEach(btn=>{
           btn.classList.toggle("active", btn.dataset.section==="anomalyReport");
         });
       }catch(e){}

       titleEl.innerHTML = '<i class="fa-solid fa-chart-column"></i> 월간/분기별 DB 접근 리포트';
       descEl.textContent = "기간별 DB 접속/SQL/다운로드 로그를 요약하고 점검 코멘트를 저장합니다.";

       bodyEl.innerHTML = this.getTemplateHtml();
       this.bindOnce();
       this.rescan(false);
       this.generate(false);
       this.renderAll();
     },

     getTemplateHtml(){
       return `
         <div id="prPage" class="emg-page" style="display:flex;flex-direction:column;gap:10px;">
           <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
             <div style="display:flex;gap:8px;align-items:center;">
               <button id="prBack" class="btn" type="button"><i class="fa-solid fa-arrow-left"></i></button>
               <div style="font-weight:900;">리포트 생성</div>
               <span class="badge" id="prScanBadge">미스캔</span>
             </div>
             <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
               <button id="prRescan" class="btn" type="button"><i class="fa-solid fa-rotate"></i> 로그 재스캔</button>
               <button id="prExport" class="btn" type="button"><i class="fa-solid fa-file-export"></i> 리포트 내보내기</button>
             </div>
           </div>

           <div class="admin-card" style="padding:12px 14px;">
             <div class="admin-header">
               <h2><i class="fa-solid fa-sliders"></i> 조건</h2>
               <span class="badge" id="prPeriodBadge">-</span>
             </div>

             <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:10px;">
               <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                 <select id="prPeriodType" class="input" style="min-width:140px;">
                   <option value="M">월간</option>
                   <option value="Q">분기</option>
                 </select>

                 <select id="prEnv" class="input" style="min-width:120px;">
                   <option value="ALL">환경(전체)</option>
                   <option value="PRD">PRD</option>
                   <option value="STG">STG</option>
                   <option value="DEV">DEV</option>
                 </select>

                 <select id="prYear" class="input" style="min-width:110px;"></select>

                 <select id="prMonth" class="input" style="min-width:110px;"></select>
                 <select id="prQuarter" class="input" style="min-width:110px;"></select>

                 <button id="prGenerate" class="btn primary" type="button"><i class="fa-solid fa-wand-magic-sparkles"></i> 생성</button>
               </div>

               <div style="font-size:12px;color:var(--muted);">
                 ※ 스캔 대상: localStorage 내 <b>dbam_*</b> 키의 logs/events/records/items 배열 (CONNECT/SQL/DOWNLOAD만 집계)
               </div>
             </div>
           </div>

           <div style="display:flex;gap:10px;flex-wrap:wrap;">
             <div style="flex:1.15;min-width:520px;display:flex;flex-direction:column;gap:10px;">
               <div class="admin-card" style="padding:12px 14px;">
                 <div class="admin-header">
                   <h2><i class="fa-solid fa-gauge-high"></i> 요약</h2>
                   <span class="badge" id="prSummaryBadge">-</span>
                 </div>

                 <div id="prSummary" style="margin-top:10px;"></div>

                 <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
                   <button class="btn" id="prTabSystem" type="button"><i class="fa-solid fa-server"></i> 시스템</button>
                   <button class="btn" id="prTabUser" type="button"><i class="fa-solid fa-user"></i> 사용자</button>
                 </div>

                 <div class="table-scroll-x scope-items-wrap" style="margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow:auto;padding-bottom:6px;max-height:520px;">
                   <table class="scope-items-table" style="width:100%;min-width:980px;border-collapse:collapse;table-layout:fixed;">
                     <colgroup>
                       <col style="width:260px;">
                       <col style="width:100px;">
                       <col style="width:100px;">
                       <col style="width:110px;">
                       <col style="width:110px;">
                       <col style="width:260px;">
                     </colgroup>
                     <thead>
                       <tr style="background:#f9fafb;">
                         <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;" id="prCol0">시스템/사용자</th>
                         <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">총</th>
                         <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">접속</th>
                         <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">SQL</th>
                         <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">다운로드</th>
                         <th style="text-align:left;padding:8px 10px;font-size:12px;color:#6b7280;">TOP 상대</th>
                       </tr>
                     </thead>
                     <tbody id="prTbody"></tbody>
                   </table>
                 </div>
               </div>
             </div>

             <div style="flex:1;min-width:420px;display:flex;flex-direction:column;gap:10px;">
               <div class="admin-card" style="padding:12px 14px;">
                 <div class="admin-header">
                   <h2><i class="fa-solid fa-comment-dots"></i> 점검 코멘트</h2>
                   <span class="badge" id="prCommentBadge">-</span>
                 </div>

                 <div style="margin-top:10px;">
                   <div style="font-size:12px;color:#6b7280;margin-bottom:6px;">점검 결과/조치 내역</div>
                   <textarea id="prCommentText" class="export-input" style="min-height:140px;" placeholder="예) 야간 접속 2건(운영 배치) 확인, 위험 SQL 1건(DELETE no WHERE) 사후 조치 완료"></textarea>

                   <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap;">
                     <button id="prCommentLoad" class="btn" type="button"><i class="fa-solid fa-download"></i> 불러오기</button>
                     <button id="prCommentSave" class="btn primary" type="button"><i class="fa-solid fa-floppy-disk"></i> 저장</button>
                   </div>

                   <div id="prCommentMeta" style="margin-top:8px;color:#9ca3af;font-size:12px;"></div>
                 </div>
               </div>

               <div class="admin-card" style="padding:12px 14px;">
                 <div class="admin-header">
                   <h2><i class="fa-solid fa-magnifying-glass"></i> 샘플 이벤트(최신)</h2>
                   <span class="badge" id="prSampleBadge">0</span>
                 </div>

                 <div id="prSample" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;"></div>
               </div>
             </div>
           </div>
         </div>
       `;
     },

     bindOnce(){
       const bodyEl=document.getElementById("adminBody");
       if(!bodyEl) return;
       if(bodyEl.dataset.prBound==="1") return;
       bodyEl.dataset.prBound="1";

       bodyEl.addEventListener("click",(e)=>{
         const btn=e.target.closest("button");
         const row=e.target.closest("tr[data-key]");
         if(row){
           this.state.selectedRowKey = row.dataset.key || null;
           this.renderTable(); // 선택 강조
           return;
         }
         if(!btn) return;

         if(btn.id==="prBack"){
           if(W.admin && typeof W.admin.show==="function") W.admin.show("anomalyReport");
           return;
         }
         if(btn.id==="prRescan"){
           this.rescan(true);
           this.generate(false);
           this.renderAll();
           return;
         }
         if(btn.id==="prGenerate"){
           this.generate(true);
           this.renderAll();
           return;
         }
         if(btn.id==="prExport"){
           this.exportReport();
           return;
         }
         if(btn.id==="prTabSystem"){
           this.state.selectedTab="system";
           this.state.selectedRowKey=null;
           this.renderAll();
           return;
         }
         if(btn.id==="prTabUser"){
           this.state.selectedTab="user";
           this.state.selectedRowKey=null;
           this.renderAll();
           return;
         }
         if(btn.id==="prCommentSave"){
           this.saveComment();
           return;
         }
         if(btn.id==="prCommentLoad"){
           this.loadCommentToUI(true);
           return;
         }
       });

       bodyEl.addEventListener("change",(e)=>{
         const t=e.target;
         if(!t) return;
         if(t.id==="prPeriodType"){
           this.state.periodType=t.value;
           this.renderPeriodSelectors();
           return;
         }
         if(t.id==="prEnv") this.state.env=t.value;
         if(t.id==="prYear") this.state.year=t.value;
         if(t.id==="prMonth") this.state.month=t.value;
         if(t.id==="prQuarter") this.state.quarter=t.value;

         this.generate(false);
         this.renderAll();
       });
     },

     rescan(showToastMsg){
       const st=ensureStore();
       this._events = collectAccessEvents(1400);
       st.lastScanAt = nowStr();
       saveStore(st);

       const badge=document.getElementById("prScanBadge");
       if(badge) badge.textContent = `최근 스캔: ${st.lastScanAt}`;

       if(showToastMsg) toast(`로그 스캔 완료: ${this._events.length}건`);
     },

     generate(showToastMsg){
       if(!this._events || !this._events.length) this.rescan(false);

       const y = this.state.year;
       const m = this.state.month;
       const q = this.state.quarter;
       const pt = this.state.periodType;
       const env = this.state.env;

       const rng = periodRange(pt, y, m, q);
       const rep = aggReport(this._events, rng, env);

       this.state.report = rep;

       if(showToastMsg) toast(`리포트 생성: ${rep.periodLabel} / ${env==="ALL"?"전체":env}`);
     },

     renderAll(){
       const st=ensureStore();

       // 스캔 뱃지
       const scan=document.getElementById("prScanBadge");
       if(scan) scan.textContent = st.lastScanAt ? `최근 스캔: ${st.lastScanAt}` : "미스캔";

       // 셀렉터 옵션 렌더
       this.renderYearOptions();
       this.renderPeriodSelectors();

       // UI 값 동기화
       const ptEl=document.getElementById("prPeriodType");
       const envEl=document.getElementById("prEnv");
       const yEl=document.getElementById("prYear");
       const mEl=document.getElementById("prMonth");
       const qEl=document.getElementById("prQuarter");

       if(ptEl) ptEl.value=this.state.periodType;
       if(envEl) envEl.value=this.state.env;
       if(yEl) yEl.value=this.state.year;
       if(mEl) mEl.value=this.state.month;
       if(qEl) qEl.value=this.state.quarter;

       // 탭 버튼 강조
       const ts=document.getElementById("prTabSystem");
       const tu=document.getElementById("prTabUser");
       if(ts) ts.classList.toggle("primary", this.state.selectedTab==="system");
       if(tu) tu.classList.toggle("primary", this.state.selectedTab==="user");

       // period badge
       const pb=document.getElementById("prPeriodBadge");
       if(pb && this.state.report) pb.textContent = `${this.state.report.periodLabel} / ${this.state.report.env==="ALL"?"전체":this.state.report.env}`;

       this.renderSummary();
       this.renderTable();
       this.loadCommentToUI(false);
       this.renderSample();
     },

     renderYearOptions(){
       const yEl=document.getElementById("prYear");
       if(!yEl) return;

       const cur = new Date().getFullYear();
       const years = [cur-2, cur-1, cur].map(String);

       yEl.innerHTML = years.map(y=>`<option value="${esc(y)}">${esc(y)}년</option>`).join("");
       if(!years.includes(this.state.year)) this.state.year = String(cur);
     },

     renderPeriodSelectors(){
       const mEl=document.getElementById("prMonth");
       const qEl=document.getElementById("prQuarter");
       if(!mEl || !qEl) return;

       // 월 옵션
       mEl.innerHTML = Array.from({length:12}).map((_,i)=>{
         const mm=String(i+1);
         return `<option value="${esc(mm)}">${esc(pad2(i+1))}월</option>`;
       }).join("");

       // 분기 옵션
       qEl.innerHTML = ["1","2","3","4"].map(q=>`<option value="${esc(q)}">Q${esc(q)}</option>`).join("");

       // 표시/숨김
       const isM = this.state.periodType==="M";
       mEl.style.display = isM ? "" : "none";
       qEl.style.display = isM ? "none" : "";

       // 값 정리
       if(!(Number(this.state.month)>=1 && Number(this.state.month)<=12)) this.state.month = String(new Date().getMonth()+1);
       if(!(Number(this.state.quarter)>=1 && Number(this.state.quarter)<=4)) this.state.quarter = String(Math.floor(new Date().getMonth()/3)+1);
     },

     renderSummary(){
       const rep=this.state.report;
       const sumEl=document.getElementById("prSummary");
       const sb=document.getElementById("prSummaryBadge");
       if(!sumEl || !sb) return;

       if(!rep){
         sb.textContent="-";
         sumEl.innerHTML=`<div style="color:#6b7280;font-size:13px;">리포트가 없습니다.</div>`;
         return;
       }

       const t=rep.totals;
       sb.textContent = `${t.events}건`;

       const chips = [
         badge(`접속 ${t.connect}`, "#eff6ff", "#1d4ed8"),
         badge(`SQL ${t.sql}`, "#f0f9ff", "#0369a1"),
         badge(`다운로드 ${t.download}`, "#ecfdf5", "#047857"),
         badge(`위험SQL ${t.riskSql}`, "#fef2f2", "#b91c1c"),
         badge(`사용자 ${t.uniqUsers}`, "#f3f4f6", "#374151"),
         badge(`시스템 ${t.uniqSystems}`, "#f3f4f6", "#374151"),
         badge(`IP ${t.uniqIps}`, "#f3f4f6", "#374151")
       ].join(" ");

       sumEl.innerHTML = `
         <div style="display:flex;gap:8px;flex-wrap:wrap;">
           ${chips}
         </div>
       `;
     },

     renderTable(){
       const rep=this.state.report;
       const tbody=document.getElementById("prTbody");
       const col0=document.getElementById("prCol0");
       if(!tbody || !col0) return;

       if(!rep){
         tbody.innerHTML="";
         return;
       }

       const isSystem = this.state.selectedTab==="system";
       col0.textContent = isSystem ? "시스템" : "사용자";

       const rows = (isSystem ? rep.systems : rep.users).slice(0, 60);
       tbody.innerHTML = rows.map(r=>{
         const key = isSystem ? r.system : r.user;
         const isSel = (this.state.selectedRowKey === key);
         const bg = isSel ? "background:#eef2ff;" : "";

         const topText = isSystem ? (r.topUsersText||"") : (r.topSystemsText||"");
         const riskTxt = r.riskSql ? ` · 위험SQL ${r.riskSql}` : "";
         const name = `<b>${esc(key)}</b><div style="color:#9ca3af;font-size:12px;">${isSystem ? `env=${esc(r.env||"")}` : ""}${esc(riskTxt)}</div>`;

         return `
           <tr data-key="${esc(key)}" style="border-bottom:1px solid #f3f4f6;cursor:pointer;${bg}">
             <td style="padding:10px;">${name}</td>
             <td style="padding:10px;font-weight:900;">${esc(r.total)}</td>
             <td style="padding:10px;">${esc(r.connect)}</td>
             <td style="padding:10px;">${esc(r.sql)}</td>
             <td style="padding:10px;">${esc(r.download)}</td>
             <td style="padding:10px;color:#475569;">${esc(topText || "-")}</td>
           </tr>
         `;
       }).join("");
     },

     loadCommentToUI(showToastMsg){
       const rep=this.state.report;
       const txt=document.getElementById("prCommentText");
       const badgeEl=document.getElementById("prCommentBadge");
       const metaEl=document.getElementById("prCommentMeta");
       if(!txt || !badgeEl || !metaEl) return;

       if(!rep){
         badgeEl.textContent="-";
         txt.value="";
         metaEl.textContent="";
         return;
       }

       const st=ensureStore();
       const key = rep.periodKey + "|" + rep.env;
       badgeEl.textContent = key;

       const saved = st.comments[key];
       txt.value = saved?.text || "";
       metaEl.textContent = saved?.updatedAt ? `마지막 저장: ${saved.updatedAt}` : "";
       if(showToastMsg) toast(saved ? "코멘트를 불러왔습니다." : "저장된 코멘트가 없습니다.");
     },

     saveComment(){
       const rep=this.state.report;
       const txt=document.getElementById("prCommentText");
       const metaEl=document.getElementById("prCommentMeta");
       if(!rep || !txt) return;

       const st=ensureStore();
       const key = rep.periodKey + "|" + rep.env;
       st.comments[key] = { text: (txt.value||"").trim(), updatedAt: nowStr() };
       saveStore(st);

       if(metaEl) metaEl.textContent = `마지막 저장: ${st.comments[key].updatedAt}`;
       toast("저장했습니다.");
     },

     renderSample(){
       const rep=this.state.report;
       const box=document.getElementById("prSample");
       const badgeEl=document.getElementById("prSampleBadge");
       if(!box || !badgeEl) return;

       if(!rep){
         badgeEl.textContent="0";
         box.innerHTML=`<div style="color:#6b7280;font-size:13px;">(리포트 없음)</div>`;
         return;
       }

       const list = rep.sample || [];
       badgeEl.textContent = String(list.length);

       box.innerHTML = list.map(e=>{
         const t = e.type;
         const b = (t==="SQL" && e.riskHit)
           ? badge("RISK", "#fef2f2", "#b91c1c")
           : badge(t, "#f3f4f6", "#374151");

         const reason = (t==="SQL" && e.riskHit && e.riskReasons?.length)
           ? `<div style="color:#b91c1c;font-size:12px;margin-top:4px;">${esc(e.riskReasons.join(", "))}</div>` : "";

         const sql = (t==="SQL" && e.sql) ? `<div style="margin-top:6px;color:#111827;font-size:12px;white-space:pre-wrap;">${esc(e.sql)}</div>` : "";

         return `
           <div style="padding:10px;border:1px solid #eef2f7;border-radius:10px;${(t==="SQL"&&e.riskHit)?"background:#fffafa;":""}">
             <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
               <div style="font-weight:900;">${b} <span style="margin-left:6px;">${esc(e.action||t)}</span></div>
               <div style="color:#9ca3af;font-size:12px;">${esc(e.atStr||"")}</div>
             </div>
             <div style="color:#475569;font-size:12px;margin-top:6px;">
               user=${esc(e.user||"")} · ip=${esc(e.ip||"-")} · system=${esc(e.system||"")} · env=${esc(e.env||"")}
             </div>
             ${sql}
             ${reason}
           </div>
         `;
       }).join("");
     },

     exportReport(){
       const rep=this.state.report;
       if(!rep) return toast("리포트를 먼저 생성하세요.");

       const st=ensureStore();
       const commentKey = rep.periodKey + "|" + rep.env;
       const comment = st.comments[commentKey] || null;

       const payload = {
         exportedAt: nowStr(),
         report: rep,
         comment
       };

       const json=JSON.stringify(payload,null,2);
       const blob=new Blob([json],{type:"application/json;charset=utf-8"});
       const url=URL.createObjectURL(blob);

       const a=document.createElement("a");
       a.href=url;
       a.download=`db_access_report_${rep.periodKey}_${rep.env}_${Date.now()}.json`;
       document.body.appendChild(a);
       a.click();
       a.remove();
       setTimeout(()=>URL.revokeObjectURL(url),1000);
     }
   };

   // 전역 노출
   W.periodicReportAdmin = periodicReportAdmin;

   // router 방식이 있으면 등록(있어도 영향 없음)
   try{
     if(W.admin && typeof W.admin.registerItemHandler==="function"){
       W.admin.registerItemHandler("periodicReport", ()=>periodicReportAdmin.open());
     }
   }catch(e){}

   // 카드 클릭 진입 (섹션 가드 + 제목 매칭)
   document.addEventListener("click",(e)=>{
     const card = e.target.closest?.("#adminBody .admin-card.admin-card-clickable");
     if(!card) return;
     if(!W.admin || W.admin.current!=="anomalyReport") return;

     const title=(card.querySelector("h4")?.textContent||"").trim();
     if(!title.includes("월간/분기별 DB 접근 리포트")) return;

     e.preventDefault();
     e.stopPropagation();
     periodicReportAdmin.open();
   }, true);

 })();

 /* =========================================================
  * [PATCH v2] Access Lifecycle - 권한 신청/회수 Audit + ITSM 연동(모의) + 프로비저닝(모의)
  * - accessRequestAdmin / dbAccountLifecycleAdmin UI + 검색 + Audit(이력) 강화
  * - 티켓 상태 동기화(모의)로 승인 시 프로비저닝 작업 이력 생성
  * ========================================================= */
 (function patchAccessLifecycleV2(){
   // 이미 적용된 경우 중복 실행 방지
   if (window.__DBAM_ACCESS_LIFECYCLE_V2_PATCHED) return;
   window.__DBAM_ACCESS_LIFECYCLE_V2_PATCHED = true;

   const Store = {
     read(key, fallback){
       try{
         const raw = localStorage.getItem(key);
         if (!raw) return (fallback === undefined ? null : fallback);
         return JSON.parse(raw);
       }catch(e){
         return (fallback === undefined ? null : fallback);
       }
     },
     write(key, val){
       try{
         localStorage.setItem(key, JSON.stringify(val));
       }catch(e){}
     },
     bump(key){
       const v = Number(this.read(key, 0) || 0) + 1;
       this.write(key, v);
       return v;
     }
   };

   function nowLocal(){
     try{
       const d = new Date();
       const yyyy = d.getFullYear();
       const mm = String(d.getMonth()+1).padStart(2,'0');
       const dd = String(d.getDate()).padStart(2,'0');
       const hh = String(d.getHours()).padStart(2,'0');
       const mi = String(d.getMinutes()).padStart(2,'0');
       const ss = String(d.getSeconds()).padStart(2,'0');
       return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
     }catch(e){
       return String(new Date());
     }
   }

   function todayYmd(){
     const d = new Date();
     const yyyy = d.getFullYear();
     const mm = String(d.getMonth()+1).padStart(2,'0');
     const dd = String(d.getDate()).padStart(2,'0');
     return `${yyyy}${mm}${dd}`;
   }

   function currentUser(){
     // 파일 내 다른 모듈과의 호환: window.DBAM_CURRENT_USER 를 우선 사용
     return (window.DBAM_CURRENT_USER || '현재사용자');
   }

   function escapeHtml(str){
     return String(str || '')
       .replaceAll('&','&amp;')
       .replaceAll('<','&lt;')
       .replaceAll('>','&gt;')
       .replaceAll('"','&quot;')
       .replaceAll("'","&#039;");
   }

   // ---------------- ITSM (모의) ----------------
   const ITSM_KEY = 'DBAM_ITSM_TICKETS_V1';
   const ITSM_FLOW = ['OPEN','IN_APPROVAL','DONE','REJECTED','CANCELED']; // 간단 상태 흐름

   function ensureTicket(ticketId, meta){
     const map = Store.read(ITSM_KEY, {}) || {};
     if (!map[ticketId]) {
       map[ticketId] = {
         id: ticketId,
         status: 'OPEN',
         createdAt: nowLocal(),
         updatedAt: nowLocal(),
         meta: meta || {}
       };
       Store.write(ITSM_KEY, map);
     }
     return map[ticketId];
   }

   function nextTicketStatus(ticketId){
     const map = Store.read(ITSM_KEY, {}) || {};
     if (!map[ticketId]) ensureTicket(ticketId, {});
     const t = map[ticketId];
     const idx = ITSM_FLOW.indexOf(t.status || 'OPEN');
     const next = ITSM_FLOW[Math.min(idx+1, ITSM_FLOW.length-1)];
     t.status = next;
     t.updatedAt = nowLocal();
     map[ticketId] = t;
     Store.write(ITSM_KEY, map);
     return t;
   }

   function createTicketId(kind /* REQ|CHG */){
     const seq = Store.bump(`DBAM_SEQ_${kind}_${todayYmd()}`);
     const num = String(seq).padStart(4,'0');
     return `${kind}-${todayYmd()}-${num}`;
   }

   function mapItsmToRequestStatus(itsmStatus){
     switch(String(itsmStatus||'').toUpperCase()){
       case 'OPEN': return '결재대기';
       case 'IN_APPROVAL': return '결재중';
       case 'DONE': return '승인';
       case 'REJECTED': return '반려';
       case 'CANCELED': return '취소';
       default: return '결재대기';
     }
   }

   // ---------------- 프로비저닝 (모의) ----------------
   const PROV_KEY = 'DBAM_PROVISION_JOBS_V1';

   function addProvisionJob(job){
     const list = Store.read(PROV_KEY, []) || [];
     const seq = Store.bump(`DBAM_SEQ_PV_${todayYmd()}`);
     const id = `PV-${todayYmd()}-${String(seq).padStart(4,'0')}`;
     const row = Object.assign({
       id,
       createdAt: nowLocal(),
       status: '완료(모의)'
     }, job || {});
     list.unshift(row);
     Store.write(PROV_KEY, list);
     return row;
   }

   function listProvisionJobs(filterFn){
     const list = Store.read(PROV_KEY, []) || [];
     return typeof filterFn === 'function' ? list.filter(filterFn) : list;
   }

   // ---------------- 공통: 카드 클릭 리스너 교체(중복 방지) ----------------
   function rebindCardClick(cardEl, onClick){
     if (!cardEl) return;
     const parent = cardEl.parentNode;
     if (!parent) return;
     const clone = cardEl.cloneNode(true); // 기존 리스너 제거
     parent.replaceChild(clone, cardEl);
     clone.classList.add('admin-card-clickable');
     clone.addEventListener('click', (e)=>{
       e.preventDefault();
       e.stopPropagation();
       onClick && onClick(e);
     });
     return clone;
   }

   // =========================================================
   // 1) 권한 신청/변경/회수 요청 (Audit + 검색 + ITSM/프로비저닝 연계)
   // =========================================================
   const accessRequestAdminV2 = {
     STORAGE_KEY: 'DBAM_ACCESS_REQUESTS_V2',
     state: {
       approvers: [],
       filterType: 'ALL',
       filterStatus: 'ALL',
       keyword: '',
       selectedId: ''
     },
     seedIfEmpty(){
       const cur = Store.read(this.STORAGE_KEY, null);
       if (Array.isArray(cur) && cur.length) return;

       // 기존 샘플과 최대한 비슷한 형태로 초기값 생성
       const samples = [
         { id: 'AR-2025-001', type: '신청', target: 'DEV / ERP_READ', requester: '홍길동', dept: '정보보안실', status: '결재대기', createdAt: '2025-12-10', itsm: 'CHG-10421', itsmStatus:'OPEN', reason: '업무상 조회 필요' },
         { id: 'AR-2025-002', type: '변경', target: 'PRD / FIN_WRITE', requester: '김태규', dept: 'IT운영팀', status: '결재중', createdAt: '2025-12-11', itsm: 'REQ-88210', itsmStatus:'IN_APPROVAL', reason: '권한 범위 조정' },
         { id: 'AR-2025-003', type: '회수', target: 'OPS / DBA_TEMP', requester: '김감사', dept: '감사팀', status: '승인', createdAt: '2025-12-12', itsm: '', itsmStatus:'DONE', reason: '프로젝트 종료' }
       ].map(r => {
         const t = r.itsm ? ensureTicket(r.itsm, {kind:'ACCESS', requestId:r.id}) : null;
         return Object.assign({}, r, {
           itsmStatus: r.itsmStatus || (t ? t.status : 'OPEN'),
           approvers: r.approvers || [],
           audit: [
             { at: (r.createdAt ? (r.createdAt+' 09:00:00') : nowLocal()), actor: r.requester || '시스템', action: '요청등록', detail: '초기 샘플' }
           ]
         });
       });

       Store.write(this.STORAGE_KEY, samples);
     },
     _getAll(){
       this.seedIfEmpty();
       return Store.read(this.STORAGE_KEY, []) || [];
     },
     _saveAll(list){
       Store.write(this.STORAGE_KEY, list || []);
     },
     _find(id){
       const all = this._getAll();
       return all.find(x => x.id === id);
     },
     _update(row){
       const all = this._getAll();
       const idx = all.findIndex(x => x.id === row.id);
       if (idx >= 0) all[idx] = row;
       else all.unshift(row);
       this._saveAll(all);
       return all;
     },
     _pushAudit(row, actor, action, detail){
       if (!row) return;
       if (!Array.isArray(row.audit)) row.audit = [];
       row.audit.unshift({
         at: nowLocal(),
         actor: actor || currentUser(),
         action: action || '변경',
         detail: detail || ''
       });
     },
     attachAccessRequestCardHandler(){
       const bodyEl = document.getElementById('adminBody');
       if (!bodyEl) return;

       const cards = Array.from(bodyEl.querySelectorAll('.admin-card'));
       const card = cards.find(c => (c.querySelector('h4')?.textContent || '').includes('권한 신청/변경/회수 요청'));
       if (!card) return;

       // 중복 바인딩 방지(기존 코드와 구분하기 위해 v2 마커 사용)
       if (card.dataset.accessRequestBound === '2') return;
       card.dataset.accessRequestBound = '2';

       const footer = card.querySelector('.admin-footer');
       if (footer) footer.textContent = '요청서 작성/상태/감사 로그 확인';

       rebindCardClick(card, () => this.open());
     },
     open(){
       // 좌측 메뉴 active 처리
       try {
         if (window.admin) admin.current = 'accessLifecycle';
         document.querySelectorAll('.admin-nav button').forEach(btn => {
           if (btn.dataset.section === 'accessLifecycle') btn.classList.add('active');
           else btn.classList.remove('active');
         });
       } catch(e){}

       const titleEl = document.getElementById('adminTitle');
       const descEl  = document.getElementById('adminDesc');
       const bodyEl  = document.getElementById('adminBody');
       if (!titleEl || !descEl || !bodyEl) return;

       titleEl.innerHTML = '<i class="fa-solid fa-paper-plane"></i> 권한 신청/변경/회수 요청';
       descEl.textContent = '요청서 작성, 신청 현황 검색, Audit(이력), ITSM 티켓 상태 동기화(모의) 및 프로비저닝 이력을 확인합니다.';

       bodyEl.innerHTML = this.getTemplateHtml();
       this.bindOnce();
       this.renderList();
       this.renderDetail();
     },
     getTemplateHtml(){
       return `
         <div style="display:flex; flex-direction:column; gap:12px;">
           <div class="admin-card" style="padding:14px;">
             <h4 style="margin:0 0 6px 0;"><i class="fa-solid fa-file-signature"></i> 요청서 작성</h4>
             <p style="margin:0 0 10px 0; color:#6b7280; font-size:13px;">
               ITSM 티켓은 미입력 시 자동 생성(모의)되며, 티켓 상태를 진행하면 요청 상태 및 프로비저닝 이력이 자동 반영됩니다.
             </p>

             <div style="display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px;">
               <div>
                 <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">유형</div>
                 <select id="ar2Type" class="input" style="width:100%;">
                   <option value="신청">신청</option>
                   <option value="변경">변경</option>
                   <option value="회수">회수</option>
                 </select>
               </div>

               <div>
                 <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">ITSM 티켓(선택)</div>
                 <input id="ar2Itsm" class="input" style="width:100%;" placeholder="예) REQ-YYYYMMDD-0001 / CHG-YYYYMMDD-0001" />
               </div>

               <div>
                 <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">대상 시스템/권한</div>
                 <input id="ar2Target" class="input" style="width:100%;" placeholder="예) DEV / ERP_READ" />
               </div>

               <div>
                 <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">결재선(간단)</div>
                 <div style="display:flex; gap:8px;">
                   <input id="ar2Approvers" class="input" style="width:100%;" placeholder="결재선 미지정" readonly />
                   <button id="ar2PickApprover" class="btn" type="button" style="white-space:nowrap;">지정</button>
                 </div>
               </div>

               <div style="grid-column:1 / -1;">
                 <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">사유</div>
                 <textarea id="ar2Reason" class="input" style="width:100%; min-height:70px;" placeholder="요청 사유를 간단히 입력"></textarea>
               </div>
             </div>

             <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
               <button id="ar2Reset" class="btn" type="button">초기화</button>
               <button id="ar2Submit" class="btn primary" type="button">요청 등록</button>
             </div>
           </div>

           <div style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap:12px;">
             <div class="admin-card" style="padding:14px;">
               <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
                 <div style="display:flex; align-items:center; gap:8px;">
                   <h4 style="margin:0;"><i class="fa-solid fa-list"></i> 신청 현황</h4>
                   <span style="font-size:12px; color:#6b7280;">조회 결과 <b id="ar2Count">0</b>건</span>
                 </div>

                 <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                   <select id="ar2FilterType" class="input" style="min-width:120px;">
                     <option value="ALL">유형(전체)</option>
                     <option value="신청">신청</option>
                     <option value="변경">변경</option>
                     <option value="회수">회수</option>
                   </select>
                   <select id="ar2FilterStatus" class="input" style="min-width:140px;">
                     <option value="ALL">상태(전체)</option>
                     <option value="결재대기">결재대기</option>
                     <option value="결재중">결재중</option>
                     <option value="승인">승인</option>
                     <option value="반려">반려</option>
                     <option value="취소">취소</option>
                   </select>
                   <input id="ar2Keyword" class="input" style="min-width:220px;" placeholder="검색(요청자/대상/티켓)" />
                   <button id="ar2SearchBtn" class="btn" type="button">검색</button>
                   <button id="ar2ClearBtn" class="btn" type="button">초기화</button>
                 </div>
               </div>

               <div style="margin-top:10px; overflow:auto;">
                 <table style="width:100%; border-collapse:collapse; font-size:13px;">
                   <thead>
                     <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
                       <th style="padding:8px 6px;">ID</th>
                       <th style="padding:8px 6px;">유형</th>
                       <th style="padding:8px 6px;">대상</th>
                       <th style="padding:8px 6px;">요청자</th>
                       <th style="padding:8px 6px;">상태</th>
                       <th style="padding:8px 6px;">ITSM</th>
                       <th style="padding:8px 6px;">생성일</th>
                       <th style="padding:8px 6px; text-align:right;">액션</th>
                     </tr>
                   </thead>
                   <tbody id="ar2Tbody"></tbody>
                 </table>
               </div>

               <div class="admin-footer">행을 선택하면 우측에서 상세/Audit/프로비저닝 이력을 확인할 수 있습니다.</div>
             </div>

             <div class="admin-card" style="padding:14px;">
               <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                 <h4 style="margin:0;"><i class="fa-solid fa-clipboard-list"></i> 상세 / Audit</h4>
                 <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                   <button class="btn" type="button" data-ar2-act="itsm-next"><i class="fa-solid fa-rotate"></i> 티켓 진행</button>
                   <button class="btn" type="button" data-ar2-act="status-next"><i class="fa-solid fa-forward"></i> 상태 진행</button>
                   <button class="btn" type="button" data-ar2-act="status-reject"><i class="fa-solid fa-xmark"></i> 반려</button>
                   <button class="btn" type="button" data-ar2-act="status-cancel"><i class="fa-solid fa-ban"></i> 취소</button>
                 </div>
               </div>

               <div id="ar2Detail" style="margin-top:10px; font-size:13px; color:#334155;">
                 <div style="color:#6b7280;">선택된 요청이 없습니다.</div>
               </div>

               <div style="margin-top:12px;">
                 <div style="font-weight:700; font-size:13px; margin-bottom:6px;"><i class="fa-solid fa-clock-rotate-left"></i> Audit 로그</div>
                 <div style="overflow:auto; border:1px solid #e5e7eb; border-radius:8px;">
                   <table style="width:100%; border-collapse:collapse; font-size:12px;">
                     <thead>
                       <tr style="background:#f8fafc; color:#334155;">
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">시간</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">주체</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">행위</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">내용</th>
                       </tr>
                     </thead>
                     <tbody id="ar2AuditTbody"></tbody>
                   </table>
                 </div>
               </div>

               <div style="margin-top:12px;">
                 <div style="font-weight:700; font-size:13px; margin-bottom:6px;"><i class="fa-solid fa-gears"></i> 프로비저닝 이력</div>
                 <div style="overflow:auto; border:1px solid #e5e7eb; border-radius:8px;">
                   <table style="width:100%; border-collapse:collapse; font-size:12px;">
                     <thead>
                       <tr style="background:#f8fafc; color:#334155;">
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">작업ID</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">액션</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">대상</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">상태</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">시간</th>
                       </tr>
                     </thead>
                     <tbody id="ar2ProvTbody"></tbody>
                   </table>
                 </div>
               </div>

               <div class="admin-footer">“티켓 진행”은 ITSM 상태를 진행(모의)하며, 상태에 맞춰 요청 상태/프로비저닝이 동기화됩니다.</div>
             </div>
           </div>
         </div>
       `;
     },
     bindOnce(){
       const bodyEl = document.getElementById('adminBody');
       if (!bodyEl) return;
       if (bodyEl.dataset.ar2Bound === '1') return;
       bodyEl.dataset.ar2Bound = '1';

       bodyEl.addEventListener('click', (e)=>{
         const btn = e.target.closest('button');
         const tr  = e.target.closest('tr');

         // 행 클릭으로 선택
         if (tr && tr.dataset && tr.dataset.ar2Id) {
           this.state.selectedId = tr.dataset.ar2Id;
           this.renderList();
           this.renderDetail();
         }

         if (!btn) return;

         if (btn.id === 'ar2PickApprover') this.pickApprovers();
         else if (btn.id === 'ar2Reset') this.resetForm();
         else if (btn.id === 'ar2Submit') this.submitRequest();
         else if (btn.id === 'ar2SearchBtn') this.renderList();
         else if (btn.id === 'ar2ClearBtn') this.clearFilters();

         const act = btn.dataset.ar2Act;
         if (act === 'select') {
           this.state.selectedId = btn.dataset.id || '';
           this.renderList();
           this.renderDetail();
         } else if (act === 'status-next') {
           this.advanceStatus(this.state.selectedId);
         } else if (act === 'status-reject') {
           this.setStatus(this.state.selectedId, '반려');
         } else if (act === 'status-cancel') {
           this.setStatus(this.state.selectedId, '취소');
         } else if (act === 'itsm-next') {
           this.advanceItsm(this.state.selectedId);
         }
       });

       bodyEl.addEventListener('change', (e)=>{
         const id = e.target?.id;
         if (id === 'ar2FilterType') { this.state.filterType = e.target.value; this.renderList(); }
         if (id === 'ar2FilterStatus') { this.state.filterStatus = e.target.value; this.renderList(); }
       });

       bodyEl.addEventListener('keydown', (e)=>{
         if (e.key !== 'Enter') return;
         const id = e.target?.id;
         if (id === 'ar2Keyword') this.renderList();
       });
     },
     clearFilters(){
       this.state.filterType = 'ALL';
       this.state.filterStatus = 'ALL';
       this.state.keyword = '';
       const t = document.getElementById('ar2FilterType'); if (t) t.value = 'ALL';
       const s = document.getElementById('ar2FilterStatus'); if (s) s.value = 'ALL';
       const k = document.getElementById('ar2Keyword'); if (k) k.value = '';
       this.renderList();
     },
     pickApprovers(){
       const current = this.state.approvers.join(', ');
       const input = prompt('결재자 이름을 쉼표(,)로 구분해서 입력하세요.', current);
       if (input === null) return;
       const list = input.split(',').map(s=>s.trim()).filter(Boolean);
       this.state.approvers = list;
       const el = document.getElementById('ar2Approvers');
       if (el) el.value = list.join(' > ');
     },
     resetForm(){
       const typeEl = document.getElementById('ar2Type');
       const itsmEl = document.getElementById('ar2Itsm');
       const targetEl = document.getElementById('ar2Target');
       const reasonEl = document.getElementById('ar2Reason');
       if (typeEl) typeEl.value = '신청';
       if (itsmEl) itsmEl.value = '';
       if (targetEl) targetEl.value = '';
       if (reasonEl) reasonEl.value = '';
       this.state.approvers = [];
       const appr = document.getElementById('ar2Approvers');
       if (appr) appr.value = '';
     },
     submitRequest(){
       const type = document.getElementById('ar2Type')?.value || '신청';
       let itsm = (document.getElementById('ar2Itsm')?.value || '').trim();
       const target = (document.getElementById('ar2Target')?.value || '').trim();
       const reason = (document.getElementById('ar2Reason')?.value || '').trim();

       if (!target) return alert('대상 시스템/권한을 입력하세요.');
       if (!reason) return alert('사유를 입력하세요.');

       const y = new Date().getFullYear();
       const seq = Store.bump(`DBAM_SEQ_AR_${y}`);
       const id = `AR-${y}-${String(seq).padStart(3,'0')}`;

       // 티켓 자동 생성(모의)
       if (!itsm) {
         itsm = createTicketId(type === '변경' ? 'CHG' : 'REQ');
       }
       ensureTicket(itsm, {kind:'ACCESS', requestId:id});

       const row = {
         id,
         type,
         target,
         requester: currentUser(),
         dept: '요청부서',
         status: '결재대기',
         createdAt: nowLocal().slice(0,10),
         itsm,
         itsmStatus: 'OPEN',
         reason,
         approvers: this.state.approvers.slice(),
         audit: []
       };
       this._pushAudit(row, row.requester, '요청등록', `요청 등록 (ITSM:${itsm})`);
       this._update(row);

       this.state.selectedId = id;
       this.resetForm();
       this.renderList();
       this.renderDetail();
       alert(`요청이 등록되었습니다. (티켓: ${itsm})`);
     },
     _filtered(){
       let list = this._getAll().slice();

       // 최신이 위로
       list.sort((a,b)=>{
         const ta = (a.createdAt||'') + (a.id||'');
         const tb = (b.createdAt||'') + (b.id||'');
         return (tb>ta?1:(tb<ta?-1:0));
       });

       if (this.state.filterType !== 'ALL') list = list.filter(x => x.type === this.state.filterType);
       if (this.state.filterStatus !== 'ALL') list = list.filter(x => x.status === this.state.filterStatus);

       const kwEl = document.getElementById('ar2Keyword');
       const q = (kwEl ? kwEl.value : this.state.keyword || '').trim().toLowerCase();
       this.state.keyword = q;

       if (q) {
         list = list.filter(x =>
           String(x.requester||'').toLowerCase().includes(q) ||
           String(x.target||'').toLowerCase().includes(q) ||
           String(x.itsm||'').toLowerCase().includes(q)
         );
       }
       return list;
     },
     badge(status){
       const s = String(status||'');
       const base = 'display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700;';
       if (s === '승인') return `<span style="${base} background:#dcfce7; color:#166534;">승인</span>`;
       if (s === '반려') return `<span style="${base} background:#fee2e2; color:#991b1b;">반려</span>`;
       if (s === '취소') return `<span style="${base} background:#e2e8f0; color:#334155;">취소</span>`;
       if (s === '결재중') return `<span style="${base} background:#dbeafe; color:#1e40af;">결재중</span>`;
       return `<span style="${base} background:#fef9c3; color:#854d0e;">결재대기</span>`;
     },
     renderList(){
       const tbody = document.getElementById('ar2Tbody');
       const countEl = document.getElementById('ar2Count');
       if (!tbody || !countEl) return;

       const list = this._filtered();
       countEl.textContent = String(list.length);

       tbody.innerHTML = list.map(r=>{
         const selected = (r.id === this.state.selectedId) ? 'background:#f8fafc;' : '';
         return `
           <tr data-ar2-id="${escapeHtml(r.id)}" style="border-bottom:1px solid #f1f5f9; cursor:pointer; ${selected}">
             <td style="padding:8px 6px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${escapeHtml(r.id)}</td>
             <td style="padding:8px 6px;">${escapeHtml(r.type)}</td>
             <td style="padding:8px 6px; max-width:240px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(r.target)}</td>
             <td style="padding:8px 6px;">${escapeHtml(r.requester || '')}</td>
             <td style="padding:8px 6px;">${this.badge(r.status)}</td>
             <td style="padding:8px 6px;">${escapeHtml(r.itsm || '-')}</td>
             <td style="padding:8px 6px;">${escapeHtml(r.createdAt || '')}</td>
             <td style="padding:8px 6px; text-align:right;">
               <button class="btn" type="button" data-ar2-act="select" data-id="${escapeHtml(r.id)}">보기</button>
             </td>
           </tr>
         `;
       }).join('');

       // 선택된 항목이 없으면 첫 행 자동 선택(편의)
       if (!this.state.selectedId && list.length) {
         this.state.selectedId = list[0].id;
         this.renderList();
       }
     },
     renderDetail(){
       const box = document.getElementById('ar2Detail');
       const auditT = document.getElementById('ar2AuditTbody');
       const provT  = document.getElementById('ar2ProvTbody');
       if (!box || !auditT || !provT) return;

       const id = this.state.selectedId;
       const row = id ? this._find(id) : null;

       if (!row) {
         box.innerHTML = `<div style="color:#6b7280;">선택된 요청이 없습니다.</div>`;
         auditT.innerHTML = `<tr><td colspan="4" style="padding:10px; color:#6b7280;">-</td></tr>`;
         provT.innerHTML = `<tr><td colspan="5" style="padding:10px; color:#6b7280;">-</td></tr>`;
         return;
       }

       const ticket = row.itsm ? (Store.read(ITSM_KEY, {}) || {})[row.itsm] : null;
       const itsmStatus = (ticket?.status || row.itsmStatus || 'OPEN');
       const approvers = (row.approvers && row.approvers.length) ? row.approvers.join(' > ') : '(미지정)';

       box.innerHTML = `
         <div style="display:grid; grid-template-columns: 120px 1fr; gap:6px 10px;">
           <div style="color:#64748b;">요청ID</div><div><b>${escapeHtml(row.id)}</b></div>
           <div style="color:#64748b;">유형</div><div>${escapeHtml(row.type)}</div>
           <div style="color:#64748b;">대상</div><div>${escapeHtml(row.target)}</div>
           <div style="color:#64748b;">요청자</div><div>${escapeHtml(row.requester||'')}</div>
           <div style="color:#64748b;">상태</div><div>${this.badge(row.status)}</div>
           <div style="color:#64748b;">ITSM</div><div>${escapeHtml(row.itsm || '-')} <span style="color:#64748b;">(${escapeHtml(itsmStatus)})</span></div>
           <div style="color:#64748b;">결재선</div><div>${escapeHtml(approvers)}</div>
           <div style="color:#64748b;">사유</div><div>${escapeHtml(row.reason||'')}</div>
         </div>
       `;

       const audits = Array.isArray(row.audit) && row.audit.length ? row.audit : [];
       auditT.innerHTML = audits.slice(0,50).map(a=>`
         <tr style="border-bottom:1px solid #f1f5f9;">
           <td style="padding:8px;">${escapeHtml(a.at)}</td>
           <td style="padding:8px;">${escapeHtml(a.actor)}</td>
           <td style="padding:8px;">${escapeHtml(a.action)}</td>
           <td style="padding:8px;">${escapeHtml(a.detail)}</td>
         </tr>
       `).join('') || `<tr><td colspan="4" style="padding:10px; color:#6b7280;">-</td></tr>`;

       const jobs = listProvisionJobs(j => j.source === 'ACCESS' && j.requestId === row.id);
       provT.innerHTML = jobs.map(j=>`
         <tr style="border-bottom:1px solid #f1f5f9;">
           <td style="padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${escapeHtml(j.id)}</td>
           <td style="padding:8px;">${escapeHtml(j.action || '')}</td>
           <td style="padding:8px;">${escapeHtml(j.target || '')}</td>
           <td style="padding:8px;">${escapeHtml(j.status || '')}</td>
           <td style="padding:8px;">${escapeHtml(j.createdAt || '')}</td>
         </tr>
       `).join('') || `<tr><td colspan="5" style="padding:10px; color:#6b7280;">-</td></tr>`;
     },
     advanceStatus(id){
       if (!id) return alert('선택된 요청이 없습니다.');
       const row = this._find(id);
       if (!row) return;

       const flow = ['결재대기','결재중','승인'];
       if (!flow.includes(row.status)) return alert('상태 진행 가능한 상태가 아닙니다.');

       const idx = flow.indexOf(row.status);
       const next = flow[Math.min(idx+1, flow.length-1)];
       row.status = next;

       // ITSM 상태도 동기화(요청 상태 기준)
       if (row.itsm) {
         const ticket = ensureTicket(row.itsm, {kind:'ACCESS', requestId:row.id});
         if (next === '결재중') ticket.status = 'IN_APPROVAL';
         if (next === '승인') ticket.status = 'DONE';
         ticket.updatedAt = nowLocal();

         const map = Store.read(ITSM_KEY, {}) || {};
         map[row.itsm] = ticket;
         Store.write(ITSM_KEY, map);
       }

       this._pushAudit(row, currentUser(), '상태변경', `상태 진행 → ${next}`);

       // 승인 시 프로비저닝(모의)
       if (next === '승인') {
         const job = addProvisionJob({
           source: 'ACCESS',
           requestId: row.id,
           ticketId: row.itsm || '',
           action: (row.type === '회수') ? 'REVOKE_PRIVILEGE' : (row.type === '변경' ? 'CHANGE_PRIVILEGE' : 'GRANT_PRIVILEGE'),
           target: row.target
         });
         this._pushAudit(row, '시스템', '프로비저닝', `${job.action} 실행(모의) - ${job.id}`);
       }

       this._update(row);
       this.renderList();
       this.renderDetail();
     },
     setStatus(id, status){
       if (!id) return alert('선택된 요청이 없습니다.');
       const row = this._find(id);
       if (!row) return;

       const allow = ['반려','취소'];
       if (!allow.includes(status)) return;

       row.status = status;

       if (row.itsm) {
         const ticket = ensureTicket(row.itsm, {kind:'ACCESS', requestId:row.id});
         ticket.status = (status === '반려') ? 'REJECTED' : 'CANCELED';
         ticket.updatedAt = nowLocal();
         const map = Store.read(ITSM_KEY, {}) || {};
         map[row.itsm] = ticket;
         Store.write(ITSM_KEY, map);
       }

       this._pushAudit(row, currentUser(), '상태변경', `상태 변경 → ${status}`);
       this._update(row);
       this.renderList();
       this.renderDetail();
     },
     advanceItsm(id){
       if (!id) return alert('선택된 요청이 없습니다.');
       const row = this._find(id);
       if (!row) return;

       if (!row.itsm) {
         row.itsm = createTicketId(row.type === '변경' ? 'CHG' : 'REQ');
         ensureTicket(row.itsm, {kind:'ACCESS', requestId:row.id});
         this._pushAudit(row, '시스템', 'ITSM', `티켓 자동 생성(모의): ${row.itsm}`);
       }

       const t = nextTicketStatus(row.itsm);
       row.itsmStatus = t.status;

       const mapped = mapItsmToRequestStatus(t.status);

       // ITSM 상태가 DONE/REJECTED/CANCELED 처럼 결정되면 요청 상태도 동기화
       if (mapped && row.status !== mapped) {
         row.status = mapped;
         this._pushAudit(row, '시스템', 'ITSM동기화', `티켓 상태(${t.status}) → 요청 상태(${mapped})`);
       }

       // DONE이면 프로비저닝 실행
       if (row.status === '승인') {
         const existing = listProvisionJobs(j => j.source === 'ACCESS' && j.requestId === row.id);
         if (!existing.length) {
           const job = addProvisionJob({
             source: 'ACCESS',
             requestId: row.id,
             ticketId: row.itsm || '',
             action: (row.type === '회수') ? 'REVOKE_PRIVILEGE' : (row.type === '변경' ? 'CHANGE_PRIVILEGE' : 'GRANT_PRIVILEGE'),
             target: row.target
           });
           this._pushAudit(row, '시스템', '프로비저닝', `${job.action} 실행(모의) - ${job.id}`);
         }
       }

       this._update(row);
       this.renderList();
       this.renderDetail();
     }
   };

   // =========================================================
   // 2) DB 계정 발급/변경/삭제 요청 (Audit + 검색 + ITSM/프로비저닝 연계)
   // =========================================================
   const dbAccountLifecycleAdminV2 = {
     STORAGE_KEY: 'DBAM_DB_ACCOUNT_LIFECYCLE_V2',
     state: {
       approvers: [],
       filterType: 'ALL',
       filterStatus: 'ALL',
       keyword: '',
       selectedId: ''
     },
     seedIfEmpty(){
       const cur = Store.read(this.STORAGE_KEY, null);
       if (Array.isArray(cur) && cur.length) return;

       const samples = [
         { id: 'DBA-2025-001', type: '발급', system: 'DEV', account: 'APP_DEV01', period: '2025-12-10 ~ 2026-03-31', requester: '홍길동', dept: '개발팀', status: '결재대기', createdAt: '2025-12-10', itsm: 'REQ-90211', itsmStatus:'OPEN', reason: '신규 프로젝트 투입' },
         { id: 'DBA-2025-002', type: '변경', system: 'PRD', account: 'BATCH_PRD02', period: '2025-12-11 ~ 2025-12-31', requester: '김태규', dept: 'IT운영팀', status: '결재중', createdAt: '2025-12-11', itsm: 'CHG-11421', itsmStatus:'IN_APPROVAL', reason: '권한 범위 확장' },
         { id: 'DBA-2025-003', type: '삭제', system: 'OPS', account: 'TEMP_DBA99', period: '2025-12-12 ~ 2025-12-12', requester: '김감사', dept: '감사팀', status: '승인', createdAt: '2025-12-12', itsm: '', itsmStatus:'DONE', reason: '사용 종료' }
       ].map(r=>{
         const t = r.itsm ? ensureTicket(r.itsm, {kind:'DB_ACCOUNT', requestId:r.id}) : null;
         return Object.assign({}, r, {
           itsmStatus: r.itsmStatus || (t ? t.status : 'OPEN'),
           approvers: r.approvers || [],
           audit: [
             { at: (r.createdAt ? (r.createdAt+' 09:00:00') : nowLocal()), actor: r.requester || '시스템', action: '요청등록', detail: '초기 샘플' }
           ]
         });
       });

       Store.write(this.STORAGE_KEY, samples);
     },
     _getAll(){ this.seedIfEmpty(); return Store.read(this.STORAGE_KEY, []) || []; },
     _saveAll(list){ Store.write(this.STORAGE_KEY, list || []); },
     _find(id){ return this._getAll().find(x=>x.id===id); },
     _update(row){
       const all = this._getAll();
       const idx = all.findIndex(x=>x.id===row.id);
       if (idx>=0) all[idx]=row;
       else all.unshift(row);
       this._saveAll(all);
       return all;
     },
     _pushAudit(row, actor, action, detail){
       if (!row) return;
       if (!Array.isArray(row.audit)) row.audit = [];
       row.audit.unshift({ at: nowLocal(), actor: actor || currentUser(), action: action || '변경', detail: detail || '' });
     },
     attachDbAccountLifecycleCardHandler(){
       const bodyEl = document.getElementById('adminBody');
       if (!bodyEl) return;

       const cards = Array.from(bodyEl.querySelectorAll('.admin-card'));
       const card = cards.find(c => (c.querySelector('h4')?.textContent || '').includes('DB 계정 발급/변경/삭제 요청'));
       if (!card) return;

       if (card.dataset.dbAccountLifecycleBound === '2') return;
       card.dataset.dbAccountLifecycleBound = '2';

       const footer = card.querySelector('.admin-footer');
       if (footer) footer.textContent = '요청서 작성/상태/감사 로그 확인';

       rebindCardClick(card, () => this.open());
     },
     open(){
       try {
         if (window.admin) admin.current = 'accessLifecycle';
         document.querySelectorAll('.admin-nav button').forEach(btn => {
           if (btn.dataset.section === 'accessLifecycle') btn.classList.add('active');
           else btn.classList.remove('active');
         });
       } catch(e){}

       const titleEl = document.getElementById('adminTitle');
       const descEl  = document.getElementById('adminDesc');
       const bodyEl  = document.getElementById('adminBody');
       if (!titleEl || !descEl || !bodyEl) return;

       titleEl.innerHTML = '<i class="fa-solid fa-database"></i> DB 계정 발급/변경/삭제 요청';
       descEl.textContent = '계정 라이프사이클 요청을 등록하고, Audit(이력), ITSM 티켓 상태 동기화(모의) 및 프로비저닝 이력을 확인합니다.';

       bodyEl.innerHTML = this.getTemplateHtml();
       this.bindOnce();
       this.renderList();
       this.renderDetail();
     },
     getTemplateHtml(){
       return `
         <div style="display:flex; flex-direction:column; gap:12px;">
           <div class="admin-card" style="padding:14px;">
             <h4 style="margin:0 0 6px 0;"><i class="fa-solid fa-user-gear"></i> 요청서 작성</h4>
             <p style="margin:0 0 10px 0; color:#6b7280; font-size:13px;">
               ITSM 티켓은 미입력 시 자동 생성(모의)되며, 승인 시 프로비저닝 작업 이력이 생성됩니다.
             </p>

             <div style="display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px;">
               <div>
                 <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">유형</div>
                 <select id="dba2Type" class="input" style="width:100%;">
                   <option value="발급">발급</option>
                   <option value="변경">변경</option>
                   <option value="삭제">삭제</option>
                 </select>
               </div>

               <div>
                 <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">ITSM 티켓(선택)</div>
                 <input id="dba2Itsm" class="input" style="width:100%;" placeholder="예) REQ-YYYYMMDD-0001 / CHG-YYYYMMDD-0001" />
               </div>

               <div>
                 <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">대상 시스템</div>
                 <input id="dba2System" class="input" style="width:100%;" placeholder="예) DEV / PRD / OPS" />
               </div>

               <div>
                 <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">계정</div>
                 <input id="dba2Account" class="input" style="width:100%;" placeholder="예) APP_DEV01" />
               </div>

               <div>
                 <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">기간</div>
                 <input id="dba2Period" class="input" style="width:100%;" placeholder="예) 2025-12-10 ~ 2026-03-31" />
               </div>

               <div>
                 <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">결재선(간단)</div>
                 <div style="display:flex; gap:8px;">
                   <input id="dba2Approvers" class="input" style="width:100%;" placeholder="결재선 미지정" readonly />
                   <button id="dba2PickApprover" class="btn" type="button" style="white-space:nowrap;">지정</button>
                 </div>
               </div>

               <div style="grid-column:1 / -1;">
                 <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">사유</div>
                 <textarea id="dba2Reason" class="input" style="width:100%; min-height:70px;" placeholder="요청 사유를 간단히 입력"></textarea>
               </div>
             </div>

             <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
               <button id="dba2Reset" class="btn" type="button">초기화</button>
               <button id="dba2Submit" class="btn primary" type="button">요청 등록</button>
             </div>
           </div>

           <div style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap:12px;">
             <div class="admin-card" style="padding:14px;">
               <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
                 <div style="display:flex; align-items:center; gap:8px;">
                   <h4 style="margin:0;"><i class="fa-solid fa-list"></i> 신청 현황</h4>
                   <span style="font-size:12px; color:#6b7280;">조회 결과 <b id="dba2Count">0</b>건</span>
                 </div>

                 <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                   <select id="dba2FilterType" class="input" style="min-width:120px;">
                     <option value="ALL">유형(전체)</option>
                     <option value="발급">발급</option>
                     <option value="변경">변경</option>
                     <option value="삭제">삭제</option>
                   </select>
                   <select id="dba2FilterStatus" class="input" style="min-width:140px;">
                     <option value="ALL">상태(전체)</option>
                     <option value="결재대기">결재대기</option>
                     <option value="결재중">결재중</option>
                     <option value="승인">승인</option>
                     <option value="반려">반려</option>
                     <option value="취소">취소</option>
                   </select>
                   <input id="dba2Keyword" class="input" style="min-width:220px;" placeholder="검색(요청자/계정/티켓)" />
                   <button id="dba2SearchBtn" class="btn" type="button">검색</button>
                   <button id="dba2ClearBtn" class="btn" type="button">초기화</button>
                 </div>
               </div>

               <div style="margin-top:10px; overflow:auto;">
                 <table style="width:100%; border-collapse:collapse; font-size:13px;">
                   <thead>
                     <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
                       <th style="padding:8px 6px;">ID</th>
                       <th style="padding:8px 6px;">유형</th>
                       <th style="padding:8px 6px;">시스템</th>
                       <th style="padding:8px 6px;">계정</th>
                       <th style="padding:8px 6px;">상태</th>
                       <th style="padding:8px 6px;">ITSM</th>
                       <th style="padding:8px 6px;">생성일</th>
                       <th style="padding:8px 6px; text-align:right;">액션</th>
                     </tr>
                   </thead>
                   <tbody id="dba2Tbody"></tbody>
                 </table>
               </div>

               <div class="admin-footer">행을 선택하면 우측에서 상세/Audit/프로비저닝 이력을 확인할 수 있습니다.</div>
             </div>

             <div class="admin-card" style="padding:14px;">
               <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                 <h4 style="margin:0;"><i class="fa-solid fa-clipboard-list"></i> 상세 / Audit</h4>
                 <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                   <button class="btn" type="button" data-dba2-act="itsm-next"><i class="fa-solid fa-rotate"></i> 티켓 진행</button>
                   <button class="btn" type="button" data-dba2-act="status-next"><i class="fa-solid fa-forward"></i> 상태 진행</button>
                   <button class="btn" type="button" data-dba2-act="status-reject"><i class="fa-solid fa-xmark"></i> 반려</button>
                   <button class="btn" type="button" data-dba2-act="status-cancel"><i class="fa-solid fa-ban"></i> 취소</button>
                 </div>
               </div>

               <div id="dba2Detail" style="margin-top:10px; font-size:13px; color:#334155;">
                 <div style="color:#6b7280;">선택된 요청이 없습니다.</div>
               </div>

               <div style="margin-top:12px;">
                 <div style="font-weight:700; font-size:13px; margin-bottom:6px;"><i class="fa-solid fa-clock-rotate-left"></i> Audit 로그</div>
                 <div style="overflow:auto; border:1px solid #e5e7eb; border-radius:8px;">
                   <table style="width:100%; border-collapse:collapse; font-size:12px;">
                     <thead>
                       <tr style="background:#f8fafc; color:#334155;">
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">시간</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">주체</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">행위</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">내용</th>
                       </tr>
                     </thead>
                     <tbody id="dba2AuditTbody"></tbody>
                   </table>
                 </div>
               </div>

               <div style="margin-top:12px;">
                 <div style="font-weight:700; font-size:13px; margin-bottom:6px;"><i class="fa-solid fa-gears"></i> 프로비저닝 이력</div>
                 <div style="overflow:auto; border:1px solid #e5e7eb; border-radius:8px;">
                   <table style="width:100%; border-collapse:collapse; font-size:12px;">
                     <thead>
                       <tr style="background:#f8fafc; color:#334155;">
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">작업ID</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">액션</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">대상</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">상태</th>
                         <th style="text-align:left; padding:8px; border-bottom:1px solid #e5e7eb;">시간</th>
                       </tr>
                     </thead>
                     <tbody id="dba2ProvTbody"></tbody>
                   </table>
                 </div>
               </div>

               <div class="admin-footer">“티켓 진행”은 ITSM 상태를 진행(모의)하며, 상태에 맞춰 요청 상태/프로비저닝이 동기화됩니다.</div>
             </div>
           </div>
         </div>
       `;
     },
     bindOnce(){
       const bodyEl = document.getElementById('adminBody');
       if (!bodyEl) return;
       if (bodyEl.dataset.dba2Bound === '1') return;
       bodyEl.dataset.dba2Bound = '1';

       bodyEl.addEventListener('click', (e)=>{
         const btn = e.target.closest('button');
         const tr  = e.target.closest('tr');

         if (tr && tr.dataset && tr.dataset.dba2Id) {
           this.state.selectedId = tr.dataset.dba2Id;
           this.renderList();
           this.renderDetail();
         }

         if (!btn) return;

         if (btn.id === 'dba2PickApprover') this.pickApprovers();
         else if (btn.id === 'dba2Reset') this.resetForm();
         else if (btn.id === 'dba2Submit') this.submitRequest();
         else if (btn.id === 'dba2SearchBtn') this.renderList();
         else if (btn.id === 'dba2ClearBtn') this.clearFilters();

         const act = btn.dataset.dba2Act;
         if (act === 'select') {
           this.state.selectedId = btn.dataset.id || '';
           this.renderList();
           this.renderDetail();
         } else if (act === 'status-next') {
           this.advanceStatus(this.state.selectedId);
         } else if (act === 'status-reject') {
           this.setStatus(this.state.selectedId, '반려');
         } else if (act === 'status-cancel') {
           this.setStatus(this.state.selectedId, '취소');
         } else if (act === 'itsm-next') {
           this.advanceItsm(this.state.selectedId);
         }
       });

       bodyEl.addEventListener('change', (e)=>{
         const id = e.target?.id;
         if (id === 'dba2FilterType') { this.state.filterType = e.target.value; this.renderList(); }
         if (id === 'dba2FilterStatus') { this.state.filterStatus = e.target.value; this.renderList(); }
       });

       bodyEl.addEventListener('keydown', (e)=>{
         if (e.key !== 'Enter') return;
         const id = e.target?.id;
         if (id === 'dba2Keyword') this.renderList();
       });
     },
     clearFilters(){
       this.state.filterType = 'ALL';
       this.state.filterStatus = 'ALL';
       this.state.keyword = '';
       const t = document.getElementById('dba2FilterType'); if (t) t.value = 'ALL';
       const s = document.getElementById('dba2FilterStatus'); if (s) s.value = 'ALL';
       const k = document.getElementById('dba2Keyword'); if (k) k.value = '';
       this.renderList();
     },
     pickApprovers(){
       const current = this.state.approvers.join(', ');
       const input = prompt('결재자 이름을 쉼표(,)로 구분해서 입력하세요.', current);
       if (input === null) return;
       const list = input.split(',').map(s=>s.trim()).filter(Boolean);
       this.state.approvers = list;
       const el = document.getElementById('dba2Approvers');
       if (el) el.value = list.join(' > ');
     },
     resetForm(){
       const typeEl = document.getElementById('dba2Type');
       const itsmEl = document.getElementById('dba2Itsm');
       const systemEl = document.getElementById('dba2System');
       const acctEl = document.getElementById('dba2Account');
       const periodEl = document.getElementById('dba2Period');
       const reasonEl = document.getElementById('dba2Reason');
       if (typeEl) typeEl.value = '발급';
       if (itsmEl) itsmEl.value = '';
       if (systemEl) systemEl.value = '';
       if (acctEl) acctEl.value = '';
       if (periodEl) periodEl.value = '';
       if (reasonEl) reasonEl.value = '';
       this.state.approvers = [];
       const appr = document.getElementById('dba2Approvers');
       if (appr) appr.value = '';
     },
     submitRequest(){
       const type = document.getElementById('dba2Type')?.value || '발급';
       let itsm = (document.getElementById('dba2Itsm')?.value || '').trim();
       const system = (document.getElementById('dba2System')?.value || '').trim();
       const account = (document.getElementById('dba2Account')?.value || '').trim();
       const period = (document.getElementById('dba2Period')?.value || '').trim();
       const reason = (document.getElementById('dba2Reason')?.value || '').trim();

       if (!system) return alert('대상 시스템을 입력하세요.');
       if (!account) return alert('계정을 입력하세요.');
       if (!period) return alert('기간을 입력하세요.');
       if (!reason) return alert('사유를 입력하세요.');

       const y = new Date().getFullYear();
       const seq = Store.bump(`DBAM_SEQ_DBA_${y}`);
       const id = `DBA-${y}-${String(seq).padStart(3,'0')}`;

       if (!itsm) {
         itsm = createTicketId(type === '변경' ? 'CHG' : 'REQ');
       }
       ensureTicket(itsm, {kind:'DB_ACCOUNT', requestId:id});

       const row = {
         id,
         type,
         system,
         account,
         period,
         requester: currentUser(),
         dept: '요청부서',
         status: '결재대기',
         createdAt: nowLocal().slice(0,10),
         itsm,
         itsmStatus: 'OPEN',
         reason,
         approvers: this.state.approvers.slice(),
         audit: []
       };
       this._pushAudit(row, row.requester, '요청등록', `요청 등록 (ITSM:${itsm})`);
       this._update(row);

       this.state.selectedId = id;
       this.resetForm();
       this.renderList();
       this.renderDetail();
       alert(`요청이 등록되었습니다. (티켓: ${itsm})`);
     },
     _filtered(){
       let list = this._getAll().slice();
       list.sort((a,b)=>{
         const ta = (a.createdAt||'') + (a.id||'');
         const tb = (b.createdAt||'') + (b.id||'');
         return (tb>ta?1:(tb<ta?-1:0));
       });

       if (this.state.filterType !== 'ALL') list = list.filter(x => x.type === this.state.filterType);
       if (this.state.filterStatus !== 'ALL') list = list.filter(x => x.status === this.state.filterStatus);

       const kwEl = document.getElementById('dba2Keyword');
       const q = (kwEl ? kwEl.value : this.state.keyword || '').trim().toLowerCase();
       this.state.keyword = q;

       if (q) {
         list = list.filter(x =>
           String(x.requester||'').toLowerCase().includes(q) ||
           String(x.account||'').toLowerCase().includes(q) ||
           String(x.itsm||'').toLowerCase().includes(q)
         );
       }
       return list;
     },
     badge(status){
       // accessRequestAdminV2와 동일한 뱃지 스타일을 공유
       const s = String(status||'');
       const base = 'display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700;';
       if (s === '승인') return `<span style="${base} background:#dcfce7; color:#166534;">승인</span>`;
       if (s === '반려') return `<span style="${base} background:#fee2e2; color:#991b1b;">반려</span>`;
       if (s === '취소') return `<span style="${base} background:#e2e8f0; color:#334155;">취소</span>`;
       if (s === '결재중') return `<span style="${base} background:#dbeafe; color:#1e40af;">결재중</span>`;
       return `<span style="${base} background:#fef9c3; color:#854d0e;">결재대기</span>`;
     },
     renderList(){
       const tbody = document.getElementById('dba2Tbody');
       const countEl = document.getElementById('dba2Count');
       if (!tbody || !countEl) return;

       const list = this._filtered();
       countEl.textContent = String(list.length);

       tbody.innerHTML = list.map(r=>{
         const selected = (r.id === this.state.selectedId) ? 'background:#f8fafc;' : '';
         return `
           <tr data-dba2-id="${escapeHtml(r.id)}" style="border-bottom:1px solid #f1f5f9; cursor:pointer; ${selected}">
             <td style="padding:8px 6px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${escapeHtml(r.id)}</td>
             <td style="padding:8px 6px;">${escapeHtml(r.type)}</td>
             <td style="padding:8px 6px;">${escapeHtml(r.system||'')}</td>
             <td style="padding:8px 6px; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(r.account||'')}</td>
             <td style="padding:8px 6px;">${this.badge(r.status)}</td>
             <td style="padding:8px 6px;">${escapeHtml(r.itsm || '-')}</td>
             <td style="padding:8px 6px;">${escapeHtml(r.createdAt || '')}</td>
             <td style="padding:8px 6px; text-align:right;">
               <button class="btn" type="button" data-dba2-act="select" data-id="${escapeHtml(r.id)}">보기</button>
             </td>
           </tr>
         `;
       }).join('');

       if (!this.state.selectedId && list.length) {
         this.state.selectedId = list[0].id;
         this.renderList();
       }
     },
     renderDetail(){
       const box = document.getElementById('dba2Detail');
       const auditT = document.getElementById('dba2AuditTbody');
       const provT  = document.getElementById('dba2ProvTbody');
       if (!box || !auditT || !provT) return;

       const id = this.state.selectedId;
       const row = id ? this._find(id) : null;

       if (!row) {
         box.innerHTML = `<div style="color:#6b7280;">선택된 요청이 없습니다.</div>`;
         auditT.innerHTML = `<tr><td colspan="4" style="padding:10px; color:#6b7280;">-</td></tr>`;
         provT.innerHTML = `<tr><td colspan="5" style="padding:10px; color:#6b7280;">-</td></tr>`;
         return;
       }

       const ticket = row.itsm ? (Store.read(ITSM_KEY, {}) || {})[row.itsm] : null;
       const itsmStatus = (ticket?.status || row.itsmStatus || 'OPEN');
       const approvers = (row.approvers && row.approvers.length) ? row.approvers.join(' > ') : '(미지정)';

       box.innerHTML = `
         <div style="display:grid; grid-template-columns: 120px 1fr; gap:6px 10px;">
           <div style="color:#64748b;">요청ID</div><div><b>${escapeHtml(row.id)}</b></div>
           <div style="color:#64748b;">유형</div><div>${escapeHtml(row.type)}</div>
           <div style="color:#64748b;">시스템</div><div>${escapeHtml(row.system||'')}</div>
           <div style="color:#64748b;">계정</div><div>${escapeHtml(row.account||'')}</div>
           <div style="color:#64748b;">기간</div><div>${escapeHtml(row.period||'')}</div>
           <div style="color:#64748b;">요청자</div><div>${escapeHtml(row.requester||'')}</div>
           <div style="color:#64748b;">상태</div><div>${this.badge(row.status)}</div>
           <div style="color:#64748b;">ITSM</div><div>${escapeHtml(row.itsm || '-')} <span style="color:#64748b;">(${escapeHtml(itsmStatus)})</span></div>
           <div style="color:#64748b;">결재선</div><div>${escapeHtml(approvers)}</div>
           <div style="color:#64748b;">사유</div><div>${escapeHtml(row.reason||'')}</div>
         </div>
       `;

       const audits = Array.isArray(row.audit) && row.audit.length ? row.audit : [];
       auditT.innerHTML = audits.slice(0,50).map(a=>`
         <tr style="border-bottom:1px solid #f1f5f9;">
           <td style="padding:8px;">${escapeHtml(a.at)}</td>
           <td style="padding:8px;">${escapeHtml(a.actor)}</td>
           <td style="padding:8px;">${escapeHtml(a.action)}</td>
           <td style="padding:8px;">${escapeHtml(a.detail)}</td>
         </tr>
       `).join('') || `<tr><td colspan="4" style="padding:10px; color:#6b7280;">-</td></tr>`;

       const jobs = listProvisionJobs(j => j.source === 'DB_ACCOUNT' && j.requestId === row.id);
       provT.innerHTML = jobs.map(j=>`
         <tr style="border-bottom:1px solid #f1f5f9;">
           <td style="padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${escapeHtml(j.id)}</td>
           <td style="padding:8px;">${escapeHtml(j.action || '')}</td>
           <td style="padding:8px;">${escapeHtml(j.target || '')}</td>
           <td style="padding:8px;">${escapeHtml(j.status || '')}</td>
           <td style="padding:8px;">${escapeHtml(j.createdAt || '')}</td>
         </tr>
       `).join('') || `<tr><td colspan="5" style="padding:10px; color:#6b7280;">-</td></tr>`;
     },
     advanceStatus(id){
       if (!id) return alert('선택된 요청이 없습니다.');
       const row = this._find(id);
       if (!row) return;

       const flow = ['결재대기','결재중','승인'];
       if (!flow.includes(row.status)) return alert('상태 진행 가능한 상태가 아닙니다.');

       const idx = flow.indexOf(row.status);
       const next = flow[Math.min(idx+1, flow.length-1)];
       row.status = next;

       if (row.itsm) {
         const ticket = ensureTicket(row.itsm, {kind:'DB_ACCOUNT', requestId:row.id});
         if (next === '결재중') ticket.status = 'IN_APPROVAL';
         if (next === '승인') ticket.status = 'DONE';
         ticket.updatedAt = nowLocal();
         const map = Store.read(ITSM_KEY, {}) || {};
         map[row.itsm] = ticket;
         Store.write(ITSM_KEY, map);
       }

       this._pushAudit(row, currentUser(), '상태변경', `상태 진행 → ${next}`);

       if (next === '승인') {
         const job = addProvisionJob({
           source: 'DB_ACCOUNT',
           requestId: row.id,
           ticketId: row.itsm || '',
           action: (row.type === '삭제') ? 'DELETE_ACCOUNT' : (row.type === '변경' ? 'UPDATE_ACCOUNT' : 'CREATE_ACCOUNT'),
           target: `${row.system} / ${row.account}`
         });
         this._pushAudit(row, '시스템', '프로비저닝', `${job.action} 실행(모의) - ${job.id}`);
       }

       this._update(row);
       this.renderList();
       this.renderDetail();
     },
     setStatus(id, status){
       if (!id) return alert('선택된 요청이 없습니다.');
       const row = this._find(id);
       if (!row) return;

       const allow = ['반려','취소'];
       if (!allow.includes(status)) return;

       row.status = status;

       if (row.itsm) {
         const ticket = ensureTicket(row.itsm, {kind:'DB_ACCOUNT', requestId:row.id});
         ticket.status = (status === '반려') ? 'REJECTED' : 'CANCELED';
         ticket.updatedAt = nowLocal();
         const map = Store.read(ITSM_KEY, {}) || {};
         map[row.itsm] = ticket;
         Store.write(ITSM_KEY, map);
       }

       this._pushAudit(row, currentUser(), '상태변경', `상태 변경 → ${status}`);
       this._update(row);
       this.renderList();
       this.renderDetail();
     },
     advanceItsm(id){
       if (!id) return alert('선택된 요청이 없습니다.');
       const row = this._find(id);
       if (!row) return;

       if (!row.itsm) {
         row.itsm = createTicketId(row.type === '변경' ? 'CHG' : 'REQ');
         ensureTicket(row.itsm, {kind:'DB_ACCOUNT', requestId:row.id});
         this._pushAudit(row, '시스템', 'ITSM', `티켓 자동 생성(모의): ${row.itsm}`);
       }

       const t = nextTicketStatus(row.itsm);
       row.itsmStatus = t.status;

       const mapped = mapItsmToRequestStatus(t.status);
       if (mapped && row.status !== mapped) {
         row.status = mapped;
         this._pushAudit(row, '시스템', 'ITSM동기화', `티켓 상태(${t.status}) → 요청 상태(${mapped})`);
       }

       if (row.status === '승인') {
         const existing = listProvisionJobs(j => j.source === 'DB_ACCOUNT' && j.requestId === row.id);
         if (!existing.length) {
           const job = addProvisionJob({
             source: 'DB_ACCOUNT',
             requestId: row.id,
             ticketId: row.itsm || '',
             action: (row.type === '삭제') ? 'DELETE_ACCOUNT' : (row.type === '변경' ? 'UPDATE_ACCOUNT' : 'CREATE_ACCOUNT'),
             target: `${row.system} / ${row.account}`
           });
           this._pushAudit(row, '시스템', '프로비저닝', `${job.action} 실행(모의) - ${job.id}`);
         }
       }

       this._update(row);
       this.renderList();
       this.renderDetail();
     }
   };

   // 전역 등록(기존 admin.show 패치가 이 객체들을 참조)
   window.accessRequestAdmin = accessRequestAdminV2;
   window.dbAccountLifecycleAdmin = dbAccountLifecycleAdminV2;

   // 이미 accessLifecycle 화면이 떠있으면 카드 바인딩만 즉시 재시도
   try{
     if (window.admin && admin.current === 'accessLifecycle') {
       accessRequestAdminV2.attachAccessRequestCardHandler();
       dbAccountLifecycleAdminV2.attachDbAccountLifecycleCardHandler();
     }
   }catch(e){}
 })();


///**tk - end/////////////////////////////////////////////////////
</script>
</body>
</html>